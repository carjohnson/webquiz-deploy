{"version":3,"file":"extensions_cornerstone-dicom-pmap_src_viewports_OHIFCornerstonePMAPViewport_tsx.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AAEA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAGA;AACA;AACA;AACA;AAEA;AAIA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAKA;AACA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAGA;;AAUA;AACA;AACA;AAEA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAGA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AAQA;AAAA;AA1JA;AAgBA;AAAA;AA4IA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AAIA;AAAA;AAAA;AAEA;AAIA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAAA;AAAA","sources":["file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone-dicom-pmap%5Csrc%5Cviewports%5COHIFCornerstonePMAPViewport.tsx"],"sourcesContent":["import PropTypes from 'prop-types';\r\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\r\nimport { useViewportGrid } from '@ohif/ui-next';\r\nimport { OHIFCornerstoneViewport } from '@ohif/extension-cornerstone';\r\n\r\nfunction OHIFCornerstonePMAPViewport(props: withAppTypes) {\r\n  const { displaySets, children, viewportOptions, displaySetOptions, servicesManager } = props;\r\n  const viewportId = viewportOptions.viewportId;\r\n  const { displaySetService, segmentationService, uiNotificationService, customizationService } =\r\n    servicesManager.services;\r\n\r\n  // PMAP viewport will always have a single display set\r\n  if (displaySets.length !== 1) {\r\n    throw new Error('PMAP viewport must have a single display set');\r\n  }\r\n\r\n  const LoadingIndicatorTotalPercent = customizationService.getCustomization(\r\n    'ui.loadingIndicatorTotalPercent'\r\n  );\r\n\r\n  const pmapDisplaySet = displaySets[0];\r\n  const [viewportGrid, viewportGridService] = useViewportGrid();\r\n  const referencedDisplaySetRef = useRef(null);\r\n  const { viewports, activeViewportId } = viewportGrid;\r\n  const referencedDisplaySet = pmapDisplaySet.getReferenceDisplaySet();\r\n  const referencedDisplaySetMetadata = _getReferencedDisplaySetMetadata(\r\n    referencedDisplaySet,\r\n    pmapDisplaySet\r\n  );\r\n\r\n  referencedDisplaySetRef.current = {\r\n    displaySet: referencedDisplaySet,\r\n    metadata: referencedDisplaySetMetadata,\r\n  };\r\n\r\n  const [pmapIsLoading, setPmapIsLoading] = useState(!pmapDisplaySet.isLoaded);\r\n\r\n  // Add effect to listen for loading complete\r\n  useEffect(() => {\r\n    const { unsubscribe } = segmentationService.subscribe(\r\n      segmentationService.EVENTS.SEGMENTATION_LOADING_COMPLETE,\r\n      evt => {\r\n        if (evt.pmapDisplaySet?.displaySetInstanceUID === pmapDisplaySet.displaySetInstanceUID) {\r\n          setPmapIsLoading(false);\r\n        }\r\n      }\r\n    );\r\n\r\n    return () => {\r\n      unsubscribe();\r\n    };\r\n  }, [pmapDisplaySet]);\r\n\r\n  const getCornerstoneViewport = useCallback(() => {\r\n    const { displaySet: referencedDisplaySet } = referencedDisplaySetRef.current;\r\n\r\n    displaySetOptions.unshift({});\r\n    const [pmapDisplaySetOptions] = displaySetOptions;\r\n\r\n    // Make sure `options` exists\r\n    pmapDisplaySetOptions.options = pmapDisplaySetOptions.options ?? {};\r\n\r\n    Object.assign(pmapDisplaySetOptions.options, {\r\n      colormap: {\r\n        name: 'rainbow_2',\r\n        opacity: [\r\n          { value: 0, opacity: 0 },\r\n          { value: 0.25, opacity: 0.25 },\r\n          { value: 0.5, opacity: 0.5 },\r\n          { value: 0.75, opacity: 0.75 },\r\n          { value: 0.9, opacity: 0.99 },\r\n        ],\r\n      },\r\n      voi: {\r\n        windowCenter: 50,\r\n        windowWidth: 100,\r\n      },\r\n    });\r\n\r\n    uiNotificationService.show({\r\n      title: 'Parametric Map',\r\n      type: 'warning',\r\n      message: 'The values are multiplied by 100 in the viewport for better visibility',\r\n    });\r\n\r\n    return (\r\n      <OHIFCornerstoneViewport\r\n        {...props}\r\n        // Referenced + PMAP displaySets must be passed as parameter in this order\r\n        displaySets={[referencedDisplaySet, pmapDisplaySet]}\r\n        viewportOptions={{\r\n          viewportType: 'volume',\r\n          orientation: viewportOptions.orientation,\r\n          viewportId: viewportOptions.viewportId,\r\n          presentationIds: viewportOptions.presentationIds,\r\n        }}\r\n        displaySetOptions={[{}, pmapDisplaySetOptions]}\r\n      />\r\n    );\r\n  }, [\r\n    displaySetOptions,\r\n    props,\r\n    pmapDisplaySet,\r\n    viewportOptions.orientation,\r\n    viewportOptions.viewportId,\r\n    viewportOptions.presentationIds,\r\n    uiNotificationService,\r\n  ]);\r\n\r\n  // Cleanup the PMAP viewport when the viewport is destroyed\r\n  useEffect(() => {\r\n    const onDisplaySetsRemovedSubscription = displaySetService.subscribe(\r\n      displaySetService.EVENTS.DISPLAY_SETS_REMOVED,\r\n      ({ displaySetInstanceUIDs }) => {\r\n        const activeViewport = viewports.get(activeViewportId);\r\n        if (displaySetInstanceUIDs.includes(activeViewport.displaySetInstanceUID)) {\r\n          viewportGridService.setDisplaySetsForViewport({\r\n            viewportId: activeViewportId,\r\n            displaySetInstanceUIDs: [],\r\n          });\r\n        }\r\n      }\r\n    );\r\n\r\n    return () => {\r\n      onDisplaySetsRemovedSubscription.unsubscribe();\r\n    };\r\n  }, [activeViewportId, displaySetService, viewportGridService, viewports]);\r\n\r\n  let childrenWithProps = null;\r\n\r\n  if (children && children.length) {\r\n    childrenWithProps = children.map((child, index) => {\r\n      return (\r\n        child &&\r\n        React.cloneElement(child, {\r\n          viewportId,\r\n          key: index,\r\n        })\r\n      );\r\n    });\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <div className=\"relative flex h-full w-full flex-row overflow-hidden\">\r\n        {pmapIsLoading && (\r\n          <LoadingIndicatorTotalPercent\r\n            className=\"h-full w-full\"\r\n            totalNumbers={null}\r\n            percentComplete={null}\r\n            loadingText=\"Loading Parametric Map...\"\r\n          />\r\n        )}\r\n        {getCornerstoneViewport()}\r\n        {childrenWithProps}\r\n      </div>\r\n    </>\r\n  );\r\n}\r\n\r\nOHIFCornerstonePMAPViewport.propTypes = {\r\n  displaySets: PropTypes.arrayOf(PropTypes.object),\r\n  viewportId: PropTypes.string.isRequired,\r\n  dataSource: PropTypes.object,\r\n  children: PropTypes.node,\r\n};\r\n\r\nfunction _getReferencedDisplaySetMetadata(referencedDisplaySet, pmapDisplaySet) {\r\n  const { SharedFunctionalGroupsSequence } = pmapDisplaySet.instance;\r\n\r\n  const SharedFunctionalGroup = Array.isArray(SharedFunctionalGroupsSequence)\r\n    ? SharedFunctionalGroupsSequence[0]\r\n    : SharedFunctionalGroupsSequence;\r\n\r\n  const { PixelMeasuresSequence } = SharedFunctionalGroup;\r\n\r\n  const PixelMeasures = Array.isArray(PixelMeasuresSequence)\r\n    ? PixelMeasuresSequence[0]\r\n    : PixelMeasuresSequence;\r\n\r\n  const { SpacingBetweenSlices, SliceThickness } = PixelMeasures;\r\n\r\n  const image0 = referencedDisplaySet.images[0];\r\n  const referencedDisplaySetMetadata = {\r\n    PatientID: image0.PatientID,\r\n    PatientName: image0.PatientName,\r\n    PatientSex: image0.PatientSex,\r\n    PatientAge: image0.PatientAge,\r\n    SliceThickness: image0.SliceThickness || SliceThickness,\r\n    StudyDate: image0.StudyDate,\r\n    SeriesDescription: image0.SeriesDescription,\r\n    SeriesInstanceUID: image0.SeriesInstanceUID,\r\n    SeriesNumber: image0.SeriesNumber,\r\n    ManufacturerModelName: image0.ManufacturerModelName,\r\n    SpacingBetweenSlices: image0.SpacingBetweenSlices || SpacingBetweenSlices,\r\n  };\r\n\r\n  return referencedDisplaySetMetadata;\r\n}\r\n\r\nexport default OHIFCornerstonePMAPViewport;\r\n"],"names":[],"sourceRoot":""}