{"version":3,"file":"extensions_cornerstone_src_components_NavigationComponent_NavigationComponent_tsx-extensions_-cc794b.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAUA;AAOA;AACA;AACA;AAEA;AACA;AACA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAGA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AAAA;AAAA;AAGA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;;AAEA;AACA;AAIA;AACA;AACA;AAGA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;;AAGA;AACA;AACA;AAEA;AAKA;AAEA;AAIA;AAEA;;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAEA;AAEA;AACA;AAEA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;;AAEA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAMA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAIA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAMA;AAEA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAGA;;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AAGA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;;AAEA;AACA;AAKA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AAGA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AACA;AAEA;;AAEA;AACA;AAGA;AAEA;AACA;AAEA;;AAEA;AACA;AAGA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;;AAGA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAIA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAIA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAMA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAGA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAIA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAMA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAIA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3pEA;AACA;AACA;AACA;AAUA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AAAA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAGA;AAAA;AA7BA;AAEA;AAAA;AA6BA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAAA;AAGA;AAEA;AACA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AAGA;AACA;AACA;AACA;AACA;AAAA;AAIA;AAGA;AAAA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAGA;AAAA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAKA;AACA;AAAA;AAKA;AAAA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClMA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACHA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAEA;AAIA;AACA;AAAA;AAKA;AAAA;AAdA;AACA;AAAA;AAeA;AACA;AACA;AAEA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACzBA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACAA;AACA;AACA;AAEA;AACA;AACA;AACA;AAKA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;;AAKA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAKA;AAGA;AAAA;AA7GA;AAyBA;AAAA;AAsFA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACnHA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAQA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAGA;AAAA;AAEA;AAAA;AAEA;AACA;AAAA;AAEA;AAAA;AAAA;AAGA;AACA;AAAA;AASA;AACA;AAAA;AAEA;AAAA;AAAA;AAGA;AACA;AACA;AAAA;AAKA;AACA;AAAA;AAOA;AAAA;AACA;AAAA;AAKA;AAEA;AAGA;AAAA;AAEA;AACA;AAAA;AAIA;AAAA;AAIA;AAAA;AAnFA;AAqFA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3GA;AACA;AACA;AACA;AACA;AACA;AAMA;AACA;AAOA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAEA;AAGA;AAIA;AAEA;AAEA;AAEA;AAEA;AAEA;AAEA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AAEA;AACA;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AAKA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AAGA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAAA;AAGA;AAAA;AAIA;AACA;AACA;AAAA;AAQA;AACA;AAAA;AAIA;AAAA;AACA;AAAA;AAIA;AAIA;AAAA;AAQA;AAEA;AACA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AAAA;AAMA;AAEA;AACA;AACA;AAAA;AACA;AAAA;AAGA;AAAA;AAUA;AACA;AAAA;AAGA;AAAA;AAGA;AAAA;AACA;AAAA;AAQA;AAEA;AACA;AAAA;AAEA;AAAA;AAEA;AAAA;AAQA;AACA;AAAA;AAOA;AAAA;AA5VA;AAIA;AAAA;AA0VA;AACA;AACA;AACA;AAEA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC1YA;AACA;AACA;AAMA;AAMA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AAKA;AAEA;AACA;AAGA;AACA;AAGA;AAGA;AACA;AACA;AAGA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAGA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AAIA;AAAA;AAEA;AAAA;AAIA;AAAA;AAEA;AAAA;AAEA;AACA;AAAA;AAQA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3GA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAGA;AAAA;AAEA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAAA;AAGA;AAAA;AAAA;AACA;AAEA;AACA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AACA;AAAA;AAGA;AAAA;AAOA;AAGA;AAAA;AAhDA;AAEA;AAAA;AAFA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrBA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AAEA;AACA;AACA;AAAA;AAEA;AAAA;AAEA;AAAA;AACA;AAAA;AAAA;AAEA;AAAA;AAGA;AAAA;AArBA;AAEA;AAAA;AAFA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACRA;AACA;AACA;AASA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAAA;AAGA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAAA;AAAA;AAGA;AAAA;AACA;AAAA;AAEA;AACA;AACA;AAGA;AACA;AAAA;AAEA;AAAA;AAGA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AAMA;AAAA;AAnEA;AAUA;AAAA;AA2DA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AChFA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AACA;AAAA;AAKA;AAAA;AAEA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACjFA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAGA;AACA;AAGA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAGA;AAEA;AACA;AAEA;AACA;AAAA;AAGA;AACA;AAEA;AACA;AAAA;AAGA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAEA;AAAA;AAMA;AACA;AACA;AACA;AACA;AACA;AAAA;AAOA;AAEA;AACA;AAEA;AAIA;AAAA;AAKA;AAAA;AAQA;AAAA;AAzJA;AAOA;AAAA;AAoJA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACvKA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;;AAGA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AACA;AACA;AAEA;;AAEA;AACA;AAQA;AAEA;AAIA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAKA;AACA;AACA;AACA;AAYA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAIA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;;AAIA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAAA;AAGA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AANA;AAnHA;AAaA;AAAA;AA6GA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACtJA;AACA;AACA;AAOA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AAOA;AAAA;AA1CA;AAKA;AAAA;AAuCA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrDA;AACA;AACA;AAQA;AAWA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAEA;AAEA;AACA;AAAA;AAGA;AACA;AAAA;AAKA;AACA;AAAA;AAQA;AACA;AACA;AAAA;AAQA;AACA;AACA;AACA;AACA;AAAA;AAGA;AACA;AAAA;AAKA;AAAA;AA/DA;AAYA;AAAA;AAZA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrBA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AAEA;AAAA;AAEA;AAAA;AACA;AAAA;AAOA;AAAA;AAGA;AAAA;AAIA;AAAA;AA5BA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACnBA;;AAEA;AACA;AACA;AACA;AAIA;AACA;AAAA;AACA;AAAA;AAEA;AAAA;AAKA;AAEA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACpBA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAGA;AAAA;AAEA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AAKA;AAAA;AAjCA;AAGA;AAAA;AAgCA;AAAA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACzFA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAKA;AAAA;AAGA;AAAA;AAzBA;AAIA;AAAA;AAuBA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACvFA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AACA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAQA;AAAA;AAlEA;AACA;AAAA;AAmEA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACxEA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AAAA;AAGA;AAAA;AAnBA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACNA;AACA;AACA;AAEA;AACA;AAMA;AAAA;AAEA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACbA;AACA;AASA;AACA;AACA;AAOA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAIA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAIA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AAAA;AAQA;AACA;AAAA;AAEA;AAAA;AASA;AACA;AACA;AACA;AAAA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAGA;AAAA;AACA;AAAA;AACA;AAAA;AAMA;AAAA;AAlFA;AAMA;AAAA;AA8EA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACvGA;AACA;AACA;AAQA;AAWA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAEA;AAEA;AACA;AAAA;AAGA;AACA;AAAA;AAKA;AACA;AAAA;AAQA;AACA;AACA;AAAA;AAQA;AACA;AACA;AACA;AACA;AAAA;AAGA;AACA;AAAA;AAKA;AAAA;AA/DA;AAYA;AAAA;AAZA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrBA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AAGA;AAAA;AAEA;AAAA;AAGA;AAAA;AAMA;AAAA;AArBA;AACA;AAAA;AAsBA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC/BA;AACA;AAYA;AACA;AACA;AACA;AAOA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAIA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AAGA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AAIA;AACA;AAAA;AACA;AAAA;AAEA;AACA;AAAA;AAEA;AAAA;AAGA;AACA;AAAA;AAQA;AACA;AAAA;AAQA;AAAA;AAEA;AACA;AAAA;AAKA;AACA;AAAA;AAOA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAEA;AAAA;AAGA;AAAA;AACA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAEA;AAAA;AAEA;AAAA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAEA;AAAA;AAEA;AAAA;AASA;AAAA;AA/JA;AASA;AAAA;AAwJA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC7LA;AACA;AACA;AAQA;AAWA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAEA;AAEA;AACA;AAAA;AAGA;AACA;AAAA;AAKA;AACA;AAAA;AAQA;AACA;AACA;AAAA;AAQA;AACA;AACA;AACA;AACA;AAAA;AAGA;AACA;AAAA;AAKA;AAAA;AA/DA;AAYA;AAAA;AAZA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrBA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACDA;AACA;AACA;AAUA;AAAA;AAAA;AAiBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AAGA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAYA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAGA;AAAA;AAtGA;AAsGA;AAtGA;AAsGA;AAEA;AAAA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACzJA;AACA;AAGA;AACA;AACA;AAeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;;AAEA;AACA;AACA;AAGA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AAEA;AAEA;AAAA;AACA;AAAA;AAAA;AAGA;AAKA;AACA;AAEA;AAEA;AACA;AACA;AAAA;AAGA;AACA;AAAA;AAAA;AAAA;AAGA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAGA;AAIA;AAAA;AA3FA;AA2FA;AA3FA;AA2FA;AAEA;AAAA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC/HA;AACA;AAEA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACJA;AACA;AAcA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAIA;AACA;AACA;;AAEA;AACA;AAIA;AACA;AAIA;AACA;;AAEA;AACA;AACA;AACA;AAIA;AACA;AACA;;AAEA;AACA;AAIA;AACA;AAIA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAIA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAKA;AAAA;AAEA;AAAA;AAGA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AAAA;AAEA;AAAA;AAMA;AACA;AACA;AAAA;AAEA;AAAA;AAIA;AACA;AACA;AAAA;AAEA;AAAA;AAMA;AAAA;AAEA;AACA;AACA;AAAA;AAEA;AAAA;AAGA;AAAA;AAEA;AAAA;AAWA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AAKA;AACA;AACA;AAAA;AAEA;AAAA;AAMA;AAAA;AAEA;AACA;AACA;AAAA;AAEA;AAAA;AAGA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAUA;AAAA;AAGA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AAAA;AAEA;AAAA;AAMA;AACA;AACA;AAAA;AAEA;AAAA;AAIA;AACA;AACA;AAAA;AAEA;AAAA;AAMA;AAAA;AAEA;AACA;AACA;AAAA;AAEA;AAAA;AAGA;AAAA;AAEA;AAAA;AAWA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AAKA;AACA;AACA;AAAA;AAEA;AAAA;AAMA;AAAA;AAEA;AACA;AACA;AAAA;AAEA;AAAA;AAGA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAUA;AAAA;AACA;AAAA;AAEA;AACA;AACA;AAGA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAYA;AACA;AACA;AAAA;AAEA;AAAA;AAQA;AAAA;AACA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAGA;AACA;AACA;AAAA;AASA;AAAA;AA9cA;AAeA;AAAA;AAicA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACreA;AACA;AACA;AAQA;AACA;AAWA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAEA;AAEA;AACA;AAAA;AAGA;AACA;AAAA;AAKA;AACA;AAAA;AAQA;AACA;AACA;AAAA;AAQA;AACA;AACA;AACA;AACA;AAAA;AAGA;AACA;AACA;AAAA;AAKA;AAAA;AAjEA;AAaA;AAAA;AAbA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACtBA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAEA;AAEA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AAIA;AAIA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAIA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACnKA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AASA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AACA;AAEA;AACA;AAAA;AAGA;AACA;AAAA;AAKA;AACA;AAAA;AAQA;AACA;AACA;AACA;AAAA;AAQA;AACA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AACA;AAAA;AAKA;AACA;AACA;AAAA;AAKA;AACA;AACA;AAAA;AAKA;AACA;AACA;AAAA;AAQA;AAAA;AA5KA;AAqBA;AAAA;AAyJA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACpLA;AACA;AACA;AAEA;AAUA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AAGA;AAAA;AAGA;AAAA;AAxBA;AAYA;AAAA;AAZA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACJA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AAAA;AAAA;AAEA;AACA;AACA;AAGA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAEA;AACA;AACA;AAIA;AACA;AAIA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAKA;AAIA;AAKA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AACA;AAIA;AAEA;AAEA;AACA;AACA;AAEA;AAEA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;AAIA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;AAEA;AACA;AAKA;AAIA;AACA;AACA;;AAOA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AAAA;AACA;AACA;AACA;AACA;;AAGA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAGA;AAEA;AAAA;AAOA;AAAA;AA5NA;AASA;AAAA;AAqNA;AACA;AACA;AACA;AAEA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClPA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACvEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AAKA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAGA;AAEA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AAGA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACxJA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AACA;AAAA;AAEA;AACA;AAAA;AAKA;AACA;AACA;AAAA;AAIA;AAAA;AAvBA;AACA;AAAA;AADA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACJA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;;AAIA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AAEA;AAGA;AAAA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAKA;AACA;AAAA;AAWA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAMA;AAAA;AACA;AAAA;AACA;AAAA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAQA;AAAA;AAzHA;AAQA;AAAA;AARA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACJA;AAEA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;;AAEA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAGA;AACA;AAAA;AAEA;AAAA;AAAA;AAGA;AACA;AAAA;AAGA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AACA;AAAA;AAQA;AAAA;AA1EA;AACA;AAAA;AADA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACLA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAGA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AAEA;AACA;AAAA;AAIA;AACA;AAAA;AAIA;AAAA;AA1BA;AACA;AAAA;AADA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACRA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAGA;AAAA;AA1BA;AAEA;AAAA;AAFA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACPA;AACA;AACA;AAEA;AAMA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAIA;AAIA;AACA;AACA;AAEA;AACA;AAAA;AAIA;AACA;AACA;AAAA;AAMA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAGA;AACA;AAIA;AAEA;AAAA;AAOA;AAAA;AAEA;AAAA;AAKA;AAAA;AApEA;AACA;AAAA;AADA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACVA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AACA;AAAA;AAOA;AAAA;AAxDA;AAIA;AAAA;AAJA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACLA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAGA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAIA;AAAA;AAvCA;AAIA;AAAA;AAJA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACLA;AAEA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAGA;AACA;AAEA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AACA;AAAA;AAOA;AAAA;AAtEA;AACA;AAAA;AADA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACLA;AACA;AACA;AAGA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;;AAIA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAGA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAKA;AACA;AAAA;AAWA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAAA;AAMA;AAAA;AACA;AAAA;AACA;AAAA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAQA;AAAA;AApHA;AAOA;AAAA;AAPA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AASA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAGA;AAAA;AAEA;AACA;AACA;AACA;AAKA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAAA;;AACA;AACA;AACA;AAAA;AAGA;AAAA;AAIA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAMA;AACA;AACA;AAAA;AAEA;AAAA;AAIA;AAAA;AAGA;AAAA;AACA;AAAA;AAMA;AAAA;AA/DA;AAmBA;AAAA;AAnBA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AChCA;AACA;AACA;AASA;AACA;AACA;AAEA;AAYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AAEA;AAEA;AAAA;AAEA;AAAA;AAGA;AAEA;AACA;AAAA;AAGA;AACA;AAAA;AAKA;AAAA;AAQA;AACA;AACA;AAAA;AAQA;AACA;AACA;AACA;AACA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AAKA;AAAA;AArHA;AAkCA;AAAA;AAlCA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACfA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACtBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACVA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACXA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACFA;AACA;AAaA;AACA;;AAEA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AAIA;AAAA;AACA;AAAA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AACA;AAAA;AAGA;AAAA;AACA;AAAA;AACA;AAAA;AAIA;AAAA;AACA;AAAA;AACA;AAAA;AAGA;AACA;AACA;AACA;AAAA;AAKA;AACA;AACA;AACA;AACA;AAAA;AAKA;AACA;AACA;AACA;AACA;AAAA;AAKA;AAAA;AACA;AAAA;AACA;AAAA;AAGA;AACA;AACA;AACA;AACA;AAAA;AAQA;AAAA;AACA;AAAA;AACA;AAAA;AAIA;AAAA;AAvIA;AAoBA;AAAA;AApBA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACpBA;AACA;AACA;AACA;AACA;AACA;AAOA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAAA;AACA;AAAA;AAEA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAIA;AAAA;AAGA;AAAA;AAGA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AAEA;AAIA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AAQA;AAAA;AAEA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;AAAA;AAGA;AAAA;AAEA;AAAA;AAIA;AAAA;AAGA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAKA;AAAA;AAIA;AAAA;AAGA;AAAA;AA1HA;AAMA;AAAA;AANA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACfA;AACA;AAEA;AACA;AAiBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAIA;AACA;AACA;AACA;AAAA;AASA;AAAA;AAEA;AACA;AAAA;AAKA;AACA;AACA;AAAA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAIA;AACA;AACA;AAAA;AAMA;AACA;AACA;AAAA;AAKA;AAAA;AAEA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAUA;AAAA;AA9HA;AAgIA;AACA;AACA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACvJA;AAYA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC5FA;AACA;AACA;AAGA;AACA;AAKA;AACA;AACA;AAEA;AAIA;AAEA;AACA;AAGA;AACA;AAAA;AAAA;AAAA;AAAA;AAGA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAIA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3HA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACtBA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AAAA;AACA;AAAA;AAEA;AACA;AAAA;AAEA;AAAA;AAGA;AAAA;AAEA;AACA;AAAA;AAEA;AAAA;AAGA;AAAA;AAEA;AACA;AAAA;AAEA;AAAA;AAIA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACpFA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACdA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACLA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3CA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AChCA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACbA;AAEA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACJA;AACA;AAEA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC9CA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAGA;AAEA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAGA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AAGA;AACA;AAAA;AAGA;AACA;AACA;AACA;AACA;AACA;AAAA;AAIA;AAEA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC7FA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AAGA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AAEA;AACA;AAEA;AAIA;AACA;AAIA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAGA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC/JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAIA;AACA;AAOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAIA;AACA;AACA;;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAMA;;AAIA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AAIA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AAIA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAEA;AAIA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACnkBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACPA;AACA;AAEA;AAAA;AACA;AAEA;AAEA;AAAA;AAAA;AAEA;AACA;AAAA;AARA;AAKA;AAKA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACbA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAGA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAEA;AAIA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;;AAqBA;AACA;AACA;AAOA;AAGA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AArHA;AAKA;AAkHA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACnIA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AAEA;AAQA;AAIA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AA1CA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3DA;AACA;AACA;AAEA;AAEA;AACA;AAAA;AAAA;AAAA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAIA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AAEA;AAWA;AACA;AAMA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AA5DA;AAKA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3FA;AACA;AACA;AACA;AAMA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AA4BA;AACA;AACA;;AAoCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAKA;AACA;AACA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAGA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AAEA;AAMA;AACA;AACA;AACA;AACA;AAKA;AAEA;AAKA;AACA;AACA;AACA;AACA;AAQA;AAEA;AACA;AACA;AACA;AACA;AAQA;AAEA;AACA;AACA;AACA;AACA;AASA;AAQA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AA1KA;AAUA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrGA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AAMA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAlEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACZA;AACA;AACA;AACA;AAaA;AAiEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AAAA;AAAA;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AAIA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AAAA;AAAA;AAEA;AAEA;AAAA;AAAA;AAAA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AAIA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAEA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAIA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AAAA;AAAA;AAKA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAIA;AACA;AAGA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;;AAEA;AACA;AAAA;AAAA;AAAA;AAKA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAWA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAEA;AACA;AAIA;AACA;AAIA;AAEA;AACA;AACA;AACA;AAIA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AAIA;AACA;;AAIA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AAIA;AACA;AACA;AAEA;AACA;AAIA;AACA;AAIA;AAEA;AAAA;AAAA;AAIA;AACA;AAIA;AAEA;AACA;AACA;AACA;AAIA;AACA;;AAQA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAttBA;AAsBA;AAksBA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AAIA;AAEA;AACA;AACA;AAIA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACz3BA;AACA;AACA;AAKA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AASA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AAEA;AAoBA;AACA;AAMA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAUA;AACA;AAAA;AAvHA;AASA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC9GA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAEA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC7iDA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3IA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACzIA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3HA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACpEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC7IA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACjHA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACJA;AACA;AACA;AACA;AAKA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AAAA;AAEA;AACA;AACA;AAAA;AAIA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAGA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AAIA;AAKA;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAEA;AAGA;AACA;AACA;AAAA;AAGA;AAEA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAiBA;;AAiBA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACjRA;AACA;AAEA;AACA;AACA;AAWA;AAKA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAIA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AAAA;AAAA;AAGA;AAAA;AAAA;;AAEA;AACA;AAIA;AACA;AAKA;AACA;AAAA;AAEA;AACA;AAGA;AAEA;AAKA;;AAKA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAIA;;AAEA;AACA;AAKA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAIA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;;AAEA;AACA;AAGA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AAEA;;AAEA;AACA;AAEA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;;AAIA;;AAEA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AASA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAGA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACnbA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AAAA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrEA;AACA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AAEA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC7FA;AA0CA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACtKA;AACA;AAEA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;AAEA;AACA;AAIA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AAIA;AAEA;AACA;AAAA;AAAA;AAEA;AAIA;AAEA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACjFA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAIA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAMA;;AAKA;AACA;AAQA;AAKA;AACA;AAEA;AACA;AAGA;AAQA;AAQA;AAQA;AAQA;AAQA;AAQA;AAQA;AAQA;;AAQA;AACA;AACA;AAQA;AAQA;AAQA;AAQA;AAQA;AACA;AAEA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAMA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAGA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;;AAEA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAGA;AACA;AAGA;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAGA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAEA;AAMA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAGA;AAEA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3fA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AChCA;AACA;AAIA;AACA;AAEA;AAAA;AAAA;AAEA;AAKA;AAEA;AAKA;AACA;AAIA;AACA;AACA;AACA;AACA;AAMA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACvDA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AAAA;AAEA;AAAA;AAEA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAxBA;AAGA;AAAA;AAHA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC1DA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;;AAGA;AACA;AAGA;AAGA;AACA;AACA;AAIA;;AAIA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAQA;;AAEA;AACA;AACA;AACA;AAeA;AAEA;AAkBA;AAEA;AAQA;AAAA;AAlMA;AAKA;AAAA;AALA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACNA;AACA;AACA;AACA;AAEA;AA8BA;AACA;AAnBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAdA;AAeA;AAKA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAMA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAIA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AAAA;AA5PA;AAEA;AACA;AAHA;AAMA;AACA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACfA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACAA;AAEA;AAEA;AAEA;AAaA;AAAA;AAJA;AACA;AAIA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAMA;AAEA;AACA;AAEA;AAIA;AACA;AACA;AACA;AAMA;AACA;AAMA;AAEA;AAEA;AACA;AAEA;AAMA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAIA;AAMA;AACA;AAEA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AAMA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAKA;AACA;;AAEA;AAEA;AACA;AAAA;AAAA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAAA;AAzTA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAoTA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClUA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACnCA;AAWA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AA0BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AAeA;AAAA;AAAA;AACA;AAAA;AAPA;AACA;AACA;AACA;AACA;AAwIA;AAKA;AAKA;AAKA;AAKA;AAKA;AACA;AAAA;AAmgBA;AAEA;AACA;AAAA;AAWA;AACA;AAAA;AAGA;AACA;AA0TA;AACA;AACA;AACA;AACA;AACA;AALA;AAQA;AAAA;AAAA;AAEA;AACA;AAAA;AAGA;AACA;AACA;AAAA;AA4lBA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAMA;AAAA;AA6EA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAGA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AAKA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAKA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAxtDA;AAEA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAEA;AACA;AAEA;AAGA;AAGA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AACA;;AAKA;AACA;AAIA;AACA;AA+BA;AAGA;AACA;AACA;AACA;AAQA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAGA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AASA;AAEA;AASA;AACA;AAAA;AAAA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AASA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAMA;AACA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAIA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAEA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AAGA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AAEA;AACA;AAEA;AAMA;AACA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AAGA;AAEA;AACA;AAIA;AAEA;AACA;AACA;AAKA;AACA;AACA;;AAEA;AACA;AAEA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAGA;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAKA;AACA;AA6BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAWA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAOA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AAEA;AAMA;AAGA;AACA;AACA;AAGA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAMA;AAMA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAoBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AACA;AAEA;AAQA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;;AAEA;AACA;AAIA;AACA;AAAA;AAAA;AACA;AAEA;AASA;AACA;AAEA;AASA;AACA;AACA;AAEA;AAEA;AAIA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AAGA;AAEA;AASA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAMA;AACA;AACA;AACA;AACA;AAEA;AACA;AAGA;AACA;AAEA;AAGA;AACA;AACA;AAGA;AAEA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AASA;AACA;AAEA;AAEA;AAAA;AAAA;AAAA;AAQA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAKA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AAOA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AAOA;AAAA;AAAA;AAAA;AACA;AAEA;AAUA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AAGA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAKA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAIA;AAEA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAMA;AACA;AACA;AAEA;AAKA;AACA;AAMA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAIA;AAAA;AAAA;AAAA;AACA;AAEA;AAIA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AAEA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AAEA;AAMA;AAGA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAKA;AAKA;AAKA;AAKA;AAKA;AAKA;AAIA;AAEA;AACA;AACA;AAEA;AASA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAGA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAGA;AACA;AAEA;AACA;AAEA;AASA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAGA;AACA;AAEA;AACA;AA2BA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AAOA;AAGA;AACA;AACA;AAIA;AAEA;AACA;AACA;AAAA;AAAA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAoCA;AAAA;AA3uDA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAsuDA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACj0DA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACFA;AACA;AAEA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAYA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAEA;AAyBA;AAAA;AAhBA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAKA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAKA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAKA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AAEA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AAKA;AAEA;AAKA;AAEA;AAIA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AAAA;AApOA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC1CA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AAEA;AAAA;AAAA;AAEA;AAIA;AAKA;AAAA;AAAA;AAEA;AAEA;AACA;AAGA;AACA;AAEA;AAKA;AAAA;AAAA;AAEA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AAEA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AAEA;AAEA;AAAA;AAGA;AACA;AACA;;AAEA;AACA;AAEA;AAAA;AAGA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACnFA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACFA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAcA;AAoBA;AAAA;AAXA;AACA;AACA;AACA;AAEA;AACA;AACA;AAFA;AAGA;AACA;AAoQA;AAAA;AAAA;AAAA;AAAA;AACA;AAIA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAjRA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AAMA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAKA;AAEA;AACA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAoBA;AAAA;AAvSA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AChCA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACFA;AAEA;AAaA;AAEA;AACA;AAcA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;AAyBA;AACA;AAAA;AAfA;AACA;AACA;AACA;AAGA;AAAA;AACA;AAEA;AACA;AACA;AACA;AAQA;AACA;AACA;AACA;AACA;AACA;AACA;AAVA;AACA;AACA;AACA;AAUA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAIA;AAIA;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAGA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AAIA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;;AAOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAMA;AACA;AACA;AACA;AACA;AACA;AAEA;AAMA;AAEA;;AAEA;AACA;;AAEA;AAEA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AAGA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AAIA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AAIA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAIA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAMA;AACA;AACA;AAEA;AACA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAGA;AAAA;AAAA;;AAEA;AACA;;AAEA;AACA;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAGA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAIA;AAAA;AAAA;AACA;AAEA;AAKA;AACA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAMA;AACA;AAMA;AAEA;AACA;AAMA;AAEA;AAMA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAMA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;;AAEA;AACA;AAAA;AAAA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AAGA;AACA;AAAA;AA5qCA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAqqCA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACpuCA;AAQA;AACA;AACA;AAuFA;AACA;;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AASA;AAAA;AARA;AACA;AACA;AACA;AACA;AACA;AACA;AAkCA;AACA;AACA;AACA;AACA;AAnCA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AASA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAGA;AACA;AAEA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAIA;AACA;AACA;AAAA;AAEA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AAGA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC5WA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACFA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACjCA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACHA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAMA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACzCA;AACA;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AA6CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AAKA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;AAAA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACnKA;AACA;AAEA;AAEA;AACA;;AAEA;AACA;AACA;;AAmDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AAKA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAMA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACzKA;AACA;AAEA;AACA;AAEA;AACA;;AAEA;AACA;AACA;;AA2EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AAMA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AAGA;AACA;AAEA;AACA;AAEA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAMA;AACA;AACA;AAIA;AACA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC7PA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAQA;AACA;AACA;;AAqBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAIA;AAEA;AACA;AAAA;AAAA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACjFA;AACA;AAEA;AAKA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAIA;AAAA;AAAA;AAIA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAKA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClDA;AACA;AACA;AAEA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAGA;AACA;AAGA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAEA;AACA;AAGA;AACA;AAEA;AAEA;AACA;AACA;AAvBA;AAyBA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AAIA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAAA;AAAA;AAEA;AAKA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AChGA;AAEA;AACA;AACA;AAaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AASA;AAGA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAGA;AAYA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AA7CA;AAIA;AACA;AACA;AACA;AAEA;AACA;AACA;AAoCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAMA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAKA;AAGA;AACA;AACA;AAEA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAKA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAEA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAQA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AA/OA;AAGA;AACA;AACA;AACA;AANA;AAiPA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC5QA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrCA;;AAGA;;AAGA;;AAWA;;AAKA;;AAMA;;AAKA;;AAKA;;AASA;;AAOA;;AAMA;;AASA;;AAOA;;AAeA;;AAeA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACxGA;AACA;AACA;AACA;AACA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACTA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAQA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AAKA;AACA;AACA;AAAA;AAAA;AAAA;AAGA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAGA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAIA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAIA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAGA;AAAA;AA3NA;AAIA;AAAA;AAyNA;AAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACxPA;AAEA;AAEA;AACA;AACA;AAUA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAUA;AAIA;AAAA;AAHA;AAIA;AACA;AACA;AACA;AAEA;AASA;AACA;AAAA;AATA;AACA;AACA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAGA;AACA;AACA;AACA;AAEA;AACA;AACA;AAIA;AACA;AAEA;AACA;;AAEA;AACA;AAGA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3MA;AACA;AACA;AACA;AAHA;AAIA;AAAA;AAAA;AAAA;AAAA;AASA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACbA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAGA;AACA;AAEA;AACA;AACA;AAIA;AACA;AAEA;AACA;AACA;AA8LA;AACA;AAEA;AACA;AACA;AAiIA;AACA;AAEA;AACA;AACA;AA4LA;AACA;AAEA;AACA;AACA;AA8KA;AACA;AAEA;AACA;AACA;AAqIA;AACA;AAEA;AACA;AACA;AA6IA;AACA;AAEA;AACA;AACA;AA0LA;AACA;AAEA;AACA;AACA;AA2LA;AACA;AAEA;AACA;AACA;AA4LA;AACA;AAGA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC5jDA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAGA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAQA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAOA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAIA;AACA;AAEA;AAEA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAMA;AACA;AACA;AAEA;AAOA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AChOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAGA;AACA;AACA;AAGA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACpBA;AAaA;AACA;;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AASA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAIA;AAIA;;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AAIA;AAEA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC1IA;AAGA;AAEA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACVA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACxBA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACpBA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAIA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAGA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACtCA;AACA;AACA;AAEA;AAEA;AACA;;AAEA;AACA;AACA;AAAA;AAAA;AAGA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACjCA;AAEA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAIA;AACA;AAEA;AAIA;AACA;AAEA;AAIA;AACA;AAEA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACvDA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AACA;AAEA;AAMA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC5BA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AAEA;;AAGA;AACA;AACA;AACA;AACA;AAIA;AAEA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAKA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAIA;AAAA;AAAA;AAEA;AACA;AACA;;AAIA;AACA;AACA;AAAA;AAAA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACpGA;AACA;AACA;AAIA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACtBA;AACA;AAEA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AAKA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACnDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC7BA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AAEA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC9IA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AAEA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC5JA;AACA;AAAA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;;AAEA;AACA;AAKA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAKA;AAKA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACjGA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AACA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACvMA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AACA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC/KA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AACA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AChMA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AACA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClOA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AACA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACxMA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AACA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC5NA;AACA;AACA;AACA;AACA;AAGA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AACA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC/MA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AAIA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAMA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC9KA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AAIA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC9NA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AACA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC/LA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AACA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC9NA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AACA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACvLA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AAAA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AAIA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAMA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClOA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAGA;AAEA;AACA;AAIA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAGA;AAMA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACrNA;AAkBA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClBA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAQA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAQA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAQA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAQA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAQA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAQA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAQA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAQA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAQA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAQA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAQA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAQA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAQA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAQA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC/SA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACbA;AAEA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACJA;AAEA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACLA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AAGA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACtCA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACXA;AACA;AAKA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACTA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AChCA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAIA;;AAEA;AACA;AAEA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AAEA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC3EA;AACA;AACA;AACA;AACA;AAoBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;;AAEA;AACA;AAEA;AACA;AACA;AACA;AAGA;AAIA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAMA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC1LA;AACA;AACA;AACA;AACA;AACA;AAOA;AACA;AAEA;AAAA;AAAA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AAGA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC7CA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AAAA;AACA;AAEA;AACA;AACA;AAEA;;AAEA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;;AAEA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAEA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAKA;AACA;AACA;AAGA;AACA;AACA;;AAIA;AACA;AACA;AAMA;AACA;AAEA;AACA;AACA;AACA;AAGA;AAAA;AAAA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACjHA;AAKA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AACA;AAEA;AAAA;AAAA;AAGA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAGA;AAMA;AAAA;AAAA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACzDA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAIA;AAEA;AACA;AAEA;AACA;AACA;;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAKA;AACA;AAEA;AAIA;AAAA;AAAA;AAEA;;AAEA;AACA;AACA;AAAA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAKA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAKA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC9DA;AAYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;AAEA;;AAIA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AACA;AAEA;AACA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACxLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;AC9BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5CcommandsModule.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CAccordionGroup%5CAccordionGroup.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CAccordionGroup%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CActiveViewportWindowLevel%5CActiveViewportWindowLevel.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CActiveViewportWindowLevel%5Cindex.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CAdvancedRenderingControls%5CAdvancedRenderingControls.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CAdvancedRenderingControls%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CDicomUpload%5CDicomUpload.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CDicomUpload%5CDicomUploadProgress.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CDicomUpload%5CDicomUploadProgressItem.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CMeasurementItems.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CMeasurementTableNested.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CMeasurementsMenu.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CMeasurementsOrAdditionalFindings.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CModalityLoadBadge%5CModalityLoadBadge.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CModalityLoadBadge%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CNavigationComponent%5CNavigationComponent.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5COpacityMenu%5COpacityMenu.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5COpacityMenu%5COpacityMenuWrapper.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CPanelAccordionTrigger.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CSelectItemWithModality.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CSeriesMeasurements.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CStudyMeasurements.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CStudyMeasurementsActions.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CStudySummaryFromMetadata.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CStudySummaryWithActions.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CThresholdMenu%5CThresholdMenu.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CThresholdMenu%5CThresholdMenuWrapper.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CTrackingStatus%5CTrackingStatus.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CVOIManualControlMenu%5CVOIManualControlMenu.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CVOIManualControlMenu%5CVOIManualControlMenuWrapper.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CVOIManualControlMenu%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CViewportColorbar%5CViewportColorbar.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CViewportColorbar%5CViewportColorbarsContainer.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CViewportColorbar%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CViewportDataOverlaySettingMenu%5CViewportDataOverlayMenu.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CViewportDataOverlaySettingMenu%5CViewportDataOverlayMenuWrapper.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CViewportDataOverlaySettingMenu%5Cutils.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CViewportOrientationMenu%5CViewportOrientationMenu.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CViewportOrientationMenu%5CViewportOrientationMenuWrapper.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CViewportWindowLevel%5CViewportWindowLevel.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CViewportWindowLevel%5CgetViewportVolumeHistogram.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CViewportWindowLevel%5Cutils.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CWindowLevelActionMenu%5CColorbar.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CWindowLevelActionMenu%5CColormap.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CWindowLevelActionMenu%5CVolumeLighting.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CWindowLevelActionMenu%5CVolumeRenderingOptions.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CWindowLevelActionMenu%5CVolumeRenderingPresets.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CWindowLevelActionMenu%5CVolumeRenderingPresetsContent.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CWindowLevelActionMenu%5CVolumeRenderingQuality.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CWindowLevelActionMenu%5CVolumeShade.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CWindowLevelActionMenu%5CVolumeShift.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CWindowLevelActionMenu%5CWindowLevel.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CWindowLevelActionMenu%5CWindowLevelActionMenu.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CWindowLevelActionMenu%5CWindowLevelActionMenuWrapper.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CWindowLevelActionMenu%5CdefaultWindowLevelPresets.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CWindowLevelActionMenu%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cconstants%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5CCustomDropdownMenuContent.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5CCustomSegmentStatisticsHeader.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5CcaptureViewportModalCustomization.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5CcolorbarCustomization.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5ClayoutSelectorCustomization.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5CmeasurementsCustomization.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5CmiscCustomization.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5CmodalityColorMapCustomization.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5CsegmentationPanelCustomization.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5CviewportClickCommandsCustomization.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5CviewportDownloadWarningCustomization.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5CviewportOverlayCustomization.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5CviewportToolsCustomization.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5CvolumeRenderingCustomization.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccustomizations%5CwindowLevelPresetsCustomization.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cenums.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5CgetCustomizationModule.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5CgetHangingProtocolModule.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5CgetPanelModule.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5CgetSopClassHandlerModule.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5CgetToolbarModule.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chooks%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chooks%5CuseActiveViewportSegmentationRepresentations.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chooks%5CuseMeasurementTracking.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chooks%5CuseMeasurements.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chooks%5CuseSegmentations.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chooks%5CuseViewportDisplaySets.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chooks%5CuseViewportHover.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chooks%5CuseViewportRendering.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chooks%5CuseViewportSegmentations.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chps%5CfourUp.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chps%5CframeView.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chps%5Cmain3D.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chps%5Cmpr.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chps%5CmprAnd3DVolumeViewport.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chps%5Conly3D.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chps%5Cprimary3D.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Chps%5CprimaryAxial.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cid.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cindex.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cinit.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5CinitCineService.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5CinitContextMenu.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5CinitCornerstoneTools.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5CinitDoubleClick.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5CinitMeasurementService.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5CinitStudyPrefetcherService.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5CinitWADOImageLoader.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cpanels%5CPanelMeasurement.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cpanels%5CPanelSegmentation.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CColorbarService%5CColorbarService.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CColorbarService%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CCornerstoneCacheService%5CCornerstoneCacheService.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CCornerstoneCacheService%5Cindex.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CSegmentationService%5CRTSTRUCT%5CmapROIContoursToRTStructData.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CSegmentationService%5CSegmentationService.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CSegmentationService%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CSyncGroupService%5CSyncGroupService.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CSyncGroupService%5CcreateHydrateSegmentationSynchronizer.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CSyncGroupService%5Cindex.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CToolGroupService%5CToolGroupService.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CToolGroupService%5Cindex.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CViewportService%5CCornerstoneViewportService.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CViewportService%5CViewport.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cservices%5CViewportService%5Cconstants.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cstate.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cstores%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cstores%5CpresentationUtils.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cstores%5CuseLutPresentationStore.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cstores%5CusePositionPresentationStore.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cstores%5CuseSegmentationPresentationStore.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cstores%5CuseSynchronizersStore.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Csynchronizers%5CframeViewSynchronizer.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ctools%5CCalibrationLineTool.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ctools%5CImageOverlayViewerTool.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ctools%5COverlayPlaneModuleProvider.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ctypes%5CColorbar.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ctypes%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CCornerstoneViewportDownloadForm.tsx","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CDicomFileUploader.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CJumpPresets.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5Ccolormaps.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CdicomLoaderService.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CfindNearbyToolData.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CgenerateSegmentationCSVReport.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CgetActiveViewportEnabledElement.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CgetCornerstoneBlendMode.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CgetCornerstoneOrientation.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CgetCornerstoneViewportType.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CgetInterleavedFrames.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CgetNthFrames.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CgetViewportOrientationFromImageOrientationPatient.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5ChydrationUtils.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CimageSliceSync%5CtoggleImageSliceSync.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CinitViewTiming.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5Cinterleave.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CinterleaveCenterLoader.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CinterleaveTopToBottom.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CisReferenceViewable.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CAngle.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CArrowAnnotate.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CBidirectional.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CCircleROI.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CCobbAngle.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CEllipticalROI.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CLength.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CLivewireContour.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CPlanarFreehandROI.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CProbe.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CRectangleROI.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CSegmentBidirectional.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CSplineROI.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CUltrasoundDirectional.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5Cconstants%5CsupportedTools.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5CmeasurementServiceMappingsFactory.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5Cutils%5CgetDisplayUnit.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5Cutils%5CgetHandlesFromPoints.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5Cutils%5CgetIsLocked.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5Cutils%5CgetIsVisible.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5Cutils%5CgetSOPInstanceAttributes.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5Cutils%5CgetValueDisplayString.js","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5Cutils%5Cindex.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CmeasurementServiceMappings%5Cutils%5Cselection.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CnthLoader.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CpromptHydrationDialog.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CsegmentUtils.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CsegmentationHandlers.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CsetUpSegmentationEventHandlers.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CtoggleVOISliceSync.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5Ctransitions.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Cutils%5CupdateSegmentationStats.ts","file:///D:%5CUsers%5Ccjohnson%5CGitRepositories%5COHIF-Viewer-Dev%5Cohif%5Cextensions%5Ccornerstone%5Csrc%5Ccomponents%5CDicomUpload%5CDicomUpload.css","webpack:///../../../extensions/cornerstone/src/components/DicomUpload/DicomUpload.css?19c7"],"sourcesContent":["import {\r\n  getEnabledElement,\r\n  StackViewport,\r\n  VolumeViewport,\r\n  utilities as csUtils,\r\n  Enums as CoreEnums,\r\n  Types as CoreTypes,\r\n  BaseVolumeViewport,\r\n  getRenderingEngines,\r\n} from '@cornerstonejs/core';\r\nimport {\r\n  ToolGroupManager,\r\n  Enums,\r\n  utilities as cstUtils,\r\n  annotation,\r\n  Types as ToolTypes,\r\n} from '@cornerstonejs/tools';\r\nimport * as cornerstoneTools from '@cornerstonejs/tools';\r\nimport * as labelmapInterpolation from '@cornerstonejs/labelmap-interpolation';\r\nimport { ONNXSegmentationController } from '@cornerstonejs/ai';\r\n\r\nimport { Types as OhifTypes, utils } from '@ohif/core';\r\nimport i18n from '@ohif/i18n';\r\nimport {\r\n  callInputDialogAutoComplete,\r\n  createReportAsync,\r\n  colorPickerDialog,\r\n  callInputDialog,\r\n} from '@ohif/extension-default';\r\nimport { vec3, mat4 } from 'gl-matrix';\r\nimport toggleImageSliceSync from './utils/imageSliceSync/toggleImageSliceSync';\r\nimport { getFirstAnnotationSelected } from './utils/measurementServiceMappings/utils/selection';\r\nimport getActiveViewportEnabledElement from './utils/getActiveViewportEnabledElement';\r\nimport toggleVOISliceSync from './utils/toggleVOISliceSync';\r\nimport { usePositionPresentationStore, useSegmentationPresentationStore } from './stores';\r\nimport { toolNames } from './initCornerstoneTools';\r\nimport CornerstoneViewportDownloadForm from './utils/CornerstoneViewportDownloadForm';\r\nimport { updateSegmentBidirectionalStats } from './utils/updateSegmentationStats';\r\nimport { generateSegmentationCSVReport } from './utils/generateSegmentationCSVReport';\r\nimport { getUpdatedViewportsForSegmentation } from './utils/hydrationUtils';\r\nimport { SegmentationRepresentations } from '@cornerstonejs/tools/enums';\r\n\r\nconst { DefaultHistoryMemo } = csUtils.HistoryMemo;\r\nconst toggleSyncFunctions = {\r\n  imageSlice: toggleImageSliceSync,\r\n  voi: toggleVOISliceSync,\r\n};\r\n\r\nconst { segmentation: segmentationUtils } = cstUtils;\r\n\r\nconst getLabelmapTools = ({ toolGroupService }) => {\r\n  const labelmapTools = [];\r\n  const toolGroupIds = toolGroupService.getToolGroupIds();\r\n  toolGroupIds.forEach(toolGroupId => {\r\n    const toolGroup = cornerstoneTools.ToolGroupManager.getToolGroup(toolGroupId);\r\n    const tools = toolGroup.getToolInstances();\r\n    // tools is an object with toolName as the key and tool as the value\r\n    Object.keys(tools).forEach(toolName => {\r\n      const tool = tools[toolName];\r\n      if (tool instanceof cornerstoneTools.LabelmapBaseTool) {\r\n        labelmapTools.push(tool);\r\n      }\r\n    });\r\n  });\r\n  return labelmapTools;\r\n};\r\n\r\nconst segmentAI = new ONNXSegmentationController({\r\n  autoSegmentMode: true,\r\n  models: {\r\n    sam_b: [\r\n      {\r\n        name: 'sam-b-encoder',\r\n        url: 'https://huggingface.co/schmuell/sam-b-fp16/resolve/main/sam_vit_b_01ec64.encoder-fp16.onnx',\r\n        size: 180,\r\n        key: 'encoder',\r\n      },\r\n      {\r\n        name: 'sam-b-decoder',\r\n        url: 'https://huggingface.co/schmuell/sam-b-fp16/resolve/main/sam_vit_b_01ec64.decoder.onnx',\r\n        size: 17,\r\n        key: 'decoder',\r\n      },\r\n    ],\r\n  },\r\n  modelName: 'sam_b',\r\n});\r\nlet segmentAIEnabled = false;\r\n\r\nfunction commandsModule({\r\n  servicesManager,\r\n  commandsManager,\r\n}: OhifTypes.Extensions.ExtensionParams): OhifTypes.Extensions.CommandsModule {\r\n  const {\r\n    viewportGridService,\r\n    toolGroupService,\r\n    cineService,\r\n    uiDialogService,\r\n    cornerstoneViewportService,\r\n    uiNotificationService,\r\n    measurementService,\r\n    customizationService,\r\n    colorbarService,\r\n    hangingProtocolService,\r\n    syncGroupService,\r\n    segmentationService,\r\n    displaySetService,\r\n  } = servicesManager.services as AppTypes.Services;\r\n\r\n  function _getActiveViewportEnabledElement() {\r\n    return getActiveViewportEnabledElement(viewportGridService);\r\n  }\r\n\r\n  function _getActiveViewportToolGroupId() {\r\n    const viewport = _getActiveViewportEnabledElement();\r\n    return toolGroupService.getToolGroupForViewport(viewport.id);\r\n  }\r\n\r\n  function _getActiveSegmentationInfo() {\r\n    const viewportId = viewportGridService.getActiveViewportId();\r\n    const activeSegmentation = segmentationService.getActiveSegmentation(viewportId);\r\n    const segmentationId = activeSegmentation?.segmentationId;\r\n    const activeSegmentIndex = segmentationService.getActiveSegment(viewportId).segmentIndex;\r\n\r\n    return {\r\n      segmentationId,\r\n      segmentIndex: activeSegmentIndex,\r\n    };\r\n  }\r\n\r\n  const actions = {\r\n    hydrateSecondaryDisplaySet: async ({ displaySet, viewportId }) => {\r\n      if (!displaySet) {\r\n        return;\r\n      }\r\n\r\n      if (displaySet.isOverlayDisplaySet) {\r\n        // update the previously stored segmentationPresentation with the new viewportId\r\n        // presentation so that when we put the referencedDisplaySet back in the viewport\r\n        // it will have the correct segmentation representation hydrated\r\n        commandsManager.runCommand('updateStoredSegmentationPresentation', {\r\n          displaySet,\r\n          type:\r\n            displaySet.Modality === 'SEG'\r\n              ? SegmentationRepresentations.Labelmap\r\n              : SegmentationRepresentations.Contour,\r\n        });\r\n      }\r\n\r\n      const referencedDisplaySetInstanceUID = displaySet.referencedDisplaySetInstanceUID;\r\n\r\n      const storePositionPresentation = refDisplaySet => {\r\n        // update the previously stored positionPresentation with the new viewportId\r\n        // presentation so that when we put the referencedDisplaySet back in the viewport\r\n        // it will be in the correct position zoom and pan\r\n        commandsManager.runCommand('updateStoredPositionPresentation', {\r\n          viewportId,\r\n          displaySetInstanceUIDs: [refDisplaySet.displaySetInstanceUID],\r\n        });\r\n      };\r\n\r\n      if (displaySet.Modality === 'SEG' || displaySet.Modality === 'RTSTRUCT') {\r\n        const referencedDisplaySet = displaySetService.getDisplaySetByUID(\r\n          referencedDisplaySetInstanceUID\r\n        );\r\n        storePositionPresentation(referencedDisplaySet);\r\n        return commandsManager.runCommand('loadSegmentationDisplaySetsForViewport', {\r\n          viewportId,\r\n          displaySetInstanceUIDs: [referencedDisplaySet.displaySetInstanceUID],\r\n        });\r\n      } else if (displaySet.Modality === 'SR') {\r\n        const results = commandsManager.runCommand('hydrateStructuredReport', {\r\n          displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n        });\r\n        const { SeriesInstanceUIDs } = results;\r\n        const referencedDisplaySets = displaySetService.getDisplaySetsForSeries(\r\n          SeriesInstanceUIDs[0]\r\n        );\r\n        referencedDisplaySets.forEach(storePositionPresentation);\r\n\r\n        if (referencedDisplaySets.length) {\r\n          actions.setDisplaySetsForViewports({\r\n            viewportsToUpdate: [\r\n              {\r\n                viewportId: viewportGridService.getActiveViewportId(),\r\n                displaySetInstanceUIDs: [referencedDisplaySets[0].displaySetInstanceUID],\r\n              },\r\n            ],\r\n          });\r\n        }\r\n        return results;\r\n      }\r\n    },\r\n    runSegmentBidirectional: async ({ segmentationId, segmentIndex } = {}) => {\r\n      // Get active segmentation if not specified\r\n      const targetSegmentation =\r\n        segmentationId && segmentIndex\r\n          ? { segmentationId, segmentIndex }\r\n          : _getActiveSegmentationInfo();\r\n\r\n      const { segmentationId: targetId, segmentIndex: targetIndex } = targetSegmentation;\r\n\r\n      // Get bidirectional measurement data\r\n      const bidirectionalData = await cstUtils.segmentation.getSegmentLargestBidirectional({\r\n        segmentationId: targetId,\r\n        segmentIndices: [targetIndex],\r\n      });\r\n\r\n      const activeViewportId = viewportGridService.getActiveViewportId();\r\n\r\n      // Process each bidirectional measurement\r\n      bidirectionalData.forEach(measurement => {\r\n        const { segmentIndex, majorAxis, minorAxis } = measurement;\r\n\r\n        // Create annotation\r\n        const annotation = cornerstoneTools.SegmentBidirectionalTool.hydrate(\r\n          activeViewportId,\r\n          [majorAxis, minorAxis],\r\n          {\r\n            segmentIndex,\r\n            segmentationId: targetId,\r\n          }\r\n        );\r\n\r\n        measurement.annotationUID = annotation.annotationUID;\r\n\r\n        // Update segmentation stats\r\n        const updatedSegmentation = updateSegmentBidirectionalStats({\r\n          segmentationId: targetId,\r\n          segmentIndex: targetIndex,\r\n          bidirectionalData: measurement,\r\n          segmentationService,\r\n          annotation,\r\n        });\r\n\r\n        // Save changes if needed\r\n        if (updatedSegmentation) {\r\n          segmentationService.addOrUpdateSegmentation({\r\n            segmentationId: targetId,\r\n            segments: updatedSegmentation.segments,\r\n          });\r\n        }\r\n      });\r\n\r\n      // get the active segmentIndex bidirectional annotation and jump to it\r\n      const activeBidirectional = bidirectionalData.find(\r\n        measurement => measurement.segmentIndex === targetIndex\r\n      );\r\n      commandsManager.run('jumpToMeasurement', {\r\n        uid: activeBidirectional.annotationUID,\r\n      });\r\n    },\r\n    interpolateLabelmap: () => {\r\n      const { segmentationId, segmentIndex } = _getActiveSegmentationInfo();\r\n      labelmapInterpolation.interpolate({\r\n        segmentationId,\r\n        segmentIndex,\r\n      });\r\n    },\r\n    /**\r\n     * Generates the selector props for the context menu, specific to\r\n     * the cornerstone viewport, and then runs the context menu.\r\n     */\r\n    showCornerstoneContextMenu: options => {\r\n      const element = _getActiveViewportEnabledElement()?.viewport?.element;\r\n\r\n      const optionsToUse = { ...options, element };\r\n      const { useSelectedAnnotation, nearbyToolData, event } = optionsToUse;\r\n\r\n      // This code is used to invoke the context menu via keyboard shortcuts\r\n      if (useSelectedAnnotation && !nearbyToolData) {\r\n        const firstAnnotationSelected = getFirstAnnotationSelected(element);\r\n        // filter by allowed selected tools from config property (if there is any)\r\n        const isToolAllowed =\r\n          !optionsToUse.allowedSelectedTools ||\r\n          optionsToUse.allowedSelectedTools.includes(firstAnnotationSelected?.metadata?.toolName);\r\n        if (isToolAllowed) {\r\n          optionsToUse.nearbyToolData = firstAnnotationSelected;\r\n        } else {\r\n          return;\r\n        }\r\n      }\r\n\r\n      optionsToUse.defaultPointsPosition = [];\r\n      // if (optionsToUse.nearbyToolData) {\r\n      //   optionsToUse.defaultPointsPosition = commandsManager.runCommand(\r\n      //     'getToolDataActiveCanvasPoints',\r\n      //     { toolData: optionsToUse.nearbyToolData }\r\n      //   );\r\n      // }\r\n\r\n      // TODO - make the selectorProps richer by including the study metadata and display set.\r\n      optionsToUse.selectorProps = {\r\n        toolName: optionsToUse.nearbyToolData?.metadata?.toolName,\r\n        value: optionsToUse.nearbyToolData,\r\n        uid: optionsToUse.nearbyToolData?.annotationUID,\r\n        nearbyToolData: optionsToUse.nearbyToolData,\r\n        event,\r\n        ...optionsToUse.selectorProps,\r\n      };\r\n\r\n      commandsManager.run(options, optionsToUse);\r\n    },\r\n    updateStoredSegmentationPresentation: ({ displaySet, type }) => {\r\n      const { addSegmentationPresentationItem } = useSegmentationPresentationStore.getState();\r\n\r\n      const referencedDisplaySetInstanceUID = displaySet.referencedDisplaySetInstanceUID;\r\n      addSegmentationPresentationItem(referencedDisplaySetInstanceUID, {\r\n        segmentationId: displaySet.displaySetInstanceUID,\r\n        hydrated: true,\r\n        type,\r\n      });\r\n    },\r\n    updateStoredPositionPresentation: ({\r\n      viewportId,\r\n      displaySetInstanceUIDs,\r\n      referencedImageId,\r\n      options,\r\n    }) => {\r\n      const presentations = cornerstoneViewportService.getPresentations(viewportId);\r\n      const { positionPresentationStore, setPositionPresentation, getPositionPresentationId } =\r\n        usePositionPresentationStore.getState();\r\n\r\n      // Look inside positionPresentationStore and find the key that includes ALL the displaySetInstanceUIDs\r\n      // and the value has viewportId as activeViewportId.\r\n      let previousReferencedDisplaySetStoreKey;\r\n\r\n      if (\r\n        displaySetInstanceUIDs &&\r\n        Array.isArray(displaySetInstanceUIDs) &&\r\n        displaySetInstanceUIDs.length > 0\r\n      ) {\r\n        previousReferencedDisplaySetStoreKey = Object.entries(positionPresentationStore).find(\r\n          ([key, value]) => {\r\n            return (\r\n              displaySetInstanceUIDs.every(uid => key.includes(uid)) &&\r\n              value.viewportId === viewportId\r\n            );\r\n          }\r\n        )?.[0];\r\n      }\r\n\r\n      // Create presentation data with referencedImageId and options if provided\r\n      const presentationData = referencedImageId\r\n        ? {\r\n            ...presentations.positionPresentation,\r\n            viewReference: {\r\n              referencedImageId,\r\n              ...options,\r\n            },\r\n          }\r\n        : presentations.positionPresentation;\r\n\r\n      if (previousReferencedDisplaySetStoreKey) {\r\n        setPositionPresentation(previousReferencedDisplaySetStoreKey, presentationData);\r\n        return;\r\n      }\r\n\r\n      // if not found means we have not visited that referencedDisplaySetInstanceUID before\r\n      // so we need to grab the positionPresentationId directly from the store,\r\n      // Todo: this is really hacky, we should have a better way for this\r\n      const positionPresentationId = getPositionPresentationId({\r\n        displaySetInstanceUIDs,\r\n        viewportId,\r\n      });\r\n\r\n      setPositionPresentation(positionPresentationId, presentationData);\r\n    },\r\n    getNearbyToolData({ nearbyToolData, element, canvasCoordinates }) {\r\n      return nearbyToolData ?? cstUtils.getAnnotationNearPoint(element, canvasCoordinates);\r\n    },\r\n    getNearbyAnnotation({ element, canvasCoordinates }) {\r\n      const nearbyToolData = actions.getNearbyToolData({\r\n        nearbyToolData: null,\r\n        element,\r\n        canvasCoordinates,\r\n      });\r\n\r\n      const isAnnotation = toolName => {\r\n        const enabledElement = getEnabledElement(element);\r\n\r\n        if (!enabledElement) {\r\n          return;\r\n        }\r\n\r\n        const { renderingEngineId, viewportId } = enabledElement;\r\n        const toolGroup = ToolGroupManager.getToolGroupForViewport(viewportId, renderingEngineId);\r\n\r\n        const toolInstance = toolGroup.getToolInstance(toolName);\r\n\r\n        return toolInstance?.constructor?.isAnnotation ?? true;\r\n      };\r\n\r\n      return nearbyToolData?.metadata?.toolName && isAnnotation(nearbyToolData.metadata.toolName)\r\n        ? nearbyToolData\r\n        : null;\r\n    },\r\n    /**\r\n     * Common logic for handling measurement label updates through dialog\r\n     * @param uid - measurement uid\r\n     * @returns Promise that resolves when the label is updated\r\n     */\r\n    _handleMeasurementLabelDialog: async uid => {\r\n      const labelConfig = customizationService.getCustomization('measurementLabels');\r\n      const renderContent = customizationService.getCustomization('ui.labellingComponent');\r\n      const measurement = measurementService.getMeasurement(uid);\r\n\r\n      if (!measurement) {\r\n        console.debug('No measurement found for label editing');\r\n        return;\r\n      }\r\n\r\n      if (!labelConfig) {\r\n        const label = await callInputDialog({\r\n          uiDialogService,\r\n          title: 'Edit Measurement Label',\r\n          placeholder: measurement.label || 'Enter new label',\r\n          defaultValue: measurement.label,\r\n        });\r\n\r\n        if (label !== undefined && label !== null) {\r\n          measurementService.update(uid, { ...measurement, label }, true);\r\n        }\r\n        return;\r\n      }\r\n\r\n      const val = await callInputDialogAutoComplete({\r\n        measurement,\r\n        uiDialogService,\r\n        labelConfig,\r\n        renderContent,\r\n      });\r\n\r\n      if (val !== undefined && val !== null) {\r\n        measurementService.update(uid, { ...val }, true);\r\n      }\r\n    },\r\n    /**\r\n     * Show the measurement labelling input dialog and update the label\r\n     * on the measurement with a response if not cancelled.\r\n     */\r\n    setMeasurementLabel: async ({ uid }) => {\r\n      await actions._handleMeasurementLabelDialog(uid);\r\n    },\r\n    renameMeasurement: async ({ uid }) => {\r\n      await actions._handleMeasurementLabelDialog(uid);\r\n    },\r\n    /**\r\n     *\r\n     * @param props - containing the updates to apply\r\n     * @param props.measurementKey - chooses the measurement key to apply the\r\n     *        code to.  This will typically be finding or site to apply a\r\n     *        finding code or a findingSites code.\r\n     * @param props.code - A coding scheme value from DICOM, including:\r\n     *       * CodeValue - the language independent code, for example '1234'\r\n     *       * CodingSchemeDesignator - the issue of the code value\r\n     *       * CodeMeaning - the text value shown to the user\r\n     *       * ref - a string reference in the form `<designator>:<codeValue>`\r\n     *       * type - defaulting to 'finding'.  Will replace other codes of same type\r\n     *       * style - a styling object to use\r\n     *       * Other fields\r\n     *     Note it is a valid option to remove the finding or site values by\r\n     *     supplying null for the code.\r\n     * @param props.uid - the measurement UID to find it with\r\n     * @param props.label - the text value for the code.  Has NOTHING to do with\r\n     *        the measurement label, which can be set with textLabel\r\n     * @param props.textLabel is the measurement label to apply.  Set to null to\r\n     *            delete.\r\n     *\r\n     * If the measurementKey is `site`, then the code will also be added/replace\r\n     * the 0 element of findingSites.  This behaviour is expected to be enhanced\r\n     * in the future with ability to set other site information.\r\n     */\r\n    updateMeasurement: props => {\r\n      const { code, uid, textLabel, label } = props;\r\n      let { style } = props;\r\n      const measurement = measurementService.getMeasurement(uid);\r\n      if (!measurement) {\r\n        console.warn('No measurement found to update', uid);\r\n        return;\r\n      }\r\n      const updatedMeasurement = {\r\n        ...measurement,\r\n      };\r\n      // Call it textLabel as the label value\r\n      // TODO - remove the label setting when direct rendering of findingSites is enabled\r\n      if (textLabel !== undefined) {\r\n        updatedMeasurement.label = textLabel;\r\n      }\r\n      if (code !== undefined) {\r\n        const measurementKey = code.type || 'finding';\r\n\r\n        if (code.ref && !code.CodeValue) {\r\n          const split = code.ref.indexOf(':');\r\n          code.CodeValue = code.ref.substring(split + 1);\r\n          code.CodeMeaning = code.text || label;\r\n          code.CodingSchemeDesignator = code.ref.substring(0, split);\r\n        }\r\n        updatedMeasurement[measurementKey] = code;\r\n        if (measurementKey !== 'finding') {\r\n          if (updatedMeasurement.findingSites) {\r\n            updatedMeasurement.findingSites = updatedMeasurement.findingSites.filter(\r\n              it => it.type !== measurementKey\r\n            );\r\n            updatedMeasurement.findingSites.push(code);\r\n          } else {\r\n            updatedMeasurement.findingSites = [code];\r\n          }\r\n        }\r\n      }\r\n\r\n      style ||= updatedMeasurement.finding?.style;\r\n      style ||= updatedMeasurement.findingSites?.find(site => site?.style)?.style;\r\n\r\n      if (style) {\r\n        // Reset the selected values to preserve appearance on selection\r\n        style.lineDashSelected ||= style.lineDash;\r\n        annotation.config.style.setAnnotationStyles(measurement.uid, style);\r\n\r\n        // this is a bit ugly, but given the underlying behavior, this is how it needs to work.\r\n        switch (measurement.toolName) {\r\n          case toolNames.PlanarFreehandROI: {\r\n            const targetAnnotation = annotation.state.getAnnotation(measurement.uid);\r\n            targetAnnotation.data.isOpenUShapeContour = !!style.isOpenUShapeContour;\r\n            break;\r\n          }\r\n          default:\r\n            break;\r\n        }\r\n      }\r\n      measurementService.update(updatedMeasurement.uid, updatedMeasurement, true);\r\n    },\r\n\r\n    /**\r\n     * Jumps to the specified (by uid) measurement in the active viewport.\r\n     * Also marks any provided display measurements isActive value\r\n     */\r\n    jumpToMeasurement: ({ uid, displayMeasurements = [] }) => {\r\n      measurementService.jumpToMeasurement(viewportGridService.getActiveViewportId(), uid);\r\n      for (const measurement of displayMeasurements) {\r\n        measurement.isActive = measurement.uid === uid;\r\n      }\r\n    },\r\n\r\n    removeMeasurement: ({ uid }) => {\r\n      if (Array.isArray(uid)) {\r\n        measurementService.removeMany(uid);\r\n      } else {\r\n        measurementService.remove(uid);\r\n      }\r\n    },\r\n\r\n    toggleLockMeasurement: ({ uid }) => {\r\n      measurementService.toggleLockMeasurement(uid);\r\n    },\r\n\r\n    toggleVisibilityMeasurement: ({ uid, items, visibility }) => {\r\n      if (visibility === undefined && items?.length) {\r\n        visibility = !items[0].isVisible;\r\n      }\r\n      if (Array.isArray(uid)) {\r\n        measurementService.toggleVisibilityMeasurementMany(uid, visibility);\r\n      } else {\r\n        measurementService.toggleVisibilityMeasurement(uid, visibility);\r\n      }\r\n    },\r\n\r\n    /**\r\n     * Download the CSV report for the measurements.\r\n     */\r\n    downloadCSVMeasurementsReport: ({ measurementFilter }) => {\r\n      utils.downloadCSVReport(measurementService.getMeasurements(measurementFilter));\r\n    },\r\n\r\n    downloadCSVSegmentationReport: ({ segmentationId }) => {\r\n      const segmentation = segmentationService.getSegmentation(segmentationId);\r\n\r\n      const { representationData } = segmentation;\r\n      const { Labelmap } = representationData;\r\n      const { referencedImageIds } = Labelmap;\r\n\r\n      const firstImageId = referencedImageIds[0];\r\n\r\n      // find displaySet for firstImageId\r\n      const displaySet = displaySetService\r\n        .getActiveDisplaySets()\r\n        .find(ds => ds.imageIds?.some(i => i === firstImageId));\r\n\r\n      const {\r\n        SeriesNumber,\r\n        SeriesInstanceUID,\r\n        StudyInstanceUID,\r\n        SeriesDate,\r\n        SeriesTime,\r\n        SeriesDescription,\r\n      } = displaySet;\r\n\r\n      const additionalInfo = {\r\n        reference: {\r\n          SeriesNumber,\r\n          SeriesInstanceUID,\r\n          StudyInstanceUID,\r\n          SeriesDate,\r\n          SeriesTime,\r\n          SeriesDescription,\r\n        },\r\n      };\r\n\r\n      generateSegmentationCSVReport(segmentation, additionalInfo);\r\n    },\r\n\r\n    // Retrieve value commands\r\n    getActiveViewportEnabledElement: _getActiveViewportEnabledElement,\r\n\r\n    setViewportActive: ({ viewportId }) => {\r\n      const viewportInfo = cornerstoneViewportService.getViewportInfo(viewportId);\r\n      if (!viewportInfo) {\r\n        console.warn('No viewport found for viewportId:', viewportId);\r\n        return;\r\n      }\r\n\r\n      viewportGridService.setActiveViewportId(viewportId);\r\n    },\r\n    arrowTextCallback: async ({ callback }) => {\r\n      const labelConfig = customizationService.getCustomization('measurementLabels');\r\n      const renderContent = customizationService.getCustomization('ui.labellingComponent');\r\n\r\n      const value = await callInputDialogAutoComplete({\r\n        uiDialogService,\r\n        labelConfig,\r\n        renderContent,\r\n      });\r\n      callback?.(value);\r\n    },\r\n\r\n    toggleCine: () => {\r\n      const { viewports } = viewportGridService.getState();\r\n      const { isCineEnabled } = cineService.getState();\r\n      cineService.setIsCineEnabled(!isCineEnabled);\r\n      viewports.forEach((_, index) => cineService.setCine({ id: index, isPlaying: false }));\r\n    },\r\n\r\n    setViewportWindowLevel({\r\n      viewportId,\r\n      windowWidth,\r\n      windowCenter,\r\n      displaySetInstanceUID,\r\n    }: {\r\n      viewportId: string;\r\n      windowWidth: number;\r\n      windowCenter: number;\r\n      displaySetInstanceUID?: string;\r\n    }) {\r\n      // convert to numbers\r\n      const windowWidthNum = Number(windowWidth);\r\n      const windowCenterNum = Number(windowCenter);\r\n\r\n      // get actor from the viewport\r\n      const renderingEngine = cornerstoneViewportService.getRenderingEngine();\r\n      const viewport = renderingEngine.getViewport(viewportId);\r\n\r\n      const { lower, upper } = csUtils.windowLevel.toLowHighRange(windowWidthNum, windowCenterNum);\r\n\r\n      if (viewport instanceof BaseVolumeViewport) {\r\n        const volumeId = actions.getVolumeIdForDisplaySet({\r\n          viewportId,\r\n          displaySetInstanceUID,\r\n        });\r\n        viewport.setProperties(\r\n          {\r\n            voiRange: {\r\n              upper,\r\n              lower,\r\n            },\r\n          },\r\n          volumeId\r\n        );\r\n      } else {\r\n        viewport.setProperties({\r\n          voiRange: {\r\n            upper,\r\n            lower,\r\n          },\r\n        });\r\n      }\r\n      viewport.render();\r\n    },\r\n    toggleViewportColorbar: ({ viewportId, displaySetInstanceUIDs, options = {} }) => {\r\n      const hasColorbar = colorbarService.hasColorbar(viewportId);\r\n      if (hasColorbar) {\r\n        colorbarService.removeColorbar(viewportId);\r\n        return;\r\n      }\r\n      colorbarService.addColorbar(viewportId, displaySetInstanceUIDs, options);\r\n    },\r\n    setWindowLevel(props) {\r\n      const { toolGroupId } = props;\r\n      const { viewportId } = _getActiveViewportEnabledElement();\r\n      const viewportToolGroupId = toolGroupService.getToolGroupForViewport(viewportId);\r\n\r\n      if (toolGroupId && toolGroupId !== viewportToolGroupId) {\r\n        return;\r\n      }\r\n\r\n      actions.setViewportWindowLevel({ ...props, viewportId });\r\n    },\r\n    setWindowLevelPreset: ({ presetName, presetIndex }) => {\r\n      const windowLevelPresets = customizationService.getCustomization(\r\n        'cornerstone.windowLevelPresets'\r\n      );\r\n\r\n      const activeViewport = viewportGridService.getActiveViewportId();\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(activeViewport);\r\n      const metadata = viewport.getImageData().metadata;\r\n\r\n      const modality = metadata.Modality;\r\n\r\n      if (!modality) {\r\n        return;\r\n      }\r\n\r\n      const windowLevelPresetForModality = windowLevelPresets[modality];\r\n\r\n      if (!windowLevelPresetForModality) {\r\n        return;\r\n      }\r\n\r\n      const windowLevelPreset =\r\n        windowLevelPresetForModality[presetName] ??\r\n        Object.values(windowLevelPresetForModality)[presetIndex];\r\n\r\n      actions.setViewportWindowLevel({\r\n        viewportId: activeViewport,\r\n        windowWidth: windowLevelPreset.window,\r\n        windowCenter: windowLevelPreset.level,\r\n      });\r\n    },\r\n    getVolumeIdForDisplaySet: ({ viewportId, displaySetInstanceUID }) => {\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n      if (viewport instanceof BaseVolumeViewport) {\r\n        const volumeIds = viewport.getAllVolumeIds();\r\n        const volumeId = volumeIds.find(id => id.includes(displaySetInstanceUID));\r\n        return volumeId;\r\n      }\r\n      return null;\r\n    },\r\n    setToolEnabled: ({ toolName, toggle, toolGroupId }) => {\r\n      const { viewports } = viewportGridService.getState();\r\n\r\n      if (!viewports.size) {\r\n        return;\r\n      }\r\n\r\n      const toolGroup = toolGroupService.getToolGroup(toolGroupId ?? null);\r\n\r\n      if (!toolGroup || !toolGroup.hasTool(toolName)) {\r\n        return;\r\n      }\r\n\r\n      const toolIsEnabled = toolGroup.getToolOptions(toolName).mode === Enums.ToolModes.Enabled;\r\n\r\n      // Toggle the tool's state only if the toggle is true\r\n      if (toggle) {\r\n        toolIsEnabled ? toolGroup.setToolDisabled(toolName) : toolGroup.setToolEnabled(toolName);\r\n      } else {\r\n        toolGroup.setToolEnabled(toolName);\r\n      }\r\n\r\n      const renderingEngine = cornerstoneViewportService.getRenderingEngine();\r\n      renderingEngine.render();\r\n    },\r\n    toggleEnabledDisabledToolbar({ value, itemId, toolGroupId }) {\r\n      const toolName = itemId || value;\r\n      toolGroupId = toolGroupId ?? _getActiveViewportToolGroupId();\r\n\r\n      const toolGroup = toolGroupService.getToolGroup(toolGroupId);\r\n      if (!toolGroup || !toolGroup.hasTool(toolName)) {\r\n        return;\r\n      }\r\n\r\n      const toolIsEnabled = toolGroup.getToolOptions(toolName).mode === Enums.ToolModes.Enabled;\r\n\r\n      toolIsEnabled ? toolGroup.setToolDisabled(toolName) : toolGroup.setToolEnabled(toolName);\r\n    },\r\n    toggleActiveDisabledToolbar({ value, itemId, toolGroupId }) {\r\n      const toolName = itemId || value;\r\n      toolGroupId = toolGroupId ?? _getActiveViewportToolGroupId();\r\n      const toolGroup = toolGroupService.getToolGroup(toolGroupId);\r\n      if (!toolGroup || !toolGroup.hasTool(toolName)) {\r\n        return;\r\n      }\r\n\r\n      const toolIsActive = [\r\n        Enums.ToolModes.Active,\r\n        Enums.ToolModes.Enabled,\r\n        Enums.ToolModes.Passive,\r\n      ].includes(toolGroup.getToolOptions(toolName).mode);\r\n\r\n      toolIsActive\r\n        ? toolGroup.setToolDisabled(toolName)\r\n        : actions.setToolActive({ toolName, toolGroupId });\r\n\r\n      // we should set the previously active tool to active after we set the\r\n      // current tool disabled\r\n      if (toolIsActive) {\r\n        const prevToolName = toolGroup.getPrevActivePrimaryToolName();\r\n        if (prevToolName !== toolName) {\r\n          actions.setToolActive({ toolName: prevToolName, toolGroupId });\r\n        }\r\n      }\r\n    },\r\n    setToolActiveToolbar: ({ value, itemId, toolName, toolGroupIds = [] }) => {\r\n      // Sometimes it is passed as value (tools with options), sometimes as itemId (toolbar buttons)\r\n      toolName = toolName || itemId || value;\r\n\r\n      toolGroupIds = toolGroupIds.length ? toolGroupIds : toolGroupService.getToolGroupIds();\r\n\r\n      toolGroupIds.forEach(toolGroupId => {\r\n        actions.setToolActive({ toolName, toolGroupId });\r\n      });\r\n    },\r\n    setToolActive: ({ toolName, toolGroupId = null }) => {\r\n      const { viewports } = viewportGridService.getState();\r\n\r\n      if (!viewports.size) {\r\n        return;\r\n      }\r\n\r\n      const toolGroup = toolGroupService.getToolGroup(toolGroupId);\r\n\r\n      if (!toolGroup) {\r\n        return;\r\n      }\r\n\r\n      if (!toolGroup?.hasTool(toolName)) {\r\n        return;\r\n      }\r\n\r\n      const activeToolName = toolGroup.getActivePrimaryMouseButtonTool();\r\n\r\n      if (activeToolName) {\r\n        const activeToolOptions = toolGroup.getToolConfiguration(activeToolName);\r\n        activeToolOptions?.disableOnPassive\r\n          ? toolGroup.setToolDisabled(activeToolName)\r\n          : toolGroup.setToolPassive(activeToolName);\r\n      }\r\n\r\n      // Set the new toolName to be active\r\n      toolGroup.setToolActive(toolName, {\r\n        bindings: [\r\n          {\r\n            mouseButton: Enums.MouseBindings.Primary,\r\n          },\r\n        ],\r\n      });\r\n    },\r\n    // capture viewport\r\n    showDownloadViewportModal: () => {\r\n      const { activeViewportId } = viewportGridService.getState();\r\n\r\n      if (!cornerstoneViewportService.getCornerstoneViewport(activeViewportId)) {\r\n        // Cannot download a non-cornerstone viewport (image).\r\n        uiNotificationService.show({\r\n          title: 'Download Image',\r\n          message: 'Image cannot be downloaded',\r\n          type: 'error',\r\n        });\r\n        return;\r\n      }\r\n\r\n      const { uiModalService } = servicesManager.services;\r\n\r\n      if (uiModalService) {\r\n        uiModalService.show({\r\n          content: CornerstoneViewportDownloadForm,\r\n          title: 'Download High Quality Image',\r\n          contentProps: {\r\n            activeViewportId,\r\n            cornerstoneViewportService,\r\n          },\r\n          containerClassName: 'max-w-4xl p-4',\r\n        });\r\n      }\r\n    },\r\n    rotateViewport: ({ rotation }) => {\r\n      const enabledElement = _getActiveViewportEnabledElement();\r\n      if (!enabledElement) {\r\n        return;\r\n      }\r\n\r\n      const { viewport } = enabledElement;\r\n\r\n      if (viewport instanceof BaseVolumeViewport) {\r\n        const camera = viewport.getCamera();\r\n        const rotAngle = (rotation * Math.PI) / 180;\r\n        const rotMat = mat4.identity(new Float32Array(16));\r\n        mat4.rotate(rotMat, rotMat, rotAngle, camera.viewPlaneNormal);\r\n        const rotatedViewUp = vec3.transformMat4(vec3.create(), camera.viewUp, rotMat);\r\n        viewport.setCamera({ viewUp: rotatedViewUp as CoreTypes.Point3 });\r\n        viewport.render();\r\n      } else if (viewport.getRotation !== undefined) {\r\n        const presentation = viewport.getViewPresentation();\r\n        const { rotation: currentRotation } = presentation;\r\n        const newRotation = (currentRotation + rotation + 360) % 360;\r\n        viewport.setViewPresentation({ rotation: newRotation });\r\n        viewport.render();\r\n      }\r\n    },\r\n    flipViewportHorizontal: () => {\r\n      const enabledElement = _getActiveViewportEnabledElement();\r\n\r\n      if (!enabledElement) {\r\n        return;\r\n      }\r\n\r\n      const { viewport } = enabledElement;\r\n\r\n      const { flipHorizontal } = viewport.getCamera();\r\n      viewport.setCamera({ flipHorizontal: !flipHorizontal });\r\n      viewport.render();\r\n    },\r\n    flipViewportVertical: () => {\r\n      const enabledElement = _getActiveViewportEnabledElement();\r\n\r\n      if (!enabledElement) {\r\n        return;\r\n      }\r\n\r\n      const { viewport } = enabledElement;\r\n\r\n      const { flipVertical } = viewport.getCamera();\r\n      viewport.setCamera({ flipVertical: !flipVertical });\r\n      viewport.render();\r\n    },\r\n    invertViewport: ({ element }) => {\r\n      let enabledElement;\r\n\r\n      if (element === undefined) {\r\n        enabledElement = _getActiveViewportEnabledElement();\r\n      } else {\r\n        enabledElement = element;\r\n      }\r\n\r\n      if (!enabledElement) {\r\n        return;\r\n      }\r\n\r\n      const { viewport } = enabledElement;\r\n\r\n      const { invert } = viewport.getProperties();\r\n      viewport.setProperties({ invert: !invert });\r\n      viewport.render();\r\n    },\r\n    resetViewport: () => {\r\n      const enabledElement = _getActiveViewportEnabledElement();\r\n\r\n      if (!enabledElement) {\r\n        return;\r\n      }\r\n\r\n      const { viewport } = enabledElement;\r\n\r\n      viewport.resetProperties?.();\r\n      viewport.resetCamera();\r\n\r\n      viewport.render();\r\n    },\r\n    scaleViewport: ({ direction }) => {\r\n      const enabledElement = _getActiveViewportEnabledElement();\r\n      const scaleFactor = direction > 0 ? 0.9 : 1.1;\r\n\r\n      if (!enabledElement) {\r\n        return;\r\n      }\r\n      const { viewport } = enabledElement;\r\n\r\n      if (viewport instanceof StackViewport) {\r\n        if (direction) {\r\n          const { parallelScale } = viewport.getCamera();\r\n          viewport.setCamera({ parallelScale: parallelScale * scaleFactor });\r\n          viewport.render();\r\n        } else {\r\n          viewport.resetCamera();\r\n          viewport.render();\r\n        }\r\n      }\r\n    },\r\n\r\n    /** Jumps the active viewport or the specified one to the given slice index */\r\n    jumpToImage: ({ imageIndex, viewport: gridViewport }): void => {\r\n      // Get current active viewport (return if none active)\r\n      let viewport;\r\n      if (!gridViewport) {\r\n        const enabledElement = _getActiveViewportEnabledElement();\r\n        if (!enabledElement) {\r\n          return;\r\n        }\r\n        viewport = enabledElement.viewport;\r\n      } else {\r\n        viewport = cornerstoneViewportService.getCornerstoneViewport(gridViewport.id);\r\n      }\r\n\r\n      // Get number of slices\r\n      // -> Copied from cornerstone3D jumpToSlice\\_getImageSliceData()\r\n      let numberOfSlices = 0;\r\n\r\n      if (viewport instanceof StackViewport) {\r\n        numberOfSlices = viewport.getImageIds().length;\r\n      } else if (viewport instanceof VolumeViewport) {\r\n        numberOfSlices = csUtils.getImageSliceDataForVolumeViewport(viewport).numberOfSlices;\r\n      } else {\r\n        throw new Error('Unsupported viewport type');\r\n      }\r\n\r\n      const jumpIndex = imageIndex < 0 ? numberOfSlices + imageIndex : imageIndex;\r\n      if (jumpIndex >= numberOfSlices || jumpIndex < 0) {\r\n        throw new Error(`Can't jump to ${imageIndex}`);\r\n      }\r\n\r\n      // Set slice to last slice\r\n      const options = { imageIndex: jumpIndex };\r\n      csUtils.jumpToSlice(viewport.element, options);\r\n    },\r\n    scroll: (options: ToolTypes.ScrollOptions) => {\r\n      const enabledElement = _getActiveViewportEnabledElement();\r\n      // Allow either or direction for consistency in scroll implementation\r\n      options.delta ??= options.direction || 1;\r\n      options.direction ??= options.delta;\r\n\r\n      if (!enabledElement) {\r\n        return;\r\n      }\r\n\r\n      const { viewport } = enabledElement;\r\n\r\n      csUtils.scroll(viewport, options);\r\n    },\r\n    setViewportColormap: ({\r\n      viewportId,\r\n      displaySetInstanceUID,\r\n      colormap,\r\n      opacity = 1,\r\n      immediate = false,\r\n    }) => {\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n      let hpOpacity;\r\n      // Retrieve active protocol's viewport match details\r\n      const { viewportMatchDetails } = hangingProtocolService.getActiveProtocol();\r\n      // Get display set options for the specified viewport ID\r\n      const displaySetsInfo = viewportMatchDetails.get(viewportId)?.displaySetsInfo;\r\n\r\n      if (displaySetsInfo) {\r\n        // Find the display set that matches the given UID\r\n        const matchingDisplaySet = displaySetsInfo.find(\r\n          displaySet => displaySet.displaySetInstanceUID === displaySetInstanceUID\r\n        );\r\n        // If a matching display set is found, update the opacity with its value\r\n        hpOpacity = matchingDisplaySet?.displaySetOptions?.options?.colormap?.opacity;\r\n      }\r\n\r\n      // HP takes priority over the default opacity\r\n      colormap = { ...colormap, opacity: hpOpacity || opacity };\r\n\r\n      if (viewport instanceof StackViewport) {\r\n        viewport.setProperties({ colormap });\r\n      }\r\n\r\n      if (viewport instanceof VolumeViewport) {\r\n        if (!displaySetInstanceUID) {\r\n          const { viewports } = viewportGridService.getState();\r\n          displaySetInstanceUID = viewports.get(viewportId)?.displaySetInstanceUIDs[0];\r\n        }\r\n\r\n        // ToDo: Find a better way of obtaining the volumeId that corresponds to the displaySetInstanceUID\r\n        const volumeId =\r\n          viewport\r\n            .getAllVolumeIds()\r\n            .find((_volumeId: string) => _volumeId.includes(displaySetInstanceUID)) ??\r\n          viewport.getVolumeId();\r\n        viewport.setProperties({ colormap }, volumeId);\r\n      }\r\n\r\n      if (immediate) {\r\n        viewport.render();\r\n      }\r\n    },\r\n    changeActiveViewport: ({ direction = 1 }) => {\r\n      const { activeViewportId, viewports } = viewportGridService.getState();\r\n      const viewportIds = Array.from(viewports.keys());\r\n      const currentIndex = viewportIds.indexOf(activeViewportId);\r\n      const nextViewportIndex =\r\n        (currentIndex + direction + viewportIds.length) % viewportIds.length;\r\n      viewportGridService.setActiveViewportId(viewportIds[nextViewportIndex] as string);\r\n    },\r\n    /**\r\n     * If the syncId is given and a synchronizer with that ID already exists, it will\r\n     * toggle it on/off for the provided viewports. If not, it will attempt to create\r\n     * a new synchronizer using the given syncId and type for the specified viewports.\r\n     * If no viewports are provided, you may notice some default behavior.\r\n     * - 'voi' type, we will aim to synchronize all viewports with the same modality\r\n     * -'imageSlice' type, we will aim to synchronize all viewports with the same orientation.\r\n     *\r\n     * @param options\r\n     * @param options.viewports - The viewports to synchronize\r\n     * @param options.syncId - The synchronization group ID\r\n     * @param options.type - The type of synchronization to perform\r\n     */\r\n    toggleSynchronizer: ({ type, viewports, syncId }) => {\r\n      const synchronizer = syncGroupService.getSynchronizer(syncId);\r\n\r\n      if (synchronizer) {\r\n        synchronizer.isDisabled() ? synchronizer.setEnabled(true) : synchronizer.setEnabled(false);\r\n        return;\r\n      }\r\n\r\n      const fn = toggleSyncFunctions[type];\r\n\r\n      if (fn) {\r\n        fn({\r\n          servicesManager,\r\n          viewports,\r\n          syncId,\r\n        });\r\n      }\r\n    },\r\n    setViewportForToolConfiguration: ({ viewportId, toolName }) => {\r\n      if (!viewportId) {\r\n        const { activeViewportId } = viewportGridService.getState();\r\n        viewportId = activeViewportId ?? 'default';\r\n      }\r\n\r\n      const toolGroup = toolGroupService.getToolGroupForViewport(viewportId);\r\n\r\n      if (!toolGroup?.hasTool(toolName)) {\r\n        return;\r\n      }\r\n\r\n      const prevConfig = toolGroup?.getToolConfiguration(toolName);\r\n      toolGroup?.setToolConfiguration(\r\n        toolName,\r\n        {\r\n          ...prevConfig,\r\n          sourceViewportId: viewportId,\r\n        },\r\n        true // overwrite\r\n      );\r\n\r\n      const renderingEngine = cornerstoneViewportService.getRenderingEngine();\r\n      renderingEngine.render();\r\n    },\r\n    storePresentation: ({ viewportId }) => {\r\n      cornerstoneViewportService.storePresentation({ viewportId });\r\n    },\r\n    updateVolumeData: ({ volume }) => {\r\n      // update vtkOpenGLTexture and imageData of computed volume\r\n      const { imageData, vtkOpenGLTexture } = volume;\r\n      const numSlices = imageData.getDimensions()[2];\r\n      const slicesToUpdate = [...Array(numSlices).keys()];\r\n      slicesToUpdate.forEach(i => {\r\n        vtkOpenGLTexture.setUpdatedFrame(i);\r\n      });\r\n      imageData.modified();\r\n    },\r\n\r\n    attachProtocolViewportDataListener: ({ protocol, stageIndex }) => {\r\n      const EVENT = cornerstoneViewportService.EVENTS.VIEWPORT_DATA_CHANGED;\r\n      const command = protocol.callbacks.onViewportDataInitialized;\r\n      const numPanes = protocol.stages?.[stageIndex]?.viewports.length ?? 1;\r\n      let numPanesWithData = 0;\r\n      const { unsubscribe } = cornerstoneViewportService.subscribe(EVENT, evt => {\r\n        numPanesWithData++;\r\n\r\n        if (numPanesWithData === numPanes) {\r\n          commandsManager.run(...command);\r\n\r\n          // Unsubscribe from the event\r\n          unsubscribe(EVENT);\r\n        }\r\n      });\r\n    },\r\n\r\n    setViewportPreset: ({ viewportId, preset }) => {\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n      if (!viewport) {\r\n        return;\r\n      }\r\n      viewport.setProperties({\r\n        preset,\r\n      });\r\n      viewport.render();\r\n    },\r\n\r\n    /**\r\n     * Sets the volume quality for a given viewport.\r\n     * @param {string} viewportId - The ID of the viewport to set the volume quality.\r\n     * @param {number} volumeQuality - The desired quality level of the volume rendering.\r\n     */\r\n\r\n    setVolumeRenderingQulaity: ({ viewportId, volumeQuality }) => {\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n      const { actor } = viewport.getActors()[0];\r\n      const mapper = actor.getMapper();\r\n      const image = mapper.getInputData();\r\n      const dims = image.getDimensions();\r\n      const spacing = image.getSpacing();\r\n      const spatialDiagonal = vec3.length(\r\n        vec3.fromValues(dims[0] * spacing[0], dims[1] * spacing[1], dims[2] * spacing[2])\r\n      );\r\n\r\n      let sampleDistance = spacing.reduce((a, b) => a + b) / 3.0;\r\n      sampleDistance /= volumeQuality > 1 ? 0.5 * volumeQuality ** 2 : 1.0;\r\n      const samplesPerRay = spatialDiagonal / sampleDistance + 1;\r\n      mapper.setMaximumSamplesPerRay(samplesPerRay);\r\n      mapper.setSampleDistance(sampleDistance);\r\n      viewport.render();\r\n    },\r\n\r\n    /**\r\n     * Shifts opacity points for a given viewport id.\r\n     * @param {string} viewportId - The ID of the viewport to set the mapping range.\r\n     * @param {number} shift - The shift value to shift the points by.\r\n     */\r\n    shiftVolumeOpacityPoints: ({ viewportId, shift }) => {\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n      const { actor } = viewport.getActors()[0];\r\n      const ofun = actor.getProperty().getScalarOpacity(0);\r\n\r\n      const opacityPointValues = []; // Array to hold values\r\n      // Gather Existing Values\r\n      const size = ofun.getSize();\r\n      for (let pointIdx = 0; pointIdx < size; pointIdx++) {\r\n        const opacityPointValue = [0, 0, 0, 0];\r\n        ofun.getNodeValue(pointIdx, opacityPointValue);\r\n        // opacityPointValue now holds [xLocation, opacity, midpoint, sharpness]\r\n        opacityPointValues.push(opacityPointValue);\r\n      }\r\n      // Add offset\r\n      opacityPointValues.forEach(opacityPointValue => {\r\n        opacityPointValue[0] += shift; // Change the location value\r\n      });\r\n      // Set new values\r\n      ofun.removeAllPoints();\r\n      opacityPointValues.forEach(opacityPointValue => {\r\n        ofun.addPoint(...opacityPointValue);\r\n      });\r\n      viewport.render();\r\n    },\r\n\r\n    /**\r\n     * Sets the volume lighting settings for a given viewport.\r\n     * @param {string} viewportId - The ID of the viewport to set the lighting settings.\r\n     * @param {Object} options - The lighting settings to be set.\r\n     * @param {boolean} options.shade - The shade setting for the lighting.\r\n     * @param {number} options.ambient - The ambient setting for the lighting.\r\n     * @param {number} options.diffuse - The diffuse setting for the lighting.\r\n     * @param {number} options.specular - The specular setting for the lighting.\r\n     **/\r\n\r\n    setVolumeLighting: ({ viewportId, options }) => {\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n      const { actor } = viewport.getActors()[0];\r\n      const property = actor.getProperty();\r\n\r\n      if (options.shade !== undefined) {\r\n        property.setShade(options.shade);\r\n      }\r\n\r\n      if (options.ambient !== undefined) {\r\n        property.setAmbient(options.ambient);\r\n      }\r\n\r\n      if (options.diffuse !== undefined) {\r\n        property.setDiffuse(options.diffuse);\r\n      }\r\n\r\n      if (options.specular !== undefined) {\r\n        property.setSpecular(options.specular);\r\n      }\r\n\r\n      viewport.render();\r\n    },\r\n    resetCrosshairs: ({ viewportId }) => {\r\n      const crosshairInstances = [];\r\n\r\n      const getCrosshairInstances = toolGroupId => {\r\n        const toolGroup = toolGroupService.getToolGroup(toolGroupId);\r\n        crosshairInstances.push(toolGroup.getToolInstance('Crosshairs'));\r\n      };\r\n\r\n      if (!viewportId) {\r\n        const toolGroupIds = toolGroupService.getToolGroupIds();\r\n        toolGroupIds.forEach(getCrosshairInstances);\r\n      } else {\r\n        const toolGroup = toolGroupService.getToolGroupForViewport(viewportId);\r\n        getCrosshairInstances(toolGroup.id);\r\n      }\r\n\r\n      crosshairInstances.forEach(ins => {\r\n        ins?.computeToolCenter();\r\n      });\r\n    },\r\n    /**\r\n     * Creates a labelmap for the active viewport\r\n     *\r\n     * The created labelmap will be registered as a display set and also added\r\n     * as a segmentation representation to the viewport.\r\n     */\r\n    createLabelmapForViewport: async ({ viewportId, options = {} }) => {\r\n      const { viewportGridService, displaySetService, segmentationService } =\r\n        servicesManager.services;\r\n      const { viewports } = viewportGridService.getState();\r\n      const targetViewportId = viewportId;\r\n\r\n      const viewport = viewports.get(targetViewportId);\r\n\r\n      // Todo: add support for multiple display sets\r\n      const displaySetInstanceUID =\r\n        options.displaySetInstanceUID || viewport.displaySetInstanceUIDs[0];\r\n\r\n      const segs = segmentationService.getSegmentations();\r\n\r\n      const label = options.label || `Segmentation ${segs.length + 1}`;\r\n      const segmentationId = options.segmentationId || `${csUtils.uuidv4()}`;\r\n\r\n      const displaySet = displaySetService.getDisplaySetByUID(displaySetInstanceUID);\r\n\r\n      // This will create the segmentation and register it as a display set\r\n      const generatedSegmentationId = await segmentationService.createLabelmapForDisplaySet(\r\n        displaySet,\r\n        {\r\n          label,\r\n          segmentationId,\r\n          segments: options.createInitialSegment\r\n            ? {\r\n                1: {\r\n                  label: `${i18n.t('Segment')} 1`,\r\n                  active: true,\r\n                },\r\n              }\r\n            : {},\r\n        }\r\n      );\r\n\r\n      // Also add the segmentation representation to the viewport\r\n      await segmentationService.addSegmentationRepresentation(viewportId, {\r\n        segmentationId,\r\n        type: Enums.SegmentationRepresentations.Labelmap,\r\n      });\r\n\r\n      return generatedSegmentationId;\r\n    },\r\n\r\n    /**\r\n     * Sets the active segmentation for a viewport\r\n     * @param props.segmentationId - The ID of the segmentation to set as active\r\n     */\r\n    setActiveSegmentation: ({ segmentationId }) => {\r\n      const { viewportGridService, segmentationService } = servicesManager.services;\r\n      segmentationService.setActiveSegmentation(\r\n        viewportGridService.getActiveViewportId(),\r\n        segmentationId\r\n      );\r\n    },\r\n\r\n    /**\r\n     * Adds a new segment to a segmentation\r\n     * @param props.segmentationId - The ID of the segmentation to add the segment to\r\n     */\r\n    addSegmentCommand: ({ segmentationId }) => {\r\n      const { segmentationService } = servicesManager.services;\r\n      segmentationService.addSegment(segmentationId);\r\n    },\r\n\r\n    /**\r\n     * Sets the active segment and jumps to its center\r\n     * @param props.segmentationId - The ID of the segmentation\r\n     * @param props.segmentIndex - The index of the segment to activate\r\n     */\r\n    setActiveSegmentAndCenterCommand: ({ segmentationId, segmentIndex }) => {\r\n      const { segmentationService, viewportGridService } = servicesManager.services;\r\n      // set both active segmentation and active segment\r\n      segmentationService.setActiveSegmentation(\r\n        viewportGridService.getActiveViewportId(),\r\n        segmentationId\r\n      );\r\n      segmentationService.setActiveSegment(segmentationId, segmentIndex);\r\n      segmentationService.jumpToSegmentCenter(segmentationId, segmentIndex);\r\n    },\r\n\r\n    /**\r\n     * Toggles the visibility of a segment\r\n     * @param props.segmentationId - The ID of the segmentation\r\n     * @param props.segmentIndex - The index of the segment\r\n     * @param props.type - The type of visibility to toggle\r\n     */\r\n    toggleSegmentVisibilityCommand: ({ segmentationId, segmentIndex, type }) => {\r\n      const { segmentationService, viewportGridService } = servicesManager.services;\r\n      segmentationService.toggleSegmentVisibility(\r\n        viewportGridService.getActiveViewportId(),\r\n        segmentationId,\r\n        segmentIndex,\r\n        type\r\n      );\r\n    },\r\n\r\n    /**\r\n     * Toggles the lock state of a segment\r\n     * @param props.segmentationId - The ID of the segmentation\r\n     * @param props.segmentIndex - The index of the segment\r\n     */\r\n    toggleSegmentLockCommand: ({ segmentationId, segmentIndex }) => {\r\n      const { segmentationService } = servicesManager.services;\r\n      segmentationService.toggleSegmentLocked(segmentationId, segmentIndex);\r\n    },\r\n\r\n    /**\r\n     * Toggles the visibility of a segmentation representation\r\n     * @param props.segmentationId - The ID of the segmentation\r\n     * @param props.type - The type of representation\r\n     */\r\n    toggleSegmentationVisibilityCommand: ({ segmentationId, type }) => {\r\n      const { segmentationService, viewportGridService } = servicesManager.services;\r\n      segmentationService.toggleSegmentationRepresentationVisibility(\r\n        viewportGridService.getActiveViewportId(),\r\n        { segmentationId, type }\r\n      );\r\n    },\r\n\r\n    /**\r\n     * Downloads a segmentation\r\n     * @param props.segmentationId - The ID of the segmentation to download\r\n     */\r\n    downloadSegmentationCommand: ({ segmentationId }) => {\r\n      const { segmentationService } = servicesManager.services;\r\n      segmentationService.downloadSegmentation(segmentationId);\r\n    },\r\n\r\n    /**\r\n     * Stores a segmentation and shows it in the viewport\r\n     * @param props.segmentationId - The ID of the segmentation to store\r\n     */\r\n    storeSegmentationCommand: async ({ segmentationId }) => {\r\n      const { segmentationService, viewportGridService } = servicesManager.services;\r\n\r\n      const displaySetInstanceUIDs = await createReportAsync({\r\n        servicesManager,\r\n        getReport: () =>\r\n          commandsManager.runCommand('storeSegmentation', {\r\n            segmentationId,\r\n          }),\r\n        reportType: 'Segmentation',\r\n      });\r\n\r\n      if (displaySetInstanceUIDs) {\r\n        segmentationService.remove(segmentationId);\r\n        viewportGridService.setDisplaySetsForViewport({\r\n          viewportId: viewportGridService.getActiveViewportId(),\r\n          displaySetInstanceUIDs,\r\n        });\r\n      }\r\n    },\r\n\r\n    /**\r\n     * Downloads a segmentation as RTSS\r\n     * @param props.segmentationId - The ID of the segmentation\r\n     */\r\n    downloadRTSSCommand: ({ segmentationId }) => {\r\n      const { segmentationService } = servicesManager.services;\r\n      segmentationService.downloadRTSS(segmentationId);\r\n    },\r\n\r\n    /**\r\n     * Sets the style for a segmentation\r\n     * @param props.segmentationId - The ID of the segmentation\r\n     * @param props.type - The type of style\r\n     * @param props.key - The style key to set\r\n     * @param props.value - The style value\r\n     */\r\n    setSegmentationStyleCommand: ({ type, key, value }) => {\r\n      const { segmentationService } = servicesManager.services;\r\n      segmentationService.setStyle({ type }, { [key]: value });\r\n    },\r\n\r\n    /**\r\n     * Deletes a segment from a segmentation\r\n     * @param props.segmentationId - The ID of the segmentation\r\n     * @param props.segmentIndex - The index of the segment to delete\r\n     */\r\n    deleteSegmentCommand: ({ segmentationId, segmentIndex }) => {\r\n      const { segmentationService } = servicesManager.services;\r\n      segmentationService.removeSegment(segmentationId, segmentIndex);\r\n    },\r\n\r\n    /**\r\n     * Deletes an entire segmentation\r\n     * @param props.segmentationId - The ID of the segmentation to delete\r\n     */\r\n    deleteSegmentationCommand: ({ segmentationId }) => {\r\n      const { segmentationService } = servicesManager.services;\r\n      segmentationService.remove(segmentationId);\r\n    },\r\n\r\n    /**\r\n     * Removes a segmentation from the viewport\r\n     * @param props.segmentationId - The ID of the segmentation to remove\r\n     */\r\n    removeSegmentationFromViewportCommand: ({ segmentationId }) => {\r\n      const { segmentationService, viewportGridService } = servicesManager.services;\r\n      segmentationService.removeSegmentationRepresentations(\r\n        viewportGridService.getActiveViewportId(),\r\n        { segmentationId }\r\n      );\r\n    },\r\n\r\n    /**\r\n     * Toggles rendering of inactive segmentations\r\n     */\r\n    toggleRenderInactiveSegmentationsCommand: () => {\r\n      const { segmentationService, viewportGridService } = servicesManager.services;\r\n      const viewportId = viewportGridService.getActiveViewportId();\r\n      const renderInactive = segmentationService.getRenderInactiveSegmentations(viewportId);\r\n      segmentationService.setRenderInactiveSegmentations(viewportId, !renderInactive);\r\n    },\r\n\r\n    /**\r\n     * Sets the fill alpha value for a segmentation type\r\n     * @param props.type - The type of segmentation\r\n     * @param props.value - The alpha value to set\r\n     */\r\n    setFillAlphaCommand: ({ type, value }) => {\r\n      const { segmentationService } = servicesManager.services;\r\n      segmentationService.setStyle({ type }, { fillAlpha: value });\r\n    },\r\n\r\n    /**\r\n     * Sets the outline width for a segmentation type\r\n     * @param props.type - The type of segmentation\r\n     * @param props.value - The width value to set\r\n     */\r\n    setOutlineWidthCommand: ({ type, value }) => {\r\n      const { segmentationService } = servicesManager.services;\r\n      segmentationService.setStyle({ type }, { outlineWidth: value });\r\n    },\r\n\r\n    /**\r\n     * Sets whether to render fill for a segmentation type\r\n     * @param props.type - The type of segmentation\r\n     * @param props.value - Whether to render fill\r\n     */\r\n    setRenderFillCommand: ({ type, value }) => {\r\n      const { segmentationService } = servicesManager.services;\r\n      segmentationService.setStyle({ type }, { renderFill: value });\r\n    },\r\n\r\n    /**\r\n     * Sets whether to render outline for a segmentation type\r\n     * @param props.type - The type of segmentation\r\n     * @param props.value - Whether to render outline\r\n     */\r\n    setRenderOutlineCommand: ({ type, value }) => {\r\n      const { segmentationService } = servicesManager.services;\r\n      segmentationService.setStyle({ type }, { renderOutline: value });\r\n    },\r\n\r\n    /**\r\n     * Sets the fill alpha for inactive segmentations\r\n     * @param props.type - The type of segmentation\r\n     * @param props.value - The alpha value to set\r\n     */\r\n    setFillAlphaInactiveCommand: ({ type, value }) => {\r\n      const { segmentationService } = servicesManager.services;\r\n      segmentationService.setStyle({ type }, { fillAlphaInactive: value });\r\n    },\r\n\r\n    editSegmentLabel: async ({ segmentationId, segmentIndex }) => {\r\n      const { segmentationService, uiDialogService } = servicesManager.services;\r\n      const segmentation = segmentationService.getSegmentation(segmentationId);\r\n\r\n      if (!segmentation) {\r\n        return;\r\n      }\r\n\r\n      const segment = segmentation.segments[segmentIndex];\r\n\r\n      callInputDialog({\r\n        uiDialogService,\r\n        title: 'Edit Segment Label',\r\n        placeholder: 'Enter new label',\r\n        defaultValue: segment.label,\r\n      }).then(label => {\r\n        segmentationService.setSegmentLabel(segmentationId, segmentIndex, label);\r\n      });\r\n    },\r\n\r\n    editSegmentationLabel: ({ segmentationId }) => {\r\n      const { segmentationService, uiDialogService } = servicesManager.services;\r\n      const segmentation = segmentationService.getSegmentation(segmentationId);\r\n\r\n      if (!segmentation) {\r\n        return;\r\n      }\r\n\r\n      const { label } = segmentation;\r\n\r\n      callInputDialog({\r\n        uiDialogService,\r\n        title: 'Edit Segmentation Label',\r\n        placeholder: 'Enter new label',\r\n        defaultValue: label,\r\n      }).then(label => {\r\n        segmentationService.addOrUpdateSegmentation({ segmentationId, label });\r\n      });\r\n    },\r\n\r\n    editSegmentColor: ({ segmentationId, segmentIndex }) => {\r\n      const { segmentationService, uiDialogService, viewportGridService } =\r\n        servicesManager.services;\r\n      const viewportId = viewportGridService.getActiveViewportId();\r\n      const color = segmentationService.getSegmentColor(viewportId, segmentationId, segmentIndex);\r\n\r\n      const rgbaColor = {\r\n        r: color[0],\r\n        g: color[1],\r\n        b: color[2],\r\n        a: color[3] / 255.0,\r\n      };\r\n\r\n      uiDialogService.show({\r\n        content: colorPickerDialog,\r\n        title: 'Segment Color',\r\n        contentProps: {\r\n          value: rgbaColor,\r\n          onSave: newRgbaColor => {\r\n            const color = [newRgbaColor.r, newRgbaColor.g, newRgbaColor.b, newRgbaColor.a * 255.0];\r\n            segmentationService.setSegmentColor(viewportId, segmentationId, segmentIndex, color);\r\n          },\r\n        },\r\n      });\r\n    },\r\n\r\n    getRenderInactiveSegmentations: () => {\r\n      const { segmentationService, viewportGridService } = servicesManager.services;\r\n      return segmentationService.getRenderInactiveSegmentations(\r\n        viewportGridService.getActiveViewportId()\r\n      );\r\n    },\r\n\r\n    deleteActiveAnnotation: () => {\r\n      const activeAnnotationsUID = cornerstoneTools.annotation.selection.getAnnotationsSelected();\r\n      activeAnnotationsUID.forEach(activeAnnotationUID => {\r\n        measurementService.remove(activeAnnotationUID);\r\n      });\r\n    },\r\n    setDisplaySetsForViewports: ({ viewportsToUpdate }) => {\r\n      const { cineService, viewportGridService } = servicesManager.services;\r\n      // Stopping the cine of modified viewports before changing the viewports to\r\n      // avoid inconsistent state and lost references\r\n      viewportsToUpdate.forEach(viewport => {\r\n        const state = cineService.getState();\r\n        const currentCineState = state.cines?.[viewport.viewportId];\r\n        cineService.setCine({\r\n          id: viewport.viewportId,\r\n          frameRate: currentCineState?.frameRate ?? state.default?.frameRate ?? 24,\r\n          isPlaying: false,\r\n        });\r\n      });\r\n\r\n      viewportGridService.setDisplaySetsForViewports(viewportsToUpdate);\r\n    },\r\n    undo: () => {\r\n      DefaultHistoryMemo.undo();\r\n    },\r\n    redo: () => {\r\n      DefaultHistoryMemo.redo();\r\n    },\r\n    toggleSegmentPreviewEdit: ({ toggle }) => {\r\n      let labelmapTools = getLabelmapTools({ toolGroupService });\r\n      labelmapTools = labelmapTools.filter(tool => !tool.toolName.includes('Eraser'));\r\n      labelmapTools.forEach(tool => {\r\n        tool.configuration = {\r\n          ...tool.configuration,\r\n          preview: {\r\n            ...tool.configuration.preview,\r\n            enabled: toggle,\r\n          },\r\n        };\r\n      });\r\n    },\r\n    toggleSegmentSelect: ({ toggle }) => {\r\n      const toolGroupIds = toolGroupService.getToolGroupIds();\r\n      toolGroupIds.forEach(toolGroupId => {\r\n        const toolGroup = cornerstoneTools.ToolGroupManager.getToolGroup(toolGroupId);\r\n        if (toggle) {\r\n          toolGroup.setToolActive(cornerstoneTools.SegmentSelectTool.toolName);\r\n        } else {\r\n          toolGroup.setToolDisabled(cornerstoneTools.SegmentSelectTool.toolName);\r\n        }\r\n      });\r\n    },\r\n    toggleUseCenterSegmentIndex: ({ toggle }) => {\r\n      let labelmapTools = getLabelmapTools({ toolGroupService });\r\n      labelmapTools = labelmapTools.filter(tool => !tool.toolName.includes('Eraser'));\r\n      labelmapTools.forEach(tool => {\r\n        tool.configuration = {\r\n          ...tool.configuration,\r\n          useCenterSegmentIndex: toggle,\r\n        };\r\n      });\r\n    },\r\n    _handlePreviewAction: action => {\r\n      const labelmapTools = getLabelmapTools({ toolGroupService });\r\n      const { viewport } = _getActiveViewportEnabledElement();\r\n      const activeTools = labelmapTools.filter(\r\n        tool => tool.mode === 'Active' || tool.mode === 'Enabled'\r\n      );\r\n\r\n      activeTools.forEach(tool => {\r\n        tool[`${action}Preview`]();\r\n      });\r\n\r\n      if (segmentAI.enabled) {\r\n        segmentAI[`${action}Preview`](viewport.element);\r\n      }\r\n    },\r\n    acceptPreview: () => {\r\n      actions._handlePreviewAction('accept');\r\n    },\r\n    rejectPreview: () => {\r\n      actions._handlePreviewAction('reject');\r\n    },\r\n    clearMarkersForMarkerLabelmap: () => {\r\n      const { viewport } = _getActiveViewportEnabledElement();\r\n      const toolGroup = cornerstoneTools.ToolGroupManager.getToolGroupForViewport(viewport.id);\r\n      const toolInstance = toolGroup.getToolInstance('MarkerLabelmap');\r\n\r\n      if (!toolInstance) {\r\n        return;\r\n      }\r\n\r\n      toolInstance.clearMarkers(viewport);\r\n    },\r\n    interpolateScrollForMarkerLabelmap: () => {\r\n      const { viewport } = _getActiveViewportEnabledElement();\r\n      const toolGroup = cornerstoneTools.ToolGroupManager.getToolGroupForViewport(viewport.id);\r\n      const toolInstance = toolGroup.getToolInstance('MarkerLabelmap');\r\n\r\n      if (!toolInstance) {\r\n        return;\r\n      }\r\n\r\n      toolInstance.interpolateScroll(viewport, 1);\r\n    },\r\n    toggleLabelmapAssist: async () => {\r\n      const { viewport } = _getActiveViewportEnabledElement();\r\n      const newState = !segmentAI.enabled;\r\n      segmentAI.enabled = newState;\r\n\r\n      if (!segmentAIEnabled) {\r\n        await segmentAI.initModel();\r\n        segmentAIEnabled = true;\r\n      }\r\n\r\n      // set the brush tool to active\r\n      const toolGroupIds = toolGroupService.getToolGroupIds();\r\n      if (newState) {\r\n        actions.setToolActiveToolbar({\r\n          toolName: 'CircularBrushForAutoSegmentAI',\r\n          toolGroupIds: toolGroupIds,\r\n        });\r\n      } else {\r\n        toolGroupIds.forEach(toolGroupId => {\r\n          const toolGroup = cornerstoneTools.ToolGroupManager.getToolGroup(toolGroupId);\r\n          toolGroup.setToolPassive('CircularBrushForAutoSegmentAI');\r\n        });\r\n      }\r\n\r\n      if (segmentAI.enabled) {\r\n        segmentAI.initViewport(viewport);\r\n      }\r\n    },\r\n    setBrushSize: ({ value, toolNames }) => {\r\n      const brushSize = Number(value);\r\n\r\n      toolGroupService.getToolGroupIds()?.forEach(toolGroupId => {\r\n        if (toolNames?.length === 0) {\r\n          segmentationUtils.setBrushSizeForToolGroup(toolGroupId, brushSize);\r\n        } else {\r\n          toolNames?.forEach(toolName => {\r\n            segmentationUtils.setBrushSizeForToolGroup(toolGroupId, brushSize, toolName);\r\n          });\r\n        }\r\n      });\r\n    },\r\n    setThresholdRange: ({\r\n      value,\r\n      toolNames = [\r\n        'ThresholdCircularBrush',\r\n        'ThresholdSphereBrush',\r\n        'ThresholdCircularBrushDynamic',\r\n        'ThresholdSphereBrushDynamic',\r\n      ],\r\n    }) => {\r\n      const toolGroupIds = toolGroupService.getToolGroupIds();\r\n      if (!toolGroupIds?.length) {\r\n        return;\r\n      }\r\n\r\n      for (const toolGroupId of toolGroupIds) {\r\n        const toolGroup = toolGroupService.getToolGroup(toolGroupId);\r\n        toolNames?.forEach(toolName => {\r\n          toolGroup.setToolConfiguration(toolName, {\r\n            threshold: {\r\n              range: value,\r\n            },\r\n          });\r\n        });\r\n      }\r\n    },\r\n    increaseBrushSize: () => {\r\n      const toolGroupIds = toolGroupService.getToolGroupIds();\r\n      if (!toolGroupIds?.length) {\r\n        return;\r\n      }\r\n\r\n      for (const toolGroupId of toolGroupIds) {\r\n        const brushSize = segmentationUtils.getBrushSizeForToolGroup(toolGroupId);\r\n        segmentationUtils.setBrushSizeForToolGroup(toolGroupId, brushSize + 3);\r\n      }\r\n    },\r\n    decreaseBrushSize: () => {\r\n      const toolGroupIds = toolGroupService.getToolGroupIds();\r\n      if (!toolGroupIds?.length) {\r\n        return;\r\n      }\r\n\r\n      for (const toolGroupId of toolGroupIds) {\r\n        const brushSize = segmentationUtils.getBrushSizeForToolGroup(toolGroupId);\r\n        segmentationUtils.setBrushSizeForToolGroup(toolGroupId, brushSize - 3);\r\n      }\r\n    },\r\n    addNewSegment: () => {\r\n      const { segmentationService } = servicesManager.services;\r\n      const { activeViewportId } = viewportGridService.getState();\r\n      const activeSegmentation = segmentationService.getActiveSegmentation(activeViewportId);\r\n      segmentationService.addSegment(activeSegmentation.segmentationId);\r\n    },\r\n    loadSegmentationDisplaySetsForViewport: ({ viewportId, displaySetInstanceUIDs }) => {\r\n      const updatedViewports = getUpdatedViewportsForSegmentation({\r\n        viewportId,\r\n        servicesManager,\r\n        displaySetInstanceUIDs,\r\n      });\r\n\r\n      actions.setDisplaySetsForViewports({\r\n        viewportsToUpdate: updatedViewports.map(viewport => ({\r\n          viewportId: viewport.viewportId,\r\n          displaySetInstanceUIDs: viewport.displaySetInstanceUIDs,\r\n        })),\r\n      });\r\n    },\r\n    setViewportOrientation: ({ viewportId, orientation }) => {\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n      if (!viewport || viewport.type !== CoreEnums.ViewportType.ORTHOGRAPHIC) {\r\n        console.warn('Orientation can only be set on volume viewports');\r\n        return;\r\n      }\r\n\r\n      // Get display sets for this viewport to verify at least one is reconstructable\r\n      const displaySetUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n      const displaySets = displaySetUIDs.map(uid => displaySetService.getDisplaySetByUID(uid));\r\n\r\n      if (!displaySets.some(ds => ds.isReconstructable)) {\r\n        console.warn('Cannot change orientation: No reconstructable display sets in viewport');\r\n        return;\r\n      }\r\n\r\n      viewport.setOrientation(orientation);\r\n      viewport.render();\r\n\r\n      // update the orientation in the viewport info\r\n      const viewportInfo = cornerstoneViewportService.getViewportInfo(viewportId);\r\n      viewportInfo.setOrientation(orientation);\r\n    },\r\n    triggerCreateAnnotationMemo: ({\r\n      annotation,\r\n      FrameOfReferenceUID,\r\n      options,\r\n    }: {\r\n      annotation: ToolTypes.Annotation;\r\n      FrameOfReferenceUID: string;\r\n      options: { newAnnotation?: boolean; deleting?: boolean };\r\n    }): void => {\r\n      const { newAnnotation, deleting } = options;\r\n      const renderingEngines = getRenderingEngines();\r\n      const viewports = renderingEngines.flatMap(re => re.getViewports());\r\n      const validViewport = viewports.find(\r\n        vp => vp.getFrameOfReferenceUID() === FrameOfReferenceUID\r\n      );\r\n\r\n      if (!validViewport) {\r\n        return;\r\n      }\r\n\r\n      cornerstoneTools.AnnotationTool.createAnnotationMemo(validViewport.element, annotation, {\r\n        newAnnotation,\r\n        deleting,\r\n      });\r\n    },\r\n  };\r\n\r\n  const definitions = {\r\n    // The command here is to show the viewer context menu, as being the\r\n    // context menu\r\n    showCornerstoneContextMenu: {\r\n      commandFn: actions.showCornerstoneContextMenu,\r\n      options: {\r\n        menuCustomizationId: 'measurementsContextMenu',\r\n        commands: [\r\n          {\r\n            commandName: 'showContextMenu',\r\n          },\r\n        ],\r\n      },\r\n    },\r\n\r\n    getNearbyToolData: {\r\n      commandFn: actions.getNearbyToolData,\r\n    },\r\n    getNearbyAnnotation: {\r\n      commandFn: actions.getNearbyAnnotation,\r\n      storeContexts: [],\r\n      options: {},\r\n    },\r\n    toggleViewportColorbar: {\r\n      commandFn: actions.toggleViewportColorbar,\r\n    },\r\n    setMeasurementLabel: {\r\n      commandFn: actions.setMeasurementLabel,\r\n    },\r\n    renameMeasurement: {\r\n      commandFn: actions.renameMeasurement,\r\n    },\r\n    updateMeasurement: {\r\n      commandFn: actions.updateMeasurement,\r\n    },\r\n    jumpToMeasurement: {\r\n      commandFn: actions.jumpToMeasurement,\r\n    },\r\n    removeMeasurement: {\r\n      commandFn: actions.removeMeasurement,\r\n    },\r\n    toggleLockMeasurement: {\r\n      commandFn: actions.toggleLockMeasurement,\r\n    },\r\n    toggleVisibilityMeasurement: {\r\n      commandFn: actions.toggleVisibilityMeasurement,\r\n    },\r\n    downloadCSVMeasurementsReport: {\r\n      commandFn: actions.downloadCSVMeasurementsReport,\r\n    },\r\n    setViewportWindowLevel: {\r\n      commandFn: actions.setViewportWindowLevel,\r\n    },\r\n    setWindowLevel: {\r\n      commandFn: actions.setWindowLevel,\r\n    },\r\n    setWindowLevelPreset: {\r\n      commandFn: actions.setWindowLevelPreset,\r\n    },\r\n    setToolActive: {\r\n      commandFn: actions.setToolActive,\r\n    },\r\n    setToolActiveToolbar: {\r\n      commandFn: actions.setToolActiveToolbar,\r\n    },\r\n    setToolEnabled: {\r\n      commandFn: actions.setToolEnabled,\r\n    },\r\n    rotateViewportCW: {\r\n      commandFn: actions.rotateViewport,\r\n      options: { rotation: 90 },\r\n    },\r\n    rotateViewportCCW: {\r\n      commandFn: actions.rotateViewport,\r\n      options: { rotation: -90 },\r\n    },\r\n    incrementActiveViewport: {\r\n      commandFn: actions.changeActiveViewport,\r\n    },\r\n    decrementActiveViewport: {\r\n      commandFn: actions.changeActiveViewport,\r\n      options: { direction: -1 },\r\n    },\r\n    flipViewportHorizontal: {\r\n      commandFn: actions.flipViewportHorizontal,\r\n    },\r\n    flipViewportVertical: {\r\n      commandFn: actions.flipViewportVertical,\r\n    },\r\n    invertViewport: {\r\n      commandFn: actions.invertViewport,\r\n    },\r\n    resetViewport: {\r\n      commandFn: actions.resetViewport,\r\n    },\r\n    scaleUpViewport: {\r\n      commandFn: actions.scaleViewport,\r\n      options: { direction: 1 },\r\n    },\r\n    scaleDownViewport: {\r\n      commandFn: actions.scaleViewport,\r\n      options: { direction: -1 },\r\n    },\r\n    fitViewportToWindow: {\r\n      commandFn: actions.scaleViewport,\r\n      options: { direction: 0 },\r\n    },\r\n    nextImage: {\r\n      commandFn: actions.scroll,\r\n      options: { direction: 1 },\r\n    },\r\n    previousImage: {\r\n      commandFn: actions.scroll,\r\n      options: { direction: -1 },\r\n    },\r\n    firstImage: {\r\n      commandFn: actions.jumpToImage,\r\n      options: { imageIndex: 0 },\r\n    },\r\n    lastImage: {\r\n      commandFn: actions.jumpToImage,\r\n      options: { imageIndex: -1 },\r\n    },\r\n    jumpToImage: {\r\n      commandFn: actions.jumpToImage,\r\n    },\r\n    showDownloadViewportModal: {\r\n      commandFn: actions.showDownloadViewportModal,\r\n    },\r\n    toggleCine: {\r\n      commandFn: actions.toggleCine,\r\n    },\r\n    arrowTextCallback: {\r\n      commandFn: actions.arrowTextCallback,\r\n    },\r\n    setViewportActive: {\r\n      commandFn: actions.setViewportActive,\r\n    },\r\n    setViewportColormap: {\r\n      commandFn: actions.setViewportColormap,\r\n    },\r\n    setViewportForToolConfiguration: {\r\n      commandFn: actions.setViewportForToolConfiguration,\r\n    },\r\n    storePresentation: {\r\n      commandFn: actions.storePresentation,\r\n    },\r\n    attachProtocolViewportDataListener: {\r\n      commandFn: actions.attachProtocolViewportDataListener,\r\n    },\r\n    setViewportPreset: {\r\n      commandFn: actions.setViewportPreset,\r\n    },\r\n    setVolumeRenderingQulaity: {\r\n      commandFn: actions.setVolumeRenderingQulaity,\r\n    },\r\n    shiftVolumeOpacityPoints: {\r\n      commandFn: actions.shiftVolumeOpacityPoints,\r\n    },\r\n    setVolumeLighting: {\r\n      commandFn: actions.setVolumeLighting,\r\n    },\r\n    resetCrosshairs: {\r\n      commandFn: actions.resetCrosshairs,\r\n    },\r\n    toggleSynchronizer: {\r\n      commandFn: actions.toggleSynchronizer,\r\n    },\r\n    updateVolumeData: {\r\n      commandFn: actions.updateVolumeData,\r\n    },\r\n    toggleEnabledDisabledToolbar: {\r\n      commandFn: actions.toggleEnabledDisabledToolbar,\r\n    },\r\n    toggleActiveDisabledToolbar: {\r\n      commandFn: actions.toggleActiveDisabledToolbar,\r\n    },\r\n    updateStoredPositionPresentation: {\r\n      commandFn: actions.updateStoredPositionPresentation,\r\n    },\r\n    updateStoredSegmentationPresentation: {\r\n      commandFn: actions.updateStoredSegmentationPresentation,\r\n    },\r\n    createLabelmapForViewport: {\r\n      commandFn: actions.createLabelmapForViewport,\r\n    },\r\n    setActiveSegmentation: {\r\n      commandFn: actions.setActiveSegmentation,\r\n    },\r\n    addSegment: {\r\n      commandFn: actions.addSegmentCommand,\r\n    },\r\n    setActiveSegmentAndCenter: {\r\n      commandFn: actions.setActiveSegmentAndCenterCommand,\r\n    },\r\n    toggleSegmentVisibility: {\r\n      commandFn: actions.toggleSegmentVisibilityCommand,\r\n    },\r\n    toggleSegmentLock: {\r\n      commandFn: actions.toggleSegmentLockCommand,\r\n    },\r\n    toggleSegmentationVisibility: {\r\n      commandFn: actions.toggleSegmentationVisibilityCommand,\r\n    },\r\n    downloadSegmentation: {\r\n      commandFn: actions.downloadSegmentationCommand,\r\n    },\r\n    storeSegmentation: {\r\n      commandFn: actions.storeSegmentationCommand,\r\n    },\r\n    downloadRTSS: {\r\n      commandFn: actions.downloadRTSSCommand,\r\n    },\r\n    setSegmentationStyle: {\r\n      commandFn: actions.setSegmentationStyleCommand,\r\n    },\r\n    deleteSegment: {\r\n      commandFn: actions.deleteSegmentCommand,\r\n    },\r\n    deleteSegmentation: {\r\n      commandFn: actions.deleteSegmentationCommand,\r\n    },\r\n    removeSegmentationFromViewport: {\r\n      commandFn: actions.removeSegmentationFromViewportCommand,\r\n    },\r\n    toggleRenderInactiveSegmentations: {\r\n      commandFn: actions.toggleRenderInactiveSegmentationsCommand,\r\n    },\r\n    setFillAlpha: {\r\n      commandFn: actions.setFillAlphaCommand,\r\n    },\r\n    setOutlineWidth: {\r\n      commandFn: actions.setOutlineWidthCommand,\r\n    },\r\n    setRenderFill: {\r\n      commandFn: actions.setRenderFillCommand,\r\n    },\r\n    setRenderOutline: {\r\n      commandFn: actions.setRenderOutlineCommand,\r\n    },\r\n    setFillAlphaInactive: {\r\n      commandFn: actions.setFillAlphaInactiveCommand,\r\n    },\r\n    editSegmentLabel: {\r\n      commandFn: actions.editSegmentLabel,\r\n    },\r\n    editSegmentationLabel: {\r\n      commandFn: actions.editSegmentationLabel,\r\n    },\r\n    editSegmentColor: {\r\n      commandFn: actions.editSegmentColor,\r\n    },\r\n    getRenderInactiveSegmentations: {\r\n      commandFn: actions.getRenderInactiveSegmentations,\r\n    },\r\n    deleteActiveAnnotation: {\r\n      commandFn: actions.deleteActiveAnnotation,\r\n    },\r\n    setDisplaySetsForViewports: actions.setDisplaySetsForViewports,\r\n    undo: actions.undo,\r\n    redo: actions.redo,\r\n    interpolateLabelmap: actions.interpolateLabelmap,\r\n    runSegmentBidirectional: actions.runSegmentBidirectional,\r\n    downloadCSVSegmentationReport: actions.downloadCSVSegmentationReport,\r\n    toggleSegmentPreviewEdit: actions.toggleSegmentPreviewEdit,\r\n    toggleSegmentSelect: actions.toggleSegmentSelect,\r\n    acceptPreview: actions.acceptPreview,\r\n    rejectPreview: actions.rejectPreview,\r\n    toggleUseCenterSegmentIndex: actions.toggleUseCenterSegmentIndex,\r\n    toggleLabelmapAssist: actions.toggleLabelmapAssist,\r\n    interpolateScrollForMarkerLabelmap: actions.interpolateScrollForMarkerLabelmap,\r\n    clearMarkersForMarkerLabelmap: actions.clearMarkersForMarkerLabelmap,\r\n    setBrushSize: actions.setBrushSize,\r\n    setThresholdRange: actions.setThresholdRange,\r\n    increaseBrushSize: actions.increaseBrushSize,\r\n    decreaseBrushSize: actions.decreaseBrushSize,\r\n    addNewSegment: actions.addNewSegment,\r\n    loadSegmentationDisplaySetsForViewport: actions.loadSegmentationDisplaySetsForViewport,\r\n    setViewportOrientation: actions.setViewportOrientation,\r\n    hydrateSecondaryDisplaySet: actions.hydrateSecondaryDisplaySet,\r\n    getVolumeIdForDisplaySet: actions.getVolumeIdForDisplaySet,\r\n    triggerCreateAnnotationMemo: actions.triggerCreateAnnotationMemo,\r\n  };\r\n\r\n  return {\r\n    actions,\r\n    definitions,\r\n    defaultContext: 'CORNERSTONE',\r\n  };\r\n}\r\n\r\nexport default commandsModule;\r\n","import React from 'react';\r\nimport { useSystem } from '@ohif/core';\r\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@ohif/ui-next';\r\nimport { ChevronDownIcon } from '@radix-ui/react-icons';\r\n\r\nexport type AccordionGrouping = {\r\n  [name: string]: unknown;\r\n};\r\n\r\nexport type AccordionGroupProps = {\r\n  grouping: AccordionGrouping;\r\n};\r\n\r\n/**\r\n * Searches for the required type from the provided allChildren list and\r\n * renders them.\r\n */\r\nexport const CloneChildren = props => {\r\n  const { group, allChildren, children, childType, defaultTypes } = props;\r\n\r\n  const subType = group?.subType;\r\n\r\n  for (const child of allChildren) {\r\n    if (subType && child.props?.subType !== subType) {\r\n      continue;\r\n    }\r\n    if (childType && child.type === childType) {\r\n      return React.cloneElement(child, { ...props, children: child.props.children });\r\n    }\r\n    if (defaultTypes?.indexOf(child.type) === -1) {\r\n      return childType({ ...props, children: child });\r\n    }\r\n  }\r\n\r\n  if (!children) {\r\n    throw new Error(`No children defined for ${props.name} CloneChildren in group ${group?.name}`);\r\n  }\r\n  return React.cloneElement(children, props);\r\n};\r\n\r\n/** Used to exclude defaults */\r\nconst DEFAULT_TYPES = [GroupAccordion, Content, Trigger];\r\n\r\n/**\r\n * An AccordionGroup is a component that splits a set of items into different\r\n * groups according to a set of grouping rules.  It then puts the groups\r\n * into a set of accordion folds selected from the body of the accordion group,\r\n * looking for matching trigger/content sections according to the type definition\r\n * in the group with first one found being used.\r\n *\r\n * This design allows for easy customization of the component by declaring grouping\r\n * functions with default grouping setups and then only overriding the specific\r\n * children needing to be changed.  See the PanelMeasurement for some example\r\n * possibilities of how to modify the default grouping, or the test-extension\r\n * measurements panel for a practical, working example.\r\n */\r\nexport function AccordionGroup(props) {\r\n  const { grouping, items, children, sourceChildren, type } = props;\r\n  const childProps = useSystem();\r\n  let defaultValue = props.defaultValue;\r\n  const groups = grouping.groupingFunction(items, grouping, childProps);\r\n\r\n  if (!defaultValue) {\r\n    const defaultGroup = groups.values().find(group => group.isSelected);\r\n    defaultValue = defaultGroup?.key || defaultGroup?.title;\r\n  }\r\n\r\n  const valueArr =\r\n    (Array.isArray(defaultValue) && defaultValue) || (defaultValue && [defaultValue]) || [];\r\n  const sourceChildrenArr = sourceChildren ? React.Children.toArray(sourceChildren) : [];\r\n  const childrenArr = children ? React.Children.toArray(children) : [];\r\n  const allChildren = sourceChildrenArr.concat(childrenArr);\r\n\r\n  return (\r\n    <CloneChildren\r\n      allChildren={allChildren}\r\n      groups={groups}\r\n      childType={GroupAccordion}\r\n      grouping={grouping}\r\n      defaultValue={valueArr}\r\n      name={'grouping ' + grouping.name}\r\n    >\r\n      <DefaultAccordion name=\"DefaultAccordion\" />\r\n    </CloneChildren>\r\n  );\r\n}\r\n\r\nfunction DefaultAccordion(props) {\r\n  const { groups, defaultValue, grouping, allChildren, asChild } = props;\r\n  if (!allChildren || !groups) {\r\n    return null;\r\n  }\r\n\r\n  if (Boolean(asChild)) {\r\n    return React.cloneElement(props.children, props);\r\n  }\r\n\r\n  return (\r\n    <Accordion\r\n      type={grouping.type || 'multiple'}\r\n      className=\"text-white\"\r\n      defaultValue={defaultValue}\r\n    >\r\n      {[...groups.entries()].map(([key, group]) => {\r\n        return (\r\n          <AccordionItem\r\n            key={group.key + '-i'}\r\n            value={group.key}\r\n          >\r\n            <CloneChildren\r\n              allChildren={allChildren}\r\n              group={group}\r\n              childType={Trigger}\r\n              name=\"AccordionGroup.Trigger\"\r\n            />\r\n            <CloneChildren\r\n              allChildren={allChildren}\r\n              group={group}\r\n              childType={Content}\r\n              defaultTypes={DEFAULT_TYPES}\r\n              name=\"AccordionGroup.Content\"\r\n            />\r\n          </AccordionItem>\r\n        );\r\n      })}\r\n    </Accordion>\r\n  );\r\n}\r\n\r\nfunction GroupAccordion(props) {\r\n  const { groups, children } = props;\r\n  if (!groups) {\r\n    return null;\r\n  }\r\n  return [...groups.values()].map(group =>\r\n    React.cloneElement(children, {\r\n      ...props,\r\n      children: children.props.children,\r\n      group,\r\n      ...group,\r\n      key: group.title,\r\n    })\r\n  );\r\n}\r\n\r\nfunction Content(props) {\r\n  const { children, asChild, ...childProps } = props;\r\n  const { group } = props;\r\n  Object.assign(childProps, group);\r\n\r\n  if (!group) {\r\n    return null;\r\n  }\r\n  if (asChild) {\r\n    return React.cloneElement(children, { ...group, ...props, children: children.props.children });\r\n  }\r\n  return (\r\n    <AccordionContent>\r\n      {React.cloneElement(children, { ...group, ...props, children: children.props.children })}\r\n    </AccordionContent>\r\n  );\r\n}\r\n\r\nfunction Trigger(props) {\r\n  const { children, asChild, ...childProps } = props;\r\n  const { group } = props;\r\n  Object.assign(childProps, group);\r\n\r\n  if (!group) {\r\n    return null;\r\n  }\r\n  if (asChild) {\r\n    return React.cloneElement(children, childProps);\r\n  }\r\n  return (\r\n    <AccordionTrigger\r\n      value={group.value}\r\n      asChild={true}\r\n    >\r\n      <div>\r\n        {React.cloneElement(children, childProps)}\r\n        <ChevronDownIcon\r\n          key=\"chevronDown\"\r\n          className=\"text-primary h-4 w-4 shrink-0 transition-transform duration-200\"\r\n        />\r\n      </div>\r\n    </AccordionTrigger>\r\n  );\r\n}\r\n\r\nAccordionGroup.Content = Content;\r\nAccordionGroup.Trigger = Trigger;\r\nAccordionGroup.Accordion = GroupAccordion;\r\n\r\nexport default AccordionGroup;\r\n","export * from './AccordionGroup';\r\nimport AccordionGroup from './AccordionGroup';\r\n\r\nexport default AccordionGroup;\r\n","import React, { ReactElement } from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport { useViewportGrid } from '@ohif/ui-next';\r\nimport ViewportWindowLevel from '../ViewportWindowLevel/ViewportWindowLevel';\r\n\r\nconst ActiveViewportWindowLevel = ({ servicesManager }: withAppTypes): ReactElement => {\r\n  const [viewportGrid] = useViewportGrid();\r\n  const { activeViewportId } = viewportGrid;\r\n\r\n  return (\r\n    <>\r\n      {activeViewportId && (\r\n        <ViewportWindowLevel\r\n          servicesManager={servicesManager}\r\n          viewportId={activeViewportId}\r\n        />\r\n      )}\r\n    </>\r\n  );\r\n};\r\n\r\nActiveViewportWindowLevel.propTypes = {\r\n  servicesManager: PropTypes.object.isRequired,\r\n};\r\n\r\nexport default ActiveViewportWindowLevel;\r\n","export { default } from './ActiveViewportWindowLevel';\r\n","import { useToolbar, useViewportMousePosition } from '@ohif/core/src/hooks';\r\nimport React, { useState, useEffect, useRef } from 'react';\r\nimport { useViewportRendering } from '../../hooks';\r\n\r\nfunction AdvancedRenderingControls({\r\n  viewportId,\r\n  location,\r\n  buttonSection,\r\n}: {\r\n  viewportId: string;\r\n  location: number;\r\n  buttonSection: string;\r\n}) {\r\n  const {\r\n    onInteraction,\r\n    toolbarButtons,\r\n    isItemOpen,\r\n    isItemLocked,\r\n    openItem,\r\n    closeItem,\r\n    toggleLock,\r\n  } = useToolbar({\r\n    buttonSection,\r\n  });\r\n\r\n  const mousePosition = useViewportMousePosition(viewportId);\r\n  const [isAtBottom, setIsAtBottom] = useState(false);\r\n  const [showAllIcons, setShowAllIcons] = useState(true);\r\n  const firstMountRef = useRef(true);\r\n  const { hasColorbar } = useViewportRendering(viewportId);\r\n\r\n  useEffect(() => {\r\n    if (firstMountRef.current) {\r\n      firstMountRef.current = false;\r\n\r\n      const timer = setTimeout(() => {\r\n        setShowAllIcons(false);\r\n      }, 3000);\r\n\r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!showAllIcons && mousePosition.isInViewport) {\r\n      if (mousePosition.isInBottomPercentage(10)) {\r\n        setIsAtBottom(true);\r\n      } else {\r\n        setIsAtBottom(false);\r\n      }\r\n    }\r\n  }, [mousePosition, showAllIcons]);\r\n\r\n  if (!toolbarButtons?.length) {\r\n    return null;\r\n  }\r\n\r\n  if (!hasColorbar) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-row gap-2\">\r\n      {toolbarButtons.map(toolDef => {\r\n        if (!toolDef) {\r\n          return null;\r\n        }\r\n\r\n        const { id, Component, componentProps } = toolDef;\r\n\r\n        // Enhanced props with state and actions - respecting viewport specificity\r\n        const enhancedProps = {\r\n          ...componentProps,\r\n          isOpen: isItemOpen(id, viewportId),\r\n          isLocked: isItemLocked(id, viewportId),\r\n          onOpen: () => openItem(id, viewportId),\r\n          onClose: () => closeItem(id, viewportId),\r\n          onToggleLock: () => toggleLock(id, viewportId),\r\n          viewportId,\r\n        };\r\n\r\n        const tool = (\r\n          <Component\r\n            key={id}\r\n            id={id}\r\n            location={location}\r\n            onInteraction={args => {\r\n              onInteraction({\r\n                ...args,\r\n                itemId: id,\r\n                viewportId,\r\n              });\r\n            }}\r\n            {...enhancedProps}\r\n          />\r\n        );\r\n\r\n        // Always show all icons on first mount for 3 seconds\r\n        // After that, always show Colorbar, show others only when mouse is at bottom\r\n        const shouldBeVisible = showAllIcons || id === 'Colorbar' || isAtBottom;\r\n\r\n        return (\r\n          <div\r\n            key={id}\r\n            className={shouldBeVisible ? 'opacity-100' : 'pointer-events-none opacity-0'}\r\n            style={{ transition: 'opacity 0.2s ease-in-out' }}\r\n          >\r\n            {tool}\r\n          </div>\r\n        );\r\n      })}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default AdvancedRenderingControls;\r\n","export { default } from './AdvancedRenderingControls';\r\n","import React, { useCallback, useState } from 'react';\r\nimport { ReactElement } from 'react';\r\nimport Dropzone from 'react-dropzone';\r\nimport PropTypes from 'prop-types';\r\nimport classNames from 'classnames';\r\nimport DicomFileUploader from '../../utils/DicomFileUploader';\r\nimport DicomUploadProgress from './DicomUploadProgress';\r\nimport { Button, ButtonEnums } from '@ohif/ui';\r\nimport './DicomUpload.css';\r\n\r\ntype DicomUploadProps = {\r\n  dataSource;\r\n  onComplete: () => void;\r\n  onStarted: () => void;\r\n};\r\n\r\nfunction DicomUpload({ dataSource, onComplete, onStarted }: DicomUploadProps): ReactElement {\r\n  const baseClassNames = 'min-h-[480px] flex flex-col bg-black select-none';\r\n  const [dicomFileUploaderArr, setDicomFileUploaderArr] = useState([]);\r\n\r\n  const onDrop = useCallback(async acceptedFiles => {\r\n    onStarted();\r\n    setDicomFileUploaderArr(acceptedFiles.map(file => new DicomFileUploader(file, dataSource)));\r\n  }, []);\r\n\r\n  const getDropZoneComponent = (): ReactElement => {\r\n    return (\r\n      <Dropzone\r\n        onDrop={acceptedFiles => {\r\n          onDrop(acceptedFiles);\r\n        }}\r\n        noClick\r\n      >\r\n        {({ getRootProps }) => (\r\n          <div\r\n            {...getRootProps()}\r\n            className=\"dicom-upload-drop-area-border-dash m-5 flex h-full flex-col items-center justify-center\"\r\n          >\r\n            <div className=\"flex gap-3\">\r\n              <Dropzone\r\n                onDrop={onDrop}\r\n                noDrag\r\n              >\r\n                {({ getRootProps, getInputProps }) => (\r\n                  <div {...getRootProps()}>\r\n                    <Button\r\n                      disabled={false}\r\n                      onClick={() => {}}\r\n                    >\r\n                      {'Add files'}\r\n                      <input {...getInputProps()} />\r\n                    </Button>\r\n                  </div>\r\n                )}\r\n              </Dropzone>\r\n              <Dropzone\r\n                onDrop={onDrop}\r\n                noDrag\r\n              >\r\n                {({ getRootProps, getInputProps }) => (\r\n                  <div {...getRootProps()}>\r\n                    <Button\r\n                      type={ButtonEnums.type.secondary}\r\n                      disabled={false}\r\n                      onClick={() => {}}\r\n                    >\r\n                      {'Add folder'}\r\n                      <input\r\n                        {...getInputProps()}\r\n                        webkitdirectory=\"true\"\r\n                        mozdirectory=\"true\"\r\n                      />\r\n                    </Button>\r\n                  </div>\r\n                )}\r\n              </Dropzone>\r\n            </div>\r\n            <div className=\"pt-5\">or drag images or folders here</div>\r\n            <div className=\"text-aqua-pale pt-3 text-lg\">(DICOM files supported)</div>\r\n          </div>\r\n        )}\r\n      </Dropzone>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <>\r\n      {dicomFileUploaderArr.length ? (\r\n        <div className={classNames('h-[calc(100vh-300px)]', baseClassNames)}>\r\n          <DicomUploadProgress\r\n            dicomFileUploaderArr={Array.from(dicomFileUploaderArr)}\r\n            onComplete={onComplete}\r\n          />\r\n        </div>\r\n      ) : (\r\n        <div className={classNames('h-[480px]', baseClassNames)}>{getDropZoneComponent()}</div>\r\n      )}\r\n    </>\r\n  );\r\n}\r\n\r\nDicomUpload.propTypes = {\r\n  dataSource: PropTypes.object.isRequired,\r\n  onComplete: PropTypes.func.isRequired,\r\n  onStarted: PropTypes.func.isRequired,\r\n};\r\n\r\nexport default DicomUpload;\r\n","import React, { useCallback, useEffect, useRef, useState, ReactElement } from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport { useSystem } from '@ohif/core';\r\nimport { Button } from '@ohif/ui';\r\nimport { Icons } from '@ohif/ui-next';\r\nimport DicomFileUploader, {\r\n  EVENTS,\r\n  UploadStatus,\r\n  DicomFileUploaderProgressEvent,\r\n  UploadRejection,\r\n} from '../../utils/DicomFileUploader';\r\nimport DicomUploadProgressItem from './DicomUploadProgressItem';\r\nimport classNames from 'classnames';\r\n\r\ntype DicomUploadProgressProps = {\r\n  dicomFileUploaderArr: DicomFileUploader[];\r\n  onComplete: () => void;\r\n};\r\n\r\nconst ONE_SECOND = 1000;\r\nconst ONE_MINUTE = ONE_SECOND * 60;\r\nconst ONE_HOUR = ONE_MINUTE * 60;\r\n\r\n// The base/initial interval time length used to calculate the\r\n// rate of the upload and in turn estimate the\r\n// the amount of time remaining for the upload. This is the length\r\n// of the very first interval to get a reasonable estimate on screen in\r\n// a reasonable amount of time. The length of each interval after the first\r\n// is based on the upload rate calculated. Faster rates use this base interval\r\n// length. Slower rates below UPLOAD_RATE_THRESHOLD get longer interval times\r\n// to obtain more accurate upload rates.\r\nconst BASE_INTERVAL_TIME = 15000;\r\n\r\n// The upload rate threshold to determine the length of the interval to\r\n// calculate the upload rate.\r\nconst UPLOAD_RATE_THRESHOLD = 75;\r\n\r\nconst NO_WRAP_ELLIPSIS_CLASS_NAMES = 'text-ellipsis whitespace-nowrap overflow-hidden';\r\n\r\nfunction DicomUploadProgress({\r\n  dicomFileUploaderArr,\r\n  onComplete,\r\n}: DicomUploadProgressProps): ReactElement {\r\n  const { servicesManager } = useSystem();\r\n\r\n  const ProgressLoadingBar =\r\n    servicesManager.services.customizationService.getCustomization('ui.progressLoadingBar');\r\n\r\n  const [totalUploadSize] = useState(\r\n    dicomFileUploaderArr.reduce((acc, fileUploader) => acc + fileUploader.getFileSize(), 0)\r\n  );\r\n\r\n  const currentUploadSizeRef = useRef<number>(0);\r\n\r\n  const uploadRateRef = useRef(0);\r\n\r\n  const [timeRemaining, setTimeRemaining] = useState<number>(null);\r\n\r\n  const [percentComplete, setPercentComplete] = useState(0);\r\n\r\n  const [numFilesCompleted, setNumFilesCompleted] = useState(0);\r\n\r\n  const [numFails, setNumFails] = useState(0);\r\n\r\n  const [showFailedOnly, setShowFailedOnly] = useState(false);\r\n\r\n  const progressBarContainerRef = useRef<HTMLElement>();\r\n\r\n  /**\r\n   * The effect for measuring and setting the current upload rate. This is\r\n   * done by measuring the amount of data uploaded in a set interval time.\r\n   */\r\n  useEffect(() => {\r\n    let timeoutId: NodeJS.Timeout;\r\n\r\n    // The amount of data already uploaded at the start of the interval.\r\n    let intervalStartUploadSize = 0;\r\n\r\n    // The starting time of the interval.\r\n    let intervalStartTime = Date.now();\r\n\r\n    const setUploadRateRef = () => {\r\n      const uploadSizeFromStartOfInterval = currentUploadSizeRef.current - intervalStartUploadSize;\r\n\r\n      const now = Date.now();\r\n      const timeSinceStartOfInterval = now - intervalStartTime;\r\n\r\n      // Calculate and set the upload rate (ref)\r\n      uploadRateRef.current = uploadSizeFromStartOfInterval / timeSinceStartOfInterval;\r\n\r\n      // Reset the interval starting values.\r\n      intervalStartUploadSize = currentUploadSizeRef.current;\r\n      intervalStartTime = now;\r\n\r\n      // Only start a new interval if there is more to upload.\r\n      if (totalUploadSize - currentUploadSizeRef.current > 0) {\r\n        if (uploadRateRef.current >= UPLOAD_RATE_THRESHOLD) {\r\n          timeoutId = setTimeout(setUploadRateRef, BASE_INTERVAL_TIME);\r\n        } else {\r\n          // The current upload rate is relatively slow, so use a larger\r\n          // time interval to get a better upload rate estimate.\r\n          timeoutId = setTimeout(setUploadRateRef, BASE_INTERVAL_TIME * 2);\r\n        }\r\n      }\r\n    };\r\n\r\n    // The very first interval is just the base time interval length.\r\n    timeoutId = setTimeout(setUploadRateRef, BASE_INTERVAL_TIME);\r\n\r\n    return () => {\r\n      clearTimeout(timeoutId);\r\n    };\r\n  }, []);\r\n\r\n  /**\r\n   * The effect for: updating the overall percentage complete; setting the\r\n   * estimated time remaining; updating the number of files uploaded; and\r\n   * detecting if any error has occurred.\r\n   */\r\n  useEffect(() => {\r\n    let currentTimeRemaining = null;\r\n\r\n    // For each uploader, listen for the progress percentage complete and\r\n    // add promise catch/finally callbacks to detect errors and count number\r\n    // of uploads complete.\r\n    const subscriptions = dicomFileUploaderArr.map(fileUploader => {\r\n      let currentFileUploadSize = 0;\r\n\r\n      const updateProgress = (percentComplete: number) => {\r\n        const previousFileUploadSize = currentFileUploadSize;\r\n\r\n        currentFileUploadSize = Math.round((percentComplete / 100) * fileUploader.getFileSize());\r\n\r\n        currentUploadSizeRef.current = Math.min(\r\n          totalUploadSize,\r\n          currentUploadSizeRef.current - previousFileUploadSize + currentFileUploadSize\r\n        );\r\n\r\n        setPercentComplete((currentUploadSizeRef.current / totalUploadSize) * 100);\r\n\r\n        if (uploadRateRef.current !== 0) {\r\n          const uploadSizeRemaining = totalUploadSize - currentUploadSizeRef.current;\r\n\r\n          const timeRemaining = Math.round(uploadSizeRemaining / uploadRateRef.current);\r\n\r\n          if (currentTimeRemaining === null) {\r\n            currentTimeRemaining = timeRemaining;\r\n            setTimeRemaining(currentTimeRemaining);\r\n            return;\r\n          }\r\n\r\n          // Do not show an increase in the time remaining by two seconds or minutes\r\n          // so as to prevent jumping the time remaining up and down constantly\r\n          // due to rounding, inaccuracies in the estimate and slight variations\r\n          // in upload rates over time.\r\n          if (timeRemaining < ONE_MINUTE) {\r\n            const currentSecondsRemaining = Math.ceil(currentTimeRemaining / ONE_SECOND);\r\n            const secondsRemaining = Math.ceil(timeRemaining / ONE_SECOND);\r\n            const delta = secondsRemaining - currentSecondsRemaining;\r\n            if (delta < 0 || delta > 2) {\r\n              currentTimeRemaining = timeRemaining;\r\n              setTimeRemaining(currentTimeRemaining);\r\n            }\r\n            return;\r\n          }\r\n\r\n          if (timeRemaining < ONE_HOUR) {\r\n            const currentMinutesRemaining = Math.ceil(currentTimeRemaining / ONE_MINUTE);\r\n            const minutesRemaining = Math.ceil(timeRemaining / ONE_MINUTE);\r\n            const delta = minutesRemaining - currentMinutesRemaining;\r\n            if (delta < 0 || delta > 2) {\r\n              currentTimeRemaining = timeRemaining;\r\n              setTimeRemaining(currentTimeRemaining);\r\n            }\r\n            return;\r\n          }\r\n\r\n          // Hours remaining...\r\n          currentTimeRemaining = timeRemaining;\r\n          setTimeRemaining(currentTimeRemaining);\r\n        }\r\n      };\r\n\r\n      const progressCallback = (progressEvent: DicomFileUploaderProgressEvent) => {\r\n        updateProgress(progressEvent.percentComplete);\r\n      };\r\n\r\n      // Use the uploader promise to flag any error and count the number of\r\n      // uploads completed.\r\n      fileUploader\r\n        .load()\r\n        .catch((rejection: UploadRejection) => {\r\n          if (rejection.status === UploadStatus.Failed) {\r\n            setNumFails(numFails => numFails + 1);\r\n          }\r\n        })\r\n        .finally(() => {\r\n          // If any error occurred, the percent complete progress stops firing\r\n          // but this call to updateProgress nicely puts all finished uploads at 100%.\r\n          updateProgress(100);\r\n          setNumFilesCompleted(numCompleted => numCompleted + 1);\r\n        });\r\n\r\n      return fileUploader.subscribe(EVENTS.PROGRESS, progressCallback);\r\n    });\r\n    return () => {\r\n      subscriptions.forEach(subscription => subscription.unsubscribe());\r\n    };\r\n  }, []);\r\n\r\n  const cancelAllUploads = useCallback(async () => {\r\n    for (const dicomFileUploader of dicomFileUploaderArr) {\r\n      // Important: we need a non-blocking way to cancel every upload,\r\n      // otherwise the UI will freeze and the user will not be able\r\n      // to interact with the app and progress will not be updated.\r\n      const promise = new Promise<void>((resolve, reject) => {\r\n        setTimeout(() => {\r\n          dicomFileUploader.cancel();\r\n          resolve();\r\n        }, 0);\r\n      });\r\n    }\r\n  }, []);\r\n\r\n  const getFormattedTimeRemaining = useCallback((): string => {\r\n    if (timeRemaining == null) {\r\n      return '';\r\n    }\r\n\r\n    if (timeRemaining < ONE_MINUTE) {\r\n      const secondsRemaining = Math.ceil(timeRemaining / ONE_SECOND);\r\n      return `${secondsRemaining} ${secondsRemaining === 1 ? 'second' : 'seconds'}`;\r\n    }\r\n\r\n    if (timeRemaining < ONE_HOUR) {\r\n      const minutesRemaining = Math.ceil(timeRemaining / ONE_MINUTE);\r\n      return `${minutesRemaining} ${minutesRemaining === 1 ? 'minute' : 'minutes'}`;\r\n    }\r\n\r\n    const hoursRemaining = Math.ceil(timeRemaining / ONE_HOUR);\r\n    return `${hoursRemaining} ${hoursRemaining === 1 ? 'hour' : 'hours'}`;\r\n  }, [timeRemaining]);\r\n\r\n  const getPercentCompleteRounded = useCallback(\r\n    () => Math.min(100, Math.round(percentComplete)),\r\n    [percentComplete]\r\n  );\r\n\r\n  /**\r\n   * Determines if the progress bar should show the infinite animation or not.\r\n   * Show the infinite animation for progress less than 1% AND if less than\r\n   * one pixel of the progress bar would be displayed.\r\n   */\r\n  const showInfiniteProgressBar = useCallback((): boolean => {\r\n    return (\r\n      getPercentCompleteRounded() < 1 &&\r\n      (progressBarContainerRef?.current?.offsetWidth ?? 0) * (percentComplete / 100) < 1\r\n    );\r\n  }, [getPercentCompleteRounded, percentComplete]);\r\n\r\n  /**\r\n   * Gets the css style for the 'n of m' (files completed) text. The only css attribute\r\n   * of the style is width such that the 'n of m' is always a fixed width and thus\r\n   * as each file completes uploading the text on screen does not constantly shift\r\n   * left and right.\r\n   */\r\n  const getNofMFilesStyle = useCallback(() => {\r\n    // the number of digits accounts for the digits being on each side of the ' of '\r\n    const numDigits = 2 * dicomFileUploaderArr.length.toString().length;\r\n    // the number of digits + 2 spaces and 2 characters for ' of '\r\n    const numChars = numDigits + 4;\r\n    return { width: `${numChars}ch` };\r\n  }, []);\r\n\r\n  const getNumCompletedAndTimeRemainingComponent = (): ReactElement => {\r\n    return (\r\n      <div className=\"bg-primary-dark flex h-14 items-center px-1 pb-4 text-lg\">\r\n        {numFilesCompleted === dicomFileUploaderArr.length ? (\r\n          <>\r\n            <span className={NO_WRAP_ELLIPSIS_CLASS_NAMES}>{`${dicomFileUploaderArr.length} ${\r\n              dicomFileUploaderArr.length > 1 ? 'files' : 'file'\r\n            } completed.`}</span>\r\n            <Button\r\n              disabled={false}\r\n              className=\"ml-auto\"\r\n              onClick={onComplete}\r\n            >\r\n              {'Close'}\r\n            </Button>\r\n          </>\r\n        ) : (\r\n          <>\r\n            <span\r\n              style={getNofMFilesStyle()}\r\n              className={classNames(NO_WRAP_ELLIPSIS_CLASS_NAMES, 'text-end')}\r\n            >\r\n              {`${numFilesCompleted} of ${dicomFileUploaderArr.length}`}&nbsp;\r\n            </span>\r\n            <span className={NO_WRAP_ELLIPSIS_CLASS_NAMES}>{' files completed.'}&nbsp;</span>\r\n            <span className={NO_WRAP_ELLIPSIS_CLASS_NAMES}>\r\n              {timeRemaining ? `Less than ${getFormattedTimeRemaining()} remaining. ` : ''}\r\n            </span>\r\n            <span\r\n              className={classNames(\r\n                NO_WRAP_ELLIPSIS_CLASS_NAMES,\r\n                'text-primary hover:text-primary-light active:text-aqua-pale ml-auto cursor-pointer'\r\n              )}\r\n              onClick={cancelAllUploads}\r\n            >\r\n              Cancel All Uploads\r\n            </span>\r\n          </>\r\n        )}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  const getShowFailedOnlyIconComponent = (): ReactElement => {\r\n    return (\r\n      <div className=\"ml-auto flex w-6 justify-center\">\r\n        {numFails > 0 && (\r\n          <div onClick={() => setShowFailedOnly(currentShowFailedOnly => !currentShowFailedOnly)}>\r\n            <Icons.ByName\r\n              className=\"cursor-pointer\"\r\n              name=\"icon-status-alert\"\r\n            ></Icons.ByName>\r\n          </div>\r\n        )}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  const getPercentCompleteComponent = (): ReactElement => {\r\n    return (\r\n      <div className=\"ohif-scrollbar border-secondary-light overflow-y-scroll border-b px-2\">\r\n        <div className=\"min-h-14 flex w-full items-center p-2.5\">\r\n          {numFilesCompleted === dicomFileUploaderArr.length ? (\r\n            <>\r\n              <div className=\"text-primary-light text-xl\">\r\n                {numFails > 0\r\n                  ? `Completed with ${numFails} ${numFails > 1 ? 'errors' : 'error'}!`\r\n                  : 'Completed!'}\r\n              </div>\r\n              {getShowFailedOnlyIconComponent()}\r\n            </>\r\n          ) : (\r\n            <>\r\n              <div\r\n                ref={progressBarContainerRef}\r\n                className=\"flex-grow\"\r\n              >\r\n                <ProgressLoadingBar\r\n                  progress={showInfiniteProgressBar() ? undefined : Math.min(100, percentComplete)}\r\n                ></ProgressLoadingBar>\r\n              </div>\r\n              <div className=\"ml-1 flex w-24 items-center\">\r\n                <div className=\"w-10 text-right\">{`${getPercentCompleteRounded()}%`}</div>\r\n                {getShowFailedOnlyIconComponent()}\r\n              </div>\r\n            </>\r\n          )}\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex grow flex-col\">\r\n      {getNumCompletedAndTimeRemainingComponent()}\r\n      <div className=\"flex grow flex-col overflow-hidden bg-black text-lg\">\r\n        {getPercentCompleteComponent()}\r\n        <div className=\"ohif-scrollbar h-1 grow overflow-y-scroll px-2\">\r\n          {dicomFileUploaderArr\r\n            .filter(\r\n              dicomFileUploader =>\r\n                !showFailedOnly || dicomFileUploader.getStatus() === UploadStatus.Failed\r\n            )\r\n            .map(dicomFileUploader => (\r\n              <DicomUploadProgressItem\r\n                key={dicomFileUploader.getFileId()}\r\n                dicomFileUploader={dicomFileUploader}\r\n              />\r\n            ))}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nDicomUploadProgress.propTypes = {\r\n  dicomFileUploaderArr: PropTypes.arrayOf(PropTypes.instanceOf(DicomFileUploader)).isRequired,\r\n  onComplete: PropTypes.func.isRequired,\r\n};\r\n\r\nexport default DicomUploadProgress;\r\n","import React, { ReactElement, memo, useCallback, useEffect, useState } from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport DicomFileUploader, {\r\n  DicomFileUploaderProgressEvent,\r\n  EVENTS,\r\n  UploadRejection,\r\n  UploadStatus,\r\n} from '../../utils/DicomFileUploader';\r\nimport { Icons } from '@ohif/ui-next';\r\n\r\ntype DicomUploadProgressItemProps = {\r\n  dicomFileUploader: DicomFileUploader;\r\n};\r\n\r\n// eslint-disable-next-line react/display-name\r\nconst DicomUploadProgressItem = memo(\r\n  ({ dicomFileUploader }: DicomUploadProgressItemProps): ReactElement => {\r\n    const [percentComplete, setPercentComplete] = useState(dicomFileUploader.getPercentComplete());\r\n    const [failedReason, setFailedReason] = useState('');\r\n    const [status, setStatus] = useState(dicomFileUploader.getStatus());\r\n\r\n    const isComplete = useCallback(() => {\r\n      return (\r\n        status === UploadStatus.Failed ||\r\n        status === UploadStatus.Cancelled ||\r\n        status === UploadStatus.Success\r\n      );\r\n    }, [status]);\r\n\r\n    useEffect(() => {\r\n      const progressSubscription = dicomFileUploader.subscribe(\r\n        EVENTS.PROGRESS,\r\n        (dicomFileUploaderProgressEvent: DicomFileUploaderProgressEvent) => {\r\n          setPercentComplete(dicomFileUploaderProgressEvent.percentComplete);\r\n        }\r\n      );\r\n\r\n      dicomFileUploader\r\n        .load()\r\n        .catch((reason: UploadRejection) => {\r\n          setStatus(reason.status);\r\n          setFailedReason(reason.message ?? '');\r\n        })\r\n        .finally(() => setStatus(dicomFileUploader.getStatus()));\r\n\r\n      return () => progressSubscription.unsubscribe();\r\n    }, []);\r\n\r\n    const cancelUpload = useCallback(() => {\r\n      dicomFileUploader.cancel();\r\n    }, []);\r\n\r\n    const getStatusIcon = (): ReactElement => {\r\n      switch (dicomFileUploader.getStatus()) {\r\n        case UploadStatus.Success:\r\n          return (\r\n            <Icons.ByName\r\n              name=\"status-tracked\"\r\n              className=\"text-primary-light\"\r\n            />\r\n          );\r\n        case UploadStatus.InProgress:\r\n          return <Icons.ByName name=\"icon-transferring\" />;\r\n        case UploadStatus.Failed:\r\n          return <Icons.ByName name=\"icon-alert-small\" />;\r\n        case UploadStatus.Cancelled:\r\n          return <Icons.ByName name=\"icon-alert-outline\" />;\r\n        default:\r\n          return <></>;\r\n      }\r\n    };\r\n\r\n    return (\r\n      <div className=\"min-h-14 border-secondary-light flex w-full items-center overflow-hidden border-b p-2.5 text-lg\">\r\n        <div className=\"self-top flex w-0 shrink grow flex-col gap-1\">\r\n          <div className=\"flex gap-4\">\r\n            <div className=\"flex w-6 shrink-0 items-center justify-center\">{getStatusIcon()}</div>\r\n            <div className=\"overflow-hidden text-ellipsis whitespace-nowrap\">\r\n              {dicomFileUploader.getFileName()}\r\n            </div>\r\n          </div>\r\n          {failedReason && <div className=\"pl-10\">{failedReason}</div>}\r\n        </div>\r\n        <div className=\"flex w-24 items-center\">\r\n          {!isComplete() && (\r\n            <>\r\n              {dicomFileUploader.getStatus() === UploadStatus.InProgress && (\r\n                <div className=\"w-10 text-right\">{percentComplete}%</div>\r\n              )}\r\n              <div className=\"ml-auto flex cursor-pointer\">\r\n                <Icons.Close\r\n                  className=\"text-primary self-center\"\r\n                  onClick={cancelUpload}\r\n                />\r\n              </div>\r\n            </>\r\n          )}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n);\r\n\r\nDicomUploadProgressItem.propTypes = {\r\n  dicomFileUploader: PropTypes.instanceOf(DicomFileUploader).isRequired,\r\n};\r\n\r\nexport default DicomUploadProgressItem;\r\n","import React from 'react';\r\nimport { Accordion, AccordionContent, AccordionItem } from '@ohif/ui-next';\r\n\r\nimport PanelAccordionTrigger from './PanelAccordionTrigger';\r\nimport MeasurementsMenu from './MeasurementsMenu';\r\nimport { useSystem } from '@ohif/core';\r\n\r\nexport function MeasurementItem(props) {\r\n  const { index, item } = props;\r\n  return (\r\n    <PanelAccordionTrigger\r\n      count={index + 1}\r\n      text={item.toolName || item.label || item.title}\r\n      colorHex=\"#f00\"\r\n      isActive={item.isSelected}\r\n      menu={MeasurementsMenu}\r\n      group={{ items: [item], onClick: props.onClick }}\r\n    />\r\n  );\r\n}\r\n\r\nexport default function MeasurementAccordion(props) {\r\n  const { items } = props;\r\n  const system = useSystem();\r\n\r\n  const onClick = (e, group) => {\r\n    const { items } = group;\r\n    // Just jump to the first measurement in the set, and mark that one as active\r\n    // with the set of items.\r\n    system.commandsManager.run('jumpToMeasurement', {\r\n      uid: items[0].uid,\r\n      displayMeasurements: items,\r\n      group,\r\n    });\r\n  };\r\n\r\n  return (\r\n    <Accordion\r\n      type=\"multiple\"\r\n      className=\"flex-shrink-0 overflow-hidden\"\r\n    >\r\n      {items.map((item, index) => {\r\n        const { displayText: details = {} } = item;\r\n        return (\r\n          <AccordionItem\r\n            key={`measurementAccordion:${item.uid}`}\r\n            value={item.uid}\r\n          >\r\n            <MeasurementItem\r\n              item={item}\r\n              key={`measurementItem:${item.uid}`}\r\n              index={index}\r\n              onClick={onClick}\r\n            />\r\n            <AccordionContent key={`measurementContent:${item.uid}`}>\r\n              <div className=\"ml-7 px-2 py-2\">\r\n                <div className=\"text-secondary-foreground flex items-center gap-1 text-base leading-normal\">\r\n                  {details.primary?.length > 0 &&\r\n                    details.primary.map((detail, index) => (\r\n                      <span key={`details:${item.uid}:${index}`}>{detail}</span>\r\n                    ))}\r\n                </div>\r\n              </div>\r\n            </AccordionContent>\r\n          </AccordionItem>\r\n        );\r\n      })}\r\n    </Accordion>\r\n  );\r\n}\r\n","import React from 'react';\r\nimport { MeasurementTable } from '@ohif/ui-next';\r\nimport { useSystem } from '@ohif/core';\r\n\r\n/**\r\n * This is a measurement table that is designed to be nested inside\r\n * the accordion groups.\r\n */\r\nexport default function MeasurementTableNested(props) {\r\n  const { title, items, group, customHeader } = props;\r\n  const { commandsManager } = useSystem();\r\n  const onAction = (e, command, uid) => {\r\n    commandsManager.run(command, { uid, annotationUID: uid, displayMeasurements: items });\r\n  };\r\n\r\n  return (\r\n    <MeasurementTable\r\n      title={title ? title : `Measurements`}\r\n      data={items}\r\n      onAction={onAction}\r\n      {...group}\r\n      key={group.key}\r\n    >\r\n      <MeasurementTable.Header key=\"measurementTableHeader\">\r\n        {customHeader && group.isFirst && customHeader({ ...props, items: props.allItems })}\r\n      </MeasurementTable.Header>\r\n      <MeasurementTable.Body key=\"measurementTableBody\" />\r\n    </MeasurementTable>\r\n  );\r\n}\r\n","import React, { useState } from 'react';\r\nimport { useSystem } from '@ohif/core';\r\nimport {\r\n  Button,\r\n  DropdownMenu,\r\n  DropdownMenuTrigger,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  Icons,\r\n} from '@ohif/ui-next';\r\n\r\nexport function MeasumentsMenu(props) {\r\n  const { group, classNames } = props;\r\n  if (!group.items?.length) {\r\n    console.log('No items to iterate', group.items);\r\n    return null;\r\n  }\r\n  const { items } = group;\r\n  const [item] = items;\r\n  const { isSelected, isVisible } = item;\r\n\r\n  const system = useSystem();\r\n\r\n  const onAction = (event, command, args?) => {\r\n    const uid = items.map(item => item.uid);\r\n    // Some commands use displayMeasurements and some use items\r\n    system.commandsManager.run(command, {\r\n      ...args,\r\n      uid,\r\n      displayMeasurements: items,\r\n      items,\r\n      event,\r\n    });\r\n  };\r\n\r\n  const [isDropdownOpen, setIsDropdownOpen] = useState(false);\r\n\r\n  return (\r\n    <div className={`relative ml-2 inline-flex items-center space-x-1 ${classNames}`}>\r\n      {/* Visibility Toggle Icon */}\r\n      <Button\r\n        size=\"icon\"\r\n        variant=\"ghost\"\r\n        className={`h-6 w-6 transition-opacity ${\r\n          isSelected || !isVisible ? 'opacity-100' : 'opacity-50 group-hover:opacity-100'\r\n        }`}\r\n        aria-label={isVisible ? 'Hide' : 'Show'}\r\n        onClick={e => {\r\n          e.stopPropagation();\r\n          onAction(e, ['jumpToMeasurement', 'toggleVisibilityMeasurement']);\r\n        }}\r\n      >\r\n        {isVisible ? <Icons.Hide className=\"h-6 w-6\" /> : <Icons.Show className=\"h-6 w-6\" />}\r\n      </Button>\r\n      {/* Actions Dropdown Menu */}\r\n      <DropdownMenu onOpenChange={open => setIsDropdownOpen(open)}>\r\n        <DropdownMenuTrigger asChild>\r\n          <Button\r\n            size=\"icon\"\r\n            variant=\"ghost\"\r\n            className={`h-6 w-6 transition-opacity ${\r\n              isSelected || isDropdownOpen ? 'opacity-100' : 'opacity-50 group-hover:opacity-100'\r\n            }`}\r\n            aria-label=\"Actions\"\r\n            onClick={e => e.stopPropagation()} // Prevent row selection on button click\r\n          >\r\n            <Icons.More className=\"h-6 w-6\" />\r\n          </Button>\r\n        </DropdownMenuTrigger>\r\n        <DropdownMenuContent align=\"end\">\r\n          <DropdownMenuItem onClick={e => onAction(e, 'removeMeasurement')}>\r\n            <Icons.Delete className=\"text-foreground\" />\r\n            <span className=\"pl-2\">Delete</span>\r\n          </DropdownMenuItem>\r\n        </DropdownMenuContent>\r\n      </DropdownMenu>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default MeasumentsMenu;\r\n","import React from 'react';\r\nimport AccordionGroup from './AccordionGroup';\r\nimport { utils } from '@ohif/core';\r\nimport MeasurementTableNested from './MeasurementTableNested';\r\n\r\nconst { filterNot, filterAdditionalFindings } = utils.MeasurementFilters;\r\n\r\nexport const MeasurementOrAdditionalFindingSets = [\r\n  {\r\n    title: 'Measurements',\r\n    filter: filterNot(filterAdditionalFindings),\r\n  },\r\n  {\r\n    title: 'Additional Findings',\r\n    filter: filterAdditionalFindings,\r\n  },\r\n];\r\n\r\n/**\r\n * Groups measurements by study in order to allow display and saving by study\r\n * @param {Object} servicesManager\r\n */\r\nexport const groupByNamedSets = (items, grouping) => {\r\n  const groups = new Map();\r\n  const { namedSets } = grouping;\r\n\r\n  for (const namedSet of namedSets) {\r\n    const name = namedSet.id || namedSet.title;\r\n    groups.set(name, {\r\n      ...grouping,\r\n      ...namedSet,\r\n      items: [],\r\n      isFirst: groups.size === 0,\r\n      title: name,\r\n      key: name,\r\n    });\r\n  }\r\n  items.forEach(item => {\r\n    for (const namedSet of namedSets) {\r\n      if (namedSet.filter(item)) {\r\n        const name = namedSet.id || namedSet.title;\r\n        groups.get(name).items.push(item);\r\n        return;\r\n      }\r\n    }\r\n  });\r\n  for (const namedSet of namedSets) {\r\n    const name = namedSet.id || namedSet.title;\r\n    if (!groups.get(name).items.length) {\r\n      groups.delete(name);\r\n    }\r\n  }\r\n  return groups;\r\n};\r\n\r\nexport function MeasurementsOrAdditionalFindings(props): React.ReactNode {\r\n  const { items, children, grouping = {}, customHeader, group, actions } = props;\r\n\r\n  return (\r\n    <AccordionGroup\r\n      grouping={{\r\n        groupingFunction: groupByNamedSets,\r\n        name: 'measurementsOrAdditional',\r\n        namedSets: MeasurementOrAdditionalFindingSets,\r\n        StudyInstanceUID: group?.StudyInstanceUID,\r\n        ...grouping,\r\n      }}\r\n      items={items}\r\n      sourceChildren={children}\r\n    >\r\n      <AccordionGroup.Accordion noWrapper=\"true\">\r\n        <MeasurementTableNested\r\n          customHeader={customHeader}\r\n          allItems={items}\r\n          actions={actions}\r\n        />\r\n      </AccordionGroup.Accordion>\r\n    </AccordionGroup>\r\n  );\r\n}\r\n\r\nexport default MeasurementsOrAdditionalFindings;\r\n","import React, { useMemo, useState, useEffect } from 'react';\r\nimport { useTranslation } from 'react-i18next';\r\nimport { ViewportActionButton } from '@ohif/ui-next';\r\nimport { Icons, Tooltip, TooltipTrigger, TooltipContent } from '@ohif/ui-next';\r\nimport { useSystem } from '@ohif/core/src';\r\nimport { useViewportDisplaySets } from '../../hooks/useViewportDisplaySets';\r\nimport { useMeasurementTracking } from '../../hooks/useMeasurementTracking';\r\n\r\n/**\r\n * ModalityLoadBadge displays the status and actionable buttons for viewports containing\r\n * special displaySets (SR, SEG, RTSTRUCT) or when tracking measurements\r\n */\r\nfunction ModalityLoadBadge({ viewportId }: { viewportId: string }) {\r\n  const { commandsManager } = useSystem();\r\n  const { t } = useTranslation('Common');\r\n  const loadStr = t('LOAD');\r\n\r\n  const { isTracked, isLocked } = useMeasurementTracking({ viewportId });\r\n\r\n  const { backgroundDisplaySet, overlayDisplaySets } = useViewportDisplaySets(viewportId);\r\n\r\n  const [specialDisplaySet, setSpecialDisplaySet] = useState(null);\r\n\r\n  const allDisplaySets = useMemo(() => {\r\n    return [backgroundDisplaySet, ...overlayDisplaySets].filter(Boolean);\r\n  }, [backgroundDisplaySet, overlayDisplaySets]);\r\n\r\n  useEffect(() => {\r\n    const displaySet = allDisplaySets.find(ds => ds.isOverlayDisplaySet || ds?.Modality === 'SR');\r\n\r\n    setSpecialDisplaySet(displaySet || null);\r\n  }, [allDisplaySets]);\r\n\r\n  const statusInfo = useMemo(() => {\r\n    if (isTracked && !specialDisplaySet) {\r\n      return {\r\n        type: 'SR',\r\n        isHydrated: true,\r\n        isTracked,\r\n        displaySet: null,\r\n        tooltip: 'Currently tracking measurements in this viewport',\r\n      };\r\n    }\r\n\r\n    if (!specialDisplaySet) {\r\n      return {\r\n        type: null,\r\n      };\r\n    }\r\n\r\n    const type = specialDisplaySet.Modality;\r\n    const isHydrated = specialDisplaySet.isHydrated || false;\r\n    let tooltip = null;\r\n    const isRehydratable = specialDisplaySet.isRehydratable || false;\r\n\r\n    if (type === 'SEG') {\r\n      tooltip = isHydrated\r\n        ? 'This Segmentation is loaded in the segmentation panel'\r\n        : 'Click LOAD to load segmentation.';\r\n    } else if (type === 'RTSTRUCT') {\r\n      tooltip = isHydrated\r\n        ? 'This RTSTRUCT is loaded in the segmentation panel'\r\n        : 'Click LOAD to load RTSTRUCT.';\r\n    } else if (type === 'SR') {\r\n      if (!isRehydratable) {\r\n        tooltip = 'This structured report is not compatible with this application.';\r\n      } else if (isRehydratable && isLocked) {\r\n        tooltip =\r\n          'This structured report is currently read-only because you are tracking measurements in another viewport.';\r\n      } else {\r\n        tooltip = `Click ${loadStr} to restore measurements.`;\r\n      }\r\n    }\r\n\r\n    return {\r\n      type,\r\n      isHydrated,\r\n      displaySet: specialDisplaySet,\r\n      isRehydratable,\r\n      tooltip,\r\n    };\r\n  }, [specialDisplaySet, loadStr, isLocked, isTracked]);\r\n\r\n  // Nothing to show if there's no special display set type or tracking\r\n  if (!statusInfo.type && !isTracked) {\r\n    return null;\r\n  }\r\n\r\n  const StatusIcon = () => {\r\n    if (statusInfo.type === 'SR') {\r\n      if (statusInfo.isRehydratable && !isLocked) {\r\n        return (\r\n          <Icons.ByName\r\n            className=\"text-muted-foreground h-4 w-4\"\r\n            name=\"status-untracked\"\r\n          />\r\n        );\r\n      }\r\n\r\n      if (statusInfo.isRehydratable && isLocked) {\r\n        return (\r\n          <Icons.ByName\r\n            name=\"status-locked\"\r\n            className=\"h-4 w-4\"\r\n          />\r\n        );\r\n      } else {\r\n        return (\r\n          <Icons.ByName\r\n            name=\"status-alert\"\r\n            className=\"h-4 w-4\"\r\n          />\r\n        );\r\n      }\r\n    } else {\r\n      return <Icons.StatusUntracked className=\"h-4 w-4\" />;\r\n    }\r\n  };\r\n\r\n  const StatusArea = () => {\r\n    if (!statusInfo.isHydrated) {\r\n      return (\r\n        <div className=\"flex h-6 cursor-default text-sm leading-6 text-white\">\r\n          <div className=\"bg-customgray-100 flex min-w-[45px] items-center rounded-l-xl rounded-r p-1\">\r\n            <StatusIcon />\r\n            <span className=\"ml-1\">{statusInfo.type}</span>\r\n          </div>\r\n          {/* We don't show the load button for SRs because we handle it in the SR extension\r\n          via the tracked measurement context that works with state machine, this is not a regression right now  */}\r\n          {statusInfo.type !== 'SR' && (\r\n            <ViewportActionButton\r\n              onInteraction={() => {\r\n                commandsManager.runCommand('hydrateSecondaryDisplaySet', {\r\n                  displaySet: statusInfo.displaySet,\r\n                  viewportId,\r\n                });\r\n              }}\r\n            >\r\n              {loadStr}\r\n            </ViewportActionButton>\r\n          )}\r\n        </div>\r\n      );\r\n    }\r\n\r\n    return null;\r\n  };\r\n\r\n  return (\r\n    <>\r\n      {statusInfo.tooltip && (\r\n        <Tooltip>\r\n          <TooltipTrigger asChild>\r\n            <span>\r\n              <StatusArea />\r\n            </span>\r\n          </TooltipTrigger>\r\n          <TooltipContent side=\"bottom\">\r\n            <div>{statusInfo.tooltip}</div>\r\n          </TooltipContent>\r\n        </Tooltip>\r\n      )}\r\n      {!statusInfo.tooltip && <StatusArea />}\r\n    </>\r\n  );\r\n}\r\n\r\nexport default ModalityLoadBadge;\r\n","export { default } from './ModalityLoadBadge';\r\n","import React, { useCallback, useState } from 'react';\r\nimport { ViewportActionArrows } from '@ohif/ui-next';\r\nimport { useSystem } from '@ohif/core/src';\r\nimport { utils } from '../..';\r\nimport { useViewportSegmentations } from '../../hooks';\r\nimport { useMeasurementTracking } from '../../hooks/useMeasurementTracking';\r\nimport { useViewportDisplaySets } from '../../hooks/useViewportDisplaySets';\r\n\r\n/**\r\n * NavigationComponent provides navigation controls for viewports containing\r\n * special displaySets (SR, SEG, RTSTRUCT) to navigate between segments or measurements\r\n */\r\nfunction NavigationComponent({ viewportId }: { viewportId: string }) {\r\n  const { servicesManager } = useSystem();\r\n  const { segmentationService, cornerstoneViewportService, measurementService } =\r\n    servicesManager.services;\r\n\r\n  // Get tracking information\r\n  const { isTracked, trackedMeasurementUIDs } = useMeasurementTracking({ viewportId });\r\n  const { viewportDisplaySets } = useViewportDisplaySets(viewportId);\r\n  const [measurementSelected, setMeasurementSelected] = useState(0);\r\n  const isSRDisplaySet = viewportDisplaySets.some(displaySet => displaySet?.Modality === 'SR');\r\n  const cornerstoneViewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n  // Get segmentation information\r\n  const { segmentationsWithRepresentations } = useViewportSegmentations({\r\n    viewportId,\r\n  });\r\n\r\n  const hasSegmentations = segmentationsWithRepresentations.length > 0;\r\n\r\n  // prefer segment navigation if available\r\n  const navigationMode = hasSegmentations\r\n    ? 'segment'\r\n    : isSRDisplaySet\r\n      ? 'measurement'\r\n      : isTracked\r\n        ? 'measurement'\r\n        : null;\r\n\r\n  const handleMeasurementNavigation = useCallback(\r\n    (direction: number) => {\r\n      const measurementDisplaySet = viewportDisplaySets.find(\r\n        displaySet => displaySet?.Modality === 'SR'\r\n      );\r\n\r\n      if (measurementDisplaySet) {\r\n        const measurements = measurementDisplaySet.measurements;\r\n        if (measurements.length <= 0) {\r\n          return;\r\n        }\r\n\r\n        const newIndex = getNextIndex(measurementSelected, direction, measurements.length);\r\n        setMeasurementSelected(newIndex);\r\n\r\n        const measurement = measurements[newIndex];\r\n        cornerstoneViewport.setViewReference({\r\n          referencedImageId: measurement.imageId,\r\n        });\r\n        return;\r\n      }\r\n\r\n      if (isTracked && trackedMeasurementUIDs.length > 0) {\r\n        const newIndex = getNextIndex(\r\n          measurementSelected,\r\n          direction,\r\n          trackedMeasurementUIDs.length\r\n        );\r\n        setMeasurementSelected(newIndex);\r\n        measurementService.jumpToMeasurement(viewportId, trackedMeasurementUIDs[newIndex]);\r\n      }\r\n    },\r\n    [\r\n      viewportId,\r\n      cornerstoneViewport,\r\n      measurementSelected,\r\n      measurementService,\r\n      isTracked,\r\n      trackedMeasurementUIDs,\r\n      viewportDisplaySets,\r\n    ]\r\n  );\r\n\r\n  const handleSegmentNavigation = useCallback(\r\n    (direction: number) => {\r\n      if (!segmentationsWithRepresentations.length) {\r\n        return;\r\n      }\r\n\r\n      const segmentationId = segmentationsWithRepresentations[0].segmentation.segmentationId;\r\n\r\n      utils.handleSegmentChange({\r\n        direction,\r\n        segmentationId,\r\n        viewportId,\r\n        selectedSegmentObjectIndex: 0,\r\n        segmentationService,\r\n      });\r\n    },\r\n    [segmentationsWithRepresentations, viewportId, segmentationService]\r\n  );\r\n\r\n  // Handle navigation between segments/measurements\r\n  const handleNavigate = useCallback(\r\n    (direction: number) => {\r\n      if (navigationMode === 'segment') {\r\n        handleSegmentNavigation(direction);\r\n      } else if (navigationMode === 'measurement') {\r\n        handleMeasurementNavigation(direction);\r\n      }\r\n    },\r\n    [navigationMode, handleSegmentNavigation, handleMeasurementNavigation]\r\n  );\r\n\r\n  // Only render if we have a navigation mode\r\n  if (!navigationMode) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <ViewportActionArrows\r\n      onArrowsClick={handleNavigate}\r\n      className=\"h-6\"\r\n    />\r\n  );\r\n}\r\n\r\n/**\r\n * Calculate the next index with circular navigation support\r\n * @param currentIndex Current index position\r\n * @param direction Direction of movement (1 for next, -1 for previous)\r\n * @param totalItems Total number of items to navigate through\r\n * @returns The next index with wrap-around support\r\n */\r\nfunction getNextIndex(currentIndex: number, direction: number, totalItems: number): number {\r\n  if (totalItems <= 0) {\r\n    return 0;\r\n  }\r\n\r\n  // Use modulo to handle circular navigation\r\n  let nextIndex = (currentIndex + direction) % totalItems;\r\n\r\n  // Handle negative index when going backwards from index 0\r\n  if (nextIndex < 0) {\r\n    nextIndex = totalItems - 1;\r\n  }\r\n\r\n  return nextIndex;\r\n}\r\n\r\nexport default NavigationComponent;\r\n","import React from 'react';\r\nimport { Numeric } from '@ohif/ui-next';\r\nimport { useViewportDisplaySets, useViewportRendering } from '../../hooks';\r\n\r\ninterface OpacityMenuProps {\r\n  viewportId: string;\r\n  className?: string;\r\n}\r\n\r\nfunction OpacityMenu({ viewportId, className }: OpacityMenuProps) {\r\n  const { backgroundDisplaySet, foregroundDisplaySets } = useViewportDisplaySets(viewportId, {\r\n    includeForeground: true,\r\n    includeBackground: true,\r\n  });\r\n  const { opacityLinear, setOpacityLinear } = useViewportRendering(viewportId, {\r\n    displaySetInstanceUID: foregroundDisplaySets[0].displaySetInstanceUID,\r\n  });\r\n\r\n  const opacityValue = opacityLinear !== undefined ? opacityLinear : 0;\r\n  const backgroundModality = backgroundDisplaySet?.Modality || '';\r\n  const foregroundModality = foregroundDisplaySets[0]?.Modality || '';\r\n\r\n  return (\r\n    <div className={className}>\r\n      <div className=\"bg-popover w-72 rounded-lg p-3\">\r\n        <div className=\"mb-2 flex items-center justify-center\">\r\n          <span className=\"text-muted-foreground text-base\">Opacity</span>\r\n        </div>\r\n        <div className=\"\">\r\n          <Numeric.Container\r\n            mode=\"singleRange\"\r\n            value={opacityValue}\r\n            onChange={(val: number | [number, number]) => {\r\n              if (typeof val === 'number') {\r\n                setOpacityLinear(val);\r\n              }\r\n            }}\r\n            min={0}\r\n            max={1}\r\n            step={0.0001}\r\n          >\r\n            <div className=\"flex items-center\">\r\n              <span className=\"text-foreground mr-2 text-sm\">{backgroundModality}</span>\r\n              <Numeric.SingleRange showNumberInput={false} />\r\n              <span className=\"text-foreground ml-2 text-sm\">{foregroundModality}</span>\r\n            </div>\r\n          </Numeric.Container>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default OpacityMenu;\r\n","import React, { ReactNode } from 'react';\r\nimport { useSystem } from '@ohif/core';\r\nimport {\r\n  Button,\r\n  Icons,\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverTrigger,\r\n  useIconPresentation,\r\n} from '@ohif/ui-next';\r\nimport OpacityMenu from './OpacityMenu';\r\n\r\ntype OpacityMenuWrapperProps = {\r\n  viewportId: string;\r\n  location: string;\r\n  isOpen?: boolean;\r\n  onOpen?: () => void;\r\n  onClose?: () => void;\r\n  disabled?: boolean;\r\n};\r\n\r\nexport function OpacityMenuWrapper(props: OpacityMenuWrapperProps): ReactNode {\r\n  const { viewportId, location, isOpen = false, onOpen, onClose, disabled, ...rest } = props;\r\n  const { IconContainer, className: iconClassName, containerProps } = useIconPresentation();\r\n\r\n  const handleOpenChange = (openState: boolean) => {\r\n    if (openState) {\r\n      onOpen?.();\r\n    } else {\r\n      onClose?.();\r\n    }\r\n  };\r\n\r\n  const { servicesManager } = useSystem();\r\n  const { toolbarService } = servicesManager.services;\r\n\r\n  const { align, side } = toolbarService.getAlignAndSide(location);\r\n\r\n  const Icon = <Icons.Opacity className={iconClassName} />;\r\n\r\n  return (\r\n    <Popover\r\n      open={isOpen}\r\n      onOpenChange={handleOpenChange}\r\n    >\r\n      <PopoverTrigger\r\n        asChild\r\n        className=\"flex items-center justify-center\"\r\n      >\r\n        <div>\r\n          {IconContainer ? (\r\n            <IconContainer\r\n              disabled={disabled}\r\n              icon=\"Opacity\"\r\n              {...rest}\r\n              {...containerProps}\r\n            >\r\n              {Icon}\r\n            </IconContainer>\r\n          ) : (\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              disabled={disabled}\r\n            >\r\n              {Icon}\r\n            </Button>\r\n          )}\r\n        </div>\r\n      </PopoverTrigger>\r\n      <PopoverContent\r\n        className=\"border-none bg-transparent p-0 shadow-none\"\r\n        side={side}\r\n        align={align}\r\n        alignOffset={0}\r\n        sideOffset={5}\r\n      >\r\n        <OpacityMenu\r\n          className=\"w-full\"\r\n          viewportId={viewportId}\r\n        />\r\n      </PopoverContent>\r\n    </Popover>\r\n  );\r\n}","import React from 'react';\r\nimport { AccordionTrigger, ColorCircle } from '@ohif/ui-next';\r\nimport { ChevronDownIcon } from '@radix-ui/react-icons';\r\n\r\nfunction onClickDefault(e) {\r\n  const { group, onClick = group?.onClick } = this;\r\n  if (!onClick) {\r\n    console.log('No onClick function', group);\r\n    return;\r\n  }\r\n  console.log('onClickDefault');\r\n  e.preventDefault();\r\n  e.stopPropagation();\r\n\r\n  onClick(e, group);\r\n\r\n  return false;\r\n}\r\n\r\nexport default function PanelAccordionTrigger(props) {\r\n  const { marginLeft = 8, isActive = false, colorHex, count, text, menu: Menu = null } = props;\r\n\r\n  return (\r\n    <AccordionTrigger\r\n      style={{ marginLeft: `${marginLeft}px`, padding: 0 }}\r\n      asChild={true}\r\n    >\r\n      <div className={`inline-flex text-base ${isActive ? 'bg-popover' : 'bg-muted'} flex-grow`}>\r\n        <button onClick={onClickDefault.bind(props)}>\r\n          <span\r\n            className={`inline-flex rounded-l border-r border-black ${isActive ? 'bg-highlight' : 'bg-muted'}`}\r\n          >\r\n            {count !== undefined ? <span className=\"px-2\">{count}</span> : null}\r\n            {colorHex && <ColorCircle colorHex={colorHex} />}\r\n          </span>\r\n          <span>{text}</span>\r\n        </button>\r\n        {Menu && (\r\n          <Menu\r\n            {...props}\r\n            classNames=\"justify-end flex-grow\"\r\n          />\r\n        )}\r\n        <ChevronDownIcon className=\"text-primary h-4 w-4 shrink-0 transition-transform duration-200\" />\r\n      </div>\r\n    </AccordionTrigger>\r\n  );\r\n}\r\n","import React from 'react';\r\n\r\n// should be used in a Select component\r\nconst SelectItemWithModality = ({\r\n  displaySet,\r\n  showModality = true,\r\n}: {\r\n  displaySet: AppTypes.DisplaySet;\r\n  showModality?: boolean;\r\n}): JSX.Element => (\r\n  <div className=\"flex w-[90%] items-center justify-between\">\r\n    <span className=\"text-foreground truncate text-base\">{displaySet.label}</span>\r\n    {showModality && displaySet.Modality && (\r\n      <span className=\"text-muted-foreground flex-shrink-0 whitespace-nowrap text-xs\">\r\n        {displaySet.Modality}\r\n      </span>\r\n    )}\r\n  </div>\r\n);\r\n\r\nexport default SelectItemWithModality;\r\n","import React from 'react';\r\nimport { useActiveViewportDisplaySets, useSystem } from '@ohif/core';\r\n\r\nimport AccordionGroup from './AccordionGroup';\r\nimport PanelAccordionTrigger from './PanelAccordionTrigger';\r\nimport MeasurementItems from './MeasurementItems';\r\nimport MeasurementsMenu from './MeasurementsMenu';\r\n\r\n/**\r\n * Groups measurements by study in order to allow display and saving by study\r\n * @param {Object} servicesManager\r\n */\r\nexport const groupByDisplaySet = (items, grouping, childProps) => {\r\n  const groups = new Map();\r\n  const { displaySetService } = childProps.servicesManager.services;\r\n  const { activeDisplaySetInstanceUID } = grouping;\r\n\r\n  items.forEach(item => {\r\n    const { displaySetInstanceUID } = item;\r\n\r\n    if (!groups.has(displaySetInstanceUID)) {\r\n      const displaySet = displaySetService.getDisplaySetByUID(displaySetInstanceUID);\r\n      groups.set(displaySetInstanceUID, {\r\n        header: null,\r\n        isSelected: displaySetInstanceUID == activeDisplaySetInstanceUID,\r\n        ...grouping,\r\n        items: [],\r\n        key: displaySetInstanceUID,\r\n        title: 'Series Measurements',\r\n        displaySet,\r\n      });\r\n    }\r\n    groups.get(displaySetInstanceUID).items.push(item);\r\n  });\r\n\r\n  return groups;\r\n};\r\n\r\nexport function SeriesMeasurementTrigger(props) {\r\n  const { group, isSelected, displaySet, menu } = props;\r\n  const { SeriesNumber = 1, SeriesDescription } = displaySet;\r\n\r\n  return (\r\n    <PanelAccordionTrigger\r\n      text={`Series #${SeriesNumber} ${SeriesDescription}`}\r\n      count={group.items.length}\r\n      isActive={isSelected}\r\n      group={group}\r\n      menu={menu}\r\n      marginLeft=\"0\"\r\n    />\r\n  );\r\n}\r\n\r\nexport function SeriesMeasurements(props): React.ReactNode {\r\n  const { items, grouping = {}, children } = props;\r\n  const system = useSystem();\r\n  const activeDisplaySets = useActiveViewportDisplaySets(system);\r\n  const activeDisplaySetInstanceUID = activeDisplaySets?.[0]?.displaySetInstanceUID;\r\n  const onClick = (_e, group) => {\r\n    const { items } = group;\r\n    system.commandsManager.run('jumpToMeasurement', {\r\n      uid: items[0].uid,\r\n      displayMeasurements: items,\r\n      group,\r\n    });\r\n  };\r\n\r\n  // The content of the accordion group will default to the children of the\r\n  // parent declaration if present, otherwise to MeasurementItems\r\n  return (\r\n    <AccordionGroup\r\n      grouping={{\r\n        groupingFunction: groupByDisplaySet,\r\n        activeDisplaySetInstanceUID,\r\n        ...grouping,\r\n        onClick,\r\n      }}\r\n      items={items}\r\n      sourceChildren={children}\r\n    >\r\n      <AccordionGroup.Trigger asChild={true}>\r\n        <SeriesMeasurementTrigger menu={MeasurementsMenu} />\r\n      </AccordionGroup.Trigger>\r\n      <MeasurementItems />\r\n    </AccordionGroup>\r\n  );\r\n}\r\n\r\nexport default SeriesMeasurements;\r\n","import React from 'react';\r\nimport { useActiveViewportDisplaySets, useSystem, utils } from '@ohif/core';\r\n// import { AccordionContent, AccordionItem, AccordionTrigger } from '@ohif/ui-next';\r\n\r\nimport { AccordionGroup } from './AccordionGroup';\r\nimport MeasurementsOrAdditionalFindings from './MeasurementsOrAdditionalFindings';\r\nimport StudySummaryWithActions from './StudySummaryWithActions';\r\n\r\nconst { MeasurementFilters } = utils;\r\n\r\n/**\r\n * Groups measurements by study in order to allow display and saving by study\r\n * @param {Object} servicesManager\r\n */\r\nexport const groupByStudy = (items, grouping, childProps) => {\r\n  const groups = new Map();\r\n  const { activeStudyUID } = grouping;\r\n  const { displaySetService } = childProps.servicesManager.services;\r\n\r\n  const getItemStudyInstanceUID = item => {\r\n    const displaySet = displaySetService.getDisplaySetByUID(item.displaySetInstanceUID);\r\n    return displaySet.instances[0].StudyInstanceUID;\r\n  };\r\n\r\n  let firstSelected, firstGroup;\r\n\r\n  items.forEach(item => {\r\n    const studyUID = getItemStudyInstanceUID(item);\r\n    if (!groups.has(studyUID)) {\r\n      const items = [];\r\n      const filter = MeasurementFilters.filterAnd(\r\n        MeasurementFilters.filterMeasurementsByStudyUID(activeStudyUID),\r\n        grouping.filter\r\n      );\r\n      const group = {\r\n        ...grouping,\r\n        items,\r\n        displayMeasurements: items,\r\n        key: studyUID,\r\n        isSelected: studyUID === activeStudyUID,\r\n        StudyInstanceUID: activeStudyUID,\r\n        filter,\r\n        measurementFilter: filter,\r\n      };\r\n      if (group.isSelected && !firstSelected) {\r\n        firstSelected = group;\r\n      }\r\n      firstGroup ||= group;\r\n      groups.set(studyUID, group);\r\n    }\r\n    if (!firstSelected && firstGroup) {\r\n      firstGroup.isSelected = true;\r\n    }\r\n    const group = groups.get(studyUID);\r\n    group.items.push(item);\r\n  });\r\n\r\n  return groups;\r\n};\r\n\r\nexport function StudyMeasurements(props): React.ReactNode {\r\n  const { items, grouping = {}, children } = props;\r\n\r\n  const system = useSystem();\r\n  const activeDisplaySets = useActiveViewportDisplaySets(system);\r\n  const activeStudyUID = activeDisplaySets?.[0]?.StudyInstanceUID;\r\n\r\n  return (\r\n    <AccordionGroup\r\n      grouping={{\r\n        name: 'groupByStudy',\r\n        groupingFunction: groupByStudy,\r\n        activeStudyUID,\r\n        ...grouping,\r\n      }}\r\n      items={items}\r\n      value={[activeStudyUID]}\r\n      sourceChildren={children}\r\n    >\r\n      <AccordionGroup.Trigger>\r\n        <StudySummaryWithActions />\r\n      </AccordionGroup.Trigger>\r\n      <MeasurementsOrAdditionalFindings activeStudyUID={activeStudyUID} />\r\n    </AccordionGroup>\r\n  );\r\n}\r\n\r\nexport default StudyMeasurements;\r\n","import React from 'react';\r\nimport { Button, Icons } from '@ohif/ui-next';\r\nimport { useSystem } from '@ohif/core';\r\n\r\nexport function StudyMeasurementsActions({ items, StudyInstanceUID, measurementFilter, actions }) {\r\n  const { commandsManager } = useSystem();\r\n  const disabled = !items?.length;\r\n\r\n  if (disabled) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-background flex h-9 w-full items-center rounded pr-0.5\">\r\n      <div className=\"flex space-x-1\">\r\n        <Button\r\n          size=\"sm\"\r\n          variant=\"ghost\"\r\n          className=\"pl-1.5\"\r\n          onClick={() => {\r\n            commandsManager.runCommand('downloadCSVMeasurementsReport', {\r\n              StudyInstanceUID,\r\n              measurementFilter,\r\n            });\r\n          }}\r\n        >\r\n          <Icons.Download className=\"h-5 w-5\" />\r\n          <span className=\"pl-1\">CSV</span>\r\n        </Button>\r\n\r\n        <Button\r\n          size=\"sm\"\r\n          variant=\"ghost\"\r\n          className=\"pl-0.5\"\r\n          onClick={e => {\r\n            e.stopPropagation();\r\n            if (actions?.createSR) {\r\n              actions.createSR({ StudyInstanceUID, measurementFilter });\r\n              return;\r\n            }\r\n            commandsManager.run('promptSaveReport', {\r\n              StudyInstanceUID,\r\n              measurementFilter,\r\n            });\r\n          }}\r\n        >\r\n          <Icons.Add />\r\n          Create SR\r\n        </Button>\r\n        <Button\r\n          size=\"sm\"\r\n          variant=\"ghost\"\r\n          className=\"pl-0.5\"\r\n          onClick={e => {\r\n            e.stopPropagation();\r\n            if (actions?.onDelete) {\r\n              actions.onDelete();\r\n              return;\r\n            }\r\n            commandsManager.runCommand('clearMeasurements', {\r\n              measurementFilter,\r\n            });\r\n          }}\r\n        >\r\n          <Icons.Delete />\r\n          Delete\r\n        </Button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default StudyMeasurementsActions;\r\n","import React from 'react';\r\nimport { DicomMetadataStore, utils } from '@ohif/core';\r\nimport { StudySummary } from '@ohif/ui-next';\r\n\r\nconst { formatDate } = utils;\r\n\r\nexport function StudySummaryFromMetadata(props) {\r\n  const { StudyInstanceUID } = props;\r\n  if (!StudyInstanceUID) {\r\n    return null;\r\n  }\r\n  const studyMeta = DicomMetadataStore.getStudy(StudyInstanceUID);\r\n  if (!studyMeta?.series?.length) {\r\n    return null;\r\n  }\r\n\r\n  const instanceMeta = studyMeta.series[0].instances[0];\r\n  const { StudyDate, StudyDescription } = instanceMeta;\r\n\r\n  return (\r\n    <StudySummary\r\n      date={formatDate(StudyDate)}\r\n      description={StudyDescription}\r\n    />\r\n  );\r\n}\r\n","import React from 'react';\r\nimport { StudySummaryFromMetadata } from './StudySummaryFromMetadata';\r\nimport StudyMeasurementsActions from './StudyMeasurementsActions';\r\n\r\nexport function StudySummaryWithActions(props) {\r\n  return (\r\n    <div>\r\n      <StudySummaryFromMetadata {...props} />\r\n      <StudyMeasurementsActions {...props} />\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default StudySummaryWithActions;\r\n","import React, { useState, useEffect } from 'react';\r\nimport {\r\n  Numeric,\r\n  Select,\r\n  SelectTrigger,\r\n  SelectValue,\r\n  SelectContent,\r\n  SelectItem,\r\n  Button,\r\n} from '@ohif/ui-next';\r\nimport { useViewportRendering } from '../../hooks';\r\nimport { useViewportDisplaySets } from '../../hooks/useViewportDisplaySets';\r\nimport SelectItemWithModality from '../SelectItemWithModality';\r\n\r\ninterface ThresholdMenuProps {\r\n  viewportId: string;\r\n  className?: string;\r\n}\r\n\r\nfunction ThresholdMenu({ viewportId, className }: ThresholdMenuProps) {\r\n  const { viewportDisplaySets, foregroundDisplaySets } = useViewportDisplaySets(viewportId);\r\n  const [selectedDisplaySetUID, setSelectedDisplaySetUID] = useState<string | undefined>(\r\n    foregroundDisplaySets.length > 0 ? foregroundDisplaySets[0].displaySetInstanceUID : undefined\r\n  );\r\n\r\n  const { threshold, setThreshold, pixelValueRange } = useViewportRendering(viewportId, {\r\n    displaySetInstanceUID: selectedDisplaySetUID,\r\n  });\r\n\r\n  const { min, max } = pixelValueRange;\r\n  const thresholdValue = threshold ?? min;\r\n\r\n  useEffect(() => {\r\n    if (foregroundDisplaySets.length > 0 && !selectedDisplaySetUID) {\r\n      setSelectedDisplaySetUID(foregroundDisplaySets[0].displaySetInstanceUID);\r\n    }\r\n  }, [foregroundDisplaySets, selectedDisplaySetUID]);\r\n\r\n  const selectedDisplaySet = viewportDisplaySets.find(\r\n    ds => ds.displaySetInstanceUID === selectedDisplaySetUID\r\n  );\r\n\r\n  return (\r\n    <div className={className}>\r\n      <div className=\"bg-popover w-72 rounded-lg p-4 shadow-md\">\r\n        <div className=\"mb-4 flex items-center justify-between\">\r\n          <div className=\"flex items-center space-x-2\">\r\n            <span className=\"text-muted-foreground text-base\">Threshold</span>\r\n            {viewportDisplaySets.length > 1 && (\r\n              <div className=\"w-32\">\r\n                <Select\r\n                  value={selectedDisplaySetUID}\r\n                  onValueChange={setSelectedDisplaySetUID}\r\n                >\r\n                  <SelectTrigger>\r\n                    <SelectValue>{selectedDisplaySet?.label || 'Select Display Set'}</SelectValue>\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {viewportDisplaySets.map(ds => (\r\n                      <SelectItem\r\n                        key={ds.displaySetInstanceUID}\r\n                        value={ds.displaySetInstanceUID}\r\n                      >\r\n                        <SelectItemWithModality displaySet={ds} />\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            )}\r\n          </div>\r\n          <Button\r\n            size=\"sm\"\r\n            variant=\"ghost\"\r\n            onClick={() => setThreshold(min)}\r\n            className=\"text-sm\"\r\n          >\r\n            Reset\r\n          </Button>\r\n        </div>\r\n        <Numeric.Container\r\n          mode=\"singleRange\"\r\n          value={thresholdValue}\r\n          onChange={(val: number | [number, number]) => {\r\n            if (typeof val === 'number') {\r\n              setThreshold(val);\r\n            }\r\n          }}\r\n          min={min}\r\n          max={max}\r\n          step={0.01}\r\n        >\r\n          <Numeric.SingleRange />\r\n          <div className=\"mt-1 flex justify-between\">\r\n            <span className=\"text-muted-foreground text-sm\">{min.toFixed(0)}</span>\r\n            <span className=\"text-muted-foreground text-sm\">{max.toFixed(0)}</span>\r\n          </div>\r\n        </Numeric.Container>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default ThresholdMenu;\r\n","import React, { ReactNode } from 'react';\r\nimport { useSystem } from '@ohif/core';\r\nimport {\r\n  Button,\r\n  Icons,\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverTrigger,\r\n  useIconPresentation,\r\n} from '@ohif/ui-next';\r\nimport ThresholdMenu from './ThresholdMenu';\r\n\r\ntype ThresholdMenuWrapperProps = {\r\n  viewportId: string;\r\n  location: string;\r\n  isOpen?: boolean;\r\n  onOpen?: () => void;\r\n  onClose?: () => void;\r\n  disabled?: boolean;\r\n};\r\n\r\nexport function ThresholdMenuWrapper(props: ThresholdMenuWrapperProps): ReactNode {\r\n  const { viewportId, location, isOpen = false, onOpen, onClose, disabled, ...rest } = props;\r\n  const { IconContainer, className: iconClassName, containerProps } = useIconPresentation();\r\n\r\n  const handleOpenChange = (openState: boolean) => {\r\n    if (openState) {\r\n      onOpen?.();\r\n    } else {\r\n      onClose?.();\r\n    }\r\n  };\r\n\r\n  const { servicesManager } = useSystem();\r\n  const { toolbarService } = servicesManager.services;\r\n\r\n  const { align, side } = toolbarService.getAlignAndSide(location);\r\n\r\n  const Icon = <Icons.Threshold className={iconClassName} />;\r\n\r\n  return (\r\n    <Popover\r\n      open={isOpen}\r\n      onOpenChange={handleOpenChange}\r\n    >\r\n      <PopoverTrigger\r\n        asChild\r\n        className=\"flex items-center justify-center\"\r\n      >\r\n        <div>\r\n          {IconContainer ? (\r\n            <IconContainer\r\n              disabled={disabled}\r\n              icon=\"Threshold\"\r\n              {...rest}\r\n              {...containerProps}\r\n            >\r\n              {Icon}\r\n            </IconContainer>\r\n          ) : (\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              disabled={disabled}\r\n            >\r\n              {Icon}\r\n            </Button>\r\n          )}\r\n        </div>\r\n      </PopoverTrigger>\r\n      <PopoverContent\r\n        className=\"border-none bg-transparent p-0 shadow-none\"\r\n        side={side}\r\n        align={align}\r\n        alignOffset={0}\r\n        sideOffset={5}\r\n      >\r\n        <ThresholdMenu\r\n          className=\"w-full\"\r\n          viewportId={viewportId}\r\n        />\r\n      </PopoverContent>\r\n    </Popover>\r\n  );\r\n}","import React from 'react';\r\nimport { Icons, Tooltip, TooltipTrigger, TooltipContent } from '@ohif/ui-next';\r\nimport { useMeasurementTracking } from '../../hooks/useMeasurementTracking';\r\n\r\n/**\r\n * TrackingStatus displays an indicator icon for viewports that have\r\n * tracked measurements\r\n */\r\nfunction TrackingStatus({ viewportId }: { viewportId: string }) {\r\n  const { isTracked } = useMeasurementTracking({ viewportId });\r\n\r\n  if (!isTracked) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <Tooltip>\r\n        <TooltipTrigger asChild>\r\n          <span>\r\n            <Icons.StatusTracking className=\"h-4 w-4\" />\r\n          </span>\r\n        </TooltipTrigger>\r\n        <TooltipContent side=\"bottom\">\r\n          <div>Tracking</div>\r\n        </TooltipContent>\r\n      </Tooltip>\r\n    </>\r\n  );\r\n}\r\n\r\nexport default TrackingStatus;\r\n","import React, { useState, useEffect } from 'react';\r\nimport {\r\n  Tabs,\r\n  TabsList,\r\n  TabsTrigger,\r\n  TabsContent,\r\n  Numeric,\r\n  Select,\r\n  SelectTrigger,\r\n  SelectValue,\r\n  SelectContent,\r\n  SelectItem,\r\n} from '@ohif/ui-next';\r\nimport { useViewportDisplaySets } from '../../hooks/useViewportDisplaySets';\r\nimport { useViewportRendering } from '../../hooks/useViewportRendering';\r\nimport { useSystem } from '@ohif/core';\r\nimport { cache } from '@cornerstonejs/core';\r\n\r\ninterface VOIManualControlMenuProps {\r\n  viewportId: string;\r\n  className?: string;\r\n}\r\n\r\nconst TABS = {\r\n  MINMAX: 'minmax',\r\n  MANUAL: 'manual',\r\n};\r\n\r\nfunction VOIManualControlMenu({ viewportId, className }: VOIManualControlMenuProps) {\r\n  const { servicesManager } = useSystem();\r\n  const { displaySetService } = servicesManager.services;\r\n  const [activeTab, setActiveTab] = useState(TABS.MINMAX);\r\n  const { viewportDisplaySets } = useViewportDisplaySets(viewportId);\r\n  const [selectedDisplaySetUID, setSelectedDisplaySetUID] = useState<string | undefined>(\r\n    viewportDisplaySets.length > 0 ? viewportDisplaySets[0].displaySetInstanceUID : undefined\r\n  );\r\n\r\n  const { voiRange, setVOIRange, windowLevel, setWindowLevel } = useViewportRendering(viewportId, {\r\n    displaySetInstanceUID: selectedDisplaySetUID,\r\n  });\r\n\r\n  useEffect(() => {\r\n    if (viewportDisplaySets.length > 0 && !selectedDisplaySetUID) {\r\n      setSelectedDisplaySetUID(viewportDisplaySets[0].displaySetInstanceUID);\r\n    }\r\n  }, [viewportDisplaySets, selectedDisplaySetUID]);\r\n\r\n  if (!voiRange) {\r\n    return null;\r\n  }\r\n\r\n  const { upper, lower } = voiRange;\r\n  const { windowWidth, windowCenter } = windowLevel;\r\n\r\n  const selectedViewportImageIds =\r\n    displaySetService.getDisplaySetByUID(selectedDisplaySetUID)?.imageIds;\r\n\r\n  let min = Infinity;\r\n  let max = -Infinity;\r\n\r\n  if (selectedViewportImageIds) {\r\n    for (const imageId of selectedViewportImageIds) {\r\n      const image = cache.getImage(imageId);\r\n      if (image) {\r\n        min = Math.min(min, image.minPixelValue);\r\n        max = Math.max(max, image.maxPixelValue);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Provide reasonable defaults if min/max couldn't be determined\r\n  if (min === Infinity || max === -Infinity) {\r\n    min = 0;\r\n    max = 255;\r\n  }\r\n\r\n  const selectedDisplaySet = viewportDisplaySets.find(\r\n    ds => ds.displaySetInstanceUID === selectedDisplaySetUID\r\n  );\r\n\r\n  return (\r\n    <div className={className}>\r\n      <div className=\"bg-popover w-72 rounded-lg p-4 shadow-md\">\r\n        <Tabs\r\n          defaultValue={activeTab}\r\n          onValueChange={setActiveTab}\r\n        >\r\n          <div className=\"mb-4 flex items-center space-x-2\">\r\n            {viewportDisplaySets.length > 1 && (\r\n              <Select\r\n                value={selectedDisplaySetUID}\r\n                onValueChange={setSelectedDisplaySetUID}\r\n              >\r\n                <SelectTrigger>\r\n                  <SelectValue>{selectedDisplaySet?.label || 'Select Display Set'}</SelectValue>\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {viewportDisplaySets.map(ds => (\r\n                    <SelectItem\r\n                      key={ds.displaySetInstanceUID}\r\n                      value={ds.displaySetInstanceUID}\r\n                    >\r\n                      {`${ds.SeriesDescription || ''}`.trim()}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            )}\r\n            <TabsList className=\"w-full flex-1\">\r\n              <TabsTrigger\r\n                value={TABS.MINMAX}\r\n                className=\"flex-1\"\r\n              >\r\n                Min/Max\r\n              </TabsTrigger>\r\n              <TabsTrigger\r\n                value={TABS.MANUAL}\r\n                className=\"flex-1\"\r\n              >\r\n                Manual\r\n              </TabsTrigger>\r\n            </TabsList>\r\n          </div>\r\n\r\n          <TabsContent value={TABS.MINMAX}>\r\n            <Numeric.Container\r\n              mode=\"doubleRange\"\r\n              min={min}\r\n              max={max}\r\n              values={[lower, upper]}\r\n              step={1}\r\n              className=\"space-y-1\"\r\n              onChange={(vals: [number, number]) => {\r\n                const [newLower, newUpper] = vals;\r\n                if (newLower !== lower || newUpper !== upper) {\r\n                  setVOIRange({ lower: newLower, upper: newUpper });\r\n                }\r\n              }}\r\n            >\r\n              <Numeric.DoubleRange showNumberInputs />\r\n            </Numeric.Container>\r\n          </TabsContent>\r\n          <TabsContent value={TABS.MANUAL}>\r\n            <div className=\"space-y-1\">\r\n              <Numeric.Container\r\n                mode=\"singleRange\"\r\n                min={0}\r\n                max={max}\r\n                step={1}\r\n                value={windowWidth}\r\n                className=\"space-y-1\"\r\n                onChange={(val: number) => {\r\n                  if (val !== windowWidth) {\r\n                    setWindowLevel({ windowWidth: val, windowCenter });\r\n                  }\r\n                }}\r\n              >\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <Numeric.Label>W:</Numeric.Label>\r\n                  <Numeric.SingleRange showNumberInput />\r\n                </div>\r\n              </Numeric.Container>\r\n\r\n              <Numeric.Container\r\n                mode=\"singleRange\"\r\n                min={min}\r\n                max={max}\r\n                step={1}\r\n                value={windowCenter}\r\n                className=\"space-y-1\"\r\n                onChange={(val: number) => {\r\n                  if (val !== windowCenter) {\r\n                    setWindowLevel({ windowWidth, windowCenter: val });\r\n                  }\r\n                }}\r\n              >\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <Numeric.Label>L:</Numeric.Label>\r\n                  <Numeric.SingleRange showNumberInput />\r\n                </div>\r\n              </Numeric.Container>\r\n            </div>\r\n          </TabsContent>\r\n        </Tabs>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default VOIManualControlMenu;\r\n","import React, { ReactNode } from 'react';\r\nimport { useSystem } from '@ohif/core';\r\nimport {\r\n  Button,\r\n  Icons,\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverTrigger,\r\n  useIconPresentation,\r\n} from '@ohif/ui-next';\r\nimport VOIManualControlMenu from './VOIManualControlMenu';\r\n\r\ntype VOIManualControlMenuWrapperProps = {\r\n  viewportId: string;\r\n  location: string;\r\n  isOpen?: boolean;\r\n  onOpen?: () => void;\r\n  onClose?: () => void;\r\n  disabled?: boolean;\r\n};\r\n\r\nexport function VOIManualControlMenuWrapper(props: VOIManualControlMenuWrapperProps): ReactNode {\r\n  const { viewportId, location, isOpen = false, onOpen, onClose, disabled, ...rest } = props;\r\n  const { IconContainer, className: iconClassName, containerProps } = useIconPresentation();\r\n\r\n  const handleOpenChange = (openState: boolean) => {\r\n    if (openState) {\r\n      onOpen?.();\r\n    } else {\r\n      onClose?.();\r\n    }\r\n  };\r\n\r\n  const { servicesManager } = useSystem();\r\n  const { toolbarService } = servicesManager.services;\r\n\r\n  const { align, side } = toolbarService.getAlignAndSide(location);\r\n\r\n  const Icon = <Icons.WindowLevelAdvanced className={iconClassName} />;\r\n\r\n  return (\r\n    <Popover\r\n      open={isOpen}\r\n      onOpenChange={handleOpenChange}\r\n    >\r\n      <PopoverTrigger\r\n        asChild\r\n        className=\"flex items-center justify-center\"\r\n      >\r\n        <div>\r\n          {IconContainer ? (\r\n            <IconContainer\r\n              disabled={disabled}\r\n              icon=\"WindowLevelAdvanced\"\r\n              {...rest}\r\n              {...containerProps}\r\n            >\r\n              {Icon}\r\n            </IconContainer>\r\n          ) : (\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              disabled={disabled}\r\n            >\r\n              {Icon}\r\n            </Button>\r\n          )}\r\n        </div>\r\n      </PopoverTrigger>\r\n      <PopoverContent\r\n        className=\"border-none bg-transparent p-0 shadow-none\"\r\n        side={side}\r\n        align={align}\r\n        alignOffset={0}\r\n        sideOffset={5}\r\n      >\r\n        <VOIManualControlMenu\r\n          className=\"w-full\"\r\n          viewportId={viewportId}\r\n        />\r\n      </PopoverContent>\r\n    </Popover>\r\n  );\r\n}\r\n","export { VOIManualControlMenuWrapper } from './VOIManualControlMenuWrapper';\r\nexport { default as VOIManualControlMenu } from './VOIManualControlMenu';\r\n","import React, { useEffect, useRef, useMemo, memo } from 'react';\r\nimport { utilities } from '@cornerstonejs/tools';\r\nimport { useSystem, useViewportRef, useViewportSize } from '@ohif/core';\r\nimport {\r\n  ColorbarPositionType,\r\n  TickPositionType,\r\n  ColorbarCustomization,\r\n  TickStyleType,\r\n  ContainerStyleType,\r\n} from '../../types/Colorbar';\r\nimport { ColorbarRangeTextPosition } from '@cornerstonejs/tools/utilities/voi/colorbar/enums/ColorbarRangeTextPosition';\r\n\r\nconst { ViewportColorbar: CornerstoneViewportColorbar } = utilities.voi.colorbar;\r\n\r\ntype ColorbarProps = {\r\n  viewportId: string;\r\n  displaySetInstanceUID: string;\r\n  colormap?: any;\r\n  colormaps: any[];\r\n  activeColormapName: string;\r\n  volumeId?: string;\r\n  position: ColorbarPositionType;\r\n  tickPosition: TickPositionType;\r\n  tickStyles?: TickStyleType;\r\n  containerStyles?: ContainerStyleType;\r\n  viewportElementRef?: React.RefObject<HTMLDivElement>;\r\n  numColorbars: number;\r\n};\r\n\r\n/**\r\n * ViewportColorbar Component\r\n * A React wrapper for the cornerstone ViewportColorbar that adds a close button\r\n * positioned appropriately based on the colorbar position.\r\n */\r\nconst ViewportColorbar = memo(function ViewportColorbar({\r\n  viewportId,\r\n  displaySetInstanceUID,\r\n  colormaps,\r\n  activeColormapName,\r\n  volumeId,\r\n  position,\r\n  tickPosition,\r\n  tickStyles,\r\n  numColorbars,\r\n}: ColorbarProps) {\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  const { servicesManager } = useSystem();\r\n  const { customizationService } = servicesManager.services;\r\n  const viewportElementRef = useViewportRef(viewportId);\r\n  const { height, width } = useViewportSize(viewportId);\r\n\r\n  // Memoize colorbar customization to prevent rerenders from unrelated customization changes\r\n  const colorbarCustomization = useMemo(() => {\r\n    return customizationService.getCustomization(\r\n      'cornerstone.colorbar'\r\n    ) as unknown as ColorbarCustomization;\r\n  }, [customizationService]);\r\n\r\n  const appropriateTickPosition = useMemo(() => {\r\n    let tickPos = tickPosition;\r\n    if (position === 'left' || position === 'right') {\r\n      tickPos = position === 'left' ? 'right' : 'left';\r\n    } else {\r\n      tickPos = position === 'top' ? 'bottom' : 'top';\r\n    }\r\n    return tickPos;\r\n  }, [position, tickPosition]);\r\n\r\n  const positionTickStyles = useMemo(() => {\r\n    return colorbarCustomization?.positionTickStyles?.[position];\r\n  }, [colorbarCustomization, position]);\r\n\r\n  const positionStylesFromConfig = useMemo(() => {\r\n    return colorbarCustomization?.positionStyles?.[position] || {};\r\n  }, [colorbarCustomization, position]);\r\n\r\n  const mergedTickStyles = useMemo(() => {\r\n    return {\r\n      ...(colorbarCustomization?.tickStyles || {}),\r\n      ...(positionTickStyles?.style || {}),\r\n      ...(tickStyles || {}),\r\n    };\r\n  }, [colorbarCustomization, positionTickStyles, tickStyles]);\r\n\r\n  const colorbarId = useMemo(() => {\r\n    return `Colorbar-${viewportId}-${displaySetInstanceUID}`;\r\n  }, [viewportId, displaySetInstanceUID]);\r\n\r\n  useEffect(() => {\r\n    if (!containerRef.current || !colormaps || !activeColormapName) {\r\n      return;\r\n    }\r\n\r\n    const viewportElement = viewportElementRef?.current;\r\n\r\n    if (!viewportElement || !colormaps?.length) {\r\n      return;\r\n    }\r\n\r\n    // Using stable references from memoized values\r\n    const csColorbar = new CornerstoneViewportColorbar({\r\n      id: colorbarId,\r\n      element: viewportElement,\r\n      container: containerRef.current,\r\n      colormaps: colormaps,\r\n      activeColormapName: activeColormapName,\r\n      volumeId,\r\n      ticks: {\r\n        position: appropriateTickPosition as ColorbarRangeTextPosition,\r\n        style: mergedTickStyles,\r\n      },\r\n    });\r\n\r\n    return () => {\r\n      if (csColorbar) {\r\n        csColorbar.destroy();\r\n      }\r\n    };\r\n  }, [\r\n    viewportId,\r\n    displaySetInstanceUID,\r\n    colormaps,\r\n    activeColormapName,\r\n    volumeId,\r\n    colorbarId,\r\n    appropriateTickPosition,\r\n    mergedTickStyles,\r\n    viewportElementRef,\r\n  ]);\r\n\r\n  if (!height || !width) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div\r\n      id={`colorbar-container-${viewportId}-${displaySetInstanceUID}`}\r\n      ref={containerRef}\r\n      style={{\r\n        position: 'relative',\r\n        zIndex: 1000,\r\n        boxSizing: 'border-box',\r\n        display: 'flex',\r\n        alignItems: 'center',\r\n        pointerEvents: 'auto',\r\n        minWidth: position === 'bottom' ? width / 2.5 : '17px',\r\n        minHeight: position === 'bottom' ? '20px' : numColorbars === 1 ? height / 3 : height / 4,\r\n        ...positionStylesFromConfig,\r\n      }}\r\n    ></div>\r\n  );\r\n});\r\n\r\nexport default ViewportColorbar;\r\n","import React, { useEffect, useState, useMemo, memo, useCallback } from 'react';\r\nimport { useSystem } from '@ohif/core';\r\nimport { ColorbarCustomization } from '../../types/Colorbar';\r\nimport type { ColorMapPreset } from '../../types/Colormap';\r\nimport ViewportColorbar from './ViewportColorbar';\r\nimport useViewportRendering from '../../hooks/useViewportRendering';\r\nimport { useViewportDisplaySets } from '../../hooks/useViewportDisplaySets';\r\ntype ViewportColorbarsContainerProps = {\r\n  viewportId: string;\r\n  location: number;\r\n};\r\n\r\ntype ColorbarData = {\r\n  colorbar: {\r\n    activeColormapName: string;\r\n    colormaps: ColorMapPreset[];\r\n    volumeId?: string;\r\n  };\r\n  displaySetInstanceUID: string;\r\n};\r\n\r\n/**\r\n * Container component that manages multiple colorbars for a viewport\r\n * It interacts with the colorbarService to get/set colorbar states\r\n */\r\nconst ViewportColorbarsContainer = memo(function ViewportColorbarsContainer({\r\n  viewportId,\r\n  location,\r\n}: ViewportColorbarsContainerProps) {\r\n  const [colorbars, setColorbars] = useState<ColorbarData[]>([]);\r\n  const { servicesManager } = useSystem();\r\n  const { colorbarService, customizationService, displaySetService } = servicesManager.services;\r\n  const { viewportDisplaySets, backgroundDisplaySet, foregroundDisplaySets } =\r\n    useViewportDisplaySets(viewportId);\r\n  const { colorbarPosition: position, opacity } = useViewportRendering(viewportId, {\r\n    location,\r\n  });\r\n\r\n  // Memoize the customization to prevent recomputation\r\n  const colorbarCustomization = useMemo(() => {\r\n    return customizationService.getCustomization(\r\n      'cornerstone.colorbar'\r\n    ) as unknown as ColorbarCustomization;\r\n  }, [customizationService]);\r\n\r\n  // Memoize tick position\r\n  const tickPosition = useMemo(() => {\r\n    const defaultTickPosition = colorbarCustomization?.colorbarTickPosition;\r\n    return colorbarCustomization?.colorbarTickPosition || defaultTickPosition;\r\n  }, [colorbarCustomization]);\r\n\r\n  // Initial load of colorbars\r\n  useEffect(() => {\r\n    setColorbars(colorbarService.getViewportColorbar(viewportId) || []);\r\n  }, [viewportId, colorbarService]);\r\n\r\n  // Subscribe to colorbar state changes\r\n  useEffect(() => {\r\n    const { unsubscribe } = colorbarService.subscribe(\r\n      colorbarService.EVENTS.STATE_CHANGED,\r\n      (event: { viewportId: string; displaySetInstanceUID?: string; changeType: string }) => {\r\n        if (event.viewportId === viewportId) {\r\n          setColorbars(colorbarService.getViewportColorbar(viewportId) || []);\r\n        }\r\n      }\r\n    );\r\n\r\n    return () => {\r\n      unsubscribe();\r\n    };\r\n  }, [viewportId, colorbarService]);\r\n\r\n  if (!colorbars.length) {\r\n    return null;\r\n  }\r\n\r\n  const isBottom = position === 'bottom';\r\n\r\n  const isSingleViewport = viewportDisplaySets.length === 1;\r\n  const showFullList = isSingleViewport || !isBottom;\r\n\r\n  const colorbarsToUse = showFullList\r\n    ? colorbars\r\n    : colorbars.filter(({ displaySetInstanceUID }) => {\r\n        const { displaySetInstanceUID: dsUID } =\r\n          displaySetService.getDisplaySetByUID(displaySetInstanceUID) ?? {};\r\n\r\n        const targetUID =\r\n          opacity === 0 || opacity == null\r\n            ? backgroundDisplaySet?.displaySetInstanceUID\r\n            : foregroundDisplaySets[0].displaySetInstanceUID;\r\n\r\n        return dsUID === targetUID;\r\n      });\r\n\r\n  return (\r\n    <div\r\n      style={{\r\n        pointerEvents: 'auto',\r\n      }}\r\n    >\r\n      <div\r\n        className=\"flex h-full flex-col items-center justify-center\"\r\n        style={{ pointerEvents: 'auto' }}\r\n      >\r\n        {colorbarsToUse.map(colorbarInfo => {\r\n          const { colorbar, displaySetInstanceUID } = colorbarInfo;\r\n          return (\r\n            <ViewportColorbar\r\n              key={`colorbar-${viewportId}-${displaySetInstanceUID}`}\r\n              viewportId={viewportId}\r\n              displaySetInstanceUID={displaySetInstanceUID}\r\n              colormaps={colorbar.colormaps}\r\n              activeColormapName={colorbar.activeColormapName}\r\n              volumeId={colorbar.volumeId}\r\n              position={position}\r\n              tickPosition={tickPosition}\r\n              tickStyles={colorbarCustomization?.tickStyles}\r\n              numColorbars={colorbars.length}\r\n            />\r\n          );\r\n        })}\r\n      </div>\r\n    </div>\r\n  );\r\n});\r\n\r\nexport default ViewportColorbarsContainer;\r\n","import ViewportColorbar from './ViewportColorbar';\r\nimport ViewportColorbarsContainer from './ViewportColorbarsContainer';\r\n\r\nexport { ViewportColorbar, ViewportColorbarsContainer };\r\nexport default ViewportColorbarsContainer;\r\n","import React, { useState } from 'react';\r\nimport {\r\n  Button,\r\n  Icons,\r\n  DropdownMenu,\r\n  DropdownMenuTrigger,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n  Switch,\r\n} from '@ohif/ui-next';\r\nimport { useSystem } from '@ohif/core';\r\n\r\nimport { useViewportDisplaySets } from '../../hooks/useViewportDisplaySets';\r\nimport SelectItemWithModality from '../SelectItemWithModality';\r\nimport { useViewportRendering } from '../../hooks';\r\n\r\nfunction ViewportDataOverlayMenu({ viewportId }: withAppTypes<{ viewportId: string }>) {\r\n  const { commandsManager, servicesManager } = useSystem();\r\n  const [pendingForegrounds, setPendingForegrounds] = useState<string[]>([]);\r\n  const [pendingSegmentations, setPendingSegmentations] = useState<string[]>([]);\r\n  const { toggleColorbar } = useViewportRendering(viewportId);\r\n\r\n  const { hangingProtocolService, toolbarService } = servicesManager.services;\r\n\r\n  const {\r\n    backgroundDisplaySet,\r\n    potentialOverlayDisplaySets,\r\n    potentialForegroundDisplaySets,\r\n    potentialBackgroundDisplaySets,\r\n    overlayDisplaySets,\r\n    foregroundDisplaySets,\r\n  } = useViewportDisplaySets(viewportId);\r\n\r\n  const [thresholdOpacityEnabled, setThresholdOpacityEnabled] = useState(false);\r\n\r\n  /**\r\n   * Change the background display set\r\n   */\r\n  const handleBackgroundSelection = (newBackgroundDisplaySet: AppTypes.DisplaySet) => {\r\n    const updatedViewports = hangingProtocolService.getViewportsRequireUpdate(\r\n      viewportId,\r\n      newBackgroundDisplaySet.displaySetInstanceUID\r\n    );\r\n\r\n    commandsManager.run('setDisplaySetsForViewports', {\r\n      viewportsToUpdate: updatedViewports,\r\n    });\r\n  };\r\n\r\n  /**\r\n   * Replace a display set layer with a new one\r\n   */\r\n  const handleReplaceDisplaySetLayer = (\r\n    currentDisplaySetInstanceUID: string,\r\n    newDisplaySetInstanceUID: string\r\n  ) => {\r\n    // Remove current display set\r\n    commandsManager.runCommand('removeDisplaySetLayer', {\r\n      viewportId,\r\n      displaySetInstanceUID: currentDisplaySetInstanceUID,\r\n    });\r\n\r\n    setTimeout(() => {\r\n      commandsManager.runCommand('addDisplaySetAsLayer', {\r\n        viewportId,\r\n        displaySetInstanceUID: newDisplaySetInstanceUID,\r\n      });\r\n    }, 0);\r\n  };\r\n\r\n  /**\r\n   * Remove a display set layer\r\n   */\r\n  const handleRemoveDisplaySetLayer = (displaySetInstanceUID: string) => {\r\n    commandsManager.runCommand('removeDisplaySetLayer', {\r\n      viewportId,\r\n      displaySetInstanceUID,\r\n    });\r\n  };\r\n\r\n  /**\r\n   * Add a display set as a layer\r\n   */\r\n  const handleAddDisplaySetAsLayer = (displaySetInstanceUID: string) => {\r\n    commandsManager.runCommand('addDisplaySetAsLayer', {\r\n      viewportId,\r\n      displaySetInstanceUID,\r\n    });\r\n  };\r\n\r\n  /**\r\n   * Handle overlay display set selection change\r\n   */\r\n  const handleOverlaySelectionChange = (\r\n    currentDisplaySet: AppTypes.DisplaySet,\r\n    newDisplaySetInstanceUID: string\r\n  ) => {\r\n    if (newDisplaySetInstanceUID === currentDisplaySet.displaySetInstanceUID) {\r\n      return;\r\n    }\r\n\r\n    // Find the selected display set\r\n    const selectedDisplaySet = potentialOverlayDisplaySets.find(\r\n      ds => ds.displaySetInstanceUID === newDisplaySetInstanceUID\r\n    );\r\n\r\n    if (selectedDisplaySet) {\r\n      handleReplaceDisplaySetLayer(\r\n        currentDisplaySet.displaySetInstanceUID,\r\n        selectedDisplaySet.displaySetInstanceUID\r\n      );\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Handle foreground display set selection change\r\n   */\r\n  const handleForegroundSelectionChange = (\r\n    currentDisplaySet: AppTypes.DisplaySet,\r\n    newDisplaySetInstanceUID: string\r\n  ) => {\r\n    if (newDisplaySetInstanceUID === currentDisplaySet.displaySetInstanceUID) {\r\n      return;\r\n    }\r\n\r\n    // Find the selected display set\r\n    const selectedDisplaySet = potentialForegroundDisplaySets.find(\r\n      ds => ds.displaySetInstanceUID === newDisplaySetInstanceUID\r\n    );\r\n\r\n    if (selectedDisplaySet) {\r\n      handleReplaceDisplaySetLayer(\r\n        currentDisplaySet.displaySetInstanceUID,\r\n        selectedDisplaySet.displaySetInstanceUID\r\n      );\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Handle pending segmentation selection\r\n   */\r\n  const handlePendingSegmentationSelection = (pendingId: string, displaySetInstanceUID: string) => {\r\n    const selectedDisplaySet = potentialOverlayDisplaySets.find(\r\n      ds => ds.displaySetInstanceUID === displaySetInstanceUID\r\n    );\r\n\r\n    if (selectedDisplaySet) {\r\n      handleAddDisplaySetAsLayer(selectedDisplaySet.displaySetInstanceUID);\r\n      // Remove this pending segmentation from the list\r\n      setPendingSegmentations(pendingSegmentations.filter(id => id !== pendingId));\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Handle pending foreground selection\r\n   */\r\n  const handlePendingForegroundSelection = (pendingId: string, displaySetInstanceUID: string) => {\r\n    const selectedDisplaySet = potentialForegroundDisplaySets.find(\r\n      ds => ds.displaySetInstanceUID === displaySetInstanceUID\r\n    );\r\n\r\n    if (selectedDisplaySet) {\r\n      handleAddDisplaySetAsLayer(selectedDisplaySet.displaySetInstanceUID);\r\n      // Remove this pending foreground from the list\r\n      setPendingForegrounds(pendingForegrounds.filter(id => id !== pendingId));\r\n    }\r\n  };\r\n\r\n  // Check if the advanced window level components exist in toolbar\r\n  const hasAdvancedRenderingControls = !!toolbarService.getButton('AdvancedRenderingControls');\r\n  const hasOpacityMenu = !!toolbarService.getButton('opacityMenu');\r\n\r\n  const handleThresholdOpacityToggle = () => {\r\n    const newValue = !thresholdOpacityEnabled;\r\n    if (hasAdvancedRenderingControls) {\r\n      toggleColorbar();\r\n    }\r\n    setThresholdOpacityEnabled(newValue);\r\n  };\r\n\r\n  return (\r\n    <div className=\"bg-popover flex h-full w-[275px] flex-col rounded rounded-md p-1.5\">\r\n      {/* Top buttons row */}\r\n      <div className={`flex`}>\r\n        <Button\r\n          variant=\"ghost\"\r\n          className=\"text-primary flex items-center p-1\"\r\n          onClick={() => {\r\n            // Add a new pending foreground slot with a unique ID\r\n            setPendingForegrounds([...pendingForegrounds, `pending-${Date.now()}`]);\r\n          }}\r\n          disabled={potentialForegroundDisplaySets.length === 0}\r\n        >\r\n          <Icons.Plus className=\"h-4 w-4\" />\r\n          Foreground\r\n        </Button>\r\n        <Button\r\n          variant=\"ghost\"\r\n          className=\"text-primary ml-2 flex items-center\"\r\n          disabled={potentialOverlayDisplaySets.length === 0}\r\n          onClick={() => {\r\n            setPendingSegmentations([...pendingSegmentations, `seg-${Date.now()}`]);\r\n          }}\r\n        >\r\n          <Icons.Plus className=\"h-4 w-4\" />\r\n          Segmentation\r\n        </Button>\r\n      </div>\r\n\r\n      <div className=\"\">\r\n        {/* Overlays Segmentation section */}\r\n        <div className=\"my-2 ml-1\">\r\n          {overlayDisplaySets.map((displaySet, index) => (\r\n            <div\r\n              key={displaySet.displaySetInstanceUID}\r\n              className=\"mb-1 flex items-center\"\r\n            >\r\n              <Icons.LayerSegmentation className=\"text-muted-foreground mr-1 h-6 w-6 flex-shrink-0\" />\r\n              <Select\r\n                value={displaySet.displaySetInstanceUID}\r\n                onValueChange={value => handleOverlaySelectionChange(displaySet, value)}\r\n              >\r\n                <SelectTrigger className=\"flex-1\">\r\n                  <SelectValue>{displaySet.label?.toUpperCase()}</SelectValue>\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {/* Include both potential overlays and the current overlay */}\r\n                  <SelectItem\r\n                    key={displaySet.displaySetInstanceUID}\r\n                    value={displaySet.displaySetInstanceUID}\r\n                    className=\"pr-2\"\r\n                  >\r\n                    <SelectItemWithModality displaySet={displaySet} />\r\n                  </SelectItem>\r\n                  {potentialOverlayDisplaySets.map(item => (\r\n                    <SelectItem\r\n                      key={item.displaySetInstanceUID}\r\n                      value={item.displaySetInstanceUID}\r\n                      className=\"pr-2\"\r\n                    >\r\n                      <SelectItemWithModality displaySet={item} />\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n              <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                  <Button\r\n                    variant=\"ghost\"\r\n                    size=\"icon\"\r\n                    className=\"ml-2 flex-shrink-0\"\r\n                  >\r\n                    <Icons.More className=\"h-4 w-4\" />\r\n                  </Button>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent align=\"start\">\r\n                  <DropdownMenuItem\r\n                    onClick={() => handleRemoveDisplaySetLayer(displaySet.displaySetInstanceUID)}\r\n                  >\r\n                    Remove\r\n                  </DropdownMenuItem>\r\n                </DropdownMenuContent>\r\n              </DropdownMenu>\r\n            </div>\r\n          ))}\r\n\r\n          {pendingSegmentations.map(pendingId => (\r\n            <div\r\n              key={pendingId}\r\n              className=\"mb-2 flex items-center\"\r\n            >\r\n              <Icons.LayerSegmentation className=\"text-muted-foreground mr-1 h-6 w-6 flex-shrink-0\" />\r\n              <Select\r\n                value=\"\"\r\n                onValueChange={value => handlePendingSegmentationSelection(pendingId, value)}\r\n              >\r\n                <SelectTrigger className=\"flex-1\">\r\n                  <SelectValue placeholder=\"SELECT A SEGMENTATION\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {potentialOverlayDisplaySets.map(item => (\r\n                    <SelectItem\r\n                      key={item.displaySetInstanceUID}\r\n                      value={item.displaySetInstanceUID}\r\n                      className=\"pr-2\"\r\n                    >\r\n                      <SelectItemWithModality displaySet={item} />\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n              <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                  <Button\r\n                    variant=\"ghost\"\r\n                    size=\"icon\"\r\n                    className=\"ml-2 flex-shrink-0\"\r\n                  >\r\n                    <Icons.More className=\"h-4 w-4\" />\r\n                  </Button>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent align=\"start\">\r\n                  <DropdownMenuItem\r\n                    onClick={() => {\r\n                      // Remove this pending segmentation\r\n                      setPendingSegmentations(pendingSegmentations.filter(id => id !== pendingId));\r\n                    }}\r\n                  >\r\n                    Cancel\r\n                  </DropdownMenuItem>\r\n                </DropdownMenuContent>\r\n              </DropdownMenu>\r\n            </div>\r\n          ))}\r\n        </div>\r\n        {/* Foregrounds section */}\r\n        <div className=\"my-2 px-1\">\r\n          {foregroundDisplaySets.map((displaySet, index) => (\r\n            <div\r\n              key={displaySet.displaySetInstanceUID}\r\n              className=\"mb-1 flex items-center\"\r\n            >\r\n              <Icons.LayerForeground className=\"text-muted-foreground mr-1 h-6 w-6 flex-shrink-0\" />\r\n              <Select\r\n                value={displaySet.displaySetInstanceUID}\r\n                onValueChange={value => handleForegroundSelectionChange(displaySet, value)}\r\n              >\r\n                <SelectTrigger className=\"flex-1\">\r\n                  <SelectValue>{displaySet.label?.toUpperCase()}</SelectValue>\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {/* Include both potential foregrounds and the current foreground */}\r\n                  <SelectItem\r\n                    key={displaySet.displaySetInstanceUID}\r\n                    value={displaySet.displaySetInstanceUID}\r\n                    className=\"pr-2\"\r\n                  >\r\n                    <SelectItemWithModality displaySet={displaySet} />\r\n                  </SelectItem>\r\n                  {potentialForegroundDisplaySets.map(item => (\r\n                    <SelectItem\r\n                      key={item.displaySetInstanceUID}\r\n                      value={item.displaySetInstanceUID}\r\n                      className=\"pr-2\"\r\n                    >\r\n                      <SelectItemWithModality displaySet={item} />\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n              <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                  <Button\r\n                    variant=\"ghost\"\r\n                    size=\"icon\"\r\n                    className=\"ml-2 flex-shrink-0\"\r\n                  >\r\n                    <Icons.More className=\"h-4 w-4\" />\r\n                  </Button>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent align=\"start\">\r\n                  <DropdownMenuItem\r\n                    onClick={() => handleRemoveDisplaySetLayer(displaySet.displaySetInstanceUID)}\r\n                  >\r\n                    Remove\r\n                  </DropdownMenuItem>\r\n                </DropdownMenuContent>\r\n              </DropdownMenu>\r\n            </div>\r\n          ))}\r\n\r\n          {pendingForegrounds.map(pendingId => (\r\n            <div\r\n              key={pendingId}\r\n              className=\"mb-2 flex items-center\"\r\n            >\r\n              <Icons.LayerForeground className=\"text-muted-foreground mr-1 h-6 w-6 flex-shrink-0\" />\r\n              <Select\r\n                value=\"\"\r\n                onValueChange={value => handlePendingForegroundSelection(pendingId, value)}\r\n              >\r\n                <SelectTrigger className=\"flex-1\">\r\n                  <SelectValue placeholder=\"SELECT A FOREGROUND\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {potentialForegroundDisplaySets.map(item => (\r\n                    <SelectItem\r\n                      key={item.displaySetInstanceUID}\r\n                      value={item.displaySetInstanceUID}\r\n                      className=\"pr-2\"\r\n                    >\r\n                      <SelectItemWithModality displaySet={item} />\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n              <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                  <Button\r\n                    variant=\"ghost\"\r\n                    size=\"icon\"\r\n                    className=\"ml-2 flex-shrink-0\"\r\n                  >\r\n                    <Icons.More className=\"h-4 w-4\" />\r\n                  </Button>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent align=\"start\">\r\n                  <DropdownMenuItem\r\n                    onClick={() => {\r\n                      // Remove this pending foreground\r\n                      setPendingForegrounds(pendingForegrounds.filter(id => id !== pendingId));\r\n                    }}\r\n                  >\r\n                    Cancel\r\n                  </DropdownMenuItem>\r\n                </DropdownMenuContent>\r\n              </DropdownMenu>\r\n            </div>\r\n          ))}\r\n        </div>\r\n        {/* Background section */}\r\n        <div className=\"mt-1 mb-1 flex items-center px-1\">\r\n          <Icons.LayerBackground className=\"text-muted-foreground mr-1 h-6 w-6 flex-shrink-0\" />\r\n          <Select\r\n            value={backgroundDisplaySet?.displaySetInstanceUID}\r\n            onValueChange={value => {\r\n              const selectedDisplaySet = potentialBackgroundDisplaySets.find(\r\n                ds => ds.displaySetInstanceUID === value\r\n              );\r\n              if (selectedDisplaySet) {\r\n                handleBackgroundSelection(selectedDisplaySet);\r\n              }\r\n            }}\r\n          >\r\n            <SelectTrigger className=\"flex-1\">\r\n              <SelectValue>\r\n                {(\r\n                  backgroundDisplaySet?.SeriesDescription ||\r\n                  backgroundDisplaySet?.label ||\r\n                  'background'\r\n                ).toUpperCase()}\r\n              </SelectValue>\r\n            </SelectTrigger>\r\n            <SelectContent>\r\n              {potentialBackgroundDisplaySets.map(displaySet => (\r\n                <SelectItem\r\n                  key={displaySet.displaySetInstanceUID}\r\n                  value={displaySet.displaySetInstanceUID}\r\n                  className=\"pr-2\"\r\n                >\r\n                  <SelectItemWithModality displaySet={displaySet} />\r\n                </SelectItem>\r\n              ))}\r\n            </SelectContent>\r\n          </Select>\r\n        </div>\r\n      </div>\r\n      {foregroundDisplaySets.length > 0 && (hasAdvancedRenderingControls || hasOpacityMenu) && (\r\n        <div className=\"mt-1 ml-7\">\r\n          <div className=\"flex items-center\">\r\n            <Switch\r\n              id=\"threshold-opacity-switch\"\r\n              className=\"mr-2\"\r\n              checked={thresholdOpacityEnabled}\r\n              onCheckedChange={handleThresholdOpacityToggle}\r\n            />\r\n            <label\r\n              htmlFor=\"threshold-opacity-switch\"\r\n              className=\"text-muted-foreground cursor-pointer text-sm\"\r\n              onClick={() => setThresholdOpacityEnabled(!thresholdOpacityEnabled)}\r\n            >\r\n              Control threshold & opacity\r\n            </label>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default ViewportDataOverlayMenu;\r\n","import React, { ReactNode } from 'react';\r\nimport { useSystem } from '@ohif/core';\r\nimport {\r\n  Button,\r\n  Icons,\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverTrigger,\r\n  useIconPresentation,\r\n} from '@ohif/ui-next';\r\nimport ViewportDataOverlayMenu from './ViewportDataOverlayMenu';\r\nimport { useViewportDisplaySets } from '../../hooks/useViewportDisplaySets';\r\n\r\ntype DataOverlayMenuProps = {\r\n  viewportId: string;\r\n  location: string;\r\n  isOpen?: boolean;\r\n  onOpen?: () => void;\r\n  onClose?: () => void;\r\n  disabled?: boolean;\r\n};\r\n\r\nexport function ViewportDataOverlayMenuWrapper(props: DataOverlayMenuProps): ReactNode {\r\n  const { viewportId, location, isOpen = false, onOpen, onClose, disabled, ...rest } = props;\r\n  const { viewportDisplaySets: displaySets } = useViewportDisplaySets(viewportId);\r\n  const { IconContainer, className: iconClassName, containerProps } = useIconPresentation();\r\n\r\n  const handleOpenChange = (openState: boolean) => {\r\n    if (openState) {\r\n      onOpen?.();\r\n    } else {\r\n      onClose?.();\r\n    }\r\n  };\r\n\r\n  const { servicesManager } = useSystem();\r\n  const { toolbarService } = servicesManager.services;\r\n\r\n  const { align, side } = toolbarService.getAlignAndSide(location);\r\n\r\n  const Icon = <Icons.ViewportViews className={iconClassName} />;\r\n\r\n  return (\r\n    <Popover\r\n      open={isOpen}\r\n      onOpenChange={handleOpenChange}\r\n    >\r\n      <PopoverTrigger\r\n        asChild\r\n        className=\"flex items-center justify-center\"\r\n      >\r\n        <div>\r\n          {IconContainer ? (\r\n            <IconContainer\r\n              disabled={disabled}\r\n              icon=\"ViewportViews\"\r\n              {...rest}\r\n              {...containerProps}\r\n            >\r\n              {Icon}\r\n            </IconContainer>\r\n          ) : (\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              disabled={disabled}\r\n            >\r\n              {Icon}\r\n            </Button>\r\n          )}\r\n        </div>\r\n      </PopoverTrigger>\r\n      <PopoverContent\r\n        className=\"border-none bg-transparent p-0 shadow-none\"\r\n        side={side}\r\n        align={align}\r\n        alignOffset={0}\r\n        sideOffset={5}\r\n      >\r\n        <ViewportDataOverlayMenu\r\n          className=\"w-full\"\r\n          viewportId={viewportId}\r\n          displaySets={displaySets}\r\n        />\r\n      </PopoverContent>\r\n    </Popover>\r\n  );\r\n}\r\n","import { utilities as csUtils } from '@cornerstonejs/core';\r\n\r\nexport const DEFAULT_COLORMAP = 'hsv';\r\nexport const DEFAULT_OPACITY = 0.5;\r\nexport const DEFAULT_OPACITY_PERCENT = DEFAULT_OPACITY * 100;\r\nexport const DERIVED_OVERLAY_MODALITIES = ['SEG', 'RTSTRUCT'];\r\n\r\n/**\r\n * Get modality-specific color and opacity settings from the customization service\r\n */\r\nexport function getModalityOverlayColormap(customizationService, modality) {\r\n  const modalityOverlayDefaultColorMaps = customizationService?.getCustomization(\r\n    'cornerstone.modalityOverlayDefaultColorMaps'\r\n  ) || { defaultSettings: {} };\r\n\r\n  return (\r\n    modalityOverlayDefaultColorMaps.defaultSettings[modality] || {\r\n      colormap: DEFAULT_COLORMAP,\r\n      opacity: DEFAULT_OPACITY,\r\n    }\r\n  );\r\n}\r\n\r\n/**\r\n * Identifies display sets that can be used as overlays for a specific viewport.\r\n *\r\n * \"Enhanced\" display sets are those that:\r\n * 1. Are not already in the viewport\r\n * 2. Are evaluated for their ability to be overlaid onto the background display set\r\n * 3. Have an \"isOverlayable\" flag indicating if they're compatible with the viewport\r\n *\r\n * A display set is considered overlayable when:\r\n * - The background display set is reconstructable\r\n * - The display set is not unsupported\r\n * - The Frame of Reference matches the background display set\r\n * - For non-derived modalities: background can be a volume and display set is either multiframe or valid volume\r\n *\r\n * @returns {Object} Object containing:\r\n *   - viewportDisplaySets: Display sets already in the viewport\r\n *   - enhancedDisplaySets: Other display sets with overlayability assessment\r\n */\r\nexport function getEnhancedDisplaySets({ viewportId, services }) {\r\n  const { displaySetService, viewportGridService } = services;\r\n  const displaySetsUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n\r\n  if (!displaySetsUIDs?.length) {\r\n    return {\r\n      viewportDisplaySets: [],\r\n      enhancedDisplaySets: [],\r\n    };\r\n  }\r\n\r\n  const allDisplaySets = displaySetService.getActiveDisplaySets();\r\n\r\n  const otherDisplaySets = allDisplaySets.filter(\r\n    displaySet => !displaySetsUIDs.includes(displaySet.displaySetInstanceUID)\r\n  );\r\n\r\n  const viewportDisplaySets = displaySetsUIDs.map(displaySetUID =>\r\n    displaySetService.getDisplaySetByUID(displaySetUID)\r\n  );\r\n\r\n  const backgroundCanBeVolume = csUtils.isValidVolume(viewportDisplaySets[0].imageIds || []);\r\n  const backgroundDisplaySet = viewportDisplaySets[0];\r\n\r\n  const enhancedDisplaySets = otherDisplaySets.map(displaySet => {\r\n    if (!backgroundDisplaySet.isReconstructable) {\r\n      return {\r\n        ...displaySet,\r\n        isOverlayable: false,\r\n      };\r\n    }\r\n\r\n    if (displaySet.unsupported) {\r\n      return {\r\n        ...displaySet,\r\n        isOverlayable: false,\r\n      };\r\n    }\r\n\r\n    // Check if Frame of Reference matches\r\n    if (\r\n      displaySet.FrameOfReferenceUID &&\r\n      displaySet.FrameOfReferenceUID !== backgroundDisplaySet.FrameOfReferenceUID\r\n    ) {\r\n      return {\r\n        ...displaySet,\r\n        isOverlayable: false,\r\n      };\r\n    }\r\n\r\n    // Special handling for derived modalities\r\n    if (!DERIVED_OVERLAY_MODALITIES.includes(displaySet.Modality)) {\r\n      if (!backgroundCanBeVolume) {\r\n        return {\r\n          ...displaySet,\r\n          isOverlayable: false,\r\n        };\r\n      }\r\n\r\n      const imageIds = displaySet.imageIds || displaySet.images?.map(image => image.imageId);\r\n      const isMultiframe = displaySet.isMultiFrame;\r\n\r\n      if (!isMultiframe && imageIds?.length > 0 && !csUtils.isValidVolume(imageIds)) {\r\n        return {\r\n          ...displaySet,\r\n          isOverlayable: false,\r\n        };\r\n      }\r\n    }\r\n\r\n    return {\r\n      ...displaySet,\r\n      isOverlayable: true,\r\n    };\r\n  });\r\n\r\n  return {\r\n    viewportDisplaySets,\r\n    enhancedDisplaySets,\r\n  };\r\n}\r\n\r\n/**\r\n * Sort function: puts disabled items (isOverlayable: false) at the end\r\n */\r\nexport const sortByOverlayable = (a, b) => {\r\n  if (a.isOverlayable === b.isOverlayable) {\r\n    return 0;\r\n  }\r\n  return a.isOverlayable ? -1 : 1;\r\n};\r\n\r\n/**\r\n * Create display set options based on modality and opacity settings\r\n */\r\nexport function createColormapOverlayDisplaySetOptions(displaySet, opacity, customizationService) {\r\n  if (displaySet.Modality === 'SEG') {\r\n    return {};\r\n  }\r\n\r\n  const modalitySettings = getModalityOverlayColormap(customizationService, displaySet.Modality);\r\n  return {\r\n    colormap: {\r\n      name: modalitySettings.colormap || DEFAULT_COLORMAP,\r\n      opacity: opacity / 100, // Convert from percentage to 0-1 range\r\n    },\r\n  };\r\n}\r\n\r\n/**\r\n * Get segmentations that can be added as overlays to the viewport\r\n *\r\n * Note: This function is deprecated as we now use display sets for segmentations\r\n */\r\nexport function getAvailableSegmentations(segmentationService) {\r\n  const segmentations = segmentationService.getSegmentations() || [];\r\n  return segmentations.map(segmentation => ({\r\n    segmentationId: segmentation.segmentationId,\r\n    label: segmentation.label || 'Segmentation',\r\n    segments: segmentation.segments,\r\n    frameOfReferenceUID: segmentation.frameOfReferenceUID,\r\n  }));\r\n}\r\n","import React from 'react';\r\nimport { cn, Icons, ToolButton, useIconPresentation } from '@ohif/ui-next';\r\nimport { useSystem } from '@ohif/core';\r\nimport { Enums } from '@cornerstonejs/core';\r\nimport { Popover, PopoverTrigger, PopoverContent, Button, useViewportGrid } from '@ohif/ui-next';\r\n\r\nfunction ViewportOrientationMenu({\r\n  location,\r\n  viewportId,\r\n  displaySets,\r\n  isOpen = false,\r\n  onOpen,\r\n  onClose,\r\n  disabled,\r\n  ...props\r\n}: withAppTypes<{\r\n  location?: string;\r\n  viewportId: string;\r\n  displaySets: AppTypes.DisplaySet[];\r\n  isOpen?: boolean;\r\n  onOpen?: () => void;\r\n  onClose?: () => void;\r\n  disabled?: boolean;\r\n}>) {\r\n  const [gridState] = useViewportGrid();\r\n  const viewportIdToUse = viewportId || gridState.activeViewportId;\r\n  const { IconContainer, className: iconClassName, containerProps } = useIconPresentation();\r\n  const { servicesManager, commandsManager } = useSystem();\r\n  const { cornerstoneViewportService, toolbarService } = servicesManager.services;\r\n\r\n  const handleOrientationChange = (orientation: string) => {\r\n    const viewportInfo = cornerstoneViewportService.getViewportInfo(viewportIdToUse);\r\n    const currentViewportType = viewportInfo?.getViewportType();\r\n\r\n    if (!displaySets.length) {\r\n      return;\r\n    }\r\n\r\n    // Check if at least one displaySet is reconstructable\r\n    const hasReconstructableDisplaySet = displaySets.some(ds => ds.isReconstructable);\r\n\r\n    if (!hasReconstructableDisplaySet) {\r\n      console.warn('Cannot change orientation: No reconstructable display sets in viewport');\r\n      return;\r\n    }\r\n\r\n    // Set the orientation enum based on the selected orientation\r\n    let orientationEnum;\r\n    switch (orientation.toLowerCase()) {\r\n      case 'axial':\r\n        orientationEnum = Enums.OrientationAxis.AXIAL;\r\n        break;\r\n      case 'sagittal':\r\n        orientationEnum = Enums.OrientationAxis.SAGITTAL;\r\n        break;\r\n      case 'coronal':\r\n        orientationEnum = Enums.OrientationAxis.CORONAL;\r\n        break;\r\n      default:\r\n        orientationEnum = Enums.OrientationAxis.ACQUISITION;\r\n    }\r\n\r\n    const displaySetUIDs = displaySets.map(ds => ds.displaySetInstanceUID);\r\n\r\n    // If viewport is not already a volume type, we need to convert it\r\n    if (currentViewportType !== Enums.ViewportType.ORTHOGRAPHIC) {\r\n      // Configure the viewport to be a volume viewport with current display sets\r\n      const updatedViewport = {\r\n        viewportId: viewportIdToUse,\r\n        displaySetInstanceUIDs: displaySetUIDs,\r\n        viewportOptions: {\r\n          viewportType: Enums.ViewportType.ORTHOGRAPHIC,\r\n          orientation: orientationEnum,\r\n        },\r\n        displaySetOptions: displaySetUIDs.map(() => ({})),\r\n      };\r\n\r\n      // Update the viewport to be a volume viewport\r\n      commandsManager.run('setDisplaySetsForViewports', {\r\n        viewportsToUpdate: [updatedViewport],\r\n      });\r\n    } else {\r\n      // Set the viewport orientation\r\n      commandsManager.runCommand('setViewportOrientation', {\r\n        viewportId: viewportIdToUse,\r\n        orientation: orientationEnum,\r\n      });\r\n    }\r\n\r\n    // Close the menu after selection\r\n    onClose?.();\r\n  };\r\n\r\n  const handleOpenChange = (openState: boolean) => {\r\n    if (openState) {\r\n      onOpen?.();\r\n    } else {\r\n      onClose?.();\r\n    }\r\n  };\r\n\r\n  if (!displaySets.length) {\r\n    return null;\r\n  }\r\n\r\n  // Get proper alignment and side based on the location using toolbar service\r\n  const { align, side } = toolbarService.getAlignAndSide(Number(location));\r\n\r\n  const Icon = <Icons.OrientationSwitch className={iconClassName} />;\r\n  return (\r\n    <Popover\r\n      open={isOpen}\r\n      onOpenChange={handleOpenChange}\r\n    >\r\n      <PopoverTrigger\r\n        asChild\r\n        className={cn('flex items-center justify-center')}\r\n      >\r\n        <div>\r\n          {IconContainer ? (\r\n            <IconContainer\r\n              disabled={disabled}\r\n              icon=\"OrientationSwitch\"\r\n              {...props}\r\n              {...containerProps}\r\n            >\r\n              {Icon}\r\n            </IconContainer>\r\n          ) : (\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              disabled={disabled}\r\n              onClick={() => {}}\r\n            >\r\n              {Icon}\r\n            </Button>\r\n          )}\r\n        </div>\r\n      </PopoverTrigger>\r\n      <PopoverContent\r\n        className=\"w-[100px] p-1\"\r\n        align={align}\r\n        side={side}\r\n      >\r\n        <div className=\"flex flex-col\">\r\n          <Button\r\n            variant=\"ghost\"\r\n            className=\"justify-start\"\r\n            onClick={() => handleOrientationChange('axial')}\r\n          >\r\n            Axial\r\n          </Button>\r\n          <Button\r\n            variant=\"ghost\"\r\n            className=\"justify-start\"\r\n            onClick={() => handleOrientationChange('sagittal')}\r\n          >\r\n            Sagittal\r\n          </Button>\r\n          <Button\r\n            variant=\"ghost\"\r\n            className=\"justify-start\"\r\n            onClick={() => handleOrientationChange('coronal')}\r\n          >\r\n            Coronal\r\n          </Button>\r\n          <Button\r\n            variant=\"ghost\"\r\n            className=\"justify-start\"\r\n            onClick={() => handleOrientationChange('acquisition')}\r\n          >\r\n            Acquisition\r\n          </Button>\r\n        </div>\r\n      </PopoverContent>\r\n    </Popover>\r\n  );\r\n}\r\n\r\nexport default ViewportOrientationMenu;\r\n","import React, { ReactNode } from 'react';\r\nimport ViewportOrientationMenu from './ViewportOrientationMenu';\r\nimport { useViewportDisplaySets } from '../../hooks/useViewportDisplaySets';\r\n\r\nexport function ViewportOrientationMenuWrapper(\r\n  props: withAppTypes<{\r\n    viewportId: string;\r\n    location: string;\r\n    isOpen?: boolean;\r\n    onOpen?: () => void;\r\n    onClose?: () => void;\r\n    iconSize?: number;\r\n    disabled?: boolean;\r\n  }>\r\n): ReactNode {\r\n  const { viewportId } = props;\r\n  const { viewportDisplaySets } = useViewportDisplaySets(viewportId);\r\n\r\n  if (!viewportDisplaySets.length) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <ViewportOrientationMenu\r\n      {...props}\r\n      displaySets={viewportDisplaySets}\r\n    />\r\n  );\r\n}\r\n","import React, { useEffect, useCallback, useState, ReactElement, useMemo } from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport debounce from 'lodash.debounce';\r\nimport { PanelSection, WindowLevel } from '@ohif/ui-next';\r\nimport { BaseVolumeViewport, Enums, eventTarget } from '@cornerstonejs/core';\r\nimport { useActiveViewportDisplaySets } from '@ohif/core';\r\nimport {\r\n  getNodeOpacity,\r\n  isPetVolumeWithDefaultOpacity,\r\n  isVolumeWithConstantOpacity,\r\n  getWindowLevelsData,\r\n} from './utils';\r\n\r\nconst { Events } = Enums;\r\n\r\nconst ViewportWindowLevel = ({\r\n  servicesManager,\r\n  viewportId,\r\n}: withAppTypes<{\r\n  viewportId: string;\r\n}>): ReactElement => {\r\n  const { cornerstoneViewportService } = servicesManager.services;\r\n  const [windowLevels, setWindowLevels] = useState<any[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const displaySets = useActiveViewportDisplaySets();\r\n\r\n  const getViewportsWithVolumeIds = useCallback(\r\n    (volumeIds: string[]) => {\r\n      const renderingEngine = cornerstoneViewportService.getRenderingEngine();\r\n      const viewports = renderingEngine.getVolumeViewports();\r\n\r\n      return viewports.filter(vp => {\r\n        const viewportVolumeIds = vp instanceof BaseVolumeViewport ? vp.getAllVolumeIds() : [];\r\n        return (\r\n          volumeIds.length === viewportVolumeIds.length &&\r\n          volumeIds.every(volumeId => viewportVolumeIds.includes(volumeId))\r\n        );\r\n      });\r\n    },\r\n    [cornerstoneViewportService]\r\n  );\r\n\r\n  const getVolumeOpacity = useCallback((viewport, volumeId) => {\r\n    const volumeActor = viewport.getActors().find(actor => actor.referencedId === volumeId)?.actor;\r\n\r\n    if (isPetVolumeWithDefaultOpacity(volumeId, volumeActor)) {\r\n      return getNodeOpacity(volumeActor, 1);\r\n    } else if (isVolumeWithConstantOpacity(volumeActor)) {\r\n      return getNodeOpacity(volumeActor, 0);\r\n    }\r\n\r\n    return undefined;\r\n  }, []);\r\n\r\n  const updateViewportHistograms = useCallback(() => {\r\n    const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n    const viewportInfo = cornerstoneViewportService.getViewportInfo(viewportId);\r\n\r\n    getWindowLevelsData(viewport, viewportInfo, getVolumeOpacity).then(data => {\r\n      setWindowLevels(data);\r\n    });\r\n  }, [viewportId, cornerstoneViewportService, getVolumeOpacity]);\r\n\r\n  const handleCornerstoneVOIModified = useCallback(\r\n    e => {\r\n      const { detail } = e;\r\n      const { volumeId, range } = detail;\r\n      const oldWindowLevel = windowLevels.find(wl => wl.volumeId === volumeId);\r\n\r\n      if (!oldWindowLevel) {\r\n        return;\r\n      }\r\n\r\n      const oldVOI = oldWindowLevel.voi;\r\n      const windowWidth = range.upper - range.lower;\r\n      const windowCenter = range.lower + windowWidth / 2;\r\n\r\n      if (windowWidth === oldVOI.windowWidth && windowCenter === oldVOI.windowCenter) {\r\n        return;\r\n      }\r\n\r\n      const newWindowLevel = {\r\n        ...oldWindowLevel,\r\n        voi: {\r\n          windowWidth,\r\n          windowCenter,\r\n        },\r\n      };\r\n\r\n      setWindowLevels(\r\n        windowLevels.map(windowLevel =>\r\n          windowLevel === oldWindowLevel ? newWindowLevel : windowLevel\r\n        )\r\n      );\r\n    },\r\n    [windowLevels]\r\n  );\r\n\r\n  const debouncedHandleCornerstoneVOIModified = useMemo(\r\n    () => debounce(handleCornerstoneVOIModified, 100),\r\n    [handleCornerstoneVOIModified]\r\n  );\r\n\r\n  const handleVOIChange = useCallback(\r\n    (volumeId, voi) => {\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n      const newRange = {\r\n        lower: voi.windowCenter - voi.windowWidth / 2,\r\n        upper: voi.windowCenter + voi.windowWidth / 2,\r\n      };\r\n\r\n      viewport.setProperties({ voiRange: newRange }, volumeId);\r\n      viewport.render();\r\n    },\r\n    [cornerstoneViewportService, viewportId]\r\n  );\r\n\r\n  const handleOpacityChange = useCallback(\r\n    (viewportId, _volumeIndex, volumeId, opacity) => {\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n      if (!viewport) {\r\n        return;\r\n      }\r\n\r\n      const viewportVolumeIds =\r\n        viewport instanceof BaseVolumeViewport ? viewport.getAllVolumeIds() : [];\r\n      const viewports = getViewportsWithVolumeIds(viewportVolumeIds);\r\n\r\n      viewports.forEach(vp => {\r\n        vp.setProperties({ colormap: { opacity } }, volumeId);\r\n        vp.render();\r\n      });\r\n    },\r\n    [getViewportsWithVolumeIds, cornerstoneViewportService]\r\n  );\r\n\r\n  // New function to handle image volume loading completion\r\n  const handleImageVolumeLoadingCompleted = useCallback(() => {\r\n    setIsLoading(false);\r\n    updateViewportHistograms();\r\n  }, [updateViewportHistograms]);\r\n\r\n  // Listen to cornerstone events and set up interval for histogram updates\r\n  useEffect(() => {\r\n    document.addEventListener(Events.VOI_MODIFIED, debouncedHandleCornerstoneVOIModified, true);\r\n    eventTarget.addEventListener(\r\n      Events.IMAGE_VOLUME_LOADING_COMPLETED,\r\n      handleImageVolumeLoadingCompleted\r\n    );\r\n\r\n    const intervalId = setInterval(() => {\r\n      if (isLoading) {\r\n        updateViewportHistograms();\r\n      }\r\n    }, 1000);\r\n\r\n    return () => {\r\n      document.removeEventListener(\r\n        Events.VOI_MODIFIED,\r\n        debouncedHandleCornerstoneVOIModified,\r\n        true\r\n      );\r\n      eventTarget.removeEventListener(\r\n        Events.IMAGE_VOLUME_LOADING_COMPLETED,\r\n        handleImageVolumeLoadingCompleted\r\n      );\r\n      clearInterval(intervalId);\r\n    };\r\n  }, [\r\n    updateViewportHistograms,\r\n    debouncedHandleCornerstoneVOIModified,\r\n    handleImageVolumeLoadingCompleted,\r\n    isLoading,\r\n  ]);\r\n\r\n  // Create a memoized version of displaySet IDs for comparison\r\n  const displaySetIds = useMemo(() => {\r\n    return displaySets?.map(ds => ds.displaySetInstanceUID).sort() || [];\r\n  }, [displaySets]);\r\n\r\n  useEffect(() => {\r\n    const { unsubscribe } = cornerstoneViewportService.subscribe(\r\n      cornerstoneViewportService.EVENTS.VIEWPORT_VOLUMES_CHANGED,\r\n      ({ viewportInfo }) => {\r\n        if (viewportInfo.viewportId === viewportId) {\r\n          updateViewportHistograms();\r\n        }\r\n      }\r\n    );\r\n\r\n    // Only update if displaySets actually changed and are loaded\r\n    if (displaySetIds.length && !isLoading) {\r\n      updateViewportHistograms();\r\n    }\r\n\r\n    return () => {\r\n      unsubscribe();\r\n    };\r\n  }, [viewportId, cornerstoneViewportService, updateViewportHistograms, displaySetIds, isLoading]);\r\n\r\n  return (\r\n    <PanelSection defaultOpen={true}>\r\n      <PanelSection.Header>Window Level</PanelSection.Header>\r\n      <PanelSection.Content className=\"bg-muted py-1\">\r\n        {windowLevels.map((windowLevel, i) => {\r\n          if (!windowLevel.histogram) {\r\n            return null;\r\n          }\r\n\r\n          return (\r\n            <WindowLevel\r\n              key={windowLevel.volumeId}\r\n              histogram={windowLevel.histogram}\r\n              voi={windowLevel.voi}\r\n              step={windowLevel.step}\r\n              showOpacitySlider={windowLevel.showOpacitySlider}\r\n              colormap={windowLevel.colormap}\r\n              onVOIChange={voi => handleVOIChange(windowLevel.volumeId, voi)}\r\n              opacity={windowLevel.opacity}\r\n              onOpacityChange={opacity =>\r\n                handleOpacityChange(windowLevel.viewportId, i, windowLevel.volumeId, opacity)\r\n              }\r\n            />\r\n          );\r\n        })}\r\n        {windowLevels.length === 0 && !isLoading && (\r\n          <div className=\"text-muted-foreground py-2 text-center text-sm\">\r\n            No window level data available\r\n          </div>\r\n        )}\r\n      </PanelSection.Content>\r\n    </PanelSection>\r\n  );\r\n};\r\n\r\nViewportWindowLevel.propTypes = {\r\n  servicesManager: PropTypes.object.isRequired,\r\n  viewportId: PropTypes.string.isRequired,\r\n};\r\n\r\nexport default ViewportWindowLevel;\r\n","import { getWebWorkerManager } from '@cornerstonejs/core';\r\n\r\nconst workerManager = getWebWorkerManager();\r\n\r\nconst WorkerOptions = {\r\n  maxWorkerInstances: 1,\r\n  autoTerminateOnIdle: {\r\n    enabled: true,\r\n    idleTimeThreshold: 1000,\r\n  },\r\n};\r\n\r\n// Register the task\r\nconst workerFn = () => {\r\n  return new Worker(new URL('./histogramWorker.js', import.meta.url), {\r\n    name: 'histogram-worker', // name used by the browser to name the worker\r\n  });\r\n};\r\n\r\nconst getViewportVolumeHistogram = async (viewport, volume, options?) => {\r\n  workerManager.registerWorker('histogram-worker', workerFn, WorkerOptions);\r\n\r\n  const volumeImageData = viewport.getImageData(volume.volumeId);\r\n\r\n  if (!volumeImageData) {\r\n    return undefined;\r\n  }\r\n\r\n  let scalarData = volume.scalarData;\r\n\r\n  if (volume.numTimePoints > 1) {\r\n    const targetTimePoint = volume.numTimePoints - 1; // or any other time point you need\r\n    scalarData = volume.voxelManager.getTimePointScalarData(targetTimePoint);\r\n  } else {\r\n    scalarData = volume.voxelManager.getCompleteScalarDataArray();\r\n  }\r\n\r\n  if (!scalarData?.length) {\r\n    return undefined;\r\n  }\r\n\r\n  const { dimensions, origin, direction, spacing } = volume;\r\n\r\n  const range = await workerManager.executeTask('histogram-worker', 'getRange', {\r\n    dimensions,\r\n    origin,\r\n    direction,\r\n    spacing,\r\n    scalarData,\r\n  });\r\n\r\n  const { minimum: min, maximum: max } = range;\r\n\r\n  if (min === Infinity || max === -Infinity) {\r\n    return undefined;\r\n  }\r\n\r\n  const calcHistOptions = {\r\n    numBins: 256,\r\n    min: Math.max(min, options?.min ?? min),\r\n    max: Math.min(max, options?.max ?? max),\r\n  };\r\n\r\n  const histogram = await workerManager.executeTask('histogram-worker', 'calcHistogram', {\r\n    data: scalarData,\r\n    options: calcHistOptions,\r\n  });\r\n\r\n  return histogram;\r\n};\r\n\r\nexport { getViewportVolumeHistogram };\r\n","import { cache as cs3DCache, Types } from '@cornerstonejs/core';\r\nimport vtkColorMaps from '@kitware/vtk.js/Rendering/Core/ColorTransferFunction/ColorMaps';\r\nimport { utilities as csUtils } from '@cornerstonejs/core';\r\nimport { getViewportVolumeHistogram } from './getViewportVolumeHistogram';\r\n\r\n/**\r\n * Gets node opacity from volume actor\r\n */\r\nexport const getNodeOpacity = (volumeActor, nodeIndex) => {\r\n  const volumeOpacity = volumeActor.getProperty().getScalarOpacity(0);\r\n  const nodeValue = [];\r\n\r\n  volumeOpacity.getNodeValue(nodeIndex, nodeValue);\r\n\r\n  return nodeValue[1];\r\n};\r\n\r\n/**\r\n * Checks if the opacity applied to the PET volume follows a specific pattern\r\n */\r\nexport const isPetVolumeWithDefaultOpacity = (volumeId: string, volumeActor) => {\r\n  const volume = cs3DCache.getVolume(volumeId);\r\n\r\n  if (!volume || volume.metadata.Modality !== 'PT') {\r\n    return false;\r\n  }\r\n\r\n  const volumeOpacity = volumeActor.getProperty().getScalarOpacity(0);\r\n\r\n  if (volumeOpacity.getSize() < 2) {\r\n    return false;\r\n  }\r\n\r\n  const node1Value = [];\r\n  const node2Value = [];\r\n\r\n  volumeOpacity.getNodeValue(0, node1Value);\r\n  volumeOpacity.getNodeValue(1, node2Value);\r\n\r\n  if (node1Value[0] !== 0 || node1Value[1] !== 0 || node2Value[0] !== 0.1) {\r\n    return false;\r\n  }\r\n\r\n  const expectedOpacity = node2Value[1];\r\n  const opacitySize = volumeOpacity.getSize();\r\n  const currentNodeValue = [];\r\n\r\n  for (let i = 2; i < opacitySize; i++) {\r\n    volumeOpacity.getNodeValue(i, currentNodeValue);\r\n    if (currentNodeValue[1] !== expectedOpacity) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  return true;\r\n};\r\n\r\n/**\r\n * Checks if volume has constant opacity\r\n */\r\nexport const isVolumeWithConstantOpacity = volumeActor => {\r\n  const volumeOpacity = volumeActor.getProperty().getScalarOpacity(0);\r\n  const opacitySize = volumeOpacity.getSize();\r\n  const firstNodeValue = [];\r\n\r\n  volumeOpacity.getNodeValue(0, firstNodeValue);\r\n  const firstNodeOpacity = firstNodeValue[1];\r\n\r\n  for (let i = 0; i < opacitySize; i++) {\r\n    const currentNodeValue = [];\r\n    volumeOpacity.getNodeValue(0, currentNodeValue);\r\n    if (currentNodeValue[1] !== firstNodeOpacity) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  return true;\r\n};\r\n\r\n/**\r\n * Gets window levels data for a viewport\r\n */\r\nexport const getWindowLevelsData = async (\r\n  viewport: Types.IStackViewport | Types.IVolumeViewport,\r\n  viewportInfo: any,\r\n  getVolumeOpacity: (viewport: any, volumeId: string) => number | undefined\r\n) => {\r\n  if (!viewport) {\r\n    return [];\r\n  }\r\n\r\n  const volumeIds = (viewport as Types.IBaseVolumeViewport).getAllVolumeIds();\r\n  const viewportProperties = viewport.getProperties();\r\n  const { voiRange } = viewportProperties;\r\n  const viewportVoi = voiRange\r\n    ? {\r\n        windowWidth: voiRange.upper - voiRange.lower,\r\n        windowCenter: voiRange.lower + (voiRange.upper - voiRange.lower) / 2,\r\n      }\r\n    : undefined;\r\n\r\n  const windowLevels = await Promise.all(\r\n    volumeIds.map(async (volumeId, volumeIndex) => {\r\n      const volume = cs3DCache.getVolume(volumeId);\r\n\r\n      const opacity = getVolumeOpacity(viewport, volumeId);\r\n      const { metadata, scaling } = volume;\r\n      const modality = metadata.Modality;\r\n\r\n      const options = {\r\n        min: modality === 'PT' ? 0.1 : -999,\r\n        max: modality === 'PT' ? 5 : 10000,\r\n      };\r\n\r\n      const histogram = await getViewportVolumeHistogram(viewport, volume, options);\r\n\r\n      if (!histogram || histogram.range.min === histogram.range.max) {\r\n        return null;\r\n      }\r\n\r\n      if (!viewportInfo.displaySetOptions || !viewportInfo.displaySetOptions[volumeIndex]) {\r\n        return null;\r\n      }\r\n\r\n      const { voi: displaySetVOI, colormap: displaySetColormap } =\r\n        viewportInfo.displaySetOptions[volumeIndex];\r\n\r\n      let colormap;\r\n      if (displaySetColormap) {\r\n        colormap =\r\n          csUtils.colormap.getColormap(displaySetColormap.name) ??\r\n          vtkColorMaps.getPresetByName(displaySetColormap.name);\r\n      }\r\n\r\n      const voi = !volumeIndex ? (viewportVoi ?? displaySetVOI) : displaySetVOI;\r\n\r\n      return {\r\n        viewportId: viewportInfo.viewportId,\r\n        modality,\r\n        volumeId,\r\n        volumeIndex,\r\n        voi,\r\n        histogram,\r\n        colormap,\r\n        step: scaling?.PT ? 0.05 : 1,\r\n        opacity,\r\n        showOpacitySlider: volumeIndex === 1 && opacity !== undefined,\r\n      };\r\n    })\r\n  );\r\n\r\n  return windowLevels.filter(Boolean);\r\n};\r\n","import React, { ReactElement, useCallback } from 'react';\r\nimport { Switch } from '@ohif/ui-next';\r\nimport { useViewportRendering } from '../../hooks/useViewportRendering';\r\n\r\nexport function Colorbar({ viewportId }: { viewportId?: string } = {}): ReactElement {\r\n  const { hasColorbar, toggleColorbar } = useViewportRendering(viewportId);\r\n\r\n  const handleToggle = useCallback(() => {\r\n    toggleColorbar();\r\n  }, [toggleColorbar]);\r\n\r\n  return (\r\n    <div className=\"hover:bg-accent flex h-8 w-full flex-shrink-0 cursor-pointer items-center px-2 text-base hover:rounded\">\r\n      <div className=\"flex w-7 flex-shrink-0 items-center justify-center\"></div>\r\n      <span\r\n        className=\"flex-grow\"\r\n        onClick={handleToggle}\r\n      >\r\n        Display Color bar\r\n      </span>\r\n      <Switch\r\n        className=\"ml-2 flex-shrink-0\"\r\n        checked={!!hasColorbar}\r\n        onCheckedChange={handleToggle}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n","import React, { ReactElement, useEffect, useRef, useState } from 'react';\r\nimport { AllInOneMenu, ScrollArea, Switch, Tabs, TabsList, TabsTrigger } from '@ohif/ui-next';\r\nimport { useViewportRendering } from '../../hooks/useViewportRendering';\r\n\r\nexport function Colormap({ viewportId }: { viewportId?: string } = {}): ReactElement {\r\n  const { viewportDisplaySets } = useViewportRendering(viewportId);\r\n\r\n  const [activeDisplaySetUID, setActiveDisplaySetUID] = useState<string | undefined>(\r\n    viewportDisplaySets?.[0]?.displaySetInstanceUID\r\n  );\r\n\r\n  // Use the hook with the active display set\r\n  const { colorbarProperties, setColormap } = useViewportRendering(viewportId, {\r\n    displaySetInstanceUID: activeDisplaySetUID,\r\n  });\r\n\r\n  const { colormaps } = colorbarProperties;\r\n\r\n  const [showPreview, setShowPreview] = useState(false);\r\n  const [prePreviewColormap, setPrePreviewColormap] = useState(null);\r\n  const [currentColormap, setCurrentColormap] = useState(null);\r\n\r\n  const showPreviewRef = useRef(showPreview);\r\n  showPreviewRef.current = showPreview;\r\n  const prePreviewColormapRef = useRef(prePreviewColormap);\r\n  prePreviewColormapRef.current = prePreviewColormap;\r\n  const currentColormapRef = useRef(currentColormap);\r\n  currentColormapRef.current = currentColormap;\r\n\r\n  useEffect(() => {\r\n    setCurrentColormap(null);\r\n    setPrePreviewColormap(null);\r\n  }, [activeDisplaySetUID]);\r\n\r\n  const handleSetColorLUT = (colormap, immediate = true) => {\r\n    // Check if it's a fusion viewport\r\n    const oneOpacityColormaps = ['Grayscale', 'X Ray'];\r\n    const opacity =\r\n      viewportDisplaySets.length > 1 && !oneOpacityColormaps.includes(colormap.name) ? 0.5 : 1;\r\n\r\n    setColormap({\r\n      colormap,\r\n      opacity,\r\n      immediate,\r\n    });\r\n  };\r\n\r\n  return (\r\n    <>\r\n      {viewportDisplaySets && viewportDisplaySets.length > 1 && (\r\n        <div className=\"flex h-8 w-full flex-shrink-0 items-center justify-center px-2 text-base\">\r\n          <Tabs\r\n            value={activeDisplaySetUID}\r\n            onValueChange={displaySetUID => {\r\n              setActiveDisplaySetUID(displaySetUID);\r\n              setPrePreviewColormap(null);\r\n            }}\r\n          >\r\n            <TabsList>\r\n              {viewportDisplaySets.map(ds => (\r\n                <TabsTrigger\r\n                  key={ds.displaySetInstanceUID}\r\n                  value={ds.displaySetInstanceUID}\r\n                >\r\n                  {ds.Modality}\r\n                </TabsTrigger>\r\n              ))}\r\n            </TabsList>\r\n          </Tabs>\r\n        </div>\r\n      )}\r\n\r\n      <div\r\n        className=\"hover:bg-accent flex h-8 w-full flex-shrink-0 cursor-pointer items-center px-2 text-base hover:rounded\"\r\n        onClick={() => setShowPreview(!showPreview)}\r\n      >\r\n        <span className=\"flex-shrink-0\">Preview in viewport</span>\r\n        <Switch\r\n          className=\"ml-auto flex-shrink-0\"\r\n          checked={showPreview}\r\n          onCheckedChange={checked => {\r\n            setShowPreview(checked);\r\n\r\n            if (!checked && currentColormapRef.current) {\r\n              handleSetColorLUT(currentColormapRef.current);\r\n            }\r\n          }}\r\n        />\r\n      </div>\r\n\r\n      <AllInOneMenu.DividerItem />\r\n\r\n      <div className=\"h-[300px] flex-grow\">\r\n        <ScrollArea className=\"h-full w-full\">\r\n          <div className=\"p-1\">\r\n            {colormaps.map((colormap, index) => (\r\n              <AllInOneMenu.Item\r\n                key={index}\r\n                label={colormap.description}\r\n                useIconSpace={false}\r\n                onClick={() => {\r\n                  setCurrentColormap(colormap);\r\n                  handleSetColorLUT(colormap);\r\n                  setPrePreviewColormap(null);\r\n                }}\r\n                onMouseEnter={() => {\r\n                  if (showPreviewRef.current) {\r\n                    if (!prePreviewColormapRef.current) {\r\n                      setPrePreviewColormap(colormap);\r\n                    }\r\n                    handleSetColorLUT(colormap);\r\n                  }\r\n                }}\r\n                onMouseLeave={() => {\r\n                  if (showPreviewRef.current && prePreviewColormapRef.current) {\r\n                    handleSetColorLUT(prePreviewColormapRef.current);\r\n                  }\r\n                }}\r\n              />\r\n            ))}\r\n          </div>\r\n        </ScrollArea>\r\n      </div>\r\n    </>\r\n  );\r\n}\r\n","import React, { ReactElement, useState, useEffect, useCallback } from 'react';\r\nimport { VolumeLightingProps } from '../../types/ViewportPresets';\r\nimport { Numeric } from '@ohif/ui-next';\r\nimport { useSystem } from '@ohif/core';\r\n\r\nexport function VolumeLighting({ viewportId, hasShade }: VolumeLightingProps): ReactElement {\r\n  const { servicesManager, commandsManager } = useSystem();\r\n  const { cornerstoneViewportService } = servicesManager.services;\r\n  const [lightingValues, setLightingValues] = useState({\r\n    ambient: null,\r\n    diffuse: null,\r\n    specular: null,\r\n  });\r\n\r\n  // Single callback to handle all lighting property changes\r\n  const onLightingChange = useCallback(\r\n    (property, value) => {\r\n      commandsManager.runCommand('setVolumeLighting', {\r\n        viewportId,\r\n        options: { [property]: value },\r\n      });\r\n      setLightingValues(prev => ({\r\n        ...prev,\r\n        [property]: value,\r\n      }));\r\n    },\r\n    [commandsManager, viewportId]\r\n  );\r\n\r\n  useEffect(() => {\r\n    const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n    const { actor } = viewport.getActors()[0];\r\n    const property = actor.getProperty();\r\n\r\n    const values = {\r\n      ambient: property.getAmbient(),\r\n      diffuse: property.getDiffuse(),\r\n      specular: property.getSpecular(),\r\n    };\r\n\r\n    setLightingValues(values);\r\n  }, [viewportId, cornerstoneViewportService]);\r\n\r\n  const disableOption = hasShade ? '' : 'ohif-disabled !opacity-40';\r\n\r\n  // Configuration for our lighting properties\r\n  const lightingProperties = [\r\n    { key: 'ambient', label: 'Ambient' },\r\n    { key: 'diffuse', label: 'Diffuse' },\r\n    { key: 'specular', label: 'Specular' },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"my-1 mt-2 flex flex-col space-y-2\">\r\n      {lightingProperties.map(\r\n        ({ key, label }) =>\r\n          lightingValues[key] !== null && (\r\n            <div\r\n              key={key}\r\n              className={`w-full pl-2 pr-1 ${disableOption}`}\r\n            >\r\n              <Numeric.Container\r\n                mode=\"singleRange\"\r\n                min={0}\r\n                max={1}\r\n                step={0.1}\r\n                value={lightingValues[key]}\r\n                onChange={value => onLightingChange(key, value)}\r\n              >\r\n                <div className=\"flex flex-row items-center\">\r\n                  <Numeric.Label className=\"w-16\">{label}</Numeric.Label>\r\n                  <Numeric.SingleRange sliderClassName=\"mx-2 flex-grow\" />\r\n                </div>\r\n              </Numeric.Container>\r\n            </div>\r\n          )\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","import React, { ReactElement, useState } from 'react';\r\nimport { AllInOneMenu } from '@ohif/ui-next';\r\nimport { VolumeRenderingQuality } from './VolumeRenderingQuality';\r\nimport { VolumeShift } from './VolumeShift';\r\nimport { VolumeLighting } from './VolumeLighting';\r\nimport { VolumeShade } from './VolumeShade';\r\nimport { useViewportRendering } from '../../hooks/useViewportRendering';\r\n\r\nexport function VolumeRenderingOptions({ viewportId }: { viewportId?: string } = {}): ReactElement {\r\n  const { volumeRenderingQualityRange } = useViewportRendering(viewportId);\r\n  const [hasShade, setShade] = useState(false);\r\n  return (\r\n    <AllInOneMenu.ItemPanel>\r\n      <VolumeRenderingQuality\r\n        viewportId={viewportId}\r\n        volumeRenderingQualityRange={volumeRenderingQualityRange}\r\n      />\r\n      <VolumeShift viewportId={viewportId} />\r\n      <div className=\"mt-2 flex h-8 !h-[20px] w-full flex-shrink-0 items-center justify-start px-2 text-base\">\r\n        <div className=\"text-muted-foreground text-sm\">Lighting</div>\r\n      </div>\r\n      <div className=\"bg-background mt-1 mb-1 h-px w-full\"></div>\r\n      <div className=\"hover:bg-accent flex h-8 w-full flex-shrink-0 items-center px-2 text-base hover:rounded\">\r\n        <VolumeShade\r\n          viewportId={viewportId}\r\n          onClickShade={setShade}\r\n        />\r\n      </div>\r\n      <VolumeLighting\r\n        viewportId={viewportId}\r\n        hasShade={hasShade}\r\n      />\r\n    </AllInOneMenu.ItemPanel>\r\n  );\r\n}\r\n","import { AllInOneMenu } from '@ohif/ui-next';\r\nimport { Icons } from '@ohif/ui-next';\r\nimport React, { ReactElement } from 'react';\r\nimport { VolumeRenderingPresetsContent } from './VolumeRenderingPresetsContent';\r\nimport { useSystem } from '@ohif/core';\r\nimport { useViewportRendering } from '../../hooks/useViewportRendering';\r\n\r\nexport function VolumeRenderingPresets({ viewportId }: { viewportId?: string } = {}): ReactElement {\r\n  const { volumeRenderingPresets } = useViewportRendering(viewportId);\r\n  const { servicesManager } = useSystem();\r\n  const { uiDialogService } = servicesManager.services;\r\n\r\n  const onClickPresets = () => {\r\n    uiDialogService.show({\r\n      id: 'volume-rendering-presets',\r\n      content: VolumeRenderingPresetsContent,\r\n      title: 'Rendering Presets',\r\n      isDraggable: true,\r\n      contentProps: {\r\n        presets: volumeRenderingPresets,\r\n        viewportId,\r\n      },\r\n    });\r\n  };\r\n\r\n  return (\r\n    <AllInOneMenu.Item\r\n      label=\"Rendering Presets\"\r\n      icon={<Icons.VolumeRendering />}\r\n      rightIcon={<Icons.ByName name=\"action-new-dialog\" />}\r\n      onClick={onClickPresets}\r\n    />\r\n  );\r\n}\r\n","import { Icons, FooterAction } from '@ohif/ui-next';\r\nimport React, { ReactElement, useState, useCallback } from 'react';\r\nimport { PresetDialog } from '@ohif/ui-next';\r\nimport { ViewportPreset, VolumeRenderingPresetsContentProps } from '../../types/ViewportPresets';\r\nimport { useSystem } from '@ohif/core';\r\n\r\ninterface Props extends VolumeRenderingPresetsContentProps {\r\n  hide: () => void;\r\n}\r\n\r\nexport function VolumeRenderingPresetsContent({ presets, viewportId, hide }: Props): ReactElement {\r\n  const { commandsManager } = useSystem();\r\n  const [searchValue, setSearchValue] = useState('');\r\n  const [selectedPreset, setSelectedPreset] = useState<ViewportPreset | null>(null);\r\n\r\n  const handleSearchChange = useCallback((event: React.ChangeEvent<HTMLInputElement>) => {\r\n    setSearchValue(event.target.value);\r\n  }, []);\r\n\r\n  const handleApply = useCallback(\r\n    props => {\r\n      commandsManager.runCommand('setViewportPreset', {\r\n        ...props,\r\n      });\r\n    },\r\n    [commandsManager]\r\n  );\r\n\r\n  const filteredPresets = searchValue\r\n    ? presets.filter(preset => preset.name.toLowerCase().includes(searchValue.toLowerCase()))\r\n    : presets;\r\n\r\n  const formatLabel = (label: string, maxChars: number) => {\r\n    return label.length > maxChars ? `${label.slice(0, maxChars)}...` : label;\r\n  };\r\n\r\n  return (\r\n    <PresetDialog className=\"h-[500px]\">\r\n      <PresetDialog.PresetBody>\r\n        <PresetDialog.PresetFilter>\r\n          <PresetDialog.PresetSearch\r\n            value={searchValue}\r\n            onChange={handleSearchChange}\r\n            placeholder=\"Search all\"\r\n          />\r\n        </PresetDialog.PresetFilter>\r\n        <PresetDialog.PresetGrid>\r\n          {filteredPresets.map((preset, index) => (\r\n            <div\r\n              key={index}\r\n              className=\"flex cursor-pointer flex-col items-start\"\r\n              onClick={() => {\r\n                setSelectedPreset(preset);\r\n                handleApply({ preset: preset.name, viewportId });\r\n              }}\r\n            >\r\n              <Icons.ByName\r\n                name={preset.name}\r\n                className={\r\n                  selectedPreset?.name === preset.name\r\n                    ? 'border-highlight h-[75px] w-[95px] max-w-none rounded border-2'\r\n                    : 'hover:border-highlight h-[75px] w-[95px] max-w-none rounded border-2 border-black'\r\n                }\r\n              />\r\n              <label className=\"text-muted-foreground mt-1 text-left text-xs\">\r\n                {formatLabel(preset.name, 11)}\r\n              </label>\r\n            </div>\r\n          ))}\r\n        </PresetDialog.PresetGrid>\r\n      </PresetDialog.PresetBody>\r\n      <FooterAction className=\"mt-4 flex-shrink-0\">\r\n        <FooterAction.Right>\r\n          <FooterAction.Secondary onClick={hide}>Cancel</FooterAction.Secondary>\r\n        </FooterAction.Right>\r\n      </FooterAction>\r\n    </PresetDialog>\r\n  );\r\n}\r\n","import React, { ReactElement, useCallback, useState, useEffect } from 'react';\r\nimport { VolumeRenderingQualityProps } from '../../types/ViewportPresets';\r\nimport { Numeric } from '@ohif/ui-next';\r\nimport { useSystem } from '@ohif/core';\r\n\r\nexport function VolumeRenderingQuality({\r\n  volumeRenderingQualityRange,\r\n  viewportId,\r\n}: VolumeRenderingQualityProps): ReactElement {\r\n  const { servicesManager, commandsManager } = useSystem();\r\n  const { cornerstoneViewportService } = servicesManager.services;\r\n  const { min, max, step } = volumeRenderingQualityRange;\r\n  const [quality, setQuality] = useState(null);\r\n\r\n  const onChange = useCallback(\r\n    (value: number) => {\r\n      commandsManager.runCommand('setVolumeRenderingQulaity', {\r\n        viewportId,\r\n        volumeQuality: value,\r\n      });\r\n      setQuality(value);\r\n    },\r\n    [commandsManager, viewportId]\r\n  );\r\n\r\n  useEffect(() => {\r\n    const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n    const { actor } = viewport.getActors()[0];\r\n    const mapper = actor.getMapper();\r\n    const image = mapper.getInputData();\r\n    const spacing = image.getSpacing();\r\n    const sampleDistance = mapper.getSampleDistance();\r\n    const averageSpacing = spacing.reduce((a, b) => a + b) / 3.0;\r\n    if (sampleDistance === averageSpacing) {\r\n      setQuality(1);\r\n    } else {\r\n      setQuality(Math.sqrt(averageSpacing / (sampleDistance * 0.5)));\r\n    }\r\n  }, [cornerstoneViewportService, viewportId]);\r\n\r\n  return (\r\n    <div className=\"my-1 mt-2 flex flex-col space-y-2\">\r\n      {quality !== null && (\r\n        <div className=\"w-full pl-2 pr-1\">\r\n          <Numeric.Container\r\n            mode=\"singleRange\"\r\n            min={min}\r\n            max={max}\r\n            step={step}\r\n            value={quality}\r\n            onChange={onChange}\r\n          >\r\n            <div className=\"flex flex-row items-center\">\r\n              <Numeric.Label className=\"w-16\">Quality</Numeric.Label>\r\n              <Numeric.SingleRange sliderClassName=\"mx-2 flex-grow\" />\r\n            </div>\r\n          </Numeric.Container>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","import React, { ReactElement, useCallback, useEffect, useState } from 'react';\r\nimport { Switch } from '@ohif/ui-next';\r\nimport { VolumeShadeProps } from '../../types/ViewportPresets';\r\nimport { useSystem } from '@ohif/core';\r\n\r\nexport function VolumeShade({\r\n  viewportId,\r\n  onClickShade = bool => {},\r\n}: VolumeShadeProps): ReactElement {\r\n  const { servicesManager, commandsManager } = useSystem();\r\n  const { cornerstoneViewportService } = servicesManager.services;\r\n  const [shade, setShade] = useState(true);\r\n  const [key, setKey] = useState(0);\r\n\r\n  const onShadeChange = useCallback(\r\n    (checked: boolean) => {\r\n      commandsManager.runCommand('setVolumeLighting', { viewportId, options: { shade: checked } });\r\n    },\r\n    [commandsManager, viewportId]\r\n  );\r\n  useEffect(() => {\r\n    const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n    const { actor } = viewport.getActors()[0];\r\n    const shade = actor.getProperty().getShade();\r\n    setShade(shade);\r\n    onClickShade(shade);\r\n    setKey(key + 1);\r\n  }, [viewportId, cornerstoneViewportService]);\r\n\r\n  return (\r\n    <>\r\n      <span className=\"flex-grow\">Shade</span>\r\n      <Switch\r\n        className=\"ml-2 flex-shrink-0\"\r\n        key={key}\r\n        checked={shade}\r\n        onCheckedChange={() => {\r\n          setShade(!shade);\r\n          onClickShade(!shade);\r\n          onShadeChange(!shade);\r\n        }}\r\n      />\r\n    </>\r\n  );\r\n}\r\n","import React, { ReactElement, useCallback, useEffect, useState, useRef } from 'react';\r\nimport { VolumeShiftProps } from '../../types/ViewportPresets';\r\nimport { Numeric } from '@ohif/ui-next';\r\nimport { useSystem } from '@ohif/core';\r\n\r\nexport function VolumeShift({ viewportId }: VolumeShiftProps): ReactElement {\r\n  const { servicesManager, commandsManager } = useSystem();\r\n  const { cornerstoneViewportService } = servicesManager.services;\r\n  const [minShift, setMinShift] = useState<number | null>(null);\r\n  const [maxShift, setMaxShift] = useState<number | null>(null);\r\n  const [shift, setShift] = useState<number | null>(\r\n    cornerstoneViewportService.getCornerstoneViewport(viewportId)?.shiftedBy || 0\r\n  );\r\n  const [step, setStep] = useState<number | null>(null);\r\n  const [isBlocking, setIsBlocking] = useState(false);\r\n\r\n  const prevShiftRef = useRef<number>(shift);\r\n\r\n  const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n  const { actor } = viewport.getActors()[0];\r\n  const ofun = actor.getProperty().getScalarOpacity(0);\r\n\r\n  useEffect(() => {\r\n    if (isBlocking) {\r\n      return;\r\n    }\r\n    const range = ofun.getRange();\r\n\r\n    const transferFunctionWidth = range[1] - range[0];\r\n\r\n    const minShift = -transferFunctionWidth;\r\n    const maxShift = transferFunctionWidth;\r\n\r\n    setMinShift(minShift);\r\n    setMaxShift(maxShift);\r\n    setStep(Math.pow(10, Math.floor(Math.log10(transferFunctionWidth / 500))));\r\n  }, [cornerstoneViewportService, viewportId, actor, ofun, isBlocking]);\r\n\r\n  const onChangeRange = useCallback(\r\n    newShift => {\r\n      const shiftDifference = newShift - prevShiftRef.current;\r\n      prevShiftRef.current = newShift;\r\n      viewport.shiftedBy = newShift;\r\n      commandsManager.runCommand('shiftVolumeOpacityPoints', {\r\n        viewportId,\r\n        shift: shiftDifference,\r\n      });\r\n      setShift(newShift);\r\n    },\r\n    [commandsManager, viewportId, viewport]\r\n  );\r\n\r\n  return (\r\n    <div className=\"my-1 mt-2 flex flex-col space-y-2\">\r\n      {step !== null && minShift !== null && maxShift !== null && (\r\n        <div className=\"w-full pl-2 pr-1\">\r\n          <Numeric.Container\r\n            mode=\"singleRange\"\r\n            min={minShift}\r\n            max={maxShift}\r\n            step={step}\r\n            value={shift}\r\n            onChange={onChangeRange}\r\n            onMouseDown={() => setIsBlocking(true)}\r\n            onMouseUp={() => setIsBlocking(false)}\r\n          >\r\n            <div className=\"flex flex-row items-center\">\r\n              <Numeric.Label className=\"w-16\">Shift</Numeric.Label>\r\n              <Numeric.SingleRange sliderClassName=\"mx-2 flex-grow\" />\r\n            </div>\r\n          </Numeric.Container>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","import React, { ReactElement, useEffect, useRef, useState } from 'react';\r\nimport { AllInOneMenu, ScrollArea, Switch, Tabs, TabsList, TabsTrigger } from '@ohif/ui-next';\r\nimport { useViewportRendering } from '../../hooks/useViewportRendering';\r\nimport { WindowLevelPreset } from '../../types/WindowLevel';\r\n\r\nexport function WindowLevel({ viewportId }: { viewportId?: string } = {}): ReactElement {\r\n  const { viewportDisplaySets } = useViewportRendering(viewportId);\r\n  const [activeDisplaySetUID, setActiveDisplaySetUID] = useState<string | undefined>(\r\n    viewportDisplaySets?.[0]?.displaySetInstanceUID\r\n  );\r\n\r\n  // Use the hook with the active display set\r\n  const { windowLevelPresets, setWindowLevel } = useViewportRendering(viewportId, {\r\n    displaySetInstanceUID: activeDisplaySetUID,\r\n  });\r\n\r\n  const [showPreview, setShowPreview] = useState(false);\r\n  const [prePreviewPreset, setPrePreviewPreset] = useState<WindowLevelPreset | null>(null);\r\n  const [currentPreset, setCurrentPreset] = useState<WindowLevelPreset | null>(null);\r\n\r\n  const showPreviewRef = useRef(showPreview);\r\n  showPreviewRef.current = showPreview;\r\n  const prePreviewPresetRef = useRef(prePreviewPreset);\r\n  prePreviewPresetRef.current = prePreviewPreset;\r\n  const currentPresetRef = useRef(currentPreset);\r\n  currentPresetRef.current = currentPreset;\r\n\r\n  // Reset presets when active display set changes\r\n  useEffect(() => {\r\n    setCurrentPreset(null);\r\n    setPrePreviewPreset(null);\r\n  }, [activeDisplaySetUID]);\r\n\r\n  // Handle applying window level preset\r\n  const handleSetWindowLevel = (preset: WindowLevelPreset, immediate = false) => {\r\n    setWindowLevel({\r\n      windowWidth: Number(preset.window),\r\n      windowCenter: Number(preset.level),\r\n      immediate,\r\n    });\r\n  };\r\n\r\n  return (\r\n    <>\r\n      {viewportDisplaySets && viewportDisplaySets.length > 1 && (\r\n        <div className=\"flex h-8 w-full flex-shrink-0 items-center justify-center px-2 text-base\">\r\n          <Tabs\r\n            value={activeDisplaySetUID}\r\n            onValueChange={displaySetUID => {\r\n              setActiveDisplaySetUID(displaySetUID);\r\n            }}\r\n          >\r\n            <TabsList>\r\n              {viewportDisplaySets.map(ds => (\r\n                <TabsTrigger\r\n                  key={ds.displaySetInstanceUID}\r\n                  value={ds.displaySetInstanceUID}\r\n                >\r\n                  {ds.Modality}\r\n                </TabsTrigger>\r\n              ))}\r\n            </TabsList>\r\n          </Tabs>\r\n        </div>\r\n      )}\r\n\r\n      <div\r\n        className=\"hover:bg-accent flex h-8 w-full flex-shrink-0 cursor-pointer items-center px-2 text-base hover:rounded\"\r\n        onClick={() => setShowPreview(!showPreview)}\r\n      >\r\n        <span className=\"flex-shrink-0\">Preview in viewport</span>\r\n        <Switch\r\n          className=\"ml-auto flex-shrink-0\"\r\n          checked={showPreview}\r\n          onCheckedChange={checked => {\r\n            setShowPreview(checked);\r\n\r\n            // When turning off preview, restore the current preset if one exists\r\n            if (!checked && currentPresetRef.current) {\r\n              handleSetWindowLevel(currentPresetRef.current, true);\r\n            }\r\n          }}\r\n        />\r\n      </div>\r\n\r\n      <AllInOneMenu.DividerItem />\r\n\r\n      <div className=\"h-[175px] flex-grow\">\r\n        <ScrollArea className=\"h-full w-full\">\r\n          <div className=\"p-1\">\r\n            {windowLevelPresets.map((preset, index) => (\r\n              <AllInOneMenu.Item\r\n                key={index}\r\n                label={preset.description}\r\n                secondaryLabel={`${preset.window} / ${preset.level}`}\r\n                useIconSpace={false}\r\n                onClick={() => {\r\n                  setCurrentPreset(preset);\r\n                  handleSetWindowLevel(preset, true);\r\n                  setPrePreviewPreset(null);\r\n                }}\r\n                onMouseEnter={() => {\r\n                  if (showPreviewRef.current) {\r\n                    if (!prePreviewPresetRef.current) {\r\n                      setPrePreviewPreset(currentPresetRef.current || preset);\r\n                    }\r\n                    handleSetWindowLevel(preset, true);\r\n                  }\r\n                }}\r\n                onMouseLeave={() => {\r\n                  if (showPreviewRef.current && prePreviewPresetRef.current) {\r\n                    handleSetWindowLevel(prePreviewPresetRef.current, true);\r\n                  }\r\n                }}\r\n              />\r\n            ))}\r\n          </div>\r\n        </ScrollArea>\r\n      </div>\r\n    </>\r\n  );\r\n}\r\n","import React, { ReactElement, useMemo } from 'react';\r\nimport { useTranslation } from 'react-i18next';\r\nimport { AllInOneMenu } from '@ohif/ui-next';\r\nimport { Colormap } from './Colormap';\r\nimport { Colorbar } from './Colorbar';\r\nimport { WindowLevel } from './WindowLevel';\r\nimport { VolumeRenderingPresets } from './VolumeRenderingPresets';\r\nimport { VolumeRenderingOptions } from './VolumeRenderingOptions';\r\nimport { useViewportRendering } from '../../hooks/useViewportRendering';\r\n\r\nexport type WindowLevelActionMenuProps = {\r\n  viewportId: string;\r\n  element?: HTMLElement;\r\n  align?: 'start' | 'end' | 'center';\r\n  side?: 'top' | 'bottom' | 'left' | 'right';\r\n};\r\n\r\nexport function WindowLevelActionMenu({\r\n  viewportId,\r\n  element,\r\n  align,\r\n  side,\r\n}: WindowLevelActionMenuProps): ReactElement {\r\n  return (\r\n    <WindowLevelActionMenuContent\r\n      viewportId={viewportId}\r\n      align={align}\r\n      side={side}\r\n    />\r\n  );\r\n}\r\n\r\nexport function WindowLevelActionMenuContent({\r\n  viewportId,\r\n  align,\r\n  side,\r\n}: {\r\n  viewportId: string;\r\n  align?: string;\r\n  side?: string;\r\n}): ReactElement {\r\n  const { t } = useTranslation('WindowLevelActionMenu');\r\n  // Use a stable key for the menu to avoid infinite re-renders\r\n  const menuKey = useMemo(() => `${viewportId}`, [viewportId]);\r\n\r\n  const {\r\n    is3DVolume,\r\n    colorbarProperties,\r\n    windowLevelPresets,\r\n    volumeRenderingPresets,\r\n    volumeRenderingQualityRange,\r\n  } = useViewportRendering(viewportId);\r\n\r\n  return (\r\n    <AllInOneMenu.Menu\r\n      key={menuKey}\r\n      // the visibility is handled by the parent component\r\n      isVisible={true}\r\n      align={align}\r\n      side={side}\r\n    >\r\n      <AllInOneMenu.ItemPanel>\r\n        {!is3DVolume && <Colorbar viewportId={viewportId} />}\r\n\r\n        {colorbarProperties?.colormaps && !is3DVolume && (\r\n          <AllInOneMenu.SubMenu\r\n            key=\"colorLUTPresets\"\r\n            itemLabel=\"Color LUT\"\r\n            itemIcon=\"icon-color-lut\"\r\n            className=\"flex h-[calc(100%-32px)] flex-col\"\r\n          >\r\n            <Colormap viewportId={viewportId} />\r\n          </AllInOneMenu.SubMenu>\r\n        )}\r\n\r\n        {windowLevelPresets?.length > 0 && !is3DVolume && (\r\n          <AllInOneMenu.SubMenu\r\n            key=\"windowLevelPresets\"\r\n            itemLabel={t('Modality Window Presets')}\r\n            itemIcon=\"viewport-window-level\"\r\n          >\r\n            <WindowLevel viewportId={viewportId} />\r\n          </AllInOneMenu.SubMenu>\r\n        )}\r\n\r\n        {volumeRenderingPresets && is3DVolume && <VolumeRenderingPresets viewportId={viewportId} />}\r\n\r\n        {volumeRenderingQualityRange && is3DVolume && (\r\n          <AllInOneMenu.SubMenu itemLabel=\"Rendering Options\">\r\n            <VolumeRenderingOptions viewportId={viewportId} />\r\n          </AllInOneMenu.SubMenu>\r\n        )}\r\n      </AllInOneMenu.ItemPanel>\r\n    </AllInOneMenu.Menu>\r\n  );\r\n}\r\n","import React, { ReactNode } from 'react';\r\nimport { useSystem } from '@ohif/core';\r\nimport {\r\n  Button,\r\n  Icons,\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverTrigger,\r\n  useViewportGrid,\r\n  useIconPresentation,\r\n} from '@ohif/ui-next';\r\nimport { WindowLevelActionMenu } from './WindowLevelActionMenu';\r\nimport { useViewportDisplaySets } from '../../hooks/useViewportDisplaySets';\r\nimport { useViewportRendering } from '../../hooks';\r\n\r\nexport function WindowLevelActionMenuWrapper(\r\n  props: withAppTypes<{\r\n    viewportId: string;\r\n    element?: HTMLElement;\r\n    location?: number;\r\n    isOpen?: boolean;\r\n    onOpen?: () => void;\r\n    onClose?: () => void;\r\n    displaySets?: Array<AppTypes.DisplaySet>;\r\n    disabled?: boolean;\r\n    isEmbedded?: boolean;\r\n  }>\r\n): ReactNode {\r\n  const {\r\n    viewportId,\r\n    element,\r\n    location,\r\n    isOpen = false,\r\n    onOpen,\r\n    onClose,\r\n    disabled,\r\n    isEmbedded = false,\r\n    onInteraction: onInteractionProps,\r\n    hasEmbeddedVariantToUse,\r\n    ...rest\r\n  } = props;\r\n\r\n  const [gridState] = useViewportGrid();\r\n  const viewportIdToUse = viewportId || gridState.activeViewportId;\r\n\r\n  const { viewportDisplaySets: displaySets } = useViewportDisplaySets(viewportIdToUse);\r\n  const { servicesManager } = useSystem();\r\n  const { toolbarService } = servicesManager.services;\r\n  const { IconContainer, className: iconClassName, containerProps } = useIconPresentation();\r\n  const { hasColorbar, toggleColorbar } = useViewportRendering(viewportId);\r\n\r\n  const handleOpenChange = (openState: boolean) => {\r\n    const shouldToggleColorbar = hasColorbar && !isEmbedded;\r\n\r\n    if (isOpen && shouldToggleColorbar && openState) {\r\n      toggleColorbar();\r\n      onClose?.();\r\n      return;\r\n    }\r\n\r\n    if (!isOpen && openState && shouldToggleColorbar) {\r\n      toggleColorbar();\r\n      return;\r\n    }\r\n\r\n    if (openState) {\r\n      onOpen?.();\r\n    } else {\r\n      onClose?.();\r\n    }\r\n  };\r\n\r\n  const { align, side } = toolbarService.getAlignAndSide(location);\r\n\r\n  const modalities = displaySets.map(displaySet => displaySet.supportsWindowLevel);\r\n\r\n  if (modalities.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  const Icon =\r\n    hasColorbar && !isEmbedded && hasEmbeddedVariantToUse ? (\r\n      <Icons.Close className={iconClassName} />\r\n    ) : (\r\n      <Icons.ViewportWindowLevel className={iconClassName} />\r\n    );\r\n\r\n  return (\r\n    <Popover\r\n      open={isOpen}\r\n      onOpenChange={handleOpenChange}\r\n    >\r\n      <PopoverTrigger\r\n        asChild\r\n        className=\"flex items-center justify-center\"\r\n      >\r\n        <div>\r\n          {IconContainer ? (\r\n            <IconContainer\r\n              disabled={disabled}\r\n              {...rest}\r\n              {...containerProps}\r\n            >\r\n              {Icon}\r\n            </IconContainer>\r\n          ) : (\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              disabled={disabled}\r\n            >\r\n              {Icon}\r\n            </Button>\r\n          )}\r\n        </div>\r\n      </PopoverTrigger>\r\n      <PopoverContent\r\n        className=\"border-none bg-transparent p-0 shadow-none\"\r\n        side={side}\r\n        align={align}\r\n        alignOffset={0}\r\n        sideOffset={5}\r\n      >\r\n        <WindowLevelActionMenu\r\n          viewportId={viewportIdToUse}\r\n          element={element}\r\n          align={align}\r\n          side={side}\r\n        />\r\n      </PopoverContent>\r\n    </Popover>\r\n  );\r\n}\r\n","// The following are the default window level presets and can be further\r\n// configured via the customization service.\r\nconst defaultWindowLevelPresets = {\r\n  CT: [\r\n    { id: 'ct-soft-tissue', description: 'Soft tissue', window: '400', level: '40' },\r\n    { id: 'ct-lung', description: 'Lung', window: '1500', level: '-600' },\r\n    { id: 'ct-liver', description: 'Liver', window: '150', level: '90' },\r\n    { id: 'ct-bone', description: 'Bone', window: '2500', level: '480' },\r\n    { id: 'ct-brain', description: 'Brain', window: '80', level: '40' },\r\n  ],\r\n\r\n  PT: [\r\n    { id: 'pt-default', description: 'Default', window: '5', level: '2.5' },\r\n    { id: 'pt-suv-3', description: 'SUV', window: '0', level: '3' },\r\n    { id: 'pt-suv-5', description: 'SUV', window: '0', level: '5' },\r\n    { id: 'pt-suv-7', description: 'SUV', window: '0', level: '7' },\r\n    { id: 'pt-suv-8', description: 'SUV', window: '0', level: '8' },\r\n    { id: 'pt-suv-10', description: 'SUV', window: '0', level: '10' },\r\n    { id: 'pt-suv-15', description: 'SUV', window: '0', level: '15' },\r\n  ],\r\n};\r\n\r\nexport default defaultWindowLevelPresets;\r\n","export * from './Colorbar';\r\nexport * from './Colormap';\r\nexport * from './WindowLevel';\r\nexport * from './WindowLevelActionMenu';\r\nexport * from './WindowLevelActionMenuWrapper';\r\nexport * from './VolumeRenderingOptions';\r\nexport * from './VolumeRenderingPresets';\r\nexport * from './VolumeRenderingQuality';\r\nexport * from './VolumeLighting';\r\nexport * from './VolumeShade';\r\nexport * from './VolumeShift';\r\n","import DicomUpload from './DicomUpload/DicomUpload';\r\nexport * from './AccordionGroup';\r\nexport * from './MeasurementTableNested';\r\nexport * from './StudyMeasurements';\r\nexport * from './MeasurementsMenu';\r\nexport * from './SeriesMeasurements';\r\nexport * from './StudyMeasurementsActions';\r\nexport * from './MeasurementsOrAdditionalFindings';\r\nexport * from './WindowLevelActionMenu';\r\nexport * from './ModalityLoadBadge';\r\n\r\nexport { DicomUpload };\r\n","// Volume loader schemes\r\nexport const VOLUME_LOADER_SCHEME = 'cornerstoneStreamingImageVolume';\r\nexport const DYNAMIC_VOLUME_LOADER_SCHEME = 'cornerstoneStreamingDynamicImageVolume';","import React from 'react';\r\nimport {\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuLabel,\r\n  DropdownMenuPortal,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuSub,\r\n  DropdownMenuSubTrigger,\r\n  DropdownMenuSubContent,\r\n  Icons,\r\n  useSegmentationTableContext,\r\n  useSegmentationExpanded,\r\n} from '@ohif/ui-next';\r\nimport { useTranslation } from 'react-i18next';\r\nimport { useSystem } from '@ohif/core/src';\r\n\r\n/**\r\n * Custom dropdown menu component for segmentation panel that uses context for data\r\n */\r\nexport const CustomDropdownMenuContent = () => {\r\n  const { commandsManager } = useSystem();\r\n  const { t } = useTranslation('SegmentationTable');\r\n  const {\r\n    onSegmentationAdd,\r\n    onSegmentationRemoveFromViewport,\r\n    onSegmentationEdit,\r\n    onSegmentationDelete,\r\n    exportOptions,\r\n    activeSegmentation,\r\n    activeSegmentationId,\r\n  } = useSegmentationTableContext('CustomDropdownMenu');\r\n\r\n  // Try to get segmentation data from expanded context first, fall back to table context\r\n  let segmentation;\r\n  let segmentationId;\r\n  let allowExport = false;\r\n\r\n  try {\r\n    // Try to get from expanded context\r\n    const context = useSegmentationExpanded();\r\n    segmentation = context.segmentation;\r\n    segmentationId = segmentation.segmentationId;\r\n  } catch (e) {\r\n    // If not in expanded context, fallback to active segmentation from table context\r\n    segmentation = activeSegmentation;\r\n    segmentationId = activeSegmentationId;\r\n  }\r\n\r\n  // Determine if export is allowed for this segmentation\r\n  if (exportOptions && segmentationId) {\r\n    const exportOption = exportOptions.find(opt => opt.segmentationId === segmentationId);\r\n    allowExport = exportOption?.isExportable || false;\r\n  }\r\n\r\n  if (!segmentation || !segmentationId) {\r\n    return null;\r\n  }\r\n\r\n  const actions = {\r\n    storeSegmentation: async segmentationId => {\r\n      commandsManager.run({\r\n        commandName: 'storeSegmentation',\r\n        commandOptions: { segmentationId },\r\n        context: 'CORNERSTONE',\r\n      });\r\n    },\r\n    onSegmentationDownloadRTSS: segmentationId => {\r\n      commandsManager.run('downloadRTSS', { segmentationId });\r\n    },\r\n    onSegmentationDownload: segmentationId => {\r\n      commandsManager.run('downloadSegmentation', { segmentationId });\r\n    },\r\n    downloadCSVSegmentationReport: segmentationId => {\r\n      commandsManager.run('downloadCSVSegmentationReport', { segmentationId });\r\n    },\r\n  };\r\n\r\n  return (\r\n    <DropdownMenuContent align=\"start\">\r\n      <DropdownMenuItem onClick={() => onSegmentationAdd(segmentationId)}>\r\n        <Icons.Add className=\"text-foreground\" />\r\n        <span className=\"pl-2\">{t('Create New Segmentation')}</span>\r\n      </DropdownMenuItem>\r\n      <DropdownMenuSeparator />\r\n      <DropdownMenuLabel>{t('Manage Current Segmentation')}</DropdownMenuLabel>\r\n      <DropdownMenuItem onClick={() => onSegmentationRemoveFromViewport(segmentationId)}>\r\n        <Icons.Series className=\"text-foreground\" />\r\n        <span className=\"pl-2\">{t('Remove from Viewport')}</span>\r\n      </DropdownMenuItem>\r\n      <DropdownMenuItem onClick={() => onSegmentationEdit(segmentationId)}>\r\n        <Icons.Rename className=\"text-foreground\" />\r\n        <span className=\"pl-2\">{t('Rename')}</span>\r\n      </DropdownMenuItem>\r\n      <DropdownMenuSub>\r\n        <DropdownMenuSubTrigger className=\"pl-1\">\r\n          <Icons.Export className=\"text-foreground\" />\r\n          <span className=\"pl-2\">{t('Download & Export')}</span>\r\n        </DropdownMenuSubTrigger>\r\n        <DropdownMenuPortal>\r\n          <DropdownMenuSubContent>\r\n            <DropdownMenuLabel className=\"flex items-center pl-0\">\r\n              <Icons.Download className=\"h-5 w-5\" />\r\n              <span className=\"pl-1\">{t('Download')}</span>\r\n            </DropdownMenuLabel>\r\n            <DropdownMenuItem\r\n              onClick={e => {\r\n                e.preventDefault();\r\n                actions.downloadCSVSegmentationReport(segmentationId);\r\n              }}\r\n            >\r\n              {t('CSV Report')}\r\n            </DropdownMenuItem>\r\n            <DropdownMenuItem\r\n              onClick={e => {\r\n                e.preventDefault();\r\n                actions.onSegmentationDownload(segmentationId);\r\n              }}\r\n              disabled={!allowExport}\r\n            >\r\n              {t('DICOM SEG')}\r\n            </DropdownMenuItem>\r\n            <DropdownMenuItem\r\n              onClick={e => {\r\n                e.preventDefault();\r\n                actions.onSegmentationDownloadRTSS(segmentationId);\r\n              }}\r\n              disabled={!allowExport}\r\n            >\r\n              {t('DICOM RTSS')}\r\n            </DropdownMenuItem>\r\n            <DropdownMenuSeparator />\r\n            <DropdownMenuLabel className=\"flex items-center pl-0\">\r\n              <Icons.Export className=\"h-5 w-5\" />\r\n              <span className=\"pl-1 pt-1\">{t('Export')}</span>\r\n            </DropdownMenuLabel>\r\n            <DropdownMenuItem\r\n              onClick={e => {\r\n                e.preventDefault();\r\n                actions.storeSegmentation(segmentationId);\r\n              }}\r\n              disabled={!allowExport}\r\n            >\r\n              {t('DICOM SEG')}\r\n            </DropdownMenuItem>\r\n          </DropdownMenuSubContent>\r\n        </DropdownMenuPortal>\r\n      </DropdownMenuSub>\r\n      <DropdownMenuSeparator />\r\n      <DropdownMenuItem onClick={() => onSegmentationDelete(segmentationId)}>\r\n        <Icons.Delete className=\"text-red-600\" />\r\n        <span className=\"pl-2 text-red-600\">{t('Delete')}</span>\r\n      </DropdownMenuItem>\r\n    </DropdownMenuContent>\r\n  );\r\n};\r\n","import * as cornerstoneTools from '@cornerstonejs/tools';\r\nimport React from 'react';\r\nimport { Separator, Button, Tooltip, TooltipTrigger, TooltipContent, Icons } from '@ohif/ui-next';\r\nimport { useTranslation } from 'react-i18next';\r\nimport { roundNumber } from '@ohif/core/src/utils';\r\nimport { useSystem } from '@ohif/core/src';\r\n\r\ninterface CustomSegmentStatisticsHeaderProps {\r\n  segmentationId: string;\r\n  segmentIndex: number;\r\n}\r\n\r\n/**\r\n * Custom header component for segment statistics\r\n */\r\nexport const CustomSegmentStatisticsHeader = ({\r\n  segmentationId,\r\n  segmentIndex,\r\n}: CustomSegmentStatisticsHeaderProps) => {\r\n  const { servicesManager, commandsManager } = useSystem();\r\n  const { segmentationService } = servicesManager.services;\r\n  const { t } = useTranslation('SegmentationTable');\r\n\r\n  const segmentation = segmentationService.getSegmentation(segmentationId);\r\n  const segment = segmentation.segments[segmentIndex];\r\n  const cachedStats = segment.cachedStats;\r\n  const namedStats = cachedStats.namedStats;\r\n\r\n  if (!namedStats) {\r\n    return null;\r\n  }\r\n\r\n  const bidirectional = namedStats.bidirectional;\r\n\r\n  if (!bidirectional) {\r\n    return (\r\n      <div className=\"-mt-2 space-y-2\">\r\n        <div className=\"flex\">\r\n          <Tooltip>\r\n            <TooltipTrigger asChild>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"text-primary flex items-center gap-2\"\r\n                onClick={() => {\r\n                  commandsManager.run('runSegmentBidirectional', {\r\n                    segmentationId,\r\n                    segmentIndex,\r\n                  });\r\n                }}\r\n              >\r\n                <Icons.ToolBidirectionalSegment className=\"h-5 w-5\" />\r\n                <span>{t('Compute Largest Bidirectional')}</span>\r\n              </Button>\r\n            </TooltipTrigger>\r\n            <TooltipContent side=\"bottom\">{t('Add bidirectional measurement')}</TooltipContent>\r\n          </Tooltip>\r\n        </div>\r\n        <Separator className=\"bg-input\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const { value, unit } = bidirectional;\r\n  const maxMajor = value.maxMajor;\r\n  const maxMinor = value.maxMinor;\r\n\r\n  const max = Math.max(maxMajor, maxMinor);\r\n  const min = Math.min(maxMajor, maxMinor);\r\n\r\n  const isVisible = cornerstoneTools.annotation.visibility.isAnnotationVisible(\r\n    bidirectional.annotationUID\r\n  );\r\n\r\n  return (\r\n    <div className=\"-mt-2 space-y-2\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"text-foreground\">\r\n          <div>\r\n            L: {roundNumber(max)} {unit}\r\n          </div>\r\n          <div>\r\n            W: {roundNumber(min)} {unit}\r\n          </div>\r\n        </div>\r\n        <div className=\"flex gap-2\">\r\n          <Tooltip>\r\n            <TooltipTrigger asChild>\r\n              <Button\r\n                size=\"icon\"\r\n                variant=\"ghost\"\r\n                className={`h-6 w-6 transition-opacity`}\r\n                onClick={e => {\r\n                  e.stopPropagation();\r\n                  cornerstoneTools.annotation.visibility.setAnnotationVisibility(\r\n                    bidirectional.annotationUID,\r\n                    !isVisible\r\n                  );\r\n\r\n                  segmentationService.addOrUpdateSegmentation({\r\n                    segmentationId,\r\n                    segmentIndex,\r\n                  });\r\n                }}\r\n              >\r\n                {isVisible ? (\r\n                  <Icons.Hide className=\"h-6 w-6\" />\r\n                ) : (\r\n                  <Icons.Show className=\"h-6 w-6\" />\r\n                )}\r\n              </Button>\r\n            </TooltipTrigger>\r\n            <TooltipContent side=\"bottom\">{t('Toggle visibility')}</TooltipContent>\r\n          </Tooltip>\r\n          <Tooltip>\r\n            <TooltipTrigger asChild>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"icon\"\r\n                onClick={() => {\r\n                  if (bidirectional.annotationUID) {\r\n                    commandsManager.run('jumpToMeasurement', {\r\n                      uid: bidirectional.annotationUID,\r\n                    });\r\n                  }\r\n                }}\r\n              >\r\n                <Icons.JumpToSlice />\r\n              </Button>\r\n            </TooltipTrigger>\r\n            <TooltipContent side=\"bottom\">{t('Jump to measurement')}</TooltipContent>\r\n          </Tooltip>\r\n        </div>\r\n      </div>\r\n      <Separator className=\"bg-input\" />\r\n    </div>\r\n  );\r\n};\r\n","import React, { useState, useEffect } from 'react';\r\nimport { ImageModal, FooterAction } from '@ohif/ui-next';\r\n\r\nconst MAX_TEXTURE_SIZE = 10000;\r\nconst DEFAULT_FILENAME = 'image';\r\n\r\ninterface ViewportDownloadFormNewProps {\r\n  onClose: () => void;\r\n  defaultSize: number;\r\n  fileTypeOptions: Array<{ value: string; label: string }>;\r\n  viewportId: string;\r\n  showAnnotations: boolean;\r\n  onAnnotationsChange: (show: boolean) => void;\r\n  dimensions: { width: number; height: number };\r\n  onDimensionsChange: (dimensions: { width: number; height: number }) => void;\r\n  onEnableViewport: (element: HTMLElement) => void;\r\n  onDisableViewport: () => void;\r\n  onDownload: (filename: string, fileType: string) => void;\r\n  warningState: { enabled: boolean; value: string };\r\n}\r\n\r\nfunction ViewportDownloadFormNew({\r\n  onClose,\r\n  defaultSize,\r\n  fileTypeOptions,\r\n  viewportId,\r\n  showAnnotations,\r\n  onAnnotationsChange,\r\n  dimensions,\r\n  warningState,\r\n  onDimensionsChange,\r\n  onEnableViewport,\r\n  onDisableViewport,\r\n  onDownload,\r\n}: ViewportDownloadFormNewProps) {\r\n  const [viewportElement, setViewportElement] = useState<HTMLElement | null>(null);\r\n  const [showWarningMessage, setShowWarningMessage] = useState(true);\r\n  const [filename, setFilename] = useState(DEFAULT_FILENAME);\r\n  const [fileType, setFileType] = useState('jpg');\r\n\r\n  useEffect(() => {\r\n    if (!viewportElement) {\r\n      return;\r\n    }\r\n\r\n    onEnableViewport(viewportElement);\r\n\r\n    return () => {\r\n      onDisableViewport();\r\n    };\r\n  }, [onDisableViewport, onEnableViewport, viewportElement]);\r\n\r\n  return (\r\n    <ImageModal>\r\n      <ImageModal.Body>\r\n        <ImageModal.ImageVisual>\r\n          <div\r\n            style={{\r\n              height: dimensions.height,\r\n              width: dimensions.width,\r\n              position: 'relative',\r\n            }}\r\n            data-viewport-uid={viewportId}\r\n            ref={setViewportElement}\r\n          >\r\n            {warningState.enabled && showWarningMessage && (\r\n              <div\r\n                className=\"text-foreground absolute left-1/2 bottom-[5px] z-[1000] -translate-x-1/2 whitespace-nowrap rounded bg-black p-3 text-xs font-bold\"\r\n                style={{\r\n                  fontSize: '12px',\r\n                }}\r\n              >\r\n                {warningState.value}\r\n              </div>\r\n            )}\r\n          </div>\r\n        </ImageModal.ImageVisual>\r\n\r\n        <ImageModal.ImageOptions>\r\n          <div className=\"flex items-end space-x-2\">\r\n            <ImageModal.Filename\r\n              value={filename}\r\n              onChange={e => setFilename(e.target.value)}\r\n            >\r\n              File name\r\n            </ImageModal.Filename>\r\n            <ImageModal.Filetype\r\n              selected={fileType}\r\n              onSelect={setFileType}\r\n              options={fileTypeOptions}\r\n            />\r\n          </div>\r\n\r\n          <ImageModal.ImageSize\r\n            width={dimensions.width.toString()}\r\n            height={dimensions.height.toString()}\r\n            onWidthChange={e => {\r\n              onDimensionsChange({\r\n                ...dimensions,\r\n                width: parseInt(e.target.value) || defaultSize,\r\n              });\r\n            }}\r\n            onHeightChange={e => {\r\n              onDimensionsChange({\r\n                ...dimensions,\r\n                height: parseInt(e.target.value) || defaultSize,\r\n              });\r\n            }}\r\n            maxWidth={MAX_TEXTURE_SIZE.toString()}\r\n            maxHeight={MAX_TEXTURE_SIZE.toString()}\r\n          >\r\n            Image size <span className=\"text-muted-foreground\">px</span>\r\n          </ImageModal.ImageSize>\r\n\r\n          <ImageModal.SwitchOption\r\n            defaultChecked={showAnnotations}\r\n            checked={showAnnotations}\r\n            onCheckedChange={onAnnotationsChange}\r\n          >\r\n            Include annotations\r\n          </ImageModal.SwitchOption>\r\n          {warningState.enabled && (\r\n            <ImageModal.SwitchOption\r\n              defaultChecked={showWarningMessage}\r\n              checked={showWarningMessage}\r\n              onCheckedChange={setShowWarningMessage}\r\n            >\r\n              Include warning message\r\n            </ImageModal.SwitchOption>\r\n          )}\r\n          <FooterAction className=\"mt-2\">\r\n            <FooterAction.Right>\r\n              <FooterAction.Secondary onClick={onClose}>Cancel</FooterAction.Secondary>\r\n              <FooterAction.Primary\r\n                onClick={() => {\r\n                  onDownload(filename || DEFAULT_FILENAME, fileType);\r\n                  onClose();\r\n                }}\r\n              >\r\n                Save\r\n              </FooterAction.Primary>\r\n            </FooterAction.Right>\r\n          </FooterAction>\r\n        </ImageModal.ImageOptions>\r\n      </ImageModal.Body>\r\n    </ImageModal>\r\n  );\r\n}\r\n\r\nexport default {\r\n  'ohif.captureViewportModal': ViewportDownloadFormNew,\r\n};\r\n","import { colormaps } from '../utils/colormaps';\r\nimport {\r\n  ColorbarPositionType,\r\n  TickPositionType,\r\n  PositionStylesMapType,\r\n  PositionTickStylesMapType,\r\n  ContainerStyleType,\r\n  TickStyleType,\r\n  ColorbarProperties,\r\n} from '../types/Colorbar';\r\nimport { ColorMapPreset } from '../types/Colormap';\r\n\r\nconst defaultPosition: ColorbarPositionType = 'bottom';\r\nconst DefaultColormap = 'Grayscale';\r\n\r\nconst positionStyles: PositionStylesMapType = {\r\n  left: { width: '15px' },\r\n  right: { width: '15px' },\r\n  bottom: { height: '15px' },\r\n};\r\n\r\n// Typed position-specific tick styles\r\nconst positionTickStyles: PositionTickStylesMapType = {\r\n  bottom: {\r\n    position: 'top',\r\n    style: {\r\n      labelOffset: 5,\r\n      labelMargin: 13,\r\n    },\r\n  },\r\n  right: {\r\n    position: 'left',\r\n    style: {\r\n      labelMargin: 5,\r\n    },\r\n  },\r\n  left: {\r\n    position: 'right',\r\n    style: {\r\n      labelMargin: 5,\r\n    },\r\n  },\r\n  top: {\r\n    position: 'bottom',\r\n    style: {\r\n      labelMargin: 5,\r\n    },\r\n  },\r\n};\r\n\r\n// Get recommended tick position for a given colorbar position\r\nconst getTickPositionForPosition = (position: ColorbarPositionType): TickPositionType => {\r\n  if (position === 'bottom') {\r\n    return 'top';\r\n  } else if (position === 'top') {\r\n    return 'bottom';\r\n  } else if (position === 'left') {\r\n    return 'right';\r\n  } else if (position === 'right') {\r\n    return 'left';\r\n  }\r\n\r\n  return positionTickStyles[position]?.position || 'top';\r\n};\r\n\r\n// Container styles for colorbar\r\nconst containerStyles: ContainerStyleType = {\r\n  cursor: 'initial',\r\n};\r\n\r\n// Tick styling\r\nconst tickStyles: TickStyleType = {\r\n  font: '12px Arial',\r\n  color: '#fff',\r\n  maxNumTicks: 6,\r\n  tickSize: 5,\r\n  tickWidth: 1,\r\n};\r\n\r\nconst colorbarConfig: Partial<ColorbarProperties> = {\r\n  colorbarTickPosition: getTickPositionForPosition(defaultPosition),\r\n  colormaps: colormaps as unknown as Record<string, ColorMapPreset>,\r\n  colorbarContainerPosition: defaultPosition,\r\n  colorbarInitialColormap: DefaultColormap,\r\n  positionStyles,\r\n  positionTickStyles,\r\n  containerStyles,\r\n  tickStyles,\r\n};\r\n\r\nexport default {\r\n  'cornerstone.colorbar': colorbarConfig,\r\n};\r\n","export default {\r\n  'layoutSelector.advancedPresetGenerator': ({\r\n    servicesManager,\r\n  }: {\r\n    servicesManager: AppTypes.ServicesManager;\r\n  }) => {\r\n    const _areSelectorsValid = (\r\n      hp: AppTypes.HangingProtocol.Protocol,\r\n      displaySets: AppTypes.DisplaySet[],\r\n      hangingProtocolService: AppTypes.HangingProtocolService\r\n    ) => {\r\n      if (!hp.displaySetSelectors || Object.values(hp.displaySetSelectors).length === 0) {\r\n        return true;\r\n      }\r\n\r\n      return hangingProtocolService.areRequiredSelectorsValid(\r\n        Object.values(hp.displaySetSelectors),\r\n        displaySets[0]\r\n      );\r\n    };\r\n\r\n    const generateAdvancedPresets = ({\r\n      servicesManager,\r\n    }: {\r\n      servicesManager: AppTypes.ServicesManager;\r\n    }) => {\r\n      const { hangingProtocolService, viewportGridService, displaySetService } =\r\n        servicesManager.services;\r\n\r\n      const hangingProtocols = Array.from(hangingProtocolService.protocols.values());\r\n\r\n      const viewportId = viewportGridService.getActiveViewportId();\r\n\r\n      if (!viewportId) {\r\n        return [];\r\n      }\r\n      const displaySetInsaneUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n\r\n      if (!displaySetInsaneUIDs) {\r\n        return [];\r\n      }\r\n\r\n      const displaySets = displaySetInsaneUIDs.map(uid =>\r\n        displaySetService.getDisplaySetByUID(uid)\r\n      );\r\n\r\n      return hangingProtocols\r\n        .map(hp => {\r\n          if (!hp.isPreset) {\r\n            return null;\r\n          }\r\n\r\n          const areValid = _areSelectorsValid(hp, displaySets, hangingProtocolService);\r\n\r\n          return {\r\n            icon: hp.icon,\r\n            title: hp.name,\r\n            commandOptions: {\r\n              protocolId: hp.id,\r\n            },\r\n            disabled: !areValid,\r\n          };\r\n        })\r\n        .filter(preset => preset !== null);\r\n    };\r\n\r\n    return generateAdvancedPresets({ servicesManager });\r\n  },\r\n  'layoutSelector.commonPresets': [\r\n    {\r\n      icon: 'layout-common-1x1',\r\n      commandOptions: {\r\n        numRows: 1,\r\n        numCols: 1,\r\n      },\r\n    },\r\n    {\r\n      icon: 'layout-common-1x2',\r\n      commandOptions: {\r\n        numRows: 1,\r\n        numCols: 2,\r\n      },\r\n    },\r\n    {\r\n      icon: 'layout-common-2x2',\r\n      commandOptions: {\r\n        numRows: 2,\r\n        numCols: 2,\r\n      },\r\n    },\r\n    {\r\n      icon: 'layout-common-2x3',\r\n      commandOptions: {\r\n        numRows: 2,\r\n        numCols: 3,\r\n      },\r\n    },\r\n  ],\r\n};\r\n","export default {\r\n  'cornerstone.measurements': {\r\n    Angle: {\r\n      displayText: [],\r\n      report: [],\r\n    },\r\n    CobbAngle: {\r\n      displayText: [],\r\n      report: [],\r\n    },\r\n    ArrowAnnotate: {\r\n      displayText: [],\r\n      report: [],\r\n    },\r\n    RectangleROi: {\r\n      displayText: [],\r\n      report: [],\r\n    },\r\n    CircleROI: {\r\n      displayText: [],\r\n      report: [],\r\n    },\r\n    EllipticalROI: {\r\n      displayText: [],\r\n      report: [],\r\n    },\r\n    Bidirectional: {\r\n      displayText: [],\r\n      report: [],\r\n    },\r\n    Length: {\r\n      displayText: [],\r\n      report: [],\r\n    },\r\n    LivewireContour: {\r\n      displayText: [],\r\n      report: [],\r\n    },\r\n    SplineROI: {\r\n      displayText: [\r\n        {\r\n          displayName: 'Areas',\r\n          value: 'area',\r\n          type: 'value',\r\n        },\r\n        {\r\n          value: 'areaUnits',\r\n          for: ['area'],\r\n          type: 'unit',\r\n        },\r\n      ],\r\n      report: [\r\n        {\r\n          displayName: 'Area',\r\n          value: 'area',\r\n          type: 'value',\r\n        },\r\n        {\r\n          displayName: 'Unit',\r\n          value: 'areaUnits',\r\n          type: 'value',\r\n        },\r\n      ],\r\n    },\r\n    PlanarFreehandROI: {\r\n      displayTextOpen: [\r\n        {\r\n          displayName: 'Length',\r\n          value: 'length',\r\n          type: 'value',\r\n        },\r\n      ],\r\n      displayText: [\r\n        {\r\n          displayName: 'Mean',\r\n          value: 'mean',\r\n          type: 'value',\r\n        },\r\n        {\r\n          displayName: 'Max',\r\n          value: 'max',\r\n          type: 'value',\r\n        },\r\n        {\r\n          displayName: 'Area',\r\n          value: 'area',\r\n          type: 'value',\r\n        },\r\n        {\r\n          value: 'pixelValueUnits',\r\n          for: ['mean', 'max'],\r\n          type: 'unit',\r\n        },\r\n        {\r\n          value: 'areaUnits',\r\n          for: ['area'],\r\n          type: 'unit',\r\n        },\r\n      ],\r\n      report: [\r\n        {\r\n          displayName: 'Mean',\r\n          value: 'mean',\r\n          type: 'value',\r\n        },\r\n        {\r\n          displayName: 'Max',\r\n          value: 'max',\r\n          type: 'value',\r\n        },\r\n        {\r\n          displayName: 'Area',\r\n          value: 'area',\r\n          type: 'value',\r\n        },\r\n        {\r\n          displayName: 'Unit',\r\n          value: 'unit',\r\n          type: 'value',\r\n        },\r\n      ],\r\n    },\r\n  },\r\n};\r\n","import { CinePlayer } from '@ohif/ui-next';\r\nimport DicomUpload from '../components/DicomUpload/DicomUpload';\r\n\r\nexport default {\r\n  cinePlayer: CinePlayer,\r\n  autoCineModalities: ['OT', 'US'],\r\n  'panelMeasurement.disableEditing': false,\r\n  onBeforeSRAddMeasurement: ({ measurement, StudyInstanceUID, SeriesInstanceUID }) => {\r\n    return measurement;\r\n  },\r\n  onBeforeDicomStore: ({ dicomDict, measurementData, naturalizedReport }) => {\r\n    return dicomDict;\r\n  },\r\n  dicomUploadComponent: DicomUpload,\r\n  codingValues: {},\r\n};\r\n","export default {\r\n  'cornerstone.modalityOverlayDefaultColorMaps': {\r\n    defaultSettings: {\r\n      PT: {\r\n        colormap: 'hsv',\r\n        // Note: Right now, there is a nonlinear relationship between the opacity value\r\n        // below and how it will get applied to the image. The limitation is in rendering.\r\n        // We are working on this and will remove this note when it's fixed.\r\n        // But don't expect 0.5 to be 50% opacity, but rather close to that.\r\n        opacity: 0.5,\r\n      },\r\n      RTDOSE: {\r\n        colormap: 'Isodose',\r\n        // Note: Right now, there is a nonlinear relationship between the opacity value\r\n        // below and how it will get applied to the image. The limitation is in rendering.\r\n        // We are working on this and will remove this note when it's fixed.\r\n        // But don't expect 0.5 to be 50% opacity, but rather close to that.\r\n\r\n        opacity: 0.5,\r\n      },\r\n    },\r\n  },\r\n};\r\n","import { CustomDropdownMenuContent } from './CustomDropdownMenuContent';\r\nimport { CustomSegmentStatisticsHeader } from './CustomSegmentStatisticsHeader';\r\nimport React, { useState } from 'react';\r\nimport { Switch } from '@ohif/ui-next';\r\n\r\nexport default function getSegmentationPanelCustomization({ commandsManager, servicesManager }) {\r\n  return {\r\n    'panelSegmentation.customDropdownMenuContent': CustomDropdownMenuContent,\r\n    'panelSegmentation.customSegmentStatisticsHeader': CustomSegmentStatisticsHeader,\r\n    'panelSegmentation.disableEditing': false,\r\n    'panelSegmentation.showAddSegment': true,\r\n    'panelSegmentation.onSegmentationAdd': () => {\r\n      const { viewportGridService } = servicesManager.services;\r\n      const viewportId = viewportGridService.getState().activeViewportId;\r\n      commandsManager.run('createLabelmapForViewport', { viewportId });\r\n    },\r\n    'panelSegmentation.tableMode': 'collapsed',\r\n    'panelSegmentation.readableText': {\r\n      // the values will appear in this order\r\n      min: 'Min Value',\r\n      minLPS: 'Min Coord',\r\n      max: 'Max Value',\r\n      maxLPS: 'Max Coord',\r\n      mean: 'Mean Value',\r\n      stdDev: 'Standard Deviation',\r\n      count: 'Voxel Count',\r\n      median: 'Median',\r\n      skewness: 'Skewness',\r\n      kurtosis: 'Kurtosis',\r\n      peakValue: 'Peak Value',\r\n      peakLPS: 'Peak Coord',\r\n      volume: 'Volume',\r\n      lesionGlycolysis: 'Lesion Glycolysis',\r\n      center: 'Center',\r\n    },\r\n    'segmentationToolbox.config': () => {\r\n      // Get initial states based on current configuration\r\n      const [previewEdits, setPreviewEdits] = useState(false);\r\n      const [toggleSegmentEnabled, setToggleSegmentEnabled] = useState(false);\r\n      const [useCenterAsSegmentIndex, setUseCenterAsSegmentIndex] = useState(false);\r\n      const handlePreviewEditsChange = checked => {\r\n        setPreviewEdits(checked);\r\n        commandsManager.run('toggleSegmentPreviewEdit', { toggle: checked });\r\n      };\r\n\r\n      const handleToggleSegmentEnabledChange = checked => {\r\n        setToggleSegmentEnabled(checked);\r\n        commandsManager.run('toggleSegmentSelect', { toggle: checked });\r\n      };\r\n\r\n      const handleUseCenterAsSegmentIndexChange = checked => {\r\n        setUseCenterAsSegmentIndex(checked);\r\n        commandsManager.run('toggleUseCenterSegmentIndex', { toggle: checked });\r\n      };\r\n\r\n      return (\r\n        <div className=\"bg-muted flex flex-col gap-4 border-b border-b-[2px] border-black px-2 py-3\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <Switch\r\n              checked={previewEdits}\r\n              onCheckedChange={handlePreviewEditsChange}\r\n            />\r\n            <span className=\"text-base text-white\">Preview edits before creating</span>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-2\">\r\n            <Switch\r\n              checked={useCenterAsSegmentIndex}\r\n              onCheckedChange={handleUseCenterAsSegmentIndexChange}\r\n            />\r\n            <span className=\"text-base text-white\">Use center as segment index</span>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-2\">\r\n            <Switch\r\n              checked={toggleSegmentEnabled}\r\n              onCheckedChange={handleToggleSegmentEnabledChange}\r\n            />\r\n            <span className=\"text-base text-white\">Hover on segment border to activate</span>\r\n          </div>\r\n        </div>\r\n      );\r\n    },\r\n  };\r\n}\r\n","export default {\r\n  cornerstoneViewportClickCommands: {\r\n    doubleClick: ['toggleOneUp'],\r\n    button1: ['closeContextMenu'],\r\n    button3: [\r\n      {\r\n        commandName: 'showCornerstoneContextMenu',\r\n        commandOptions: {\r\n          requireNearbyToolData: true,\r\n          menuId: 'measurementsContextMenu',\r\n        },\r\n      },\r\n    ],\r\n  },\r\n};\r\n","export default {\r\n  'viewportDownload.warningMessage': {\r\n    enabled: true,\r\n    value: 'Not For Diagnostic Use',\r\n  },\r\n};\r\n","export default {\r\n  'viewportOverlay.topLeft': [\r\n    {\r\n      id: 'StudyDate',\r\n      inheritsFrom: 'ohif.overlayItem',\r\n      label: '',\r\n      title: 'Study date',\r\n      condition: ({ referenceInstance }) => referenceInstance?.StudyDate,\r\n      contentF: ({ referenceInstance, formatters: { formatDate } }) =>\r\n        formatDate(referenceInstance.StudyDate),\r\n    },\r\n    {\r\n      id: 'SeriesDescription',\r\n      inheritsFrom: 'ohif.overlayItem',\r\n      label: '',\r\n      title: 'Series description',\r\n      condition: ({ referenceInstance }) => {\r\n        return referenceInstance && referenceInstance.SeriesDescription;\r\n      },\r\n      contentF: ({ referenceInstance }) => referenceInstance.SeriesDescription,\r\n    },\r\n  ],\r\n  'viewportOverlay.topRight': [],\r\n  'viewportOverlay.bottomLeft': [\r\n    {\r\n      id: 'WindowLevel',\r\n      inheritsFrom: 'ohif.overlayItem.windowLevel',\r\n    },\r\n    {\r\n      id: 'ZoomLevel',\r\n      inheritsFrom: 'ohif.overlayItem.zoomLevel',\r\n      condition: props => {\r\n        const activeToolName = props.toolGroupService.getActiveToolForViewport(props.viewportId);\r\n        return activeToolName === 'Zoom';\r\n      },\r\n    },\r\n  ],\r\n  'viewportOverlay.bottomRight': [\r\n    {\r\n      id: 'InstanceNumber',\r\n      inheritsFrom: 'ohif.overlayItem.instanceNumber',\r\n    },\r\n  ],\r\n};\r\n","import { Enums } from '@cornerstonejs/tools';\r\nimport { toolNames } from '../initCornerstoneTools';\r\n\r\nexport default {\r\n  'cornerstone.overlayViewportTools': {\r\n    active: [\r\n      {\r\n        toolName: toolNames.WindowLevel,\r\n        bindings: [{ mouseButton: Enums.MouseBindings.Primary }],\r\n      },\r\n      {\r\n        toolName: toolNames.Pan,\r\n        bindings: [{ mouseButton: Enums.MouseBindings.Auxiliary }],\r\n      },\r\n      {\r\n        toolName: toolNames.Zoom,\r\n        bindings: [{ mouseButton: Enums.MouseBindings.Secondary }, { numTouchPoints: 2 }],\r\n      },\r\n      {\r\n        toolName: toolNames.StackScroll,\r\n        bindings: [{ mouseButton: Enums.MouseBindings.Wheel }, { numTouchPoints: 3 }],\r\n      },\r\n    ],\r\n    enabled: [\r\n      {\r\n        toolName: toolNames.PlanarFreehandContourSegmentation,\r\n        configuration: {\r\n          displayOnePointAsCrosshairs: true,\r\n        },\r\n      },\r\n    ],\r\n  },\r\n};\r\n","import { CONSTANTS } from '@cornerstonejs/core';\r\n\r\nconst { VIEWPORT_PRESETS } = CONSTANTS;\r\n\r\nexport default {\r\n  'cornerstone.3dVolumeRendering': {\r\n    volumeRenderingPresets: VIEWPORT_PRESETS,\r\n    volumeRenderingQualityRange: {\r\n      min: 1,\r\n      max: 4,\r\n      step: 1,\r\n    },\r\n  },\r\n};\r\n","import defaultWindowLevelPresets from '../components/WindowLevelActionMenu/defaultWindowLevelPresets';\r\n\r\nexport default {\r\n  'cornerstone.windowLevelPresets': defaultWindowLevelPresets,\r\n};\r\n","export const CORNERSTONE_3D_TOOLS_SOURCE_NAME = 'Cornerstone3DTools';\r\nexport const CORNERSTONE_3D_TOOLS_SOURCE_VERSION = '0.1';\r\n\r\nconst Enums = {\r\n  CORNERSTONE_3D_TOOLS_SOURCE_NAME,\r\n  CORNERSTONE_3D_TOOLS_SOURCE_VERSION,\r\n};\r\n\r\nexport default Enums;\r\n","import viewportOverlayCustomization from './customizations/viewportOverlayCustomization';\r\nimport getSegmentationPanelCustomization from './customizations/segmentationPanelCustomization';\r\nimport layoutSelectorCustomization from './customizations/layoutSelectorCustomization';\r\nimport viewportToolsCustomization from './customizations/viewportToolsCustomization';\r\nimport viewportClickCommandsCustomization from './customizations/viewportClickCommandsCustomization';\r\nimport measurementsCustomization from './customizations/measurementsCustomization';\r\nimport volumeRenderingCustomization from './customizations/volumeRenderingCustomization';\r\nimport colorbarCustomization from './customizations/colorbarCustomization';\r\nimport modalityColorMapCustomization from './customizations/modalityColorMapCustomization';\r\nimport windowLevelPresetsCustomization from './customizations/windowLevelPresetsCustomization';\r\nimport miscCustomization from './customizations/miscCustomization';\r\nimport captureViewportModalCustomization from './customizations/captureViewportModalCustomization';\r\nimport viewportDownloadWarningCustomization from './customizations/viewportDownloadWarningCustomization';\r\n\r\nfunction getCustomizationModule({ commandsManager, servicesManager }) {\r\n  return [\r\n    {\r\n      name: 'default',\r\n      value: {\r\n        ...viewportOverlayCustomization,\r\n        ...getSegmentationPanelCustomization({ commandsManager, servicesManager }),\r\n        ...layoutSelectorCustomization,\r\n        ...viewportToolsCustomization,\r\n        ...viewportClickCommandsCustomization,\r\n        ...measurementsCustomization,\r\n        ...volumeRenderingCustomization,\r\n        ...colorbarCustomization,\r\n        ...modalityColorMapCustomization,\r\n        ...windowLevelPresetsCustomization,\r\n        ...miscCustomization,\r\n        ...captureViewportModalCustomization,\r\n        ...viewportDownloadWarningCustomization,\r\n      },\r\n    },\r\n  ];\r\n}\r\n\r\nexport default getCustomizationModule;\r\n","import { fourUp } from './hps/fourUp';\r\nimport { main3D } from './hps/main3D';\r\nimport { mpr } from './hps/mpr';\r\nimport { mprAnd3DVolumeViewport } from './hps/mprAnd3DVolumeViewport';\r\nimport { only3D } from './hps/only3D';\r\nimport { primary3D } from './hps/primary3D';\r\nimport { primaryAxial } from './hps/primaryAxial';\r\nimport { frameView } from './hps/frameView';\r\n\r\nfunction getHangingProtocolModule() {\r\n  return [\r\n    {\r\n      name: mpr.id,\r\n      protocol: mpr,\r\n    },\r\n    {\r\n      name: mprAnd3DVolumeViewport.id,\r\n      protocol: mprAnd3DVolumeViewport,\r\n    },\r\n    {\r\n      name: fourUp.id,\r\n      protocol: fourUp,\r\n    },\r\n    {\r\n      name: main3D.id,\r\n      protocol: main3D,\r\n    },\r\n    {\r\n      name: primaryAxial.id,\r\n      protocol: primaryAxial,\r\n    },\r\n    {\r\n      name: only3D.id,\r\n      protocol: only3D,\r\n    },\r\n    {\r\n      name: primary3D.id,\r\n      protocol: primary3D,\r\n    },\r\n    {\r\n      name: frameView.id,\r\n      protocol: frameView,\r\n    },\r\n  ];\r\n}\r\n\r\nexport default getHangingProtocolModule;\r\n","import React from 'react';\r\n\r\nimport { Toolbox } from '@ohif/extension-default';\r\nimport PanelSegmentation from './panels/PanelSegmentation';\r\nimport ActiveViewportWindowLevel from './components/ActiveViewportWindowLevel';\r\nimport PanelMeasurement from './panels/PanelMeasurement';\r\n\r\nconst getPanelModule = ({ commandsManager, servicesManager, extensionManager }: withAppTypes) => {\r\n  const wrappedPanelSegmentation = ({ configuration }) => {\r\n    return (\r\n      <PanelSegmentation\r\n        commandsManager={commandsManager}\r\n        servicesManager={servicesManager}\r\n        extensionManager={extensionManager}\r\n        configuration={{\r\n          ...configuration,\r\n        }}\r\n      />\r\n    );\r\n  };\r\n\r\n  const wrappedPanelSegmentationNoHeader = ({ configuration }) => {\r\n    return (\r\n      <PanelSegmentation\r\n        commandsManager={commandsManager}\r\n        servicesManager={servicesManager}\r\n        extensionManager={extensionManager}\r\n        configuration={{\r\n          ...configuration,\r\n        }}\r\n      />\r\n    );\r\n  };\r\n\r\n  const wrappedPanelSegmentationWithTools = ({ configuration }) => {\r\n    const { toolbarService } = servicesManager.services;\r\n\r\n    return (\r\n      <>\r\n        <Toolbox\r\n          buttonSectionId={toolbarService.sections.segmentationToolbox}\r\n          title=\"Segmentation Tools\"\r\n        />\r\n        <PanelSegmentation\r\n          commandsManager={commandsManager}\r\n          servicesManager={servicesManager}\r\n          extensionManager={extensionManager}\r\n          configuration={{\r\n            ...configuration,\r\n          }}\r\n        />\r\n      </>\r\n    );\r\n  };\r\n\r\n  return [\r\n    {\r\n      name: 'activeViewportWindowLevel',\r\n      component: () => {\r\n        return <ActiveViewportWindowLevel servicesManager={servicesManager} />;\r\n      },\r\n    },\r\n    {\r\n      name: 'panelMeasurement',\r\n      iconName: 'tab-linear',\r\n      iconLabel: 'Measure',\r\n      label: 'Measurement',\r\n      component: PanelMeasurement,\r\n    },\r\n    {\r\n      name: 'panelSegmentation',\r\n      iconName: 'tab-segmentation',\r\n      iconLabel: 'Segmentation',\r\n      label: 'Segmentation',\r\n      component: wrappedPanelSegmentation,\r\n    },\r\n    {\r\n      name: 'panelSegmentationNoHeader',\r\n      iconName: 'tab-segmentation',\r\n      iconLabel: 'Segmentation',\r\n      label: 'Segmentation',\r\n      component: wrappedPanelSegmentationNoHeader,\r\n    },\r\n    {\r\n      name: 'panelSegmentationWithTools',\r\n      iconName: 'tab-segmentation',\r\n      iconLabel: 'Segmentation',\r\n      label: 'Segmentation',\r\n      component: wrappedPanelSegmentationWithTools,\r\n    },\r\n  ];\r\n};\r\n\r\nexport default getPanelModule;\r\n","import OHIF from '@ohif/core';\r\nimport i18n from '@ohif/i18n';\r\nimport { utilities as csUtils, Enums as csEnums } from '@cornerstonejs/core';\r\nimport dcmjs from 'dcmjs';\r\nimport { dicomWebUtils } from '@ohif/extension-default';\r\n\r\nconst { MetadataModules } = csEnums;\r\nconst { utils } = OHIF;\r\nconst { denaturalizeDataset } = dcmjs.data.DicomMetaDictionary;\r\nconst { transferDenaturalizedDataset, fixMultiValueKeys } = dicomWebUtils;\r\n\r\nconst SOP_CLASS_UIDS = {\r\n  VL_WHOLE_SLIDE_MICROSCOPY_IMAGE_STORAGE: '1.2.840.10008.5.1.4.1.1.77.1.6',\r\n};\r\n\r\nconst SOPClassHandlerId =\r\n  '@ohif/extension-cornerstone.sopClassHandlerModule.DicomMicroscopySopClassHandler';\r\n\r\nfunction _getDisplaySetsFromSeries(instances, servicesManager, extensionManager) {\r\n  const dataSource = extensionManager.getActiveDataSource()[0];\r\n  // If the series has no instances, stop here\r\n  if (!instances || !instances.length) {\r\n    throw new Error('No instances were provided');\r\n  }\r\n\r\n  const instance = instances[0];\r\n\r\n  let singleFrameInstance = instance;\r\n  let currentFrames = +singleFrameInstance.NumberOfFrames || 1;\r\n  for (const instanceI of instances) {\r\n    const framesI = +instanceI.NumberOfFrames || 1;\r\n    if (framesI < currentFrames) {\r\n      singleFrameInstance = instanceI;\r\n      currentFrames = framesI;\r\n    }\r\n  }\r\n\r\n  const {\r\n    FrameOfReferenceUID,\r\n    SeriesDescription,\r\n    ContentDate,\r\n    ContentTime,\r\n    SeriesNumber,\r\n    StudyInstanceUID,\r\n    SeriesInstanceUID,\r\n    SOPInstanceUID,\r\n    SOPClassUID,\r\n  } = instance;\r\n\r\n  instances = instances.map(inst => {\r\n    // NOTE: According to DICOM standard a series should have a FrameOfReferenceUID\r\n    // When the Microscopy file was built by certain tool from multiple image files,\r\n    // each instance's FrameOfReferenceUID is sometimes different.\r\n    // Even though this means the file was not well formatted DICOM VL Whole Slide Microscopy Image,\r\n    // the case is so often, so let's override this value manually here.\r\n    //\r\n    // https://dicom.nema.org/medical/dicom/current/output/chtml/part03/sect_C.7.4.html#sect_C.7.4.1.1.1\r\n\r\n    inst.FrameOfReferenceUID = instance.FrameOfReferenceUID;\r\n\r\n    return inst;\r\n  });\r\n\r\n  const othersFrameOfReferenceUID = instances\r\n    .filter(v => v)\r\n    .map(inst => inst.FrameOfReferenceUID)\r\n    .filter((value, index, array) => array.indexOf(value) === index);\r\n  if (othersFrameOfReferenceUID.length > 1) {\r\n    console.warn(\r\n      'Expected FrameOfReferenceUID of difference instances within a series to be the same, found multiple different values',\r\n      othersFrameOfReferenceUID\r\n    );\r\n  }\r\n\r\n  const displaySet = {\r\n    plugin: 'microscopy',\r\n    Modality: 'SM',\r\n    viewportType: csEnums.ViewportType.WHOLE_SLIDE,\r\n    altImageText: 'Microscopy',\r\n    displaySetInstanceUID: utils.guid(),\r\n    SOPInstanceUID,\r\n    SeriesInstanceUID,\r\n    StudyInstanceUID,\r\n    FrameOfReferenceUID,\r\n    SOPClassHandlerId,\r\n    SOPClassUID,\r\n    SeriesDescription: SeriesDescription || 'Microscopy Data',\r\n    // Map ContentDate/Time to SeriesTime for series list sorting.\r\n    SeriesDate: ContentDate,\r\n    SeriesTime: ContentTime,\r\n    SeriesNumber,\r\n    firstInstance: singleFrameInstance, // top level instance in the image Pyramid\r\n    instance,\r\n    numImageFrames: 0,\r\n    numInstances: 1,\r\n    others: instances, // all other level instances in the image Pyramid\r\n    instances,\r\n    othersFrameOfReferenceUID,\r\n    imageIds: instances.map(instance => instance.imageId),\r\n    getThumbnailSrc: dataSource.retrieve.getGetThumbnailSrc?.(\r\n      singleFrameInstance,\r\n      singleFrameInstance.imageId\r\n    ),\r\n    label: SeriesDescription || `${i18n.t('Series')} ${SeriesNumber} - ${i18n.t('SM')}`,\r\n  };\r\n  // The microscopy viewer directly accesses the metadata already loaded, and\r\n  // uses the DICOMweb client library directly for loading, so it has to be\r\n  // provided here.\r\n  const dicomWebClient = dataSource.retrieve.getWadoDicomWebClient?.();\r\n  const instanceMap = new Map();\r\n  instances.forEach(instance => instanceMap.set(instance.imageId, instance));\r\n  if (dicomWebClient) {\r\n    const webClient = Object.create(dicomWebClient);\r\n    // This replaces just the dicom web metadata call with one which retrieves\r\n    // internally.\r\n    webClient.getDICOMwebMetadata = getDICOMwebMetadata.bind(webClient, instanceMap);\r\n\r\n    csUtils.genericMetadataProvider.addRaw(displaySet.imageIds[0], {\r\n      type: MetadataModules.WADO_WEB_CLIENT,\r\n      metadata: webClient,\r\n    });\r\n  } else {\r\n    // Might have some other way of getting the data in the future or internally?\r\n    // throw new Error('Unable to provide a DICOMWeb client library, microscopy will fail to view');\r\n  }\r\n\r\n  return [displaySet];\r\n}\r\n\r\n/**\r\n * This method provides access to the internal DICOMweb metadata, used to avoid\r\n * refetching the DICOMweb data.  It gets assigned as a member function to the\r\n * dicom web client.\r\n */\r\nfunction getDICOMwebMetadata(instanceMap, imageId) {\r\n  const instance = instanceMap.get(imageId);\r\n  if (!instance) {\r\n    console.warn('Metadata not already found for', imageId, 'in', instanceMap);\r\n    return this.super.getDICOMwebMetadata(imageId);\r\n  }\r\n  return transferDenaturalizedDataset(\r\n    denaturalizeDataset(fixMultiValueKeys(instanceMap.get(imageId)))\r\n  );\r\n}\r\n\r\nexport function getDicomMicroscopySopClassHandler({ servicesManager, extensionManager }) {\r\n  const getDisplaySetsFromSeries = instances => {\r\n    return _getDisplaySetsFromSeries(instances, servicesManager, extensionManager);\r\n  };\r\n\r\n  return {\r\n    name: 'DicomMicroscopySopClassHandler',\r\n    sopClassUids: [SOP_CLASS_UIDS.VL_WHOLE_SLIDE_MICROSCOPY_IMAGE_STORAGE],\r\n    getDisplaySetsFromSeries,\r\n  };\r\n}\r\n\r\nexport function getSopClassHandlerModule(params) {\r\n  return [getDicomMicroscopySopClassHandler(params)];\r\n}\r\n","import { Enums } from '@cornerstonejs/tools';\r\nimport { utils } from '@ohif/ui-next';\r\nimport { ViewportDataOverlayMenuWrapper } from './components/ViewportDataOverlaySettingMenu/ViewportDataOverlayMenuWrapper';\r\nimport { ViewportOrientationMenuWrapper } from './components/ViewportOrientationMenu/ViewportOrientationMenuWrapper';\r\nimport { WindowLevelActionMenuWrapper } from './components/WindowLevelActionMenu/WindowLevelActionMenuWrapper';\r\nimport { VOIManualControlMenuWrapper } from './components/VOIManualControlMenu';\r\nimport { ThresholdMenuWrapper } from './components/ThresholdMenu/ThresholdMenuWrapper';\r\nimport { OpacityMenuWrapper } from './components/OpacityMenu/OpacityMenuWrapper';\r\nimport ModalityLoadBadge from './components/ModalityLoadBadge/ModalityLoadBadge';\r\nimport NavigationComponent from './components/NavigationComponent/NavigationComponent';\r\nimport TrackingStatus from './components/TrackingStatus/TrackingStatus';\r\nimport ViewportColorbarsContainer from './components/ViewportColorbar';\r\nimport AdvancedRenderingControls from './components/AdvancedRenderingControls';\r\n\r\nconst getDisabledState = (disabledText?: string) => ({\r\n  disabled: true,\r\n  disabledText: disabledText ?? 'Not available on the current viewport',\r\n});\r\n\r\nexport default function getToolbarModule({ servicesManager, extensionManager }: withAppTypes) {\r\n  const {\r\n    toolGroupService,\r\n    toolbarService,\r\n    syncGroupService,\r\n    cornerstoneViewportService,\r\n    colorbarService,\r\n    displaySetService,\r\n    viewportGridService,\r\n    segmentationService,\r\n  } = servicesManager.services;\r\n\r\n  return [\r\n    {\r\n      name: 'ohif.advancedRenderingControls',\r\n      defaultComponent: AdvancedRenderingControls,\r\n    },\r\n    {\r\n      name: 'evaluate.advancedRenderingControls',\r\n      evaluate: ({ viewportId }) => {\r\n        const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n        if (!viewport) {\r\n          return {\r\n            disabled: true,\r\n          };\r\n        }\r\n\r\n        const hasColorbar = colorbarService?.hasColorbar(viewportId) || false;\r\n        return {\r\n          disabled: !hasColorbar,\r\n        };\r\n      },\r\n    },\r\n    {\r\n      name: 'ohif.colorbar',\r\n      defaultComponent: ViewportColorbarsContainer,\r\n    },\r\n    {\r\n      name: 'ohif.trackingStatus',\r\n      defaultComponent: TrackingStatus,\r\n    },\r\n    {\r\n      name: 'evaluate.trackingStatus',\r\n      evaluate: ({ viewportId }) => {\r\n        const displaySetUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n\r\n        if (!displaySetUIDs?.length) {\r\n          return {\r\n            disabled: true,\r\n          };\r\n        }\r\n\r\n        return {\r\n          disabled: false,\r\n        };\r\n      },\r\n    },\r\n    // ModalityLoadBadge\r\n    {\r\n      name: 'ohif.modalityLoadBadge',\r\n      defaultComponent: ModalityLoadBadge,\r\n    },\r\n    {\r\n      name: 'evaluate.modalityLoadBadge',\r\n      evaluate: ({ viewportId }) => {\r\n        // We can't use useViewportDisplaySets hook here since we're in a non-React context,\r\n        // but we'll follow the same pattern by getting only the display sets for this viewport\r\n        const displaySetUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n\r\n        if (!displaySetUIDs?.length) {\r\n          return {\r\n            disabled: true,\r\n          };\r\n        }\r\n\r\n        // Get the display sets that are specifically in this viewport\r\n        const viewportDisplaySets = displaySetUIDs.map(uid =>\r\n          displaySetService.getDisplaySetByUID(uid)\r\n        );\r\n\r\n        // Only show status for supported types like SR, SEG, RTSTRUCT\r\n        const isSupportedType = viewportDisplaySets.some(\r\n          displaySet =>\r\n            displaySet?.Modality === 'SR' ||\r\n            displaySet?.Modality === 'SEG' ||\r\n            displaySet?.Modality === 'RTSTRUCT'\r\n        );\r\n\r\n        return {\r\n          disabled: !isSupportedType,\r\n        };\r\n      },\r\n    },\r\n    // NavigationComponent\r\n    {\r\n      name: 'ohif.navigationComponent',\r\n      defaultComponent: NavigationComponent,\r\n    },\r\n    {\r\n      name: 'evaluate.navigationComponent',\r\n      evaluate: ({ viewportId }) => {\r\n        const { trackedMeasurementsService } = servicesManager.services;\r\n        // Same logic as statusComponent - only show for SR, SEG, RTSTRUCT\r\n        const displaySetUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n\r\n        if (!displaySetUIDs?.length) {\r\n          return {\r\n            disabled: true,\r\n          };\r\n        }\r\n\r\n        // Get the display sets that are specifically in this viewport\r\n        const viewportDisplaySets = displaySetUIDs.map(uid =>\r\n          displaySetService.getDisplaySetByUID(uid)\r\n        );\r\n\r\n        // Check if there's a need for navigation:\r\n        // 1. Segmentations are present (for SEG/RTSTRUCT navigation)\r\n        // 2. There are tracked measurements in the viewport (for SR navigation)\r\n\r\n        // Check for SEG/RTSTRUCT navigation\r\n        const hasSegmentation =\r\n          segmentationService.getSegmentationRepresentations(viewportId).length > 0;\r\n\r\n        if (!trackedMeasurementsService) {\r\n          return {\r\n            disabled: !hasSegmentation,\r\n          };\r\n        }\r\n\r\n        // Check if any of the viewport's series are being tracked\r\n        const hasTrackedInViewport = viewportDisplaySets.some(\r\n          displaySet =>\r\n            displaySet?.SeriesInstanceUID &&\r\n            trackedMeasurementsService.isSeriesTracked(displaySet.SeriesInstanceUID)\r\n        );\r\n\r\n        const isSRDisplaySet = viewportDisplaySets.some(\r\n          displaySet => displaySet?.Modality === 'SR'\r\n        );\r\n\r\n        // Enable navigation if:\r\n        // - There's a segmentation to navigate (SEG/RTSTRUCT)\r\n        // - OR there are tracked measurements in the viewport (SR/etc.)\r\n        const needsNavigation = hasSegmentation || hasTrackedInViewport || isSRDisplaySet;\r\n\r\n        return {\r\n          disabled: !needsNavigation,\r\n        };\r\n      },\r\n    },\r\n    {\r\n      name: 'ohif.dataOverlayMenu',\r\n      defaultComponent: ViewportDataOverlayMenuWrapper,\r\n    },\r\n    {\r\n      name: 'evaluate.dataOverlayMenu',\r\n      evaluate: ({ viewportId }) => {\r\n        const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n        if (!viewport) {\r\n          return {\r\n            disabled: true,\r\n          };\r\n        }\r\n\r\n        // Example: Show data overlay menu only for certain modalities\r\n        const displaySetUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n        if (!displaySetUIDs?.length) {\r\n          return {\r\n            disabled: true,\r\n          };\r\n        }\r\n\r\n        return {\r\n          disabled: false,\r\n        };\r\n      },\r\n    },\r\n    {\r\n      name: 'ohif.orientationMenu',\r\n      defaultComponent: ViewportOrientationMenuWrapper,\r\n    },\r\n    {\r\n      name: 'evaluate.orientationMenu',\r\n      evaluate: ({ viewportId }) => {\r\n        const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n        if (!viewport) {\r\n          return {\r\n            disabled: true,\r\n          };\r\n        }\r\n\r\n        // Only show orientation menu for 3D capable viewports\r\n        const displaySetUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n        const displaySets = displaySetUIDs.map(displaySetService.getDisplaySetByUID);\r\n        const isNotReconstructable = displaySets.some(displaySet => !displaySet?.isReconstructable);\r\n\r\n        const disabled = isNotReconstructable;\r\n\r\n        return {\r\n          disabled,\r\n        };\r\n      },\r\n    },\r\n    {\r\n      name: 'ohif.windowLevelMenu',\r\n      defaultComponent: WindowLevelActionMenuWrapper,\r\n    },\r\n    {\r\n      name: 'ohif.voiManualControlMenu',\r\n      defaultComponent: VOIManualControlMenuWrapper,\r\n    },\r\n    {\r\n      name: 'ohif.windowLevelMenuEmbedded',\r\n      defaultComponent: WindowLevelActionMenuWrapper,\r\n    },\r\n    {\r\n      name: 'evaluate.windowLevelMenuEmbedded',\r\n      evaluate: () => {\r\n        return {\r\n          isEmbedded: true,\r\n        };\r\n      },\r\n    },\r\n    {\r\n      name: 'ohif.thresholdMenu',\r\n      defaultComponent: ThresholdMenuWrapper,\r\n    },\r\n    {\r\n      name: 'ohif.opacityMenu',\r\n      defaultComponent: OpacityMenuWrapper,\r\n    },\r\n    {\r\n      name: 'evaluate.windowLevelMenu',\r\n      evaluate: ({ viewportId }) => {\r\n        const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n        if (!viewport) {\r\n          return {\r\n            disabled: true,\r\n          };\r\n        }\r\n\r\n        const displaySetUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n        const displaySets = displaySetUIDs.map(displaySetService.getDisplaySetByUID);\r\n\r\n        const supportWindowLevel = displaySets.some(displaySet => displaySet?.supportsWindowLevel);\r\n\r\n        const isInAnySection = toolbarService.isInAnySection('windowLevelMenuEmbedded');\r\n\r\n        return {\r\n          disabled: !supportWindowLevel,\r\n          hasEmbeddedVariantToUse: !!isInAnySection,\r\n        };\r\n      },\r\n    },\r\n    {\r\n      name: 'evaluate.voiManualControlMenu',\r\n      evaluate: ({ viewportId }) => {\r\n        const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n        if (!viewport) {\r\n          return {\r\n            disabled: true,\r\n          };\r\n        }\r\n\r\n        const displaySetUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n        const displaySets = displaySetUIDs.map(displaySetService.getDisplaySetByUID);\r\n\r\n        const supportWindowLevel = displaySets.some(displaySet => displaySet?.supportsWindowLevel);\r\n\r\n        return {\r\n          disabled: !supportWindowLevel,\r\n        };\r\n      },\r\n    },\r\n    {\r\n      name: 'evaluate.thresholdMenu',\r\n      evaluate: ({ viewportId }) => {\r\n        const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n        if (!viewport) {\r\n          return {\r\n            disabled: true,\r\n          };\r\n        }\r\n\r\n        if (viewport.type !== 'orthographic') {\r\n          return {\r\n            disabled: true,\r\n          };\r\n        }\r\n\r\n        const displaySetUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n        if (!displaySetUIDs.length) {\r\n          return {\r\n            disabled: true,\r\n          };\r\n        }\r\n\r\n        return {\r\n          disabled: false,\r\n        };\r\n      },\r\n    },\r\n    {\r\n      name: 'evaluate.opacityMenu',\r\n      evaluate: ({ viewportId }) => {\r\n        const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n        if (!viewport || viewport.type !== 'orthographic') {\r\n          return {\r\n            disabled: true,\r\n          };\r\n        }\r\n\r\n        const displaySetUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n\r\n        if (displaySetUIDs.length <= 1) {\r\n          return {\r\n            disabled: true,\r\n          };\r\n        }\r\n\r\n        const displaySets = displaySetUIDs.map(displaySetService.getDisplaySetByUID);\r\n        const hasOverlayable = displaySets.some(displaySet => displaySet?.isOverlayDisplaySet);\r\n\r\n        return {\r\n          disabled: hasOverlayable,\r\n        };\r\n      },\r\n    },\r\n    // functions/helpers to be used by the toolbar buttons to decide if they should\r\n    // enabled or not\r\n    {\r\n      name: 'evaluate.viewport.supported',\r\n      evaluate: ({ viewportId, unsupportedViewportTypes, disabledText }) => {\r\n        const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n        if (viewport && unsupportedViewportTypes?.includes(viewport.type)) {\r\n          return getDisabledState(disabledText);\r\n        }\r\n\r\n        return undefined;\r\n      },\r\n    },\r\n    {\r\n      name: 'evaluate.modality.supported',\r\n      evaluate: ({ viewportId, unsupportedModalities, supportedModalities, disabledText }) => {\r\n        const displaySetUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n\r\n        if (!displaySetUIDs?.length) {\r\n          return;\r\n        }\r\n\r\n        const displaySets = displaySetUIDs.map(displaySetService.getDisplaySetByUID);\r\n\r\n        // Check for unsupported modalities (exclusion)\r\n        if (unsupportedModalities?.length) {\r\n          const hasUnsupportedModality = displaySets.some(displaySet =>\r\n            unsupportedModalities.includes(displaySet?.Modality)\r\n          );\r\n\r\n          if (hasUnsupportedModality) {\r\n            return getDisabledState(disabledText);\r\n          }\r\n        }\r\n\r\n        // Check for supported modalities (inclusion)\r\n        if (supportedModalities?.length) {\r\n          const hasAnySupportedModality = displaySets.some(displaySet =>\r\n            supportedModalities.includes(displaySet?.Modality)\r\n          );\r\n\r\n          if (!hasAnySupportedModality) {\r\n            return getDisabledState(disabledText || 'Tool not available for this modality');\r\n          }\r\n        }\r\n      },\r\n    },\r\n    {\r\n      name: 'evaluate.cornerstoneTool',\r\n      evaluate: ({ viewportId, button, toolNames, disabledText }) => {\r\n        const toolGroup = toolGroupService.getToolGroupForViewport(viewportId);\r\n\r\n        if (!toolGroup) {\r\n          return;\r\n        }\r\n\r\n        const toolName = toolbarService.getToolNameForButton(button);\r\n\r\n        if (!toolGroup || (!toolGroup.hasTool(toolName) && !toolNames)) {\r\n          return getDisabledState(disabledText);\r\n        }\r\n\r\n        const isPrimaryActive = toolNames\r\n          ? toolNames.includes(toolGroup.getActivePrimaryMouseButtonTool())\r\n          : toolGroup.getActivePrimaryMouseButtonTool() === toolName;\r\n\r\n        return {\r\n          disabled: false,\r\n          isActive: isPrimaryActive,\r\n        };\r\n      },\r\n    },\r\n    {\r\n      name: 'evaluate.action',\r\n      evaluate: () => {\r\n        return {\r\n          disabled: false,\r\n        };\r\n      },\r\n    },\r\n    {\r\n      name: 'evaluate.cornerstoneTool.toggle.ifStrictlyDisabled',\r\n      evaluate: ({ viewportId, button, disabledText }) =>\r\n        _evaluateToggle({\r\n          viewportId,\r\n          button,\r\n          toolbarService,\r\n          disabledText,\r\n          offModes: [Enums.ToolModes.Disabled],\r\n          toolGroupService,\r\n        }),\r\n    },\r\n    {\r\n      name: 'evaluate.cornerstoneTool.toggle',\r\n      evaluate: ({ viewportId, button, disabledText }) =>\r\n        _evaluateToggle({\r\n          viewportId,\r\n          button,\r\n          toolbarService,\r\n          disabledText,\r\n          offModes: [Enums.ToolModes.Disabled, Enums.ToolModes.Passive],\r\n          toolGroupService,\r\n        }),\r\n    },\r\n    {\r\n      name: 'evaluate.cornerstone.synchronizer',\r\n      evaluate: ({ viewportId, button }) => {\r\n        let synchronizers = syncGroupService.getSynchronizersForViewport(viewportId);\r\n\r\n        if (!synchronizers?.length) {\r\n          return {\r\n            className: utils.getToggledClassName(false),\r\n          };\r\n        }\r\n\r\n        const isArray = Array.isArray(button.commands);\r\n\r\n        const synchronizerType = isArray\r\n          ? button.commands?.[0].commandOptions.type\r\n          : button.commands?.commandOptions.type;\r\n\r\n        synchronizers = syncGroupService.getSynchronizersOfType(synchronizerType);\r\n\r\n        if (!synchronizers?.length) {\r\n          return {\r\n            className: utils.getToggledClassName(false),\r\n          };\r\n        }\r\n\r\n        // Todo: we need a better way to find the synchronizers based on their\r\n        // type, but for now we just check the first one and see if it is\r\n        // enabled\r\n        const synchronizer = synchronizers[0];\r\n\r\n        const isEnabled = synchronizer?._enabled;\r\n\r\n        return {\r\n          className: utils.getToggledClassName(isEnabled),\r\n        };\r\n      },\r\n    },\r\n    {\r\n      name: 'evaluate.viewportProperties.toggle',\r\n      evaluate: ({ viewportId, button }) => {\r\n        const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n        if (!viewport || viewport.isDisabled) {\r\n          return;\r\n        }\r\n\r\n        const propId = button.id;\r\n\r\n        const properties = viewport.getProperties();\r\n        const camera = viewport.getCamera();\r\n\r\n        const prop = camera?.[propId] || properties?.[propId];\r\n\r\n        if (!prop) {\r\n          return {\r\n            disabled: false,\r\n          };\r\n        }\r\n\r\n        const isToggled = prop;\r\n\r\n        return {\r\n          className: utils.getToggledClassName(isToggled),\r\n        };\r\n      },\r\n    },\r\n    {\r\n      name: 'evaluate.displaySetIsReconstructable',\r\n      evaluate: ({ viewportId, disabledText = 'Selected viewport is not reconstructable' }) => {\r\n        const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n        if (!viewport) {\r\n          return;\r\n        }\r\n\r\n        const displaySetUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n\r\n        const displaySets = displaySetUIDs.map(displaySetService.getDisplaySetByUID);\r\n\r\n        const areReconstructable = displaySets.every(displaySet => {\r\n          return displaySet?.isReconstructable;\r\n        });\r\n\r\n        if (!areReconstructable) {\r\n          return getDisabledState(disabledText);\r\n        }\r\n\r\n        return {\r\n          disabled: false,\r\n        };\r\n      },\r\n    },\r\n  ];\r\n}\r\n\r\nfunction _evaluateToggle({\r\n  viewportId,\r\n  toolbarService,\r\n  button,\r\n  disabledText,\r\n  offModes,\r\n  toolGroupService,\r\n}) {\r\n  const toolGroup = toolGroupService.getToolGroupForViewport(viewportId);\r\n\r\n  if (!toolGroup) {\r\n    return;\r\n  }\r\n  const toolName = toolbarService.getToolNameForButton(button);\r\n\r\n  if (!toolGroup?.hasTool(toolName)) {\r\n    return getDisabledState(disabledText);\r\n  }\r\n\r\n  const isOff = offModes.includes(toolGroup.getToolOptions(toolName).mode);\r\n\r\n  return {\r\n    className: utils.getToggledClassName(!isOff),\r\n  };\r\n}\r\n","export * from './useActiveViewportSegmentationRepresentations';\r\nexport * from './useMeasurements';\r\nexport * from './useSegmentations';\r\nexport * from './useViewportSegmentations';\r\nexport * from './useViewportHover';\r\nexport * from './useViewportDisplaySets';\r\nexport * from './useMeasurementTracking';\r\nexport * from './useViewportRendering';\r\n","import { useViewportGrid } from '@ohif/ui-next';\r\nimport { useViewportSegmentations } from './useViewportSegmentations';\r\n\r\nfunction useActiveViewportSegmentationRepresentations() {\r\n  const [viewportGrid] = useViewportGrid();\r\n\r\n  const viewportId = viewportGrid?.activeViewportId;\r\n\r\n  const segmentations = useViewportSegmentations({ viewportId });\r\n\r\n  return segmentations;\r\n}\r\n\r\nexport { useActiveViewportSegmentationRepresentations };\r\n","import { useState, useEffect, useCallback } from 'react';\r\nimport { useSystem } from '@ohif/core/src';\r\nimport { useViewportDisplaySets } from './useViewportDisplaySets';\r\nimport { BaseVolumeViewport } from '@cornerstonejs/core';\r\n\r\n/**\r\n * Hook that provides measurement tracking information for a viewport\r\n *\r\n * @param options - The hook options\r\n * @param options.viewportId - The ID of the viewport to track\r\n * @returns An object containing the tracking state, related information, and tracked measurement UIDs\r\n */\r\nexport function useMeasurementTracking({ viewportId }: { viewportId: string }) {\r\n  const { servicesManager } = useSystem();\r\n  const { cornerstoneViewportService, trackedMeasurementsService, measurementService } =\r\n    servicesManager.services;\r\n\r\n  const { backgroundDisplaySet } = useViewportDisplaySets(viewportId);\r\n\r\n  // Tracking states\r\n  const [isTracked, setIsTracked] = useState(false);\r\n  const [isLocked, setIsLocked] = useState(false);\r\n  const [trackedMeasurementUIDs, setTrackedMeasurementUIDs] = useState<string[]>([]);\r\n\r\n  const updateTrackedMeasurements = useCallback(() => {\r\n    if (!measurementService || !backgroundDisplaySet?.SeriesInstanceUID || !isTracked) {\r\n      setTrackedMeasurementUIDs([]);\r\n      return;\r\n    }\r\n\r\n    const seriesInstanceUID = backgroundDisplaySet.SeriesInstanceUID;\r\n\r\n    const seriesMeasurements = measurementService.getMeasurements(\r\n      measurement => measurement.referenceSeriesUID === seriesInstanceUID\r\n    );\r\n\r\n    const uids = seriesMeasurements.map(measurement => measurement.uid);\r\n    setTrackedMeasurementUIDs(uids);\r\n  }, [measurementService, backgroundDisplaySet, isTracked]);\r\n\r\n  const updateIsTracked = useCallback(() => {\r\n    if (!trackedMeasurementsService || !backgroundDisplaySet?.SeriesInstanceUID) {\r\n      setIsTracked(false);\r\n      return;\r\n    }\r\n\r\n    const trackedSeries = trackedMeasurementsService.getTrackedSeries();\r\n\r\n    if (!trackedSeries?.length) {\r\n      setIsTracked(false);\r\n      return;\r\n    }\r\n\r\n    const viewport = cornerstoneViewportService?.getCornerstoneViewport(viewportId);\r\n    const SeriesInstanceUID = backgroundDisplaySet.SeriesInstanceUID;\r\n\r\n    if (viewport instanceof BaseVolumeViewport) {\r\n      const currentImageId = viewport?.getCurrentImageId();\r\n\r\n      if (!currentImageId) {\r\n        setIsTracked(false);\r\n        return;\r\n      }\r\n    }\r\n\r\n    const seriesIsTracked = trackedSeries.includes(SeriesInstanceUID);\r\n    setIsTracked(seriesIsTracked);\r\n  }, [viewportId, backgroundDisplaySet, cornerstoneViewportService, trackedMeasurementsService]);\r\n\r\n  // Update tracked measurements whenever tracking state changes\r\n  useEffect(() => {\r\n    updateTrackedMeasurements();\r\n  }, [isTracked, updateTrackedMeasurements]);\r\n\r\n  useEffect(() => {\r\n    if (!trackedMeasurementsService) {\r\n      return;\r\n    }\r\n\r\n    setIsLocked(trackedMeasurementsService.isTrackingEnabled());\r\n    updateIsTracked();\r\n\r\n    const subscriptions = [\r\n      trackedMeasurementsService.subscribe(trackedMeasurementsService.EVENTS.TRACKING_ENABLED, () =>\r\n        setIsLocked(true)\r\n      ),\r\n      trackedMeasurementsService.subscribe(\r\n        trackedMeasurementsService.EVENTS.TRACKING_DISABLED,\r\n        () => setIsLocked(false)\r\n      ),\r\n\r\n      trackedMeasurementsService.subscribe(\r\n        trackedMeasurementsService.EVENTS.TRACKED_SERIES_CHANGED,\r\n        () => updateIsTracked()\r\n      ),\r\n      trackedMeasurementsService.subscribe(trackedMeasurementsService.EVENTS.SERIES_ADDED, () =>\r\n        updateIsTracked()\r\n      ),\r\n      trackedMeasurementsService.subscribe(trackedMeasurementsService.EVENTS.SERIES_REMOVED, () =>\r\n        updateIsTracked()\r\n      ),\r\n    ];\r\n\r\n    // Subscribe to measurement service events to update trackedMeasurementUIDs\r\n    if (measurementService) {\r\n      [\r\n        measurementService.EVENTS.MEASUREMENT_ADDED,\r\n        measurementService.EVENTS.RAW_MEASUREMENT_ADDED,\r\n        measurementService.EVENTS.MEASUREMENT_UPDATED,\r\n        measurementService.EVENTS.MEASUREMENT_REMOVED,\r\n        measurementService.EVENTS.MEASUREMENTS_CLEARED,\r\n      ].forEach(eventType => {\r\n        subscriptions.push(\r\n          measurementService.subscribe(eventType, () => updateTrackedMeasurements())\r\n        );\r\n      });\r\n    }\r\n\r\n    return () => {\r\n      subscriptions.forEach(sub => sub.unsubscribe());\r\n    };\r\n  }, [trackedMeasurementsService, measurementService, updateIsTracked, updateTrackedMeasurements]);\r\n\r\n  return {\r\n    isTracked,\r\n    isLocked,\r\n    seriesInstanceUID: backgroundDisplaySet?.SeriesInstanceUID,\r\n    trackedMeasurementUIDs,\r\n  };\r\n}\r\n\r\nexport default useMeasurementTracking;\r\n","import { useState, useEffect } from 'react';\r\nimport debounce from 'lodash.debounce';\r\nimport { useSystem } from '@ohif/core';\r\nfunction mapMeasurementToDisplay(measurement, displaySetService) {\r\n  const { referenceSeriesUID } = measurement;\r\n\r\n  const displaySets = displaySetService.getDisplaySetsForSeries(referenceSeriesUID);\r\n\r\n  if (!displaySets[0]?.instances) {\r\n    throw new Error('The tracked measurements panel should only be tracking \"stack\" displaySets.');\r\n  }\r\n\r\n  const { findingSites, finding, label: baseLabel, displayText: baseDisplayText } = measurement;\r\n\r\n  const firstSite = findingSites?.[0];\r\n  const label = baseLabel || finding?.text || firstSite?.text || '(empty)';\r\n\r\n  // Initialize displayText with the structure used in Length.ts and CobbAngle.ts\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: baseDisplayText?.secondary || [],\r\n  };\r\n\r\n  // Add baseDisplayText to primary if it exists\r\n  if (baseDisplayText) {\r\n    displayText.primary.push(...baseDisplayText.primary);\r\n  }\r\n\r\n  // Add finding sites to primary\r\n  if (findingSites) {\r\n    findingSites.forEach(site => {\r\n      if (site?.text && site.text !== label) {\r\n        displayText.primary.push(site.text);\r\n      }\r\n    });\r\n  }\r\n\r\n  // Add finding to primary if it's different from the label\r\n  if (finding && finding.text && finding.text !== label) {\r\n    displayText.primary.push(finding.text);\r\n  }\r\n\r\n  return {\r\n    ...measurement,\r\n    displayText,\r\n    label,\r\n  };\r\n}\r\n\r\n/**\r\n * A custom hook that provides mapped measurements based on the given services and filters.\r\n *\r\n * @param {Object} servicesManager - The services manager object.\r\n * @param {Object} options - The options for filtering and mapping measurements.\r\n * @param {Function} options.measurementFilter - Optional function to filter measurements.\r\n * @param {Object} options.valueTypes - The value types for mapping measurements.\r\n * @returns {Array} An array of mapped and filtered measurements.\r\n */\r\nexport function useMeasurements({ measurementFilter } = { measurementFilter: () => true }) {\r\n  const { servicesManager } = useSystem();\r\n  const { measurementService, displaySetService } = servicesManager.services;\r\n  const [displayMeasurements, setDisplayMeasurements] = useState([]);\r\n\r\n  useEffect(() => {\r\n    const updateDisplayMeasurements = () => {\r\n      const measurements = measurementService.getMeasurements(measurementFilter);\r\n      const mappedMeasurements = measurements.map(m =>\r\n        mapMeasurementToDisplay(m, displaySetService)\r\n      );\r\n      setDisplayMeasurements(prevMeasurements => {\r\n        if (JSON.stringify(prevMeasurements) !== JSON.stringify(mappedMeasurements)) {\r\n          return mappedMeasurements;\r\n        }\r\n        return prevMeasurements;\r\n      });\r\n    };\r\n\r\n    const debouncedUpdate = debounce(updateDisplayMeasurements, 100);\r\n\r\n    updateDisplayMeasurements();\r\n\r\n    const events = [\r\n      measurementService.EVENTS.MEASUREMENT_ADDED,\r\n      measurementService.EVENTS.RAW_MEASUREMENT_ADDED,\r\n      measurementService.EVENTS.MEASUREMENT_UPDATED,\r\n      measurementService.EVENTS.MEASUREMENT_REMOVED,\r\n      measurementService.EVENTS.MEASUREMENTS_CLEARED,\r\n    ];\r\n\r\n    const subscriptions = events.map(\r\n      evt => measurementService.subscribe(evt, debouncedUpdate).unsubscribe\r\n    );\r\n\r\n    return () => {\r\n      subscriptions.forEach(unsub => unsub());\r\n      debouncedUpdate.cancel();\r\n    };\r\n  }, [measurementService, measurementFilter, displaySetService]);\r\n\r\n  return displayMeasurements;\r\n}\r\n","import { useState, useEffect } from 'react';\r\nimport debounce from 'lodash.debounce';\r\nimport { roundNumber } from '@ohif/core/src/utils';\r\nimport { SegmentationData } from '../services/SegmentationService/SegmentationService';\r\nimport { useSystem } from '@ohif/core';\r\n\r\nfunction mapSegmentationToDisplay(segmentation, customizationService) {\r\n  const { label, segments } = segmentation;\r\n\r\n  // Get the readable text mapping once\r\n  const readableTextMap = customizationService.getCustomization('panelSegmentation.readableText');\r\n\r\n  // Helper function to recursively map cachedStats to readable display text\r\n  function mapStatsToDisplay(stats, indent = 0) {\r\n    const primary = [];\r\n    const indentation = '  '.repeat(indent);\r\n\r\n    for (const key in stats) {\r\n      if (Object.prototype.hasOwnProperty.call(stats, key)) {\r\n        const value = stats[key];\r\n        const readableText = readableTextMap?.[key];\r\n\r\n        if (!readableText) {\r\n          continue;\r\n        }\r\n\r\n        if (typeof value === 'object' && value !== null && !Array.isArray(value)) {\r\n          // Add empty row before category (except for the first category)\r\n          if (primary.length > 0) {\r\n            primary.push('');\r\n          }\r\n          // Add category title\r\n          primary.push(`${indentation}${readableText}`);\r\n          // Recursively handle nested objects\r\n          primary.push(...mapStatsToDisplay(value, indent + 1));\r\n        } else {\r\n          // For non-nested values, don't add empty rows\r\n          primary.push(`${indentation}${readableText}: ${roundNumber(value, 2)}`);\r\n        }\r\n      }\r\n    }\r\n\r\n    return primary;\r\n  }\r\n\r\n  // Get customization for display text mapping\r\n  const displayTextMapper = segment => {\r\n    const defaultDisplay = {\r\n      primary: [],\r\n      secondary: [],\r\n    };\r\n\r\n    // If the segment has cachedStats, map it to readable text\r\n    if (segment.cachedStats) {\r\n      const primary = mapStatsToDisplay(segment.cachedStats);\r\n      defaultDisplay.primary = primary;\r\n    }\r\n\r\n    return defaultDisplay;\r\n  };\r\n\r\n  const updatedSegments = {};\r\n\r\n  Object.entries(segments).forEach(([segmentIndex, segment]) => {\r\n    updatedSegments[segmentIndex] = {\r\n      ...segment,\r\n      displayText: displayTextMapper(segment),\r\n    };\r\n  });\r\n\r\n  // Map the segments and apply the display text mapper\r\n  return {\r\n    ...segmentation,\r\n    label,\r\n    segments: updatedSegments,\r\n  };\r\n}\r\n\r\n/**\r\n * Custom hook that provides segmentation data.\r\n * @param options - The options object.\r\n * @param options.servicesManager - The services manager object.\r\n * @param options.subscribeToDataModified - Whether to subscribe to segmentation data modifications.\r\n * @param options.debounceTime - Debounce time in milliseconds for updates.\r\n * @returns An array of segmentation data.\r\n */\r\nexport function useSegmentations(options?: {\r\n  subscribeToDataModified?: boolean;\r\n  debounceTime?: number;\r\n}): SegmentationData[] {\r\n  const { subscribeToDataModified = false, debounceTime = 0 } = options || {};\r\n  const { servicesManager } = useSystem();\r\n  const { segmentationService, customizationService } = servicesManager.services;\r\n\r\n  const [segmentations, setSegmentations] = useState<SegmentationData[]>([]);\r\n\r\n  useEffect(() => {\r\n    const update = () => {\r\n      const segmentations = segmentationService.getSegmentations();\r\n\r\n      if (!segmentations?.length) {\r\n        setSegmentations([]);\r\n        return;\r\n      }\r\n\r\n      const mappedSegmentations = segmentations.map(segmentation =>\r\n        mapSegmentationToDisplay(segmentation, customizationService)\r\n      );\r\n\r\n      setSegmentations(mappedSegmentations);\r\n    };\r\n\r\n    const debouncedUpdate =\r\n      debounceTime > 0 ? debounce(update, debounceTime, { leading: true, trailing: true }) : update;\r\n\r\n    update();\r\n\r\n    const subscriptions = [\r\n      segmentationService.subscribe(\r\n        segmentationService.EVENTS.SEGMENTATION_MODIFIED,\r\n        debouncedUpdate\r\n      ),\r\n      segmentationService.subscribe(\r\n        segmentationService.EVENTS.SEGMENTATION_REMOVED,\r\n        debouncedUpdate\r\n      ),\r\n    ];\r\n\r\n    if (subscribeToDataModified) {\r\n      subscriptions.push(\r\n        segmentationService.subscribe(\r\n          segmentationService.EVENTS.SEGMENTATION_DATA_MODIFIED,\r\n          debouncedUpdate\r\n        )\r\n      );\r\n    }\r\n\r\n    return () => {\r\n      subscriptions.forEach(subscription => subscription.unsubscribe());\r\n      if (debounceTime > 0) {\r\n        debouncedUpdate.cancel();\r\n      }\r\n    };\r\n  }, [segmentationService, customizationService, debounceTime, subscribeToDataModified]);\r\n\r\n  return segmentations;\r\n}\r\n","import { useMemo } from 'react';\r\nimport { useSystem, utils } from '@ohif/core';\r\nimport { useViewportGrid } from '@ohif/ui-next';\r\nimport {\r\n  getEnhancedDisplaySets,\r\n  sortByOverlayable,\r\n  DERIVED_OVERLAY_MODALITIES,\r\n} from '../components/ViewportDataOverlaySettingMenu/utils';\r\n\r\nconst sortByPriority = (a, b) => {\r\n  if (utils.isLowPriorityModality(a.Modality)) {\r\n    return 1;\r\n  }\r\n  return -1;\r\n};\r\n\r\n/**\r\n * Options for the useViewportDisplaySets hook\r\n */\r\nexport type UseViewportDisplaySetsOptions = {\r\n  /**\r\n   * Whether to include background display set\r\n   */\r\n  includeBackground?: boolean;\r\n  /**\r\n   * Whether to include foreground display sets\r\n   */\r\n  includeForeground?: boolean;\r\n  /**\r\n   * Whether to include overlay display sets\r\n   */\r\n  includeOverlay?: boolean;\r\n  /**\r\n   * Whether to include potential overlay display sets\r\n   */\r\n  includePotentialOverlay?: boolean;\r\n  /**\r\n   * Whether to include potential foreground display sets\r\n   */\r\n  includePotentialForeground?: boolean;\r\n  /**\r\n   * Whether to include potential background display sets\r\n   */\r\n  includePotentialBackground?: boolean;\r\n};\r\n\r\n/**\r\n * Return type for useViewportDisplaySets\r\n */\r\nexport type ViewportDisplaySets = {\r\n  /**\r\n   * All display sets for the viewport\r\n   */\r\n  allDisplaySets: AppTypes.DisplaySet[];\r\n  /**\r\n   * The viewport display sets for the viewport\r\n   */\r\n  viewportDisplaySets: AppTypes.DisplaySet[];\r\n  /**\r\n   * The primary display set for the viewport (base image)\r\n   */\r\n  backgroundDisplaySet?: AppTypes.DisplaySet;\r\n  /**\r\n   * Display sets currently shown with background (non-overlay layers)\r\n   */\r\n  foregroundDisplaySets?: AppTypes.DisplaySet[];\r\n  /**\r\n   * Segmentation display sets currently applied as overlays\r\n   */\r\n  overlayDisplaySets?: AppTypes.DisplaySet[];\r\n  /**\r\n   * Display sets that could be toggled on as overlays (derived modalities)\r\n   */\r\n  potentialOverlayDisplaySets?: AppTypes.DisplaySet[];\r\n  /**\r\n   * Display sets that could be added as foreground layers\r\n   */\r\n  potentialForegroundDisplaySets?: AppTypes.DisplaySet[];\r\n  /**\r\n   * Display sets that could replace the current background\r\n   */\r\n  potentialBackgroundDisplaySets?: AppTypes.DisplaySet[];\r\n};\r\n\r\n/**\r\n * Hook to provide display sets and overlay information for a viewport based on options.\r\n *\r\n * @param viewportId - The viewport ID to get display sets for\r\n * @param options - Options to control which display sets to compute\r\n * @returns Object containing requested display set collections based on options\r\n */\r\nexport function useViewportDisplaySets(\r\n  viewportId?: string,\r\n  options?: UseViewportDisplaySetsOptions\r\n): ViewportDisplaySets {\r\n  const { servicesManager } = useSystem();\r\n  const { displaySetService, segmentationService } = servicesManager.services;\r\n\r\n  // Note: this is very important we should use the useViewportGrid hook here,\r\n  // since if the viewport displaySet is changed we should re-run this hook\r\n  // to get the latest displaySets\r\n  const [viewportGridState, viewportGridService] = useViewportGrid();\r\n\r\n  const viewportIdToUse = viewportId || viewportGridState.activeViewportId;\r\n\r\n  // Apply defaults - include everything if no options specified\r\n  const {\r\n    includeBackground = true,\r\n    includeForeground = true,\r\n    includeOverlay = true,\r\n    includePotentialOverlay = true,\r\n    includePotentialForeground = true,\r\n    includePotentialBackground = true,\r\n  } = options || {};\r\n\r\n  // Get all available display sets (only if needed)\r\n  const needsAllDisplaySets = includePotentialBackground;\r\n  const allDisplaySets = useMemo(\r\n    () => (needsAllDisplaySets ? displaySetService.getActiveDisplaySets() : []),\r\n    [displaySetService, needsAllDisplaySets]\r\n  );\r\n\r\n  // Get all available segmentations (only if needed)\r\n  const needsSegmentations = includeOverlay;\r\n  const segmentationRepresentations = useMemo(\r\n    () =>\r\n      needsSegmentations ? segmentationService.getSegmentationRepresentations(viewportIdToUse) : [],\r\n    [segmentationService, viewportIdToUse, needsSegmentations]\r\n  );\r\n\r\n  const overlayDisplaySets = useMemo(() => {\r\n    if (!includeOverlay) {\r\n      return [];\r\n    }\r\n    return segmentationRepresentations.map(repr => {\r\n      const displaySet = displaySetService.getDisplaySetByUID(repr.segmentationId);\r\n      return displaySet;\r\n    });\r\n  }, [includeOverlay, segmentationRepresentations, displaySetService]);\r\n\r\n  const overlayDisplaySetUIDs = useMemo(() => {\r\n    return overlayDisplaySets.map(ds => ds.displaySetInstanceUID);\r\n  }, [overlayDisplaySets]);\r\n\r\n  // Get enhanced display sets (only if needed)\r\n  const needsEnhancedDisplaySets =\r\n    includeBackground || includeForeground || includePotentialOverlay || includePotentialForeground;\r\n\r\n  const { viewportDisplaySets = [], enhancedDisplaySets = [] } = useMemo(() => {\r\n    if (!needsEnhancedDisplaySets) {\r\n      return { viewportDisplaySets: [], enhancedDisplaySets: [] };\r\n    }\r\n    return (\r\n      getEnhancedDisplaySets({\r\n        viewportId: viewportIdToUse,\r\n        services: { displaySetService, viewportGridService },\r\n      }) || { viewportDisplaySets: [], enhancedDisplaySets: [] }\r\n    );\r\n  }, [viewportIdToUse, displaySetService, viewportGridService, needsEnhancedDisplaySets]);\r\n\r\n  const backgroundDisplaySet = useMemo(\r\n    () =>\r\n      includeBackground && viewportDisplaySets.length > 0 ? viewportDisplaySets[0] : undefined,\r\n    [includeBackground, viewportDisplaySets]\r\n  );\r\n\r\n  const foregroundDisplaySets = useMemo(() => {\r\n    if (!includeForeground || !backgroundDisplaySet) {\r\n      return [];\r\n    }\r\n    return viewportDisplaySets.filter(\r\n      ds =>\r\n        !DERIVED_OVERLAY_MODALITIES.includes(ds.Modality) &&\r\n        ds.displaySetInstanceUID !== backgroundDisplaySet.displaySetInstanceUID\r\n    );\r\n  }, [includeForeground, viewportDisplaySets, backgroundDisplaySet]);\r\n\r\n  const foregroundDisplaySetUIDs = useMemo(\r\n    () => foregroundDisplaySets.map(ds => ds.displaySetInstanceUID),\r\n    [foregroundDisplaySets]\r\n  );\r\n\r\n  const potentialOverlayDisplaySets = useMemo(() => {\r\n    if (!includePotentialOverlay) {\r\n      return [];\r\n    }\r\n    return enhancedDisplaySets\r\n      .filter(\r\n        ds =>\r\n          DERIVED_OVERLAY_MODALITIES.includes(ds.Modality) &&\r\n          !overlayDisplaySetUIDs.includes(ds.displaySetInstanceUID) &&\r\n          ds.isOverlayable\r\n      )\r\n      .sort(sortByOverlayable);\r\n  }, [includePotentialOverlay, enhancedDisplaySets, overlayDisplaySetUIDs]);\r\n\r\n  const potentialForegroundDisplaySets = useMemo(() => {\r\n    if (!includePotentialForeground) {\r\n      return [];\r\n    }\r\n    return enhancedDisplaySets\r\n      .filter(\r\n        ds =>\r\n          !DERIVED_OVERLAY_MODALITIES.includes(ds.Modality) &&\r\n          !foregroundDisplaySetUIDs.includes(ds.displaySetInstanceUID) &&\r\n          ds.isOverlayable\r\n      )\r\n      .sort(sortByPriority);\r\n  }, [includePotentialForeground, enhancedDisplaySets, foregroundDisplaySetUIDs]);\r\n\r\n  const potentialBackgroundDisplaySets = useMemo(() => {\r\n    if (!includePotentialBackground || !backgroundDisplaySet) {\r\n      return [];\r\n    }\r\n    return allDisplaySets\r\n      .filter(\r\n        ds =>\r\n          !DERIVED_OVERLAY_MODALITIES.includes(ds.Modality) &&\r\n          ds.displaySetInstanceUID !== backgroundDisplaySet.displaySetInstanceUID &&\r\n          !overlayDisplaySetUIDs.includes(ds.displaySetInstanceUID) &&\r\n          !foregroundDisplaySetUIDs.includes(ds.displaySetInstanceUID)\r\n      )\r\n      .sort(sortByPriority);\r\n  }, [\r\n    includePotentialBackground,\r\n    allDisplaySets,\r\n    backgroundDisplaySet,\r\n    overlayDisplaySetUIDs,\r\n    foregroundDisplaySetUIDs,\r\n  ]);\r\n\r\n  const result: ViewportDisplaySets = {\r\n    allDisplaySets: allDisplaySets || [],\r\n    viewportDisplaySets: viewportDisplaySets || [],\r\n  };\r\n\r\n  if (includeBackground) {\r\n    result.backgroundDisplaySet = backgroundDisplaySet;\r\n  }\r\n\r\n  if (includeForeground) {\r\n    result.foregroundDisplaySets = foregroundDisplaySets;\r\n  }\r\n\r\n  if (includeOverlay) {\r\n    result.overlayDisplaySets = overlayDisplaySets;\r\n  }\r\n\r\n  if (includePotentialOverlay) {\r\n    result.potentialOverlayDisplaySets = potentialOverlayDisplaySets;\r\n  }\r\n\r\n  if (includePotentialForeground) {\r\n    result.potentialForegroundDisplaySets = potentialForegroundDisplaySets;\r\n  }\r\n\r\n  if (includePotentialBackground) {\r\n    result.potentialBackgroundDisplaySets = potentialBackgroundDisplaySets;\r\n  }\r\n\r\n  return result;\r\n}\r\n","import { useState, useEffect, useCallback, useMemo } from 'react';\r\nimport { useViewportGrid } from '@ohif/ui-next';\r\n\r\n/**\r\n * Hook to track whether the mouse is hovering over a specific viewport\r\n * and whether the viewport is active\r\n *\r\n * @param viewportId - The ID of the viewport to track\r\n * @returns { isHovered, isActive } - Whether the viewport is hovered and active\r\n */\r\nexport function useViewportHover(viewportId: string): { isHovered: boolean; isActive: boolean } {\r\n  const [isHovered, setIsHovered] = useState(false);\r\n  const [viewportGrid] = useViewportGrid();\r\n  const { activeViewportId } = viewportGrid;\r\n\r\n  const isActive = activeViewportId === viewportId;\r\n\r\n  const setupListeners = useCallback(() => {\r\n    const viewportElement = document.querySelector(`[data-viewportId=\"${viewportId}\"]`);\r\n    const element = viewportElement?.closest('.viewport-wrapper') || viewportElement;\r\n\r\n    if (!element) {\r\n      return null;\r\n    }\r\n\r\n    let elementRect = (element as HTMLElement).getBoundingClientRect();\r\n    let lastIsInside = false;\r\n\r\n    // Update rectangle when window is resized\r\n    const updateRect = () => {\r\n      elementRect = (element as HTMLElement).getBoundingClientRect();\r\n    };\r\n\r\n    const isPointInViewport = (x, y) => {\r\n      return (\r\n        x >= elementRect.left &&\r\n        x <= elementRect.right &&\r\n        y >= elementRect.top &&\r\n        y <= elementRect.bottom\r\n      );\r\n    };\r\n\r\n    const handleMouseMove = event => {\r\n      const isInside = isPointInViewport(event.clientX, event.clientY);\r\n\r\n      if (isInside !== lastIsInside) {\r\n        lastIsInside = isInside;\r\n        setIsHovered(isInside);\r\n      }\r\n    };\r\n\r\n    let resizeTimeout;\r\n    const handleResize = () => {\r\n      clearTimeout(resizeTimeout);\r\n      resizeTimeout = setTimeout(updateRect, 10);\r\n    };\r\n\r\n    window.addEventListener('resize', handleResize);\r\n    document.addEventListener('mousemove', handleMouseMove);\r\n\r\n    updateRect();\r\n\r\n    return () => {\r\n      window.removeEventListener('resize', handleResize);\r\n      document.removeEventListener('mousemove', handleMouseMove);\r\n      clearTimeout(resizeTimeout);\r\n    };\r\n  }, [viewportId]);\r\n\r\n  useEffect(() => {\r\n    const cleanup = setupListeners();\r\n    return cleanup;\r\n  }, [setupListeners]);\r\n\r\n  // Memoize the return value to prevent unnecessary re-renders\r\n  return useMemo(() => ({ isHovered, isActive }), [isHovered, isActive]);\r\n}\r\n","import React, { useCallback, useState, useEffect, useMemo } from 'react';\r\nimport { useSystem } from '@ohif/core';\r\nimport { useViewportDisplaySets } from './useViewportDisplaySets';\r\nimport {\r\n  StackViewport,\r\n  Types,\r\n  VolumeViewport3D,\r\n  utilities,\r\n  Enums,\r\n  BaseVolumeViewport,\r\n  cache,\r\n} from '@cornerstonejs/core';\r\nimport { WindowLevelPreset } from '../types/WindowLevel';\r\nimport { ColorbarPositionType, ColorbarOptions, ColorbarProperties } from '../types/Colorbar';\r\nimport { VolumeRenderingConfig } from '../types/VolumeRenderingConfig';\r\nimport { VolumeLightingParams } from '../types';\r\nimport { ButtonLocation } from '@ohif/core/src/services/ToolBarService/ToolbarService';\r\n\r\ninterface ViewportRenderingOptions {\r\n  location?: number;\r\n  displaySetInstanceUID?: string;\r\n}\r\n\r\ninterface PixelValueRange {\r\n  min: number;\r\n  max: number;\r\n}\r\n\r\ninterface WindowLevelHook {\r\n  // Viewport information\r\n  is3DVolume: boolean;\r\n  isViewportBackgroundLight: boolean;\r\n  viewportDisplaySets: AppTypes.DisplaySet[] | undefined;\r\n  voiRange: { lower: number; upper: number } | undefined;\r\n  windowLevel: { windowWidth: number; windowCenter: number } | undefined;\r\n\r\n  // Window level functions\r\n  setWindowLevel: (preset: {\r\n    windowWidth: number;\r\n    windowCenter: number;\r\n    immediate?: boolean;\r\n  }) => void;\r\n  setVOIRange: (params: { lower: number; upper: number }) => void;\r\n  windowLevelPresets: WindowLevelPreset[];\r\n  allWindowLevelPresets: Array<{\r\n    displaySetInstanceUID: string;\r\n    modality: string;\r\n    presets: WindowLevelPreset[];\r\n  }>;\r\n\r\n  // Colorbar functions\r\n  hasColorbar: boolean;\r\n  toggleColorbar: (options?: Partial<ColorbarOptions>) => void;\r\n  colorbarProperties: ColorbarProperties;\r\n  colorbarPosition: ColorbarPositionType;\r\n  setColorbarPosition: React.Dispatch<React.SetStateAction<ColorbarPositionType>>;\r\n\r\n  // Colormap functions\r\n  setColormap: (params: { colormap: any; opacity?: number; immediate?: boolean }) => void;\r\n  colormap: any;\r\n\r\n  // Opacity functions\r\n  opacity: number | undefined;\r\n  setOpacity: (opacity: number) => void;\r\n  opacityLinear: number | undefined;\r\n  setOpacityLinear: (opacityLinear: number) => void;\r\n\r\n  // Threshold functions\r\n  threshold: number | undefined;\r\n  setThreshold: (threshold: number) => void;\r\n  pixelValueRange: PixelValueRange;\r\n\r\n  // 3D volume rendering functions\r\n  setVolumeRenderingPreset: (preset: any) => void;\r\n  setVolumeRenderingQuality: (quality: number) => void;\r\n  setVolumeLighting: (params: { ambient: number; diffuse: number; specular: number }) => void;\r\n  setVolumeShading: (enabled: boolean) => void;\r\n  volumeRenderingPresets: Array<any>;\r\n  volumeRenderingQualityRange: { min: number; max: number; step: number };\r\n}\r\n\r\nconst getPosition = (location: number): ColorbarPositionType => {\r\n  switch (location) {\r\n    case ButtonLocation.LeftMiddle:\r\n      return 'left';\r\n    case ButtonLocation.RightMiddle:\r\n      return 'right';\r\n    case ButtonLocation.BottomMiddle:\r\n      return 'bottom';\r\n    case ButtonLocation.TopMiddle:\r\n      return 'top';\r\n    default:\r\n      return 'bottom'; // Default to bottom if location doesn't match a middle position\r\n  }\r\n};\r\n\r\nconst GAMMA = 1 / 5;\r\n\r\nconst linearToOpacity = (linearValue: number): number => {\r\n  return Math.pow(linearValue, GAMMA);\r\n};\r\n\r\nconst opacityToLinear = (opacityValue: number): number => {\r\n  return Math.pow(opacityValue, 1.0 / GAMMA);\r\n};\r\n\r\nconst is3DViewport = ({ viewportId, cornerstoneViewportService }) => {\r\n  const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n  return viewport instanceof VolumeViewport3D;\r\n};\r\n\r\n/**\r\n * Hook to access window level functionality for a specific viewport\r\n *\r\n * @param viewportId - The ID of the viewport to get window level functionality for\r\n * @param options - Options for the hook, including location and displaySetInstanceUID\r\n * @returns Window level API for the specified viewport\r\n */\r\nexport function useViewportRendering(\r\n  viewportId?: string,\r\n  options?: ViewportRenderingOptions\r\n): WindowLevelHook {\r\n  const { servicesManager, commandsManager } = useSystem();\r\n  const { cornerstoneViewportService, colorbarService, customizationService } =\r\n    servicesManager.services;\r\n\r\n  const [is3DVolume, setIs3DVolume] = useState(\r\n    is3DViewport({ viewportId, cornerstoneViewportService })\r\n  );\r\n  const [hasColorbar, setHasColorbar] = useState(colorbarService.hasColorbar(viewportId));\r\n  const [colorbarPosition, setColorbarPosition] = useState<ColorbarPositionType>(\r\n    options?.location ? getPosition(options.location) : 'bottom'\r\n  );\r\n  const [voiRange, setVoiRange] = useState<{ lower: number; upper: number } | undefined>();\r\n  const voiRangeRef = React.useRef<{ lower: number; upper: number } | undefined>();\r\n  const [opacity, setOpacityState] = useState<number | undefined>();\r\n  const [opacityLinear, setOpacityLinearState] = useState<number | undefined>();\r\n  const [threshold, setThresholdState] = useState<number | undefined>();\r\n  const [pixelValueRange, setPixelValueRange] = useState<PixelValueRange>({ min: 0, max: 255 });\r\n\r\n  const { viewportDisplaySets } = useViewportDisplaySets(viewportId);\r\n  const { displaySetService } = servicesManager.services;\r\n\r\n  // Determine the active display set instance UID (internal only, not exposed)\r\n  const activeDisplaySetInstanceUID = useMemo(() => {\r\n    if (options?.displaySetInstanceUID) {\r\n      return options.displaySetInstanceUID;\r\n    }\r\n\r\n    if (viewportDisplaySets && viewportDisplaySets.length > 0) {\r\n      return viewportDisplaySets[0].displaySetInstanceUID;\r\n    }\r\n\r\n    return undefined;\r\n  }, [options?.displaySetInstanceUID, viewportDisplaySets]);\r\n\r\n  const viewportInfo = viewportId ? cornerstoneViewportService.getViewportInfo(viewportId) : null;\r\n\r\n  const { presets, colorbarProperties, volumeRenderingPresets, volumeRenderingQualityRange } =\r\n    getCustomizationData(customizationService);\r\n\r\n  const backgroundColor = viewportInfo?.getViewportOptions().background;\r\n  const isViewportBackgroundLight = backgroundColor\r\n    ? utilities.isEqual(backgroundColor, [1, 1, 1])\r\n    : false;\r\n\r\n  const allWindowLevelPresets = useMemo(() => {\r\n    return (\r\n      viewportDisplaySets\r\n        ?.filter(displaySet => presets?.[displaySet.Modality as string])\r\n        .map(displaySet => {\r\n          return {\r\n            displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n            modality: displaySet.Modality as string,\r\n            presets: presets[displaySet.Modality as string],\r\n          };\r\n        }) || []\r\n    );\r\n  }, [viewportDisplaySets, presets]);\r\n\r\n  // Calculate pixel value range for the active display set\r\n  useEffect(() => {\r\n    if (!activeDisplaySetInstanceUID) {\r\n      return;\r\n    }\r\n\r\n    const selectedDisplaySet = displaySetService.getDisplaySetByUID(activeDisplaySetInstanceUID);\r\n    if (!selectedDisplaySet?.imageIds?.length) {\r\n      return;\r\n    }\r\n\r\n    const csViewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n    if (!csViewport) {\r\n      return;\r\n    }\r\n\r\n    if (!(csViewport instanceof BaseVolumeViewport)) {\r\n      return;\r\n    }\r\n\r\n    const volumeIds = csViewport.getAllVolumeIds();\r\n    const volumeId = volumeIds.find(id => id.includes(activeDisplaySetInstanceUID));\r\n\r\n    if (!volumeId) {\r\n      return;\r\n    }\r\n\r\n    // only handle volume viewports for now\r\n    const imageData = csViewport.getImageData(volumeId);\r\n\r\n    if (!imageData) {\r\n      return;\r\n    }\r\n\r\n    const imageDataVtk = imageData.imageData;\r\n\r\n    const { voxelManager } = imageDataVtk.get('voxelManager');\r\n\r\n    const range = voxelManager.getRange();\r\n\r\n    setPixelValueRange({ min: range[0], max: range[1] });\r\n  }, [activeDisplaySetInstanceUID, displaySetService, cornerstoneViewportService, viewportId]);\r\n\r\n  // Get the presets specifically for the active display set\r\n  const activeDisplaySetPresets = useMemo(() => {\r\n    if (!activeDisplaySetInstanceUID || allWindowLevelPresets.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    const activePresetData = allWindowLevelPresets.find(\r\n      preset => preset.displaySetInstanceUID === activeDisplaySetInstanceUID\r\n    );\r\n\r\n    if (!activePresetData) {\r\n      return [];\r\n    }\r\n\r\n    return activePresetData.presets;\r\n  }, [allWindowLevelPresets, activeDisplaySetInstanceUID]);\r\n\r\n  useEffect(() => {\r\n    setIs3DVolume(is3DViewport({ viewportId, cornerstoneViewportService }));\r\n\r\n    const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n    // Initialize the VOI range from the viewport\r\n    if (viewport && activeDisplaySetInstanceUID) {\r\n      try {\r\n        let properties;\r\n\r\n        if (viewport instanceof StackViewport) {\r\n          properties = viewport.getProperties();\r\n          if (properties.voiRange) {\r\n            setVoiRange(properties.voiRange);\r\n            voiRangeRef.current = properties.voiRange;\r\n          }\r\n        } else if (viewport instanceof BaseVolumeViewport) {\r\n          // For volume viewports, find the actor for the active display set\r\n          const volumeIds = viewport.getAllVolumeIds();\r\n          const volumeId = volumeIds.find(id => id.includes(activeDisplaySetInstanceUID));\r\n\r\n          if (volumeId) {\r\n            properties = viewport.getProperties(volumeId);\r\n            if (properties.voiRange) {\r\n              setVoiRange(properties.voiRange);\r\n              voiRangeRef.current = properties.voiRange;\r\n            }\r\n\r\n            // Get opacity from colormap if available\r\n            if (properties.colormap && properties.colormap.opacity !== undefined) {\r\n              const isArray = Array.isArray(properties.colormap.opacity);\r\n              const opacity = isArray\r\n                ? properties.colormap.opacity.reduce((max, current) => Math.max(max, current), 0)\r\n                : properties.colormap.opacity;\r\n\r\n              setOpacityState(opacity);\r\n              setOpacityLinearState(opacityToLinear(opacity));\r\n            }\r\n\r\n            // Get threshold from colormap if available\r\n            if (properties.colormap && properties.colormap.threshold !== undefined) {\r\n              setThresholdState(properties.colormap.threshold);\r\n            }\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.error('Error initializing VOI range:', error);\r\n      }\r\n    }\r\n  }, [cornerstoneViewportService, viewportId, activeDisplaySetInstanceUID]);\r\n\r\n  useEffect(() => {\r\n    if (!viewportId) {\r\n      return;\r\n    }\r\n\r\n    const updateColorbarState = () => {\r\n      const hasColorbarValue = colorbarService.hasColorbar(viewportId);\r\n      setHasColorbar(hasColorbarValue);\r\n    };\r\n\r\n    updateColorbarState();\r\n\r\n    const { unsubscribe } = colorbarService.subscribe(\r\n      colorbarService.EVENTS.STATE_CHANGED,\r\n      updateColorbarState\r\n    );\r\n\r\n    return () => {\r\n      unsubscribe();\r\n    };\r\n  }, [colorbarService, viewportId]);\r\n\r\n  useEffect(() => {\r\n    if (!viewportId || !activeDisplaySetInstanceUID) {\r\n      return;\r\n    }\r\n\r\n    const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n    if (!viewport) {\r\n      return;\r\n    }\r\n\r\n    const element = viewport.element;\r\n    if (!element) {\r\n      return;\r\n    }\r\n\r\n    const updateVOI = eventDetail => {\r\n      const { range } = eventDetail.detail;\r\n\r\n      if (!range) {\r\n        return;\r\n      }\r\n\r\n      // Check if this update is coming from our own setVOIRange or setWindowLevel call\r\n      // If so, we already updated our state and don't need to do it again\r\n      const isInternalUpdate = voiRangeRef.current && areVoiRangesClose(voiRangeRef.current, range);\r\n\r\n      if (!isInternalUpdate) {\r\n        voiRangeRef.current = range;\r\n        setVoiRange(range);\r\n      }\r\n    };\r\n\r\n    const updateColormap = eventDetail => {\r\n      const { colormap } = eventDetail.detail;\r\n\r\n      if (!colormap) {\r\n        return;\r\n      }\r\n\r\n      // Extract threshold from colormap in the event detail\r\n      if (colormap.threshold !== undefined) {\r\n        setThresholdState(colormap.threshold);\r\n      }\r\n\r\n      if (colormap.opacity !== undefined) {\r\n        setOpacityState(colormap.opacity);\r\n        setOpacityLinearState(opacityToLinear(colormap.opacity));\r\n      }\r\n    };\r\n\r\n    element.addEventListener(Enums.Events.VOI_MODIFIED, updateVOI);\r\n    element.addEventListener(Enums.Events.COLORMAP_MODIFIED, updateColormap);\r\n\r\n    return () => {\r\n      element.removeEventListener(Enums.Events.VOI_MODIFIED, updateVOI);\r\n      element.removeEventListener(Enums.Events.COLORMAP_MODIFIED, updateColormap);\r\n    };\r\n  }, [viewportId, activeDisplaySetInstanceUID, cornerstoneViewportService, opacityToLinear]);\r\n\r\n  const validateActiveDisplaySet = useCallback(() => {\r\n    if (!activeDisplaySetInstanceUID) {\r\n      throw new Error('No active display set instance UID is available');\r\n    }\r\n\r\n    if (viewportDisplaySets?.length === 0) {\r\n      throw new Error('No display sets are available for this viewport');\r\n    }\r\n\r\n    // Verify the active display set is in the viewport\r\n    const isDisplaySetInViewport = viewportDisplaySets?.some(\r\n      ds => ds.displaySetInstanceUID === activeDisplaySetInstanceUID\r\n    );\r\n\r\n    if (!isDisplaySetInViewport) {\r\n      throw new Error(\r\n        `Display set with UID ${activeDisplaySetInstanceUID} is not present in the viewport`\r\n      );\r\n    }\r\n\r\n    return activeDisplaySetInstanceUID;\r\n  }, [activeDisplaySetInstanceUID, viewportDisplaySets]);\r\n\r\n  const setWindowLevel = useCallback(\r\n    (preset: { windowWidth: number; windowCenter: number; immediate?: boolean }) => {\r\n      if (!viewportId) {\r\n        return;\r\n      }\r\n\r\n      const displaySetInstanceUID = validateActiveDisplaySet();\r\n\r\n      // Update voiRange as well, to ensure immediate UI updates\r\n      const { lower, upper } = utilities.windowLevel.toLowHighRange(\r\n        preset.windowWidth,\r\n        preset.windowCenter\r\n      );\r\n\r\n      const newVoiRange = { lower, upper };\r\n\r\n      if (!voiRangeRef.current || !areVoiRangesClose(voiRangeRef.current, newVoiRange)) {\r\n        voiRangeRef.current = newVoiRange;\r\n        setVoiRange(newVoiRange);\r\n\r\n        commandsManager.run({\r\n          commandName: 'setViewportWindowLevel',\r\n          commandOptions: {\r\n            ...preset,\r\n            viewportId,\r\n            displaySetInstanceUID,\r\n          },\r\n          context: 'CORNERSTONE',\r\n        });\r\n      }\r\n    },\r\n    [commandsManager, viewportId, validateActiveDisplaySet]\r\n  );\r\n\r\n  const setVOIRange = useCallback(\r\n    (params: { lower: number; upper: number }) => {\r\n      if (!viewportId) {\r\n        return;\r\n      }\r\n\r\n      // Only update if VOI values have actually changed\r\n      if (!voiRangeRef.current || !areVoiRangesClose(voiRangeRef.current, params)) {\r\n        // Update the ref and state immediately to avoid race conditions with the event listener\r\n        voiRangeRef.current = params;\r\n        setVoiRange(params);\r\n\r\n        const windowLevel = utilities.windowLevel.toWindowLevel(params.lower, params.upper);\r\n\r\n        // Set window level using the command manager directly to avoid circular calls\r\n        const displaySetInstanceUID = validateActiveDisplaySet();\r\n        commandsManager.run({\r\n          commandName: 'setViewportWindowLevel',\r\n          commandOptions: {\r\n            ...windowLevel,\r\n            viewportId,\r\n            displaySetInstanceUID,\r\n          },\r\n          context: 'CORNERSTONE',\r\n        });\r\n      }\r\n    },\r\n    [viewportId, commandsManager, validateActiveDisplaySet]\r\n  );\r\n\r\n  const toggleColorbar = useCallback(\r\n    (options?: Partial<ColorbarOptions>) => {\r\n      if (!viewportId) {\r\n        return;\r\n      }\r\n\r\n      if (viewportDisplaySets?.length === 0) {\r\n        return;\r\n      }\r\n\r\n      if (!colorbarProperties) {\r\n        return;\r\n      }\r\n\r\n      const {\r\n        width: colorbarWidth,\r\n        colorbarTickPosition,\r\n        colorbarInitialColormap,\r\n      } = colorbarProperties as ColorbarProperties;\r\n\r\n      let appropriateTickPosition = colorbarTickPosition || 'top';\r\n\r\n      if (colorbarPosition === 'left' || colorbarPosition === 'right') {\r\n        appropriateTickPosition = colorbarPosition === 'left' ? 'right' : 'left';\r\n      } else {\r\n        appropriateTickPosition = colorbarPosition === 'top' ? 'bottom' : 'top';\r\n      }\r\n\r\n      const colorbarOptions = {\r\n        viewportId,\r\n        colormaps: colorbarProperties.colormaps || {},\r\n        ticks: {\r\n          position: appropriateTickPosition,\r\n        },\r\n        width: colorbarWidth,\r\n        position: colorbarPosition,\r\n        activeColormapName: colorbarInitialColormap || 'Grayscale',\r\n        ...options,\r\n      };\r\n\r\n      // If light background, adjust tick style but keep the appropriate position\r\n      if (isViewportBackgroundLight) {\r\n        colorbarOptions.ticks = {\r\n          position: appropriateTickPosition,\r\n          style: {\r\n            font: '13px Inter',\r\n            color: '#000000',\r\n            maxNumTicks: 8,\r\n            tickSize: 5,\r\n            tickWidth: 1,\r\n            labelMargin: 3,\r\n          },\r\n        };\r\n      }\r\n\r\n      const displaySetInstanceUIDs = viewportDisplaySets.map(ds => ds.displaySetInstanceUID);\r\n\r\n      try {\r\n        commandsManager.run('toggleViewportColorbar', {\r\n          viewportId,\r\n          options: colorbarOptions,\r\n          displaySetInstanceUIDs,\r\n        });\r\n      } catch (error) {\r\n        console.error('Error toggling colorbar:', error);\r\n      }\r\n    },\r\n    [\r\n      commandsManager,\r\n      viewportId,\r\n      colorbarProperties,\r\n      isViewportBackgroundLight,\r\n      viewportDisplaySets,\r\n      colorbarPosition,\r\n    ]\r\n  );\r\n\r\n  const setColormap = useCallback(\r\n    ({ colormap, opacity = 1, immediate = false }) => {\r\n      if (!viewportId) {\r\n        return;\r\n      }\r\n\r\n      const displaySetInstanceUID = validateActiveDisplaySet();\r\n\r\n      // Update local opacity state\r\n      if (opacity !== undefined) {\r\n        setOpacityState(opacity);\r\n      }\r\n\r\n      commandsManager.run({\r\n        commandName: 'setViewportColormap',\r\n        commandOptions: {\r\n          viewportId,\r\n          colormap,\r\n          displaySetInstanceUID,\r\n          opacity,\r\n          immediate,\r\n        },\r\n        context: 'CORNERSTONE',\r\n      });\r\n    },\r\n    [commandsManager, viewportId, validateActiveDisplaySet]\r\n  );\r\n\r\n  const setOpacity = useCallback(\r\n    (opacityValue: number) => {\r\n      if (!viewportId) {\r\n        return;\r\n      }\r\n\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n      if (!viewport || !(viewport instanceof BaseVolumeViewport)) {\r\n        return;\r\n      }\r\n\r\n      // Apply the actual opacity value\r\n      setOpacityState(opacityValue);\r\n      // Update the linear value for UI\r\n      setOpacityLinearState(opacityToLinear(opacityValue));\r\n\r\n      const displaySetInstanceUID = validateActiveDisplaySet();\r\n      const volumeIds = viewport.getAllVolumeIds();\r\n      const volumeId = volumeIds.find(id => id.includes(displaySetInstanceUID));\r\n\r\n      if (!volumeId) {\r\n        return;\r\n      }\r\n\r\n      // Get current properties including colormap\r\n      const properties = viewport.getProperties(volumeId);\r\n      const currentColormap = properties.colormap || {};\r\n\r\n      // Update colormap with new opacity\r\n      const updatedColormap = {\r\n        ...currentColormap,\r\n        opacity: opacityValue,\r\n      };\r\n\r\n      // Apply updated colormap\r\n      viewport.setProperties(\r\n        {\r\n          colormap: updatedColormap,\r\n        },\r\n        volumeId\r\n      );\r\n\r\n      viewport.render();\r\n    },\r\n    [cornerstoneViewportService, viewportId, validateActiveDisplaySet, opacityToLinear]\r\n  );\r\n\r\n  const setOpacityLinear = useCallback(\r\n    (linearValue: number) => {\r\n      // Convert linear UI value to actual opacity value and apply it\r\n      const actualOpacity = linearToOpacity(linearValue);\r\n      setOpacity(actualOpacity);\r\n    },\r\n    [linearToOpacity, setOpacity]\r\n  );\r\n\r\n  const setThreshold = useCallback(\r\n    (thresholdValue: number) => {\r\n      if (!viewportId) {\r\n        return;\r\n      }\r\n\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n      if (!viewport || !(viewport instanceof BaseVolumeViewport)) {\r\n        return;\r\n      }\r\n\r\n      setThresholdState(thresholdValue);\r\n\r\n      const displaySetInstanceUID = validateActiveDisplaySet();\r\n      const volumeIds = viewport.getAllVolumeIds();\r\n      const volumeId = volumeIds.find(id => id.includes(displaySetInstanceUID));\r\n\r\n      if (!volumeId) {\r\n        return;\r\n      }\r\n\r\n      console.debug(' ~ thresholdValue:', thresholdValue);\r\n\r\n      viewport.setProperties(\r\n        {\r\n          colormap: {\r\n            threshold: thresholdValue,\r\n          },\r\n        },\r\n        volumeId\r\n      );\r\n\r\n      viewport.render();\r\n    },\r\n    [cornerstoneViewportService, viewportId, validateActiveDisplaySet]\r\n  );\r\n\r\n  // Get the current colormap for the active display set\r\n  const colormap = useMemo(() => {\r\n    if (!viewportId || !activeDisplaySetInstanceUID || !viewportDisplaySets?.length) {\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n      if (!viewport) {\r\n        return null;\r\n      }\r\n\r\n      if (viewport instanceof StackViewport) {\r\n        const { colormap } = viewport.getProperties();\r\n        if (!colormap) {\r\n          return (\r\n            colorbarProperties?.colormaps?.find(c => c.Name === 'Grayscale') ||\r\n            colorbarProperties?.colormaps?.[0]\r\n          );\r\n        }\r\n        return colormap;\r\n      }\r\n\r\n      const actorEntries = viewport.getActors();\r\n      const actorEntry = actorEntries?.find(entry =>\r\n        entry.referencedId.includes(activeDisplaySetInstanceUID)\r\n      );\r\n\r\n      if (!actorEntry) {\r\n        return (\r\n          colorbarProperties?.colormaps?.find(c => c.Name === 'Grayscale') ||\r\n          colorbarProperties?.colormaps?.[0]\r\n        );\r\n      }\r\n\r\n      const { colormap } = (viewport as Types.IVolumeViewport).getProperties(\r\n        actorEntry.referencedId\r\n      );\r\n\r\n      if (!colormap) {\r\n        return (\r\n          colorbarProperties?.colormaps?.find(c => c.Name === 'Grayscale') ||\r\n          colorbarProperties?.colormaps?.[0]\r\n        );\r\n      }\r\n\r\n      return colormap;\r\n    } catch (error) {\r\n      console.error('Error getting viewport colormap:', error);\r\n      return (\r\n        colorbarProperties?.colormaps?.find(c => c.Name === 'Grayscale') ||\r\n        colorbarProperties?.colormaps?.[0]\r\n      );\r\n    }\r\n  }, [\r\n    cornerstoneViewportService,\r\n    viewportId,\r\n    activeDisplaySetInstanceUID,\r\n    viewportDisplaySets,\r\n    colorbarProperties?.colormaps,\r\n  ]);\r\n\r\n  // 3D volume rendering functions\r\n  const setVolumeRenderingPreset = useCallback(\r\n    (preset: any) => {\r\n      if (!viewportId) {\r\n        return;\r\n      }\r\n\r\n      const displaySetInstanceUID = validateActiveDisplaySet();\r\n\r\n      commandsManager.run({\r\n        commandName: 'setVolumesPreset',\r\n        commandOptions: {\r\n          preset,\r\n          viewportId,\r\n          displaySetInstanceUID,\r\n        },\r\n      });\r\n    },\r\n    [commandsManager, viewportId, validateActiveDisplaySet]\r\n  );\r\n\r\n  const setVolumeRenderingQuality = useCallback(\r\n    (quality: number) => {\r\n      if (!viewportId) {\r\n        return;\r\n      }\r\n\r\n      commandsManager.run({\r\n        commandName: 'setVolumeRenderingQuality',\r\n        commandOptions: {\r\n          quality,\r\n          viewportId,\r\n        },\r\n      });\r\n    },\r\n    [commandsManager, viewportId]\r\n  );\r\n\r\n  const setVolumeLighting = useCallback(\r\n    ({ ambient, diffuse, specular }: VolumeLightingParams) => {\r\n      if (!viewportId) {\r\n        return;\r\n      }\r\n\r\n      commandsManager.run({\r\n        commandName: 'setVolumeLighting',\r\n        commandOptions: {\r\n          ambient,\r\n          diffuse,\r\n          specular,\r\n          viewportId,\r\n        },\r\n      });\r\n    },\r\n    [commandsManager, viewportId]\r\n  );\r\n\r\n  const setVolumeShading = useCallback(\r\n    (enabled: boolean) => {\r\n      if (!viewportId) {\r\n        return;\r\n      }\r\n\r\n      commandsManager.run({\r\n        commandName: 'setVolumeShading',\r\n        commandOptions: {\r\n          enabled,\r\n          viewportId,\r\n        },\r\n      });\r\n    },\r\n    [commandsManager, viewportId]\r\n  );\r\n\r\n  return {\r\n    is3DVolume,\r\n    isViewportBackgroundLight,\r\n\r\n    // Window level functions\r\n    setWindowLevel,\r\n    setVOIRange,\r\n    voiRange,\r\n    windowLevel: utilities.windowLevel.toWindowLevel(voiRange?.lower, voiRange?.upper),\r\n\r\n    // Colorbar functions\r\n    hasColorbar,\r\n    toggleColorbar,\r\n\r\n    // Colormap functions\r\n    setColormap,\r\n    colormap,\r\n\r\n    // Opacity functions\r\n    opacity,\r\n    setOpacity,\r\n    opacityLinear,\r\n    setOpacityLinear,\r\n\r\n    // Threshold functions\r\n    threshold,\r\n    setThreshold,\r\n    pixelValueRange,\r\n\r\n    // 3D volume rendering functions\r\n    setVolumeRenderingPreset,\r\n    setVolumeRenderingQuality,\r\n    setVolumeLighting,\r\n    setVolumeShading,\r\n\r\n    // Display sets\r\n    viewportDisplaySets,\r\n\r\n    // Colorbar properties\r\n    colorbarProperties,\r\n    colorbarPosition,\r\n    setColorbarPosition,\r\n\r\n    // Presets\r\n    windowLevelPresets: activeDisplaySetPresets,\r\n    allWindowLevelPresets,\r\n    volumeRenderingPresets,\r\n    volumeRenderingQualityRange,\r\n  };\r\n}\r\n\r\nexport default useViewportRendering;\r\n\r\n/**\r\n * Helper function to compare two VOI ranges with a small tolerance.\r\n * @param rangeA - The first VOI range { lower, upper }.\r\n * @param rangeB - The second VOI range { lower, upper }.\r\n * @param epsilon - The tolerance for comparison.\r\n * @returns True if the ranges are considered close, false otherwise.\r\n */\r\nfunction areVoiRangesClose(\r\n  rangeA: { lower: number; upper: number },\r\n  rangeB: { lower: number; upper: number },\r\n  epsilon = 0.001\r\n): boolean {\r\n  if (!rangeA || !rangeB) {\r\n    return false;\r\n  }\r\n  return (\r\n    Math.abs(rangeA.lower - rangeB.lower) < epsilon &&\r\n    Math.abs(rangeA.upper - rangeB.upper) < epsilon\r\n  );\r\n}\r\n\r\nfunction getCustomizationData(customizationService) {\r\n  const presets = customizationService.getCustomization('cornerstone.windowLevelPresets');\r\n  const colorbarProperties = customizationService.getCustomization(\r\n    'cornerstone.colorbar'\r\n  ) as ColorbarProperties;\r\n\r\n  const {\r\n    volumeRenderingPresets = [],\r\n    volumeRenderingQualityRange = { min: 0, max: 1, step: 0.1 },\r\n  } =\r\n    (customizationService.getCustomization(\r\n      'cornerstone.3dVolumeRendering'\r\n    ) as VolumeRenderingConfig) || {};\r\n\r\n  return {\r\n    presets,\r\n    colorbarProperties,\r\n    volumeRenderingPresets,\r\n    volumeRenderingQualityRange,\r\n  };\r\n}\r\n","import { useState, useEffect } from 'react';\r\nimport debounce from 'lodash.debounce';\r\nimport { roundNumber } from '@ohif/core/src/utils';\r\nimport {\r\n  SegmentationData,\r\n  SegmentationRepresentation,\r\n} from '../services/SegmentationService/SegmentationService';\r\nimport { useSystem } from '@ohif/core';\r\nconst excludedModalities = ['SM', 'OT', 'DOC', 'ECG'];\r\n\r\nfunction mapSegmentationToDisplay(segmentation, customizationService) {\r\n  const { label, segments } = segmentation;\r\n\r\n  // Get the readable text mapping once\r\n  const readableTextMap = customizationService.getCustomization('panelSegmentation.readableText');\r\n\r\n  // Helper function to recursively map cachedStats to readable display text\r\n  function mapStatsToDisplay(stats, indent = 0) {\r\n    const primary = [];\r\n    const indentation = '  '.repeat(indent);\r\n\r\n    for (const key in stats) {\r\n      if (Object.prototype.hasOwnProperty.call(stats, key)) {\r\n        const value = stats[key];\r\n        const readableText = readableTextMap?.[key];\r\n\r\n        if (!readableText) {\r\n          continue;\r\n        }\r\n\r\n        if (typeof value === 'object' && value !== null && !Array.isArray(value)) {\r\n          // Add empty row before category (except for the first category)\r\n          if (primary.length > 0) {\r\n            primary.push('');\r\n          }\r\n          // Add category title\r\n          primary.push(`${indentation}${readableText}`);\r\n          // Recursively handle nested objects\r\n          primary.push(...mapStatsToDisplay(value, indent + 1));\r\n        } else {\r\n          // For non-nested values, don't add empty rows\r\n          primary.push(`${indentation}${readableText}: ${roundNumber(value, 2)}`);\r\n        }\r\n      }\r\n    }\r\n\r\n    return primary;\r\n  }\r\n\r\n  // Get customization for display text mapping\r\n  const displayTextMapper = segment => {\r\n    const defaultDisplay = {\r\n      primary: [],\r\n      secondary: [],\r\n    };\r\n\r\n    // If the segment has cachedStats, map it to readable text\r\n    if (segment.cachedStats) {\r\n      const primary = mapStatsToDisplay(segment.cachedStats);\r\n      defaultDisplay.primary = primary;\r\n    }\r\n\r\n    return defaultDisplay;\r\n  };\r\n\r\n  const updatedSegments = {};\r\n\r\n  Object.entries(segments).forEach(([segmentIndex, segment]) => {\r\n    updatedSegments[segmentIndex] = {\r\n      ...segment,\r\n      displayText: displayTextMapper(segment),\r\n    };\r\n  });\r\n\r\n  // Map the segments and apply the display text mapper\r\n  return {\r\n    ...segmentation,\r\n    label,\r\n    segments: updatedSegments,\r\n  };\r\n}\r\n\r\n/**\r\n * Represents the combination of segmentation data and its representation in a viewport.\r\n */\r\ntype ViewportSegmentationRepresentation = {\r\n  segmentationsWithRepresentations: {\r\n    representation: SegmentationRepresentation;\r\n    segmentation: SegmentationData;\r\n  }[];\r\n  disabled: boolean;\r\n};\r\n\r\n/**\r\n * Custom hook that provides segmentation data and their representations for the active viewport.\r\n * @param options - The options object.\r\n * @param options.servicesManager - The services manager object.\r\n * @param options.subscribeToDataModified - Whether to subscribe to segmentation data modifications.\r\n * @param options.debounceTime - Debounce time in milliseconds for updates.\r\n * @returns An array of segmentation data and their representations for the active viewport.\r\n */\r\nexport function useViewportSegmentations({\r\n  viewportId,\r\n  subscribeToDataModified = false,\r\n  debounceTime = 0,\r\n}: {\r\n  viewportId: string;\r\n  subscribeToDataModified?: boolean;\r\n  debounceTime?: number;\r\n}): ViewportSegmentationRepresentation {\r\n  const { servicesManager } = useSystem();\r\n  const { segmentationService, viewportGridService, customizationService, displaySetService } =\r\n    servicesManager.services;\r\n\r\n  const [segmentationsWithRepresentations, setSegmentationsWithRepresentations] =\r\n    useState<ViewportSegmentationRepresentation>({\r\n      segmentationsWithRepresentations: [],\r\n      disabled: false,\r\n    });\r\n\r\n  useEffect(() => {\r\n    const update = () => {\r\n      const displaySetUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewportId);\r\n\r\n      if (!displaySetUIDs?.length) {\r\n        return;\r\n      }\r\n\r\n      const displaySet = displaySetService.getDisplaySetByUID(displaySetUIDs[0]);\r\n\r\n      if (!displaySet) {\r\n        return;\r\n      }\r\n\r\n      if (excludedModalities.includes(displaySet.Modality)) {\r\n        setSegmentationsWithRepresentations(prev => ({\r\n          segmentationsWithRepresentations: [],\r\n          disabled: true,\r\n        }));\r\n        return;\r\n      }\r\n\r\n      const segmentations = segmentationService.getSegmentations();\r\n\r\n      if (!segmentations?.length) {\r\n        setSegmentationsWithRepresentations(prev => ({\r\n          segmentationsWithRepresentations: [],\r\n          disabled: false,\r\n        }));\r\n        return;\r\n      }\r\n\r\n      const representations = segmentationService.getSegmentationRepresentations(viewportId);\r\n\r\n      const newSegmentationsWithRepresentations = representations.map(representation => {\r\n        const segmentation = segmentationService.getSegmentation(representation.segmentationId);\r\n        const mappedSegmentation = mapSegmentationToDisplay(segmentation, customizationService);\r\n        return {\r\n          representation,\r\n          segmentation: mappedSegmentation,\r\n        };\r\n      });\r\n\r\n      setSegmentationsWithRepresentations({\r\n        segmentationsWithRepresentations: newSegmentationsWithRepresentations,\r\n        disabled: false,\r\n      });\r\n    };\r\n\r\n    const debouncedUpdate =\r\n      debounceTime > 0 ? debounce(update, debounceTime, { leading: true, trailing: true }) : update;\r\n\r\n    update();\r\n\r\n    const subscriptions = [\r\n      segmentationService.subscribe(\r\n        segmentationService.EVENTS.SEGMENTATION_MODIFIED,\r\n        debouncedUpdate\r\n      ),\r\n      segmentationService.subscribe(\r\n        segmentationService.EVENTS.SEGMENTATION_REMOVED,\r\n        debouncedUpdate\r\n      ),\r\n      segmentationService.subscribe(\r\n        segmentationService.EVENTS.SEGMENTATION_REPRESENTATION_MODIFIED,\r\n        debouncedUpdate\r\n      ),\r\n      viewportGridService.subscribe(\r\n        viewportGridService.EVENTS.ACTIVE_VIEWPORT_ID_CHANGED,\r\n        debouncedUpdate\r\n      ),\r\n      viewportGridService.subscribe(viewportGridService.EVENTS.GRID_STATE_CHANGED, debouncedUpdate),\r\n    ];\r\n\r\n    if (subscribeToDataModified) {\r\n      subscriptions.push(\r\n        segmentationService.subscribe(\r\n          segmentationService.EVENTS.SEGMENTATION_DATA_MODIFIED,\r\n          debouncedUpdate\r\n        )\r\n      );\r\n    }\r\n\r\n    return () => {\r\n      subscriptions.forEach(subscription => subscription.unsubscribe());\r\n      if (debounceTime > 0) {\r\n        debouncedUpdate.cancel();\r\n      }\r\n    };\r\n  }, [\r\n    segmentationService,\r\n    viewportGridService,\r\n    customizationService,\r\n    displaySetService,\r\n    debounceTime,\r\n    subscribeToDataModified,\r\n    viewportId,\r\n  ]);\r\n\r\n  return segmentationsWithRepresentations;\r\n}\r\n","import { HYDRATE_SEG_SYNC_GROUP, VOI_SYNC_GROUP } from './mpr';\r\n\r\nexport const fourUp = {\r\n  id: 'fourUp',\r\n  locked: true,\r\n  name: '3D four up',\r\n  icon: 'layout-advanced-3d-four-up',\r\n  isPreset: true,\r\n  createdDate: '2023-03-15T10:29:44.894Z',\r\n  modifiedDate: '2023-03-15T10:29:44.894Z',\r\n  availableTo: {},\r\n  editableBy: {},\r\n  protocolMatchingRules: [],\r\n  imageLoadStrategy: 'interleaveCenter',\r\n  displaySetSelectors: {\r\n    activeDisplaySet: {\r\n      seriesMatchingRules: [\r\n        {\r\n          weight: 1,\r\n          attribute: 'isReconstructable',\r\n          constraint: {\r\n            equals: {\r\n              value: true,\r\n            },\r\n          },\r\n          required: true,\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  stages: [\r\n    {\r\n      id: 'fourUpStage',\r\n      name: 'fourUp',\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 2,\r\n          columns: 2,\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'axial',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'volume3d',\r\n            viewportType: 'volume3d',\r\n            orientation: 'coronal',\r\n            customViewportProps: {\r\n              hideOverlays: true,\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n              options: {\r\n                displayPreset: {\r\n                  CT: 'CT-Bone',\r\n                  MR: 'MR-Default',\r\n                  default: 'CT-Bone',\r\n                },\r\n              },\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'coronal',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'sagittal',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  ],\r\n};\r\n","import { Types } from '@ohif/core';\r\n\r\nconst frameView: Types.HangingProtocol.Protocol = {\r\n  id: '@ohif/frameView',\r\n  description: 'Frame view for the active series',\r\n  name: 'Frame View',\r\n  icon: 'tool-stack-scroll',\r\n  isPreset: true,\r\n  toolGroupIds: ['default'],\r\n  protocolMatchingRules: [],\r\n  displaySetSelectors: {\r\n    defaultDisplaySetId: {\r\n      seriesMatchingRules: [\r\n        {\r\n          attribute: 'numImageFrames',\r\n          constraint: {\r\n            greaterThan: { value: 16 },\r\n          },\r\n          required: true,\r\n        },\r\n        {\r\n          attribute: 'isDisplaySetFromUrl',\r\n          weight: 20,\r\n          constraint: {\r\n            equals: true,\r\n          },\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  defaultViewport: {\r\n    viewportOptions: {\r\n      viewportType: 'stack',\r\n      toolGroupId: 'default',\r\n      allowUnmatchedView: true,\r\n    },\r\n    displaySets: [\r\n      {\r\n        id: 'defaultDisplaySetId',\r\n        matchedDisplaySetsIndex: -1,\r\n      },\r\n    ],\r\n  },\r\n  stages: [\r\n    {\r\n      name: 'frameView',\r\n      id: '4x4',\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 4,\r\n          columns: 4,\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R0_C0',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 0,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R0_C1',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 1,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R0_C2',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 2,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R0_C3',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 3,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R1_C0',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 4,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R1_C1',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 5,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R1_C2',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 6,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R1_C3',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 7,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R2_C0',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 8,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R2_C1',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 9,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R2_C2',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 10,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R2_C3',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 11,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R3_C0',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 12,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R3_C1',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 13,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R3_C2',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 14,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'custom_R3_C3',\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 15,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n    {\r\n      name: 'frameView',\r\n      id: '3x3',\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 3,\r\n          columns: 3,\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 0,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 1,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 2,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 3,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 4,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 5,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 6,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 7,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 8,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n    {\r\n      name: 'frameView',\r\n      id: '3x2',\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 2,\r\n          columns: 3,\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 0,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 1,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 2,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 3,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 4,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 5,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n    {\r\n      name: 'frameView',\r\n      id: '2x2',\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 2,\r\n          columns: 2,\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 0,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 1,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 2,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 3,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n    {\r\n      name: 'frameView',\r\n      id: '1x3',\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 1,\r\n          columns: 3,\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 0,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 1,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 2,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n    {\r\n      name: 'frameView',\r\n      id: '1x2',\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 1,\r\n          columns: 2,\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 0,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'default',\r\n            syncGroups: [\r\n              {\r\n                type: 'zoompan',\r\n                id: 'zoompansync',\r\n                source: true,\r\n                target: true,\r\n              },\r\n              {\r\n                type: 'voi',\r\n                id: 'wlsync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  syncColormap: true,\r\n                },\r\n              },\r\n              {\r\n                type: 'frameview',\r\n                id: 'frameViewSync',\r\n                source: true,\r\n                target: true,\r\n                options: {\r\n                  viewportIndex: 1,\r\n                },\r\n              },\r\n            ],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'defaultDisplaySetId',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  ],\r\n};\r\n\r\nexport { frameView };\r\n","import { HYDRATE_SEG_SYNC_GROUP, VOI_SYNC_GROUP } from './mpr';\r\n\r\nexport const main3D = {\r\n  id: 'main3D',\r\n  locked: true,\r\n  name: '3D main',\r\n  icon: 'layout-advanced-3d-main',\r\n  isPreset: true,\r\n  createdDate: '2023-03-15T10:29:44.894Z',\r\n  modifiedDate: '2023-03-15T10:29:44.894Z',\r\n  availableTo: {},\r\n  editableBy: {},\r\n  protocolMatchingRules: [],\r\n  imageLoadStrategy: 'interleaveCenter',\r\n  displaySetSelectors: {\r\n    activeDisplaySet: {\r\n      seriesMatchingRules: [\r\n        {\r\n          weight: 1,\r\n          attribute: 'isReconstructable',\r\n          constraint: {\r\n            equals: {\r\n              value: true,\r\n            },\r\n          },\r\n          required: true,\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  stages: [\r\n    {\r\n      id: 'main3DStage',\r\n      name: 'main3D',\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 2,\r\n          columns: 3,\r\n          layoutOptions: [\r\n            {\r\n              x: 0,\r\n              y: 0,\r\n              width: 1,\r\n              height: 1 / 2,\r\n            },\r\n            {\r\n              x: 0,\r\n              y: 1 / 2,\r\n              width: 1 / 3,\r\n              height: 1 / 2,\r\n            },\r\n            {\r\n              x: 1 / 3,\r\n              y: 1 / 2,\r\n              width: 1 / 3,\r\n              height: 1 / 2,\r\n            },\r\n            {\r\n              x: 2 / 3,\r\n              y: 1 / 2,\r\n              width: 1 / 3,\r\n              height: 1 / 2,\r\n            },\r\n          ],\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'volume3d',\r\n            viewportType: 'volume3d',\r\n            orientation: 'coronal',\r\n            customViewportProps: {\r\n              hideOverlays: true,\r\n            },\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n              options: {\r\n                displayPreset: {\r\n                  CT: 'CT-Bone',\r\n                  MR: 'MR-Default',\r\n                  default: 'CT-Bone',\r\n                },\r\n              },\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'axial',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'coronal',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'sagittal',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  ],\r\n};\r\n","import { Types } from '@ohif/core';\r\n\r\nexport const VOI_SYNC_GROUP = {\r\n  type: 'voi',\r\n  id: 'mpr',\r\n  source: true,\r\n  target: true,\r\n  options: {\r\n    syncColormap: true,\r\n  },\r\n};\r\n\r\nexport const HYDRATE_SEG_SYNC_GROUP = {\r\n  type: 'hydrateseg',\r\n  id: 'sameFORId',\r\n  source: true,\r\n  target: true,\r\n  options: {\r\n    matchingRules: ['sameFOR'],\r\n  },\r\n};\r\n\r\nexport const mpr: Types.HangingProtocol.Protocol = {\r\n  id: 'mpr',\r\n  name: 'MPR',\r\n  locked: true,\r\n  icon: 'layout-advanced-mpr',\r\n  isPreset: true,\r\n  createdDate: '2021-02-23',\r\n  modifiedDate: '2023-08-15',\r\n  availableTo: {},\r\n  editableBy: {},\r\n  numberOfPriorsReferenced: 0,\r\n  protocolMatchingRules: [],\r\n  imageLoadStrategy: 'nth',\r\n  callbacks: {},\r\n  displaySetSelectors: {\r\n    activeDisplaySet: {\r\n      seriesMatchingRules: [\r\n        {\r\n          weight: 1,\r\n          attribute: 'isReconstructable',\r\n          constraint: {\r\n            equals: {\r\n              value: true,\r\n            },\r\n          },\r\n          required: true,\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  stages: [\r\n    {\r\n      name: 'MPR 1x3',\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 1,\r\n          columns: 3,\r\n          layoutOptions: [\r\n            {\r\n              x: 0,\r\n              y: 0,\r\n              width: 1 / 3,\r\n              height: 1,\r\n            },\r\n            {\r\n              x: 1 / 3,\r\n              y: 0,\r\n              width: 1 / 3,\r\n              height: 1,\r\n            },\r\n            {\r\n              x: 2 / 3,\r\n              y: 0,\r\n              width: 1 / 3,\r\n              height: 1,\r\n            },\r\n          ],\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'mpr-axial',\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'axial',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'mpr-sagittal',\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'sagittal',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            viewportId: 'mpr-coronal',\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'coronal',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  ],\r\n};\r\n","import { HYDRATE_SEG_SYNC_GROUP, VOI_SYNC_GROUP } from './mpr';\r\n\r\nexport const mprAnd3DVolumeViewport = {\r\n  id: 'mprAnd3DVolumeViewport',\r\n  locked: true,\r\n  name: 'mpr',\r\n  createdDate: '2023-03-15T10:29:44.894Z',\r\n  modifiedDate: '2023-03-15T10:29:44.894Z',\r\n  availableTo: {},\r\n  editableBy: {},\r\n  protocolMatchingRules: [],\r\n  imageLoadStrategy: 'interleaveCenter',\r\n  displaySetSelectors: {\r\n    activeDisplaySet: {\r\n      seriesMatchingRules: [\r\n        {\r\n          weight: 1,\r\n          attribute: 'isReconstructable',\r\n          constraint: {\r\n            equals: {\r\n              value: true,\r\n            },\r\n          },\r\n          required: true,\r\n        },\r\n        {\r\n          attribute: 'Modality',\r\n          constraint: {\r\n            equals: {\r\n              value: 'CT',\r\n            },\r\n          },\r\n          required: true,\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  stages: [\r\n    {\r\n      id: 'mpr3Stage',\r\n      name: 'mpr',\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 2,\r\n          columns: 2,\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'axial',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'volume3d',\r\n            viewportType: 'volume3d',\r\n            orientation: 'coronal',\r\n            customViewportProps: {\r\n              hideOverlays: true,\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n              options: {\r\n                displayPreset: {\r\n                  CT: 'CT-Bone',\r\n                  MR: 'MR-Default',\r\n                  default: 'CT-Bone',\r\n                },\r\n              },\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'coronal',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'sagittal',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  ],\r\n};\r\n","import { HYDRATE_SEG_SYNC_GROUP, VOI_SYNC_GROUP } from './mpr';\r\n\r\nexport const only3D = {\r\n  id: 'only3D',\r\n  locked: true,\r\n  name: '3D only',\r\n  icon: 'layout-advanced-3d-only',\r\n  isPreset: true,\r\n  createdDate: '2023-03-15T10:29:44.894Z',\r\n  modifiedDate: '2023-03-15T10:29:44.894Z',\r\n  availableTo: {},\r\n  editableBy: {},\r\n  protocolMatchingRules: [],\r\n  imageLoadStrategy: 'interleaveCenter',\r\n  displaySetSelectors: {\r\n    activeDisplaySet: {\r\n      seriesMatchingRules: [\r\n        {\r\n          weight: 1,\r\n          attribute: 'isReconstructable',\r\n          constraint: {\r\n            equals: {\r\n              value: true,\r\n            },\r\n          },\r\n          required: true,\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  stages: [\r\n    {\r\n      id: 'only3DStage',\r\n      name: 'only3D',\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 1,\r\n          columns: 1,\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'volume3d',\r\n            viewportType: 'volume3d',\r\n            orientation: 'coronal',\r\n            customViewportProps: {\r\n              hideOverlays: true,\r\n              syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n            },\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n              options: {\r\n                displayPreset: {\r\n                  CT: 'CT-Bone',\r\n                  MR: 'MR-Default',\r\n                  default: 'CT-Bone',\r\n                },\r\n              },\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  ],\r\n};\r\n","import { HYDRATE_SEG_SYNC_GROUP, VOI_SYNC_GROUP } from './mpr';\r\n\r\nexport const primary3D = {\r\n  id: 'primary3D',\r\n  locked: true,\r\n  name: '3D primary',\r\n  icon: 'layout-advanced-3d-primary',\r\n  isPreset: true,\r\n  createdDate: '2023-03-15T10:29:44.894Z',\r\n  modifiedDate: '2023-03-15T10:29:44.894Z',\r\n  availableTo: {},\r\n  editableBy: {},\r\n  protocolMatchingRules: [],\r\n  imageLoadStrategy: 'interleaveCenter',\r\n  displaySetSelectors: {\r\n    activeDisplaySet: {\r\n      seriesMatchingRules: [\r\n        {\r\n          weight: 1,\r\n          attribute: 'isReconstructable',\r\n          constraint: {\r\n            equals: {\r\n              value: true,\r\n            },\r\n          },\r\n          required: true,\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  stages: [\r\n    {\r\n      id: 'primary3DStage',\r\n      name: 'primary3D',\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 3,\r\n          columns: 3,\r\n          layoutOptions: [\r\n            {\r\n              x: 0,\r\n              y: 0,\r\n              width: 2 / 3,\r\n              height: 1,\r\n            },\r\n            {\r\n              x: 2 / 3,\r\n              y: 0,\r\n              width: 1 / 3,\r\n              height: 1 / 3,\r\n            },\r\n            {\r\n              x: 2 / 3,\r\n              y: 1 / 3,\r\n              width: 1 / 3,\r\n              height: 1 / 3,\r\n            },\r\n            {\r\n              x: 2 / 3,\r\n              y: 2 / 3,\r\n              width: 1 / 3,\r\n              height: 1 / 3,\r\n            },\r\n          ],\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'volume3d',\r\n            viewportType: 'volume3d',\r\n            orientation: 'coronal',\r\n            customViewportProps: {\r\n              hideOverlays: true,\r\n            },\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n              options: {\r\n                displayPreset: {\r\n                  CT: 'CT-Bone',\r\n                  MR: 'MR-Default',\r\n                  default: 'CT-Bone',\r\n                },\r\n              },\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'axial',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'coronal',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'sagittal',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  ],\r\n};\r\n","import { HYDRATE_SEG_SYNC_GROUP, VOI_SYNC_GROUP } from './mpr';\r\n\r\nexport const primaryAxial = {\r\n  id: 'primaryAxial',\r\n  locked: true,\r\n  name: 'Axial Primary',\r\n  icon: 'layout-advanced-axial-primary',\r\n  isPreset: true,\r\n  createdDate: '2023-03-15T10:29:44.894Z',\r\n  modifiedDate: '2023-03-15T10:29:44.894Z',\r\n  availableTo: {},\r\n  editableBy: {},\r\n  protocolMatchingRules: [],\r\n  imageLoadStrategy: 'interleaveCenter',\r\n  displaySetSelectors: {\r\n    activeDisplaySet: {\r\n      seriesMatchingRules: [\r\n        {\r\n          weight: 1,\r\n          attribute: 'isReconstructable',\r\n          constraint: {\r\n            equals: {\r\n              value: true,\r\n            },\r\n          },\r\n          required: true,\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  stages: [\r\n    {\r\n      id: 'primaryAxialStage',\r\n      name: 'primaryAxial',\r\n      viewportStructure: {\r\n        layoutType: 'grid',\r\n        properties: {\r\n          rows: 2,\r\n          columns: 3,\r\n          layoutOptions: [\r\n            {\r\n              x: 0,\r\n              y: 0,\r\n              width: 2 / 3,\r\n              height: 1,\r\n            },\r\n            {\r\n              x: 2 / 3,\r\n              y: 0,\r\n              width: 1 / 3,\r\n              height: 1 / 2,\r\n            },\r\n            {\r\n              x: 2 / 3,\r\n              y: 1 / 2,\r\n              width: 1 / 3,\r\n              height: 1 / 2,\r\n            },\r\n          ],\r\n        },\r\n      },\r\n      viewports: [\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'axial',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'sagittal',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n        {\r\n          viewportOptions: {\r\n            toolGroupId: 'mpr',\r\n            viewportType: 'volume',\r\n            orientation: 'coronal',\r\n            initialImageOptions: {\r\n              preset: 'middle',\r\n            },\r\n            syncGroups: [VOI_SYNC_GROUP, HYDRATE_SEG_SYNC_GROUP],\r\n          },\r\n          displaySets: [\r\n            {\r\n              id: 'activeDisplaySet',\r\n            },\r\n          ],\r\n        },\r\n      ],\r\n    },\r\n  ],\r\n};\r\n","import packageJson from '../package.json';\r\n\r\nconst id = packageJson.name;\r\n\r\nexport { id };\r\n","import React from 'react';\r\nimport * as cornerstone from '@cornerstonejs/core';\r\nimport * as cornerstoneTools from '@cornerstonejs/tools';\r\nimport {\r\n  Enums as cs3DEnums,\r\n  imageLoadPoolManager,\r\n  imageRetrievalPoolManager,\r\n} from '@cornerstonejs/core';\r\nimport { Enums as cs3DToolsEnums } from '@cornerstonejs/tools';\r\nimport { Types } from '@ohif/core';\r\nimport Enums from './enums';\r\n\r\nimport init from './init';\r\nimport getCustomizationModule from './getCustomizationModule';\r\nimport getCommandsModule from './commandsModule';\r\nimport getHangingProtocolModule from './getHangingProtocolModule';\r\nimport getToolbarModule from './getToolbarModule';\r\nimport ToolGroupService from './services/ToolGroupService';\r\nimport SyncGroupService from './services/SyncGroupService';\r\nimport SegmentationService from './services/SegmentationService';\r\nimport CornerstoneCacheService from './services/CornerstoneCacheService';\r\nimport CornerstoneViewportService from './services/ViewportService/CornerstoneViewportService';\r\nimport ColorbarService from './services/ColorbarService';\r\nimport * as CornerstoneExtensionTypes from './types';\r\n\r\nimport { toolNames } from './initCornerstoneTools';\r\nimport { getEnabledElement, reset as enabledElementReset, setEnabledElement } from './state';\r\nimport dicomLoaderService from './utils/dicomLoaderService';\r\nimport getActiveViewportEnabledElement from './utils/getActiveViewportEnabledElement';\r\n\r\nimport { id } from './id';\r\nimport { measurementMappingUtils } from './utils/measurementServiceMappings';\r\nimport PlanarFreehandROI from './utils/measurementServiceMappings/PlanarFreehandROI';\r\nimport RectangleROI from './utils/measurementServiceMappings/RectangleROI';\r\nimport type { PublicViewportOptions } from './services/ViewportService/Viewport';\r\nimport ImageOverlayViewerTool from './tools/ImageOverlayViewerTool';\r\nimport getSOPInstanceAttributes from './utils/measurementServiceMappings/utils/getSOPInstanceAttributes';\r\nimport { findNearbyToolData } from './utils/findNearbyToolData';\r\nimport { createFrameViewSynchronizer } from './synchronizers/frameViewSynchronizer';\r\nimport { getSopClassHandlerModule } from './getSopClassHandlerModule';\r\nimport { getDynamicVolumeInfo } from '@cornerstonejs/core/utilities';\r\nimport {\r\n  useLutPresentationStore,\r\n  usePositionPresentationStore,\r\n  useSegmentationPresentationStore,\r\n  useSynchronizersStore,\r\n} from './stores';\r\nimport { useToggleOneUpViewportGridStore } from '@ohif/extension-default';\r\nimport { useActiveViewportSegmentationRepresentations } from './hooks/useActiveViewportSegmentationRepresentations';\r\nimport { useMeasurements } from './hooks/useMeasurements';\r\nimport getPanelModule from './getPanelModule';\r\nimport PanelSegmentation from './panels/PanelSegmentation';\r\nimport PanelMeasurement from './panels/PanelMeasurement';\r\nimport { useSegmentations } from './hooks/useSegmentations';\r\nimport { StudySummaryFromMetadata } from './components/StudySummaryFromMetadata';\r\nimport CornerstoneViewportDownloadForm from './utils/CornerstoneViewportDownloadForm';\r\nimport utils from './utils';\r\nimport { useMeasurementTracking } from './hooks/useMeasurementTracking';\r\nimport { setUpSegmentationEventHandlers } from './utils/setUpSegmentationEventHandlers';\r\nexport * from './components';\r\n\r\nconst { imageRetrieveMetadataProvider } = cornerstone.utilities;\r\n\r\nconst Component = React.lazy(() => {\r\n  return import(/* webpackPrefetch: true */ './Viewport/OHIFCornerstoneViewport');\r\n});\r\n\r\nconst OHIFCornerstoneViewport = props => {\r\n  return (\r\n    <React.Suspense fallback={<div>Loading...</div>}>\r\n      <Component {...props} />\r\n    </React.Suspense>\r\n  );\r\n};\r\n\r\nconst stackRetrieveOptions = {\r\n  retrieveOptions: {\r\n    single: {\r\n      streaming: true,\r\n      decodeLevel: 1,\r\n    },\r\n  },\r\n};\r\n\r\nconst unsubscriptions = [];\r\n/**\r\n *\r\n */\r\nconst cornerstoneExtension: Types.Extensions.Extension = {\r\n  /**\r\n   * Only required property. Should be a unique value across all extensions.\r\n   */\r\n  id,\r\n\r\n  onModeEnter: ({ servicesManager, commandsManager }: withAppTypes): void => {\r\n    const { cornerstoneViewportService, toolbarService, segmentationService } =\r\n      servicesManager.services;\r\n\r\n    const { unsubscriptions: segmentationUnsubscriptions } = setUpSegmentationEventHandlers({\r\n      servicesManager,\r\n      commandsManager,\r\n    });\r\n    unsubscriptions.push(...segmentationUnsubscriptions);\r\n\r\n    toolbarService.registerEventForToolbarUpdate(cornerstoneViewportService, [\r\n      cornerstoneViewportService.EVENTS.VIEWPORT_DATA_CHANGED,\r\n    ]);\r\n\r\n    toolbarService.registerEventForToolbarUpdate(segmentationService, [\r\n      segmentationService.EVENTS.SEGMENTATION_REMOVED,\r\n      segmentationService.EVENTS.SEGMENTATION_MODIFIED,\r\n    ]);\r\n\r\n    toolbarService.registerEventForToolbarUpdate(cornerstone.eventTarget, [\r\n      cornerstoneTools.Enums.Events.TOOL_ACTIVATED,\r\n    ]);\r\n\r\n    // Configure the interleaved/HTJ2K loader\r\n    imageRetrieveMetadataProvider.clear();\r\n    // The default volume interleaved options are to interleave the\r\n    // image retrieve, but don't perform progressive loading per image\r\n    // This interleaves images and replicates them for low-resolution depth volume\r\n    // reconstruction, which progressively improves\r\n    imageRetrieveMetadataProvider.add(\r\n      'volume',\r\n      cornerstone.ProgressiveRetrieveImages.interleavedRetrieveStages\r\n    );\r\n    // The default stack loading option is to progressive load HTJ2K images\r\n    // There are other possible options, but these need more thought about\r\n    // how to define them.\r\n    imageRetrieveMetadataProvider.add('stack', stackRetrieveOptions);\r\n  },\r\n  getPanelModule,\r\n  onModeExit: ({ servicesManager }: withAppTypes): void => {\r\n    unsubscriptions.forEach(unsubscribe => unsubscribe());\r\n    // Clear the unsubscriptions\r\n    unsubscriptions.length = 0;\r\n\r\n    const { cineService, segmentationService } = servicesManager.services;\r\n    // Empty out the image load and retrieval pools to prevent memory leaks\r\n    // on the mode exits\r\n    Object.values(cs3DEnums.RequestType).forEach(type => {\r\n      imageLoadPoolManager.clearRequestStack(type);\r\n      imageRetrievalPoolManager.clearRequestStack(type);\r\n    });\r\n\r\n    cineService.setIsCineEnabled(false);\r\n\r\n    enabledElementReset();\r\n\r\n    useLutPresentationStore.getState().clearLutPresentationStore();\r\n    usePositionPresentationStore.getState().clearPositionPresentationStore();\r\n    useSynchronizersStore.getState().clearSynchronizersStore();\r\n    useToggleOneUpViewportGridStore.getState().clearToggleOneUpViewportGridStore();\r\n    useSegmentationPresentationStore.getState().clearSegmentationPresentationStore();\r\n    segmentationService.removeAllSegmentations();\r\n  },\r\n\r\n  /**\r\n   * Register the Cornerstone 3D services and set them up for use.\r\n   *\r\n   * @param configuration.csToolsConfig - Passed directly to `initCornerstoneTools`\r\n   */\r\n  preRegistration: async function (props: Types.Extensions.ExtensionParams): Promise<void> {\r\n    const { servicesManager } = props;\r\n    servicesManager.registerService(CornerstoneViewportService.REGISTRATION);\r\n    servicesManager.registerService(ToolGroupService.REGISTRATION);\r\n    servicesManager.registerService(SyncGroupService.REGISTRATION);\r\n    servicesManager.registerService(SegmentationService.REGISTRATION);\r\n    servicesManager.registerService(CornerstoneCacheService.REGISTRATION);\r\n    servicesManager.registerService(ColorbarService.REGISTRATION);\r\n\r\n    const { syncGroupService } = servicesManager.services;\r\n    syncGroupService.registerCustomSynchronizer('frameview', createFrameViewSynchronizer);\r\n\r\n    await init.call(this, props);\r\n  },\r\n  getToolbarModule,\r\n  getHangingProtocolModule,\r\n  getViewportModule({ servicesManager, commandsManager }) {\r\n    const ExtendedOHIFCornerstoneViewport = props => {\r\n      const { toolbarService } = servicesManager.services;\r\n\r\n      return (\r\n        <OHIFCornerstoneViewport\r\n          {...props}\r\n          toolbarService={toolbarService}\r\n          servicesManager={servicesManager}\r\n          commandsManager={commandsManager}\r\n        />\r\n      );\r\n    };\r\n\r\n    return [\r\n      {\r\n        name: 'cornerstone',\r\n        component: ExtendedOHIFCornerstoneViewport,\r\n        isReferenceViewable: props => utils.isReferenceViewable({ ...props, servicesManager }),\r\n      },\r\n    ];\r\n  },\r\n  getCommandsModule,\r\n  getCustomizationModule,\r\n  getUtilityModule({ servicesManager }) {\r\n    return [\r\n      {\r\n        name: 'common',\r\n        exports: {\r\n          getCornerstoneLibraries: () => {\r\n            return { cornerstone, cornerstoneTools };\r\n          },\r\n          getEnabledElement,\r\n          dicomLoaderService,\r\n        },\r\n      },\r\n      {\r\n        name: 'core',\r\n        exports: {\r\n          Enums: cs3DEnums,\r\n        },\r\n      },\r\n      {\r\n        name: 'tools',\r\n        exports: {\r\n          toolNames,\r\n          Enums: cs3DToolsEnums,\r\n        },\r\n      },\r\n      {\r\n        name: 'volumeLoader',\r\n        exports: {\r\n          getDynamicVolumeInfo,\r\n        },\r\n      },\r\n    ];\r\n  },\r\n  getSopClassHandlerModule,\r\n};\r\n\r\nexport type { PublicViewportOptions };\r\nexport {\r\n  measurementMappingUtils,\r\n  PlanarFreehandROI,\r\n  RectangleROI,\r\n  CornerstoneExtensionTypes as Types,\r\n  toolNames,\r\n  getActiveViewportEnabledElement,\r\n  setEnabledElement,\r\n  findNearbyToolData,\r\n  getEnabledElement,\r\n  ImageOverlayViewerTool,\r\n  getSOPInstanceAttributes,\r\n  dicomLoaderService,\r\n  // Export all stores\r\n  useLutPresentationStore,\r\n  usePositionPresentationStore,\r\n  useSegmentationPresentationStore,\r\n  useSynchronizersStore,\r\n  Enums,\r\n  useMeasurements,\r\n  useActiveViewportSegmentationRepresentations,\r\n  useSegmentations,\r\n  PanelSegmentation,\r\n  PanelMeasurement,\r\n  StudySummaryFromMetadata,\r\n  CornerstoneViewportDownloadForm,\r\n  utils,\r\n  OHIFCornerstoneViewport,\r\n  useMeasurementTracking,\r\n};\r\n\r\n// Export constants\r\nexport { VOLUME_LOADER_SCHEME, DYNAMIC_VOLUME_LOADER_SCHEME } from './constants';\r\nexport default cornerstoneExtension;\r\n","import OHIF, { errorHandler } from '@ohif/core';\r\nimport React from 'react';\r\n\r\nimport * as cornerstone from '@cornerstonejs/core';\r\nimport * as cornerstoneTools from '@cornerstonejs/tools';\r\nimport {\r\n  init as cs3DInit,\r\n  eventTarget,\r\n  EVENTS,\r\n  metaData,\r\n  volumeLoader,\r\n  imageLoadPoolManager,\r\n  getEnabledElement,\r\n  Settings,\r\n  utilities as csUtilities,\r\n} from '@cornerstonejs/core';\r\nimport {\r\n  cornerstoneStreamingImageVolumeLoader,\r\n  cornerstoneStreamingDynamicImageVolumeLoader,\r\n} from '@cornerstonejs/core/loaders';\r\n\r\nimport RequestTypes from '@cornerstonejs/core/enums/RequestType';\r\n\r\nimport initWADOImageLoader from './initWADOImageLoader';\r\nimport initCornerstoneTools from './initCornerstoneTools';\r\n\r\nimport { connectToolsToMeasurementService } from './initMeasurementService';\r\nimport initCineService from './initCineService';\r\nimport initStudyPrefetcherService from './initStudyPrefetcherService';\r\nimport interleaveCenterLoader from './utils/interleaveCenterLoader';\r\nimport nthLoader from './utils/nthLoader';\r\nimport interleaveTopToBottom from './utils/interleaveTopToBottom';\r\nimport initContextMenu from './initContextMenu';\r\nimport initDoubleClick from './initDoubleClick';\r\nimport initViewTiming from './utils/initViewTiming';\r\nimport { colormaps } from './utils/colormaps';\r\nimport { SegmentationRepresentations } from '@cornerstonejs/tools/enums';\r\nimport { useLutPresentationStore } from './stores/useLutPresentationStore';\r\nimport { usePositionPresentationStore } from './stores/usePositionPresentationStore';\r\nimport { useSegmentationPresentationStore } from './stores/useSegmentationPresentationStore';\r\nimport { imageRetrieveMetadataProvider } from '@cornerstonejs/core/utilities';\r\n\r\nconst { registerColormap } = csUtilities.colormap;\r\n\r\n// TODO: Cypress tests are currently grabbing this from the window?\r\n(window as any).cornerstone = cornerstone;\r\n(window as any).cornerstoneTools = cornerstoneTools;\r\n/**\r\n *\r\n */\r\nexport default async function init({\r\n  servicesManager,\r\n  commandsManager,\r\n  extensionManager,\r\n  appConfig,\r\n}: withAppTypes): Promise<void> {\r\n  // Note: this should run first before initializing the cornerstone\r\n  // DO NOT CHANGE THE ORDER\r\n\r\n  await cs3DInit({\r\n    peerImport: appConfig.peerImport,\r\n  });\r\n\r\n  // For debugging e2e tests that are failing on CI\r\n  cornerstone.setUseCPURendering(Boolean(appConfig.useCPURendering));\r\n\r\n  cornerstone.setConfiguration({\r\n    ...cornerstone.getConfiguration(),\r\n    rendering: {\r\n      ...cornerstone.getConfiguration().rendering,\r\n      strictZSpacingForVolumeViewport: appConfig.strictZSpacingForVolumeViewport,\r\n    },\r\n  });\r\n\r\n  // For debugging large datasets, otherwise prefer the defaults\r\n  const { maxCacheSize } = appConfig;\r\n  if (maxCacheSize) {\r\n    cornerstone.cache.setMaxCacheSize(maxCacheSize);\r\n  }\r\n\r\n  initCornerstoneTools();\r\n\r\n  Settings.getRuntimeSettings().set('useCursors', Boolean(appConfig.useCursors));\r\n\r\n  const {\r\n    userAuthenticationService,\r\n    customizationService,\r\n    uiModalService,\r\n    uiNotificationService,\r\n    cornerstoneViewportService,\r\n    hangingProtocolService,\r\n    viewportGridService,\r\n    segmentationService,\r\n    measurementService,\r\n    colorbarService,\r\n    displaySetService,\r\n    toolbarService,\r\n  } = servicesManager.services;\r\n\r\n  toolbarService.registerEventForToolbarUpdate(colorbarService, [\r\n    colorbarService.EVENTS.STATE_CHANGED,\r\n  ]);\r\n\r\n  window.services = servicesManager.services;\r\n  window.extensionManager = extensionManager;\r\n  window.commandsManager = commandsManager;\r\n\r\n  if (appConfig.showCPUFallbackMessage && cornerstone.getShouldUseCPURendering()) {\r\n    _showCPURenderingModal(uiModalService, hangingProtocolService);\r\n  }\r\n  const { getPresentationId: getLutPresentationId } = useLutPresentationStore.getState();\r\n\r\n  const { getPresentationId: getSegmentationPresentationId } =\r\n    useSegmentationPresentationStore.getState();\r\n\r\n  const { getPresentationId: getPositionPresentationId } = usePositionPresentationStore.getState();\r\n\r\n  // register presentation id providers\r\n  viewportGridService.addPresentationIdProvider(\r\n    'positionPresentationId',\r\n    getPositionPresentationId\r\n  );\r\n  viewportGridService.addPresentationIdProvider('lutPresentationId', getLutPresentationId);\r\n  viewportGridService.addPresentationIdProvider(\r\n    'segmentationPresentationId',\r\n    getSegmentationPresentationId\r\n  );\r\n\r\n  cornerstoneTools.segmentation.config.style.setStyle(\r\n    { type: SegmentationRepresentations.Contour },\r\n    {\r\n      renderFill: false,\r\n    }\r\n  );\r\n\r\n  const metadataProvider = OHIF.classes.MetadataProvider;\r\n\r\n  volumeLoader.registerVolumeLoader(\r\n    'cornerstoneStreamingImageVolume',\r\n    cornerstoneStreamingImageVolumeLoader\r\n  );\r\n\r\n  volumeLoader.registerVolumeLoader(\r\n    'cornerstoneStreamingDynamicImageVolume',\r\n    cornerstoneStreamingDynamicImageVolumeLoader\r\n  );\r\n\r\n  // Register strategies using the wrapper\r\n  const imageLoadStrategies = {\r\n    interleaveCenter: interleaveCenterLoader,\r\n    interleaveTopToBottom: interleaveTopToBottom,\r\n    nth: nthLoader,\r\n  };\r\n\r\n  Object.entries(imageLoadStrategies).forEach(([name, strategyFn]) => {\r\n    hangingProtocolService.registerImageLoadStrategy(\r\n      name,\r\n      createMetadataWrappedStrategy(strategyFn)\r\n    );\r\n  });\r\n\r\n  // add metadata providers\r\n  metaData.addProvider(\r\n    csUtilities.calibratedPixelSpacingMetadataProvider.get.bind(\r\n      csUtilities.calibratedPixelSpacingMetadataProvider\r\n    )\r\n  ); // this provider is required for Calibration tool\r\n  metaData.addProvider(metadataProvider.get.bind(metadataProvider), 9999);\r\n\r\n  // These are set reasonably low to allow for interleaved retrieves and slower\r\n  // connections.\r\n  imageLoadPoolManager.maxNumRequests = {\r\n    [RequestTypes.Interaction]: appConfig?.maxNumRequests?.interaction || 10,\r\n    [RequestTypes.Thumbnail]: appConfig?.maxNumRequests?.thumbnail || 5,\r\n    [RequestTypes.Prefetch]: appConfig?.maxNumRequests?.prefetch || 5,\r\n    [RequestTypes.Compute]: appConfig?.maxNumRequests?.compute || 10,\r\n  };\r\n\r\n  initWADOImageLoader(userAuthenticationService, appConfig, extensionManager);\r\n\r\n  /* Measurement Service */\r\n  this.measurementServiceSource = connectToolsToMeasurementService({\r\n    servicesManager,\r\n    commandsManager,\r\n    extensionManager,\r\n  });\r\n\r\n  initCineService(servicesManager);\r\n  initStudyPrefetcherService(servicesManager);\r\n\r\n  [\r\n    measurementService.EVENTS.JUMP_TO_MEASUREMENT_LAYOUT,\r\n    measurementService.EVENTS.JUMP_TO_MEASUREMENT_VIEWPORT,\r\n  ].forEach(event => {\r\n    measurementService.subscribe(event, evt => {\r\n      const { measurement } = evt;\r\n      const { uid: annotationUID } = measurement;\r\n      cornerstoneTools.annotation.selection.setAnnotationSelected(annotationUID, true);\r\n    });\r\n  });\r\n\r\n  // When a custom image load is performed, update the relevant viewports\r\n  hangingProtocolService.subscribe(\r\n    hangingProtocolService.EVENTS.CUSTOM_IMAGE_LOAD_PERFORMED,\r\n    volumeInputArrayMap => {\r\n      const { lutPresentationStore } = useLutPresentationStore.getState();\r\n      const { segmentationPresentationStore } = useSegmentationPresentationStore.getState();\r\n      const { positionPresentationStore } = usePositionPresentationStore.getState();\r\n\r\n      for (const entry of volumeInputArrayMap.entries()) {\r\n        const [viewportId, volumeInputArray] = entry;\r\n        const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n        const ohifViewport = cornerstoneViewportService.getViewportInfo(viewportId);\r\n\r\n        const { presentationIds } = ohifViewport.getViewportOptions();\r\n\r\n        const presentations = {\r\n          positionPresentation: positionPresentationStore[presentationIds?.positionPresentationId],\r\n          lutPresentation: lutPresentationStore[presentationIds?.lutPresentationId],\r\n          segmentationPresentation:\r\n            segmentationPresentationStore[presentationIds?.segmentationPresentationId],\r\n        };\r\n\r\n        cornerstoneViewportService.setVolumesForViewport(viewport, volumeInputArray, presentations);\r\n      }\r\n    }\r\n  );\r\n\r\n  initContextMenu({\r\n    cornerstoneViewportService,\r\n    customizationService,\r\n    commandsManager,\r\n  });\r\n\r\n  initDoubleClick({\r\n    customizationService,\r\n    commandsManager,\r\n  });\r\n\r\n  /**\r\n   * Runs error handler for failed requests.\r\n   * @param event\r\n   */\r\n  const imageLoadFailedHandler = ({ detail }) => {\r\n    const handler = errorHandler.getHTTPErrorHandler();\r\n    handler(detail.error);\r\n  };\r\n\r\n  eventTarget.addEventListener(EVENTS.IMAGE_LOAD_FAILED, imageLoadFailedHandler);\r\n  eventTarget.addEventListener(EVENTS.IMAGE_LOAD_ERROR, imageLoadFailedHandler);\r\n\r\n  const getDisplaySetFromVolumeId = (volumeId: string) => {\r\n    const allDisplaySets = displaySetService.getActiveDisplaySets();\r\n    const volume = cornerstone.cache.getVolume(volumeId);\r\n    const imageIds = volume.imageIds;\r\n    return allDisplaySets.find(ds => ds.imageIds?.some(id => imageIds.includes(id)));\r\n  };\r\n\r\n  function elementEnabledHandler(evt) {\r\n    const { element } = evt.detail;\r\n    const { viewport } = getEnabledElement(element);\r\n    initViewTiming({ element });\r\n\r\n    element.addEventListener(EVENTS.CAMERA_RESET, evt => {\r\n      const { element } = evt.detail;\r\n      const enabledElement = getEnabledElement(element);\r\n      if (!enabledElement) {\r\n        return;\r\n      }\r\n      const { viewportId } = enabledElement;\r\n      commandsManager.runCommand('resetCrosshairs', { viewportId });\r\n    });\r\n\r\n    // limitation: currently supporting only volume viewports with fusion\r\n    if (viewport.type !== cornerstone.Enums.ViewportType.ORTHOGRAPHIC) {\r\n      return;\r\n    }\r\n  }\r\n\r\n  eventTarget.addEventListener(EVENTS.ELEMENT_ENABLED, elementEnabledHandler.bind(null));\r\n\r\n  colormaps.forEach(registerColormap);\r\n\r\n  // Event listener\r\n  eventTarget.addEventListenerDebounced(\r\n    EVENTS.ERROR_EVENT,\r\n    ({ detail }) => {\r\n      // Create a stable ID for deduplication based on error type and message\r\n      const errorId = `cornerstone-error-${detail.type}-${detail.message.substring(0, 50)}`;\r\n\r\n      uiNotificationService.show({\r\n        title: detail.type,\r\n        message: detail.message,\r\n        type: 'error',\r\n        id: errorId,\r\n        allowDuplicates: false, // Prevent duplicate error notifications\r\n        deduplicationInterval: 30000, // 30 seconds deduplication window\r\n      });\r\n    },\r\n    100\r\n  );\r\n\r\n  // Subscribe to actor events to dynamically update colorbars\r\n\r\n  // Call this function when initializing\r\n  initializeWebWorkerProgressHandler(servicesManager.services.uiNotificationService);\r\n}\r\n\r\nfunction initializeWebWorkerProgressHandler(uiNotificationService) {\r\n  // Use a single map to track all active worker tasks\r\n  const activeWorkerTasks = new Map();\r\n\r\n  // Create a normalized task key that doesn't include the random ID\r\n  // This helps us identify and deduplicate the same type of task\r\n  const getNormalizedTaskKey = type => {\r\n    return `worker-task-${type.toLowerCase().replace(/\\s+/g, '-')}`;\r\n  };\r\n\r\n  eventTarget.addEventListener(EVENTS.WEB_WORKER_PROGRESS, ({ detail }) => {\r\n    const { progress, type, id } = detail;\r\n\r\n    // Skip notifications for compute statistics\r\n    if (type === cornerstoneTools.Enums.WorkerTypes.COMPUTE_STATISTICS) {\r\n      return;\r\n    }\r\n\r\n    const normalizedKey = getNormalizedTaskKey(type);\r\n\r\n    if (progress === 0) {\r\n      // Check if we're already tracking a task of this type\r\n      if (!activeWorkerTasks.has(normalizedKey)) {\r\n        const progressPromise = new Promise((resolve, reject) => {\r\n          activeWorkerTasks.set(normalizedKey, {\r\n            resolve,\r\n            reject,\r\n            originalId: id,\r\n            type,\r\n          });\r\n        });\r\n\r\n        uiNotificationService.show({\r\n          id: normalizedKey, // Use the normalized key as ID for better deduplication\r\n          title: `${type}`,\r\n          message: `Computing...`,\r\n          autoClose: false,\r\n          allowDuplicates: false,\r\n          deduplicationInterval: 60000, // 60 seconds - prevent frequent notifications of same type\r\n          promise: progressPromise,\r\n          promiseMessages: {\r\n            loading: `Computing...`,\r\n            success: `Completed successfully`,\r\n            error: 'Web Worker failed',\r\n          },\r\n        });\r\n      } else {\r\n        // Already tracking this type of task, just let it continue\r\n        console.debug(`Already tracking a \"${type}\" task, skipping duplicate notification`);\r\n      }\r\n    }\r\n    // Task completed\r\n    else if (progress === 100) {\r\n      // Check if we have this task type in our tracking map\r\n      const taskData = activeWorkerTasks.get(normalizedKey);\r\n\r\n      if (taskData) {\r\n        // Resolve the promise to update the notification\r\n        const { resolve } = taskData;\r\n        resolve({ progress, type });\r\n\r\n        // Remove from tracking\r\n        activeWorkerTasks.delete(normalizedKey);\r\n\r\n        console.debug(`Worker task \"${type}\" completed successfully`);\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Creates a wrapped image load strategy with metadata handling\r\n * @param strategyFn - The image loading strategy function to wrap\r\n * @returns A wrapped strategy function that handles metadata configuration\r\n */\r\nconst createMetadataWrappedStrategy = (strategyFn: (args: any) => any) => {\r\n  return (args: any) => {\r\n    const clonedConfig = imageRetrieveMetadataProvider.clone();\r\n    imageRetrieveMetadataProvider.clear();\r\n\r\n    try {\r\n      const result = strategyFn(args);\r\n      return result;\r\n    } finally {\r\n      // Ensure metadata is always restored, even if there's an error\r\n      setTimeout(() => {\r\n        imageRetrieveMetadataProvider.restore(clonedConfig);\r\n      }, 10);\r\n    }\r\n  };\r\n};\r\n\r\nfunction CPUModal() {\r\n  return (\r\n    <div>\r\n      <p>\r\n        Your computer does not have enough GPU power to support the default GPU rendering mode. OHIF\r\n        has switched to CPU rendering mode. Please note that CPU rendering does not support all\r\n        features such as Volume Rendering, Multiplanar Reconstruction, and Segmentation Overlays.\r\n      </p>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction _showCPURenderingModal(uiModalService, hangingProtocolService) {\r\n  const callback = progress => {\r\n    if (progress === 100) {\r\n      uiModalService.show({\r\n        content: CPUModal,\r\n        title: 'OHIF Fell Back to CPU Rendering',\r\n      });\r\n\r\n      return true;\r\n    }\r\n  };\r\n\r\n  const { unsubscribe } = hangingProtocolService.subscribe(\r\n    hangingProtocolService.EVENTS.PROTOCOL_CHANGED,\r\n    () => {\r\n      const done = callback(100);\r\n\r\n      if (done) {\r\n        unsubscribe();\r\n      }\r\n    }\r\n  );\r\n}\r\n","import { cache, Types } from '@cornerstonejs/core';\r\nimport { utilities } from '@cornerstonejs/tools';\r\n\r\nfunction _getVolumeFromViewport(viewport: Types.IBaseVolumeViewport) {\r\n  const volumeIds = viewport.getAllVolumeIds();\r\n  const volumes = volumeIds.map(id => cache.getVolume(id));\r\n  const dynamicVolume = volumes.find(volume => volume.isDynamicVolume());\r\n\r\n  return dynamicVolume ?? volumes[0];\r\n}\r\n\r\n/**\r\n * Return all viewports that needs to be synchronized with the source\r\n * viewport passed as parameter when cine is updated.\r\n * @param servicesManager ServiceManager\r\n * @param srcViewportIndex Source viewport index\r\n * @returns array with viewport information.\r\n */\r\nfunction _getSyncedViewports(servicesManager: AppTypes.ServicesManager, srcViewportId) {\r\n  const { viewportGridService, cornerstoneViewportService } = servicesManager.services;\r\n\r\n  const { viewports: viewportsStates } = viewportGridService.getState();\r\n  const srcViewportState = viewportsStates.get(srcViewportId);\r\n\r\n  if (srcViewportState?.viewportOptions?.viewportType !== 'volume') {\r\n    return [];\r\n  }\r\n\r\n  const srcViewport = cornerstoneViewportService.getCornerstoneViewport(srcViewportId);\r\n\r\n  const srcVolume = srcViewport ? _getVolumeFromViewport(srcViewport) : null;\r\n\r\n  if (!srcVolume?.isDynamicVolume()) {\r\n    return [];\r\n  }\r\n\r\n  const { volumeId: srcVolumeId } = srcVolume;\r\n\r\n  return Array.from(viewportsStates.values())\r\n    .filter(({ viewportId }) => {\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n      return viewportId !== srcViewportId && viewport?.hasVolumeId?.(srcVolumeId);\r\n    })\r\n    .map(({ viewportId }) => ({ viewportId }));\r\n}\r\n\r\nfunction initCineService(servicesManager: AppTypes.ServicesManager) {\r\n  const { cineService } = servicesManager.services;\r\n\r\n  const getSyncedViewports = viewportId => {\r\n    return _getSyncedViewports(servicesManager, viewportId);\r\n  };\r\n\r\n  const playClip = (element, playClipOptions) => {\r\n    return utilities.cine.playClip(element, playClipOptions);\r\n  };\r\n\r\n  const stopClip = (element, stopClipOptions) => {\r\n    return utilities.cine.stopClip(element, stopClipOptions);\r\n  };\r\n\r\n  cineService.setServiceImplementation({\r\n    getSyncedViewports,\r\n    playClip,\r\n    stopClip,\r\n  });\r\n}\r\n\r\nexport default initCineService;\r\n","import { eventTarget, EVENTS } from '@cornerstonejs/core';\r\nimport { Enums } from '@cornerstonejs/tools';\r\nimport { setEnabledElement } from './state';\r\nimport { findNearbyToolData } from './utils/findNearbyToolData';\r\n\r\nconst cs3DToolsEvents = Enums.Events;\r\n\r\n/**\r\n * Generates a name, consisting of:\r\n *    * alt when the alt key is down\r\n *    * ctrl when the cctrl key is down\r\n *    * shift when the shift key is down\r\n *    * 'button' followed by the button number (1 left, 3 right etc)\r\n */\r\nfunction getEventName(evt) {\r\n  const button = evt.detail.event.which;\r\n  const nameArr = [];\r\n  if (evt.detail.event.altKey) {\r\n    nameArr.push('alt');\r\n  }\r\n  if (evt.detail.event.ctrlKey) {\r\n    nameArr.push('ctrl');\r\n  }\r\n  if (evt.detail.event.shiftKey) {\r\n    nameArr.push('shift');\r\n  }\r\n  nameArr.push('button');\r\n  nameArr.push(button);\r\n  return nameArr.join('');\r\n}\r\n\r\nfunction initContextMenu({\r\n  cornerstoneViewportService,\r\n  customizationService,\r\n  commandsManager,\r\n}): void {\r\n  /*\r\n   * Run the commands associated with the given button press,\r\n   * defaults on button1 and button2\r\n   */\r\n  const cornerstoneViewportHandleEvent = (name, evt) => {\r\n    const customizations = customizationService.getCustomization(\r\n      'cornerstoneViewportClickCommands'\r\n    );\r\n\r\n    const toRun = customizations[name];\r\n\r\n    if (!toRun) {\r\n      return;\r\n    }\r\n\r\n    // only find nearbyToolData if required, for the click (which closes the context menu\r\n    // we don't need to find nearbyToolData)\r\n    let nearbyToolData = null;\r\n    if (toRun.some(command => command.commandOptions?.requireNearbyToolData)) {\r\n      nearbyToolData = findNearbyToolData(commandsManager, evt);\r\n    }\r\n\r\n    const options = {\r\n      nearbyToolData,\r\n      event: evt,\r\n    };\r\n    commandsManager.run(toRun, options);\r\n  };\r\n\r\n  const cornerstoneViewportHandleClick = evt => {\r\n    const name = getEventName(evt);\r\n    cornerstoneViewportHandleEvent(name, evt);\r\n  };\r\n\r\n  function elementEnabledHandler(evt) {\r\n    const { viewportId, element } = evt.detail;\r\n    const viewportInfo = cornerstoneViewportService.getViewportInfo(viewportId);\r\n    if (!viewportInfo) {\r\n      return;\r\n    }\r\n    // TODO check update upstream\r\n    setEnabledElement(viewportId, element);\r\n\r\n    element.addEventListener(cs3DToolsEvents.MOUSE_CLICK, cornerstoneViewportHandleClick);\r\n  }\r\n\r\n  function elementDisabledHandler(evt) {\r\n    const { element } = evt.detail;\r\n\r\n    element.removeEventListener(cs3DToolsEvents.MOUSE_CLICK, cornerstoneViewportHandleClick);\r\n  }\r\n\r\n  eventTarget.addEventListener(EVENTS.ELEMENT_ENABLED, elementEnabledHandler.bind(null));\r\n\r\n  eventTarget.addEventListener(EVENTS.ELEMENT_DISABLED, elementDisabledHandler.bind(null));\r\n}\r\n\r\nexport default initContextMenu;\r\n","import {\r\n  PanTool,\r\n  WindowLevelTool,\r\n  SegmentBidirectionalTool,\r\n  StackScrollTool,\r\n  VolumeRotateTool,\r\n  ZoomTool,\r\n  MIPJumpToClickTool,\r\n  LengthTool,\r\n  RectangleROITool,\r\n  RectangleROIThresholdTool,\r\n  EllipticalROITool,\r\n  CircleROITool,\r\n  BidirectionalTool,\r\n  ArrowAnnotateTool,\r\n  DragProbeTool,\r\n  ProbeTool,\r\n  AngleTool,\r\n  CobbAngleTool,\r\n  MagnifyTool,\r\n  CrosshairsTool,\r\n  RectangleScissorsTool,\r\n  SphereScissorsTool,\r\n  CircleScissorsTool,\r\n  BrushTool,\r\n  PaintFillTool,\r\n  init,\r\n  addTool,\r\n  annotation,\r\n  ReferenceLinesTool,\r\n  TrackballRotateTool,\r\n  AdvancedMagnifyTool,\r\n  UltrasoundDirectionalTool,\r\n  PlanarFreehandROITool,\r\n  PlanarFreehandContourSegmentationTool,\r\n  SplineROITool,\r\n  LivewireContourTool,\r\n  OrientationMarkerTool,\r\n  WindowLevelRegionTool,\r\n  SegmentSelectTool,\r\n  RegionSegmentPlusTool,\r\n} from '@cornerstonejs/tools';\r\nimport { LabelmapSlicePropagationTool, MarkerLabelmapTool } from '@cornerstonejs/ai';\r\nimport * as polySeg from '@cornerstonejs/polymorphic-segmentation';\r\n\r\nimport CalibrationLineTool from './tools/CalibrationLineTool';\r\nimport ImageOverlayViewerTool from './tools/ImageOverlayViewerTool';\r\n\r\nexport default function initCornerstoneTools(configuration = {}) {\r\n  CrosshairsTool.isAnnotation = false;\r\n  LabelmapSlicePropagationTool.isAnnotation = false;\r\n  MarkerLabelmapTool.isAnnotation = false;\r\n  ReferenceLinesTool.isAnnotation = false;\r\n  AdvancedMagnifyTool.isAnnotation = false;\r\n  PlanarFreehandContourSegmentationTool.isAnnotation = false;\r\n\r\n  init({\r\n    addons: {\r\n      polySeg,\r\n    },\r\n    computeWorker: {\r\n      autoTerminateOnIdle: {\r\n        enabled: false,\r\n      },\r\n    },\r\n  });\r\n  addTool(PanTool);\r\n  addTool(SegmentBidirectionalTool);\r\n  addTool(WindowLevelTool);\r\n  addTool(StackScrollTool);\r\n  addTool(VolumeRotateTool);\r\n  addTool(ZoomTool);\r\n  addTool(ProbeTool);\r\n  addTool(MIPJumpToClickTool);\r\n  addTool(LengthTool);\r\n  addTool(RectangleROITool);\r\n  addTool(RectangleROIThresholdTool);\r\n  addTool(EllipticalROITool);\r\n  addTool(CircleROITool);\r\n  addTool(BidirectionalTool);\r\n  addTool(ArrowAnnotateTool);\r\n  addTool(DragProbeTool);\r\n  addTool(AngleTool);\r\n  addTool(CobbAngleTool);\r\n  addTool(MagnifyTool);\r\n  addTool(CrosshairsTool);\r\n  addTool(RectangleScissorsTool);\r\n  addTool(SphereScissorsTool);\r\n  addTool(CircleScissorsTool);\r\n  addTool(BrushTool);\r\n  addTool(PaintFillTool);\r\n  addTool(ReferenceLinesTool);\r\n  addTool(CalibrationLineTool);\r\n  addTool(TrackballRotateTool);\r\n  addTool(ImageOverlayViewerTool);\r\n  addTool(AdvancedMagnifyTool);\r\n  addTool(UltrasoundDirectionalTool);\r\n  addTool(PlanarFreehandROITool);\r\n  addTool(SplineROITool);\r\n  addTool(LivewireContourTool);\r\n  addTool(OrientationMarkerTool);\r\n  addTool(WindowLevelRegionTool);\r\n  addTool(PlanarFreehandContourSegmentationTool);\r\n  addTool(SegmentSelectTool);\r\n  addTool(LabelmapSlicePropagationTool);\r\n  addTool(MarkerLabelmapTool);\r\n  addTool(RegionSegmentPlusTool);\r\n  // Modify annotation tools to use dashed lines on SR\r\n  const annotationStyle = {\r\n    textBoxFontSize: '15px',\r\n    lineWidth: '1.5',\r\n  };\r\n\r\n  const defaultStyles = annotation.config.style.getDefaultToolStyles();\r\n  annotation.config.style.setDefaultToolStyles({\r\n    global: {\r\n      ...defaultStyles.global,\r\n      ...annotationStyle,\r\n    },\r\n  });\r\n}\r\n\r\nconst toolNames = {\r\n  Pan: PanTool.toolName,\r\n  ArrowAnnotate: ArrowAnnotateTool.toolName,\r\n  WindowLevel: WindowLevelTool.toolName,\r\n  StackScroll: StackScrollTool.toolName,\r\n  Zoom: ZoomTool.toolName,\r\n  VolumeRotate: VolumeRotateTool.toolName,\r\n  MipJumpToClick: MIPJumpToClickTool.toolName,\r\n  Length: LengthTool.toolName,\r\n  DragProbe: DragProbeTool.toolName,\r\n  Probe: ProbeTool.toolName,\r\n  RectangleROI: RectangleROITool.toolName,\r\n  RectangleROIThreshold: RectangleROIThresholdTool.toolName,\r\n  EllipticalROI: EllipticalROITool.toolName,\r\n  CircleROI: CircleROITool.toolName,\r\n  Bidirectional: BidirectionalTool.toolName,\r\n  Angle: AngleTool.toolName,\r\n  CobbAngle: CobbAngleTool.toolName,\r\n  Magnify: MagnifyTool.toolName,\r\n  Crosshairs: CrosshairsTool.toolName,\r\n  Brush: BrushTool.toolName,\r\n  PaintFill: PaintFillTool.toolName,\r\n  ReferenceLines: ReferenceLinesTool.toolName,\r\n  CalibrationLine: CalibrationLineTool.toolName,\r\n  TrackballRotateTool: TrackballRotateTool.toolName,\r\n  CircleScissors: CircleScissorsTool.toolName,\r\n  RectangleScissors: RectangleScissorsTool.toolName,\r\n  SphereScissors: SphereScissorsTool.toolName,\r\n  ImageOverlayViewer: ImageOverlayViewerTool.toolName,\r\n  AdvancedMagnify: AdvancedMagnifyTool.toolName,\r\n  UltrasoundDirectional: UltrasoundDirectionalTool.toolName,\r\n  SplineROI: SplineROITool.toolName,\r\n  LivewireContour: LivewireContourTool.toolName,\r\n  PlanarFreehandROI: PlanarFreehandROITool.toolName,\r\n  OrientationMarker: OrientationMarkerTool.toolName,\r\n  WindowLevelRegion: WindowLevelRegionTool.toolName,\r\n  PlanarFreehandContourSegmentation: PlanarFreehandContourSegmentationTool.toolName,\r\n  SegmentBidirectional: SegmentBidirectionalTool.toolName,\r\n  SegmentSelect: SegmentSelectTool.toolName,\r\n  LabelmapSlicePropagation: LabelmapSlicePropagationTool.toolName,\r\n  MarkerLabelmap: MarkerLabelmapTool.toolName,\r\n  RegionSegmentPlus: RegionSegmentPlusTool.toolName,\r\n};\r\n\r\nexport { toolNames };\r\n","import { eventTarget, EVENTS } from '@cornerstonejs/core';\r\nimport { Enums } from '@cornerstonejs/tools';\r\nimport { CommandsManager, CustomizationService } from '@ohif/core';\r\nimport { findNearbyToolData } from './utils/findNearbyToolData';\r\n\r\nconst cs3DToolsEvents = Enums.Events;\r\n\r\n/**\r\n * Generates a double click event name, consisting of:\r\n *    * alt when the alt key is down\r\n *    * ctrl when the cctrl key is down\r\n *    * shift when the shift key is down\r\n *    * 'doubleClick'\r\n */\r\nfunction getDoubleClickEventName(evt: CustomEvent) {\r\n  const nameArr = [];\r\n  if (evt.detail.event.altKey) {\r\n    nameArr.push('alt');\r\n  }\r\n  if (evt.detail.event.ctrlKey) {\r\n    nameArr.push('ctrl');\r\n  }\r\n  if (evt.detail.event.shiftKey) {\r\n    nameArr.push('shift');\r\n  }\r\n  nameArr.push('doubleClick');\r\n  return nameArr.join('');\r\n}\r\n\r\nexport type initDoubleClickArgs = {\r\n  customizationService: CustomizationService;\r\n  commandsManager: CommandsManager;\r\n};\r\n\r\nfunction initDoubleClick({ customizationService, commandsManager }: initDoubleClickArgs): void {\r\n  const cornerstoneViewportHandleDoubleClick = (evt: CustomEvent) => {\r\n    // Do not allow double click on a tool.\r\n    const nearbyToolData = findNearbyToolData(commandsManager, evt);\r\n    if (nearbyToolData) {\r\n      return;\r\n    }\r\n\r\n    const eventName = getDoubleClickEventName(evt);\r\n\r\n    // Allows for the customization of the double click on a viewport.\r\n    const customizations = customizationService.getCustomization(\r\n      'cornerstoneViewportClickCommands'\r\n    );\r\n\r\n    const toRun = customizations[eventName];\r\n\r\n    if (!toRun) {\r\n      return;\r\n    }\r\n\r\n    commandsManager.run(toRun);\r\n  };\r\n\r\n  function elementEnabledHandler(evt: CustomEvent) {\r\n    const { element } = evt.detail;\r\n\r\n    element.addEventListener(\r\n      cs3DToolsEvents.MOUSE_DOUBLE_CLICK,\r\n      cornerstoneViewportHandleDoubleClick\r\n    );\r\n  }\r\n\r\n  function elementDisabledHandler(evt: CustomEvent) {\r\n    const { element } = evt.detail;\r\n\r\n    element.removeEventListener(\r\n      cs3DToolsEvents.MOUSE_DOUBLE_CLICK,\r\n      cornerstoneViewportHandleDoubleClick\r\n    );\r\n  }\r\n\r\n  eventTarget.addEventListener(EVENTS.ELEMENT_ENABLED, elementEnabledHandler.bind(null));\r\n\r\n  eventTarget.addEventListener(EVENTS.ELEMENT_DISABLED, elementDisabledHandler.bind(null));\r\n}\r\n\r\nexport default initDoubleClick;\r\n","import { eventTarget, Types } from '@cornerstonejs/core';\r\nimport { Enums, annotation } from '@cornerstonejs/tools';\r\nimport { DicomMetadataStore } from '@ohif/core';\r\n\r\nimport * as CSExtensionEnums from './enums';\r\nimport { toolNames } from './initCornerstoneTools';\r\nimport { onCompletedCalibrationLine } from './tools/CalibrationLineTool';\r\nimport measurementServiceMappingsFactory from './utils/measurementServiceMappings/measurementServiceMappingsFactory';\r\nimport getSOPInstanceAttributes from './utils/measurementServiceMappings/utils/getSOPInstanceAttributes';\r\nimport {\r\n  setAnnotationLabel,\r\n  triggerAnnotationRenderForViewportIds,\r\n} from '@cornerstonejs/tools/utilities';\r\nimport getActiveViewportEnabledElement from './utils/getActiveViewportEnabledElement';\r\n\r\nconst { CORNERSTONE_3D_TOOLS_SOURCE_NAME, CORNERSTONE_3D_TOOLS_SOURCE_VERSION } = CSExtensionEnums;\r\nconst { removeAnnotation } = annotation.state;\r\nconst csToolsEvents = Enums.Events;\r\n\r\nconst initMeasurementService = (\r\n  measurementService,\r\n  displaySetService,\r\n  cornerstoneViewportService,\r\n  customizationService\r\n) => {\r\n  /* Initialization */\r\n  const {\r\n    Length,\r\n    Bidirectional,\r\n    EllipticalROI,\r\n    CircleROI,\r\n    ArrowAnnotate,\r\n    Angle,\r\n    CobbAngle,\r\n    RectangleROI,\r\n    PlanarFreehandROI,\r\n    SplineROI,\r\n    LivewireContour,\r\n    Probe,\r\n    UltrasoundDirectional,\r\n    SegmentBidirectional,\r\n  } = measurementServiceMappingsFactory(\r\n    measurementService,\r\n    displaySetService,\r\n    cornerstoneViewportService,\r\n    customizationService\r\n  );\r\n  const csTools3DVer1MeasurementSource = measurementService.createSource(\r\n    CORNERSTONE_3D_TOOLS_SOURCE_NAME,\r\n    CORNERSTONE_3D_TOOLS_SOURCE_VERSION\r\n  );\r\n\r\n  /* Mappings */\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'Length',\r\n    Length.matchingCriteria,\r\n    Length.toAnnotation,\r\n    Length.toMeasurement\r\n  );\r\n\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'Crosshairs',\r\n    Length.matchingCriteria,\r\n    () => {\r\n      return null;\r\n    },\r\n    () => {\r\n      return null;\r\n    }\r\n  );\r\n\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'Bidirectional',\r\n    Bidirectional.matchingCriteria,\r\n    Bidirectional.toAnnotation,\r\n    Bidirectional.toMeasurement\r\n  );\r\n\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'EllipticalROI',\r\n    EllipticalROI.matchingCriteria,\r\n    EllipticalROI.toAnnotation,\r\n    EllipticalROI.toMeasurement\r\n  );\r\n\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'CircleROI',\r\n    CircleROI.matchingCriteria,\r\n    CircleROI.toAnnotation,\r\n    CircleROI.toMeasurement\r\n  );\r\n\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'ArrowAnnotate',\r\n    ArrowAnnotate.matchingCriteria,\r\n    ArrowAnnotate.toAnnotation,\r\n    ArrowAnnotate.toMeasurement\r\n  );\r\n\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'CobbAngle',\r\n    CobbAngle.matchingCriteria,\r\n    CobbAngle.toAnnotation,\r\n    CobbAngle.toMeasurement\r\n  );\r\n\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'Angle',\r\n    Angle.matchingCriteria,\r\n    Angle.toAnnotation,\r\n    Angle.toMeasurement\r\n  );\r\n\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'RectangleROI',\r\n    RectangleROI.matchingCriteria,\r\n    RectangleROI.toAnnotation,\r\n    RectangleROI.toMeasurement\r\n  );\r\n\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'PlanarFreehandROI',\r\n    PlanarFreehandROI.matchingCriteria,\r\n    PlanarFreehandROI.toAnnotation,\r\n    PlanarFreehandROI.toMeasurement\r\n  );\r\n\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'SplineROI',\r\n    SplineROI.matchingCriteria,\r\n    SplineROI.toAnnotation,\r\n    SplineROI.toMeasurement\r\n  );\r\n\r\n  // On the UI side, the Calibration Line tool will work almost the same as the\r\n  // Length tool\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'CalibrationLine',\r\n    Length.matchingCriteria,\r\n    Length.toAnnotation,\r\n    Length.toMeasurement\r\n  );\r\n\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'LivewireContour',\r\n    LivewireContour.matchingCriteria,\r\n    LivewireContour.toAnnotation,\r\n    LivewireContour.toMeasurement\r\n  );\r\n\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'Probe',\r\n    Probe.matchingCriteria,\r\n    Probe.toAnnotation,\r\n    Probe.toMeasurement\r\n  );\r\n\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'UltrasoundDirectionalTool',\r\n    UltrasoundDirectional.matchingCriteria,\r\n    UltrasoundDirectional.toAnnotation,\r\n    UltrasoundDirectional.toMeasurement\r\n  );\r\n\r\n  measurementService.addMapping(\r\n    csTools3DVer1MeasurementSource,\r\n    'SegmentBidirectional',\r\n    SegmentBidirectional.matchingCriteria,\r\n    SegmentBidirectional.toAnnotation,\r\n    SegmentBidirectional.toMeasurement\r\n  );\r\n\r\n  return csTools3DVer1MeasurementSource;\r\n};\r\n\r\nconst connectToolsToMeasurementService = ({\r\n  commandsManager,\r\n  servicesManager,\r\n  extensionManager,\r\n}: {\r\n  commandsManager: AppTypes.CommandsManager;\r\n  servicesManager: AppTypes.ServicesManager;\r\n  extensionManager: AppTypes.ExtensionManager;\r\n}) => {\r\n  const {\r\n    measurementService,\r\n    displaySetService,\r\n    cornerstoneViewportService,\r\n    customizationService,\r\n  } = servicesManager.services;\r\n  const csTools3DVer1MeasurementSource = initMeasurementService(\r\n    measurementService,\r\n    displaySetService,\r\n    cornerstoneViewportService,\r\n    customizationService\r\n  );\r\n  connectMeasurementServiceToTools({ servicesManager, commandsManager, extensionManager });\r\n  const { annotationToMeasurement, remove } = csTools3DVer1MeasurementSource;\r\n\r\n  //\r\n  function addMeasurement(csToolsEvent) {\r\n    try {\r\n      const annotationAddedEventDetail = csToolsEvent.detail;\r\n      const {\r\n        annotation: { metadata, annotationUID },\r\n      } = annotationAddedEventDetail;\r\n      const { toolName } = metadata;\r\n\r\n      if (csToolsEvent.type === completedEvt && toolName === toolNames.CalibrationLine) {\r\n        // show modal to input the measurement (mm)\r\n        onCompletedCalibrationLine(servicesManager, csToolsEvent)\r\n          .then(\r\n            () => {\r\n              console.log('Calibration applied.');\r\n            },\r\n            () => true\r\n          )\r\n          .finally(() => {\r\n            // we don't need the calibration line lingering around, remove the\r\n            // annotation from the display\r\n            removeAnnotation(annotationUID);\r\n            removeMeasurement(csToolsEvent);\r\n            // this will ensure redrawing of annotations\r\n            cornerstoneViewportService.resize();\r\n          });\r\n      } else {\r\n        // To force the measurementUID be the same as the annotationUID\r\n        // Todo: this should be changed when a measurement can include multiple annotations\r\n        // in the future\r\n        annotationAddedEventDetail.uid = annotationUID;\r\n        annotationToMeasurement(toolName, annotationAddedEventDetail);\r\n      }\r\n    } catch (error) {\r\n      console.warn('Failed to add measurement:', error);\r\n    }\r\n  }\r\n\r\n  function updateMeasurement(csToolsEvent) {\r\n    try {\r\n      const annotationModifiedEventDetail = csToolsEvent.detail;\r\n\r\n      const {\r\n        annotation: { metadata, annotationUID },\r\n      } = annotationModifiedEventDetail;\r\n\r\n      // If the measurement hasn't been added, don't modify it\r\n      const measurement = measurementService.getMeasurement(annotationUID);\r\n\r\n      if (!measurement) {\r\n        return;\r\n      }\r\n      const { toolName } = metadata;\r\n\r\n      annotationModifiedEventDetail.uid = annotationUID;\r\n      // Passing true to indicate this is an update and NOT a annotation (start) completion.\r\n      annotationToMeasurement(toolName, annotationModifiedEventDetail, true);\r\n    } catch (error) {\r\n      console.warn('Failed to update measurement:', error);\r\n    }\r\n  }\r\n\r\n  function selectMeasurement(csToolsEvent) {\r\n    try {\r\n      const annotationSelectionEventDetail = csToolsEvent.detail;\r\n\r\n      const { added: addedSelectedAnnotationUIDs, removed: removedSelectedAnnotationUIDs } =\r\n        annotationSelectionEventDetail;\r\n\r\n      if (removedSelectedAnnotationUIDs) {\r\n        removedSelectedAnnotationUIDs.forEach(annotationUID =>\r\n          measurementService.setMeasurementSelected(annotationUID, false)\r\n        );\r\n      }\r\n\r\n      if (addedSelectedAnnotationUIDs) {\r\n        addedSelectedAnnotationUIDs.forEach(annotationUID =>\r\n          measurementService.setMeasurementSelected(annotationUID, true)\r\n        );\r\n      }\r\n    } catch (error) {\r\n      console.warn('Failed to select/unselect measurements:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When csTools fires a removed event, remove the same measurement\r\n   * from the measurement service\r\n   *\r\n   * @param {*} csToolsEvent\r\n   */\r\n  function removeMeasurement(csToolsEvent) {\r\n    try {\r\n      const annotationRemovedEventDetail = csToolsEvent.detail;\r\n      const {\r\n        annotation: { annotationUID },\r\n      } = annotationRemovedEventDetail;\r\n      const measurement = measurementService.getMeasurement(annotationUID);\r\n      if (measurement) {\r\n        remove(annotationUID, annotationRemovedEventDetail);\r\n      }\r\n    } catch (error) {\r\n      console.warn('Failed to remove measurement:', error);\r\n    }\r\n  }\r\n\r\n  // on display sets added, check if there are any measurements in measurement service that need to be\r\n  // put into cornerstone tools\r\n  const addedEvt = csToolsEvents.ANNOTATION_ADDED;\r\n  const completedEvt = csToolsEvents.ANNOTATION_COMPLETED;\r\n  const updatedEvt = csToolsEvents.ANNOTATION_MODIFIED;\r\n  const removedEvt = csToolsEvents.ANNOTATION_REMOVED;\r\n  const selectionEvt = csToolsEvents.ANNOTATION_SELECTION_CHANGE;\r\n\r\n  eventTarget.addEventListener(addedEvt, addMeasurement);\r\n  eventTarget.addEventListener(completedEvt, addMeasurement);\r\n  eventTarget.addEventListener(updatedEvt, updateMeasurement);\r\n  eventTarget.addEventListener(removedEvt, removeMeasurement);\r\n  eventTarget.addEventListener(selectionEvt, selectMeasurement);\r\n\r\n  return csTools3DVer1MeasurementSource;\r\n};\r\n\r\nconst connectMeasurementServiceToTools = ({\r\n  servicesManager,\r\n  commandsManager,\r\n  extensionManager,\r\n}) => {\r\n  const { measurementService, cornerstoneViewportService, viewportGridService } =\r\n    servicesManager.services;\r\n  const { MEASUREMENT_REMOVED, MEASUREMENTS_CLEARED, MEASUREMENT_UPDATED, RAW_MEASUREMENT_ADDED } =\r\n    measurementService.EVENTS;\r\n\r\n  measurementService.subscribe(MEASUREMENTS_CLEARED, ({ measurements }) => {\r\n    if (!Object.keys(measurements).length) {\r\n      return;\r\n    }\r\n\r\n    for (const measurement of Object.values(measurements)) {\r\n      const { uid, source } = measurement;\r\n      if (source.name !== CORNERSTONE_3D_TOOLS_SOURCE_NAME) {\r\n        continue;\r\n      }\r\n      const removedAnnotation = annotation.state.getAnnotation(uid);\r\n      removeAnnotation(uid);\r\n      commandsManager.run('triggerCreateAnnotationMemo', {\r\n        annotation: removedAnnotation,\r\n        FrameOfReferenceUID: removedAnnotation.metadata.FrameOfReferenceUID,\r\n        options: { deleting: true },\r\n      });\r\n    }\r\n\r\n    // trigger a render\r\n    cornerstoneViewportService.getRenderingEngine().render();\r\n  });\r\n\r\n  measurementService.subscribe(\r\n    MEASUREMENT_UPDATED,\r\n    ({ source, measurement, notYetUpdatedAtSource }) => {\r\n      if (!source) {\r\n        return;\r\n      }\r\n\r\n      if (source.name !== CORNERSTONE_3D_TOOLS_SOURCE_NAME) {\r\n        return;\r\n      }\r\n\r\n      if (notYetUpdatedAtSource === false) {\r\n        // This event was fired by cornerstone telling the measurement service to sync.\r\n        // Already in sync.\r\n        return;\r\n      }\r\n\r\n      const { uid, label, isLocked, isVisible } = measurement;\r\n      const sourceAnnotation = annotation.state.getAnnotation(uid);\r\n      const { data, metadata } = sourceAnnotation;\r\n\r\n      if (!data) {\r\n        return;\r\n      }\r\n\r\n      if (data.label !== label) {\r\n        const element = getActiveViewportEnabledElement(viewportGridService)?.viewport.element;\r\n        setAnnotationLabel(sourceAnnotation, element, label);\r\n      }\r\n\r\n      if (metadata.toolName === 'ArrowAnnotate') {\r\n        data.text = label;\r\n      }\r\n\r\n      // update the isLocked state\r\n      annotation.locking.setAnnotationLocked(uid, isLocked);\r\n\r\n      // update the isVisible state\r\n      annotation.visibility.setAnnotationVisibility(uid, isVisible);\r\n\r\n      // annotation.config.style.setAnnotationStyles(uid, {\r\n      //   color: `rgb(${color[0]}, ${color[1]}, ${color[2]})`,\r\n      // });\r\n\r\n      // I don't like this but will fix later\r\n      const renderingEngine =\r\n        cornerstoneViewportService.getRenderingEngine() as Types.IRenderingEngine;\r\n      // Note: We could do a better job by triggering the render on the\r\n      // viewport itself, but the removeAnnotation does not include that info...\r\n      const viewportIds = renderingEngine.getViewports().map(viewport => viewport.id);\r\n      triggerAnnotationRenderForViewportIds(viewportIds);\r\n    }\r\n  );\r\n\r\n  measurementService.subscribe(\r\n    RAW_MEASUREMENT_ADDED,\r\n    ({ source, measurement, data, dataSource }) => {\r\n      if (source.name !== CORNERSTONE_3D_TOOLS_SOURCE_NAME) {\r\n        return;\r\n      }\r\n\r\n      const { referenceSeriesUID, referenceStudyUID, SOPInstanceUID } = measurement;\r\n\r\n      const instance = DicomMetadataStore.getInstance(\r\n        referenceStudyUID,\r\n        referenceSeriesUID,\r\n        SOPInstanceUID\r\n      );\r\n\r\n      let imageId;\r\n      let frameNumber = 1;\r\n\r\n      if (measurement?.metadata?.referencedImageId) {\r\n        imageId = measurement.metadata.referencedImageId;\r\n        frameNumber = getSOPInstanceAttributes(measurement.metadata.referencedImageId).frameNumber;\r\n      } else {\r\n        imageId = dataSource.getImageIdsForInstance({ instance });\r\n      }\r\n\r\n      /**\r\n       * This annotation is used by the cornerstone viewport.\r\n       * This is not the read-only annotation rendered by the SR viewport.\r\n       */\r\n      const annotationManager = annotation.state.getAnnotationManager();\r\n      const newAnnotation = {\r\n        annotationUID: measurement.uid,\r\n        highlighted: false,\r\n        isLocked: false,\r\n        invalidated: false,\r\n        metadata: {\r\n          toolName: measurement.toolName,\r\n          FrameOfReferenceUID: measurement.FrameOfReferenceUID,\r\n          referencedImageId: imageId,\r\n        },\r\n        data: {\r\n          /**\r\n           * Don't remove this destructuring of data here.\r\n           * This is used to pass annotation specific data forward e.g. contour\r\n           */\r\n          ...(data.annotation.data || {}),\r\n          text: data.annotation.data.text,\r\n          handles: { ...data.annotation.data.handles },\r\n          cachedStats: { ...data.annotation.data.cachedStats },\r\n          label: data.annotation.data.label,\r\n          frameNumber,\r\n        },\r\n      };\r\n      annotationManager.addAnnotation(newAnnotation);\r\n      commandsManager.run('triggerCreateAnnotationMemo', {\r\n        annotation: newAnnotation,\r\n        FrameOfReferenceUID: newAnnotation.metadata.FrameOfReferenceUID,\r\n        options: { newAnnotation: true },\r\n      });\r\n    }\r\n  );\r\n\r\n  measurementService.subscribe(\r\n    MEASUREMENT_REMOVED,\r\n    ({ source, measurement: removedMeasurementId }) => {\r\n      if (source?.name && source.name !== CORNERSTONE_3D_TOOLS_SOURCE_NAME) {\r\n        return;\r\n      }\r\n      const removedAnnotation = annotation.state.getAnnotation(removedMeasurementId);\r\n      removeAnnotation(removedMeasurementId);\r\n      commandsManager.run('triggerCreateAnnotationMemo', {\r\n        annotation: removedAnnotation,\r\n        FrameOfReferenceUID: removedAnnotation.metadata.FrameOfReferenceUID,\r\n        options: { deleting: true },\r\n      });\r\n      const renderingEngine = cornerstoneViewportService.getRenderingEngine();\r\n      // Note: We could do a better job by triggering the render on the\r\n      // viewport itself, but the removeAnnotation does not include that info...\r\n      renderingEngine.render();\r\n    }\r\n  );\r\n};\r\n\r\nexport {\r\n  initMeasurementService,\r\n  connectToolsToMeasurementService,\r\n  connectMeasurementServiceToTools,\r\n};\r\n","import { cache, imageLoadPoolManager, imageLoader, Enums, eventTarget, EVENTS as csEvents } from '@cornerstonejs/core';\r\n\r\nfunction initStudyPrefetcherService(servicesManager: AppTypes.ServicesManager) {\r\n  const { studyPrefetcherService } = servicesManager.services;\r\n\r\n  studyPrefetcherService.requestType = Enums.RequestType.Prefetch;\r\n  studyPrefetcherService.imageLoadPoolManager = imageLoadPoolManager;\r\n  studyPrefetcherService.imageLoader = imageLoader;\r\n\r\n  studyPrefetcherService.cache = {\r\n    isImageCached(imageId: string): boolean {\r\n      return !!cache.getImageLoadObject(imageId);\r\n    }\r\n  }\r\n\r\n  studyPrefetcherService.imageLoadEventsManager = {\r\n    addEventListeners(onImageLoaded, onImageLoadFailed) {\r\n      eventTarget.addEventListener(csEvents.IMAGE_LOADED, onImageLoaded);\r\n      eventTarget.addEventListener(csEvents.IMAGE_LOAD_FAILED, onImageLoadFailed);\r\n\r\n      return [\r\n        {\r\n          unsubscribe: () => eventTarget.removeEventListener(csEvents.IMAGE_LOADED, onImageLoaded)\r\n        },\r\n        {\r\n          unsubscribe: () => eventTarget.removeEventListener(csEvents.IMAGE_LOAD_FAILED, onImageLoadFailed)\r\n        },\r\n      ]\r\n    }\r\n  }\r\n}\r\n\r\nexport default initStudyPrefetcherService;\r\n","import { volumeLoader } from '@cornerstonejs/core';\r\nimport {\r\n  cornerstoneStreamingImageVolumeLoader,\r\n  cornerstoneStreamingDynamicImageVolumeLoader,\r\n} from '@cornerstonejs/core/loaders';\r\nimport dicomImageLoader from '@cornerstonejs/dicom-image-loader';\r\nimport { errorHandler, utils } from '@ohif/core';\r\n\r\nconst { registerVolumeLoader } = volumeLoader;\r\n\r\nexport default function initWADOImageLoader(\r\n  userAuthenticationService,\r\n  appConfig,\r\n  extensionManager\r\n) {\r\n  registerVolumeLoader('cornerstoneStreamingImageVolume', cornerstoneStreamingImageVolumeLoader);\r\n\r\n  registerVolumeLoader(\r\n    'cornerstoneStreamingDynamicImageVolume',\r\n    cornerstoneStreamingDynamicImageVolumeLoader\r\n  );\r\n\r\n  dicomImageLoader.init({\r\n    maxWebWorkers: Math.min(\r\n      Math.max(navigator.hardwareConcurrency - 1, 1),\r\n      appConfig.maxNumberOfWebWorkers\r\n    ),\r\n    beforeSend: function (xhr) {\r\n      //TODO should be removed in the future and request emitted by DicomWebDataSource\r\n      const sourceConfig = extensionManager.getActiveDataSource()?.[0].getConfig() ?? {};\r\n      const headers = userAuthenticationService.getAuthorizationHeader();\r\n      const acceptHeader = utils.generateAcceptHeader(\r\n        sourceConfig.acceptHeader,\r\n        sourceConfig.requestTransferSyntaxUID,\r\n        sourceConfig.omitQuotationForMultipartRequest\r\n      );\r\n\r\n      const xhrRequestHeaders = {\r\n        Accept: acceptHeader,\r\n      };\r\n\r\n      if (headers) {\r\n        Object.assign(xhrRequestHeaders, headers);\r\n      }\r\n\r\n      return xhrRequestHeaders;\r\n    },\r\n    errorInterceptor: error => {\r\n      errorHandler.getHTTPErrorHandler(error);\r\n    },\r\n  });\r\n}\r\n\r\nexport function destroy() {\r\n  console.debug('Destroying WADO Image Loader');\r\n}\r\n","import React from 'react';\r\n\r\nimport { useMeasurements } from '../hooks/useMeasurements';\r\nimport StudyMeasurements from '../components/StudyMeasurements';\r\n/**\r\n * The PanelMeasurement is a fairly simple wrapper that gets the filtered\r\n * measurements and then passes it on to the children component, default to\r\n * the StudyMeasurements sub-component if no children are specified.\r\n * Some example customizations that could work:\r\n *\r\n *\r\n * Creates a default study measurements panel with default children:\r\n * ```\r\n * <PanelMeasurement>\r\n *   <StudyMeasurements />\r\n * </PanelMeasurement>\r\n * ```\r\n *\r\n * A study measurements with body replacement\r\n * ```\r\n * <StudyMeasurements>\r\n *   <SeriesMeasurements />\r\n * </StudyMeasurements>\r\n * ```\r\n *\r\n * A study measurements replacing just the trigger, leaving the default body\r\n * ```\r\n * <StudyMeasurements>\r\n *    <AccordionGroup.Trigger>\r\n *        This is a new custom trigger\r\n *    </AccordionGroup.Trigger>\r\n *</StudyMeasurements>\r\n * ```\r\n *\r\n * A study measurements with the trigger and body replaced\r\n * ```\r\n * <StudyMeasurements>\r\n *    <AccordionGroup.Trigger>\r\n *        This is a new custom trigger\r\n *    </AccordionGroup.Trigger>\r\n *    <SeriesMeasurements />\r\n * </StudyMeasurements>\r\n * ```\r\n *\r\n * A study measurements with a custom header for the additional findings\r\n * ```\r\n * <StudyMeasurements>\r\n *    <MeasurementOrAdditionalFindings>\r\n *        <AccordionGroup.Trigger groupName=\"additionalFindings\">\r\n *            <CustomAdditionalFindingsHeader />\r\n *        </AccordionGroup.Trigger>\r\n *        <AccordionGroup.Trigger groupName=\"measurements\">\r\n *            <CustomMeasurementsHeader />\r\n *        </AccordionGroup.Trigger>\r\n *    </MeasurementOrAdditionalFindings>\r\n * </StudyMeasurements>\r\n *```\r\n */\r\nexport default function PanelMeasurement(props): React.ReactNode {\r\n  const { measurementFilter, emptyComponent: EmptyComponent, children } = props;\r\n\r\n  const displayMeasurements = useMeasurements({ measurementFilter });\r\n\r\n  if (!displayMeasurements.length) {\r\n    return EmptyComponent ? (\r\n      <EmptyComponent items={displayMeasurements} />\r\n    ) : (\r\n      <span className=\"text-white\">No Measurements</span>\r\n    );\r\n  }\r\n\r\n  if (children) {\r\n    const cloned = React.Children.map(children, child =>\r\n      React.cloneElement(child, {\r\n        items: displayMeasurements,\r\n        filter: measurementFilter,\r\n      })\r\n    );\r\n    return cloned;\r\n  }\r\n  // Need to merge defaults on the content props to ensure they get passed to children\r\n  return <StudyMeasurements items={displayMeasurements} />;\r\n}\r\n","import React from 'react';\r\nimport { SegmentationTable } from '@ohif/ui-next';\r\nimport { useActiveViewportSegmentationRepresentations } from '../hooks/useActiveViewportSegmentationRepresentations';\r\nimport { metaData } from '@cornerstonejs/core';\r\nimport { useSystem } from '@ohif/core/src';\r\n\r\nexport default function PanelSegmentation({ children }: withAppTypes) {\r\n  const { commandsManager, servicesManager } = useSystem();\r\n  const { customizationService, displaySetService } = servicesManager.services;\r\n\r\n  const { segmentationsWithRepresentations, disabled } =\r\n    useActiveViewportSegmentationRepresentations();\r\n\r\n  // Extract customization options\r\n  const segmentationTableMode = customizationService.getCustomization(\r\n    'panelSegmentation.tableMode'\r\n  ) as unknown as string;\r\n  const onSegmentationAdd = customizationService.getCustomization(\r\n    'panelSegmentation.onSegmentationAdd'\r\n  );\r\n  const disableEditing = customizationService.getCustomization('panelSegmentation.disableEditing');\r\n  const showAddSegment = customizationService.getCustomization('panelSegmentation.showAddSegment');\r\n  const CustomDropdownMenuContent = customizationService.getCustomization(\r\n    'panelSegmentation.customDropdownMenuContent'\r\n  );\r\n\r\n  const CustomSegmentStatisticsHeader = customizationService.getCustomization(\r\n    'panelSegmentation.customSegmentStatisticsHeader'\r\n  );\r\n\r\n  // Create handlers object for all command runs\r\n  const handlers = {\r\n    onSegmentationClick: (segmentationId: string) => {\r\n      commandsManager.run('setActiveSegmentation', { segmentationId });\r\n    },\r\n    onSegmentAdd: segmentationId => {\r\n      commandsManager.run('addSegment', { segmentationId });\r\n    },\r\n    onSegmentClick: (segmentationId, segmentIndex) => {\r\n      commandsManager.run('setActiveSegmentAndCenter', { segmentationId, segmentIndex });\r\n    },\r\n    onSegmentEdit: (segmentationId, segmentIndex) => {\r\n      commandsManager.run('editSegmentLabel', { segmentationId, segmentIndex });\r\n    },\r\n    onSegmentationEdit: segmentationId => {\r\n      commandsManager.run('editSegmentationLabel', { segmentationId });\r\n    },\r\n    onSegmentColorClick: (segmentationId, segmentIndex) => {\r\n      commandsManager.run('editSegmentColor', { segmentationId, segmentIndex });\r\n    },\r\n    onSegmentDelete: (segmentationId, segmentIndex) => {\r\n      commandsManager.run('deleteSegment', { segmentationId, segmentIndex });\r\n    },\r\n    onToggleSegmentVisibility: (segmentationId, segmentIndex, type) => {\r\n      commandsManager.run('toggleSegmentVisibility', { segmentationId, segmentIndex, type });\r\n    },\r\n    onToggleSegmentLock: (segmentationId, segmentIndex) => {\r\n      commandsManager.run('toggleSegmentLock', { segmentationId, segmentIndex });\r\n    },\r\n    onToggleSegmentationRepresentationVisibility: (segmentationId, type) => {\r\n      commandsManager.run('toggleSegmentationVisibility', { segmentationId, type });\r\n    },\r\n    onSegmentationDownload: segmentationId => {\r\n      commandsManager.run('downloadSegmentation', { segmentationId });\r\n    },\r\n    setStyle: (segmentationId, type, key, value) => {\r\n      commandsManager.run('setSegmentationStyle', { segmentationId, type, key, value });\r\n    },\r\n    toggleRenderInactiveSegmentations: () => {\r\n      commandsManager.run('toggleRenderInactiveSegmentations');\r\n    },\r\n    onSegmentationRemoveFromViewport: segmentationId => {\r\n      commandsManager.run('removeSegmentationFromViewport', { segmentationId });\r\n    },\r\n    onSegmentationDelete: segmentationId => {\r\n      commandsManager.run('deleteSegmentation', { segmentationId });\r\n    },\r\n    setFillAlpha: ({ type }, value) => {\r\n      commandsManager.run('setFillAlpha', { type, value });\r\n    },\r\n    setOutlineWidth: ({ type }, value) => {\r\n      commandsManager.run('setOutlineWidth', { type, value });\r\n    },\r\n    setRenderFill: ({ type }, value) => {\r\n      commandsManager.run('setRenderFill', { type, value });\r\n    },\r\n    setRenderOutline: ({ type }, value) => {\r\n      commandsManager.run('setRenderOutline', { type, value });\r\n    },\r\n    setFillAlphaInactive: ({ type }, value) => {\r\n      commandsManager.run('setFillAlphaInactive', { type, value });\r\n    },\r\n    getRenderInactiveSegmentations: () => {\r\n      return commandsManager.run('getRenderInactiveSegmentations');\r\n    },\r\n  };\r\n\r\n  // Generate export options\r\n  const exportOptions = segmentationsWithRepresentations.map(({ segmentation }) => {\r\n    const { representationData, segmentationId } = segmentation;\r\n    const { Labelmap } = representationData;\r\n\r\n    if (!Labelmap) {\r\n      return { segmentationId, isExportable: true };\r\n    }\r\n\r\n    const referencedImageIds = Labelmap.referencedImageIds;\r\n    const firstImageId = referencedImageIds[0];\r\n    const instance = metaData.get('instance', firstImageId);\r\n\r\n    if (!instance) {\r\n      return { segmentationId, isExportable: false };\r\n    }\r\n\r\n    const SOPInstanceUID = instance.SOPInstanceUID || instance.SopInstanceUID;\r\n    const SeriesInstanceUID = instance.SeriesInstanceUID;\r\n    const displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n      SOPInstanceUID,\r\n      SeriesInstanceUID\r\n    );\r\n\r\n    return {\r\n      segmentationId,\r\n      isExportable: displaySet?.isReconstructable,\r\n    };\r\n  });\r\n\r\n  // Common props for SegmentationTable\r\n  const tableProps = {\r\n    disabled,\r\n    data: segmentationsWithRepresentations,\r\n    mode: segmentationTableMode,\r\n    title: 'Segmentations',\r\n    exportOptions,\r\n    disableEditing,\r\n    onSegmentationAdd,\r\n    showAddSegment,\r\n    renderInactiveSegmentations: handlers.getRenderInactiveSegmentations(),\r\n    ...handlers,\r\n  };\r\n\r\n  const renderSegments = () => {\r\n    return (\r\n      <SegmentationTable.Segments>\r\n        <SegmentationTable.SegmentStatistics.Header>\r\n          <CustomSegmentStatisticsHeader />\r\n        </SegmentationTable.SegmentStatistics.Header>\r\n        <SegmentationTable.SegmentStatistics.Body />\r\n      </SegmentationTable.Segments>\r\n    );\r\n  };\r\n\r\n  // Render content based on mode\r\n  const renderModeContent = () => {\r\n    if (tableProps.mode === 'collapsed') {\r\n      return (\r\n        <SegmentationTable.Collapsed>\r\n          <SegmentationTable.Collapsed.Header>\r\n            <SegmentationTable.Collapsed.DropdownMenu>\r\n              <CustomDropdownMenuContent />\r\n            </SegmentationTable.Collapsed.DropdownMenu>\r\n            <SegmentationTable.Collapsed.Selector />\r\n            <SegmentationTable.Collapsed.Info />\r\n          </SegmentationTable.Collapsed.Header>\r\n          <SegmentationTable.Collapsed.Content>\r\n            <SegmentationTable.AddSegmentRow />\r\n            {renderSegments()}\r\n          </SegmentationTable.Collapsed.Content>\r\n        </SegmentationTable.Collapsed>\r\n      );\r\n    }\r\n\r\n    return (\r\n      <>\r\n        <SegmentationTable.Expanded>\r\n          <SegmentationTable.Expanded.Header>\r\n            <SegmentationTable.Expanded.DropdownMenu>\r\n              <CustomDropdownMenuContent />\r\n            </SegmentationTable.Expanded.DropdownMenu>\r\n            <SegmentationTable.Expanded.Label />\r\n            <SegmentationTable.Expanded.Info />\r\n          </SegmentationTable.Expanded.Header>\r\n\r\n          <SegmentationTable.Expanded.Content>\r\n            <SegmentationTable.AddSegmentRow />\r\n            {renderSegments()}\r\n          </SegmentationTable.Expanded.Content>\r\n        </SegmentationTable.Expanded>\r\n      </>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <SegmentationTable {...tableProps}>\r\n      {children}\r\n      <SegmentationTable.Config />\r\n      <SegmentationTable.AddSegmentationRow />\r\n      {renderModeContent()}\r\n    </SegmentationTable>\r\n  );\r\n}\r\n","import { PubSubService, Types as OhifTypes } from '@ohif/core';\r\nimport { RENDERING_ENGINE_ID } from '../ViewportService/constants';\r\nimport { getRenderingEngine } from '@cornerstonejs/core';\r\nimport { ColorbarOptions, ChangeTypes } from '../../types/Colorbar';\r\n\r\nexport default class ColorbarService extends PubSubService {\r\n  static EVENTS = {\r\n    STATE_CHANGED: 'event::ColorbarService:stateChanged',\r\n  };\r\n\r\n  public static REGISTRATION = {\r\n    name: 'colorbarService',\r\n    create: ({ servicesManager }: OhifTypes.Extensions.ExtensionParams) => {\r\n      return new ColorbarService(servicesManager);\r\n    },\r\n  };\r\n\r\n  /**\r\n   * Structure of colorbars state:\r\n   * {\r\n   *   [viewportId]: [\r\n   *     {\r\n   *       displaySetInstanceUID: string,\r\n   *       colorbar: {\r\n   *         activeColormapName: string,\r\n   *         colormaps: array,\r\n   *         volumeId: string (optional),\r\n   *       }\r\n   *     }\r\n   *   ]\r\n   * }\r\n   */\r\n  colorbars = {};\r\n  servicesManager: AppTypes.ServicesManager;\r\n\r\n  constructor(servicesManager: AppTypes.ServicesManager) {\r\n    super(ColorbarService.EVENTS);\r\n    this.servicesManager = servicesManager;\r\n  }\r\n\r\n  /**\r\n   * Gets the appropriate data ID for a viewport and display set\r\n   * @param viewport - The viewport instance\r\n   * @param displaySetInstanceUID - The display set instance UID to identify data\r\n   * @returns The appropriate data ID for the viewport type (volumeId for volume viewports, undefined for stack)\r\n   */\r\n  private getDataIdForViewport(viewport, displaySetInstanceUID: string): string | undefined {\r\n    // For volume viewports, find the matching volumeId\r\n    if (viewport.getAllVolumeIds) {\r\n      const volumeIds = viewport.getAllVolumeIds() || [];\r\n      return volumeIds.length > 0\r\n        ? volumeIds.find(id => id.includes(displaySetInstanceUID)) || undefined\r\n        : undefined;\r\n    }\r\n\r\n    // For other viewports, no specific dataId is needed for now\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * Adds a colorbar to a specific viewport identified by `viewportId`, using the provided `displaySetInstanceUIDs` and `options`.\r\n   * This method prepares the colorbar state that will be used by the ViewportColorbarsContainer component.\r\n   *\r\n   * @param viewportId The identifier for the viewport where the colorbar will be added.\r\n   * @param displaySetInstanceUIDs An array of display set instance UIDs to associate with the colorbar.\r\n   * @param options Configuration options for the colorbar, including position, colormaps, active colormap name, ticks, and width.\r\n   */\r\n  public addColorbar(\r\n    viewportId: string,\r\n    displaySetInstanceUIDs: string[],\r\n    options = {} as ColorbarOptions\r\n  ) {\r\n    const { displaySetService } = this.servicesManager.services;\r\n    const renderingEngine = getRenderingEngine(RENDERING_ENGINE_ID);\r\n    const viewport = renderingEngine.getViewport(viewportId);\r\n\r\n    if (!viewport) {\r\n      return;\r\n    }\r\n\r\n    const actorEntries = viewport.getActors();\r\n    if (!actorEntries || actorEntries.length === 0) {\r\n      return;\r\n    }\r\n\r\n    const { activeColormapName, colormaps } = options;\r\n\r\n    displaySetInstanceUIDs.forEach(displaySetInstanceUID => {\r\n      // don't show colorbar for overlay display sets (e.g. segmentation)\r\n      const displaySet = displaySetService.getDisplaySetByUID(displaySetInstanceUID);\r\n      if (displaySet.isOverlayDisplaySet) {\r\n        return;\r\n      }\r\n\r\n      const dataId = this.getDataIdForViewport(viewport, displaySetInstanceUID);\r\n      const properties = dataId ? viewport.getProperties(dataId) : viewport.getProperties();\r\n      const colormap = properties?.colormap;\r\n\r\n      if (activeColormapName && !colormap) {\r\n        this.setViewportColormap(\r\n          viewportId,\r\n          displaySetInstanceUID,\r\n          colormaps[activeColormapName],\r\n          true\r\n        );\r\n      }\r\n\r\n      // Prepare colorbar data for the React component\r\n      const colorbarData = {\r\n        activeColormapName: colormap?.name || options?.activeColormapName || 'Grayscale',\r\n        colormaps: options.colormaps ? Object.values(options.colormaps) : [],\r\n        volumeId: dataId,\r\n        dataId,\r\n      };\r\n\r\n      // Store the colorbar data in the service state\r\n      if (this.colorbars[viewportId]) {\r\n        // Check if there's already an entry for this displaySetInstanceUID\r\n        const existingIndex = this.colorbars[viewportId].findIndex(\r\n          item => item.displaySetInstanceUID === displaySetInstanceUID\r\n        );\r\n\r\n        if (existingIndex !== -1) {\r\n          // Update existing colorbar\r\n          this.colorbars[viewportId][existingIndex].colorbar = colorbarData;\r\n        } else {\r\n          // Add new colorbar\r\n          this.colorbars[viewportId].push({\r\n            colorbar: colorbarData,\r\n            displaySetInstanceUID,\r\n          });\r\n        }\r\n      } else {\r\n        // Create new colorbar array for this viewport\r\n        this.colorbars[viewportId] = [\r\n          {\r\n            colorbar: colorbarData,\r\n            displaySetInstanceUID,\r\n          },\r\n        ];\r\n      }\r\n    });\r\n\r\n    // Notify listeners about the state change\r\n    this._broadcastEvent(ColorbarService.EVENTS.STATE_CHANGED, {\r\n      viewportId,\r\n      changeType: ChangeTypes.Added,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Removes a colorbar from a specific viewport. If displaySetInstanceUID is provided,\r\n   * only the colorbar associated with that specific displaySetInstanceUID will be removed.\r\n   * Otherwise, all colorbars for the given viewport will be removed.\r\n   *\r\n   * @param viewportId The identifier for the viewport from which the colorbar will be removed.\r\n   * @param displaySetInstanceUID Optional. The specific display set instance UID associated with the colorbar to remove.\r\n   */\r\n  public removeColorbar(viewportId, displaySetInstanceUID?: string) {\r\n    const colorbarInfo = this.colorbars[viewportId];\r\n    if (!colorbarInfo) {\r\n      return;\r\n    }\r\n\r\n    if (displaySetInstanceUID) {\r\n      // Find the index of the colorbar with the matching displaySetInstanceUID\r\n      const index = colorbarInfo.findIndex(\r\n        info => info.displaySetInstanceUID === displaySetInstanceUID\r\n      );\r\n\r\n      if (index !== -1) {\r\n        // Remove the colorbar from the array\r\n        colorbarInfo.splice(index, 1);\r\n\r\n        // If there are no more colorbars for this viewport, remove the entry\r\n        if (colorbarInfo.length === 0) {\r\n          delete this.colorbars[viewportId];\r\n        }\r\n      }\r\n    } else {\r\n      delete this.colorbars[viewportId];\r\n    }\r\n\r\n    this._broadcastEvent(ColorbarService.EVENTS.STATE_CHANGED, {\r\n      viewportId,\r\n      displaySetInstanceUID,\r\n      changeType: ChangeTypes.Removed,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Checks whether a colorbar is associated with a given viewport ID.\r\n   *\r\n   * @param viewportId The identifier for the viewport to check.\r\n   * @returns `true` if a colorbar exists for the specified viewport, otherwise `false`.\r\n   */\r\n  public hasColorbar(viewportId) {\r\n    return this.colorbars[viewportId] ? true : false;\r\n  }\r\n\r\n  /**\r\n   * Retrieves the current state of colorbars, including all active colorbars and their configurations.\r\n   *\r\n   * @returns An object representing the current state of all colorbars managed by this service.\r\n   */\r\n  public getState() {\r\n    return this.colorbars;\r\n  }\r\n\r\n  /**\r\n   * Retrieves colorbar information for a specific viewport ID.\r\n   *\r\n   * @param viewportId The identifier for the viewport to retrieve colorbar information for.\r\n   * @returns The colorbar information associated with the specified viewport, if available.\r\n   */\r\n  public getViewportColorbar(viewportId) {\r\n    return this.colorbars[viewportId];\r\n  }\r\n\r\n  /**\r\n   * Handles the cleanup and removal of all colorbars from the viewports. This is typically called\r\n   * when exiting the mode or context in which the colorbars are used, ensuring that no DOM\r\n   * elements or references are left behind.\r\n   */\r\n  public onModeExit() {\r\n    const viewportIds = Object.keys(this.colorbars);\r\n    viewportIds.forEach(viewportId => {\r\n      this.removeColorbar(viewportId);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sets the colormap for a viewport. This function is used internally to update the colormap the viewport\r\n   *\r\n   * @param viewportId The identifier of the viewport to update.\r\n   * @param displaySetInstanceUID The display set instance UID associated with the viewport.\r\n   * @param colormap The colormap object to set on the viewport.\r\n   * @param immediate A boolean indicating whether the viewport should be re-rendered immediately after setting the colormap.\r\n   */\r\n  private setViewportColormap(viewportId, displaySetInstanceUID, colormap, immediate = false) {\r\n    const renderingEngine = getRenderingEngine(RENDERING_ENGINE_ID);\r\n    const viewport = renderingEngine.getViewport(viewportId);\r\n    const actorEntries = viewport?.getActors();\r\n    if (!viewport || !actorEntries || actorEntries.length === 0) {\r\n      return;\r\n    }\r\n\r\n    // Get the appropriate dataId for this viewport/displaySet combination\r\n    const dataId = this.getDataIdForViewport(viewport, displaySetInstanceUID);\r\n\r\n    // Set properties with or without dataId based on what the viewport supports\r\n    viewport.setProperties({ colormap }, dataId);\r\n\r\n    if (immediate) {\r\n      viewport.render();\r\n    }\r\n  }\r\n}\r\n","import ColorbarService from './ColorbarService';\r\nexport default ColorbarService;\r\n","import { Types } from '@ohif/core';\r\nimport { cache as cs3DCache, Enums, volumeLoader } from '@cornerstonejs/core';\r\n\r\nimport getCornerstoneViewportType from '../../utils/getCornerstoneViewportType';\r\nimport { StackViewportData, VolumeViewportData } from '../../types/CornerstoneCacheService';\r\nimport { VOLUME_LOADER_SCHEME } from '../../constants';\r\n\r\nclass CornerstoneCacheService {\r\n  static REGISTRATION = {\r\n    name: 'cornerstoneCacheService',\r\n    altName: 'CornerstoneCacheService',\r\n    create: ({ servicesManager }: Types.Extensions.ExtensionParams): CornerstoneCacheService => {\r\n      return new CornerstoneCacheService(servicesManager);\r\n    },\r\n  };\r\n\r\n  stackImageIds: Map<string, string[]> = new Map();\r\n  volumeImageIds: Map<string, string[]> = new Map();\r\n  readonly servicesManager: AppTypes.ServicesManager;\r\n\r\n  constructor(servicesManager: AppTypes.ServicesManager) {\r\n    this.servicesManager = servicesManager;\r\n  }\r\n\r\n  public getCacheSize() {\r\n    return cs3DCache.getCacheSize();\r\n  }\r\n\r\n  public getCacheFreeSpace() {\r\n    return cs3DCache.getBytesAvailable();\r\n  }\r\n\r\n  public async createViewportData(\r\n    displaySets: Types.DisplaySet[],\r\n    viewportOptions: AppTypes.ViewportGrid.GridViewportOptions,\r\n    dataSource: unknown,\r\n    initialImageIndex?: number\r\n  ): Promise<StackViewportData | VolumeViewportData> {\r\n    const viewportType = viewportOptions.viewportType as string;\r\n\r\n    const cs3DViewportType = getCornerstoneViewportType(viewportType, displaySets);\r\n    let viewportData: StackViewportData | VolumeViewportData;\r\n\r\n    if (\r\n      cs3DViewportType === Enums.ViewportType.ORTHOGRAPHIC ||\r\n      cs3DViewportType === Enums.ViewportType.VOLUME_3D\r\n    ) {\r\n      viewportData = await this._getVolumeViewportData(dataSource, displaySets, cs3DViewportType);\r\n    } else if (cs3DViewportType === Enums.ViewportType.STACK) {\r\n      // Everything else looks like a stack\r\n      viewportData = await this._getStackViewportData(\r\n        dataSource,\r\n        displaySets,\r\n        initialImageIndex,\r\n        cs3DViewportType\r\n      );\r\n    } else {\r\n      viewportData = await this._getOtherViewportData(\r\n        dataSource,\r\n        displaySets,\r\n        initialImageIndex,\r\n        cs3DViewportType\r\n      );\r\n    }\r\n\r\n    viewportData.viewportType = cs3DViewportType;\r\n\r\n    return viewportData;\r\n  }\r\n\r\n  public async invalidateViewportData(\r\n    viewportData: VolumeViewportData | StackViewportData,\r\n    invalidatedDisplaySetInstanceUID: string,\r\n    dataSource,\r\n    displaySetService\r\n  ): Promise<VolumeViewportData | StackViewportData> {\r\n    if (viewportData.viewportType === Enums.ViewportType.STACK) {\r\n      const displaySet = displaySetService.getDisplaySetByUID(invalidatedDisplaySetInstanceUID);\r\n      const imageIds = this._getCornerstoneStackImageIds(displaySet, dataSource);\r\n\r\n      // remove images from the cache to be able to re-load them\r\n      imageIds.forEach(imageId => {\r\n        if (cs3DCache.getImageLoadObject(imageId)) {\r\n          cs3DCache.removeImageLoadObject(imageId);\r\n        }\r\n      });\r\n\r\n      return {\r\n        viewportType: Enums.ViewportType.STACK,\r\n        data: {\r\n          StudyInstanceUID: displaySet.StudyInstanceUID,\r\n          displaySetInstanceUID: invalidatedDisplaySetInstanceUID,\r\n          imageIds,\r\n        },\r\n      };\r\n    }\r\n\r\n    // Todo: grab the volume and get the id from the viewport itself\r\n    const volumeId = `${VOLUME_LOADER_SCHEME}:${invalidatedDisplaySetInstanceUID}`;\r\n\r\n    const volume = cs3DCache.getVolume(volumeId);\r\n\r\n    if (volume) {\r\n      if (volume.imageIds) {\r\n        // also for each imageId in the volume, remove the imageId from the cache\r\n        // since that will hold the old metadata as well\r\n\r\n        volume.imageIds.forEach(imageId => {\r\n          if (cs3DCache.getImageLoadObject(imageId)) {\r\n            cs3DCache.removeImageLoadObject(imageId);\r\n          }\r\n        });\r\n      }\r\n\r\n      // this shouldn't be via removeVolumeLoadObject, since that will\r\n      // remove the texture as well, but here we really just need a remove\r\n      // from registry so that we load it again\r\n      cs3DCache._volumeCache.delete(volumeId);\r\n      this.volumeImageIds.delete(volumeId);\r\n    }\r\n\r\n    const displaySets = viewportData.data.map(({ displaySetInstanceUID }) =>\r\n      displaySetService.getDisplaySetByUID(displaySetInstanceUID)\r\n    );\r\n\r\n    const newViewportData = await this._getVolumeViewportData(\r\n      dataSource,\r\n      displaySets,\r\n      viewportData.viewportType\r\n    );\r\n\r\n    return newViewportData;\r\n  }\r\n\r\n  private async _getOtherViewportData(\r\n    dataSource,\r\n    displaySets,\r\n    _initialImageIndex,\r\n    viewportType: Enums.ViewportType\r\n  ): Promise<StackViewportData> {\r\n    // TODO - handle overlays and secondary display sets, but for now assume\r\n    // the 1st display set is the one of interest\r\n    const [displaySet] = displaySets;\r\n    if (!displaySet.imageIds) {\r\n      displaySet.imagesIds = this._getCornerstoneStackImageIds(displaySet, dataSource);\r\n    }\r\n    const { imageIds: data, viewportType: dsViewportType } = displaySet;\r\n    return {\r\n      viewportType: dsViewportType || viewportType,\r\n      data: displaySets,\r\n    };\r\n  }\r\n\r\n  private async _getStackViewportData(\r\n    dataSource,\r\n    displaySets,\r\n    initialImageIndex,\r\n    viewportType: Enums.ViewportType\r\n  ): Promise<StackViewportData> {\r\n    const { uiNotificationService } = this.servicesManager.services;\r\n    const overlayDisplaySets = displaySets.filter(ds => ds.isOverlayDisplaySet);\r\n    for (const overlayDisplaySet of overlayDisplaySets) {\r\n      if (overlayDisplaySet.load && overlayDisplaySet.load instanceof Function) {\r\n        const { userAuthenticationService } = this.servicesManager.services;\r\n        const headers = userAuthenticationService.getAuthorizationHeader();\r\n        try {\r\n          await overlayDisplaySet.load({ headers });\r\n        } catch (e) {\r\n          uiNotificationService.show({\r\n            title: 'Error loading displaySet',\r\n            message: e.message,\r\n            type: 'error',\r\n          });\r\n          console.error(e);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Ensuring the first non-overlay `displaySet` is always the primary one\r\n    const StackViewportData = [];\r\n    for (const displaySet of displaySets) {\r\n      const { displaySetInstanceUID, StudyInstanceUID, isCompositeStack } = displaySet;\r\n\r\n      if (displaySet.load && displaySet.load instanceof Function) {\r\n        const { userAuthenticationService } = this.servicesManager.services;\r\n        const headers = userAuthenticationService.getAuthorizationHeader();\r\n        try {\r\n          await displaySet.load({ headers });\r\n        } catch (e) {\r\n          uiNotificationService.show({\r\n            title: 'Error loading displaySet',\r\n            message: e.message,\r\n            type: 'error',\r\n          });\r\n          console.error(e);\r\n        }\r\n      }\r\n\r\n      let stackImageIds = this.stackImageIds.get(displaySet.displaySetInstanceUID);\r\n\r\n      if (!stackImageIds) {\r\n        stackImageIds = this._getCornerstoneStackImageIds(displaySet, dataSource);\r\n        // assign imageIds to the displaySet\r\n        displaySet.imageIds = stackImageIds;\r\n        this.stackImageIds.set(displaySet.displaySetInstanceUID, stackImageIds);\r\n      }\r\n\r\n      StackViewportData.push({\r\n        StudyInstanceUID,\r\n        displaySetInstanceUID,\r\n        isCompositeStack,\r\n        imageIds: stackImageIds,\r\n        initialImageIndex,\r\n      });\r\n    }\r\n\r\n    return {\r\n      viewportType,\r\n      data: StackViewportData,\r\n    };\r\n  }\r\n\r\n  private async _getVolumeViewportData(\r\n    dataSource,\r\n    displaySets,\r\n    viewportType: Enums.ViewportType\r\n  ): Promise<VolumeViewportData> {\r\n    // Todo: Check the cache for multiple scenarios to see if we need to\r\n    // decache the volume data from other viewports or not\r\n\r\n    const volumeData = [];\r\n\r\n    for (const displaySet of displaySets) {\r\n      const { Modality } = displaySet;\r\n      const isParametricMap = Modality === 'PMAP';\r\n      const isSeg = Modality === 'SEG';\r\n\r\n      // Don't create volumes for the displaySets that have custom load\r\n      // function (e.g., SEG, RT, since they rely on the reference volumes\r\n      // and they take care of their own loading after they are created in their\r\n      // getSOPClassHandler method\r\n\r\n      if (displaySet.load && displaySet.load instanceof Function) {\r\n        const { userAuthenticationService } = this.servicesManager.services;\r\n        const headers = userAuthenticationService.getAuthorizationHeader();\r\n\r\n        try {\r\n          await displaySet.load({ headers });\r\n        } catch (e) {\r\n          const { uiNotificationService } = this.servicesManager.services;\r\n          uiNotificationService.show({\r\n            title: 'Error loading displaySet',\r\n            message: e.message,\r\n            type: 'error',\r\n          });\r\n          console.error(e);\r\n        }\r\n\r\n        // Parametric maps have a `load` method but it should not be loaded in the\r\n        // same way as SEG and RTSTRUCT but like a normal volume\r\n        if (!isParametricMap) {\r\n          volumeData.push({\r\n            studyInstanceUID: displaySet.StudyInstanceUID,\r\n            displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n          });\r\n\r\n          // Todo: do some cache check and empty the cache if needed\r\n          continue;\r\n        }\r\n      }\r\n\r\n      const volumeLoaderSchema = displaySet.volumeLoaderSchema ?? VOLUME_LOADER_SCHEME;\r\n      const volumeId = `${volumeLoaderSchema}:${displaySet.displaySetInstanceUID}`;\r\n      let volumeImageIds = this.volumeImageIds.get(displaySet.displaySetInstanceUID);\r\n      let volume = cs3DCache.getVolume(volumeId);\r\n\r\n      // Parametric maps do not have image ids but they already have volume data\r\n      // therefore a new volume should not be created.\r\n      if (!isParametricMap && !isSeg && (!volumeImageIds || !volume)) {\r\n        volumeImageIds = this._getCornerstoneVolumeImageIds(displaySet, dataSource);\r\n\r\n        volume = await volumeLoader.createAndCacheVolume(volumeId, {\r\n          imageIds: volumeImageIds,\r\n        });\r\n\r\n        this.volumeImageIds.set(displaySet.displaySetInstanceUID, volumeImageIds);\r\n\r\n        // Add imageIds to the displaySet for volumes\r\n        displaySet.imageIds = volumeImageIds;\r\n      }\r\n\r\n      volumeData.push({\r\n        StudyInstanceUID: displaySet.StudyInstanceUID,\r\n        displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n        volume,\r\n        volumeId,\r\n        imageIds: volumeImageIds,\r\n        isDynamicVolume: displaySet.isDynamicVolume,\r\n      });\r\n    }\r\n\r\n    return {\r\n      viewportType,\r\n      data: volumeData,\r\n    };\r\n  }\r\n\r\n  private _getCornerstoneStackImageIds(displaySet, dataSource): string[] {\r\n    return dataSource.getImageIdsForDisplaySet(displaySet);\r\n  }\r\n\r\n  private _getCornerstoneVolumeImageIds(displaySet, dataSource): string[] {\r\n    if (displaySet.imageIds) {\r\n      return displaySet.imageIds;\r\n    }\r\n\r\n    const stackImageIds = this._getCornerstoneStackImageIds(displaySet, dataSource);\r\n\r\n    return stackImageIds;\r\n  }\r\n}\r\n\r\nexport default CornerstoneCacheService;\r\n","import CornerstoneCacheService from './CornerstoneCacheService';\r\n\r\nexport default CornerstoneCacheService;\r\n","/**\r\n * Maps a DICOM RT Struct ROI Contour to a RTStruct data that can be used\r\n * in Segmentation Service\r\n *\r\n * @param structureSet - A DICOM RT Struct ROI Contour\r\n * @param rtDisplaySetUID - A CornerstoneTools DisplaySet UID\r\n * @returns An array of object that includes data, id, segmentIndex, color\r\n * and geometry Id\r\n */\r\nexport function mapROIContoursToRTStructData(structureSet: unknown, rtDisplaySetUID: unknown) {\r\n  return structureSet.ROIContours.map(\r\n    ({ contourPoints, ROINumber, ROIName, colorArray, ROIGroup }) => {\r\n      const data = contourPoints.map(({ points, ...rest }) => {\r\n        const newPoints = points.map(({ x, y, z }) => {\r\n          return [x, y, z];\r\n        });\r\n\r\n        return {\r\n          ...rest,\r\n          points: newPoints,\r\n        };\r\n      });\r\n\r\n      const id = ROIName || ROINumber;\r\n\r\n      return {\r\n        data,\r\n        id,\r\n        segmentIndex: ROINumber,\r\n        color: colorArray,\r\n        group: ROIGroup,\r\n        geometryId: `${rtDisplaySetUID}:${id}:segmentIndex-${ROINumber}`,\r\n      };\r\n    }\r\n  );\r\n}\r\n","import {\r\n  cache,\r\n  Enums as csEnums,\r\n  eventTarget,\r\n  geometryLoader,\r\n  getEnabledElementByViewportId,\r\n  imageLoader,\r\n  Types as csTypes,\r\n  utilities as csUtils,\r\n  metaData,\r\n} from '@cornerstonejs/core';\r\nimport {\r\n  Enums as csToolsEnums,\r\n  segmentation as cstSegmentation,\r\n  Types as cstTypes,\r\n} from '@cornerstonejs/tools';\r\nimport { PubSubService, Types as OHIFTypes } from '@ohif/core';\r\nimport i18n from '@ohif/i18n';\r\nimport { easeInOutBell, easeInOutBellRelative } from '../../utils/transitions';\r\nimport { mapROIContoursToRTStructData } from './RTSTRUCT/mapROIContoursToRTStructData';\r\nimport { SegmentationRepresentations } from '@cornerstonejs/tools/enums';\r\nimport { addColorLUT } from '@cornerstonejs/tools/segmentation/addColorLUT';\r\nimport { getNextColorLUTIndex } from '@cornerstonejs/tools/segmentation/getNextColorLUTIndex';\r\nimport { Segment } from '@cornerstonejs/tools/types/SegmentationStateTypes';\r\nimport { ContourStyle, LabelmapStyle, SurfaceStyle } from '@cornerstonejs/tools/types';\r\nimport { ViewportType } from '@cornerstonejs/core/enums';\r\nimport { SegmentationPresentation, SegmentationPresentationItem } from '../../types/Presentation';\r\nimport { updateLabelmapSegmentationImageReferences } from '@cornerstonejs/tools/segmentation/updateLabelmapSegmentationImageReferences';\r\nimport { triggerSegmentationRepresentationModified } from '@cornerstonejs/tools/segmentation/triggerSegmentationEvents';\r\nimport { convertStackToVolumeLabelmap } from '@cornerstonejs/tools/segmentation/helpers/convertStackToVolumeLabelmap';\r\nimport { getLabelmapImageIds } from '@cornerstonejs/tools/segmentation';\r\nimport { VOLUME_LOADER_SCHEME } from '../../constants';\r\n\r\nconst LABELMAP = csToolsEnums.SegmentationRepresentations.Labelmap;\r\nconst CONTOUR = csToolsEnums.SegmentationRepresentations.Contour;\r\n\r\nexport type SegmentRepresentation = {\r\n  segmentIndex: number;\r\n  color: csTypes.Color;\r\n  opacity: number;\r\n  visible: boolean;\r\n};\r\n\r\nexport type SegmentationData = cstTypes.Segmentation;\r\n\r\nexport type SegmentationRepresentation = cstTypes.SegmentationRepresentation & {\r\n  viewportId: string;\r\n  id: string;\r\n  label: string;\r\n  styles: cstTypes.RepresentationStyle;\r\n  segments: {\r\n    [key: number]: SegmentRepresentation;\r\n  };\r\n};\r\n\r\nexport type SegmentationInfo = {\r\n  segmentation: SegmentationData;\r\n  representation?: SegmentationRepresentation;\r\n};\r\n\r\nconst EVENTS = {\r\n  SEGMENTATION_MODIFIED: 'event::segmentation_modified',\r\n  // fired when the segmentation is added\r\n  SEGMENTATION_ADDED: 'event::segmentation_added',\r\n  //\r\n  SEGMENTATION_DATA_MODIFIED: 'event::segmentation_data_modified',\r\n  // fired when the segmentation is removed\r\n  SEGMENTATION_REMOVED: 'event::segmentation_removed',\r\n  //\r\n  // fired when segmentation representation is added\r\n  SEGMENTATION_REPRESENTATION_MODIFIED: 'event::segmentation_representation_modified',\r\n  // fired when segmentation representation is removed\r\n  SEGMENTATION_REPRESENTATION_REMOVED: 'event::segmentation_representation_removed',\r\n  //\r\n  // LOADING EVENTS\r\n  // fired when the active segment is loaded in SEG or RTSTRUCT\r\n  SEGMENT_LOADING_COMPLETE: 'event::segment_loading_complete',\r\n  // loading completed for all segments\r\n  SEGMENTATION_LOADING_COMPLETE: 'event::segmentation_loading_complete',\r\n};\r\n\r\nconst VALUE_TYPES = {};\r\n\r\nclass SegmentationService extends PubSubService {\r\n  static REGISTRATION = {\r\n    name: 'segmentationService',\r\n    altName: 'SegmentationService',\r\n    create: ({ servicesManager }: OHIFTypes.Extensions.ExtensionParams): SegmentationService => {\r\n      return new SegmentationService({ servicesManager });\r\n    },\r\n  };\r\n\r\n  private _segmentationIdToColorLUTIndexMap: Map<string, number>;\r\n  private _segmentationGroupStatsMap: Map<string, any>;\r\n  readonly servicesManager: AppTypes.ServicesManager;\r\n  highlightIntervalId = null;\r\n  readonly EVENTS = EVENTS;\r\n\r\n  constructor({ servicesManager }) {\r\n    super(EVENTS);\r\n\r\n    this._segmentationIdToColorLUTIndexMap = new Map();\r\n\r\n    this.servicesManager = servicesManager;\r\n\r\n    this._segmentationGroupStatsMap = new Map();\r\n  }\r\n\r\n  public onModeEnter(): void {\r\n    this._initSegmentationService();\r\n  }\r\n\r\n  public onModeExit(): void {\r\n    this.destroy();\r\n  }\r\n\r\n  /**\r\n   * Retrieves a segmentation by its ID.\r\n   *\r\n   * @param segmentationId - The unique identifier of the segmentation to retrieve.\r\n   * @returns The segmentation object if found, or undefined if not found.\r\n   *\r\n   * @remarks\r\n   * This method directly accesses the cornerstone tools segmentation state to fetch\r\n   * the segmentation data. It's useful when you need to access specific properties\r\n   * or perform operations on a particular segmentation.\r\n   */\r\n  public getSegmentation(segmentationId: string): cstTypes.Segmentation | undefined {\r\n    return cstSegmentation.state.getSegmentation(segmentationId);\r\n  }\r\n\r\n  /**\r\n   * Retrieves all segmentations from the cornerstone tools segmentation state.\r\n   *\r\n   * @returns An array of all segmentations currently stored in the state\r\n   *\r\n   * @remarks\r\n   * This is a convenience method that directly accesses the cornerstone tools\r\n   * segmentation state to get all available segmentations. It returns the raw\r\n   * segmentation objects without any additional processing or filtering.\r\n   */\r\n  public getSegmentations(): cstTypes.Segmentation[] | [] {\r\n    return cstSegmentation.state.getSegmentations();\r\n  }\r\n\r\n  public getPresentation(viewportId: string): SegmentationPresentation {\r\n    const segmentationPresentations: SegmentationPresentation = [];\r\n    const segmentationsMap = new Map<string, SegmentationPresentationItem>();\r\n\r\n    const representations = this.getSegmentationRepresentations(viewportId);\r\n    for (const representation of representations) {\r\n      const { segmentationId } = representation;\r\n\r\n      if (!representation) {\r\n        continue;\r\n      }\r\n\r\n      const { type } = representation;\r\n\r\n      segmentationsMap.set(segmentationId, {\r\n        segmentationId,\r\n        type,\r\n        hydrated: true,\r\n        config: representation.config || {},\r\n      });\r\n    }\r\n\r\n    // Check inside the removedDisplaySetAndRepresentationMaps to see if any of the representations are not hydrated\r\n    // const hydrationMap = this._segmentationRepresentationHydrationMaps.get(presentationId);\r\n\r\n    // if (hydrationMap) {\r\n    //   hydrationMap.forEach(rep => {\r\n    //     segmentationsMap.set(rep.segmentationId, {\r\n    //       segmentationId: rep.segmentationId,\r\n    //       type: rep.type,\r\n    //       hydrated: rep.hydrated,\r\n    //       config: rep.config || {},\r\n    //     });\r\n    //   });\r\n    // }\r\n\r\n    // // Convert the Map to an array\r\n    segmentationPresentations.push(...segmentationsMap.values());\r\n\r\n    return segmentationPresentations;\r\n  }\r\n\r\n  public getRepresentationsForSegmentation(\r\n    segmentationId: string\r\n  ): { viewportId: string; representations: any[] }[] {\r\n    const representations =\r\n      cstSegmentation.state.getSegmentationRepresentationsBySegmentationId(segmentationId);\r\n\r\n    return representations;\r\n  }\r\n\r\n  /**\r\n   * Retrieves segmentation representations (labelmap, contour, surface) based on specified criteria.\r\n   *\r\n   * @param viewportId - The ID of the viewport.\r\n   * @param specifier - An object containing optional `segmentationId` and `type` to filter the representations.\r\n   * @returns An array of `SegmentationRepresentation` matching the criteria, or an empty array if none are found.\r\n   *\r\n   * @remarks\r\n   * This method filters the segmentation representations according to the provided `specifier`:\r\n   * - **No `segmentationId` or `type` provided**: Returns all representations associated with the given `viewportId`.\r\n   * - **Only `segmentationId` provided**: Returns all representations with that `segmentationId`, regardless of `viewportId`.\r\n   * - **Only `type` provided**: Returns all representations of that `type` associated with the given `viewportId`.\r\n   * - **Both `segmentationId` and `type` provided**: Returns representations matching both criteria, regardless of `viewportId`.\r\n   */\r\n  public getSegmentationRepresentations(\r\n    viewportId: string,\r\n    specifier: {\r\n      segmentationId?: string;\r\n      type?: SegmentationRepresentations;\r\n    } = {}\r\n  ): SegmentationRepresentation[] {\r\n    // Get all representations for the viewportId\r\n    const representations = cstSegmentation.state.getSegmentationRepresentations(\r\n      viewportId,\r\n      specifier\r\n    );\r\n\r\n    // Map to our SegmentationRepresentation type\r\n    const ohifRepresentations = representations.map(repr =>\r\n      this._toOHIFSegmentationRepresentation(viewportId, repr)\r\n    );\r\n\r\n    return ohifRepresentations;\r\n  }\r\n\r\n  public destroy = () => {\r\n    eventTarget.removeEventListener(\r\n      csToolsEnums.Events.SEGMENTATION_MODIFIED,\r\n      this._onSegmentationModifiedFromSource\r\n    );\r\n\r\n    eventTarget.removeEventListener(\r\n      csToolsEnums.Events.SEGMENTATION_REMOVED,\r\n      this._onSegmentationModifiedFromSource\r\n    );\r\n\r\n    eventTarget.removeEventListener(\r\n      csToolsEnums.Events.SEGMENTATION_DATA_MODIFIED,\r\n      this._onSegmentationDataModifiedFromSource\r\n    );\r\n\r\n    eventTarget.removeEventListener(\r\n      csToolsEnums.Events.SEGMENTATION_REPRESENTATION_ADDED,\r\n      this._onSegmentationModifiedFromSource\r\n    );\r\n\r\n    eventTarget.removeEventListener(\r\n      csToolsEnums.Events.SEGMENTATION_ADDED,\r\n      this._onSegmentationAddedFromSource\r\n    );\r\n\r\n    this.reset();\r\n  };\r\n\r\n  public async addSegmentationRepresentation(\r\n    viewportId: string,\r\n    {\r\n      segmentationId,\r\n      type,\r\n      config,\r\n      suppressEvents = false,\r\n    }: {\r\n      segmentationId: string;\r\n      type?: csToolsEnums.SegmentationRepresentations;\r\n      config?: {\r\n        blendMode?: csEnums.BlendModes;\r\n      };\r\n      suppressEvents?: boolean;\r\n    }\r\n  ): Promise<void> {\r\n    const segmentation = this.getSegmentation(segmentationId);\r\n    const csViewport = this.getAndValidateViewport(viewportId);\r\n\r\n    if (!csViewport) {\r\n      return;\r\n    }\r\n\r\n    const colorLUTIndex = this._segmentationIdToColorLUTIndexMap.get(segmentationId);\r\n\r\n    const defaultRepresentationType = csToolsEnums.SegmentationRepresentations.Labelmap;\r\n    let representationTypeToUse = type || defaultRepresentationType;\r\n    let isConverted = false;\r\n\r\n    if (type === csToolsEnums.SegmentationRepresentations.Labelmap) {\r\n      const { isVolumeViewport, isVolumeSegmentation } = this.determineViewportAndSegmentationType(\r\n        csViewport,\r\n        segmentation\r\n      ) || { isVolumeViewport: false, isVolumeSegmentation: false };\r\n\r\n      ({ representationTypeToUse, isConverted } = await this.handleViewportConversion(\r\n        isVolumeViewport,\r\n        isVolumeSegmentation,\r\n        csViewport,\r\n        segmentation,\r\n        viewportId,\r\n        segmentationId,\r\n        representationTypeToUse\r\n      ));\r\n    }\r\n\r\n    await this._addSegmentationRepresentation(\r\n      viewportId,\r\n      segmentationId,\r\n      representationTypeToUse,\r\n      colorLUTIndex,\r\n      isConverted,\r\n      config\r\n    );\r\n\r\n    if (!suppressEvents) {\r\n      this._broadcastEvent(this.EVENTS.SEGMENTATION_REPRESENTATION_MODIFIED, { segmentationId });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates an labelmap segmentation for a given display set\r\n   *\r\n   * @param displaySet - The display set to create the segmentation for.\r\n   * @param options - Optional parameters for creating the segmentation.\r\n   * @param options.segmentationId - Custom segmentation ID. If not provided, a UUID will be generated.\r\n   * @param options.FrameOfReferenceUID - Frame of reference UID for the segmentation.\r\n   * @param options.label - Label for the segmentation.\r\n   * @returns A promise that resolves to the created segmentation ID.\r\n   */\r\n  public async createLabelmapForDisplaySet(\r\n    displaySet: AppTypes.DisplaySet,\r\n    options?: {\r\n      segmentationId?: string;\r\n      segments?: { [segmentIndex: number]: Partial<cstTypes.Segment> };\r\n      FrameOfReferenceUID?: string;\r\n      label?: string;\r\n    }\r\n  ): Promise<string> {\r\n    // Todo: random does not makes sense, make this better, like\r\n    // labelmap 1, 2, 3 etc\r\n    const segmentationId = options?.segmentationId ?? `${csUtils.uuidv4()}`;\r\n\r\n    const isDynamicVolume = displaySet.isDynamicVolume;\r\n\r\n    let referenceImageIds = displaySet.imageIds;\r\n    if (isDynamicVolume) {\r\n      // get the middle timepoint for referenceImageIds\r\n      const timePoints = displaySet.dynamicVolumeInfo.timePoints;\r\n      const middleTimePoint = timePoints[Math.floor(timePoints.length / 2)];\r\n      referenceImageIds = middleTimePoint;\r\n    }\r\n\r\n    const derivedImages = await imageLoader.createAndCacheDerivedLabelmapImages(referenceImageIds);\r\n\r\n    const segs = this.getSegmentations();\r\n    const label = options.label || `Segmentation ${segs.length + 1}`;\r\n\r\n    const segImageIds = derivedImages.map(image => image.imageId);\r\n\r\n    const segmentationPublicInput: cstTypes.SegmentationPublicInput = {\r\n      segmentationId,\r\n      representation: {\r\n        type: LABELMAP,\r\n        data: {\r\n          imageIds: segImageIds,\r\n          // referencedVolumeId: this._getVolumeIdForDisplaySet(displaySet),\r\n          referencedImageIds: referenceImageIds,\r\n        },\r\n      },\r\n      config: {\r\n        label,\r\n        segments:\r\n          options.segments && Object.keys(options.segments).length > 0\r\n            ? options.segments\r\n            : {\r\n                1: {\r\n                  label: `${i18n.t('Segment')} 1`,\r\n                  active: true,\r\n                },\r\n              },\r\n        cachedStats: {\r\n          info: `S${displaySet.SeriesNumber}: ${displaySet.SeriesDescription}`,\r\n        },\r\n      },\r\n    };\r\n\r\n    this.addOrUpdateSegmentation(segmentationPublicInput);\r\n    return segmentationId;\r\n  }\r\n\r\n  public async createSegmentationForSEGDisplaySet(\r\n    segDisplaySet,\r\n    options: {\r\n      segmentationId?: string;\r\n      type: SegmentationRepresentations;\r\n    } = {\r\n      type: LABELMAP,\r\n    }\r\n  ): Promise<string> {\r\n    const { type } = options;\r\n    let { segmentationId } = options;\r\n    const { labelMapImages } = segDisplaySet;\r\n\r\n    if (type !== LABELMAP) {\r\n      throw new Error('Only labelmap type is supported for SEG display sets right now');\r\n    }\r\n\r\n    if (!labelMapImages || !labelMapImages.length) {\r\n      throw new Error('SEG reading failed');\r\n    }\r\n\r\n    segmentationId = segmentationId ?? segDisplaySet.displaySetInstanceUID;\r\n    const referencedDisplaySetInstanceUID = segDisplaySet.referencedDisplaySetInstanceUID;\r\n    const referencedDisplaySet = this.servicesManager.services.displaySetService.getDisplaySetByUID(\r\n      referencedDisplaySetInstanceUID\r\n    );\r\n\r\n    const images = referencedDisplaySet.instances;\r\n\r\n    if (!images.length) {\r\n      throw new Error('No instances were provided for the referenced display set of the SEG');\r\n    }\r\n\r\n    const imageIds = images.map(image => image.imageId);\r\n    const derivedImages = labelMapImages?.flat();\r\n    const derivedImageIds = derivedImages.map(image => image.imageId);\r\n\r\n    segDisplaySet.images = derivedImages.map(image => ({\r\n      ...image,\r\n      ...metaData.get('instance', image.referencedImageId),\r\n    }));\r\n\r\n    segDisplaySet.imageIds = derivedImageIds;\r\n\r\n    // We should parse the segmentation as separate slices to support overlapping segments.\r\n    // This parsing should occur in the CornerstoneJS library adapters.\r\n    // For now, we use the volume returned from the library and chop it here.\r\n    let firstSegmentedSliceImageId = null;\r\n    for (let i = 0; i < derivedImages.length; i++) {\r\n      const voxelManager = derivedImages[i].voxelManager as csTypes.IVoxelManager<number>;\r\n      const scalarData = voxelManager.getScalarData();\r\n      voxelManager.setScalarData(scalarData);\r\n\r\n      // Check if this slice has any non-zero voxels and we haven't found one yet\r\n      if (!firstSegmentedSliceImageId && scalarData.some(value => value !== 0)) {\r\n        firstSegmentedSliceImageId = derivedImages[i].referencedImageId;\r\n      }\r\n    }\r\n\r\n    // assign the first non zero voxel image id to the segDisplaySet\r\n    segDisplaySet.firstSegmentedSliceImageId = firstSegmentedSliceImageId;\r\n\r\n    const segmentsInfo = segDisplaySet.segMetadata.data;\r\n\r\n    const segments: { [segmentIndex: string]: cstTypes.Segment } = {};\r\n    const colorLUT = [];\r\n\r\n    segmentsInfo.forEach((segmentInfo, index) => {\r\n      if (index === 0) {\r\n        colorLUT.push([0, 0, 0, 0]);\r\n        return;\r\n      }\r\n\r\n      const {\r\n        SegmentedPropertyCategoryCodeSequence,\r\n        SegmentNumber,\r\n        SegmentLabel,\r\n        SegmentAlgorithmType,\r\n        SegmentAlgorithmName,\r\n        SegmentedPropertyTypeCodeSequence,\r\n        rgba,\r\n      } = segmentInfo;\r\n\r\n      colorLUT.push(rgba);\r\n\r\n      const segmentIndex = Number(SegmentNumber);\r\n\r\n      const centroid = segDisplaySet.centroids?.get(index);\r\n      const imageCentroidXYZ = centroid?.image || { x: 0, y: 0, z: 0 };\r\n      const worldCentroidXYZ = centroid?.world || { x: 0, y: 0, z: 0 };\r\n\r\n      segments[segmentIndex] = {\r\n        segmentIndex,\r\n        label: SegmentLabel || `Segment ${SegmentNumber}`,\r\n        locked: false,\r\n        active: false,\r\n        cachedStats: {\r\n          center: {\r\n            image: [imageCentroidXYZ.x, imageCentroidXYZ.y, imageCentroidXYZ.z],\r\n            world: [worldCentroidXYZ.x, worldCentroidXYZ.y, worldCentroidXYZ.z],\r\n          },\r\n          modifiedTime: segDisplaySet.SeriesDate,\r\n          category: SegmentedPropertyCategoryCodeSequence\r\n            ? SegmentedPropertyCategoryCodeSequence.CodeMeaning\r\n            : '',\r\n          type: SegmentedPropertyTypeCodeSequence\r\n            ? SegmentedPropertyTypeCodeSequence.CodeMeaning\r\n            : '',\r\n          algorithmType: SegmentAlgorithmType,\r\n          algorithmName: SegmentAlgorithmName,\r\n        },\r\n      };\r\n    });\r\n\r\n    // get next color lut index\r\n    const colorLUTIndex = getNextColorLUTIndex();\r\n    addColorLUT(colorLUT, colorLUTIndex);\r\n    this._segmentationIdToColorLUTIndexMap.set(segmentationId, colorLUTIndex);\r\n\r\n    this._broadcastEvent(EVENTS.SEGMENTATION_LOADING_COMPLETE, {\r\n      segmentationId,\r\n      segDisplaySet,\r\n    });\r\n\r\n    const seg: cstTypes.SegmentationPublicInput = {\r\n      segmentationId,\r\n      representation: {\r\n        type: LABELMAP,\r\n        data: {\r\n          imageIds: derivedImageIds,\r\n          // referencedVolumeId: this._getVolumeIdForDisplaySet(referencedDisplaySet),\r\n          referencedImageIds: imageIds as string[],\r\n        },\r\n      },\r\n      config: {\r\n        label: segDisplaySet.SeriesDescription,\r\n        segments,\r\n      },\r\n    };\r\n\r\n    segDisplaySet.isLoaded = true;\r\n\r\n    this.addOrUpdateSegmentation(seg);\r\n\r\n    return segmentationId;\r\n  }\r\n\r\n  public async createSegmentationForRTDisplaySet(\r\n    rtDisplaySet,\r\n    options: {\r\n      segmentationId?: string;\r\n      type: SegmentationRepresentations;\r\n    } = {\r\n      type: CONTOUR,\r\n    }\r\n  ): Promise<string> {\r\n    const { type } = options;\r\n    let { segmentationId } = options;\r\n\r\n    // Currently, only contour representation is supported for RT display\r\n    if (type !== CONTOUR) {\r\n      throw new Error('Only contour type is supported for RT display sets right now');\r\n    }\r\n\r\n    // Assign segmentationId if not provided\r\n    segmentationId = segmentationId ?? rtDisplaySet.displaySetInstanceUID;\r\n    const { structureSet } = rtDisplaySet;\r\n\r\n    if (!structureSet) {\r\n      throw new Error(\r\n        'To create the contours from RT displaySet, the displaySet should be loaded first. You can perform rtDisplaySet.load() before calling this method.'\r\n      );\r\n    }\r\n\r\n    const rtDisplaySetUID = rtDisplaySet.displaySetInstanceUID;\r\n    const referencedDisplaySet = this.servicesManager.services.displaySetService.getDisplaySetByUID(\r\n      rtDisplaySet.referencedDisplaySetInstanceUID\r\n    );\r\n\r\n    const referencedImageIdsWithGeometry = Array.from(structureSet.ReferencedSOPInstanceUIDsSet);\r\n\r\n    const referencedImageIds = referencedDisplaySet.imageIds;\r\n    // find the first image id that contains a referenced SOP instance UID\r\n    const firstSegmentedSliceImageId =\r\n      referencedImageIds?.find(imageId =>\r\n        referencedImageIdsWithGeometry.some(referencedId => imageId.includes(referencedId))\r\n      ) || null;\r\n\r\n    rtDisplaySet.firstSegmentedSliceImageId = firstSegmentedSliceImageId;\r\n    // Map ROI contours to RT Struct Data\r\n    const allRTStructData = mapROIContoursToRTStructData(structureSet, rtDisplaySetUID);\r\n\r\n    // Sort by segmentIndex for consistency\r\n    allRTStructData.sort((a, b) => a.segmentIndex - b.segmentIndex);\r\n\r\n    const geometryIds = allRTStructData.map(({ geometryId }) => geometryId);\r\n\r\n    // Initialize SegmentationPublicInput similar to SEG function\r\n    const segmentation: cstTypes.SegmentationPublicInput = {\r\n      segmentationId,\r\n      representation: {\r\n        type: CONTOUR,\r\n        data: {\r\n          geometryIds,\r\n        },\r\n      },\r\n      config: {\r\n        label: rtDisplaySet.SeriesDescription,\r\n      },\r\n    };\r\n\r\n    if (!structureSet.ROIContours?.length) {\r\n      throw new Error(\r\n        'The structureSet does not contain any ROIContours. Please ensure the structureSet is loaded first.'\r\n      );\r\n    }\r\n\r\n    const segments: { [segmentIndex: string]: cstTypes.Segment } = {};\r\n    let segmentsCachedStats = {};\r\n\r\n    // Create colorLUT array for RT structures\r\n    const colorLUT = [[0, 0, 0, 0]]; // First entry is transparent for index 0\r\n\r\n    // Process each segment similarly to the SEG function\r\n    for (const rtStructData of allRTStructData) {\r\n      const { data, id, color, segmentIndex, geometryId, group } = rtStructData;\r\n\r\n      // Add the color to the colorLUT array\r\n      colorLUT.push(color);\r\n\r\n      try {\r\n        const geometry = await geometryLoader.createAndCacheGeometry(geometryId, {\r\n          geometryData: {\r\n            data,\r\n            id,\r\n            color,\r\n            frameOfReferenceUID: structureSet.frameOfReferenceUID,\r\n            segmentIndex,\r\n          },\r\n          type: csEnums.GeometryType.CONTOUR,\r\n        });\r\n\r\n        const contourSet = geometry.data as csTypes.IContourSet;\r\n        const centroid = contourSet.centroid;\r\n\r\n        segmentsCachedStats = {\r\n          center: { world: centroid },\r\n          modifiedTime: rtDisplaySet.SeriesDate, // Using SeriesDate as modifiedTime\r\n        };\r\n\r\n        segments[segmentIndex] = {\r\n          label: id,\r\n          segmentIndex,\r\n          cachedStats: segmentsCachedStats,\r\n          locked: false,\r\n          active: false,\r\n          group,\r\n        };\r\n\r\n        // Broadcast segment loading progress\r\n        const numInitialized = Object.keys(segmentsCachedStats).length;\r\n        const percentComplete = Math.round((numInitialized / allRTStructData.length) * 100);\r\n        this._broadcastEvent(EVENTS.SEGMENT_LOADING_COMPLETE, {\r\n          percentComplete,\r\n          numSegments: allRTStructData.length,\r\n        });\r\n      } catch (e) {\r\n        console.warn(`Error initializing contour for segment ${segmentIndex}:`, e);\r\n        continue; // Continue processing other segments even if one fails\r\n      }\r\n    }\r\n\r\n    // Create and register the colorLUT\r\n    const colorLUTIndex = getNextColorLUTIndex();\r\n    addColorLUT(colorLUT, colorLUTIndex);\r\n    this._segmentationIdToColorLUTIndexMap.set(segmentationId, colorLUTIndex);\r\n\r\n    // Assign processed segments to segmentation config\r\n    segmentation.config.segments = segments;\r\n\r\n    // Broadcast segmentation loading complete event\r\n    this._broadcastEvent(EVENTS.SEGMENTATION_LOADING_COMPLETE, {\r\n      segmentationId,\r\n      rtDisplaySet,\r\n    });\r\n\r\n    // Mark the RT display set as loaded\r\n    rtDisplaySet.isLoaded = true;\r\n    // Add or update the segmentation in the state\r\n    this.addOrUpdateSegmentation(segmentation);\r\n\r\n    return segmentationId;\r\n  }\r\n\r\n  /**\r\n   * Adds or updates a segmentation in the state\r\n   * @param segmentationId - The ID of the segmentation to add or update\r\n   * @param data - The data to add or update the segmentation with\r\n   *\r\n   * @remarks\r\n   * This method handles the addition or update of a segmentation in the state.\r\n   * If the segmentation already exists, it updates the existing segmentation.\r\n   * If the segmentation does not exist, it adds a new segmentation.\r\n   */\r\n  public addOrUpdateSegmentation(\r\n    data: cstTypes.SegmentationPublicInput | Partial<cstTypes.Segmentation>\r\n  ) {\r\n    const segmentationId = data.segmentationId;\r\n    const existingSegmentation = cstSegmentation.state.getSegmentation(segmentationId);\r\n\r\n    if (existingSegmentation) {\r\n      // Update the existing segmentation\r\n      this.updateSegmentationInSource(segmentationId, data as Partial<cstTypes.Segmentation>);\r\n    } else {\r\n      // Add a new segmentation\r\n      this.addSegmentationToSource(data as cstTypes.SegmentationPublicInput);\r\n    }\r\n  }\r\n\r\n  public setActiveSegmentation(viewportId: string, segmentationId: string): void {\r\n    cstSegmentation.activeSegmentation.setActiveSegmentation(viewportId, segmentationId);\r\n  }\r\n\r\n  /**\r\n   * Gets the active segmentation for a viewport\r\n   * @param viewportId - The ID of the viewport to get the active segmentation for\r\n   * @returns The active segmentation object, or null if no segmentation is active\r\n   *\r\n   * @remarks\r\n   * This method retrieves the currently active segmentation for the specified viewport.\r\n   * The active segmentation is the one that is currently selected for editing operations.\r\n   * Returns null if no segmentation is active in the viewport.\r\n   */\r\n  public getActiveSegmentation(viewportId: string): cstTypes.Segmentation | null {\r\n    return cstSegmentation.activeSegmentation.getActiveSegmentation(viewportId);\r\n  }\r\n\r\n  /**\r\n   * Gets the active segment from the active segmentation in a viewport\r\n   * @param viewportId - The ID of the viewport to get the active segment from\r\n   * @returns The active segment object, or undefined if no segment is active\r\n   *\r\n   * @remarks\r\n   * This method retrieves the currently active segment from the active segmentation\r\n   * in the specified viewport. The active segment is the one that is currently\r\n   * selected for editing operations. Returns undefined if no segment is active or\r\n   * if there is no active segmentation.\r\n   */\r\n  public getActiveSegment(viewportId: string): cstTypes.Segment | undefined {\r\n    const activeSegmentation = this.getActiveSegmentation(viewportId);\r\n\r\n    if (!activeSegmentation) {\r\n      return;\r\n    }\r\n\r\n    const { segments } = activeSegmentation;\r\n\r\n    let activeSegment;\r\n    for (const segment of Object.values(segments)) {\r\n      if (segment.active) {\r\n        activeSegment = segment;\r\n        break;\r\n      }\r\n    }\r\n\r\n    return activeSegment;\r\n  }\r\n\r\n  public hasCustomStyles(specifier: {\r\n    viewportId: string;\r\n    segmentationId: string;\r\n    type: SegmentationRepresentations;\r\n  }): boolean {\r\n    return cstSegmentation.config.style.hasCustomStyle(specifier);\r\n  }\r\n\r\n  public getStyle = (specifier: {\r\n    viewportId: string;\r\n    segmentationId: string;\r\n    type: SegmentationRepresentations;\r\n    segmentIndex?: number;\r\n  }) => {\r\n    const style = cstSegmentation.config.style.getStyle(specifier);\r\n\r\n    return style;\r\n  };\r\n\r\n  public setStyle = (\r\n    specifier: {\r\n      type: SegmentationRepresentations;\r\n      viewportId?: string;\r\n      segmentationId?: string;\r\n      segmentIndex?: number;\r\n    },\r\n    style: LabelmapStyle | ContourStyle | SurfaceStyle\r\n  ) => {\r\n    cstSegmentation.config.style.setStyle(specifier, style);\r\n  };\r\n\r\n  public resetToGlobalStyle = () => {\r\n    cstSegmentation.config.style.resetToGlobalStyle();\r\n  };\r\n\r\n  /**\r\n   * Adds a new segment to the specified segmentation.\r\n   * @param segmentationId - The ID of the segmentation to add the segment to.\r\n   * @param viewportId: The ID of the viewport to add the segment to, it is used to get the representation, if it is not\r\n   * provided, the first available representation for the segmentationId will be used.\r\n   * @param config - An object containing the configuration options for the new segment.\r\n   *   - segmentIndex: (optional) The index of the segment to add. If not provided, the next available index will be used.\r\n   *   - properties: (optional) An object containing the properties of the new segment.\r\n   *     - label: (optional) The label of the new segment. If not provided, a default label will be used.\r\n   *     - color: (optional) The color of the new segment in RGB format. If not provided, a default color will be used.\r\n   *     - visibility: (optional) Whether the new segment should be visible. If not provided, the segment will be visible by default.\r\n   *     - isLocked: (optional) Whether the new segment should be locked for editing. If not provided, the segment will not be locked by default.\r\n   *     - active: (optional) Whether the new segment should be the active segment to be edited. If not provided, the segment will not be active by default.\r\n   */\r\n  public addSegment(\r\n    segmentationId: string,\r\n    config: {\r\n      segmentIndex?: number;\r\n      label?: string;\r\n      isLocked?: boolean;\r\n      active?: boolean;\r\n      color?: csTypes.Color; // Add color type\r\n      visibility?: boolean; // Add visibility option\r\n    } = {}\r\n  ): void {\r\n    if (config?.segmentIndex === 0) {\r\n      throw new Error(i18n.t('Segment') + ' index 0 is reserved for \"no label\"');\r\n    }\r\n\r\n    const csSegmentation = this.getCornerstoneSegmentation(segmentationId);\r\n\r\n    let segmentIndex = config.segmentIndex;\r\n    if (!segmentIndex) {\r\n      // grab the next available segment index based on the object keys,\r\n      // so basically get the highest segment index value + 1\r\n      const segmentKeys = Object.keys(csSegmentation.segments);\r\n      segmentIndex = segmentKeys.length === 0 ? 1 : Math.max(...segmentKeys.map(Number)) + 1;\r\n    }\r\n\r\n    // update the segmentation\r\n    if (!config.label) {\r\n      config.label = `${i18n.t('Segment')} ${segmentIndex}`;\r\n    }\r\n\r\n    const currentSegments = csSegmentation.segments;\r\n\r\n    cstSegmentation.updateSegmentations([\r\n      {\r\n        segmentationId,\r\n        payload: {\r\n          segments: {\r\n            ...currentSegments,\r\n            [segmentIndex]: {\r\n              ...currentSegments[segmentIndex],\r\n              segmentIndex,\r\n              cachedStats: {},\r\n              locked: false,\r\n              ...config,\r\n            },\r\n          },\r\n        },\r\n      },\r\n    ]);\r\n\r\n    this.setActiveSegment(segmentationId, segmentIndex);\r\n\r\n    // Apply additional configurations\r\n    if (config.isLocked !== undefined) {\r\n      this._setSegmentLockedStatus(segmentationId, segmentIndex, config.isLocked);\r\n    }\r\n\r\n    // Get all viewports that have this segmentation\r\n    const viewportIds = this.getViewportIdsWithSegmentation(segmentationId);\r\n\r\n    viewportIds.forEach(viewportId => {\r\n      // Set color if provided\r\n      if (config.color !== undefined) {\r\n        this.setSegmentColor(viewportId, segmentationId, segmentIndex, config.color);\r\n      }\r\n\r\n      // Set visibility if provided\r\n      if (config.visibility !== undefined) {\r\n        this.setSegmentVisibility(viewportId, segmentationId, segmentIndex, config.visibility);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Removes a segment from a segmentation and updates the active segment index if necessary.\r\n   *\r\n   * @param segmentationId - The ID of the segmentation containing the segment to remove.\r\n   * @param segmentIndex - The index of the segment to remove.\r\n   *\r\n   * @remarks\r\n   * This method performs the following actions:\r\n   * 1. Clears the segment value in the Cornerstone segmentation.\r\n   * 2. Updates all related segmentation representations to remove the segment.\r\n   * 3. If the removed segment was the active segment, it updates the active segment index.\r\n   *\r\n   */\r\n  public removeSegment(segmentationId: string, segmentIndex: number): void {\r\n    cstSegmentation.removeSegment(segmentationId, segmentIndex);\r\n  }\r\n\r\n  public setSegmentVisibility(\r\n    viewportId: string,\r\n    segmentationId: string,\r\n    segmentIndex: number,\r\n    isVisible: boolean,\r\n    type?: SegmentationRepresentations\r\n  ): void {\r\n    this._setSegmentVisibility(viewportId, segmentationId, segmentIndex, isVisible, type);\r\n  }\r\n\r\n  /**\r\n   * Sets the locked status of a segment in a segmentation.\r\n   *\r\n   * @param segmentationId - The ID of the segmentation containing the segment.\r\n   * @param segmentIndex - The index of the segment to set the locked status for.\r\n   * @param isLocked - The new locked status of the segment.\r\n   *\r\n   * @remarks\r\n   * This method updates the locked status of a specific segment within a segmentation.\r\n   * A locked segment cannot be modified or edited.\r\n   */\r\n  public setSegmentLocked(segmentationId: string, segmentIndex: number, isLocked: boolean): void {\r\n    this._setSegmentLockedStatus(segmentationId, segmentIndex, isLocked);\r\n  }\r\n\r\n  /**\r\n   * Toggles the locked state of a segment in a segmentation.\r\n   * @param segmentationId - The ID of the segmentation.\r\n   * @param segmentIndex - The index of the segment to toggle.\r\n   */\r\n  public toggleSegmentLocked(segmentationId: string, segmentIndex: number): void {\r\n    const isLocked = cstSegmentation.segmentLocking.isSegmentIndexLocked(\r\n      segmentationId,\r\n      segmentIndex\r\n    );\r\n    this._setSegmentLockedStatus(segmentationId, segmentIndex, !isLocked);\r\n  }\r\n\r\n  public toggleSegmentVisibility(\r\n    viewportId: string,\r\n    segmentationId: string,\r\n    segmentIndex: number,\r\n    type: SegmentationRepresentations\r\n  ): void {\r\n    const isVisible = cstSegmentation.config.visibility.getSegmentIndexVisibility(\r\n      viewportId,\r\n      {\r\n        segmentationId,\r\n        type,\r\n      },\r\n      segmentIndex\r\n    );\r\n    this._setSegmentVisibility(viewportId, segmentationId, segmentIndex, !isVisible, type);\r\n  }\r\n\r\n  /**\r\n   * Sets the color of a specific segment in a segmentation.\r\n   *\r\n   * @param viewportId - The ID of the viewport containing the segmentation\r\n   * @param segmentationId - The ID of the segmentation containing the segment\r\n   * @param segmentIndex - The index of the segment to set the color for\r\n   * @param color - The new color to apply to the segment as an array of RGBA values\r\n   *\r\n   * @remarks\r\n   * This method updates the color of a specific segment within a segmentation.\r\n   * The color parameter should be an array of 4 numbers representing RGBA values.\r\n   */\r\n  public setSegmentColor(\r\n    viewportId: string,\r\n    segmentationId: string,\r\n    segmentIndex: number,\r\n    color: csTypes.Color\r\n  ): void {\r\n    cstSegmentation.config.color.setSegmentIndexColor(\r\n      viewportId,\r\n      segmentationId,\r\n      segmentIndex,\r\n      color\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Gets the current color of a specific segment in a segmentation.\r\n   *\r\n   * @param viewportId - The ID of the viewport containing the segmentation\r\n   * @param segmentationId - The ID of the segmentation containing the segment\r\n   * @param segmentIndex - The index of the segment to get the color for\r\n   * @returns An array of 4 numbers representing the RGBA color values of the segment\r\n   *\r\n   * @remarks\r\n   * This method retrieves the current color of a specific segment within a segmentation.\r\n   * The returned color is an array of 4 numbers representing RGBA values.\r\n   */\r\n  public getSegmentColor(viewportId: string, segmentationId: string, segmentIndex: number) {\r\n    return cstSegmentation.config.color.getSegmentIndexColor(\r\n      viewportId,\r\n      segmentationId,\r\n      segmentIndex\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Gets the labelmap volume for a segmentation\r\n   * @param segmentationId - The ID of the segmentation to get the labelmap volume for\r\n   * @returns The labelmap volume for the segmentation, or null if not found\r\n   *\r\n   * @remarks\r\n   * This method retrieves the labelmap volume data for a specific segmentation.\r\n   * The labelmap volume contains the actual segmentation data in the form of a 3D volume.\r\n   * Returns null if the segmentation does not have valid labelmap volume data.\r\n   */\r\n  public getLabelmapVolume(segmentationId: string) {\r\n    const csSegmentation = cstSegmentation.state.getSegmentation(segmentationId);\r\n    const labelmapData = csSegmentation.representationData[\r\n      SegmentationRepresentations.Labelmap\r\n    ] as cstTypes.LabelmapToolOperationDataVolume;\r\n\r\n    if (!labelmapData || !labelmapData.volumeId) {\r\n      return null;\r\n    }\r\n\r\n    const { volumeId } = labelmapData;\r\n    const labelmapVolume = cache.getVolume(volumeId);\r\n\r\n    return labelmapVolume;\r\n  }\r\n\r\n  /**\r\n   * Sets the label for a specific segment in a segmentation\r\n   * @param segmentationId - The ID of the segmentation containing the segment\r\n   * @param segmentIndex - The index of the segment to set the label for\r\n   * @param label - The new label to apply to the segment\r\n   *\r\n   * @remarks\r\n   * This method updates the text label of a specific segment within a segmentation.\r\n   * The label is used to identify and describe the segment in the UI.\r\n   */\r\n  public setSegmentLabel(segmentationId: string, segmentIndex: number, label: string) {\r\n    this._setSegmentLabel(segmentationId, segmentIndex, label);\r\n  }\r\n\r\n  /**\r\n   * Sets the active segment for a segmentation\r\n   * @param segmentationId - The ID of the segmentation containing the segment\r\n   * @param segmentIndex - The index of the segment to set as active\r\n   *\r\n   * @remarks\r\n   * This method updates which segment is considered \"active\" within a segmentation.\r\n   * The active segment is typically highlighted and available for editing operations.\r\n   */\r\n  public setActiveSegment(segmentationId: string, segmentIndex: number): void {\r\n    this._setActiveSegment(segmentationId, segmentIndex);\r\n  }\r\n\r\n  /**\r\n   * Controls whether inactive segmentations should be rendered in a viewport\r\n   * @param viewportId - The ID of the viewport to update\r\n   * @param renderInactive - Whether inactive segmentations should be rendered\r\n   *\r\n   * @remarks\r\n   * This method configures if segmentations that are not currently active\r\n   * should still be visible in the specified viewport. This can be useful\r\n   * for comparing or viewing multiple segmentations simultaneously.\r\n   */\r\n  public setRenderInactiveSegmentations(viewportId: string, renderInactive: boolean): void {\r\n    cstSegmentation.config.style.setRenderInactiveSegmentations(viewportId, renderInactive);\r\n  }\r\n\r\n  /**\r\n   * Gets whether inactive segmentations are being rendered for a viewport\r\n   * @param viewportId - The ID of the viewport to check\r\n   * @returns boolean indicating if inactive segmentations are rendered\r\n   *\r\n   * @remarks\r\n   * This method retrieves the current rendering state for inactive segmentations\r\n   * in the specified viewport. Returns true if inactive segmentations are visible.\r\n   */\r\n  public getRenderInactiveSegmentations(viewportId: string): boolean {\r\n    return cstSegmentation.config.style.getRenderInactiveSegmentations(viewportId);\r\n  }\r\n  /**\r\n   * Sets statistics for a group of segmentations\r\n   * @param segmentationIds - Array of segmentation IDs that form the group\r\n   * @param stats - Statistics object containing metrics for the segmentation group\r\n   *\r\n   * @remarks\r\n   * This method stores statistical data for a group of related segmentations.\r\n   * The stats are stored using a composite key created from the sorted and joined\r\n   */\r\n  public setSegmentationGroupStats(segmentationIds: string[], stats: any) {\r\n    const groupId = this.getGroupId(segmentationIds);\r\n    this._segmentationGroupStatsMap.set(groupId, stats);\r\n  }\r\n\r\n  /**\r\n   * Gets statistics for a group of segmentations\r\n   * @param segmentationIds - Array of segmentation IDs that form the group\r\n   * @returns The stored statistics object for the segmentation group if found, undefined otherwise\r\n   */\r\n  public getSegmentationGroupStats(segmentationIds: string[]) {\r\n    const groupId = this.getGroupId(segmentationIds);\r\n    return this._segmentationGroupStatsMap.get(groupId);\r\n  }\r\n\r\n  private getGroupId(segmentationIds: string[]) {\r\n    return segmentationIds.sort().join(',');\r\n  }\r\n\r\n  /**\r\n   * Toggles the visibility of a segmentation in the state, and broadcasts the event.\r\n   * Note: this method does not update the segmentation state in the source. It only\r\n   * updates the state, and there should be separate listeners for that.\r\n   * @param ids segmentation ids\r\n   */\r\n  public toggleSegmentationRepresentationVisibility = (\r\n    viewportId: string,\r\n    { segmentationId, type }: { segmentationId: string; type: SegmentationRepresentations }\r\n  ): void => {\r\n    this._toggleSegmentationRepresentationVisibility(viewportId, segmentationId, type);\r\n  };\r\n\r\n  public getViewportIdsWithSegmentation = (segmentationId: string): string[] => {\r\n    const viewportIds = cstSegmentation.state.getViewportIdsWithSegmentation(segmentationId);\r\n    return viewportIds;\r\n  };\r\n\r\n  /**\r\n   * Clears segmentation representations from the viewport.\r\n   * Unlike removeSegmentationRepresentations, this doesn't update\r\n   * removed display set and representation maps.\r\n   * We track removed segmentations manually to avoid re-adding them\r\n   * when the display set is added again.\r\n   * @param viewportId - The viewport ID to clear segmentation representations from.\r\n   */\r\n  public clearSegmentationRepresentations(viewportId: string): void {\r\n    this.removeSegmentationRepresentations(viewportId);\r\n  }\r\n\r\n  /**\r\n   * Completely removes a segmentation from the state\r\n   * @param segmentationId - The ID of the segmentation to remove.\r\n   */\r\n  public remove(segmentationId: string): void {\r\n    cstSegmentation.state.removeSegmentation(segmentationId);\r\n  }\r\n\r\n  public removeAllSegmentations(): void {\r\n    cstSegmentation.state.removeAllSegmentations();\r\n  }\r\n\r\n  /**\r\n   * It removes the segmentation representations from the viewport.\r\n   * @param viewportId - The viewport id to remove the segmentation representations from.\r\n   * @param specifier - The specifier to remove the segmentation representations.\r\n   *\r\n   * @remarks\r\n   * If no specifier is provided, all segmentation representations for the viewport are removed.\r\n   * If a segmentationId specifier is provided, only the segmentation representation with the specified segmentationId and type are removed.\r\n   * If a type specifier is provided, only the segmentation representation with the specified type are removed.\r\n   * If both a segmentationId and type specifier are provided, only the segmentation representation with the specified segmentationId and type are removed.\r\n   */\r\n  public removeSegmentationRepresentations(\r\n    viewportId: string,\r\n    specifier: {\r\n      segmentationId?: string;\r\n      type?: SegmentationRepresentations;\r\n    } = {}\r\n  ): void {\r\n    cstSegmentation.removeSegmentationRepresentations(viewportId, specifier);\r\n  }\r\n\r\n  public jumpToSegmentCenter(\r\n    segmentationId: string,\r\n    segmentIndex: number,\r\n    viewportId?: string,\r\n    highlightAlpha = 0.9,\r\n    highlightSegment = true,\r\n    animationLength = 750,\r\n    highlightHideOthers = false,\r\n    highlightFunctionType = 'ease-in-out' // todo: make animation functions configurable from outside\r\n  ): void {\r\n    const center = this._getSegmentCenter(segmentationId, segmentIndex);\r\n    if (!center) {\r\n      console.warn('No center found for segmentation', segmentationId, segmentIndex);\r\n      return;\r\n    }\r\n\r\n    const { world } = center as { world: csTypes.Point3 };\r\n\r\n    // need to find which viewports are displaying the segmentation\r\n    const viewportIds = viewportId\r\n      ? [viewportId]\r\n      : this.getViewportIdsWithSegmentation(segmentationId);\r\n\r\n    viewportIds.forEach(viewportId => {\r\n      const { viewport } = getEnabledElementByViewportId(viewportId);\r\n      viewport.jumpToWorld(world);\r\n\r\n      highlightSegment &&\r\n        this.highlightSegment(\r\n          segmentationId,\r\n          segmentIndex,\r\n          viewportId,\r\n          highlightAlpha,\r\n          animationLength,\r\n          highlightHideOthers\r\n        );\r\n    });\r\n  }\r\n\r\n  public highlightSegment(\r\n    segmentationId: string,\r\n    segmentIndex: number,\r\n    viewportId?: string,\r\n    alpha = 0.9,\r\n    animationLength = 750,\r\n    hideOthers = true,\r\n    highlightFunctionType = 'ease-in-out'\r\n  ): void {\r\n    if (this.highlightIntervalId) {\r\n      clearInterval(this.highlightIntervalId);\r\n    }\r\n\r\n    const csSegmentation = this.getCornerstoneSegmentation(segmentationId);\r\n\r\n    const viewportIds = viewportId\r\n      ? [viewportId]\r\n      : this.getViewportIdsWithSegmentation(segmentationId);\r\n\r\n    viewportIds.forEach(viewportId => {\r\n      const segmentationRepresentation = this.getSegmentationRepresentations(viewportId, {\r\n        segmentationId,\r\n      });\r\n\r\n      const representation = segmentationRepresentation[0];\r\n      const { type } = representation;\r\n      const segments = csSegmentation.segments;\r\n\r\n      const highlightFn =\r\n        type === LABELMAP ? this._highlightLabelmap.bind(this) : this._highlightContour.bind(this);\r\n\r\n      const adjustedAlpha = type === LABELMAP ? alpha : 1 - alpha;\r\n\r\n      highlightFn(\r\n        segmentIndex,\r\n        adjustedAlpha,\r\n        hideOthers,\r\n        segments,\r\n        viewportId,\r\n        animationLength,\r\n        representation\r\n      );\r\n    });\r\n  }\r\n\r\n  private getAndValidateViewport(viewportId: string) {\r\n    const csViewport =\r\n      this.servicesManager.services.cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n    if (!csViewport) {\r\n      console.warn(`Viewport with id ${viewportId} not found.`);\r\n      return null;\r\n    }\r\n    return csViewport;\r\n  }\r\n\r\n  /**\r\n   * Sets the visibility of a segmentation representation.\r\n   *\r\n   * @param viewportId - The ID of the viewport.\r\n   * @param segmentationId - The ID of the segmentation.\r\n   * @param isVisible - The new visibility state.\r\n   */\r\n  private _setSegmentationRepresentationVisibility(\r\n    viewportId: string,\r\n    segmentationId: string,\r\n    type: SegmentationRepresentations,\r\n    isVisible: boolean\r\n  ): void {\r\n    const representations = this.getSegmentationRepresentations(viewportId, {\r\n      segmentationId,\r\n      type,\r\n    });\r\n    const representation = representations[0];\r\n\r\n    if (!representation) {\r\n      console.debug(\r\n        'No segmentation representation found for the given viewportId and segmentationId'\r\n      );\r\n      return;\r\n    }\r\n\r\n    cstSegmentation.config.visibility.setSegmentationRepresentationVisibility(\r\n      viewportId,\r\n      {\r\n        segmentationId,\r\n        type,\r\n      },\r\n      isVisible\r\n    );\r\n  }\r\n\r\n  private determineViewportAndSegmentationType(csViewport, segmentation) {\r\n    const isVolumeViewport =\r\n      csViewport.type === ViewportType.ORTHOGRAPHIC || csViewport.type === ViewportType.VOLUME_3D;\r\n    const isVolumeSegmentation = 'volumeId' in segmentation.representationData[LABELMAP];\r\n    return { isVolumeViewport, isVolumeSegmentation };\r\n  }\r\n\r\n  private async handleViewportConversion(\r\n    isVolumeViewport: boolean,\r\n    isVolumeSegmentation: boolean,\r\n    csViewport: csTypes.IViewport,\r\n    segmentation: cstTypes.Segmentation,\r\n    viewportId: string,\r\n    segmentationId: string,\r\n    representationType: csToolsEnums.SegmentationRepresentations\r\n  ) {\r\n    let representationTypeToUse = representationType;\r\n    let isConverted = false;\r\n\r\n    const handler = isVolumeViewport ? this.handleVolumeViewportCase : this.handleStackViewportCase;\r\n\r\n    ({ representationTypeToUse, isConverted } = await handler.apply(this, [\r\n      csViewport,\r\n      segmentation,\r\n      isVolumeSegmentation,\r\n      viewportId,\r\n      segmentationId,\r\n    ]));\r\n\r\n    return { representationTypeToUse, isConverted };\r\n  }\r\n\r\n  private async handleVolumeViewportCase(csViewport, segmentation, isVolumeSegmentation) {\r\n    if (csViewport.type === ViewportType.VOLUME_3D) {\r\n      return { representationTypeToUse: SegmentationRepresentations.Surface, isConverted: false };\r\n    } else {\r\n      await this.handleVolumeViewport(\r\n        csViewport as csTypes.IVolumeViewport,\r\n        segmentation,\r\n        isVolumeSegmentation\r\n      );\r\n      return { representationTypeToUse: SegmentationRepresentations.Labelmap, isConverted: false };\r\n    }\r\n  }\r\n\r\n  private async handleStackViewportCase(\r\n    csViewport: csTypes.IViewport,\r\n    segmentation: cstTypes.Segmentation,\r\n    isVolumeSegmentation: boolean,\r\n    viewportId: string,\r\n    segmentationId: string\r\n  ): Promise<{ representationTypeToUse: SegmentationRepresentations; isConverted: boolean }> {\r\n    if (isVolumeSegmentation) {\r\n      const isConverted = await this.convertStackToVolumeViewport(csViewport);\r\n      return { representationTypeToUse: SegmentationRepresentations.Labelmap, isConverted };\r\n    }\r\n\r\n    if (updateLabelmapSegmentationImageReferences(viewportId, segmentationId)) {\r\n      return { representationTypeToUse: SegmentationRepresentations.Labelmap, isConverted: false };\r\n    }\r\n\r\n    const isConverted = await this.attemptStackToVolumeConversion(\r\n      csViewport as csTypes.IStackViewport,\r\n      segmentation,\r\n      viewportId,\r\n      segmentationId\r\n    );\r\n\r\n    return { representationTypeToUse: SegmentationRepresentations.Labelmap, isConverted };\r\n  }\r\n\r\n  private async _addSegmentationRepresentation(\r\n    viewportId: string,\r\n    segmentationId: string,\r\n    representationType: csToolsEnums.SegmentationRepresentations,\r\n    colorLUTIndex: number,\r\n    isConverted: boolean,\r\n    config?: {\r\n      blendMode?: csEnums.BlendModes;\r\n    }\r\n  ): Promise<void> {\r\n    const representation = {\r\n      type: representationType,\r\n      segmentationId,\r\n      config: { colorLUTOrIndex: colorLUTIndex, ...config },\r\n    };\r\n\r\n    const addRepresentation = () =>\r\n      cstSegmentation.addSegmentationRepresentations(viewportId, [representation]);\r\n\r\n    if (isConverted) {\r\n      const { viewportGridService } = this.servicesManager.services;\r\n      await new Promise<void>(resolve => {\r\n        const { unsubscribe } = viewportGridService.subscribe(\r\n          viewportGridService.EVENTS.GRID_STATE_CHANGED,\r\n          () => {\r\n            addRepresentation();\r\n            unsubscribe();\r\n            resolve();\r\n          }\r\n        );\r\n      });\r\n    } else {\r\n      addRepresentation();\r\n    }\r\n  }\r\n  private async handleVolumeViewport(\r\n    viewport: csTypes.IVolumeViewport,\r\n    segmentation: SegmentationData,\r\n    isVolumeSegmentation: boolean\r\n  ): Promise<void> {\r\n    if (isVolumeSegmentation) {\r\n      return; // Volume Labelmap on Volume Viewport is natively supported\r\n    }\r\n\r\n    const frameOfReferenceUID = viewport.getFrameOfReferenceUID();\r\n    const imageIds = getLabelmapImageIds(segmentation.segmentationId);\r\n    const segImage = cache.getImage(imageIds[0]);\r\n\r\n    if (segImage?.FrameOfReferenceUID === frameOfReferenceUID) {\r\n      await convertStackToVolumeLabelmap(segmentation);\r\n    }\r\n  }\r\n\r\n  private async convertStackToVolumeViewport(viewport: csTypes.IViewport): Promise<boolean> {\r\n    const { viewportGridService, cornerstoneViewportService } = this.servicesManager.services;\r\n    const state = viewportGridService.getState();\r\n    const gridViewport = state.viewports.get(viewport.id);\r\n\r\n    const prevViewPresentation = viewport.getViewPresentation();\r\n    const prevViewReference = viewport.getViewReference();\r\n    const stackViewport = cornerstoneViewportService.getCornerstoneViewport(viewport.id);\r\n    const { element } = stackViewport;\r\n\r\n    const volumeViewportNewVolumeHandler = () => {\r\n      const volumeViewport = cornerstoneViewportService.getCornerstoneViewport(viewport.id);\r\n      volumeViewport.setViewPresentation(prevViewPresentation);\r\n      volumeViewport.setViewReference(prevViewReference);\r\n      volumeViewport.render();\r\n\r\n      element.removeEventListener(\r\n        csEnums.Events.VOLUME_VIEWPORT_NEW_VOLUME,\r\n        volumeViewportNewVolumeHandler\r\n      );\r\n    };\r\n\r\n    element.addEventListener(\r\n      csEnums.Events.VOLUME_VIEWPORT_NEW_VOLUME,\r\n      volumeViewportNewVolumeHandler\r\n    );\r\n\r\n    viewportGridService.setDisplaySetsForViewport({\r\n      viewportId: viewport.id,\r\n      displaySetInstanceUIDs: gridViewport.displaySetInstanceUIDs,\r\n      viewportOptions: {\r\n        ...gridViewport.viewportOptions,\r\n        viewportType: ViewportType.ORTHOGRAPHIC,\r\n      },\r\n    });\r\n\r\n    return true;\r\n  }\r\n\r\n  private async attemptStackToVolumeConversion(\r\n    viewport: csTypes.IStackViewport,\r\n    segmentation: SegmentationData,\r\n    viewportId: string,\r\n    segmentationId: string\r\n  ): Promise<boolean> {\r\n    const imageIds = getLabelmapImageIds(segmentation.segmentationId);\r\n    const frameOfReferenceUID = viewport.getFrameOfReferenceUID();\r\n    const segImage = cache.getImage(imageIds[0]);\r\n\r\n    if (\r\n      segImage?.FrameOfReferenceUID &&\r\n      frameOfReferenceUID &&\r\n      segImage.FrameOfReferenceUID === frameOfReferenceUID\r\n    ) {\r\n      const isConverted = await this.convertStackToVolumeViewport(viewport);\r\n      triggerSegmentationRepresentationModified(\r\n        viewportId,\r\n        segmentationId,\r\n        SegmentationRepresentations.Labelmap\r\n      );\r\n\r\n      return isConverted;\r\n    }\r\n  }\r\n\r\n  private addSegmentationToSource(segmentationPublicInput: cstTypes.SegmentationPublicInput) {\r\n    cstSegmentation.addSegmentations([segmentationPublicInput]);\r\n  }\r\n\r\n  private updateSegmentationInSource(\r\n    segmentationId: string,\r\n    payload: Partial<cstTypes.Segmentation>\r\n  ) {\r\n    cstSegmentation.updateSegmentations([{ segmentationId, payload }]);\r\n  }\r\n\r\n  private _toOHIFSegmentationRepresentation(\r\n    viewportId: string,\r\n    csRepresentation: cstTypes.SegmentationRepresentation\r\n  ): SegmentationRepresentation {\r\n    const { segmentationId, type, active, visible } = csRepresentation;\r\n    const { colorLUTIndex } = csRepresentation;\r\n\r\n    const segmentsRepresentations: { [segmentIndex: number]: SegmentRepresentation } = {};\r\n\r\n    const segmentation = cstSegmentation.state.getSegmentation(segmentationId);\r\n\r\n    if (!segmentation) {\r\n      throw new Error(`Segmentation with ID ${segmentationId} not found.`);\r\n    }\r\n\r\n    const segmentIds = Object.keys(segmentation.segments);\r\n\r\n    for (const segmentId of segmentIds) {\r\n      const segmentIndex = parseInt(segmentId, 10);\r\n\r\n      const color = cstSegmentation.config.color.getSegmentIndexColor(\r\n        viewportId,\r\n        segmentationId,\r\n        segmentIndex\r\n      );\r\n\r\n      const isVisible = cstSegmentation.config.visibility.getSegmentIndexVisibility(\r\n        viewportId,\r\n        {\r\n          segmentationId,\r\n          type,\r\n        },\r\n        segmentIndex\r\n      );\r\n\r\n      segmentsRepresentations[segmentIndex] = {\r\n        color,\r\n        segmentIndex,\r\n        opacity: color[3],\r\n        visible: isVisible,\r\n      };\r\n    }\r\n\r\n    const styles = cstSegmentation.config.style.getStyle({\r\n      viewportId,\r\n      segmentationId,\r\n      type,\r\n    });\r\n\r\n    const id = `${segmentationId}-${type}-${viewportId}`;\r\n\r\n    return {\r\n      id: id,\r\n      segmentationId,\r\n      label: segmentation.label,\r\n      active,\r\n      type,\r\n      visible,\r\n      segments: segmentsRepresentations,\r\n      styles,\r\n      viewportId,\r\n      colorLUTIndex,\r\n      config: {},\r\n    };\r\n  }\r\n\r\n  private _initSegmentationService() {\r\n    eventTarget.addEventListener(\r\n      csToolsEnums.Events.SEGMENTATION_MODIFIED,\r\n      this._onSegmentationModifiedFromSource\r\n    );\r\n\r\n    eventTarget.addEventListener(\r\n      csToolsEnums.Events.SEGMENTATION_REMOVED,\r\n      this._onSegmentationModifiedFromSource\r\n    );\r\n\r\n    eventTarget.addEventListener(\r\n      csToolsEnums.Events.SEGMENTATION_DATA_MODIFIED,\r\n      this._onSegmentationDataModifiedFromSource\r\n    );\r\n\r\n    eventTarget.addEventListener(\r\n      csToolsEnums.Events.SEGMENTATION_REPRESENTATION_MODIFIED,\r\n      this._onSegmentationRepresentationModifiedFromSource\r\n    );\r\n\r\n    eventTarget.addEventListener(\r\n      csToolsEnums.Events.SEGMENTATION_REPRESENTATION_ADDED,\r\n      this._onSegmentationRepresentationModifiedFromSource\r\n    );\r\n\r\n    eventTarget.addEventListener(\r\n      csToolsEnums.Events.SEGMENTATION_REPRESENTATION_REMOVED,\r\n      this._onSegmentationRepresentationModifiedFromSource\r\n    );\r\n\r\n    eventTarget.addEventListener(\r\n      csToolsEnums.Events.SEGMENTATION_ADDED,\r\n      this._onSegmentationAddedFromSource\r\n    );\r\n  }\r\n\r\n  private getCornerstoneSegmentation(segmentationId: string) {\r\n    return cstSegmentation.state.getSegmentation(segmentationId);\r\n  }\r\n\r\n  private _highlightLabelmap(\r\n    segmentIndex: number,\r\n    alpha: number,\r\n    hideOthers: boolean,\r\n    segments: Segment[],\r\n    viewportId: string,\r\n    animationLength: number,\r\n    representation: cstTypes.SegmentationRepresentation\r\n  ) {\r\n    const { segmentationId } = representation;\r\n    const newSegmentSpecificConfig = {\r\n      fillAlpha: alpha,\r\n    };\r\n\r\n    if (hideOthers) {\r\n      throw new Error('hideOthers is not working right now');\r\n      for (let i = 0; i < segments.length; i++) {\r\n        if (i !== segmentIndex) {\r\n          newSegmentSpecificConfig[i] = {\r\n            fillAlpha: 0,\r\n          };\r\n        }\r\n      }\r\n    }\r\n\r\n    const { fillAlpha } = this.getStyle({\r\n      viewportId,\r\n      segmentationId,\r\n      type: LABELMAP,\r\n      segmentIndex,\r\n    }) as cstTypes.LabelmapStyle;\r\n\r\n    let startTime: number = null;\r\n    const animation = (timestamp: number) => {\r\n      if (startTime === null) {\r\n        startTime = timestamp;\r\n      }\r\n\r\n      const elapsed = timestamp - startTime;\r\n      const progress = Math.min(elapsed / animationLength, 1);\r\n\r\n      cstSegmentation.config.style.setStyle(\r\n        {\r\n          segmentationId,\r\n          segmentIndex,\r\n          type: LABELMAP,\r\n        },\r\n        {\r\n          fillAlpha: easeInOutBell(progress, fillAlpha),\r\n        }\r\n      );\r\n\r\n      if (progress < 1) {\r\n        requestAnimationFrame(animation);\r\n      } else {\r\n        cstSegmentation.config.style.setStyle(\r\n          {\r\n            segmentationId,\r\n            segmentIndex,\r\n            type: LABELMAP,\r\n          },\r\n          {}\r\n        );\r\n      }\r\n    };\r\n\r\n    requestAnimationFrame(animation);\r\n  }\r\n\r\n  private _highlightContour(\r\n    segmentIndex: number,\r\n    alpha: number,\r\n    hideOthers: boolean,\r\n    segments: Segment[],\r\n    viewportId: string,\r\n    animationLength: number,\r\n    representation: cstTypes.SegmentationRepresentation\r\n  ) {\r\n    const { segmentationId } = representation;\r\n    const startTime = performance.now();\r\n\r\n    const prevStyle = cstSegmentation.config.style.getStyle({\r\n      type: CONTOUR,\r\n    }) as ContourStyle;\r\n\r\n    const prevOutlineWidth = prevStyle.outlineWidth;\r\n    // make this configurable\r\n    const baseline = Math.max(prevOutlineWidth * 3.5, 5);\r\n\r\n    const animate = (currentTime: number) => {\r\n      const progress = (currentTime - startTime) / animationLength;\r\n      if (progress >= 1) {\r\n        cstSegmentation.config.style.resetToGlobalStyle();\r\n        return;\r\n      }\r\n\r\n      const reversedProgress = easeInOutBellRelative(progress, baseline, prevOutlineWidth);\r\n\r\n      cstSegmentation.config.style.setStyle(\r\n        {\r\n          segmentationId,\r\n          segmentIndex,\r\n          type: CONTOUR,\r\n        },\r\n        {\r\n          outlineWidth: reversedProgress,\r\n        }\r\n      );\r\n\r\n      requestAnimationFrame(animate);\r\n    };\r\n\r\n    requestAnimationFrame(animate);\r\n  }\r\n\r\n  private _toggleSegmentationRepresentationVisibility = (\r\n    viewportId: string,\r\n    segmentationId: string,\r\n    type: SegmentationRepresentations\r\n  ): void => {\r\n    const representations = this.getSegmentationRepresentations(viewportId, {\r\n      segmentationId,\r\n      type,\r\n    });\r\n    const representation = representations[0];\r\n\r\n    const segmentsHidden = cstSegmentation.config.visibility.getHiddenSegmentIndices(viewportId, {\r\n      segmentationId,\r\n      type: representation.type,\r\n    });\r\n\r\n    const currentVisibility = segmentsHidden.size === 0;\r\n    this._setSegmentationRepresentationVisibility(\r\n      viewportId,\r\n      segmentationId,\r\n      representation.type,\r\n      !currentVisibility\r\n    );\r\n  };\r\n\r\n  private _setActiveSegment(segmentationId: string, segmentIndex: number) {\r\n    cstSegmentation.segmentIndex.setActiveSegmentIndex(segmentationId, segmentIndex);\r\n  }\r\n\r\n  private _getVolumeIdForDisplaySet(displaySet) {\r\n    const volumeLoaderSchema = displaySet.volumeLoaderSchema ?? VOLUME_LOADER_SCHEME;\r\n\r\n    return `${volumeLoaderSchema}:${displaySet.displaySetInstanceUID}`;\r\n  }\r\n\r\n  private _getSegmentCenter(segmentationId, segmentIndex) {\r\n    const segmentation = this.getSegmentation(segmentationId);\r\n\r\n    if (!segmentation) {\r\n      return;\r\n    }\r\n\r\n    const { segments } = segmentation;\r\n\r\n    const { cachedStats } = segments[segmentIndex];\r\n\r\n    if (!cachedStats) {\r\n      return;\r\n    }\r\n\r\n    const { center } = cachedStats;\r\n\r\n    if (!center) {\r\n      return {\r\n        world: cachedStats.namedStats.center.value,\r\n      };\r\n    }\r\n\r\n    return center;\r\n  }\r\n\r\n  private _setSegmentLockedStatus(segmentationId: string, segmentIndex: number, isLocked: boolean) {\r\n    cstSegmentation.segmentLocking.setSegmentIndexLocked(segmentationId, segmentIndex, isLocked);\r\n  }\r\n\r\n  private _setSegmentVisibility(\r\n    viewportId: string,\r\n    segmentationId: string,\r\n    segmentIndex: number,\r\n    isVisible: boolean,\r\n    type?: SegmentationRepresentations\r\n  ) {\r\n    cstSegmentation.config.visibility.setSegmentIndexVisibility(\r\n      viewportId,\r\n      {\r\n        segmentationId,\r\n        type,\r\n      },\r\n      segmentIndex,\r\n      isVisible\r\n    );\r\n  }\r\n\r\n  private _setSegmentLabel(segmentationId: string, segmentIndex: number, segmentLabel: string) {\r\n    const segmentation = this.getCornerstoneSegmentation(segmentationId);\r\n    const { segments } = segmentation;\r\n\r\n    segments[segmentIndex].label = segmentLabel;\r\n\r\n    cstSegmentation.updateSegmentations([\r\n      {\r\n        segmentationId,\r\n        payload: {\r\n          segments,\r\n        },\r\n      },\r\n    ]);\r\n  }\r\n\r\n  private _onSegmentationDataModifiedFromSource = evt => {\r\n    const { segmentationId } = evt.detail;\r\n    this._broadcastEvent(this.EVENTS.SEGMENTATION_DATA_MODIFIED, {\r\n      segmentationId,\r\n    });\r\n  };\r\n\r\n  private _onSegmentationRepresentationModifiedFromSource = evt => {\r\n    const { segmentationId, viewportId } = evt.detail;\r\n    this._broadcastEvent(this.EVENTS.SEGMENTATION_REPRESENTATION_MODIFIED, {\r\n      segmentationId,\r\n      viewportId,\r\n    });\r\n  };\r\n\r\n  private _onSegmentationModifiedFromSource = (\r\n    evt: cstTypes.EventTypes.SegmentationModifiedEventType\r\n  ) => {\r\n    const { segmentationId } = evt.detail;\r\n\r\n    this._broadcastEvent(this.EVENTS.SEGMENTATION_MODIFIED, {\r\n      segmentationId,\r\n    });\r\n  };\r\n\r\n  private _onSegmentationAddedFromSource = (\r\n    evt: cstTypes.EventTypes.SegmentationAddedEventType\r\n  ) => {\r\n    const { segmentationId } = evt.detail;\r\n\r\n    this._broadcastEvent(this.EVENTS.SEGMENTATION_ADDED, {\r\n      segmentationId,\r\n    });\r\n  };\r\n}\r\n\r\nexport default SegmentationService;\r\nexport { EVENTS, VALUE_TYPES };\r\n","import SegmentationService from './SegmentationService';\r\n\r\nexport default SegmentationService;\r\n","import { synchronizers, SynchronizerManager, Synchronizer } from '@cornerstonejs/tools';\r\nimport { getRenderingEngines, utilities } from '@cornerstonejs/core';\r\n\r\nimport { pubSubServiceInterface, Types } from '@ohif/core';\r\nimport createHydrateSegmentationSynchronizer from './createHydrateSegmentationSynchronizer';\r\n\r\nconst EVENTS = {\r\n  TOOL_GROUP_CREATED: 'event::cornerstone::syncgroupservice:toolgroupcreated',\r\n};\r\n\r\n/**\r\n * @params options - are an optional set of options associated with the first\r\n * sync group declared.\r\n */\r\nexport type SyncCreator = (id: string, options?: Record<string, unknown>) => Synchronizer;\r\n\r\nexport type SyncGroup = {\r\n  type: string;\r\n  id?: string;\r\n  // Source and target default to true if not specified\r\n  source?: boolean;\r\n  target?: boolean;\r\n  options?: Record<string, unknown>;\r\n};\r\n\r\nconst POSITION = 'cameraposition';\r\nconst VOI = 'voi';\r\nconst ZOOMPAN = 'zoompan';\r\nconst STACKIMAGE = 'stackimage';\r\nconst IMAGE_SLICE = 'imageslice';\r\nconst HYDRATE_SEG = 'hydrateseg';\r\n\r\nconst asSyncGroup = (syncGroup: string | SyncGroup): SyncGroup =>\r\n  typeof syncGroup === 'string' ? { type: syncGroup } : syncGroup;\r\n\r\nexport default class SyncGroupService {\r\n  static REGISTRATION = {\r\n    name: 'syncGroupService',\r\n    altName: 'SyncGroupService',\r\n    create: ({ servicesManager }: Types.Extensions.ExtensionParams): SyncGroupService => {\r\n      return new SyncGroupService(servicesManager);\r\n    },\r\n  };\r\n\r\n  servicesManager: AppTypes.ServicesManager;\r\n  listeners: { [key: string]: (...args: any[]) => void } = {};\r\n  EVENTS: { [key: string]: string };\r\n  synchronizerCreators: Record<string, SyncCreator> = {\r\n    [POSITION]: synchronizers.createCameraPositionSynchronizer,\r\n    [VOI]: synchronizers.createVOISynchronizer,\r\n    [ZOOMPAN]: synchronizers.createZoomPanSynchronizer,\r\n    // todo: remove stack image since it is legacy now and the image_slice\r\n    // handles both stack and volume viewports\r\n    [STACKIMAGE]: synchronizers.createImageSliceSynchronizer,\r\n    [IMAGE_SLICE]: synchronizers.createImageSliceSynchronizer,\r\n    [HYDRATE_SEG]: createHydrateSegmentationSynchronizer,\r\n  };\r\n\r\n  synchronizersByType: { [key: string]: Synchronizer[] } = {};\r\n\r\n  constructor(servicesManager: AppTypes.ServicesManager) {\r\n    this.servicesManager = servicesManager;\r\n    this.listeners = {};\r\n    this.EVENTS = EVENTS;\r\n    //\r\n    Object.assign(this, pubSubServiceInterface);\r\n  }\r\n\r\n  private _createSynchronizer(type: string, id: string, options): Synchronizer | undefined {\r\n    // Initialize if not already done\r\n    this.synchronizersByType[type] = this.synchronizersByType[type] || [];\r\n    const syncCreator = this.synchronizerCreators[type.toLowerCase()];\r\n\r\n    if (syncCreator) {\r\n      // Pass the servicesManager along with other parameters\r\n      const synchronizer = syncCreator(id, { ...options, servicesManager: this.servicesManager });\r\n\r\n      if (synchronizer) {\r\n        this.synchronizersByType[type].push(synchronizer);\r\n        return synchronizer;\r\n      }\r\n    } else {\r\n      console.debug(`Unknown synchronizer type: ${type}, id: ${id}`);\r\n    }\r\n  }\r\n\r\n  public getSyncCreatorForType(type: string): SyncCreator {\r\n    return this.synchronizerCreators[type.toLowerCase()];\r\n  }\r\n\r\n  /**\r\n   * Creates a synchronizer type.\r\n   * @param type is the type of the synchronizer to create\r\n   * @param creator\r\n   */\r\n  public addSynchronizerType(type: string, creator: SyncCreator): void {\r\n    this.synchronizerCreators[type.toLowerCase()] = creator;\r\n  }\r\n\r\n  public getSynchronizer(id: string): Synchronizer | void {\r\n    return SynchronizerManager.getSynchronizer(id);\r\n  }\r\n\r\n  /**\r\n   * Registers a custom synchronizer.\r\n   * @param id - The id of the synchronizer.\r\n   * @param createFunction - The function that creates the synchronizer.\r\n   */\r\n  public registerCustomSynchronizer(id: string, createFunction: SyncCreator): void {\r\n    this.synchronizerCreators[id] = createFunction;\r\n  }\r\n\r\n  /**\r\n   * Retrieves an array of synchronizers of a specific type.\r\n   * @param type - The type of synchronizers to retrieve.\r\n   * @returns An array of synchronizers of the specified type.\r\n   */\r\n  public getSynchronizersOfType(type: string): Synchronizer[] {\r\n    return this.synchronizersByType[type];\r\n  }\r\n\r\n  protected _getOrCreateSynchronizer(\r\n    type: string,\r\n    id: string,\r\n    options: Record<string, unknown>\r\n  ): Synchronizer | undefined {\r\n    let synchronizer = SynchronizerManager.getSynchronizer(id);\r\n\r\n    if (!synchronizer) {\r\n      synchronizer = this._createSynchronizer(type, id, options);\r\n    }\r\n    return synchronizer;\r\n  }\r\n\r\n  public addViewportToSyncGroup(\r\n    viewportId: string,\r\n    renderingEngineId: string,\r\n    syncGroups?: SyncGroup | string | SyncGroup[] | string[]\r\n  ): void {\r\n    if (!syncGroups) {\r\n      return;\r\n    }\r\n\r\n    const syncGroupsArray = Array.isArray(syncGroups) ? syncGroups : [syncGroups];\r\n\r\n    syncGroupsArray.forEach(syncGroup => {\r\n      const syncGroupObj = asSyncGroup(syncGroup);\r\n      const { type, target = true, source = true, options = {}, id = type } = syncGroupObj;\r\n\r\n      const synchronizer = this._getOrCreateSynchronizer(type, id, options);\r\n\r\n      if (!synchronizer) {\r\n        return;\r\n      }\r\n\r\n      synchronizer.setOptions(viewportId, options);\r\n\r\n      const viewportInfo = { viewportId, renderingEngineId };\r\n      if (target && source) {\r\n        synchronizer.add(viewportInfo);\r\n        return;\r\n      } else if (source) {\r\n        synchronizer.addSource(viewportInfo);\r\n      } else if (target) {\r\n        synchronizer.addTarget(viewportInfo);\r\n      }\r\n    });\r\n  }\r\n\r\n  public destroy(): void {\r\n    SynchronizerManager.destroy();\r\n  }\r\n\r\n  public getSynchronizersForViewport(viewportId: string): Synchronizer[] {\r\n    const renderingEngine =\r\n      getRenderingEngines().find(re => {\r\n        return re.getViewports().find(vp => vp.id === viewportId);\r\n      }) || getRenderingEngines()[0];\r\n\r\n    const synchronizers = SynchronizerManager.getAllSynchronizers();\r\n    return synchronizers.filter(\r\n      s =>\r\n        s.hasSourceViewport(renderingEngine.id, viewportId) ||\r\n        s.hasTargetViewport(renderingEngine.id, viewportId)\r\n    );\r\n  }\r\n\r\n  public removeViewportFromSyncGroup(\r\n    viewportId: string,\r\n    renderingEngineId: string,\r\n    syncGroupId?: string\r\n  ): void {\r\n    const synchronizers = SynchronizerManager.getAllSynchronizers();\r\n\r\n    const filteredSynchronizers = syncGroupId\r\n      ? synchronizers.filter(s => s.id === syncGroupId)\r\n      : synchronizers;\r\n\r\n    filteredSynchronizers.forEach(synchronizer => {\r\n      if (!synchronizer) {\r\n        return;\r\n      }\r\n\r\n      // Only image slice synchronizer register spatial registration\r\n      if (this.isImageSliceSyncronizer(synchronizer)) {\r\n        this.unRegisterSpatialRegistration(synchronizer);\r\n      }\r\n\r\n      synchronizer.remove({\r\n        viewportId,\r\n        renderingEngineId,\r\n      });\r\n\r\n      // check if any viewport is left in any of the sync groups, if not, delete that sync group\r\n      const sourceViewports = synchronizer.getSourceViewports();\r\n      const targetViewports = synchronizer.getTargetViewports();\r\n\r\n      if (!sourceViewports.length && !targetViewports.length) {\r\n        SynchronizerManager.destroySynchronizer(synchronizer.id);\r\n      }\r\n    });\r\n  }\r\n  /**\r\n   * Clean up the spatial registration metadata created by synchronizer\r\n   * This is needed to be able to re-sync images slices if needed\r\n   * @param synchronizer\r\n   */\r\n  unRegisterSpatialRegistration(synchronizer: Synchronizer) {\r\n    const sourceViewports = synchronizer.getSourceViewports().map(vp => vp.viewportId);\r\n    const targetViewports = synchronizer.getTargetViewports().map(vp => vp.viewportId);\r\n\r\n    // Create an array of pair of viewports to remove from spatialRegistrationMetadataProvider\r\n    // All sourceViewports combined with all targetViewports\r\n    const toUnregister = sourceViewports\r\n      .map((sourceViewportId: string) => {\r\n        return targetViewports.map(targetViewportId => [targetViewportId, sourceViewportId]);\r\n      })\r\n      .reduce((acc, c) => acc.concat(c), []);\r\n\r\n    toUnregister.forEach(viewportIdPair => {\r\n      utilities.spatialRegistrationMetadataProvider.add(viewportIdPair, undefined);\r\n    });\r\n  }\r\n  /**\r\n   * Check if the synchronizer type is IMAGE_SLICE\r\n   * Need to convert to lowercase here because the types are lowercase\r\n   * e.g: synchronizerCreators\r\n   * @param synchronizer\r\n   */\r\n  isImageSliceSyncronizer(synchronizer: Synchronizer) {\r\n    return this.getSynchronizerType(synchronizer).toLowerCase() === IMAGE_SLICE;\r\n  }\r\n  /**\r\n   * Returns the syncronizer type\r\n   * @param synchronizer\r\n   */\r\n  getSynchronizerType(synchronizer: Synchronizer): string {\r\n    const synchronizerTypes = Object.keys(this.synchronizersByType);\r\n    const syncType = synchronizerTypes.find(syncType =>\r\n      this.getSynchronizersOfType(syncType).includes(synchronizer)\r\n    );\r\n    return syncType;\r\n  }\r\n}\r\n","import { Enums as CoreEnums, Types, getEnabledElementByViewportId } from '@cornerstonejs/core';\r\nimport {\r\n  SynchronizerManager,\r\n  Synchronizer,\r\n  Enums,\r\n  Types as ToolsTypes,\r\n} from '@cornerstonejs/tools';\r\n\r\nconst { createSynchronizer } = SynchronizerManager;\r\nconst { SEGMENTATION_REPRESENTATION_MODIFIED } = Enums.Events;\r\nconst { BlendModes } = CoreEnums;\r\n\r\nexport default function createHydrateSegmentationSynchronizer(\r\n  synchronizerName: string,\r\n  { servicesManager, ...options }: { servicesManager: AppTypes.ServicesManager; options }\r\n): Synchronizer {\r\n  const stackImageSynchronizer = createSynchronizer(\r\n    synchronizerName,\r\n    SEGMENTATION_REPRESENTATION_MODIFIED,\r\n    (synchronizerInstance, sourceViewport, targetViewport, sourceEvent) => {\r\n      return segmentationRepresentationModifiedCallback(\r\n        synchronizerInstance,\r\n        sourceViewport,\r\n        targetViewport,\r\n        sourceEvent,\r\n        { servicesManager, options }\r\n      );\r\n    },\r\n    {\r\n      eventSource: 'eventTarget',\r\n    }\r\n  );\r\n\r\n  return stackImageSynchronizer;\r\n}\r\n\r\nconst segmentationRepresentationModifiedCallback = async (\r\n  synchronizerInstance: Synchronizer,\r\n  sourceViewport: Types.IViewportId,\r\n  targetViewport: Types.IViewportId,\r\n  sourceEvent: Event,\r\n  { servicesManager, options }: { servicesManager: AppTypes.ServicesManager; options: unknown }\r\n) => {\r\n  const event = sourceEvent as ToolsTypes.EventTypes.SegmentationRepresentationModifiedEventType;\r\n\r\n  const { segmentationId } = event.detail;\r\n  const { segmentationService } = servicesManager.services;\r\n\r\n  const targetViewportId = targetViewport.viewportId;\r\n\r\n  const { viewport } = getEnabledElementByViewportId(targetViewportId);\r\n\r\n  const targetFrameOfReferenceUID = viewport.getFrameOfReferenceUID();\r\n\r\n  if (!targetFrameOfReferenceUID) {\r\n    return;\r\n  }\r\n\r\n  const targetViewportRepresentation = segmentationService.getSegmentationRepresentations(\r\n    targetViewportId,\r\n    { segmentationId }\r\n  );\r\n\r\n  if (targetViewportRepresentation.length > 0) {\r\n    return;\r\n  }\r\n\r\n  // whatever type the source viewport has, we need to add that to the target viewport\r\n  const sourceViewportRepresentation = segmentationService.getSegmentationRepresentations(\r\n    sourceViewport.viewportId,\r\n    { segmentationId }\r\n  );\r\n\r\n  const type = sourceViewportRepresentation[0].type;\r\n\r\n  await segmentationService.addSegmentationRepresentation(targetViewportId, {\r\n    segmentationId,\r\n    type,\r\n    config: {\r\n      blendMode:\r\n        viewport.getBlendMode() === 1 ? BlendModes.LABELMAP_EDGE_PROJECTION_BLEND : undefined,\r\n    },\r\n  });\r\n};\r\n","import SyncGroupService from './SyncGroupService';\r\n\r\nexport default SyncGroupService;\r\n","import { ToolGroupManager, Enums, Types } from '@cornerstonejs/tools';\r\nimport { eventTarget } from '@cornerstonejs/core';\r\n\r\nimport { Types as OhifTypes, pubSubServiceInterface } from '@ohif/core';\r\nimport getActiveViewportEnabledElement from '../../utils/getActiveViewportEnabledElement';\r\n\r\nconst EVENTS = {\r\n  VIEWPORT_ADDED: 'event::cornerstone::toolgroupservice:viewportadded',\r\n  TOOLGROUP_CREATED: 'event::cornerstone::toolgroupservice:toolgroupcreated',\r\n  TOOL_ACTIVATED: 'event::cornerstone::toolgroupservice:toolactivated',\r\n  PRIMARY_TOOL_ACTIVATED: 'event::cornerstone::toolgroupservice:primarytoolactivated',\r\n};\r\n\r\ntype Tool = {\r\n  toolName: string;\r\n  bindings?: typeof Enums.MouseBindings | Enums.KeyboardBindings;\r\n};\r\n\r\ntype Tools = {\r\n  active: Tool[];\r\n  passive?: Tool[];\r\n  enabled?: Tool[];\r\n  disabled?: Tool[];\r\n};\r\n\r\nexport default class ToolGroupService {\r\n  public static REGISTRATION = {\r\n    name: 'toolGroupService',\r\n    altName: 'ToolGroupService',\r\n    create: ({ servicesManager }: OhifTypes.Extensions.ExtensionParams): ToolGroupService => {\r\n      return new ToolGroupService(servicesManager);\r\n    },\r\n  };\r\n\r\n  servicesManager: AppTypes.ServicesManager;\r\n  cornerstoneViewportService: any;\r\n  viewportGridService: any;\r\n  uiNotificationService: any;\r\n  private toolGroupIds: Set<string> = new Set();\r\n  /**\r\n   * Service-specific\r\n   */\r\n  listeners: { [key: string]: Function[] };\r\n  EVENTS: { [key: string]: string };\r\n\r\n  constructor(servicesManager: AppTypes.ServicesManager) {\r\n    const { cornerstoneViewportService, viewportGridService, uiNotificationService } =\r\n      servicesManager.services;\r\n    this.cornerstoneViewportService = cornerstoneViewportService;\r\n    this.viewportGridService = viewportGridService;\r\n    this.uiNotificationService = uiNotificationService;\r\n    this.listeners = {};\r\n    this.EVENTS = EVENTS;\r\n    Object.assign(this, pubSubServiceInterface);\r\n\r\n    this._init();\r\n  }\r\n\r\n  onModeExit() {\r\n    this.destroy();\r\n  }\r\n\r\n  private _init() {\r\n    eventTarget.addEventListener(Enums.Events.TOOL_ACTIVATED, this._onToolActivated);\r\n  }\r\n\r\n  /**\r\n   * Retrieves a tool group from the ToolGroupManager by tool group ID.\r\n   * If no tool group ID is provided, it retrieves the tool group of the active viewport.\r\n   * @param toolGroupId - Optional ID of the tool group to retrieve.\r\n   * @returns The tool group or undefined if it is not found.\r\n   */\r\n  public getToolGroup(toolGroupId?: string): Types.IToolGroup | void {\r\n    let toolGroupIdToUse = toolGroupId;\r\n\r\n    if (!toolGroupIdToUse) {\r\n      // Use the active viewport's tool group if no tool group id is provided\r\n      const enabledElement = getActiveViewportEnabledElement(this.viewportGridService);\r\n\r\n      if (!enabledElement) {\r\n        return;\r\n      }\r\n\r\n      const { renderingEngineId, viewportId } = enabledElement;\r\n      const toolGroup = ToolGroupManager.getToolGroupForViewport(viewportId, renderingEngineId);\r\n\r\n      if (!toolGroup) {\r\n        console.warn(\r\n          'No tool group found for viewportId:',\r\n          viewportId,\r\n          'and renderingEngineId:',\r\n          renderingEngineId\r\n        );\r\n        return;\r\n      }\r\n\r\n      toolGroupIdToUse = toolGroup.id;\r\n    }\r\n\r\n    const toolGroup = ToolGroupManager.getToolGroup(toolGroupIdToUse);\r\n    return toolGroup;\r\n  }\r\n\r\n  public getToolGroupIds(): string[] {\r\n    return Array.from(this.toolGroupIds);\r\n  }\r\n\r\n  public getToolGroupForViewport(viewportId: string): Types.IToolGroup | void {\r\n    const renderingEngine = this.cornerstoneViewportService.getRenderingEngine();\r\n    return ToolGroupManager.getToolGroupForViewport(viewportId, renderingEngine.id);\r\n  }\r\n\r\n  public getActiveToolForViewport(viewportId: string): string {\r\n    const toolGroup = this.getToolGroupForViewport(viewportId);\r\n    if (!toolGroup) {\r\n      return;\r\n    }\r\n\r\n    return toolGroup.getActivePrimaryMouseButtonTool();\r\n  }\r\n\r\n  public destroy(): void {\r\n    ToolGroupManager.destroy();\r\n    this.toolGroupIds = new Set();\r\n\r\n    eventTarget.removeEventListener(Enums.Events.TOOL_ACTIVATED, this._onToolActivated);\r\n  }\r\n\r\n  public destroyToolGroup(toolGroupId: string): void {\r\n    ToolGroupManager.destroyToolGroup(toolGroupId);\r\n    this.toolGroupIds.delete(toolGroupId);\r\n  }\r\n\r\n  public removeViewportFromToolGroup(\r\n    viewportId: string,\r\n    renderingEngineId: string,\r\n    deleteToolGroupIfEmpty?: boolean\r\n  ): void {\r\n    const toolGroup = ToolGroupManager.getToolGroupForViewport(viewportId, renderingEngineId);\r\n\r\n    if (!toolGroup) {\r\n      return;\r\n    }\r\n\r\n    toolGroup.removeViewports(renderingEngineId, viewportId);\r\n\r\n    const viewportIds = toolGroup.getViewportIds();\r\n\r\n    if (viewportIds.length === 0 && deleteToolGroupIfEmpty) {\r\n      ToolGroupManager.destroyToolGroup(toolGroup.id);\r\n    }\r\n  }\r\n\r\n  public addViewportToToolGroup(\r\n    viewportId: string,\r\n    renderingEngineId: string,\r\n    toolGroupId?: string\r\n  ): void {\r\n    if (!toolGroupId) {\r\n      // If toolGroupId is not provided, add the viewport to all toolGroups\r\n      const toolGroups = ToolGroupManager.getAllToolGroups();\r\n      toolGroups.forEach(toolGroup => {\r\n        toolGroup.addViewport(viewportId, renderingEngineId);\r\n      });\r\n    } else {\r\n      let toolGroup = ToolGroupManager.getToolGroup(toolGroupId);\r\n      if (!toolGroup) {\r\n        toolGroup = this.createToolGroup(toolGroupId);\r\n      }\r\n\r\n      toolGroup.addViewport(viewportId, renderingEngineId);\r\n    }\r\n\r\n    this._broadcastEvent(EVENTS.VIEWPORT_ADDED, {\r\n      viewportId,\r\n      toolGroupId,\r\n    });\r\n  }\r\n\r\n  public createToolGroup(toolGroupId: string): Types.IToolGroup {\r\n    if (this.getToolGroup(toolGroupId)) {\r\n      throw new Error(`ToolGroup ${toolGroupId} already exists`);\r\n    }\r\n\r\n    // if the toolGroup doesn't exist, create it\r\n    const toolGroup = ToolGroupManager.createToolGroup(toolGroupId);\r\n    this.toolGroupIds.add(toolGroupId);\r\n\r\n    this._broadcastEvent(EVENTS.TOOLGROUP_CREATED, {\r\n      toolGroupId,\r\n    });\r\n\r\n    return toolGroup;\r\n  }\r\n\r\n  public addToolsToToolGroup(toolGroupId: string, tools: Array<Tool>, configs: any = {}): void {\r\n    const toolGroup = ToolGroupManager.getToolGroup(toolGroupId);\r\n    // this.changeConfigurationIfNecessary(toolGroup, volumeId);\r\n    this._addTools(toolGroup, tools, configs);\r\n    this._setToolsMode(toolGroup, tools);\r\n  }\r\n\r\n  public createToolGroupAndAddTools(toolGroupId: string, tools: Array<Tool>): Types.IToolGroup {\r\n    const toolGroup = this.createToolGroup(toolGroupId);\r\n    this.addToolsToToolGroup(toolGroupId, tools);\r\n    return toolGroup;\r\n  }\r\n  /**\r\n   * Get the tool's configuration based on the tool name and tool group id\r\n   * @param toolGroupId - The id of the tool group that the tool instance belongs to.\r\n   * @param toolName - The name of the tool\r\n   * @returns The configuration of the tool.\r\n   */\r\n  public getToolConfiguration(toolGroupId: string, toolName: string) {\r\n    const toolGroup = ToolGroupManager.getToolGroup(toolGroupId);\r\n    if (!toolGroup) {\r\n      return null;\r\n    }\r\n\r\n    const tool = toolGroup.getToolInstance(toolName);\r\n    if (!tool) {\r\n      return null;\r\n    }\r\n\r\n    return tool.configuration;\r\n  }\r\n\r\n  /**\r\n   * Set the tool instance configuration. This will update the tool instance configuration\r\n   * on the toolGroup\r\n   * @param toolGroupId - The id of the tool group that the tool instance belongs to.\r\n   * @param toolName - The name of the tool\r\n   * @param config - The configuration object that you want to set.\r\n   */\r\n  public setToolConfiguration(toolGroupId, toolName, config) {\r\n    const toolGroup = ToolGroupManager.getToolGroup(toolGroupId);\r\n    const toolInstance = toolGroup.getToolInstance(toolName);\r\n    toolInstance.configuration = config;\r\n  }\r\n\r\n  public getActivePrimaryMouseButtonTool(toolGroupId?: string): string {\r\n    return this.getToolGroup(toolGroupId)?.getActivePrimaryMouseButtonTool();\r\n  }\r\n\r\n  private _setToolsMode(toolGroup, tools) {\r\n    const { active, passive, enabled, disabled } = tools;\r\n\r\n    if (active) {\r\n      active.forEach(({ toolName, bindings }) => {\r\n        toolGroup.setToolActive(toolName, { bindings });\r\n      });\r\n    }\r\n\r\n    if (passive) {\r\n      passive.forEach(({ toolName }) => {\r\n        toolGroup.setToolPassive(toolName);\r\n      });\r\n    }\r\n\r\n    if (enabled) {\r\n      enabled.forEach(({ toolName }) => {\r\n        toolGroup.setToolEnabled(toolName);\r\n      });\r\n    }\r\n\r\n    if (disabled) {\r\n      disabled.forEach(({ toolName }) => {\r\n        toolGroup.setToolDisabled(toolName);\r\n      });\r\n    }\r\n  }\r\n\r\n  private _addTools(toolGroup, tools) {\r\n    const addTools = tools => {\r\n      tools.forEach(({ toolName, parentTool, configuration }) => {\r\n        if (parentTool) {\r\n          toolGroup.addToolInstance(toolName, parentTool, {\r\n            ...configuration,\r\n          });\r\n        } else {\r\n          toolGroup.addTool(toolName, { ...configuration });\r\n        }\r\n      });\r\n    };\r\n\r\n    if (tools.active) {\r\n      addTools(tools.active);\r\n    }\r\n\r\n    if (tools.passive) {\r\n      addTools(tools.passive);\r\n    }\r\n\r\n    if (tools.enabled) {\r\n      addTools(tools.enabled);\r\n    }\r\n\r\n    if (tools.disabled) {\r\n      addTools(tools.disabled);\r\n    }\r\n  }\r\n\r\n  private _onToolActivated = (evt: Types.EventTypes.ToolActivatedEventType) => {\r\n    const { toolGroupId, toolName, toolBindingsOptions } = evt.detail;\r\n    const isPrimaryTool = toolBindingsOptions.bindings?.some(\r\n      binding => binding.mouseButton === Enums.MouseBindings.Primary\r\n    );\r\n\r\n    const callbackProps = {\r\n      toolGroupId,\r\n      toolName,\r\n      toolBindingsOptions,\r\n    };\r\n\r\n    this._broadcastEvent(EVENTS.TOOL_ACTIVATED, callbackProps);\r\n\r\n    if (isPrimaryTool) {\r\n      this._broadcastEvent(EVENTS.PRIMARY_TOOL_ACTIVATED, callbackProps);\r\n    }\r\n  };\r\n}\r\n","import ToolGroupService from './ToolGroupService';\r\n\r\nexport default ToolGroupService;\r\n","import { PubSubService } from '@ohif/core';\r\nimport { Types as OhifTypes } from '@ohif/core';\r\nimport {\r\n  RenderingEngine,\r\n  StackViewport,\r\n  Types,\r\n  getRenderingEngine,\r\n  utilities as csUtils,\r\n  VolumeViewport,\r\n  VolumeViewport3D,\r\n  cache,\r\n  Enums as csEnums,\r\n  BaseVolumeViewport,\r\n} from '@cornerstonejs/core';\r\n\r\nimport { utilities as csToolsUtils, Enums as csToolsEnums } from '@cornerstonejs/tools';\r\nimport { IViewportService } from './IViewportService';\r\nimport { RENDERING_ENGINE_ID } from './constants';\r\nimport ViewportInfo, {\r\n  DisplaySetOptions,\r\n  PublicViewportOptions,\r\n  ViewportOptions,\r\n} from './Viewport';\r\nimport { StackViewportData, VolumeViewportData } from '../../types/CornerstoneCacheService';\r\nimport {\r\n  LutPresentation,\r\n  PositionPresentation,\r\n  Presentations,\r\n  SegmentationPresentation,\r\n  SegmentationPresentationItem,\r\n} from '../../types/Presentation';\r\n\r\nimport JumpPresets from '../../utils/JumpPresets';\r\nimport { ViewportProperties } from '@cornerstonejs/core/types';\r\nimport { useLutPresentationStore } from '../../stores/useLutPresentationStore';\r\nimport { usePositionPresentationStore } from '../../stores/usePositionPresentationStore';\r\nimport { useSynchronizersStore } from '../../stores/useSynchronizersStore';\r\nimport { useSegmentationPresentationStore } from '../../stores/useSegmentationPresentationStore';\r\nimport { VOLUME_LOADER_SCHEME } from '../../constants';\r\n\r\nconst EVENTS = {\r\n  VIEWPORT_DATA_CHANGED: 'event::cornerstoneViewportService:viewportDataChanged',\r\n  VIEWPORT_VOLUMES_CHANGED: 'event::cornerstoneViewportService:viewportVolumesChanged',\r\n};\r\n\r\nconst MIN_STACK_VIEWPORTS_TO_ENQUEUE_RESIZE = 12;\r\nconst MIN_VOLUME_VIEWPORTS_TO_ENQUEUE_RESIZE = 6;\r\n\r\nexport const WITH_NAVIGATION = { withNavigation: true, withOrientation: false };\r\n\r\n/**\r\n * Handles cornerstone viewport logic including enabling, disabling, and\r\n * updating the viewport.\r\n */\r\nclass CornerstoneViewportService extends PubSubService implements IViewportService {\r\n  static REGISTRATION = {\r\n    name: 'cornerstoneViewportService',\r\n    altName: 'CornerstoneViewportService',\r\n    create: ({\r\n      servicesManager,\r\n    }: OhifTypes.Extensions.ExtensionParams): CornerstoneViewportService => {\r\n      return new CornerstoneViewportService(servicesManager);\r\n    },\r\n  };\r\n\r\n  renderingEngine: Types.IRenderingEngine | null;\r\n  viewportsById: Map<string, ViewportInfo> = new Map();\r\n  viewportGridResizeObserver: ResizeObserver | null;\r\n  viewportsDisplaySets: Map<string, string[]> = new Map();\r\n  beforeResizePositionPresentations: Map<string, PositionPresentation> = new Map();\r\n\r\n  // Some configs\r\n  servicesManager: AppTypes.ServicesManager = null;\r\n\r\n  resizeQueue = [];\r\n  viewportResizeTimer = null;\r\n  gridResizeDelay = 50;\r\n  gridResizeTimeOut = null;\r\n\r\n  constructor(servicesManager: AppTypes.ServicesManager) {\r\n    super(EVENTS);\r\n    this.renderingEngine = null;\r\n    this.viewportGridResizeObserver = null;\r\n    this.servicesManager = servicesManager;\r\n  }\r\n  hangingProtocolService: unknown;\r\n  viewportsInfo: unknown;\r\n  sceneVolumeInputs: unknown;\r\n  viewportDivElements: unknown;\r\n  ViewportPropertiesMap: unknown;\r\n  volumeUIDs: unknown;\r\n  displaySetsNeedRerendering: unknown;\r\n  viewportDisplaySets: unknown;\r\n\r\n  /**\r\n   * Adds the HTML element to the viewportService\r\n   * @param {*} viewportId\r\n   * @param {*} elementRef\r\n   */\r\n  public enableViewport(viewportId: string, elementRef: HTMLDivElement): void {\r\n    const viewportInfo = new ViewportInfo(viewportId);\r\n    viewportInfo.setElement(elementRef);\r\n    this.viewportsById.set(viewportId, viewportInfo);\r\n  }\r\n\r\n  public getViewportIds(): string[] {\r\n    return Array.from(this.viewportsById.keys());\r\n  }\r\n\r\n  /**\r\n   * It retrieves the renderingEngine if it does exist, or creates one otherwise\r\n   * @returns {RenderingEngine} rendering engine\r\n   */\r\n  public getRenderingEngine() {\r\n    // get renderingEngine from cache if it exists\r\n    const renderingEngine = getRenderingEngine(RENDERING_ENGINE_ID);\r\n\r\n    if (renderingEngine) {\r\n      this.renderingEngine = renderingEngine;\r\n      return this.renderingEngine;\r\n    }\r\n\r\n    if (!renderingEngine || renderingEngine.hasBeenDestroyed) {\r\n      this.renderingEngine = new RenderingEngine(RENDERING_ENGINE_ID);\r\n    }\r\n\r\n    return this.renderingEngine;\r\n  }\r\n\r\n  /**\r\n   * It triggers the resize on the rendering engine, and renders the viewports\r\n   *\r\n   */\r\n  public resize() {\r\n    // https://stackoverflow.com/a/26279685\r\n    // This resize() call, among other things, rerenders the viewports. But when the entire viewer is\r\n    // display: none'd, it makes the size of all hidden elements 0, including the viewport canvas and its containers.\r\n    // Even if the viewer is later displayed again, trying to render when the size is 0 permanently \"breaks\" the\r\n    // viewport, making it fully black even after the size is normal again. So just ignore resize events when hidden:\r\n    const areViewportsHidden = Array.from(this.viewportsById.values()).every(viewportInfo => {\r\n      const element = viewportInfo.getElement();\r\n\r\n      return element.clientWidth === 0 && element.clientHeight === 0;\r\n    });\r\n    if (areViewportsHidden) {\r\n      console.warn('Ignoring resize when viewports have size 0');\r\n      return;\r\n    }\r\n\r\n    const numStackViewportsInViewportGrid = Array.from(this.viewportsById.values()).filter(\r\n      viewportInfo => viewportInfo.getViewportType() === csEnums.ViewportType.STACK\r\n    ).length;\r\n\r\n    const numVolumeViewportsInViewportGrid = Array.from(this.viewportsById.values()).filter(\r\n      viewportInfo => viewportInfo.getViewportType() === csEnums.ViewportType.ORTHOGRAPHIC\r\n    ).length;\r\n\r\n    const isEasyResize =\r\n      numStackViewportsInViewportGrid <= MIN_STACK_VIEWPORTS_TO_ENQUEUE_RESIZE &&\r\n      numVolumeViewportsInViewportGrid <= MIN_VOLUME_VIEWPORTS_TO_ENQUEUE_RESIZE;\r\n\r\n    // if there is a grid resize happening, it means the viewport grid\r\n    // has been manipulated (e.g., panels closed, added, etc.) and we need\r\n    // to resize all viewports, so we will add a timeout here to make sure\r\n    // we don't double resize the viewports when viewports in the grid are\r\n    // resized individually\r\n    if (isEasyResize) {\r\n      this.performResize();\r\n      this.resetGridResizeTimeout();\r\n      this.resizeQueue = [];\r\n      clearTimeout(this.viewportResizeTimer);\r\n    } else {\r\n      this.enqueueViewportResizeRequest();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes the viewport from cornerstone, and destroys the rendering engine\r\n   */\r\n  public destroy() {\r\n    this._removeResizeObserver();\r\n    this.viewportGridResizeObserver = null;\r\n    try {\r\n      this.renderingEngine?.destroy?.();\r\n    } catch (e) {\r\n      console.warn('Rendering engine not destroyed', e);\r\n    }\r\n    this.viewportsDisplaySets.clear();\r\n    this.renderingEngine = null;\r\n    cache.purgeCache();\r\n  }\r\n\r\n  /**\r\n   * Disables the viewport inside the renderingEngine, if no viewport is left\r\n   * it destroys the renderingEngine.\r\n   *\r\n   * This is called when the element goes away entirely - with new viewportId's\r\n   * created for every new viewport, this will be called whenever the set of\r\n   * viewports is changed, but NOT when the viewport position changes only.\r\n   *\r\n   * @param viewportId - The viewportId to disable\r\n   */\r\n  public disableElement(viewportId: string): void {\r\n    this.renderingEngine?.disableElement(viewportId);\r\n\r\n    // clean up\r\n    this.viewportsById.delete(viewportId);\r\n    this.viewportsDisplaySets.delete(viewportId);\r\n  }\r\n\r\n  /**\r\n   * Sets the presentations for a given viewport. Presentations is an object\r\n   * that can define the lut or position for a viewport.\r\n   *\r\n   * @param viewportId - The ID of the viewport.\r\n   * @param presentations - The presentations to apply to the viewport.\r\n   * @param viewportInfo - Contains a view reference for immediate application\r\n   */\r\n  public setPresentations(viewportId: string, presentations: Presentations): void {\r\n    const viewport = this.getCornerstoneViewport(viewportId) as\r\n      | Types.IStackViewport\r\n      | Types.IVolumeViewport;\r\n\r\n    if (!viewport || !presentations) {\r\n      return;\r\n    }\r\n\r\n    const { lutPresentation, positionPresentation, segmentationPresentation } = presentations;\r\n\r\n    // Always set the segmentation presentation first, since there might be some\r\n    // lutpresentation states that need to be set on the segmentation\r\n    // Todo: i think we should even await this\r\n    this._setSegmentationPresentation(viewport, segmentationPresentation);\r\n\r\n    this._setLutPresentation(viewport, lutPresentation);\r\n    this._setPositionPresentation(viewport, { ...positionPresentation, viewportId });\r\n  }\r\n\r\n  /**\r\n   * Stores the presentation state for a given viewport inside the\r\n   * each store. This is used to persist the presentation state\r\n   * across different scenarios e.g., when the viewport is changing the\r\n   * display set, or when the viewport is moving to a different layout.\r\n   *\r\n   * @param viewportId The ID of the viewport.\r\n   */\r\n  public storePresentation({ viewportId }) {\r\n    const presentationIds = this.getPresentationIds(viewportId);\r\n    const { syncGroupService } = this.servicesManager.services;\r\n    const synchronizers = syncGroupService.getSynchronizersForViewport(viewportId);\r\n\r\n    if (!presentationIds || Object.keys(presentationIds).length === 0) {\r\n      return null;\r\n    }\r\n\r\n    const { lutPresentationId, positionPresentationId, segmentationPresentationId } =\r\n      presentationIds;\r\n\r\n    const positionPresentation = this._getPositionPresentation(viewportId);\r\n    const lutPresentation = this._getLutPresentation(viewportId);\r\n    const segmentationPresentation = this._getSegmentationPresentation(viewportId);\r\n\r\n    const { setLutPresentation } = useLutPresentationStore.getState();\r\n    const { setPositionPresentation } = usePositionPresentationStore.getState();\r\n    const { setSynchronizers } = useSynchronizersStore.getState();\r\n    const { setSegmentationPresentation } = useSegmentationPresentationStore.getState();\r\n\r\n    if (lutPresentationId) {\r\n      setLutPresentation(lutPresentationId, lutPresentation);\r\n    }\r\n\r\n    if (positionPresentationId) {\r\n      setPositionPresentation(positionPresentationId, positionPresentation);\r\n    }\r\n\r\n    if (segmentationPresentationId) {\r\n      setSegmentationPresentation(segmentationPresentationId, segmentationPresentation);\r\n    }\r\n\r\n    if (synchronizers?.length) {\r\n      setSynchronizers(\r\n        viewportId,\r\n        synchronizers.map(synchronizer => ({\r\n          id: synchronizer.id,\r\n          sourceViewports: [...synchronizer.getSourceViewports()],\r\n          targetViewports: [...synchronizer.getTargetViewports()],\r\n        }))\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retrieves the presentations for a given viewport.\r\n   * @param viewportId - The ID of the viewport.\r\n   * @returns The presentations for the viewport.\r\n   */\r\n  public getPresentations(viewportId: string): Presentations {\r\n    const positionPresentation = this._getPositionPresentation(viewportId);\r\n    const lutPresentation = this._getLutPresentation(viewportId);\r\n    const segmentationPresentation = this._getSegmentationPresentation(viewportId);\r\n\r\n    return {\r\n      positionPresentation,\r\n      lutPresentation,\r\n      segmentationPresentation,\r\n    };\r\n  }\r\n\r\n  private getPresentationIds(viewportId: string): AppTypes.PresentationIds | null {\r\n    const viewportInfo = this.viewportsById.get(viewportId);\r\n    if (!viewportInfo) {\r\n      return null;\r\n    }\r\n\r\n    return viewportInfo.getPresentationIds();\r\n  }\r\n\r\n  private _getPositionPresentation(viewportId: string): PositionPresentation {\r\n    const csViewport = this.getCornerstoneViewport(viewportId);\r\n    if (!csViewport) {\r\n      return;\r\n    }\r\n\r\n    const viewportInfo = this.viewportsById.get(viewportId);\r\n\r\n    return {\r\n      viewportType: viewportInfo.getViewportType(),\r\n      viewReference: csViewport instanceof VolumeViewport3D ? null : csViewport.getViewReference(),\r\n      viewPresentation: csViewport.getViewPresentation({ pan: true, zoom: true }),\r\n      viewportId,\r\n    };\r\n  }\r\n\r\n  private _getLutPresentation(viewportId: string): LutPresentation {\r\n    const csViewport = this.getCornerstoneViewport(viewportId) as\r\n      | Types.IStackViewport\r\n      | Types.IVolumeViewport;\r\n\r\n    if (!csViewport) {\r\n      return;\r\n    }\r\n\r\n    const cleanProperties = properties => {\r\n      if (properties?.isComputedVOI) {\r\n        delete properties?.voiRange;\r\n        delete properties?.VOILUTFunction;\r\n      }\r\n      return properties;\r\n    };\r\n\r\n    const properties =\r\n      csViewport instanceof BaseVolumeViewport\r\n        ? new Map()\r\n        : cleanProperties(csViewport.getProperties());\r\n\r\n    if (properties instanceof Map) {\r\n      const volumeIds = (csViewport as Types.IBaseVolumeViewport).getAllVolumeIds();\r\n      volumeIds?.forEach(volumeId => {\r\n        const csProps = cleanProperties(csViewport.getProperties(volumeId));\r\n        properties.set(volumeId, csProps);\r\n      });\r\n    }\r\n\r\n    const viewportInfo = this.viewportsById.get(viewportId);\r\n\r\n    return {\r\n      viewportType: viewportInfo.getViewportType(),\r\n      properties,\r\n    };\r\n  }\r\n\r\n  private _getSegmentationPresentation(viewportId: string): SegmentationPresentation {\r\n    const { segmentationService } = this.servicesManager.services;\r\n\r\n    const presentation = segmentationService.getPresentation(viewportId);\r\n    return presentation;\r\n  }\r\n\r\n  /**\r\n   * Sets the viewport data for a viewport.\r\n   * @param viewportId - The ID of the viewport to set the data for.\r\n   * @param viewportData - The viewport data to set.\r\n   * @param publicViewportOptions - The public viewport options.\r\n   * @param publicDisplaySetOptions - The public display set options.\r\n   * @param presentations - The presentations to set.\r\n   */\r\n  public setViewportData(\r\n    viewportId: string,\r\n    viewportData: StackViewportData | VolumeViewportData,\r\n    publicViewportOptions: PublicViewportOptions,\r\n    publicDisplaySetOptions: DisplaySetOptions[],\r\n    presentations?: Presentations\r\n  ): void {\r\n    const renderingEngine = this.getRenderingEngine();\r\n\r\n    // if not valid viewportData then return early\r\n    if (viewportData.viewportType === csEnums.ViewportType.STACK) {\r\n      // check if imageIds is valid\r\n      if (!viewportData.data[0].imageIds?.length) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    // This is the old viewportInfo, which may have old options but we might be\r\n    // using its viewport (same viewportId as the new viewportInfo)\r\n    const viewportInfo = this.viewportsById.get(viewportId);\r\n\r\n    // We should store the presentation for the current viewport since we can't only\r\n    // rely to store it WHEN the viewport is disabled since we might keep around the\r\n    // same viewport/element and just change the viewportData for it (drag and drop etc.)\r\n    // the disableElement storePresentation handle would not be called in this case\r\n    // and we would lose the presentation.\r\n    this.storePresentation({ viewportId: viewportInfo.getViewportId() });\r\n\r\n    if (!viewportInfo) {\r\n      throw new Error('element is not enabled for the given viewportId');\r\n    }\r\n\r\n    // override the viewportOptions and displaySetOptions with the public ones\r\n    // since those are the newly set ones, we set them here so that it handles defaults\r\n    const displaySetOptions = viewportInfo.setPublicDisplaySetOptions(publicDisplaySetOptions);\r\n    // Specify an over-ride for the viewport type, even though it is in the public\r\n    // viewport options, because the one in the viewportData is a requirement based on the\r\n    // type of data being displayed.\r\n    const viewportOptions = viewportInfo.setPublicViewportOptions(\r\n      publicViewportOptions,\r\n      viewportData.viewportType\r\n    );\r\n\r\n    const element = viewportInfo.getElement();\r\n    const type = viewportInfo.getViewportType();\r\n    const background = viewportInfo.getBackground();\r\n    const orientation = viewportInfo.getOrientation();\r\n    const displayArea = viewportInfo.getDisplayArea();\r\n\r\n    const viewportInput: Types.PublicViewportInput = {\r\n      viewportId,\r\n      element,\r\n      type,\r\n      defaultOptions: {\r\n        background,\r\n        orientation,\r\n        displayArea,\r\n      },\r\n    };\r\n\r\n    // Rendering Engine Id set should happen before enabling the element\r\n    // since there are callbacks that depend on the renderingEngine id\r\n    // Todo: however, this is a limitation which means that we can't change\r\n    // the rendering engine id for a given viewport which might be a super edge\r\n    // case\r\n    viewportInfo.setRenderingEngineId(renderingEngine.id);\r\n\r\n    // Todo: this is not optimal at all, we are re-enabling the already enabled\r\n    // element which is not what we want. But enabledElement as part of the\r\n    // renderingEngine is designed to be used like this. This will trigger\r\n    // ENABLED_ELEMENT again and again, which will run onEnableElement callbacks\r\n    renderingEngine.enableElement(viewportInput);\r\n\r\n    viewportInfo.setViewportOptions(viewportOptions);\r\n    viewportInfo.setDisplaySetOptions(displaySetOptions);\r\n    viewportInfo.setViewportData(viewportData);\r\n    viewportInfo.setViewportId(viewportId);\r\n\r\n    this.viewportsById.set(viewportId, viewportInfo);\r\n\r\n    const viewport = renderingEngine.getViewport(viewportId);\r\n    const displaySetPromise = this._setDisplaySets(\r\n      viewport,\r\n      viewportData,\r\n      viewportInfo,\r\n      presentations\r\n    );\r\n\r\n    // The broadcast event here ensures that listeners have a valid, up to date\r\n    // viewport to access.  Doing it too early can result in exceptions or\r\n    // invalid data.\r\n    displaySetPromise.then(() => {\r\n      this._broadcastEvent(this.EVENTS.VIEWPORT_DATA_CHANGED, {\r\n        viewportData,\r\n        viewportId,\r\n      });\r\n    });\r\n  }\r\n\r\n  public getViewportOptions(viewportId: string): ViewportOptions {\r\n    return this.viewportsById.get(viewportId).getViewportOptions();\r\n  }\r\n\r\n  /**\r\n   * Retrieves the Cornerstone viewport with the specified ID.\r\n   *\r\n   * @param viewportId - The ID of the viewport.\r\n   * @returns The Cornerstone viewport object if found, otherwise null.\r\n   */\r\n  public getCornerstoneViewport(viewportId: string): Types.IViewport | null {\r\n    const viewportInfo = this.getViewportInfo(viewportId);\r\n\r\n    if (!viewportInfo || !this.renderingEngine || this.renderingEngine.hasBeenDestroyed) {\r\n      return null;\r\n    }\r\n\r\n    const viewport = this.renderingEngine.getViewport(viewportId);\r\n\r\n    return viewport;\r\n  }\r\n\r\n  /**\r\n   * Retrieves the viewport information for a given viewport ID. The viewport information\r\n   * is the OHIF construct that holds different options and data for a given viewport and\r\n   * is different from the cornerstone viewport.\r\n   *\r\n   * @param viewportId The ID of the viewport.\r\n   * @returns The viewport information.\r\n   */\r\n  public getViewportInfo(viewportId: string): ViewportInfo {\r\n    return this.viewportsById.get(viewportId);\r\n  }\r\n\r\n  public getOrientation(viewportId: string): string {\r\n    const viewportInfo = this.getViewportInfo(viewportId);\r\n    return viewportInfo.getOrientation();\r\n  }\r\n\r\n  /**\r\n   * Looks through the viewports to see if the specified measurement can be\r\n   * displayed in one of the viewports. This function tries to get a \"best fit\"\r\n   * viewport to display the image in where it matches, in order:\r\n   *   * Active viewport that can be navigated to the given image without orientation change\r\n   *   * Other viewport that can be navigated to the given image without orientation change\r\n   *   * Active viewport that can change orientation to display the image\r\n   *   * Other viewport that can change orientation to display the image\r\n   *\r\n   * It returns `null` otherwise, indicating that a viewport needs display set/type\r\n   * changes in order to display the image.\r\n   *\r\n   * Notes:\r\n   *   * If the display set is displayed in multiple viewports all needing orientation change,\r\n   *     then the active one or first one listed will be modified.  This can create unexpected\r\n   *     behaviour for MPR views.\r\n   *   * If the image is contained in multiple display sets, then the first one\r\n   *     found will be navigated (active first, followed by first found)\r\n   *\r\n   * @param measurement - The measurement that is desired to view.\r\n   * @param activeViewportId - the index that was active at the time the jump\r\n   *          was initiated.\r\n   * @return the viewportId that the measurement should be displayed in.\r\n   */\r\n  public getViewportIdToJump(activeViewportId: string, metadata): string {\r\n    // First check if the active viewport can just be navigated to show the given item\r\n    const activeViewport = this.getCornerstoneViewport(activeViewportId);\r\n    if (activeViewport.isReferenceViewable(metadata, { withNavigation: true })) {\r\n      return activeViewportId;\r\n    }\r\n\r\n    // Next, see if any viewport could be navigated to show the given item,\r\n    // without considering orientation changes.\r\n    for (const id of this.viewportsById.keys()) {\r\n      const viewport = this.getCornerstoneViewport(id);\r\n      if (viewport?.isReferenceViewable(metadata, { withNavigation: true })) {\r\n        return id;\r\n      }\r\n    }\r\n\r\n    // No viewport is in the right display set/orientation to show this, so see if\r\n    // the active viewport could change orientations to show this\r\n    if (\r\n      activeViewport.isReferenceViewable(metadata, { withNavigation: true, withOrientation: true })\r\n    ) {\r\n      return activeViewportId;\r\n    }\r\n\r\n    // See if any viewport could show this with an orientation change\r\n    for (const id of this.viewportsById.keys()) {\r\n      const viewport = this.getCornerstoneViewport(id);\r\n      if (\r\n        viewport?.isReferenceViewable(metadata, { withNavigation: true, withOrientation: true })\r\n      ) {\r\n        return id;\r\n      }\r\n    }\r\n\r\n    // No luck, need to update the viewport itself\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Sets the image data for the given viewport.\r\n   */\r\n  private async _setOtherViewport(\r\n    viewport: Types.IStackViewport,\r\n    viewportData: StackViewportData,\r\n    viewportInfo: ViewportInfo,\r\n    _presentations: Presentations = {}\r\n  ): Promise<void> {\r\n    const [displaySet] = viewportData.data;\r\n    return viewport.setDataIds(displaySet.imageIds, {\r\n      groupId: displaySet.displaySetInstanceUID,\r\n      viewReference: viewportInfo.getViewReference(),\r\n    });\r\n  }\r\n\r\n  private async _setStackViewport(\r\n    viewport: Types.IStackViewport,\r\n    viewportData: StackViewportData,\r\n    viewportInfo: ViewportInfo,\r\n    presentations: Presentations = {}\r\n  ): Promise<void> {\r\n    const displaySetOptions = viewportInfo.getDisplaySetOptions();\r\n\r\n    const displaySetInstanceUIDs = viewportData.data.map(data => data.displaySetInstanceUID);\r\n\r\n    // based on the cache service construct always the first one is the non-overlay\r\n    // and the rest are overlays\r\n\r\n    this.viewportsDisplaySets.set(viewport.id, [...displaySetInstanceUIDs]);\r\n\r\n    const { initialImageIndex, imageIds } = viewportData.data[0];\r\n\r\n    // Use the slice index from any provided view reference, as the view reference\r\n    // is being used to navigate to the initial view position for measurement\r\n    // navigation and other navigation forcing specific views.\r\n    let initialImageIndexToUse =\r\n      presentations?.positionPresentation?.initialImageIndex ?? initialImageIndex;\r\n\r\n    const { rotation, flipHorizontal, displayArea } = viewportInfo.getViewportOptions();\r\n\r\n    const properties = { ...presentations.lutPresentation?.properties };\r\n    if (!presentations.lutPresentation?.properties) {\r\n      const { voi, voiInverted, colormap } = displaySetOptions[0];\r\n      if (voi && (voi.windowWidth || voi.windowCenter)) {\r\n        const { lower, upper } = csUtils.windowLevel.toLowHighRange(\r\n          voi.windowWidth,\r\n          voi.windowCenter\r\n        );\r\n        properties.voiRange = { lower, upper };\r\n      }\r\n\r\n      properties.invert = voiInverted ?? properties.invert;\r\n      properties.colormap = colormap ?? properties.colormap;\r\n    }\r\n\r\n    viewport.element.addEventListener(csEnums.Events.VIEWPORT_NEW_IMAGE_SET, evt => {\r\n      const { element } = evt.detail;\r\n\r\n      if (element !== viewport.element) {\r\n        return;\r\n      }\r\n\r\n      csToolsUtils.stackContextPrefetch.enable(element);\r\n    });\r\n\r\n    let imageIdsToSet = imageIds;\r\n    const overlayProcessingResult = this._processExtraDisplaySetsForViewport(viewport);\r\n    imageIdsToSet = overlayProcessingResult?.imageIds ?? imageIdsToSet;\r\n\r\n    const referencedImageId = presentations?.positionPresentation?.viewReference?.referencedImageId;\r\n    if (referencedImageId) {\r\n      initialImageIndexToUse = imageIdsToSet.indexOf(referencedImageId);\r\n    }\r\n\r\n    if (initialImageIndexToUse === undefined || initialImageIndexToUse === null) {\r\n      initialImageIndexToUse = this._getInitialImageIndexForViewport(viewportInfo, imageIds) || 0;\r\n    }\r\n\r\n    return viewport.setStack(imageIdsToSet, initialImageIndexToUse).then(() => {\r\n      viewport.setProperties({ ...properties });\r\n      this.setPresentations(viewport.id, presentations, viewportInfo);\r\n\r\n      if (overlayProcessingResult?.addOverlayFn) {\r\n        overlayProcessingResult.addOverlayFn();\r\n      }\r\n\r\n      if (displayArea) {\r\n        viewport.setDisplayArea(displayArea);\r\n      }\r\n      if (rotation) {\r\n        viewport.setProperties({ rotation });\r\n      }\r\n      if (flipHorizontal) {\r\n        viewport.setCamera({ flipHorizontal: true });\r\n      }\r\n    });\r\n  }\r\n\r\n  private _getInitialImageIndexForViewport(\r\n    viewportInfo: ViewportInfo,\r\n    imageIds?: string[]\r\n  ): number {\r\n    const initialImageOptions = viewportInfo.getInitialImageOptions();\r\n    if (!initialImageOptions) {\r\n      return;\r\n    }\r\n    const { index, preset } = initialImageOptions;\r\n    const viewportType = viewportInfo.getViewportType();\r\n\r\n    let numberOfSlices;\r\n    if (viewportType === csEnums.ViewportType.STACK) {\r\n      numberOfSlices = imageIds.length;\r\n    } else if (viewportType === csEnums.ViewportType.ORTHOGRAPHIC) {\r\n      const viewport = this.getCornerstoneViewport(viewportInfo.getViewportId());\r\n      const imageSliceData = csUtils.getImageSliceDataForVolumeViewport(viewport);\r\n\r\n      if (!imageSliceData) {\r\n        return;\r\n      }\r\n\r\n      ({ numberOfSlices } = imageSliceData);\r\n    } else {\r\n      return;\r\n    }\r\n\r\n    return this._getInitialImageIndex(numberOfSlices, index, preset);\r\n  }\r\n\r\n  _getInitialImageIndex(numberOfSlices: number, imageIndex?: number, preset?: JumpPresets): number {\r\n    const lastSliceIndex = numberOfSlices - 1;\r\n\r\n    if (imageIndex !== undefined) {\r\n      return csUtils.clip(imageIndex, 0, lastSliceIndex);\r\n    }\r\n\r\n    if (preset === JumpPresets.First) {\r\n      return 0;\r\n    }\r\n\r\n    if (preset === JumpPresets.Last) {\r\n      return lastSliceIndex;\r\n    }\r\n\r\n    if (preset === JumpPresets.Middle) {\r\n      // Note: this is a simple but yet very important formula.\r\n      // since viewport reset works with the middle slice\r\n      // if the below formula is not correct, on a viewport reset\r\n      // it will jump to a different slice than the middle one which\r\n      // was the initial slice, and we have some tools such as Crosshairs\r\n      // which rely on a relative camera modifications and those will break.\r\n      return lastSliceIndex % 2 === 0 ? lastSliceIndex / 2 : (lastSliceIndex + 1) / 2;\r\n    }\r\n\r\n    return 0;\r\n  }\r\n\r\n  async _setVolumeViewport(\r\n    viewport: Types.IVolumeViewport,\r\n    viewportData: VolumeViewportData,\r\n    viewportInfo: ViewportInfo,\r\n    presentations: Presentations = {}\r\n  ): Promise<void> {\r\n    // TODO: We need to overhaul the way data sources work so requests can be made\r\n    // async. I think we should follow the image loader pattern which is async and\r\n    // has a cache behind it.\r\n    // The problem is that to set this volume, we need the metadata, but the request is\r\n    // already in-flight, and the promise is not cached, so we have no way to wait for\r\n    // it and know when it has fully arrived.\r\n    // loadStudyMetadata(StudyInstanceUID) => Promise([instances for study])\r\n    // loadSeriesMetadata(StudyInstanceUID, SeriesInstanceUID) => Promise([instances for series])\r\n    // If you call loadStudyMetadata and it's not in the DicomMetadataStore cache, it should fire\r\n    // a request through the data source?\r\n    // (This call may or may not create sub-requests for series metadata)\r\n    const { displaySetService } = this.servicesManager.services;\r\n    const volumeInputArray = [];\r\n    const displaySetOptionsArray = viewportInfo.getDisplaySetOptions();\r\n    const { hangingProtocolService } = this.servicesManager.services;\r\n\r\n    const volumeToLoad = [];\r\n    const displaySetInstanceUIDs = [];\r\n\r\n    for (const [index, data] of viewportData.data.entries()) {\r\n      const { imageIds, displaySetInstanceUID } = data;\r\n      let volume = data.volume;\r\n\r\n      const displaySet = displaySetService.getDisplaySetByUID(displaySetInstanceUID);\r\n      if (!volume && displaySet.images) {\r\n        volume = csToolsUtils.getOrCreateImageVolume(displaySet.images.map(image => image.imageId));\r\n      }\r\n\r\n      displaySetInstanceUIDs.push(displaySetInstanceUID);\r\n\r\n      if (!volume) {\r\n        console.log('Volume display set not found');\r\n        continue;\r\n      }\r\n\r\n      volumeToLoad.push(volume);\r\n\r\n      const displaySetOptions = displaySetOptionsArray[index];\r\n      const { volumeId } = volume;\r\n      volumeInputArray.push({\r\n        imageIds,\r\n        volumeId,\r\n        modality: displaySet.Modality,\r\n        displaySetInstanceUID,\r\n        blendMode: displaySetOptions.blendMode,\r\n        slabThickness: this._getSlabThickness(displaySetOptions, volumeId),\r\n      });\r\n    }\r\n\r\n    this.viewportsDisplaySets.set(viewport.id, displaySetInstanceUIDs);\r\n\r\n    const volumesNotLoaded = volumeToLoad.filter(volume => !volume.loadStatus?.loaded);\r\n    if (volumesNotLoaded.length) {\r\n      if (hangingProtocolService.getShouldPerformCustomImageLoad()) {\r\n        // delegate the volume loading to the hanging protocol service if it has a custom image load strategy\r\n        return hangingProtocolService.runImageLoadStrategy({\r\n          viewportId: viewport.id,\r\n          volumeInputArray,\r\n        });\r\n      }\r\n\r\n      volumesNotLoaded.forEach(volume => {\r\n        if (!volume.loadStatus?.loading && volume.load instanceof Function) {\r\n          volume.load();\r\n        }\r\n      });\r\n    }\r\n\r\n    // It's crucial not to return here because the volume may be loaded,\r\n    // but the viewport also needs to set the volume.\r\n    // if (!volumesNotLoaded.length) {\r\n    //   return;\r\n    // }\r\n\r\n    // This returns the async continuation only\r\n    return this.setVolumesForViewport(viewport, volumeInputArray, presentations);\r\n  }\r\n\r\n  public async setVolumesForViewport(viewport, volumeInputArray, presentations) {\r\n    const { displaySetService, viewportGridService } = this.servicesManager.services;\r\n\r\n    const viewportInfo = this.getViewportInfo(viewport.id);\r\n    const displaySetOptions = viewportInfo.getDisplaySetOptions();\r\n    const displaySetUIDs = viewportGridService.getDisplaySetsUIDsForViewport(viewport.id);\r\n    const displaySet = displaySetService.getDisplaySetByUID(displaySetUIDs[0]);\r\n    const displaySetModality = displaySet?.Modality;\r\n\r\n    // filter overlay display sets (e.g. segmentation) since they will get handled below via the segmentation service\r\n    const filteredVolumeInputArray = volumeInputArray.filter(volumeInput => {\r\n      const displaySet = displaySetService.getDisplaySetByUID(volumeInput.displaySetInstanceUID);\r\n      return !displaySet?.isOverlayDisplaySet;\r\n    });\r\n\r\n    // Todo: use presentations states\r\n    const volumesProperties = filteredVolumeInputArray.map((volumeInput, index) => {\r\n      const { volumeId } = volumeInput;\r\n      const displaySetOption = displaySetOptions[index];\r\n      const { voi, voiInverted, colormap, displayPreset } = displaySetOption;\r\n      const properties = {} as ViewportProperties;\r\n\r\n      if (voi && (voi.windowWidth || voi.windowCenter)) {\r\n        const { lower, upper } = csUtils.windowLevel.toLowHighRange(\r\n          voi.windowWidth,\r\n          voi.windowCenter\r\n        );\r\n        properties.voiRange = { lower, upper };\r\n      }\r\n\r\n      if (voiInverted !== undefined) {\r\n        properties.invert = voiInverted;\r\n      }\r\n\r\n      if (colormap !== undefined) {\r\n        properties.colormap = colormap;\r\n      }\r\n\r\n      if (displayPreset !== undefined) {\r\n        properties.preset = displayPreset[displaySetModality] || displayPreset.default;\r\n      }\r\n\r\n      return { properties, volumeId };\r\n    });\r\n\r\n    // For SEG and RT viewports\r\n    const { addOverlayFn, imageIds } = this._processExtraDisplaySetsForViewport(viewport) || {};\r\n\r\n    if (!filteredVolumeInputArray.length && addOverlayFn) {\r\n      // if there is no volume input array, and there is an addOverlayFn, means we need to take\r\n      // care of the background overlay display set first then the addOverlayFn will add the\r\n      // SEG displaySet\r\n      const sampleImageId = imageIds[0];\r\n      const backgroundDisplaySet = displaySetService.getDisplaySetsBy(\r\n        displaySet =>\r\n          !displaySet.isOverlayDisplaySet &&\r\n          displaySet.images.some(image => image.imageId === sampleImageId)\r\n      );\r\n\r\n      if (backgroundDisplaySet.length !== 1) {\r\n        throw new Error('Background display set not found');\r\n      }\r\n\r\n      await viewport.setVolumes([\r\n        { volumeId: `${VOLUME_LOADER_SCHEME}:${backgroundDisplaySet[0].displaySetInstanceUID}` },\r\n      ]);\r\n    } else {\r\n      await viewport.setVolumes(filteredVolumeInputArray);\r\n    }\r\n\r\n    if (addOverlayFn) {\r\n      addOverlayFn();\r\n    }\r\n    viewport.render();\r\n\r\n    volumesProperties.forEach(({ properties, volumeId }) => {\r\n      setTimeout(() => {\r\n        // seems like a hack but we need the actor to be ready first before\r\n        // we set the properties\r\n        viewport.setProperties(properties, volumeId);\r\n        viewport.render();\r\n      }, 0);\r\n    });\r\n\r\n    this.setPresentations(viewport.id, presentations, viewportInfo);\r\n\r\n    if (!presentations.positionPresentation) {\r\n      const imageIndex = this._getInitialImageIndexForViewport(viewportInfo);\r\n\r\n      if (imageIndex !== undefined) {\r\n        csUtils.jumpToSlice(viewport.element, {\r\n          imageIndex,\r\n        });\r\n      }\r\n    }\r\n\r\n    this._broadcastEvent(this.EVENTS.VIEWPORT_VOLUMES_CHANGED, {\r\n      viewportInfo,\r\n    });\r\n  }\r\n\r\n  private _processExtraDisplaySetsForViewport(\r\n    viewport: Types.IStackViewport | Types.IVolumeViewport\r\n  ) {\r\n    const { displaySetService } = this.servicesManager.services;\r\n\r\n    // load any secondary displaySets\r\n    const displaySetInstanceUIDs = this.viewportsDisplaySets.get(viewport.id);\r\n\r\n    // Find overlay display sets (e.g. SEG, RTSTRUCT)\r\n    const overlayDisplaySet = displaySetInstanceUIDs\r\n      .map(displaySetService.getDisplaySetByUID)\r\n      .find(displaySet => displaySet?.isOverlayDisplaySet);\r\n\r\n    // if it is only the overlay displaySet, then we need to get the reference\r\n    // displaySet imageIds and set them as the imageIds for the viewport,\r\n    // here we can do some logic if the reference is missing\r\n    // then find the most similar match of displaySet instead\r\n    if (!overlayDisplaySet) {\r\n      return;\r\n    }\r\n\r\n    let imageIds;\r\n    if (overlayDisplaySet.referencedDisplaySetInstanceUID) {\r\n      const referenceDisplaySet = displaySetService.getDisplaySetByUID(\r\n        overlayDisplaySet.referencedDisplaySetInstanceUID\r\n      );\r\n      imageIds = referenceDisplaySet.images.map(image => image.imageId);\r\n    }\r\n\r\n    return {\r\n      imageIds,\r\n      addOverlayFn: () => this.addOverlayRepresentationForDisplaySet(overlayDisplaySet, viewport),\r\n    };\r\n  }\r\n\r\n  private addOverlayRepresentationForDisplaySet(\r\n    displaySet: OhifTypes.DisplaySet,\r\n    viewport: Types.IViewport\r\n  ) {\r\n    const { segmentationService } = this.servicesManager.services;\r\n    const segmentationId = displaySet.displaySetInstanceUID;\r\n\r\n    const representationType =\r\n      displaySet.Modality === 'SEG'\r\n        ? csToolsEnums.SegmentationRepresentations.Labelmap\r\n        : csToolsEnums.SegmentationRepresentations.Contour;\r\n\r\n    segmentationService.addSegmentationRepresentation(viewport.id, {\r\n      segmentationId,\r\n      type: representationType,\r\n    });\r\n\r\n    // store the segmentation presentation id in the viewport info\r\n    this.storePresentation({ viewportId: viewport.id });\r\n  }\r\n\r\n  // Todo: keepCamera is an interim solution until we have a better solution for\r\n  // keeping the camera position when the viewport data is changed\r\n  public updateViewport(viewportId: string, viewportData, keepCamera = false) {\r\n    const viewportInfo = this.getViewportInfo(viewportId);\r\n    const viewport = this.getCornerstoneViewport(viewportId);\r\n    const viewportCamera = viewport.getCamera();\r\n\r\n    let displaySetPromise;\r\n\r\n    if (viewport instanceof VolumeViewport || viewport instanceof VolumeViewport3D) {\r\n      displaySetPromise = this._setVolumeViewport(viewport, viewportData, viewportInfo).then(() => {\r\n        if (keepCamera) {\r\n          viewport.setCamera(viewportCamera);\r\n          viewport.render();\r\n        }\r\n      });\r\n    }\r\n\r\n    if (viewport instanceof StackViewport) {\r\n      displaySetPromise = this._setStackViewport(viewport, viewportData, viewportInfo);\r\n    }\r\n\r\n    displaySetPromise.then(() => {\r\n      this._broadcastEvent(this.EVENTS.VIEWPORT_DATA_CHANGED, {\r\n        viewportData,\r\n        viewportId,\r\n      });\r\n    });\r\n  }\r\n\r\n  _setDisplaySets(\r\n    viewport: Types.IViewport,\r\n    viewportData: StackViewportData | VolumeViewportData,\r\n    viewportInfo: ViewportInfo,\r\n    presentations: Presentations = {}\r\n  ): Promise<void> {\r\n    if (viewport instanceof StackViewport) {\r\n      return this._setStackViewport(\r\n        viewport,\r\n        viewportData as StackViewportData,\r\n        viewportInfo,\r\n        presentations\r\n      );\r\n    }\r\n\r\n    if ([VolumeViewport, VolumeViewport3D].some(type => viewport instanceof type)) {\r\n      return this._setVolumeViewport(\r\n        viewport as Types.IVolumeViewport,\r\n        viewportData as VolumeViewportData,\r\n        viewportInfo,\r\n        presentations\r\n      );\r\n    }\r\n\r\n    return this._setOtherViewport(\r\n      viewport,\r\n      viewportData as StackViewportData,\r\n      viewportInfo,\r\n      presentations\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Removes the resize observer from the viewport element\r\n   */\r\n  _removeResizeObserver() {\r\n    if (this.viewportGridResizeObserver) {\r\n      this.viewportGridResizeObserver.disconnect();\r\n    }\r\n  }\r\n\r\n  _getSlabThickness(displaySetOptions, volumeId) {\r\n    const { blendMode } = displaySetOptions;\r\n    if (blendMode === undefined || displaySetOptions.slabThickness === undefined) {\r\n      return;\r\n    }\r\n\r\n    // if there is a slabThickness set as a number then use it\r\n    if (typeof displaySetOptions.slabThickness === 'number') {\r\n      return displaySetOptions.slabThickness;\r\n    }\r\n\r\n    if (displaySetOptions.slabThickness.toLowerCase() === 'fullvolume') {\r\n      // calculate the slab thickness based on the volume dimensions\r\n      const imageVolume = cache.getVolume(volumeId);\r\n\r\n      const { dimensions, spacing } = imageVolume;\r\n      const slabThickness = Math.sqrt(\r\n        Math.pow(dimensions[0] * spacing[0], 2) +\r\n          Math.pow(dimensions[1] * spacing[1], 2) +\r\n          Math.pow(dimensions[2] * spacing[2], 2)\r\n      );\r\n\r\n      return slabThickness;\r\n    }\r\n  }\r\n\r\n  _getFrameOfReferenceUID(displaySetInstanceUID) {\r\n    const { displaySetService } = this.servicesManager.services;\r\n    const displaySet = displaySetService.getDisplaySetByUID(displaySetInstanceUID);\r\n\r\n    if (!displaySet) {\r\n      return;\r\n    }\r\n\r\n    if (displaySet.frameOfReferenceUID) {\r\n      return displaySet.frameOfReferenceUID;\r\n    }\r\n\r\n    if (displaySet.Modality === 'SEG') {\r\n      const { instance } = displaySet;\r\n      return instance.FrameOfReferenceUID;\r\n    }\r\n\r\n    if (displaySet.Modality === 'RTSTRUCT') {\r\n      const { instance } = displaySet;\r\n      return instance.ReferencedFrameOfReferenceSequence.FrameOfReferenceUID;\r\n    }\r\n\r\n    const { images } = displaySet;\r\n    if (images && images.length) {\r\n      return images[0].FrameOfReferenceUID;\r\n    }\r\n  }\r\n\r\n  private enqueueViewportResizeRequest() {\r\n    this.resizeQueue.push(false); // false indicates viewport resize\r\n\r\n    clearTimeout(this.viewportResizeTimer);\r\n    this.viewportResizeTimer = setTimeout(() => {\r\n      this.processViewportResizeQueue();\r\n    }, this.gridResizeDelay);\r\n  }\r\n\r\n  private processViewportResizeQueue() {\r\n    const isGridResizeInQueue = this.resizeQueue.some(isGridResize => isGridResize);\r\n    if (this.resizeQueue.length > 0 && !isGridResizeInQueue && !this.gridResizeTimeOut) {\r\n      this.performResize();\r\n    }\r\n\r\n    // Clear the queue after processing viewport resizes\r\n    this.resizeQueue = [];\r\n  }\r\n\r\n  private performResize() {\r\n    const isImmediate = false;\r\n\r\n    try {\r\n      const viewports = this.getRenderingEngine().getViewports();\r\n\r\n      // Store the current position presentations for each viewport.\r\n      viewports.forEach(({ id: viewportId }) => {\r\n        const presentation = this._getPositionPresentation(viewportId);\r\n\r\n        // During a resize, the slice index should remain unchanged. This is a temporary fix for\r\n        // a larger issue regarding the definition of slice index with slab thickness.\r\n        // We need to revisit this to make it more robust and understandable.\r\n        delete presentation.viewReference?.sliceIndex;\r\n        this.beforeResizePositionPresentations.set(viewportId, presentation);\r\n      });\r\n\r\n      // Resize the rendering engine and render.\r\n      const renderingEngine = this.renderingEngine;\r\n      renderingEngine.resize(isImmediate);\r\n      renderingEngine.render();\r\n\r\n      // Reset the camera for all viewports using position presentation to maintain relative size/position\r\n      // which means only those viewports that have a zoom level of 1.\r\n      this.beforeResizePositionPresentations.forEach((positionPresentation, viewportId) => {\r\n        this.setPresentations(viewportId, {\r\n          positionPresentation,\r\n        });\r\n      });\r\n\r\n      // Resize and render the rendering engine again.\r\n      renderingEngine.resize(isImmediate);\r\n      renderingEngine.render();\r\n    } catch (e) {\r\n      // This can happen if the resize is too close to navigation or shutdown\r\n      console.warn('Caught resize exception', e);\r\n    }\r\n  }\r\n\r\n  private resetGridResizeTimeout() {\r\n    clearTimeout(this.gridResizeTimeOut);\r\n    this.gridResizeTimeOut = setTimeout(() => {\r\n      this.gridResizeTimeOut = null;\r\n    }, this.gridResizeDelay);\r\n  }\r\n\r\n  private _setLutPresentation(\r\n    viewport: Types.IStackViewport | Types.IVolumeViewport,\r\n    lutPresentation: LutPresentation\r\n  ): void {\r\n    if (!lutPresentation) {\r\n      return;\r\n    }\r\n\r\n    const { properties } = lutPresentation;\r\n    if (viewport instanceof BaseVolumeViewport) {\r\n      if (properties instanceof Map) {\r\n        properties.forEach((propertiesEntry, volumeId) => {\r\n          viewport.setProperties(propertiesEntry, volumeId);\r\n        });\r\n      } else {\r\n        viewport.setProperties(properties);\r\n      }\r\n    } else {\r\n      viewport.setProperties(properties);\r\n    }\r\n  }\r\n\r\n  private _setPositionPresentation(\r\n    viewport: Types.IStackViewport | Types.IVolumeViewport,\r\n    positionPresentation: PositionPresentation\r\n  ): void {\r\n    const viewRef = positionPresentation?.viewReference;\r\n    if (viewRef) {\r\n      if (viewport.isReferenceViewable(viewRef, WITH_NAVIGATION)) {\r\n        viewport.setViewReference(viewRef);\r\n      } else {\r\n        console.warn('Unable to apply reference viewable', viewRef);\r\n      }\r\n    }\r\n\r\n    const viewPresentation = positionPresentation?.viewPresentation;\r\n    if (viewPresentation) {\r\n      viewport.setViewPresentation(viewPresentation);\r\n    }\r\n  }\r\n\r\n  private _setSegmentationPresentation(\r\n    viewport: Types.IStackViewport | Types.IVolumeViewport,\r\n    segmentationPresentation: SegmentationPresentation\r\n  ): void {\r\n    if (!segmentationPresentation) {\r\n      return;\r\n    }\r\n\r\n    const { segmentationService } = this.servicesManager.services;\r\n\r\n    segmentationPresentation.forEach((presentationItem: SegmentationPresentationItem) => {\r\n      const { segmentationId, type, hydrated } = presentationItem;\r\n\r\n      if (hydrated) {\r\n        segmentationService.addSegmentationRepresentation(viewport.id, {\r\n          segmentationId,\r\n          type,\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Gets the display sets for a given viewport\r\n   * @param viewportId - The ID of the viewport to get display sets for\r\n   * @returns Array of display sets for the viewport\r\n   */\r\n  public getViewportDisplaySets(viewportId: string): OhifTypes.DisplaySet[] {\r\n    const { displaySetService } = this.servicesManager.services;\r\n    const displaySetInstanceUIDs = this.viewportsDisplaySets.get(viewportId) || [];\r\n\r\n    return displaySetInstanceUIDs\r\n      .map(uid => displaySetService.getDisplaySetByUID(uid))\r\n      .filter(Boolean);\r\n  }\r\n}\r\n\r\nexport default CornerstoneViewportService;\r\n","import {\r\n  Types,\r\n  Enums,\r\n  getEnabledElementByViewportId,\r\n  VolumeViewport,\r\n  utilities,\r\n} from '@cornerstonejs/core';\r\nimport { StackViewportData, VolumeViewportData } from '../../types/CornerstoneCacheService';\r\nimport getCornerstoneBlendMode from '../../utils/getCornerstoneBlendMode';\r\nimport getCornerstoneOrientation from '../../utils/getCornerstoneOrientation';\r\nimport getCornerstoneViewportType from '../../utils/getCornerstoneViewportType';\r\nimport JumpPresets from '../../utils/JumpPresets';\r\nimport { SyncGroup } from '../SyncGroupService/SyncGroupService';\r\n\r\nexport type InitialImageOptions = {\r\n  index?: number;\r\n  preset?: JumpPresets;\r\n  useOnce?: boolean;\r\n};\r\n\r\nexport type ViewportOptions = {\r\n  id?: string;\r\n  viewportType: Enums.ViewportType;\r\n  toolGroupId: string;\r\n  viewportId: string;\r\n  // Presentation ID to store/load presentation state from\r\n  presentationIds?: AppTypes.PresentationIds;\r\n  orientation?: Enums.OrientationAxis;\r\n  background?: Types.Point3;\r\n  displayArea?: Types.DisplayArea;\r\n  syncGroups?: SyncGroup[];\r\n  initialImageOptions?: InitialImageOptions;\r\n  rotation?: number;\r\n  flipHorizontal?: boolean;\r\n  viewReference?: Types.ViewReference;\r\n  customViewportProps?: Record<string, unknown>;\r\n  /*\r\n   * Allows drag and drop of display sets not matching viewport options, but\r\n   * doesn't show them initially.  Displays initially blank if no required match\r\n   */\r\n  allowUnmatchedView?: boolean;\r\n};\r\n\r\nexport type PublicViewportOptions = {\r\n  id?: string;\r\n  viewportType?: string;\r\n  toolGroupId?: string;\r\n  presentationIds?: string[];\r\n  viewportId?: string;\r\n  orientation?: Enums.OrientationAxis;\r\n  background?: Types.Point3;\r\n  displayArea?: Types.DisplayArea;\r\n  syncGroups?: SyncGroup[];\r\n  rotation?: number;\r\n  flipHorizontal?: boolean;\r\n  initialImageOptions?: InitialImageOptions;\r\n  customViewportProps?: Record<string, unknown>;\r\n  allowUnmatchedView?: boolean;\r\n};\r\n\r\nexport type DisplaySetSelector = {\r\n  id?: string;\r\n  options?: PublicDisplaySetOptions;\r\n};\r\n\r\nexport type PublicDisplaySetOptions = {\r\n  /** The display set options can have an id in order to distinguish\r\n   * it from other similar items.\r\n   */\r\n  id?: string;\r\n  voi?: VOI;\r\n  voiInverted?: boolean;\r\n  blendMode?: string;\r\n  slabThickness?: number;\r\n  colormap?: string;\r\n  displayPreset?: string;\r\n};\r\n\r\nexport type DisplaySetOptions = {\r\n  id?: string;\r\n  voi?: VOI;\r\n  voiInverted: boolean;\r\n  blendMode?: Enums.BlendModes;\r\n  slabThickness?: number;\r\n  colormap?: { name: string; opacity?: number };\r\n  displayPreset?: string;\r\n};\r\n\r\ntype VOI = {\r\n  windowWidth: number;\r\n  windowCenter: number;\r\n};\r\n\r\nexport type DisplaySet = {\r\n  displaySetInstanceUID: string;\r\n};\r\n\r\nconst STACK = 'stack';\r\nconst DEFAULT_TOOLGROUP_ID = 'default';\r\n\r\n// Return true if the data contains the given display set UID OR the imageId\r\n// if it is a composite object.\r\nconst dataContains = ({ data, displaySetUID, imageId, viewport }): boolean => {\r\n  if (imageId && data.isCompositeStack && data.imageIds) {\r\n    return !!data.imageIds.find(dataId => dataId === imageId);\r\n  }\r\n\r\n  if (imageId && (data.volumeId || viewport instanceof VolumeViewport)) {\r\n    const isAcquisition = !!viewport.getCurrentImageId();\r\n\r\n    if (!isAcquisition) {\r\n      return false;\r\n    }\r\n\r\n    const imageURI = utilities.imageIdToURI(imageId);\r\n    const hasImageId = viewport.hasImageURI(imageURI);\r\n\r\n    if (hasImageId) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  if (data.displaySetInstanceUID === displaySetUID) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n};\r\n\r\nclass ViewportInfo {\r\n  private viewportId = '';\r\n  private element: HTMLDivElement;\r\n  private viewportOptions: ViewportOptions;\r\n  private displaySetOptions: Array<DisplaySetOptions>;\r\n  private viewportData: StackViewportData | VolumeViewportData;\r\n  private renderingEngineId: string;\r\n  private viewReference: Types.ViewReference;\r\n\r\n  constructor(viewportId: string) {\r\n    this.viewportId = viewportId;\r\n    this.setPublicViewportOptions({});\r\n    this.setPublicDisplaySetOptions([{}]);\r\n  }\r\n\r\n  /**\r\n   * Return true if the viewport contains the given display set UID,\r\n   * OR if it is a composite stack and contains the given imageId\r\n   */\r\n  public contains(displaySetUID: string, imageId: string): boolean {\r\n    if (!this.viewportData?.data) {\r\n      return false;\r\n    }\r\n\r\n    const { viewport } = getEnabledElementByViewportId(this.viewportId) || {};\r\n\r\n    if (this.viewportData.data.length) {\r\n      return !!this.viewportData.data.find(data =>\r\n        dataContains({ data, displaySetUID, imageId, viewport })\r\n      );\r\n    }\r\n\r\n    return dataContains({\r\n      data: this.viewportData.data,\r\n      displaySetUID,\r\n      imageId,\r\n      viewport,\r\n    });\r\n  }\r\n\r\n  public destroy = (): void => {\r\n    this.element = null;\r\n    this.viewportData = null;\r\n    this.viewportOptions = null;\r\n    this.displaySetOptions = null;\r\n  };\r\n\r\n  public setRenderingEngineId(renderingEngineId: string): void {\r\n    this.renderingEngineId = renderingEngineId;\r\n  }\r\n\r\n  public getRenderingEngineId(): string {\r\n    return this.renderingEngineId;\r\n  }\r\n\r\n  public setViewportId(viewportId: string): void {\r\n    this.viewportId = viewportId;\r\n  }\r\n\r\n  public setElement(element: HTMLDivElement): void {\r\n    this.element = element;\r\n  }\r\n\r\n  public setViewportData(viewportData: StackViewportData | VolumeViewportData): void {\r\n    this.viewportData = viewportData;\r\n  }\r\n\r\n  public getViewportData(): StackViewportData | VolumeViewportData {\r\n    return this.viewportData;\r\n  }\r\n\r\n  public getElement(): HTMLDivElement {\r\n    return this.element;\r\n  }\r\n\r\n  public getViewportId(): string {\r\n    return this.viewportId;\r\n  }\r\n\r\n  public getViewReference(): Types.ViewReference {\r\n    return this.viewportOptions?.viewReference;\r\n  }\r\n\r\n  public setPublicDisplaySetOptions(\r\n    publicDisplaySetOptions: PublicDisplaySetOptions[] | DisplaySetSelector[]\r\n  ): Array<DisplaySetOptions> {\r\n    // map the displaySetOptions and check if they are undefined then set them to default values\r\n    const displaySetOptions = this.mapDisplaySetOptions(publicDisplaySetOptions);\r\n\r\n    this.setDisplaySetOptions(displaySetOptions);\r\n\r\n    return this.displaySetOptions;\r\n  }\r\n\r\n  public hasDisplaySet(displaySetInstanceUID: string): boolean {\r\n    // Todo: currently this does not work for non image & referenceImage displaySets.\r\n    // Since SEG and other derived displaySets are loaded in a different way, and not\r\n    // via cornerstoneViewportService\r\n    let viewportData = this.getViewportData();\r\n\r\n    if (\r\n      viewportData.viewportType === Enums.ViewportType.ORTHOGRAPHIC ||\r\n      viewportData.viewportType === Enums.ViewportType.VOLUME_3D\r\n    ) {\r\n      viewportData = viewportData as VolumeViewportData;\r\n      return viewportData.data.some(\r\n        ({ displaySetInstanceUID: dsUID }) => dsUID === displaySetInstanceUID\r\n      );\r\n    }\r\n\r\n    viewportData = viewportData as StackViewportData;\r\n    return viewportData.data.displaySetInstanceUID === displaySetInstanceUID;\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param viewportOptionsEntry - the base values for the options\r\n   * @param viewportTypeDisplaySet  - allows overriding the viewport type\r\n   */\r\n  public setPublicViewportOptions(\r\n    viewportOptionsEntry: PublicViewportOptions,\r\n    viewportTypeDisplaySet?: string\r\n  ): ViewportOptions {\r\n    const ohifViewportType = viewportTypeDisplaySet || viewportOptionsEntry.viewportType || STACK;\r\n    const { presentationIds } = viewportOptionsEntry;\r\n    let { toolGroupId = DEFAULT_TOOLGROUP_ID } = viewportOptionsEntry;\r\n    // Just assign the orientation for any viewport type and let the viewport deal with it\r\n    const orientation = getCornerstoneOrientation(viewportOptionsEntry.orientation);\r\n\r\n    const viewportType = getCornerstoneViewportType(ohifViewportType);\r\n\r\n    if (!toolGroupId) {\r\n      toolGroupId = DEFAULT_TOOLGROUP_ID;\r\n    }\r\n\r\n    this.setViewportOptions({\r\n      ...viewportOptionsEntry,\r\n      viewportId: this.viewportId,\r\n      viewportType: viewportType as Enums.ViewportType,\r\n      orientation,\r\n      toolGroupId,\r\n      presentationIds,\r\n    });\r\n\r\n    return this.viewportOptions;\r\n  }\r\n\r\n  public setViewportOptions(viewportOptions: ViewportOptions): void {\r\n    this.viewportOptions = viewportOptions;\r\n  }\r\n\r\n  public getViewportOptions(): ViewportOptions {\r\n    return this.viewportOptions;\r\n  }\r\n\r\n  public getPresentationIds(): AppTypes.PresentationIds | null {\r\n    const { presentationIds } = this.viewportOptions;\r\n    return presentationIds;\r\n  }\r\n\r\n  public setDisplaySetOptions(displaySetOptions: Array<DisplaySetOptions>): void {\r\n    this.displaySetOptions = displaySetOptions;\r\n  }\r\n\r\n  public getSyncGroups(): SyncGroup[] {\r\n    this.viewportOptions.syncGroups ||= [];\r\n    return this.viewportOptions.syncGroups;\r\n  }\r\n\r\n  public getDisplaySetOptions(): Array<DisplaySetOptions> {\r\n    return this.displaySetOptions;\r\n  }\r\n\r\n  public getViewportType(): Enums.ViewportType {\r\n    return this.viewportOptions.viewportType || Enums.ViewportType.STACK;\r\n  }\r\n\r\n  public getToolGroupId(): string {\r\n    return this.viewportOptions.toolGroupId;\r\n  }\r\n\r\n  public getBackground(): Types.Point3 {\r\n    return this.viewportOptions.background || [0, 0, 0];\r\n  }\r\n\r\n  public getOrientation(): Enums.OrientationAxis {\r\n    return this.viewportOptions.orientation;\r\n  }\r\n\r\n  public setOrientation(orientation: Enums.OrientationAxis): void {\r\n    this.viewportOptions.orientation = orientation;\r\n  }\r\n\r\n  public getDisplayArea(): Types.DisplayArea {\r\n    return this.viewportOptions.displayArea;\r\n  }\r\n\r\n  public getInitialImageOptions(): InitialImageOptions {\r\n    return this.viewportOptions.initialImageOptions;\r\n  }\r\n\r\n  // Handle incoming public display set options or a display set select\r\n  // with a contained options.\r\n  private mapDisplaySetOptions(\r\n    options: PublicDisplaySetOptions[] | DisplaySetSelector[] = [{}]\r\n  ): Array<DisplaySetOptions> {\r\n    const displaySetOptions: Array<DisplaySetOptions> = [];\r\n\r\n    options.forEach(item => {\r\n      let option = item?.options || item;\r\n      if (!option) {\r\n        option = {\r\n          blendMode: undefined,\r\n          slabThickness: undefined,\r\n          colormap: undefined,\r\n          voi: {},\r\n          voiInverted: false,\r\n        };\r\n      }\r\n      const blendMode = getCornerstoneBlendMode(option.blendMode);\r\n\r\n      displaySetOptions.push({\r\n        voi: option.voi,\r\n        voiInverted: option.voiInverted,\r\n        colormap: option.colormap,\r\n        slabThickness: option.slabThickness,\r\n        blendMode,\r\n        displayPreset: option.displayPreset,\r\n      });\r\n    });\r\n\r\n    return displaySetOptions;\r\n  }\r\n}\r\n\r\nexport default ViewportInfo;\r\n","const RENDERING_ENGINE_ID = 'OHIFCornerstoneRenderingEngine';\r\n\r\nexport { RENDERING_ENGINE_ID };\r\n","const state = {\r\n  // The `defaultContext` of an extension's commandsModule\r\n  DEFAULT_CONTEXT: 'CORNERSTONE',\r\n  enabledElements: {},\r\n};\r\n\r\n/**\r\n * Sets the enabled element `dom` reference for an active viewport.\r\n * @param {HTMLElement} dom Active viewport element.\r\n * @return void\r\n */\r\nconst setEnabledElement = (viewportId: string, element: HTMLElement, context?: string): void => {\r\n  const targetContext = context || state.DEFAULT_CONTEXT;\r\n\r\n  state.enabledElements[viewportId] = {\r\n    element,\r\n    context: targetContext,\r\n  };\r\n};\r\n\r\n/**\r\n * Grabs the enabled element `dom` reference of an active viewport.\r\n *\r\n * @return {HTMLElement} Active viewport element.\r\n */\r\nconst getEnabledElement = viewportId => {\r\n  return state.enabledElements[viewportId];\r\n};\r\n\r\nconst reset = () => {\r\n  state.enabledElements = {};\r\n};\r\n\r\nexport { setEnabledElement, getEnabledElement, reset };\r\n","export { useLutPresentationStore } from './useLutPresentationStore';\r\nexport { usePositionPresentationStore } from './usePositionPresentationStore';\r\nexport { useSegmentationPresentationStore } from './useSegmentationPresentationStore';\r\nexport { useSynchronizersStore } from './useSynchronizersStore';\r\n","const JOIN_STR = '&';\r\n\r\n// The default lut presentation id if none defined\r\nconst DEFAULT_STR = 'default';\r\n\r\n// This code finds the first unique index to add to the presentation id so that\r\n// two viewports containing the same display set in the same type of viewport\r\n// can have different presentation information.  This allows comparison of\r\n// a single display set in two or more viewports, when the user has simply\r\n// dragged and dropped the view in twice.  For example, it allows displaying\r\n// bone, brain and soft tissue views of a single display set, and to still\r\n// remember the specific changes to each viewport.\r\nconst addUniqueIndex = (\r\n  arr,\r\n  key,\r\n  viewports: AppTypes.ViewportGrid.Viewports,\r\n  isUpdatingSameViewport\r\n) => {\r\n  arr.push(0);\r\n\r\n  // If we are updating the viewport, we should not increment the index\r\n  if (isUpdatingSameViewport) {\r\n    return;\r\n  }\r\n\r\n  // The 128 is just a value that is larger than how many viewports we\r\n  // display at once, used as an upper bound on how many unique presentation\r\n  // ID's might exist for a single display set at once.\r\n  for (let displayInstance = 0; displayInstance < 128; displayInstance++) {\r\n    arr[arr.length - 1] = displayInstance;\r\n    const testId = arr.join(JOIN_STR);\r\n    if (\r\n      !Array.from(viewports.values()).find(\r\n        viewport => viewport.viewportOptions?.presentationIds?.[key] === testId\r\n      )\r\n    ) {\r\n      break;\r\n    }\r\n  }\r\n};\r\n\r\nexport { addUniqueIndex, DEFAULT_STR, JOIN_STR };\r\n","import { create } from 'zustand';\r\nimport { devtools } from 'zustand/middleware';\r\nimport { LutPresentation } from '../types/Presentation';\r\nimport { addUniqueIndex, DEFAULT_STR, JOIN_STR } from './presentationUtils';\r\n\r\n/**\r\n * Identifier for the LUT Presentation store type.\r\n */\r\nconst PRESENTATION_TYPE_ID = 'lutPresentationId';\r\n\r\n/**\r\n * Flag to enable or disable debug mode for the store.\r\n * Set to `true` to enable zustand devtools.\r\n */\r\nconst DEBUG_STORE = false;\r\n\r\n/**\r\n * Represents the state and actions for managing LUT presentations.\r\n */\r\ntype LutPresentationState = {\r\n  /**\r\n   * Type identifier for the store.\r\n   */\r\n  type: string;\r\n\r\n  /**\r\n   * Stores LUT presentations indexed by their presentation ID.\r\n   */\r\n  lutPresentationStore: Record<string, LutPresentation>;\r\n\r\n  /**\r\n   * Sets the LUT presentation for a given key.\r\n   *\r\n   * @param key - The key identifying the LUT presentation.\r\n   * @param value - The `LutPresentation` to associate with the key.\r\n   */\r\n  setLutPresentation: (key: string, value: LutPresentation) => void;\r\n\r\n  /**\r\n   * Clears all LUT presentations from the store.\r\n   */\r\n  clearLutPresentationStore: () => void;\r\n\r\n  /**\r\n   * Retrieves the presentation ID based on the provided parameters.\r\n   *\r\n   * @param id - The presentation ID to check.\r\n   * @param options - Configuration options.\r\n   * @param options.viewport - The current viewport in grid\r\n   * @param options.viewports - All available viewports in grid\r\n   * @param options.isUpdatingSameViewport - Indicates if the same viewport is being updated.\r\n   * @returns The presentation ID or undefined.\r\n   */\r\n  getPresentationId: (\r\n    id: string,\r\n    options: {\r\n      viewport: AppTypes.ViewportGrid.Viewport;\r\n      viewports: AppTypes.ViewportGrid.Viewports;\r\n      isUpdatingSameViewport: boolean;\r\n    }\r\n  ) => string | undefined;\r\n};\r\n\r\n/**\r\n * Generates a presentation ID for LUT based on the viewport configuration.\r\n *\r\n * @param id - The ID to check.\r\n * @param options - Configuration options.\r\n * @param options.viewport - The current viewport.\r\n * @param options.viewports - All available viewports.\r\n * @param options.isUpdatingSameViewport - Indicates if the same viewport is being updated.\r\n * @returns The LUT presentation ID or undefined.\r\n */\r\nconst getLutPresentationId = (\r\n  id: string,\r\n  {\r\n    viewport,\r\n    viewports,\r\n    isUpdatingSameViewport,\r\n  }: {\r\n    viewport: AppTypes.ViewportGrid.Viewport;\r\n    viewports: AppTypes.ViewportGrid.Viewports;\r\n    isUpdatingSameViewport: boolean;\r\n  }\r\n): string | undefined => {\r\n  if (id !== PRESENTATION_TYPE_ID) {\r\n    return;\r\n  }\r\n\r\n  const getLutId = (ds): string => {\r\n    if (!ds || !ds.options) {\r\n      return DEFAULT_STR;\r\n    }\r\n    if (ds.options.id) {\r\n      return ds.options.id;\r\n    }\r\n    const arr = Object.entries(ds.options).map(([key, val]) => `${key}=${val}`);\r\n    if (!arr.length) {\r\n      return DEFAULT_STR;\r\n    }\r\n    return arr.join(JOIN_STR);\r\n  };\r\n\r\n  if (!viewport || !viewport.viewportOptions || !viewport.displaySetInstanceUIDs?.length) {\r\n    return;\r\n  }\r\n\r\n  const { displaySetOptions, displaySetInstanceUIDs } = viewport;\r\n  const lutId = getLutId(displaySetOptions[0]);\r\n  const lutPresentationArr = [lutId];\r\n\r\n  for (const uid of displaySetInstanceUIDs) {\r\n    lutPresentationArr.push(uid);\r\n  }\r\n\r\n  addUniqueIndex(lutPresentationArr, PRESENTATION_TYPE_ID, viewports, isUpdatingSameViewport);\r\n\r\n  return lutPresentationArr.join(JOIN_STR);\r\n};\r\n\r\n/**\r\n * Creates the LUT Presentation store.\r\n *\r\n * @param set - The zustand set function.\r\n * @returns The LUT Presentation store state and actions.\r\n */\r\nconst createLutPresentationStore = (set): LutPresentationState => ({\r\n  type: PRESENTATION_TYPE_ID,\r\n  lutPresentationStore: {},\r\n\r\n  /**\r\n   * Sets the LUT presentation for a given key.\r\n   */\r\n  setLutPresentation: (key, value) =>\r\n    set(\r\n      state => ({\r\n        lutPresentationStore: {\r\n          ...state.lutPresentationStore,\r\n          [key]: value,\r\n        },\r\n      }),\r\n      false,\r\n      'setLutPresentation'\r\n    ),\r\n\r\n  /**\r\n   * Clears all LUT presentations from the store.\r\n   */\r\n  clearLutPresentationStore: () =>\r\n    set({ lutPresentationStore: {} }, false, 'clearLutPresentationStore'),\r\n\r\n  /**\r\n   * Retrieves the presentation ID based on the provided parameters.\r\n   */\r\n  getPresentationId: getLutPresentationId,\r\n});\r\n\r\n/**\r\n * Zustand store for managing LUT presentations.\r\n * Applies devtools middleware when DEBUG_STORE is enabled.\r\n */\r\nexport const useLutPresentationStore = create<LutPresentationState>()(\r\n  DEBUG_STORE\r\n    ? devtools(createLutPresentationStore, { name: 'LutPresentationStore' })\r\n    : createLutPresentationStore\r\n);\r\n","import { create } from 'zustand';\r\nimport { devtools } from 'zustand/middleware';\r\nimport { PositionPresentation } from '../types/Presentation';\r\nimport { addUniqueIndex, JOIN_STR } from './presentationUtils';\r\n\r\nconst PRESENTATION_TYPE_ID = 'positionPresentationId';\r\nconst DEBUG_STORE = false;\r\n\r\n/**\r\n * Represents the state and actions for managing position presentations.\r\n */\r\ntype PositionPresentationState = {\r\n  /**\r\n   * Type identifier for the store.\r\n   */\r\n  type: string;\r\n\r\n  /**\r\n   * Stores position presentations indexed by their presentation ID.\r\n   */\r\n  positionPresentationStore: Record<string, PositionPresentation>;\r\n\r\n  /**\r\n   * Sets the position presentation for a given key.\r\n   *\r\n   * @param key - The key identifying the position presentation.\r\n   * @param value - The `PositionPresentation` to associate with the key.\r\n   */\r\n  setPositionPresentation: (key: string, value: PositionPresentation) => void;\r\n\r\n  /**\r\n   * Clears all position presentations from the store.\r\n   */\r\n  clearPositionPresentationStore: () => void;\r\n\r\n  /**\r\n   * Retrieves the presentation ID based on the provided parameters.\r\n   *\r\n   * @param id - The ID to check.\r\n   * @param options - Configuration options.\r\n   * @param options.viewport - The current viewport.\r\n   * @param options.viewports - All available viewports.\r\n   * @param options.isUpdatingSameViewport - Indicates if the same viewport is being updated.\r\n   * @returns The position presentation ID or undefined.\r\n   */\r\n  getPresentationId: (\r\n    id: string,\r\n    options: {\r\n      viewport: any;\r\n      viewports: any;\r\n      isUpdatingSameViewport: boolean;\r\n    }\r\n  ) => string | undefined;\r\n\r\n  getPositionPresentationId: (\r\n    viewport: any,\r\n    viewports?: any,\r\n    isUpdatingSameViewport?: boolean\r\n  ) => string | undefined;\r\n};\r\n\r\n/**\r\n * Generates a position presentation ID based on the viewport configuration.\r\n *\r\n * @param id - The ID to check.\r\n * @param options - Configuration options.\r\n * @param options.viewport - The current viewport.\r\n * @param options.viewports - All available viewports.\r\n * @param options.isUpdatingSameViewport - Indicates if the same viewport is being updated.\r\n * @returns The position presentation ID or undefined.\r\n */\r\nconst getPresentationId = (\r\n  id: string,\r\n  {\r\n    viewport,\r\n    viewports,\r\n    isUpdatingSameViewport,\r\n  }: {\r\n    viewport: any;\r\n    viewports: any;\r\n    isUpdatingSameViewport: boolean;\r\n  }\r\n): string | undefined => {\r\n  if (id !== PRESENTATION_TYPE_ID) {\r\n    return;\r\n  }\r\n\r\n  if (!viewport?.viewportOptions || !viewport.displaySetInstanceUIDs?.length) {\r\n    return;\r\n  }\r\n\r\n  return getPositionPresentationId(viewport, viewports, isUpdatingSameViewport);\r\n};\r\n\r\nfunction getPositionPresentationId(viewport, viewports, isUpdatingSameViewport) {\r\n  const { viewportOptions = {}, displaySetInstanceUIDs = [], displaySetOptions = [] } = viewport;\r\n  const { id: viewportOptionId, orientation } = viewportOptions;\r\n\r\n  const positionPresentationArr = [orientation || 'acquisition'];\r\n  if (viewportOptionId) {\r\n    positionPresentationArr.push(viewportOptionId);\r\n  }\r\n\r\n  if (displaySetOptions?.some(ds => ds.options?.blendMode || ds.options?.displayPreset)) {\r\n    positionPresentationArr.push(`custom`);\r\n  }\r\n\r\n  for (const uid of displaySetInstanceUIDs) {\r\n    positionPresentationArr.push(uid);\r\n  }\r\n\r\n  if (viewports && viewports.length && isUpdatingSameViewport !== undefined) {\r\n    addUniqueIndex(\r\n      positionPresentationArr,\r\n      PRESENTATION_TYPE_ID,\r\n      viewports,\r\n      isUpdatingSameViewport\r\n    );\r\n  } else {\r\n    positionPresentationArr.push(0);\r\n  }\r\n\r\n  return positionPresentationArr.join(JOIN_STR);\r\n}\r\n\r\n/**\r\n * Creates the Position Presentation store.\r\n *\r\n * @param set - The zustand set function.\r\n * @returns The Position Presentation store state and actions.\r\n */\r\nconst createPositionPresentationStore = set => ({\r\n  type: PRESENTATION_TYPE_ID,\r\n  positionPresentationStore: {},\r\n\r\n  /**\r\n   * Sets the position presentation for a given key.\r\n   */\r\n  setPositionPresentation: (key, value) =>\r\n    set(\r\n      state => ({\r\n        positionPresentationStore: {\r\n          ...state.positionPresentationStore,\r\n          [key]: value,\r\n        },\r\n      }),\r\n      false,\r\n      'setPositionPresentation'\r\n    ),\r\n\r\n  /**\r\n   * Clears all position presentations from the store.\r\n   */\r\n  clearPositionPresentationStore: () =>\r\n    set({ positionPresentationStore: {} }, false, 'clearPositionPresentationStore'),\r\n\r\n  /**\r\n   * Retrieves the presentation ID based on the provided parameters.\r\n   */\r\n  getPresentationId,\r\n  getPositionPresentationId: getPositionPresentationId,\r\n});\r\n\r\n/**\r\n * Zustand store for managing position presentations.\r\n * Applies devtools middleware when DEBUG_STORE is enabled.\r\n */\r\nexport const usePositionPresentationStore = create<PositionPresentationState>()(\r\n  DEBUG_STORE\r\n    ? devtools(createPositionPresentationStore, { name: 'PositionPresentationStore' })\r\n    : createPositionPresentationStore\r\n);\r\n","import { create } from 'zustand';\r\nimport { devtools } from 'zustand/middleware';\r\nimport { SegmentationPresentation, SegmentationPresentationItem } from '../types/Presentation';\r\nimport { JOIN_STR } from './presentationUtils';\r\nimport { getViewportOrientationFromImageOrientationPatient } from '../utils/getViewportOrientationFromImageOrientationPatient';\r\n\r\nconst PRESENTATION_TYPE_ID = 'segmentationPresentationId';\r\nconst DEBUG_STORE = false;\r\n\r\n/**\r\n * The keys are the presentationId.\r\n */\r\ntype SegmentationPresentationStore = {\r\n  /**\r\n   * Type identifier for the store.\r\n   */\r\n  type: string;\r\n\r\n  /**\r\n   * Stores segmentation presentations indexed by their presentation ID.\r\n   */\r\n  segmentationPresentationStore: Record<string, SegmentationPresentation>;\r\n\r\n  /**\r\n   * Sets the segmentation presentation for a given segmentation ID.\r\n   *\r\n   * @param presentationId - The presentation ID.\r\n   * @param value - The `SegmentationPresentation` to associate with the ID.\r\n   */\r\n  setSegmentationPresentation: (presentationId: string, value: SegmentationPresentation) => void;\r\n\r\n  /**\r\n   * Clears all segmentation presentations from the store.\r\n   */\r\n  clearSegmentationPresentationStore: () => void;\r\n\r\n  /**\r\n   * Retrieves the presentation ID based on the provided parameters.\r\n   *\r\n   * @param id - The ID to check.\r\n   * @param options - Configuration options.\r\n   * @param options.viewport - The current viewport.\r\n   * @param options.viewports - All available viewports.\r\n   * @param options.isUpdatingSameViewport - Indicates if the same viewport is being updated.\r\n   * @param options.servicesManager - The services manager instance.\r\n   * @returns The segmentation presentation ID or undefined.\r\n   */\r\n  getPresentationId: (\r\n    id: string,\r\n    options: {\r\n      viewport: AppTypes.ViewportGrid.Viewport;\r\n      viewports: AppTypes.ViewportGrid.Viewports;\r\n      isUpdatingSameViewport: boolean;\r\n      servicesManager: AppTypes.ServicesManager;\r\n    }\r\n  ) => string | undefined;\r\n\r\n  /**\r\n   * Adds a new segmentation presentation state.\r\n   *\r\n   * @param presentationId - The presentation ID.\r\n   * @param segmentationPresentation - The `SegmentationPresentation` to add.\r\n   * @param servicesManager - The services manager instance.\r\n   */\r\n  addSegmentationPresentationItem: (\r\n    presentationId: string,\r\n    segmentationPresentationItem: SegmentationPresentationItem\r\n  ) => void;\r\n\r\n  /**\r\n   * Gets the current segmentation presentation ID.\r\n   *\r\n   * @param params - Parameters for retrieving the segmentation presentation ID.\r\n   * @param params.viewport - The current viewport.\r\n   * @param params.servicesManager - The services manager instance.\r\n   * @returns The current segmentation presentation ID.\r\n   */\r\n  getSegmentationPresentationId: ({\r\n    viewport,\r\n    servicesManager,\r\n  }: {\r\n    viewport: AppTypes.ViewportGrid.Viewport;\r\n    servicesManager: AppTypes.ServicesManager;\r\n  }) => string;\r\n};\r\n\r\n/**\r\n * Generates a segmentation presentation ID based on the viewport configuration.\r\n *\r\n * @param id - The ID to check.\r\n * @param options - Configuration options.\r\n * @param options.viewport - The current viewport.\r\n * @param options.viewports - All available viewports.\r\n * @param options.isUpdatingSameViewport - Indicates if the same viewport is being updated.\r\n * @param options.servicesManager - The services manager instance.\r\n * @returns The segmentation presentation ID or undefined.\r\n */\r\nconst getPresentationId = (\r\n  id: string,\r\n  {\r\n    viewport,\r\n    viewports,\r\n    isUpdatingSameViewport,\r\n    servicesManager,\r\n  }: {\r\n    viewport: AppTypes.ViewportGrid.Viewport;\r\n    viewports: AppTypes.ViewportGrid.Viewports;\r\n    isUpdatingSameViewport: boolean;\r\n    servicesManager: AppTypes.ServicesManager;\r\n  }\r\n): string | undefined => {\r\n  if (id !== PRESENTATION_TYPE_ID) {\r\n    return;\r\n  }\r\n\r\n  return _getSegmentationPresentationId({ viewport, servicesManager });\r\n};\r\n\r\n/**\r\n * Helper function to generate the segmentation presentation ID.\r\n *\r\n * @param params - Parameters for generating the segmentation presentation ID.\r\n * @param params.viewport - The current viewport.\r\n * @param params.servicesManager - The services manager instance.\r\n * @returns The segmentation presentation ID or undefined.\r\n */\r\nconst _getSegmentationPresentationId = ({\r\n  viewport,\r\n  servicesManager,\r\n}: {\r\n  viewport: AppTypes.ViewportGrid.Viewport;\r\n  servicesManager: AppTypes.ServicesManager;\r\n}) => {\r\n  if (!viewport?.viewportOptions || !viewport.displaySetInstanceUIDs?.length) {\r\n    return;\r\n  }\r\n\r\n  const { displaySetInstanceUIDs, viewportOptions } = viewport;\r\n\r\n  let orientation = viewportOptions.orientation;\r\n\r\n  if (!orientation) {\r\n    // Calculate orientation from the viewport sample image\r\n    const displaySet = servicesManager.services.displaySetService.getDisplaySetByUID(\r\n      displaySetInstanceUIDs[0]\r\n    );\r\n    const sampleImage = displaySet.images?.[0];\r\n    const imageOrientationPatient = sampleImage?.ImageOrientationPatient;\r\n\r\n    orientation = getViewportOrientationFromImageOrientationPatient(imageOrientationPatient);\r\n  }\r\n\r\n  const segmentationPresentationArr = [];\r\n\r\n  segmentationPresentationArr.push(...displaySetInstanceUIDs);\r\n\r\n  // Uncomment if unique indexing is needed\r\n  // addUniqueIndex(\r\n  //   segmentationPresentationArr,\r\n  //   'segmentationPresentationId',\r\n  //   viewports,\r\n  //   isUpdatingSameViewport\r\n  // );\r\n\r\n  return segmentationPresentationArr.join(JOIN_STR);\r\n};\r\n\r\n/**\r\n * Creates the Segmentation Presentation store.\r\n *\r\n * @param set - The zustand set function.\r\n * @returns The Segmentation Presentation store state and actions.\r\n */\r\nconst createSegmentationPresentationStore = set => ({\r\n  type: PRESENTATION_TYPE_ID,\r\n  segmentationPresentationStore: {},\r\n\r\n  /**\r\n   * Clears all segmentation presentations from the store.\r\n   */\r\n  clearSegmentationPresentationStore: () =>\r\n    set({ segmentationPresentationStore: {} }, false, 'clearSegmentationPresentationStore'),\r\n\r\n  /**\r\n   * Adds a new segmentation presentation item to the store.\r\n   *\r\n   * segmentationPresentationItem: {\r\n   *   segmentationId: string;\r\n   *   type: SegmentationRepresentations;\r\n   *   hydrated: boolean | null;\r\n   *   config?: unknown;\r\n   * }\r\n   */\r\n  addSegmentationPresentationItem: (\r\n    presentationId: string,\r\n    segmentationPresentationItem: SegmentationPresentationItem\r\n  ) =>\r\n    set(\r\n      state => ({\r\n        segmentationPresentationStore: {\r\n          ...state.segmentationPresentationStore,\r\n          [presentationId]: [\r\n            ...(state.segmentationPresentationStore[presentationId] || []),\r\n            segmentationPresentationItem,\r\n          ],\r\n        },\r\n      }),\r\n      false,\r\n      'addSegmentationPresentationItem'\r\n    ),\r\n\r\n  /**\r\n   * Sets the segmentation presentation for a given presentation ID. A segmentation\r\n   * presentation is an array of SegmentationPresentationItem.\r\n   *\r\n   * segmentationPresentationItem: {\r\n   *   segmentationId: string;\r\n   *   type: SegmentationRepresentations;\r\n   *   hydrated: boolean | null;\r\n   *   config?: unknown;\r\n   * }\r\n   *\r\n   * segmentationPresentation: SegmentationPresentationItem[]\r\n   */\r\n  setSegmentationPresentation: (presentationId: string, values: SegmentationPresentation) =>\r\n    set(\r\n      state => ({\r\n        segmentationPresentationStore: {\r\n          ...state.segmentationPresentationStore,\r\n          [presentationId]: values,\r\n        },\r\n      }),\r\n      false,\r\n      'setSegmentationPresentation'\r\n    ),\r\n\r\n  /**\r\n   * Retrieves the presentation ID based on the provided parameters.\r\n   */\r\n  getPresentationId,\r\n\r\n  /**\r\n   * Retrieves the current segmentation presentation ID.\r\n   */\r\n  getSegmentationPresentationId: _getSegmentationPresentationId,\r\n});\r\n\r\n/**\r\n * Zustand store for managing segmentation presentations.\r\n * Applies devtools middleware when DEBUG_STORE is enabled.\r\n */\r\nexport const useSegmentationPresentationStore = create<SegmentationPresentationStore>()(\r\n  DEBUG_STORE\r\n    ? devtools(createSegmentationPresentationStore, { name: 'Segmentation Presentation Store' })\r\n    : createSegmentationPresentationStore\r\n);\r\n","import { create } from 'zustand';\r\nimport { devtools } from 'zustand/middleware';\r\n\r\n/**\r\n * Identifier for the synchronizers store type.\r\n */\r\nconst PRESENTATION_TYPE_ID = 'synchronizersStoreId';\r\n\r\n/**\r\n * Flag to enable or disable debug mode for the store.\r\n * Set to `true` to enable zustand devtools.\r\n */\r\nconst DEBUG_STORE = false;\r\n\r\n/**\r\n * Information about a single synchronizer.\r\n */\r\ntype SynchronizerInfo = {\r\n  id: string;\r\n  type: string;\r\n  sourceViewports: Array<{ viewportId: string; renderingEngineId: string }>;\r\n  targetViewports: Array<{ viewportId: string; renderingEngineId: string }>;\r\n};\r\n\r\n/**\r\n * State shape for the Synchronizers store.\r\n */\r\ntype SynchronizersState = {\r\n  /**\r\n   * Stores synchronizer information indexed by a unique key.\r\n   */\r\n  synchronizersStore: Record<string, SynchronizerInfo[]>;\r\n\r\n  /**\r\n   * Sets the synchronizers for a specific viewport.\r\n   *\r\n   * @param viewportId - The ID of the viewport.\r\n   * @param synchronizers - An array of SynchronizerInfo.\r\n   */\r\n  setSynchronizers: (viewportId: string, synchronizers: SynchronizerInfo[]) => void;\r\n\r\n  /**\r\n   * Clears the entire synchronizers store.\r\n   */\r\n  clearSynchronizersStore: () => void;\r\n};\r\n\r\n/**\r\n * Creates the Synchronizers store.\r\n *\r\n * @param set - The zustand set function.\r\n * @returns The synchronizers store state and actions.\r\n */\r\nconst createSynchronizersStore = (set): SynchronizersState => ({\r\n  synchronizersStore: {},\r\n  type: PRESENTATION_TYPE_ID,\r\n\r\n  setSynchronizers: (viewportId: string, synchronizers: SynchronizerInfo[]) => {\r\n    set(\r\n      state => ({\r\n        synchronizersStore: {\r\n          ...state.synchronizersStore,\r\n          [viewportId]: synchronizers,\r\n        },\r\n      }),\r\n      false,\r\n      'setSynchronizers'\r\n    );\r\n  },\r\n\r\n  clearSynchronizersStore: () => {\r\n    set({ synchronizersStore: {} }, false, 'clearSynchronizersStore');\r\n  },\r\n});\r\n\r\n/**\r\n * Zustand store for managing synchronizers.\r\n * Applies devtools middleware when DEBUG_STORE is enabled.\r\n */\r\nexport const useSynchronizersStore = create<SynchronizersState>()(\r\n  DEBUG_STORE\r\n    ? devtools(createSynchronizersStore, { name: 'SynchronizersStore' })\r\n    : createSynchronizersStore\r\n);\r\n","import { SynchronizerManager, Synchronizer } from '@cornerstonejs/tools';\r\nimport { EVENTS, getRenderingEngine, type Types, utilities } from '@cornerstonejs/core';\r\n\r\nconst frameViewSyncCallback = (\r\n  synchronizerInstance: Synchronizer,\r\n  sourceViewport: Types.IViewportId,\r\n  targetViewport: Types.IViewportId\r\n) => {\r\n  const renderingEngine = getRenderingEngine(targetViewport.renderingEngineId);\r\n  if (!renderingEngine) {\r\n    throw new Error(`No RenderingEngine for Id: ${targetViewport.renderingEngineId}`);\r\n  }\r\n  const sViewport = renderingEngine.getViewport(sourceViewport.viewportId) as Types.IStackViewport;\r\n\r\n  const { viewportIndex: targetViewportIndex } = synchronizerInstance.getOptions(\r\n    targetViewport.viewportId\r\n  );\r\n\r\n  const { viewportIndex: sourceViewportIndex } = synchronizerInstance.getOptions(\r\n    sourceViewport.viewportId\r\n  );\r\n\r\n  if (targetViewportIndex === undefined || sourceViewportIndex === undefined) {\r\n    throw new Error('No viewportIndex provided');\r\n  }\r\n\r\n  const tViewport = renderingEngine.getViewport(targetViewport.viewportId) as Types.IStackViewport;\r\n\r\n  const sourceSliceIndex = sViewport.getSliceIndex();\r\n  const sliceDifference = Number(targetViewportIndex) - Number(sourceViewportIndex);\r\n  const targetSliceIndex = sourceSliceIndex + sliceDifference;\r\n\r\n  if (targetSliceIndex === tViewport.getSliceIndex()) {\r\n    return;\r\n  }\r\n\r\n  utilities.jumpToSlice(tViewport.element, {\r\n    imageIndex: targetSliceIndex,\r\n  });\r\n};\r\n\r\nconst createFrameViewSynchronizer = (synchronizerName: string): Synchronizer => {\r\n  const synchronizer = SynchronizerManager.createSynchronizer(\r\n    synchronizerName,\r\n    EVENTS.STACK_VIEWPORT_SCROLL,\r\n    frameViewSyncCallback\r\n  );\r\n  return synchronizer;\r\n};\r\n\r\nexport { createFrameViewSynchronizer };\r\n","import { LengthTool, utilities } from '@cornerstonejs/tools';\r\nimport { callInputDialog } from '@ohif/extension-default';\r\nimport getActiveViewportEnabledElement from '../utils/getActiveViewportEnabledElement';\r\n\r\nconst { calibrateImageSpacing } = utilities;\r\n\r\n/**\r\n * Calibration Line tool works almost the same as the\r\n */\r\nclass CalibrationLineTool extends LengthTool {\r\n  static toolName = 'CalibrationLine';\r\n\r\n  _renderingViewport: any;\r\n  _lengthToolRenderAnnotation = this.renderAnnotation;\r\n\r\n  renderAnnotation = (enabledElement, svgDrawingHelper) => {\r\n    const { viewport } = enabledElement;\r\n    this._renderingViewport = viewport;\r\n    return this._lengthToolRenderAnnotation(enabledElement, svgDrawingHelper);\r\n  };\r\n\r\n  _getTextLines(data, targetId) {\r\n    const [canvasPoint1, canvasPoint2] = data.handles.points.map(p =>\r\n      this._renderingViewport.worldToCanvas(p)\r\n    );\r\n    // for display, round to 2 decimal points\r\n    const lengthPx = Math.round(calculateLength2(canvasPoint1, canvasPoint2) * 100) / 100;\r\n\r\n    const textLines = [`${lengthPx}px`];\r\n\r\n    return textLines;\r\n  }\r\n}\r\n\r\nfunction calculateLength2(point1, point2) {\r\n  const dx = point1[0] - point2[0];\r\n  const dy = point1[1] - point2[1];\r\n  return Math.sqrt(dx * dx + dy * dy);\r\n}\r\n\r\nfunction calculateLength3(pos1, pos2) {\r\n  const dx = pos1[0] - pos2[0];\r\n  const dy = pos1[1] - pos2[1];\r\n  const dz = pos1[2] - pos2[2];\r\n\r\n  return Math.sqrt(dx * dx + dy * dy + dz * dz);\r\n}\r\n\r\nexport default CalibrationLineTool;\r\n\r\nexport function onCompletedCalibrationLine(\r\n  servicesManager: AppTypes.ServicesManager,\r\n  csToolsEvent\r\n) {\r\n  const { uiDialogService, viewportGridService } = servicesManager.services;\r\n\r\n  // calculate length (mm) with the current Pixel Spacing\r\n  const annotationAddedEventDetail = csToolsEvent.detail;\r\n  const {\r\n    annotation: { metadata, data: annotationData },\r\n  } = annotationAddedEventDetail;\r\n  const { referencedImageId: imageId } = metadata;\r\n  const enabledElement = getActiveViewportEnabledElement(viewportGridService);\r\n  const { viewport } = enabledElement;\r\n\r\n  const length =\r\n    Math.round(\r\n      calculateLength3(annotationData.handles.points[0], annotationData.handles.points[1]) * 100\r\n    ) / 100;\r\n\r\n  const adjustCalibration = newLength => {\r\n    const spacingScale = newLength / length;\r\n\r\n    // trigger resize of the viewport to adjust the world/pixel mapping\r\n    calibrateImageSpacing(imageId, viewport.getRenderingEngine(), {\r\n      type: 'User',\r\n      scale: 1 / spacingScale,\r\n    });\r\n  };\r\n\r\n  return new Promise((resolve, reject) => {\r\n    if (!uiDialogService) {\r\n      reject('UIDialogService is not initiated');\r\n      return;\r\n    }\r\n\r\n    callInputDialog({\r\n      uiDialogService,\r\n      title: 'Calibration',\r\n      placeholder: 'Actual Physical distance (mm)',\r\n      defaultValue: `${length}`,\r\n    }).then(newValue => {\r\n      adjustCalibration(Number.parseFloat(newValue));\r\n      resolve(true);\r\n    });\r\n  });\r\n}\r\n","import { VolumeViewport, metaData, utilities } from '@cornerstonejs/core';\r\nimport { IStackViewport, IVolumeViewport } from '@cornerstonejs/core/types';\r\nimport { AnnotationDisplayTool, drawing } from '@cornerstonejs/tools';\r\nimport { guid, b64toBlob } from '@ohif/core/src/utils';\r\nimport OverlayPlaneModuleProvider from './OverlayPlaneModuleProvider';\r\n\r\ninterface CachedStat {\r\n  color: number[]; // [r, g, b, a]\r\n  overlays: {\r\n    // ...overlayPlaneModule\r\n    _id: string;\r\n    type: 'G' | 'R'; // G for Graphics, R for ROI\r\n    color?: number[]; // Rendered color [r, g, b, a]\r\n    dataUrl?: string; // Rendered image in Data URL expression\r\n  }[];\r\n}\r\n\r\n/**\r\n * Image Overlay Viewer tool is not a traditional tool that requires user interactin.\r\n * But it is used to display Pixel Overlays. And it will provide toggling capability.\r\n *\r\n * The documentation for Overlay Plane Module of DICOM can be found in [C.9.2 of\r\n * Part-3 of DICOM standard](https://dicom.nema.org/medical/dicom/2018b/output/chtml/part03/sect_C.9.2.html)\r\n *\r\n * Image Overlay rendered by this tool can be toggled on and off using\r\n * toolGroup.setToolEnabled() and toolGroup.setToolDisabled()\r\n */\r\nclass ImageOverlayViewerTool extends AnnotationDisplayTool {\r\n  static toolName = 'ImageOverlayViewer';\r\n\r\n  /**\r\n   * The overlay plane module provider add method is exposed here to be used\r\n   * when updating the overlay for this tool to use for displaying data.\r\n   */\r\n  public static addOverlayPlaneModule = OverlayPlaneModuleProvider.add;\r\n\r\n  constructor(\r\n    toolProps = {},\r\n    defaultToolProps = {\r\n      supportedInteractionTypes: [],\r\n      configuration: {\r\n        fillColor: [255, 127, 127, 255],\r\n      },\r\n    }\r\n  ) {\r\n    super(toolProps, defaultToolProps);\r\n  }\r\n\r\n  onSetToolDisabled = (): void => {};\r\n\r\n  protected getReferencedImageId(viewport: IStackViewport | IVolumeViewport): string {\r\n    if (viewport instanceof VolumeViewport) {\r\n      return;\r\n    }\r\n\r\n    const targetId = this.getTargetId(viewport);\r\n    return targetId.split('imageId:')[1];\r\n  }\r\n\r\n  renderAnnotation = (enabledElement, svgDrawingHelper) => {\r\n    const { viewport } = enabledElement;\r\n\r\n    const imageId = this.getReferencedImageId(viewport);\r\n    if (!imageId) {\r\n      return;\r\n    }\r\n\r\n    const overlayMetadata = metaData.get('overlayPlaneModule', imageId);\r\n    const overlays = overlayMetadata?.overlays;\r\n\r\n    // no overlays\r\n    if (!overlays?.length) {\r\n      return;\r\n    }\r\n\r\n    // Fix the x, y positions\r\n    overlays.forEach(overlay => {\r\n      overlay.x ||= 0;\r\n      overlay.y ||= 0;\r\n    });\r\n\r\n    // Will clear cached stat data when the overlay data changes\r\n    ImageOverlayViewerTool.addOverlayPlaneModule(imageId, overlayMetadata);\r\n\r\n    this._getCachedStat(imageId, overlayMetadata, this.configuration.fillColor).then(cachedStat => {\r\n      cachedStat.overlays.forEach(overlay => {\r\n        this._renderOverlay(enabledElement, svgDrawingHelper, overlay);\r\n      });\r\n    });\r\n\r\n    return true;\r\n  };\r\n\r\n  /**\r\n   * Render to DOM\r\n   *\r\n   * @param enabledElement\r\n   * @param svgDrawingHelper\r\n   * @param overlayData\r\n   * @returns\r\n   */\r\n  private _renderOverlay(enabledElement, svgDrawingHelper, overlayData) {\r\n    const { viewport } = enabledElement;\r\n    const imageId = this.getReferencedImageId(viewport);\r\n    if (!imageId) {\r\n      return;\r\n    }\r\n\r\n    // Decide the rendering position of the overlay image on the current canvas\r\n    const { _id, columns: width, rows: height, x, y } = overlayData;\r\n    const overlayTopLeftWorldPos = utilities.imageToWorldCoords(imageId, [\r\n      x - 1, // Remind that top-left corner's (x, y) is be (1, 1)\r\n      y - 1,\r\n    ]);\r\n    const overlayTopLeftOnCanvas = viewport.worldToCanvas(overlayTopLeftWorldPos);\r\n    const overlayBottomRightWorldPos = utilities.imageToWorldCoords(imageId, [width, height]);\r\n    const overlayBottomRightOnCanvas = viewport.worldToCanvas(overlayBottomRightWorldPos);\r\n\r\n    // add image to the annotations svg layer\r\n    const svgns = 'http://www.w3.org/2000/svg';\r\n    const svgNodeHash = `image-overlay-${_id}`;\r\n    const existingImageElement = svgDrawingHelper.getSvgNode(svgNodeHash);\r\n\r\n    const attributes = {\r\n      'data-id': svgNodeHash,\r\n      width: overlayBottomRightOnCanvas[0] - overlayTopLeftOnCanvas[0],\r\n      height: overlayBottomRightOnCanvas[1] - overlayTopLeftOnCanvas[1],\r\n      x: overlayTopLeftOnCanvas[0],\r\n      y: overlayTopLeftOnCanvas[1],\r\n      href: overlayData.dataUrl,\r\n    };\r\n\r\n    if (\r\n      isNaN(attributes.x) ||\r\n      isNaN(attributes.y) ||\r\n      isNaN(attributes.width) ||\r\n      isNaN(attributes.height)\r\n    ) {\r\n      console.warn('Invalid rendering attribute for image overlay', attributes['data-id']);\r\n      return false;\r\n    }\r\n\r\n    if (existingImageElement) {\r\n      drawing.setAttributesIfNecessary(attributes, existingImageElement);\r\n      svgDrawingHelper.setNodeTouched(svgNodeHash);\r\n    } else {\r\n      const newImageElement = document.createElementNS(svgns, 'image');\r\n      drawing.setNewAttributesIfValid(attributes, newImageElement);\r\n      svgDrawingHelper.appendNode(newImageElement, svgNodeHash);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private async _getCachedStat(\r\n    imageId: string,\r\n    overlayMetadata,\r\n    color: number[]\r\n  ): Promise<CachedStat> {\r\n    const missingOverlay = overlayMetadata.overlays.filter(\r\n      overlay => overlay.pixelData && !overlay.dataUrl\r\n    );\r\n    if (missingOverlay.length === 0) {\r\n      return overlayMetadata;\r\n    }\r\n\r\n    const overlays = await Promise.all(\r\n      overlayMetadata.overlays\r\n        .filter(overlay => overlay.pixelData)\r\n        .map(async (overlay, idx) => {\r\n          let pixelData = null;\r\n          if (overlay.pixelData.Value) {\r\n            pixelData = overlay.pixelData.Value;\r\n          } else if (overlay.pixelData instanceof Array) {\r\n            pixelData = overlay.pixelData[0];\r\n          } else if (overlay.pixelData.retrieveBulkData) {\r\n            pixelData = await overlay.pixelData.retrieveBulkData();\r\n          } else if (overlay.pixelData.InlineBinary) {\r\n            const blob = b64toBlob(overlay.pixelData.InlineBinary);\r\n            const arrayBuffer = await blob.arrayBuffer();\r\n            pixelData = arrayBuffer;\r\n          }\r\n\r\n          if (!pixelData) {\r\n            return;\r\n          }\r\n\r\n          const dataUrl = this._renderOverlayToDataUrl(\r\n            { width: overlay.columns, height: overlay.rows },\r\n            overlay.color || color,\r\n            pixelData\r\n          );\r\n\r\n          return {\r\n            ...overlay,\r\n            _id: guid(),\r\n            dataUrl, // this will be a data url expression of the rendered image\r\n            color,\r\n          };\r\n        })\r\n    );\r\n    overlayMetadata.overlays = overlays;\r\n\r\n    return overlayMetadata;\r\n  }\r\n\r\n  /**\r\n   * compare two RGBA expression of colors.\r\n   *\r\n   * @param color1\r\n   * @param color2\r\n   * @returns\r\n   */\r\n  private _isSameColor(color1: number[], color2: number[]) {\r\n    return (\r\n      color1 &&\r\n      color2 &&\r\n      color1[0] === color2[0] &&\r\n      color1[1] === color2[1] &&\r\n      color1[2] === color2[2] &&\r\n      color1[3] === color2[3]\r\n    );\r\n  }\r\n\r\n  /**\r\n   * pixelData of overlayPlane module is an array of bits corresponding\r\n   * to each of the underlying pixels of the image.\r\n   * Let's create pixel data from bit array of overlay data\r\n   *\r\n   * @param pixelDataRaw\r\n   * @param color\r\n   * @returns\r\n   */\r\n  private _renderOverlayToDataUrl({ width, height }, color, pixelDataRaw) {\r\n    const pixelDataView = new DataView(pixelDataRaw);\r\n    const totalBits = width * height;\r\n\r\n    const canvas = document.createElement('canvas');\r\n    canvas.width = width;\r\n    canvas.height = height;\r\n\r\n    const ctx = canvas.getContext('2d');\r\n    ctx.clearRect(0, 0, width, height); // make it transparent\r\n    ctx.globalCompositeOperation = 'copy';\r\n\r\n    const imageData = ctx.getImageData(0, 0, width, height);\r\n    const data = imageData.data;\r\n    for (let i = 0, bitIdx = 0, byteIdx = 0; i < totalBits; i++) {\r\n      if (pixelDataView.getUint8(byteIdx) & (1 << bitIdx)) {\r\n        data[i * 4] = color[0];\r\n        data[i * 4 + 1] = color[1];\r\n        data[i * 4 + 2] = color[2];\r\n        data[i * 4 + 3] = color[3];\r\n      }\r\n\r\n      // next bit, byte\r\n      if (bitIdx >= 7) {\r\n        bitIdx = 0;\r\n        byteIdx++;\r\n      } else {\r\n        bitIdx++;\r\n      }\r\n    }\r\n    ctx.putImageData(imageData, 0, 0);\r\n\r\n    return canvas.toDataURL();\r\n  }\r\n}\r\n\r\nexport default ImageOverlayViewerTool;\r\n","import { metaData } from '@cornerstonejs/core';\r\n\r\nconst _cachedOverlayMetadata: Map<string, any[]> = new Map();\r\n\r\n/**\r\n * Image Overlay Viewer tool is not a traditional tool that requires user interactin.\r\n * But it is used to display Pixel Overlays. And it will provide toggling capability.\r\n *\r\n * The documentation for Overlay Plane Module of DICOM can be found in [C.9.2 of\r\n * Part-3 of DICOM standard](https://dicom.nema.org/medical/dicom/2018b/output/chtml/part03/sect_C.9.2.html)\r\n *\r\n * Image Overlay rendered by this tool can be toggled on and off using\r\n * toolGroup.setToolEnabled() and toolGroup.setToolDisabled()\r\n */\r\nconst OverlayPlaneModuleProvider = {\r\n  /** Adds the metadata for overlayPlaneModule */\r\n  add: (imageId, metadata) => {\r\n    if (_cachedOverlayMetadata.get(imageId) === metadata) {\r\n      // This is a no-op here as the tool re-caches the data\r\n      return;\r\n    }\r\n    _cachedOverlayMetadata.set(imageId, metadata);\r\n  },\r\n\r\n  /** Standard getter for metadata */\r\n  get: (type: string, query: string | string[]) => {\r\n    if (Array.isArray(query)) {\r\n      return;\r\n    }\r\n    if (type !== 'overlayPlaneModule') {\r\n      return;\r\n    }\r\n    return _cachedOverlayMetadata.get(query);\r\n  },\r\n};\r\n\r\n// Needs to be higher priority than default provider\r\nmetaData.addProvider(OverlayPlaneModuleProvider.get, 10_000);\r\n\r\nexport default OverlayPlaneModuleProvider;\r\n","import { ColorMapPreset } from './Colormap';\r\n\r\n// Position options\r\nexport type ColorbarPositionType = 'top' | 'bottom' | 'left' | 'right';\r\n\r\n// Tick position options\r\nexport type TickPositionType = 'top' | 'bottom' | 'left' | 'right';\r\n\r\n// CSS style properties for ticks\r\nexport type TickStyleType = {\r\n  font?: string;\r\n  color?: string;\r\n  maxNumTicks?: number;\r\n  tickSize?: number;\r\n  tickWidth?: number;\r\n  labelMargin?: number;\r\n  labelOffset?: number;\r\n};\r\n\r\n// Position-specific styles\r\nexport type PositionStyleType = {\r\n  [key: string]: string;\r\n};\r\n\r\n// Styles for a specific position (like bottom)\r\nexport type PositionTickStyleType = {\r\n  position: TickPositionType;\r\n  style?: TickStyleType;\r\n};\r\n\r\n// Map of position to position-specific styles\r\nexport type PositionTickStylesMapType = {\r\n  [key in ColorbarPositionType]?: PositionTickStyleType;\r\n};\r\n\r\n// Map of position to position-specific CSS\r\nexport type PositionStylesMapType = {\r\n  [key in ColorbarPositionType]?: PositionStyleType;\r\n};\r\n\r\n// Container styles\r\nexport type ContainerStyleType = {\r\n  position?: string;\r\n  boxSizing?: string;\r\n  border?: string;\r\n  cursor?: string;\r\n  [key: string]: string | undefined;\r\n};\r\n\r\n// Dimension configuration\r\nexport type DimensionConfigType = {\r\n  bottomHeight: string;\r\n  defaultVerticalWidth: string;\r\n  defaultHorizontalHeight: string;\r\n};\r\n\r\n// Tick configuration\r\nexport type TickConfigType = {\r\n  position: TickPositionType;\r\n  style?: TickStyleType;\r\n};\r\n\r\n// Base options for colorbar\r\nexport type ColorbarOptions = {\r\n  position: ColorbarPositionType;\r\n  colormaps: Record<string, ColorMapPreset>;\r\n  activeColormapName: string;\r\n  ticks?: TickConfigType;\r\n  width: string;\r\n};\r\n\r\n// Props for the Colorbar component\r\nexport type ColorbarProps = {\r\n  viewportId: string;\r\n  displaySets: Array<any>;\r\n  colorbarProperties: ColorbarProperties;\r\n};\r\n\r\n// Extended properties with styling options\r\nexport type ColorbarProperties = {\r\n  width: string;\r\n  colorbarTickPosition: TickPositionType;\r\n  colorbarContainerPosition: ColorbarPositionType;\r\n  colormaps: Record<string, ColorMapPreset>;\r\n  colorbarInitialColormap: string;\r\n\r\n  // Styling properties\r\n  positionStyles?: PositionStylesMapType;\r\n  positionTickStyles?: PositionTickStylesMapType;\r\n  containerStyles?: ContainerStyleType;\r\n  tickStyles?: TickStyleType;\r\n};\r\n\r\n// Type for the customization object from the customization service\r\nexport interface ColorbarCustomization {\r\n  width: string;\r\n  colorbarTickPosition: TickPositionType;\r\n  colorbarContainerPosition: ColorbarPositionType;\r\n  colormaps: Record<string, ColorMapPreset>;\r\n  colorbarInitialColormap: string;\r\n\r\n  // Styling properties\r\n  positionStyles: PositionStylesMapType;\r\n  positionTickStyles: PositionTickStylesMapType;\r\n  containerStyles: ContainerStyleType;\r\n  tickStyles: TickStyleType;\r\n}\r\n\r\n// Event types for colorbar changes\r\nexport enum ChangeTypes {\r\n  Removed = 'removed',\r\n  Added = 'added',\r\n  Modified = 'modified',\r\n}\r\n","import * as CornerstoneCacheService from './CornerstoneCacheService';\r\nimport type CornerstoneServices from './CornerstoneServices';\r\nexport { type SyncGroup } from '../services/SyncGroupService';\r\nexport { type HydrationCallback } from '../utils/promptHydrationDialog';\r\nexport type { CornerstoneCacheService, CornerstoneServices };\r\nexport * from './Presentation';\r\nexport * from './ViewportPresets';\r\nexport * from './WindowLevel';\r\nexport * from './VolumeRenderingConfig';\r\nexport * from './VolumeLighting';\r\n","import React, { useEffect, useState } from 'react';\r\nimport html2canvas from 'html2canvas';\r\nimport { getEnabledElement, StackViewport, BaseVolumeViewport } from '@cornerstonejs/core';\r\nimport { ToolGroupManager, segmentation, Enums } from '@cornerstonejs/tools';\r\nimport { getEnabledElement as OHIFgetEnabledElement } from '../state';\r\nimport { useSystem } from '@ohif/core/src';\r\n\r\nconst DEFAULT_SIZE = 512;\r\nconst MAX_TEXTURE_SIZE = 10000;\r\nconst VIEWPORT_ID = 'cornerstone-viewport-download-form';\r\n\r\nconst FILE_TYPE_OPTIONS = [\r\n  {\r\n    value: 'jpg',\r\n    label: 'JPG',\r\n  },\r\n  {\r\n    value: 'png',\r\n    label: 'PNG',\r\n  },\r\n];\r\n\r\ntype ViewportDownloadFormProps = {\r\n  hide: () => void;\r\n  activeViewportId: string;\r\n};\r\n\r\nconst CornerstoneViewportDownloadForm = ({\r\n  hide,\r\n  activeViewportId: activeViewportIdProp,\r\n}: ViewportDownloadFormProps) => {\r\n  const { servicesManager } = useSystem();\r\n  const { customizationService, cornerstoneViewportService } = servicesManager.services;\r\n  const [showAnnotations, setShowAnnotations] = useState(true);\r\n  const [viewportDimensions, setViewportDimensions] = useState({\r\n    width: DEFAULT_SIZE,\r\n    height: DEFAULT_SIZE,\r\n  });\r\n\r\n  const warningState = customizationService.getCustomization('viewportDownload.warningMessage') as {\r\n    enabled: boolean;\r\n    value: string;\r\n  };\r\n\r\n  const refViewportEnabledElementOHIF = OHIFgetEnabledElement(activeViewportIdProp);\r\n  const activeViewportElement = refViewportEnabledElementOHIF?.element;\r\n  const { viewportId: activeViewportId, renderingEngineId } =\r\n    getEnabledElement(activeViewportElement);\r\n\r\n  const renderingEngine = cornerstoneViewportService.getRenderingEngine();\r\n  const toolGroup = ToolGroupManager.getToolGroupForViewport(activeViewportId, renderingEngineId);\r\n\r\n  useEffect(() => {\r\n    const toolModeAndBindings = Object.keys(toolGroup.toolOptions).reduce((acc, toolName) => {\r\n      const tool = toolGroup.toolOptions[toolName];\r\n      const { mode, bindings } = tool;\r\n\r\n      return {\r\n        ...acc,\r\n        [toolName]: { mode, bindings },\r\n      };\r\n    }, {});\r\n\r\n    return () => {\r\n      Object.keys(toolModeAndBindings).forEach(toolName => {\r\n        const { mode, bindings } = toolModeAndBindings[toolName];\r\n        toolGroup.setToolMode(toolName, mode, { bindings });\r\n      });\r\n    };\r\n  }, []);\r\n\r\n  const handleEnableViewport = (viewportElement: HTMLElement) => {\r\n    if (!viewportElement) {\r\n      return;\r\n    }\r\n\r\n    const { viewport } = getEnabledElement(activeViewportElement);\r\n\r\n    const viewportInput = {\r\n      viewportId: VIEWPORT_ID,\r\n      element: viewportElement,\r\n      type: viewport.type,\r\n      defaultOptions: {\r\n        background: viewport.defaultOptions.background,\r\n        orientation: viewport.defaultOptions.orientation,\r\n      },\r\n    };\r\n\r\n    renderingEngine.enableElement(viewportInput);\r\n  };\r\n\r\n  const handleDisableViewport = async () => {\r\n    renderingEngine.disableElement(VIEWPORT_ID);\r\n  };\r\n\r\n  const handleLoadImage = async (width: number, height: number) => {\r\n    if (!activeViewportElement) {\r\n      return;\r\n    }\r\n\r\n    const activeViewportEnabledElement = getEnabledElement(activeViewportElement);\r\n    if (!activeViewportEnabledElement) {\r\n      return;\r\n    }\r\n\r\n    const segmentationRepresentations =\r\n      segmentation.state.getViewportSegmentationRepresentations(activeViewportId);\r\n\r\n    const { viewport } = activeViewportEnabledElement;\r\n    const downloadViewport = renderingEngine.getViewport(VIEWPORT_ID);\r\n\r\n    try {\r\n      if (downloadViewport instanceof StackViewport) {\r\n        const imageId = viewport.getCurrentImageId();\r\n        const properties = viewport.getProperties();\r\n\r\n        await downloadViewport.setStack([imageId]);\r\n        downloadViewport.setProperties(properties);\r\n      } else if (downloadViewport instanceof BaseVolumeViewport) {\r\n        const volumeIds = viewport.getAllVolumeIds();\r\n        downloadViewport.setVolumes([{ volumeId: volumeIds[0] }]);\r\n      }\r\n\r\n      if (segmentationRepresentations.length > 0) {\r\n        segmentationRepresentations.forEach(segRepresentation => {\r\n          const { segmentationId, colorLUTIndex, type } = segRepresentation;\r\n          if (type === Enums.SegmentationRepresentations.Labelmap) {\r\n            segmentation.addLabelmapRepresentationToViewportMap({\r\n              [downloadViewport.id]: [\r\n                {\r\n                  segmentationId,\r\n                  type: Enums.SegmentationRepresentations.Labelmap,\r\n                  config: {\r\n                    colorLUTOrIndex: colorLUTIndex,\r\n                  },\r\n                },\r\n              ],\r\n            });\r\n          }\r\n\r\n          if (type === Enums.SegmentationRepresentations.Contour) {\r\n            segmentation.addContourRepresentationToViewportMap({\r\n              [downloadViewport.id]: [\r\n                {\r\n                  segmentationId,\r\n                  type: Enums.SegmentationRepresentations.Contour,\r\n                  config: {\r\n                    colorLUTOrIndex: colorLUTIndex,\r\n                  },\r\n                },\r\n              ],\r\n            });\r\n          }\r\n        });\r\n      }\r\n\r\n      return {\r\n        width: Math.min(width || DEFAULT_SIZE, MAX_TEXTURE_SIZE),\r\n        height: Math.min(height || DEFAULT_SIZE, MAX_TEXTURE_SIZE),\r\n      };\r\n    } catch (error) {\r\n      console.error('Error loading image:', error);\r\n    }\r\n  };\r\n\r\n  const handleToggleAnnotations = (show: boolean) => {\r\n    const activeViewportEnabledElement = getEnabledElement(activeViewportElement);\r\n    if (!activeViewportEnabledElement) {\r\n      return;\r\n    }\r\n\r\n    const downloadViewport = renderingEngine.getViewport(VIEWPORT_ID);\r\n    if (!downloadViewport) {\r\n      return;\r\n    }\r\n\r\n    const { viewportId: activeViewportId, renderingEngineId } = activeViewportEnabledElement;\r\n    const { id: downloadViewportId } = downloadViewport;\r\n\r\n    const toolGroup = ToolGroupManager.getToolGroupForViewport(activeViewportId, renderingEngineId);\r\n    toolGroup.addViewport(downloadViewportId, renderingEngineId);\r\n\r\n    const toolInstances = toolGroup.getToolInstances();\r\n    const toolInstancesArray = Object.values(toolInstances);\r\n\r\n    toolInstancesArray.forEach(toolInstance => {\r\n      if (toolInstance.constructor.isAnnotation !== false) {\r\n        if (show) {\r\n          toolGroup.setToolEnabled(toolInstance.toolName);\r\n        } else {\r\n          toolGroup.setToolDisabled(toolInstance.toolName);\r\n        }\r\n      }\r\n    });\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (viewportDimensions.width && viewportDimensions.height) {\r\n      setTimeout(() => {\r\n        handleLoadImage(viewportDimensions.width, viewportDimensions.height);\r\n        handleToggleAnnotations(showAnnotations);\r\n        // we need a resize here to make suer annotations world to canvas\r\n        // are properly calculated\r\n        renderingEngine.resize();\r\n        renderingEngine.render();\r\n      }, 100);\r\n    }\r\n  }, [viewportDimensions, showAnnotations]);\r\n\r\n  const handleDownload = async (filename: string, fileType: string) => {\r\n    const divForDownloadViewport = document.querySelector(\r\n      `div[data-viewport-uid=\"${VIEWPORT_ID}\"]`\r\n    );\r\n\r\n    if (!divForDownloadViewport) {\r\n      console.debug('No viewport found for download');\r\n      return;\r\n    }\r\n\r\n    const canvas = await html2canvas(divForDownloadViewport as HTMLElement);\r\n    const link = document.createElement('a');\r\n    link.download = `${filename}.${fileType}`;\r\n    link.href = canvas.toDataURL(`image/${fileType}`, 1.0);\r\n    link.click();\r\n  };\r\n\r\n  const ViewportDownloadFormNew = customizationService.getCustomization(\r\n    'ohif.captureViewportModal'\r\n  );\r\n\r\n  return (\r\n    <ViewportDownloadFormNew\r\n      onClose={hide}\r\n      defaultSize={DEFAULT_SIZE}\r\n      fileTypeOptions={FILE_TYPE_OPTIONS}\r\n      viewportId={VIEWPORT_ID}\r\n      showAnnotations={showAnnotations}\r\n      onAnnotationsChange={setShowAnnotations}\r\n      dimensions={viewportDimensions}\r\n      onDimensionsChange={setViewportDimensions}\r\n      onEnableViewport={handleEnableViewport}\r\n      onDisableViewport={handleDisableViewport}\r\n      onDownload={handleDownload}\r\n      warningState={warningState}\r\n    />\r\n  );\r\n};\r\n\r\nexport default CornerstoneViewportDownloadForm;\r\n","import dicomImageLoader from '@cornerstonejs/dicom-image-loader';\r\n\r\nimport { PubSubService } from '@ohif/core';\r\n\r\nexport const EVENTS = {\r\n  PROGRESS: 'event:DicomFileUploader:progress',\r\n};\r\n\r\nexport interface DicomFileUploaderEvent {\r\n  fileId: number;\r\n}\r\n\r\nexport interface DicomFileUploaderProgressEvent extends DicomFileUploaderEvent {\r\n  percentComplete: number;\r\n}\r\n\r\nexport enum UploadStatus {\r\n  NotStarted,\r\n  InProgress,\r\n  Success,\r\n  Failed,\r\n  Cancelled,\r\n}\r\n\r\ntype CancelOrFailed = UploadStatus.Cancelled | UploadStatus.Failed;\r\n\r\nexport class UploadRejection {\r\n  message: string;\r\n  status: CancelOrFailed;\r\n\r\n  constructor(status: CancelOrFailed, message: string) {\r\n    this.message = message;\r\n    this.status = status;\r\n  }\r\n}\r\n\r\nexport default class DicomFileUploader extends PubSubService {\r\n  private _file;\r\n  private _fileId;\r\n  private _dataSource;\r\n  private _loadPromise;\r\n  private _abortController = new AbortController();\r\n  private _status: UploadStatus = UploadStatus.NotStarted;\r\n  private _percentComplete = 0;\r\n\r\n  constructor(file, dataSource) {\r\n    super(EVENTS);\r\n    this._file = file;\r\n    this._fileId = dicomImageLoader.wadouri.fileManager.add(file);\r\n    this._dataSource = dataSource;\r\n  }\r\n\r\n  getFileId(): string {\r\n    return this._fileId;\r\n  }\r\n\r\n  getFileName(): string {\r\n    return this._file.name;\r\n  }\r\n\r\n  getFileSize(): number {\r\n    return this._file.size;\r\n  }\r\n\r\n  cancel(): void {\r\n    this._abortController.abort();\r\n  }\r\n\r\n  getStatus(): UploadStatus {\r\n    return this._status;\r\n  }\r\n\r\n  getPercentComplete(): number {\r\n    return this._percentComplete;\r\n  }\r\n\r\n  async load(): Promise<void> {\r\n    if (this._loadPromise) {\r\n      // Already started loading, return the load promise.\r\n      return this._loadPromise;\r\n    }\r\n\r\n    this._loadPromise = new Promise<void>((resolve, reject) => {\r\n      // The upload listeners: fire progress events and/or settle the promise.\r\n      const uploadCallbacks = {\r\n        progress: evt => {\r\n          if (!evt.lengthComputable) {\r\n            // Progress computation is not possible.\r\n            return;\r\n          }\r\n\r\n          this._status = UploadStatus.InProgress;\r\n\r\n          this._percentComplete = Math.round((100 * evt.loaded) / evt.total);\r\n          this._broadcastEvent(EVENTS.PROGRESS, {\r\n            fileId: this._fileId,\r\n            percentComplete: this._percentComplete,\r\n          });\r\n        },\r\n        timeout: () => {\r\n          this._reject(reject, new UploadRejection(UploadStatus.Failed, 'The request timed out.'));\r\n        },\r\n        abort: () => {\r\n          this._reject(reject, new UploadRejection(UploadStatus.Cancelled, 'Cancelled'));\r\n        },\r\n        error: () => {\r\n          this._reject(reject, new UploadRejection(UploadStatus.Failed, 'The request failed.'));\r\n        },\r\n      };\r\n\r\n      // First try to load the file.\r\n      dicomImageLoader.wadouri\r\n        .loadFileRequest(this._fileId)\r\n        .then(dicomFile => {\r\n          if (this._abortController.signal.aborted) {\r\n            this._reject(reject, new UploadRejection(UploadStatus.Cancelled, 'Cancelled'));\r\n            return;\r\n          }\r\n\r\n          if (!this._checkDicomFile(dicomFile)) {\r\n            // The file is not DICOM\r\n            this._reject(\r\n              reject,\r\n              new UploadRejection(UploadStatus.Failed, 'Not a valid DICOM file.')\r\n            );\r\n            return;\r\n          }\r\n\r\n          const request = new XMLHttpRequest();\r\n          this._addRequestCallbacks(request, uploadCallbacks);\r\n\r\n          // Do the actual upload by supplying the DICOM file and upload callbacks/listeners.\r\n          return this._dataSource.store\r\n            .dicom(dicomFile, request)\r\n            .then(() => {\r\n              this._status = UploadStatus.Success;\r\n              resolve();\r\n            })\r\n            .catch(reason => {\r\n              this._reject(reject, reason);\r\n            });\r\n        })\r\n        .catch(reason => {\r\n          this._reject(reject, reason);\r\n        });\r\n    });\r\n\r\n    return this._loadPromise;\r\n  }\r\n\r\n  private _isRejected(): boolean {\r\n    return this._status === UploadStatus.Failed || this._status === UploadStatus.Cancelled;\r\n  }\r\n\r\n  private _reject(reject: (reason?: any) => void, reason: any) {\r\n    if (this._isRejected()) {\r\n      return;\r\n    }\r\n\r\n    if (reason instanceof UploadRejection) {\r\n      this._status = reason.status;\r\n      reject(reason);\r\n      return;\r\n    }\r\n\r\n    this._status = UploadStatus.Failed;\r\n\r\n    if (reason.message) {\r\n      reject(new UploadRejection(UploadStatus.Failed, reason.message));\r\n      return;\r\n    }\r\n\r\n    reject(new UploadRejection(UploadStatus.Failed, reason));\r\n  }\r\n\r\n  private _addRequestCallbacks(request: XMLHttpRequest, uploadCallbacks) {\r\n    const abortCallback = () => request.abort();\r\n    this._abortController.signal.addEventListener('abort', abortCallback);\r\n\r\n    for (const [eventName, callback] of Object.entries(uploadCallbacks)) {\r\n      request.upload.addEventListener(eventName, callback);\r\n    }\r\n\r\n    const cleanUpCallback = () => {\r\n      this._abortController.signal.removeEventListener('abort', abortCallback);\r\n\r\n      for (const [eventName, callback] of Object.entries(uploadCallbacks)) {\r\n        request.upload.removeEventListener(eventName, callback);\r\n      }\r\n\r\n      request.removeEventListener('loadend', cleanUpCallback);\r\n    };\r\n    request.addEventListener('loadend', cleanUpCallback);\r\n  }\r\n\r\n  private _checkDicomFile(arrayBuffer: ArrayBuffer) {\r\n    if (arrayBuffer.length <= 132) {\r\n      return false;\r\n    }\r\n    const arr = new Uint8Array(arrayBuffer.slice(128, 132));\r\n    // bytes from 128 to 132 must be \"DICM\"\r\n    return Array.from('DICM').every((char, i) => char.charCodeAt(0) === arr[i]);\r\n  }\r\n}\r\n","/**\r\n * Jump Presets - This enum defines the 3 jump states which are available\r\n * to be used with the jumpToSlice utility function.\r\n */\r\nenum JumpPresets {\r\n  /** Jumps to first slice */\r\n  First = 'first',\r\n  /** Jumps to last slice */\r\n  Last = 'last',\r\n  /** Jumps to the middle slice */\r\n  Middle = 'middle',\r\n}\r\n\r\nexport default JumpPresets;\r\n","const colormaps = [\r\n  {\r\n    ColorSpace: 'RGB',\r\n    Name: 'Grayscale',\r\n    NanColor: [1, 0, 0],\r\n    RGBPoints: [0, 0, 0, 0, 1, 1, 1, 1],\r\n    description: 'Grayscale',\r\n  },\r\n  {\r\n    ColorSpace: 'RGB',\r\n    Name: 'X Ray',\r\n    NanColor: [1, 0, 0],\r\n    RGBPoints: [0, 1, 1, 1, 1, 0, 0, 0],\r\n    description: 'X Ray',\r\n  },\r\n  {\r\n    ColorSpace: 'RGB',\r\n    Name: 'Isodose',\r\n    NanColor: [1, 0, 0],\r\n    RGBPoints: [\r\n      0, 0, 1, 0, 0.1, 0.5, 1, 0, 0.2, 1, 1, 0, 0.3, 1, 0.66, 0, 0.4, 1, 0.33, 0, 0.5, 1, 0, 0,\r\n    ],\r\n    description: 'Isodose',\r\n  },\r\n  {\r\n    ColorSpace: 'RGB',\r\n    Name: 'hsv',\r\n    RGBPoints: [\r\n      -1, 1, 0, 0, -0.666666, 1, 0, 1, -0.333333, 0, 0, 1, 0, 0, 1, 1, 0.33333, 0, 1, 0, 0.66666, 1,\r\n      1, 0, 1, 1, 0, 0,\r\n    ],\r\n    description: 'HSV',\r\n  },\r\n  {\r\n    ColorSpace: 'RGB',\r\n    Name: 'hot_iron',\r\n    RGBPoints: [\r\n      0.0, 0.0039215686, 0.0039215686, 0.0156862745, 0.00392156862745098, 0.0039215686,\r\n      0.0039215686, 0.0156862745, 0.00784313725490196, 0.0039215686, 0.0039215686, 0.031372549,\r\n      0.011764705882352941, 0.0039215686, 0.0039215686, 0.0470588235, 0.01568627450980392,\r\n      0.0039215686, 0.0039215686, 0.062745098, 0.0196078431372549, 0.0039215686, 0.0039215686,\r\n      0.0784313725, 0.023529411764705882, 0.0039215686, 0.0039215686, 0.0941176471,\r\n      0.027450980392156862, 0.0039215686, 0.0039215686, 0.1098039216, 0.03137254901960784,\r\n      0.0039215686, 0.0039215686, 0.1254901961, 0.03529411764705882, 0.0039215686, 0.0039215686,\r\n      0.1411764706, 0.0392156862745098, 0.0039215686, 0.0039215686, 0.1568627451,\r\n      0.043137254901960784, 0.0039215686, 0.0039215686, 0.1725490196, 0.047058823529411764,\r\n      0.0039215686, 0.0039215686, 0.1882352941, 0.050980392156862744, 0.0039215686, 0.0039215686,\r\n      0.2039215686, 0.054901960784313725, 0.0039215686, 0.0039215686, 0.2196078431,\r\n      0.05882352941176471, 0.0039215686, 0.0039215686, 0.2352941176, 0.06274509803921569,\r\n      0.0039215686, 0.0039215686, 0.2509803922, 0.06666666666666667, 0.0039215686, 0.0039215686,\r\n      0.262745098, 0.07058823529411765, 0.0039215686, 0.0039215686, 0.2784313725,\r\n      0.07450980392156863, 0.0039215686, 0.0039215686, 0.2941176471, 0.0784313725490196,\r\n      0.0039215686, 0.0039215686, 0.3098039216, 0.08235294117647059, 0.0039215686, 0.0039215686,\r\n      0.3254901961, 0.08627450980392157, 0.0039215686, 0.0039215686, 0.3411764706,\r\n      0.09019607843137255, 0.0039215686, 0.0039215686, 0.3568627451, 0.09411764705882353,\r\n      0.0039215686, 0.0039215686, 0.3725490196, 0.09803921568627451, 0.0039215686, 0.0039215686,\r\n      0.3882352941, 0.10196078431372549, 0.0039215686, 0.0039215686, 0.4039215686,\r\n      0.10588235294117647, 0.0039215686, 0.0039215686, 0.4196078431, 0.10980392156862745,\r\n      0.0039215686, 0.0039215686, 0.4352941176, 0.11372549019607843, 0.0039215686, 0.0039215686,\r\n      0.4509803922, 0.11764705882352942, 0.0039215686, 0.0039215686, 0.4666666667,\r\n      0.12156862745098039, 0.0039215686, 0.0039215686, 0.4823529412, 0.12549019607843137,\r\n      0.0039215686, 0.0039215686, 0.4980392157, 0.12941176470588237, 0.0039215686, 0.0039215686,\r\n      0.5137254902, 0.13333333333333333, 0.0039215686, 0.0039215686, 0.5294117647,\r\n      0.13725490196078433, 0.0039215686, 0.0039215686, 0.5450980392, 0.1411764705882353,\r\n      0.0039215686, 0.0039215686, 0.5607843137, 0.1450980392156863, 0.0039215686, 0.0039215686,\r\n      0.5764705882, 0.14901960784313725, 0.0039215686, 0.0039215686, 0.5921568627,\r\n      0.15294117647058825, 0.0039215686, 0.0039215686, 0.6078431373, 0.1568627450980392,\r\n      0.0039215686, 0.0039215686, 0.6235294118, 0.1607843137254902, 0.0039215686, 0.0039215686,\r\n      0.6392156863, 0.16470588235294117, 0.0039215686, 0.0039215686, 0.6549019608,\r\n      0.16862745098039217, 0.0039215686, 0.0039215686, 0.6705882353, 0.17254901960784313,\r\n      0.0039215686, 0.0039215686, 0.6862745098, 0.17647058823529413, 0.0039215686, 0.0039215686,\r\n      0.7019607843, 0.1803921568627451, 0.0039215686, 0.0039215686, 0.7176470588,\r\n      0.1843137254901961, 0.0039215686, 0.0039215686, 0.7333333333, 0.18823529411764706,\r\n      0.0039215686, 0.0039215686, 0.7490196078, 0.19215686274509805, 0.0039215686, 0.0039215686,\r\n      0.7607843137, 0.19607843137254902, 0.0039215686, 0.0039215686, 0.7764705882, 0.2,\r\n      0.0039215686, 0.0039215686, 0.7921568627, 0.20392156862745098, 0.0039215686, 0.0039215686,\r\n      0.8078431373, 0.20784313725490197, 0.0039215686, 0.0039215686, 0.8235294118,\r\n      0.21176470588235294, 0.0039215686, 0.0039215686, 0.8392156863, 0.21568627450980393,\r\n      0.0039215686, 0.0039215686, 0.8549019608, 0.2196078431372549, 0.0039215686, 0.0039215686,\r\n      0.8705882353, 0.2235294117647059, 0.0039215686, 0.0039215686, 0.8862745098,\r\n      0.22745098039215686, 0.0039215686, 0.0039215686, 0.9019607843, 0.23137254901960785,\r\n      0.0039215686, 0.0039215686, 0.9176470588, 0.23529411764705885, 0.0039215686, 0.0039215686,\r\n      0.9333333333, 0.23921568627450984, 0.0039215686, 0.0039215686, 0.9490196078,\r\n      0.24313725490196078, 0.0039215686, 0.0039215686, 0.9647058824, 0.24705882352941178,\r\n      0.0039215686, 0.0039215686, 0.9803921569, 0.25098039215686274, 0.0039215686, 0.0039215686,\r\n      0.9960784314, 0.2549019607843137, 0.0039215686, 0.0039215686, 0.9960784314,\r\n      0.25882352941176473, 0.0156862745, 0.0039215686, 0.9803921569, 0.2627450980392157,\r\n      0.031372549, 0.0039215686, 0.9647058824, 0.26666666666666666, 0.0470588235, 0.0039215686,\r\n      0.9490196078, 0.27058823529411763, 0.062745098, 0.0039215686, 0.9333333333,\r\n      0.27450980392156865, 0.0784313725, 0.0039215686, 0.9176470588, 0.2784313725490196,\r\n      0.0941176471, 0.0039215686, 0.9019607843, 0.2823529411764706, 0.1098039216, 0.0039215686,\r\n      0.8862745098, 0.28627450980392155, 0.1254901961, 0.0039215686, 0.8705882353,\r\n      0.2901960784313726, 0.1411764706, 0.0039215686, 0.8549019608, 0.29411764705882354,\r\n      0.1568627451, 0.0039215686, 0.8392156863, 0.2980392156862745, 0.1725490196, 0.0039215686,\r\n      0.8235294118, 0.30196078431372547, 0.1882352941, 0.0039215686, 0.8078431373,\r\n      0.3058823529411765, 0.2039215686, 0.0039215686, 0.7921568627, 0.30980392156862746,\r\n      0.2196078431, 0.0039215686, 0.7764705882, 0.3137254901960784, 0.2352941176, 0.0039215686,\r\n      0.7607843137, 0.3176470588235294, 0.2509803922, 0.0039215686, 0.7490196078,\r\n      0.3215686274509804, 0.262745098, 0.0039215686, 0.7333333333, 0.3254901960784314, 0.2784313725,\r\n      0.0039215686, 0.7176470588, 0.32941176470588235, 0.2941176471, 0.0039215686, 0.7019607843,\r\n      0.3333333333333333, 0.3098039216, 0.0039215686, 0.6862745098, 0.33725490196078434,\r\n      0.3254901961, 0.0039215686, 0.6705882353, 0.3411764705882353, 0.3411764706, 0.0039215686,\r\n      0.6549019608, 0.34509803921568627, 0.3568627451, 0.0039215686, 0.6392156863,\r\n      0.34901960784313724, 0.3725490196, 0.0039215686, 0.6235294118, 0.35294117647058826,\r\n      0.3882352941, 0.0039215686, 0.6078431373, 0.3568627450980392, 0.4039215686, 0.0039215686,\r\n      0.5921568627, 0.3607843137254902, 0.4196078431, 0.0039215686, 0.5764705882,\r\n      0.36470588235294116, 0.4352941176, 0.0039215686, 0.5607843137, 0.3686274509803922,\r\n      0.4509803922, 0.0039215686, 0.5450980392, 0.37254901960784315, 0.4666666667, 0.0039215686,\r\n      0.5294117647, 0.3764705882352941, 0.4823529412, 0.0039215686, 0.5137254902,\r\n      0.3803921568627451, 0.4980392157, 0.0039215686, 0.4980392157, 0.3843137254901961,\r\n      0.5137254902, 0.0039215686, 0.4823529412, 0.38823529411764707, 0.5294117647, 0.0039215686,\r\n      0.4666666667, 0.39215686274509803, 0.5450980392, 0.0039215686, 0.4509803922,\r\n      0.396078431372549, 0.5607843137, 0.0039215686, 0.4352941176, 0.4, 0.5764705882, 0.0039215686,\r\n      0.4196078431, 0.403921568627451, 0.5921568627, 0.0039215686, 0.4039215686,\r\n      0.40784313725490196, 0.6078431373, 0.0039215686, 0.3882352941, 0.4117647058823529,\r\n      0.6235294118, 0.0039215686, 0.3725490196, 0.41568627450980394, 0.6392156863, 0.0039215686,\r\n      0.3568627451, 0.4196078431372549, 0.6549019608, 0.0039215686, 0.3411764706,\r\n      0.4235294117647059, 0.6705882353, 0.0039215686, 0.3254901961, 0.42745098039215684,\r\n      0.6862745098, 0.0039215686, 0.3098039216, 0.43137254901960786, 0.7019607843, 0.0039215686,\r\n      0.2941176471, 0.43529411764705883, 0.7176470588, 0.0039215686, 0.2784313725,\r\n      0.4392156862745098, 0.7333333333, 0.0039215686, 0.262745098, 0.44313725490196076,\r\n      0.7490196078, 0.0039215686, 0.2509803922, 0.4470588235294118, 0.7607843137, 0.0039215686,\r\n      0.2352941176, 0.45098039215686275, 0.7764705882, 0.0039215686, 0.2196078431,\r\n      0.4549019607843137, 0.7921568627, 0.0039215686, 0.2039215686, 0.4588235294117647,\r\n      0.8078431373, 0.0039215686, 0.1882352941, 0.4627450980392157, 0.8235294118, 0.0039215686,\r\n      0.1725490196, 0.4666666666666667, 0.8392156863, 0.0039215686, 0.1568627451,\r\n      0.4705882352941177, 0.8549019608, 0.0039215686, 0.1411764706, 0.4745098039215686,\r\n      0.8705882353, 0.0039215686, 0.1254901961, 0.4784313725490197, 0.8862745098, 0.0039215686,\r\n      0.1098039216, 0.48235294117647065, 0.9019607843, 0.0039215686, 0.0941176471,\r\n      0.48627450980392156, 0.9176470588, 0.0039215686, 0.0784313725, 0.49019607843137253,\r\n      0.9333333333, 0.0039215686, 0.062745098, 0.49411764705882355, 0.9490196078, 0.0039215686,\r\n      0.0470588235, 0.4980392156862745, 0.9647058824, 0.0039215686, 0.031372549, 0.5019607843137255,\r\n      0.9803921569, 0.0039215686, 0.0156862745, 0.5058823529411764, 0.9960784314, 0.0039215686,\r\n      0.0039215686, 0.5098039215686274, 0.9960784314, 0.0156862745, 0.0039215686,\r\n      0.5137254901960784, 0.9960784314, 0.031372549, 0.0039215686, 0.5176470588235295, 0.9960784314,\r\n      0.0470588235, 0.0039215686, 0.5215686274509804, 0.9960784314, 0.062745098, 0.0039215686,\r\n      0.5254901960784314, 0.9960784314, 0.0784313725, 0.0039215686, 0.5294117647058824,\r\n      0.9960784314, 0.0941176471, 0.0039215686, 0.5333333333333333, 0.9960784314, 0.1098039216,\r\n      0.0039215686, 0.5372549019607843, 0.9960784314, 0.1254901961, 0.0039215686,\r\n      0.5411764705882353, 0.9960784314, 0.1411764706, 0.0039215686, 0.5450980392156862,\r\n      0.9960784314, 0.1568627451, 0.0039215686, 0.5490196078431373, 0.9960784314, 0.1725490196,\r\n      0.0039215686, 0.5529411764705883, 0.9960784314, 0.1882352941, 0.0039215686,\r\n      0.5568627450980392, 0.9960784314, 0.2039215686, 0.0039215686, 0.5607843137254902,\r\n      0.9960784314, 0.2196078431, 0.0039215686, 0.5647058823529412, 0.9960784314, 0.2352941176,\r\n      0.0039215686, 0.5686274509803921, 0.9960784314, 0.2509803922, 0.0039215686,\r\n      0.5725490196078431, 0.9960784314, 0.262745098, 0.0039215686, 0.5764705882352941, 0.9960784314,\r\n      0.2784313725, 0.0039215686, 0.5803921568627451, 0.9960784314, 0.2941176471, 0.0039215686,\r\n      0.5843137254901961, 0.9960784314, 0.3098039216, 0.0039215686, 0.5882352941176471,\r\n      0.9960784314, 0.3254901961, 0.0039215686, 0.592156862745098, 0.9960784314, 0.3411764706,\r\n      0.0039215686, 0.596078431372549, 0.9960784314, 0.3568627451, 0.0039215686, 0.6, 0.9960784314,\r\n      0.3725490196, 0.0039215686, 0.6039215686274509, 0.9960784314, 0.3882352941, 0.0039215686,\r\n      0.6078431372549019, 0.9960784314, 0.4039215686, 0.0039215686, 0.611764705882353, 0.9960784314,\r\n      0.4196078431, 0.0039215686, 0.615686274509804, 0.9960784314, 0.4352941176, 0.0039215686,\r\n      0.6196078431372549, 0.9960784314, 0.4509803922, 0.0039215686, 0.6235294117647059,\r\n      0.9960784314, 0.4666666667, 0.0039215686, 0.6274509803921569, 0.9960784314, 0.4823529412,\r\n      0.0039215686, 0.6313725490196078, 0.9960784314, 0.4980392157, 0.0039215686,\r\n      0.6352941176470588, 0.9960784314, 0.5137254902, 0.0039215686, 0.6392156862745098,\r\n      0.9960784314, 0.5294117647, 0.0039215686, 0.6431372549019608, 0.9960784314, 0.5450980392,\r\n      0.0039215686, 0.6470588235294118, 0.9960784314, 0.5607843137, 0.0039215686,\r\n      0.6509803921568628, 0.9960784314, 0.5764705882, 0.0039215686, 0.6549019607843137,\r\n      0.9960784314, 0.5921568627, 0.0039215686, 0.6588235294117647, 0.9960784314, 0.6078431373,\r\n      0.0039215686, 0.6627450980392157, 0.9960784314, 0.6235294118, 0.0039215686,\r\n      0.6666666666666666, 0.9960784314, 0.6392156863, 0.0039215686, 0.6705882352941176,\r\n      0.9960784314, 0.6549019608, 0.0039215686, 0.6745098039215687, 0.9960784314, 0.6705882353,\r\n      0.0039215686, 0.6784313725490196, 0.9960784314, 0.6862745098, 0.0039215686,\r\n      0.6823529411764706, 0.9960784314, 0.7019607843, 0.0039215686, 0.6862745098039216,\r\n      0.9960784314, 0.7176470588, 0.0039215686, 0.6901960784313725, 0.9960784314, 0.7333333333,\r\n      0.0039215686, 0.6941176470588235, 0.9960784314, 0.7490196078, 0.0039215686,\r\n      0.6980392156862745, 0.9960784314, 0.7607843137, 0.0039215686, 0.7019607843137254,\r\n      0.9960784314, 0.7764705882, 0.0039215686, 0.7058823529411765, 0.9960784314, 0.7921568627,\r\n      0.0039215686, 0.7098039215686275, 0.9960784314, 0.8078431373, 0.0039215686,\r\n      0.7137254901960784, 0.9960784314, 0.8235294118, 0.0039215686, 0.7176470588235294,\r\n      0.9960784314, 0.8392156863, 0.0039215686, 0.7215686274509804, 0.9960784314, 0.8549019608,\r\n      0.0039215686, 0.7254901960784313, 0.9960784314, 0.8705882353, 0.0039215686,\r\n      0.7294117647058823, 0.9960784314, 0.8862745098, 0.0039215686, 0.7333333333333333,\r\n      0.9960784314, 0.9019607843, 0.0039215686, 0.7372549019607844, 0.9960784314, 0.9176470588,\r\n      0.0039215686, 0.7411764705882353, 0.9960784314, 0.9333333333, 0.0039215686,\r\n      0.7450980392156863, 0.9960784314, 0.9490196078, 0.0039215686, 0.7490196078431373,\r\n      0.9960784314, 0.9647058824, 0.0039215686, 0.7529411764705882, 0.9960784314, 0.9803921569,\r\n      0.0039215686, 0.7568627450980392, 0.9960784314, 0.9960784314, 0.0039215686,\r\n      0.7607843137254902, 0.9960784314, 0.9960784314, 0.0196078431, 0.7647058823529411,\r\n      0.9960784314, 0.9960784314, 0.0352941176, 0.7686274509803922, 0.9960784314, 0.9960784314,\r\n      0.0509803922, 0.7725490196078432, 0.9960784314, 0.9960784314, 0.0666666667,\r\n      0.7764705882352941, 0.9960784314, 0.9960784314, 0.0823529412, 0.7803921568627451,\r\n      0.9960784314, 0.9960784314, 0.0980392157, 0.7843137254901961, 0.9960784314, 0.9960784314,\r\n      0.1137254902, 0.788235294117647, 0.9960784314, 0.9960784314, 0.1294117647, 0.792156862745098,\r\n      0.9960784314, 0.9960784314, 0.1450980392, 0.796078431372549, 0.9960784314, 0.9960784314,\r\n      0.1607843137, 0.8, 0.9960784314, 0.9960784314, 0.1764705882, 0.803921568627451, 0.9960784314,\r\n      0.9960784314, 0.1921568627, 0.807843137254902, 0.9960784314, 0.9960784314, 0.2078431373,\r\n      0.8117647058823529, 0.9960784314, 0.9960784314, 0.2235294118, 0.8156862745098039,\r\n      0.9960784314, 0.9960784314, 0.2392156863, 0.8196078431372549, 0.9960784314, 0.9960784314,\r\n      0.2509803922, 0.8235294117647058, 0.9960784314, 0.9960784314, 0.2666666667,\r\n      0.8274509803921568, 0.9960784314, 0.9960784314, 0.2823529412, 0.8313725490196079,\r\n      0.9960784314, 0.9960784314, 0.2980392157, 0.8352941176470589, 0.9960784314, 0.9960784314,\r\n      0.3137254902, 0.8392156862745098, 0.9960784314, 0.9960784314, 0.3333333333,\r\n      0.8431372549019608, 0.9960784314, 0.9960784314, 0.3490196078, 0.8470588235294118,\r\n      0.9960784314, 0.9960784314, 0.3647058824, 0.8509803921568627, 0.9960784314, 0.9960784314,\r\n      0.3803921569, 0.8549019607843137, 0.9960784314, 0.9960784314, 0.3960784314,\r\n      0.8588235294117647, 0.9960784314, 0.9960784314, 0.4117647059, 0.8627450980392157,\r\n      0.9960784314, 0.9960784314, 0.4274509804, 0.8666666666666667, 0.9960784314, 0.9960784314,\r\n      0.4431372549, 0.8705882352941177, 0.9960784314, 0.9960784314, 0.4588235294,\r\n      0.8745098039215686, 0.9960784314, 0.9960784314, 0.4745098039, 0.8784313725490196,\r\n      0.9960784314, 0.9960784314, 0.4901960784, 0.8823529411764706, 0.9960784314, 0.9960784314,\r\n      0.5058823529, 0.8862745098039215, 0.9960784314, 0.9960784314, 0.5215686275,\r\n      0.8901960784313725, 0.9960784314, 0.9960784314, 0.537254902, 0.8941176470588236, 0.9960784314,\r\n      0.9960784314, 0.5529411765, 0.8980392156862745, 0.9960784314, 0.9960784314, 0.568627451,\r\n      0.9019607843137255, 0.9960784314, 0.9960784314, 0.5843137255, 0.9058823529411765,\r\n      0.9960784314, 0.9960784314, 0.6, 0.9098039215686274, 0.9960784314, 0.9960784314, 0.6156862745,\r\n      0.9137254901960784, 0.9960784314, 0.9960784314, 0.631372549, 0.9176470588235294, 0.9960784314,\r\n      0.9960784314, 0.6470588235, 0.9215686274509803, 0.9960784314, 0.9960784314, 0.6666666667,\r\n      0.9254901960784314, 0.9960784314, 0.9960784314, 0.6823529412, 0.9294117647058824,\r\n      0.9960784314, 0.9960784314, 0.6980392157, 0.9333333333333333, 0.9960784314, 0.9960784314,\r\n      0.7137254902, 0.9372549019607843, 0.9960784314, 0.9960784314, 0.7294117647,\r\n      0.9411764705882354, 0.9960784314, 0.9960784314, 0.7450980392, 0.9450980392156864,\r\n      0.9960784314, 0.9960784314, 0.7568627451, 0.9490196078431372, 0.9960784314, 0.9960784314,\r\n      0.7725490196, 0.9529411764705882, 0.9960784314, 0.9960784314, 0.7882352941,\r\n      0.9568627450980394, 0.9960784314, 0.9960784314, 0.8039215686, 0.9607843137254903,\r\n      0.9960784314, 0.9960784314, 0.8196078431, 0.9647058823529413, 0.9960784314, 0.9960784314,\r\n      0.8352941176, 0.9686274509803922, 0.9960784314, 0.9960784314, 0.8509803922,\r\n      0.9725490196078431, 0.9960784314, 0.9960784314, 0.8666666667, 0.9764705882352941,\r\n      0.9960784314, 0.9960784314, 0.8823529412, 0.9803921568627451, 0.9960784314, 0.9960784314,\r\n      0.8980392157, 0.984313725490196, 0.9960784314, 0.9960784314, 0.9137254902, 0.9882352941176471,\r\n      0.9960784314, 0.9960784314, 0.9294117647, 0.9921568627450981, 0.9960784314, 0.9960784314,\r\n      0.9450980392, 0.996078431372549, 0.9960784314, 0.9960784314, 0.9607843137, 1.0, 0.9960784314,\r\n      0.9960784314, 0.9607843137,\r\n    ],\r\n    description: 'Hot Iron',\r\n  },\r\n  {\r\n    ColorSpace: 'RGB',\r\n    Name: 'red_hot',\r\n    RGBPoints: [\r\n      0.0, 0.0, 0.0, 0.0, 0.00392156862745098, 0.0, 0.0, 0.0, 0.00784313725490196, 0.0, 0.0, 0.0,\r\n      0.011764705882352941, 0.0, 0.0, 0.0, 0.01568627450980392, 0.0039215686, 0.0039215686,\r\n      0.0039215686, 0.0196078431372549, 0.0039215686, 0.0039215686, 0.0039215686,\r\n      0.023529411764705882, 0.0039215686, 0.0039215686, 0.0039215686, 0.027450980392156862,\r\n      0.0039215686, 0.0039215686, 0.0039215686, 0.03137254901960784, 0.0039215686, 0.0039215686,\r\n      0.0039215686, 0.03529411764705882, 0.0156862745, 0.0, 0.0, 0.0392156862745098, 0.0274509804,\r\n      0.0, 0.0, 0.043137254901960784, 0.0392156863, 0.0, 0.0, 0.047058823529411764, 0.0509803922,\r\n      0.0, 0.0, 0.050980392156862744, 0.062745098, 0.0, 0.0, 0.054901960784313725, 0.0784313725,\r\n      0.0, 0.0, 0.05882352941176471, 0.0901960784, 0.0, 0.0, 0.06274509803921569, 0.1058823529, 0.0,\r\n      0.0, 0.06666666666666667, 0.1176470588, 0.0, 0.0, 0.07058823529411765, 0.1294117647, 0.0, 0.0,\r\n      0.07450980392156863, 0.1411764706, 0.0, 0.0, 0.0784313725490196, 0.1529411765, 0.0, 0.0,\r\n      0.08235294117647059, 0.1647058824, 0.0, 0.0, 0.08627450980392157, 0.1764705882, 0.0, 0.0,\r\n      0.09019607843137255, 0.1882352941, 0.0, 0.0, 0.09411764705882353, 0.2039215686, 0.0, 0.0,\r\n      0.09803921568627451, 0.2156862745, 0.0, 0.0, 0.10196078431372549, 0.2274509804, 0.0, 0.0,\r\n      0.10588235294117647, 0.2392156863, 0.0, 0.0, 0.10980392156862745, 0.2549019608, 0.0, 0.0,\r\n      0.11372549019607843, 0.2666666667, 0.0, 0.0, 0.11764705882352942, 0.2784313725, 0.0, 0.0,\r\n      0.12156862745098039, 0.2901960784, 0.0, 0.0, 0.12549019607843137, 0.3058823529, 0.0, 0.0,\r\n      0.12941176470588237, 0.3176470588, 0.0, 0.0, 0.13333333333333333, 0.3294117647, 0.0, 0.0,\r\n      0.13725490196078433, 0.3411764706, 0.0, 0.0, 0.1411764705882353, 0.3529411765, 0.0, 0.0,\r\n      0.1450980392156863, 0.3647058824, 0.0, 0.0, 0.14901960784313725, 0.3764705882, 0.0, 0.0,\r\n      0.15294117647058825, 0.3882352941, 0.0, 0.0, 0.1568627450980392, 0.4039215686, 0.0, 0.0,\r\n      0.1607843137254902, 0.4156862745, 0.0, 0.0, 0.16470588235294117, 0.431372549, 0.0, 0.0,\r\n      0.16862745098039217, 0.4431372549, 0.0, 0.0, 0.17254901960784313, 0.4588235294, 0.0, 0.0,\r\n      0.17647058823529413, 0.4705882353, 0.0, 0.0, 0.1803921568627451, 0.4823529412, 0.0, 0.0,\r\n      0.1843137254901961, 0.4941176471, 0.0, 0.0, 0.18823529411764706, 0.5098039216, 0.0, 0.0,\r\n      0.19215686274509805, 0.5215686275, 0.0, 0.0, 0.19607843137254902, 0.5333333333, 0.0, 0.0, 0.2,\r\n      0.5450980392, 0.0, 0.0, 0.20392156862745098, 0.5568627451, 0.0, 0.0, 0.20784313725490197,\r\n      0.568627451, 0.0, 0.0, 0.21176470588235294, 0.5803921569, 0.0, 0.0, 0.21568627450980393,\r\n      0.5921568627, 0.0, 0.0, 0.2196078431372549, 0.6078431373, 0.0, 0.0, 0.2235294117647059,\r\n      0.6196078431, 0.0, 0.0, 0.22745098039215686, 0.631372549, 0.0, 0.0, 0.23137254901960785,\r\n      0.6431372549, 0.0, 0.0, 0.23529411764705885, 0.6588235294, 0.0, 0.0, 0.23921568627450984,\r\n      0.6705882353, 0.0, 0.0, 0.24313725490196078, 0.6823529412, 0.0, 0.0, 0.24705882352941178,\r\n      0.6941176471, 0.0, 0.0, 0.25098039215686274, 0.7098039216, 0.0, 0.0, 0.2549019607843137,\r\n      0.7215686275, 0.0, 0.0, 0.25882352941176473, 0.7333333333, 0.0, 0.0, 0.2627450980392157,\r\n      0.7450980392, 0.0, 0.0, 0.26666666666666666, 0.7568627451, 0.0, 0.0, 0.27058823529411763,\r\n      0.768627451, 0.0, 0.0, 0.27450980392156865, 0.7843137255, 0.0, 0.0, 0.2784313725490196,\r\n      0.7960784314, 0.0, 0.0, 0.2823529411764706, 0.8117647059, 0.0, 0.0, 0.28627450980392155,\r\n      0.8235294118, 0.0, 0.0, 0.2901960784313726, 0.8352941176, 0.0, 0.0, 0.29411764705882354,\r\n      0.8470588235, 0.0, 0.0, 0.2980392156862745, 0.862745098, 0.0, 0.0, 0.30196078431372547,\r\n      0.8745098039, 0.0, 0.0, 0.3058823529411765, 0.8862745098, 0.0, 0.0, 0.30980392156862746,\r\n      0.8980392157, 0.0, 0.0, 0.3137254901960784, 0.9137254902, 0.0, 0.0, 0.3176470588235294,\r\n      0.9254901961, 0.0, 0.0, 0.3215686274509804, 0.937254902, 0.0, 0.0, 0.3254901960784314,\r\n      0.9490196078, 0.0, 0.0, 0.32941176470588235, 0.9607843137, 0.0, 0.0, 0.3333333333333333,\r\n      0.968627451, 0.0, 0.0, 0.33725490196078434, 0.9803921569, 0.0039215686, 0.0,\r\n      0.3411764705882353, 0.9882352941, 0.0078431373, 0.0, 0.34509803921568627, 1.0, 0.0117647059,\r\n      0.0, 0.34901960784313724, 1.0, 0.0235294118, 0.0, 0.35294117647058826, 1.0, 0.0352941176, 0.0,\r\n      0.3568627450980392, 1.0, 0.0470588235, 0.0, 0.3607843137254902, 1.0, 0.062745098, 0.0,\r\n      0.36470588235294116, 1.0, 0.0745098039, 0.0, 0.3686274509803922, 1.0, 0.0862745098, 0.0,\r\n      0.37254901960784315, 1.0, 0.0980392157, 0.0, 0.3764705882352941, 1.0, 0.1137254902, 0.0,\r\n      0.3803921568627451, 1.0, 0.1254901961, 0.0, 0.3843137254901961, 1.0, 0.137254902, 0.0,\r\n      0.38823529411764707, 1.0, 0.1490196078, 0.0, 0.39215686274509803, 1.0, 0.1647058824, 0.0,\r\n      0.396078431372549, 1.0, 0.1764705882, 0.0, 0.4, 1.0, 0.1882352941, 0.0, 0.403921568627451,\r\n      1.0, 0.2, 0.0, 0.40784313725490196, 1.0, 0.2156862745, 0.0, 0.4117647058823529, 1.0,\r\n      0.2274509804, 0.0, 0.41568627450980394, 1.0, 0.2392156863, 0.0, 0.4196078431372549, 1.0,\r\n      0.2509803922, 0.0, 0.4235294117647059, 1.0, 0.2666666667, 0.0, 0.42745098039215684, 1.0,\r\n      0.2784313725, 0.0, 0.43137254901960786, 1.0, 0.2901960784, 0.0, 0.43529411764705883, 1.0,\r\n      0.3019607843, 0.0, 0.4392156862745098, 1.0, 0.3176470588, 0.0, 0.44313725490196076, 1.0,\r\n      0.3294117647, 0.0, 0.4470588235294118, 1.0, 0.3411764706, 0.0, 0.45098039215686275, 1.0,\r\n      0.3529411765, 0.0, 0.4549019607843137, 1.0, 0.368627451, 0.0, 0.4588235294117647, 1.0,\r\n      0.3803921569, 0.0, 0.4627450980392157, 1.0, 0.3921568627, 0.0, 0.4666666666666667, 1.0,\r\n      0.4039215686, 0.0, 0.4705882352941177, 1.0, 0.4156862745, 0.0, 0.4745098039215686, 1.0,\r\n      0.4274509804, 0.0, 0.4784313725490197, 1.0, 0.4392156863, 0.0, 0.48235294117647065, 1.0,\r\n      0.4509803922, 0.0, 0.48627450980392156, 1.0, 0.4666666667, 0.0, 0.49019607843137253, 1.0,\r\n      0.4784313725, 0.0, 0.49411764705882355, 1.0, 0.4941176471, 0.0, 0.4980392156862745, 1.0,\r\n      0.5058823529, 0.0, 0.5019607843137255, 1.0, 0.5215686275, 0.0, 0.5058823529411764, 1.0,\r\n      0.5333333333, 0.0, 0.5098039215686274, 1.0, 0.5450980392, 0.0, 0.5137254901960784, 1.0,\r\n      0.5568627451, 0.0, 0.5176470588235295, 1.0, 0.568627451, 0.0, 0.5215686274509804, 1.0,\r\n      0.5803921569, 0.0, 0.5254901960784314, 1.0, 0.5921568627, 0.0, 0.5294117647058824, 1.0,\r\n      0.6039215686, 0.0, 0.5333333333333333, 1.0, 0.6196078431, 0.0, 0.5372549019607843, 1.0,\r\n      0.631372549, 0.0, 0.5411764705882353, 1.0, 0.6431372549, 0.0, 0.5450980392156862, 1.0,\r\n      0.6549019608, 0.0, 0.5490196078431373, 1.0, 0.6705882353, 0.0, 0.5529411764705883, 1.0,\r\n      0.6823529412, 0.0, 0.5568627450980392, 1.0, 0.6941176471, 0.0, 0.5607843137254902, 1.0,\r\n      0.7058823529, 0.0, 0.5647058823529412, 1.0, 0.7215686275, 0.0, 0.5686274509803921, 1.0,\r\n      0.7333333333, 0.0, 0.5725490196078431, 1.0, 0.7450980392, 0.0, 0.5764705882352941, 1.0,\r\n      0.7568627451, 0.0, 0.5803921568627451, 1.0, 0.7725490196, 0.0, 0.5843137254901961, 1.0,\r\n      0.7843137255, 0.0, 0.5882352941176471, 1.0, 0.7960784314, 0.0, 0.592156862745098, 1.0,\r\n      0.8078431373, 0.0, 0.596078431372549, 1.0, 0.8196078431, 0.0, 0.6, 1.0, 0.831372549, 0.0,\r\n      0.6039215686274509, 1.0, 0.8470588235, 0.0, 0.6078431372549019, 1.0, 0.8588235294, 0.0,\r\n      0.611764705882353, 1.0, 0.8745098039, 0.0, 0.615686274509804, 1.0, 0.8862745098, 0.0,\r\n      0.6196078431372549, 1.0, 0.8980392157, 0.0, 0.6235294117647059, 1.0, 0.9098039216, 0.0,\r\n      0.6274509803921569, 1.0, 0.9254901961, 0.0, 0.6313725490196078, 1.0, 0.937254902, 0.0,\r\n      0.6352941176470588, 1.0, 0.9490196078, 0.0, 0.6392156862745098, 1.0, 0.9607843137, 0.0,\r\n      0.6431372549019608, 1.0, 0.9764705882, 0.0, 0.6470588235294118, 1.0, 0.9803921569,\r\n      0.0039215686, 0.6509803921568628, 1.0, 0.9882352941, 0.0117647059, 0.6549019607843137, 1.0,\r\n      0.9921568627, 0.0156862745, 0.6588235294117647, 1.0, 1.0, 0.0235294118, 0.6627450980392157,\r\n      1.0, 1.0, 0.0352941176, 0.6666666666666666, 1.0, 1.0, 0.0470588235, 0.6705882352941176, 1.0,\r\n      1.0, 0.0588235294, 0.6745098039215687, 1.0, 1.0, 0.0745098039, 0.6784313725490196, 1.0, 1.0,\r\n      0.0862745098, 0.6823529411764706, 1.0, 1.0, 0.0980392157, 0.6862745098039216, 1.0, 1.0,\r\n      0.1098039216, 0.6901960784313725, 1.0, 1.0, 0.1254901961, 0.6941176470588235, 1.0, 1.0,\r\n      0.137254902, 0.6980392156862745, 1.0, 1.0, 0.1490196078, 0.7019607843137254, 1.0, 1.0,\r\n      0.1607843137, 0.7058823529411765, 1.0, 1.0, 0.1764705882, 0.7098039215686275, 1.0, 1.0,\r\n      0.1882352941, 0.7137254901960784, 1.0, 1.0, 0.2, 0.7176470588235294, 1.0, 1.0, 0.2117647059,\r\n      0.7215686274509804, 1.0, 1.0, 0.2274509804, 0.7254901960784313, 1.0, 1.0, 0.2392156863,\r\n      0.7294117647058823, 1.0, 1.0, 0.2509803922, 0.7333333333333333, 1.0, 1.0, 0.262745098,\r\n      0.7372549019607844, 1.0, 1.0, 0.2784313725, 0.7411764705882353, 1.0, 1.0, 0.2901960784,\r\n      0.7450980392156863, 1.0, 1.0, 0.3019607843, 0.7490196078431373, 1.0, 1.0, 0.3137254902,\r\n      0.7529411764705882, 1.0, 1.0, 0.3294117647, 0.7568627450980392, 1.0, 1.0, 0.3411764706,\r\n      0.7607843137254902, 1.0, 1.0, 0.3529411765, 0.7647058823529411, 1.0, 1.0, 0.3647058824,\r\n      0.7686274509803922, 1.0, 1.0, 0.3803921569, 0.7725490196078432, 1.0, 1.0, 0.3921568627,\r\n      0.7764705882352941, 1.0, 1.0, 0.4039215686, 0.7803921568627451, 1.0, 1.0, 0.4156862745,\r\n      0.7843137254901961, 1.0, 1.0, 0.431372549, 0.788235294117647, 1.0, 1.0, 0.4431372549,\r\n      0.792156862745098, 1.0, 1.0, 0.4549019608, 0.796078431372549, 1.0, 1.0, 0.4666666667, 0.8,\r\n      1.0, 1.0, 0.4784313725, 0.803921568627451, 1.0, 1.0, 0.4901960784, 0.807843137254902, 1.0,\r\n      1.0, 0.5019607843, 0.8117647058823529, 1.0, 1.0, 0.5137254902, 0.8156862745098039, 1.0, 1.0,\r\n      0.5294117647, 0.8196078431372549, 1.0, 1.0, 0.5411764706, 0.8235294117647058, 1.0, 1.0,\r\n      0.5568627451, 0.8274509803921568, 1.0, 1.0, 0.568627451, 0.8313725490196079, 1.0, 1.0,\r\n      0.5843137255, 0.8352941176470589, 1.0, 1.0, 0.5960784314, 0.8392156862745098, 1.0, 1.0,\r\n      0.6078431373, 0.8431372549019608, 1.0, 1.0, 0.6196078431, 0.8470588235294118, 1.0, 1.0,\r\n      0.631372549, 0.8509803921568627, 1.0, 1.0, 0.6431372549, 0.8549019607843137, 1.0, 1.0,\r\n      0.6549019608, 0.8588235294117647, 1.0, 1.0, 0.6666666667, 0.8627450980392157, 1.0, 1.0,\r\n      0.6823529412, 0.8666666666666667, 1.0, 1.0, 0.6941176471, 0.8705882352941177, 1.0, 1.0,\r\n      0.7058823529, 0.8745098039215686, 1.0, 1.0, 0.7176470588, 0.8784313725490196, 1.0, 1.0,\r\n      0.7333333333, 0.8823529411764706, 1.0, 1.0, 0.7450980392, 0.8862745098039215, 1.0, 1.0,\r\n      0.7568627451, 0.8901960784313725, 1.0, 1.0, 0.768627451, 0.8941176470588236, 1.0, 1.0,\r\n      0.7843137255, 0.8980392156862745, 1.0, 1.0, 0.7960784314, 0.9019607843137255, 1.0, 1.0,\r\n      0.8078431373, 0.9058823529411765, 1.0, 1.0, 0.8196078431, 0.9098039215686274, 1.0, 1.0,\r\n      0.8352941176, 0.9137254901960784, 1.0, 1.0, 0.8470588235, 0.9176470588235294, 1.0, 1.0,\r\n      0.8588235294, 0.9215686274509803, 1.0, 1.0, 0.8705882353, 0.9254901960784314, 1.0, 1.0,\r\n      0.8823529412, 0.9294117647058824, 1.0, 1.0, 0.8941176471, 0.9333333333333333, 1.0, 1.0,\r\n      0.9098039216, 0.9372549019607843, 1.0, 1.0, 0.9215686275, 0.9411764705882354, 1.0, 1.0,\r\n      0.937254902, 0.9450980392156864, 1.0, 1.0, 0.9490196078, 0.9490196078431372, 1.0, 1.0,\r\n      0.9607843137, 0.9529411764705882, 1.0, 1.0, 0.9725490196, 0.9568627450980394, 1.0, 1.0,\r\n      0.9882352941, 0.9607843137254903, 1.0, 1.0, 0.9882352941, 0.9647058823529413, 1.0, 1.0,\r\n      0.9921568627, 0.9686274509803922, 1.0, 1.0, 0.9960784314, 0.9725490196078431, 1.0, 1.0, 1.0,\r\n      0.9764705882352941, 1.0, 1.0, 1.0, 0.9803921568627451, 1.0, 1.0, 1.0, 0.984313725490196, 1.0,\r\n      1.0, 1.0, 0.9882352941176471, 1.0, 1.0, 1.0, 0.9921568627450981, 1.0, 1.0, 1.0,\r\n      0.996078431372549, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,\r\n    ],\r\n    description: 'Red Hot',\r\n  },\r\n  {\r\n    ColorSpace: 'RGB',\r\n    Name: 's_pet',\r\n    RGBPoints: [\r\n      0.0, 0.0156862745, 0.0039215686, 0.0156862745, 0.00392156862745098, 0.0156862745,\r\n      0.0039215686, 0.0156862745, 0.00784313725490196, 0.0274509804, 0.0039215686, 0.031372549,\r\n      0.011764705882352941, 0.0352941176, 0.0039215686, 0.0509803922, 0.01568627450980392,\r\n      0.0392156863, 0.0039215686, 0.0666666667, 0.0196078431372549, 0.0509803922, 0.0039215686,\r\n      0.0823529412, 0.023529411764705882, 0.062745098, 0.0039215686, 0.0980392157,\r\n      0.027450980392156862, 0.0705882353, 0.0039215686, 0.1176470588, 0.03137254901960784,\r\n      0.0745098039, 0.0039215686, 0.1333333333, 0.03529411764705882, 0.0862745098, 0.0039215686,\r\n      0.1490196078, 0.0392156862745098, 0.0980392157, 0.0039215686, 0.1647058824,\r\n      0.043137254901960784, 0.1058823529, 0.0039215686, 0.1843137255, 0.047058823529411764,\r\n      0.1098039216, 0.0039215686, 0.2, 0.050980392156862744, 0.1215686275, 0.0039215686,\r\n      0.2156862745, 0.054901960784313725, 0.1333333333, 0.0039215686, 0.231372549,\r\n      0.05882352941176471, 0.137254902, 0.0039215686, 0.2509803922, 0.06274509803921569,\r\n      0.1490196078, 0.0039215686, 0.262745098, 0.06666666666666667, 0.1607843137, 0.0039215686,\r\n      0.2784313725, 0.07058823529411765, 0.168627451, 0.0039215686, 0.2941176471,\r\n      0.07450980392156863, 0.1725490196, 0.0039215686, 0.3137254902, 0.0784313725490196,\r\n      0.1843137255, 0.0039215686, 0.3294117647, 0.08235294117647059, 0.1960784314, 0.0039215686,\r\n      0.3450980392, 0.08627450980392157, 0.2039215686, 0.0039215686, 0.3607843137,\r\n      0.09019607843137255, 0.2078431373, 0.0039215686, 0.3803921569, 0.09411764705882353,\r\n      0.2196078431, 0.0039215686, 0.3960784314, 0.09803921568627451, 0.231372549, 0.0039215686,\r\n      0.4117647059, 0.10196078431372549, 0.2392156863, 0.0039215686, 0.4274509804,\r\n      0.10588235294117647, 0.2431372549, 0.0039215686, 0.4470588235, 0.10980392156862745,\r\n      0.2509803922, 0.0039215686, 0.462745098, 0.11372549019607843, 0.262745098, 0.0039215686,\r\n      0.4784313725, 0.11764705882352942, 0.2666666667, 0.0039215686, 0.4980392157,\r\n      0.12156862745098039, 0.2666666667, 0.0039215686, 0.4980392157, 0.12549019607843137,\r\n      0.262745098, 0.0039215686, 0.5137254902, 0.12941176470588237, 0.2509803922, 0.0039215686,\r\n      0.5294117647, 0.13333333333333333, 0.2431372549, 0.0039215686, 0.5450980392,\r\n      0.13725490196078433, 0.2392156863, 0.0039215686, 0.5607843137, 0.1411764705882353,\r\n      0.231372549, 0.0039215686, 0.5764705882, 0.1450980392156863, 0.2196078431, 0.0039215686,\r\n      0.5921568627, 0.14901960784313725, 0.2078431373, 0.0039215686, 0.6078431373,\r\n      0.15294117647058825, 0.2039215686, 0.0039215686, 0.6235294118, 0.1568627450980392,\r\n      0.1960784314, 0.0039215686, 0.6392156863, 0.1607843137254902, 0.1843137255, 0.0039215686,\r\n      0.6549019608, 0.16470588235294117, 0.1725490196, 0.0039215686, 0.6705882353,\r\n      0.16862745098039217, 0.168627451, 0.0039215686, 0.6862745098, 0.17254901960784313,\r\n      0.1607843137, 0.0039215686, 0.7019607843, 0.17647058823529413, 0.1490196078, 0.0039215686,\r\n      0.7176470588, 0.1803921568627451, 0.137254902, 0.0039215686, 0.7333333333, 0.1843137254901961,\r\n      0.1333333333, 0.0039215686, 0.7490196078, 0.18823529411764706, 0.1215686275, 0.0039215686,\r\n      0.7607843137, 0.19215686274509805, 0.1098039216, 0.0039215686, 0.7764705882,\r\n      0.19607843137254902, 0.1058823529, 0.0039215686, 0.7921568627, 0.2, 0.0980392157,\r\n      0.0039215686, 0.8078431373, 0.20392156862745098, 0.0862745098, 0.0039215686, 0.8235294118,\r\n      0.20784313725490197, 0.0745098039, 0.0039215686, 0.8392156863, 0.21176470588235294,\r\n      0.0705882353, 0.0039215686, 0.8549019608, 0.21568627450980393, 0.062745098, 0.0039215686,\r\n      0.8705882353, 0.2196078431372549, 0.0509803922, 0.0039215686, 0.8862745098,\r\n      0.2235294117647059, 0.0392156863, 0.0039215686, 0.9019607843, 0.22745098039215686,\r\n      0.0352941176, 0.0039215686, 0.9176470588, 0.23137254901960785, 0.0274509804, 0.0039215686,\r\n      0.9333333333, 0.23529411764705885, 0.0156862745, 0.0039215686, 0.9490196078,\r\n      0.23921568627450984, 0.0078431373, 0.0039215686, 0.9647058824, 0.24313725490196078,\r\n      0.0039215686, 0.0039215686, 0.9960784314, 0.24705882352941178, 0.0039215686, 0.0039215686,\r\n      0.9960784314, 0.25098039215686274, 0.0039215686, 0.0196078431, 0.9647058824,\r\n      0.2549019607843137, 0.0039215686, 0.0392156863, 0.9490196078, 0.25882352941176473,\r\n      0.0039215686, 0.0549019608, 0.9333333333, 0.2627450980392157, 0.0039215686, 0.0745098039,\r\n      0.9176470588, 0.26666666666666666, 0.0039215686, 0.0901960784, 0.9019607843,\r\n      0.27058823529411763, 0.0039215686, 0.1098039216, 0.8862745098, 0.27450980392156865,\r\n      0.0039215686, 0.1254901961, 0.8705882353, 0.2784313725490196, 0.0039215686, 0.1450980392,\r\n      0.8549019608, 0.2823529411764706, 0.0039215686, 0.1607843137, 0.8392156863,\r\n      0.28627450980392155, 0.0039215686, 0.1803921569, 0.8235294118, 0.2901960784313726,\r\n      0.0039215686, 0.1960784314, 0.8078431373, 0.29411764705882354, 0.0039215686, 0.2156862745,\r\n      0.7921568627, 0.2980392156862745, 0.0039215686, 0.231372549, 0.7764705882,\r\n      0.30196078431372547, 0.0039215686, 0.2509803922, 0.7607843137, 0.3058823529411765,\r\n      0.0039215686, 0.262745098, 0.7490196078, 0.30980392156862746, 0.0039215686, 0.2823529412,\r\n      0.7333333333, 0.3137254901960784, 0.0039215686, 0.2980392157, 0.7176470588,\r\n      0.3176470588235294, 0.0039215686, 0.3176470588, 0.7019607843, 0.3215686274509804,\r\n      0.0039215686, 0.3333333333, 0.6862745098, 0.3254901960784314, 0.0039215686, 0.3529411765,\r\n      0.6705882353, 0.32941176470588235, 0.0039215686, 0.368627451, 0.6549019608,\r\n      0.3333333333333333, 0.0039215686, 0.3882352941, 0.6392156863, 0.33725490196078434,\r\n      0.0039215686, 0.4039215686, 0.6235294118, 0.3411764705882353, 0.0039215686, 0.4235294118,\r\n      0.6078431373, 0.34509803921568627, 0.0039215686, 0.4392156863, 0.5921568627,\r\n      0.34901960784313724, 0.0039215686, 0.4588235294, 0.5764705882, 0.35294117647058826,\r\n      0.0039215686, 0.4745098039, 0.5607843137, 0.3568627450980392, 0.0039215686, 0.4941176471,\r\n      0.5450980392, 0.3607843137254902, 0.0039215686, 0.5098039216, 0.5294117647,\r\n      0.36470588235294116, 0.0039215686, 0.5294117647, 0.5137254902, 0.3686274509803922,\r\n      0.0039215686, 0.5450980392, 0.4980392157, 0.37254901960784315, 0.0039215686, 0.5647058824,\r\n      0.4784313725, 0.3764705882352941, 0.0039215686, 0.5803921569, 0.462745098, 0.3803921568627451,\r\n      0.0039215686, 0.6, 0.4470588235, 0.3843137254901961, 0.0039215686, 0.6156862745, 0.4274509804,\r\n      0.38823529411764707, 0.0039215686, 0.6352941176, 0.4117647059, 0.39215686274509803,\r\n      0.0039215686, 0.6509803922, 0.3960784314, 0.396078431372549, 0.0039215686, 0.6705882353,\r\n      0.3803921569, 0.4, 0.0039215686, 0.6862745098, 0.3607843137, 0.403921568627451, 0.0039215686,\r\n      0.7058823529, 0.3450980392, 0.40784313725490196, 0.0039215686, 0.7215686275, 0.3294117647,\r\n      0.4117647058823529, 0.0039215686, 0.7411764706, 0.3137254902, 0.41568627450980394,\r\n      0.0039215686, 0.7529411765, 0.2941176471, 0.4196078431372549, 0.0039215686, 0.7960784314,\r\n      0.2784313725, 0.4235294117647059, 0.0039215686, 0.7960784314, 0.262745098,\r\n      0.42745098039215684, 0.0392156863, 0.8039215686, 0.2509803922, 0.43137254901960786,\r\n      0.0745098039, 0.8117647059, 0.231372549, 0.43529411764705883, 0.1098039216, 0.8196078431,\r\n      0.2156862745, 0.4392156862745098, 0.1450980392, 0.8274509804, 0.2, 0.44313725490196076,\r\n      0.1803921569, 0.8352941176, 0.1843137255, 0.4470588235294118, 0.2156862745, 0.8431372549,\r\n      0.1647058824, 0.45098039215686275, 0.2509803922, 0.8509803922, 0.1490196078,\r\n      0.4549019607843137, 0.2823529412, 0.8588235294, 0.1333333333, 0.4588235294117647,\r\n      0.3176470588, 0.8666666667, 0.1176470588, 0.4627450980392157, 0.3529411765, 0.8745098039,\r\n      0.0980392157, 0.4666666666666667, 0.3882352941, 0.8823529412, 0.0823529412,\r\n      0.4705882352941177, 0.4235294118, 0.8901960784, 0.0666666667, 0.4745098039215686,\r\n      0.4588235294, 0.8980392157, 0.0509803922, 0.4784313725490197, 0.4941176471, 0.9058823529,\r\n      0.0431372549, 0.48235294117647065, 0.5294117647, 0.9137254902, 0.031372549,\r\n      0.48627450980392156, 0.5647058824, 0.9215686275, 0.0196078431, 0.49019607843137253, 0.6,\r\n      0.9294117647, 0.0078431373, 0.49411764705882355, 0.6352941176, 0.937254902, 0.0039215686,\r\n      0.4980392156862745, 0.6705882353, 0.9450980392, 0.0039215686, 0.5019607843137255,\r\n      0.7058823529, 0.9490196078, 0.0039215686, 0.5058823529411764, 0.7411764706, 0.9568627451,\r\n      0.0039215686, 0.5098039215686274, 0.7725490196, 0.9607843137, 0.0039215686,\r\n      0.5137254901960784, 0.8078431373, 0.968627451, 0.0039215686, 0.5176470588235295, 0.8431372549,\r\n      0.9725490196, 0.0039215686, 0.5215686274509804, 0.8784313725, 0.9803921569, 0.0039215686,\r\n      0.5254901960784314, 0.9137254902, 0.9843137255, 0.0039215686, 0.5294117647058824,\r\n      0.9490196078, 0.9921568627, 0.0039215686, 0.5333333333333333, 0.9960784314, 0.9960784314,\r\n      0.0039215686, 0.5372549019607843, 0.9960784314, 0.9960784314, 0.0039215686,\r\n      0.5411764705882353, 0.9960784314, 0.9921568627, 0.0039215686, 0.5450980392156862,\r\n      0.9960784314, 0.9843137255, 0.0039215686, 0.5490196078431373, 0.9960784314, 0.9764705882,\r\n      0.0039215686, 0.5529411764705883, 0.9960784314, 0.968627451, 0.0039215686, 0.5568627450980392,\r\n      0.9960784314, 0.9607843137, 0.0039215686, 0.5607843137254902, 0.9960784314, 0.9529411765,\r\n      0.0039215686, 0.5647058823529412, 0.9960784314, 0.9450980392, 0.0039215686,\r\n      0.5686274509803921, 0.9960784314, 0.937254902, 0.0039215686, 0.5725490196078431, 0.9960784314,\r\n      0.9294117647, 0.0039215686, 0.5764705882352941, 0.9960784314, 0.9215686275, 0.0039215686,\r\n      0.5803921568627451, 0.9960784314, 0.9137254902, 0.0039215686, 0.5843137254901961,\r\n      0.9960784314, 0.9058823529, 0.0039215686, 0.5882352941176471, 0.9960784314, 0.8980392157,\r\n      0.0039215686, 0.592156862745098, 0.9960784314, 0.8901960784, 0.0039215686, 0.596078431372549,\r\n      0.9960784314, 0.8823529412, 0.0039215686, 0.6, 0.9960784314, 0.8745098039, 0.0039215686,\r\n      0.6039215686274509, 0.9960784314, 0.8666666667, 0.0039215686, 0.6078431372549019,\r\n      0.9960784314, 0.8588235294, 0.0039215686, 0.611764705882353, 0.9960784314, 0.8509803922,\r\n      0.0039215686, 0.615686274509804, 0.9960784314, 0.8431372549, 0.0039215686, 0.6196078431372549,\r\n      0.9960784314, 0.8352941176, 0.0039215686, 0.6235294117647059, 0.9960784314, 0.8274509804,\r\n      0.0039215686, 0.6274509803921569, 0.9960784314, 0.8196078431, 0.0039215686,\r\n      0.6313725490196078, 0.9960784314, 0.8117647059, 0.0039215686, 0.6352941176470588,\r\n      0.9960784314, 0.8039215686, 0.0039215686, 0.6392156862745098, 0.9960784314, 0.7960784314,\r\n      0.0039215686, 0.6431372549019608, 0.9960784314, 0.7882352941, 0.0039215686,\r\n      0.6470588235294118, 0.9960784314, 0.7803921569, 0.0039215686, 0.6509803921568628,\r\n      0.9960784314, 0.7725490196, 0.0039215686, 0.6549019607843137, 0.9960784314, 0.7647058824,\r\n      0.0039215686, 0.6588235294117647, 0.9960784314, 0.7568627451, 0.0039215686,\r\n      0.6627450980392157, 0.9960784314, 0.7490196078, 0.0039215686, 0.6666666666666666,\r\n      0.9960784314, 0.7450980392, 0.0039215686, 0.6705882352941176, 0.9960784314, 0.737254902,\r\n      0.0039215686, 0.6745098039215687, 0.9960784314, 0.7294117647, 0.0039215686,\r\n      0.6784313725490196, 0.9960784314, 0.7215686275, 0.0039215686, 0.6823529411764706,\r\n      0.9960784314, 0.7137254902, 0.0039215686, 0.6862745098039216, 0.9960784314, 0.7058823529,\r\n      0.0039215686, 0.6901960784313725, 0.9960784314, 0.6980392157, 0.0039215686,\r\n      0.6941176470588235, 0.9960784314, 0.6901960784, 0.0039215686, 0.6980392156862745,\r\n      0.9960784314, 0.6823529412, 0.0039215686, 0.7019607843137254, 0.9960784314, 0.6745098039,\r\n      0.0039215686, 0.7058823529411765, 0.9960784314, 0.6666666667, 0.0039215686,\r\n      0.7098039215686275, 0.9960784314, 0.6588235294, 0.0039215686, 0.7137254901960784,\r\n      0.9960784314, 0.6509803922, 0.0039215686, 0.7176470588235294, 0.9960784314, 0.6431372549,\r\n      0.0039215686, 0.7215686274509804, 0.9960784314, 0.6352941176, 0.0039215686,\r\n      0.7254901960784313, 0.9960784314, 0.6274509804, 0.0039215686, 0.7294117647058823,\r\n      0.9960784314, 0.6196078431, 0.0039215686, 0.7333333333333333, 0.9960784314, 0.6117647059,\r\n      0.0039215686, 0.7372549019607844, 0.9960784314, 0.6039215686, 0.0039215686,\r\n      0.7411764705882353, 0.9960784314, 0.5960784314, 0.0039215686, 0.7450980392156863,\r\n      0.9960784314, 0.5882352941, 0.0039215686, 0.7490196078431373, 0.9960784314, 0.5803921569,\r\n      0.0039215686, 0.7529411764705882, 0.9960784314, 0.5725490196, 0.0039215686,\r\n      0.7568627450980392, 0.9960784314, 0.5647058824, 0.0039215686, 0.7607843137254902,\r\n      0.9960784314, 0.5568627451, 0.0039215686, 0.7647058823529411, 0.9960784314, 0.5490196078,\r\n      0.0039215686, 0.7686274509803922, 0.9960784314, 0.5411764706, 0.0039215686,\r\n      0.7725490196078432, 0.9960784314, 0.5333333333, 0.0039215686, 0.7764705882352941,\r\n      0.9960784314, 0.5254901961, 0.0039215686, 0.7803921568627451, 0.9960784314, 0.5176470588,\r\n      0.0039215686, 0.7843137254901961, 0.9960784314, 0.5098039216, 0.0039215686, 0.788235294117647,\r\n      0.9960784314, 0.5019607843, 0.0039215686, 0.792156862745098, 0.9960784314, 0.4941176471,\r\n      0.0039215686, 0.796078431372549, 0.9960784314, 0.4862745098, 0.0039215686, 0.8, 0.9960784314,\r\n      0.4784313725, 0.0039215686, 0.803921568627451, 0.9960784314, 0.4705882353, 0.0039215686,\r\n      0.807843137254902, 0.9960784314, 0.462745098, 0.0039215686, 0.8117647058823529, 0.9960784314,\r\n      0.4549019608, 0.0039215686, 0.8156862745098039, 0.9960784314, 0.4470588235, 0.0039215686,\r\n      0.8196078431372549, 0.9960784314, 0.4392156863, 0.0039215686, 0.8235294117647058,\r\n      0.9960784314, 0.431372549, 0.0039215686, 0.8274509803921568, 0.9960784314, 0.4235294118,\r\n      0.0039215686, 0.8313725490196079, 0.9960784314, 0.4156862745, 0.0039215686,\r\n      0.8352941176470589, 0.9960784314, 0.4078431373, 0.0039215686, 0.8392156862745098,\r\n      0.9960784314, 0.4, 0.0039215686, 0.8431372549019608, 0.9960784314, 0.3921568627, 0.0039215686,\r\n      0.8470588235294118, 0.9960784314, 0.3843137255, 0.0039215686, 0.8509803921568627,\r\n      0.9960784314, 0.3764705882, 0.0039215686, 0.8549019607843137, 0.9960784314, 0.368627451,\r\n      0.0039215686, 0.8588235294117647, 0.9960784314, 0.3607843137, 0.0039215686,\r\n      0.8627450980392157, 0.9960784314, 0.3529411765, 0.0039215686, 0.8666666666666667,\r\n      0.9960784314, 0.3450980392, 0.0039215686, 0.8705882352941177, 0.9960784314, 0.337254902,\r\n      0.0039215686, 0.8745098039215686, 0.9960784314, 0.3294117647, 0.0039215686,\r\n      0.8784313725490196, 0.9960784314, 0.3215686275, 0.0039215686, 0.8823529411764706,\r\n      0.9960784314, 0.3137254902, 0.0039215686, 0.8862745098039215, 0.9960784314, 0.3058823529,\r\n      0.0039215686, 0.8901960784313725, 0.9960784314, 0.2980392157, 0.0039215686,\r\n      0.8941176470588236, 0.9960784314, 0.2901960784, 0.0039215686, 0.8980392156862745,\r\n      0.9960784314, 0.2823529412, 0.0039215686, 0.9019607843137255, 0.9960784314, 0.2705882353,\r\n      0.0039215686, 0.9058823529411765, 0.9960784314, 0.2588235294, 0.0039215686,\r\n      0.9098039215686274, 0.9960784314, 0.2509803922, 0.0039215686, 0.9137254901960784,\r\n      0.9960784314, 0.2431372549, 0.0039215686, 0.9176470588235294, 0.9960784314, 0.231372549,\r\n      0.0039215686, 0.9215686274509803, 0.9960784314, 0.2196078431, 0.0039215686,\r\n      0.9254901960784314, 0.9960784314, 0.2117647059, 0.0039215686, 0.9294117647058824,\r\n      0.9960784314, 0.2, 0.0039215686, 0.9333333333333333, 0.9960784314, 0.1882352941, 0.0039215686,\r\n      0.9372549019607843, 0.9960784314, 0.1764705882, 0.0039215686, 0.9411764705882354,\r\n      0.9960784314, 0.168627451, 0.0039215686, 0.9450980392156864, 0.9960784314, 0.1568627451,\r\n      0.0039215686, 0.9490196078431372, 0.9960784314, 0.1450980392, 0.0039215686,\r\n      0.9529411764705882, 0.9960784314, 0.1333333333, 0.0039215686, 0.9568627450980394,\r\n      0.9960784314, 0.1254901961, 0.0039215686, 0.9607843137254903, 0.9960784314, 0.1137254902,\r\n      0.0039215686, 0.9647058823529413, 0.9960784314, 0.1019607843, 0.0039215686,\r\n      0.9686274509803922, 0.9960784314, 0.0901960784, 0.0039215686, 0.9725490196078431,\r\n      0.9960784314, 0.0823529412, 0.0039215686, 0.9764705882352941, 0.9960784314, 0.0705882353,\r\n      0.0039215686, 0.9803921568627451, 0.9960784314, 0.0588235294, 0.0039215686, 0.984313725490196,\r\n      0.9960784314, 0.0470588235, 0.0039215686, 0.9882352941176471, 0.9960784314, 0.0392156863,\r\n      0.0039215686, 0.9921568627450981, 0.9960784314, 0.0274509804, 0.0039215686, 0.996078431372549,\r\n      0.9960784314, 0.0156862745, 0.0039215686, 1.0, 0.9960784314, 0.0156862745, 0.0039215686,\r\n    ],\r\n    description: 'S PET',\r\n  },\r\n  {\r\n    ColorSpace: 'RGB',\r\n    Name: 'perfusion',\r\n    RGBPoints: [\r\n      0.0, 0.0, 0.0, 0.0, 0.00392156862745098, 0.0078431373, 0.0235294118, 0.0235294118,\r\n      0.00784313725490196, 0.0078431373, 0.031372549, 0.0470588235, 0.011764705882352941,\r\n      0.0078431373, 0.0392156863, 0.062745098, 0.01568627450980392, 0.0078431373, 0.0470588235,\r\n      0.0862745098, 0.0196078431372549, 0.0078431373, 0.0549019608, 0.1019607843,\r\n      0.023529411764705882, 0.0078431373, 0.0549019608, 0.1254901961, 0.027450980392156862,\r\n      0.0078431373, 0.062745098, 0.1411764706, 0.03137254901960784, 0.0078431373, 0.0705882353,\r\n      0.1647058824, 0.03529411764705882, 0.0078431373, 0.0784313725, 0.1803921569,\r\n      0.0392156862745098, 0.0078431373, 0.0862745098, 0.2039215686, 0.043137254901960784,\r\n      0.0078431373, 0.0862745098, 0.2196078431, 0.047058823529411764, 0.0078431373, 0.0941176471,\r\n      0.2431372549, 0.050980392156862744, 0.0078431373, 0.1019607843, 0.2666666667,\r\n      0.054901960784313725, 0.0078431373, 0.1098039216, 0.2823529412, 0.05882352941176471,\r\n      0.0078431373, 0.1176470588, 0.3058823529, 0.06274509803921569, 0.0078431373, 0.1176470588,\r\n      0.3215686275, 0.06666666666666667, 0.0078431373, 0.1254901961, 0.3450980392,\r\n      0.07058823529411765, 0.0078431373, 0.1333333333, 0.3607843137, 0.07450980392156863,\r\n      0.0078431373, 0.1411764706, 0.3843137255, 0.0784313725490196, 0.0078431373, 0.1490196078, 0.4,\r\n      0.08235294117647059, 0.0078431373, 0.1490196078, 0.4235294118, 0.08627450980392157,\r\n      0.0078431373, 0.1568627451, 0.4392156863, 0.09019607843137255, 0.0078431373, 0.1647058824,\r\n      0.462745098, 0.09411764705882353, 0.0078431373, 0.1725490196, 0.4784313725,\r\n      0.09803921568627451, 0.0078431373, 0.1803921569, 0.5019607843, 0.10196078431372549,\r\n      0.0078431373, 0.1803921569, 0.5254901961, 0.10588235294117647, 0.0078431373, 0.1882352941,\r\n      0.5411764706, 0.10980392156862745, 0.0078431373, 0.1960784314, 0.5647058824,\r\n      0.11372549019607843, 0.0078431373, 0.2039215686, 0.5803921569, 0.11764705882352942,\r\n      0.0078431373, 0.2117647059, 0.6039215686, 0.12156862745098039, 0.0078431373, 0.2117647059,\r\n      0.6196078431, 0.12549019607843137, 0.0078431373, 0.2196078431, 0.6431372549,\r\n      0.12941176470588237, 0.0078431373, 0.2274509804, 0.6588235294, 0.13333333333333333,\r\n      0.0078431373, 0.2352941176, 0.6823529412, 0.13725490196078433, 0.0078431373, 0.2431372549,\r\n      0.6980392157, 0.1411764705882353, 0.0078431373, 0.2431372549, 0.7215686275,\r\n      0.1450980392156863, 0.0078431373, 0.2509803922, 0.737254902, 0.14901960784313725,\r\n      0.0078431373, 0.2588235294, 0.7607843137, 0.15294117647058825, 0.0078431373, 0.2666666667,\r\n      0.7843137255, 0.1568627450980392, 0.0078431373, 0.2745098039, 0.8, 0.1607843137254902,\r\n      0.0078431373, 0.2745098039, 0.8235294118, 0.16470588235294117, 0.0078431373, 0.2823529412,\r\n      0.8392156863, 0.16862745098039217, 0.0078431373, 0.2901960784, 0.862745098,\r\n      0.17254901960784313, 0.0078431373, 0.2980392157, 0.8784313725, 0.17647058823529413,\r\n      0.0078431373, 0.3058823529, 0.9019607843, 0.1803921568627451, 0.0078431373, 0.3058823529,\r\n      0.9176470588, 0.1843137254901961, 0.0078431373, 0.2980392157, 0.9411764706,\r\n      0.18823529411764706, 0.0078431373, 0.3058823529, 0.9568627451, 0.19215686274509805,\r\n      0.0078431373, 0.2980392157, 0.9803921569, 0.19607843137254902, 0.0078431373, 0.2980392157,\r\n      0.9882352941, 0.2, 0.0078431373, 0.2901960784, 0.9803921569, 0.20392156862745098,\r\n      0.0078431373, 0.2901960784, 0.9647058824, 0.20784313725490197, 0.0078431373, 0.2823529412,\r\n      0.9568627451, 0.21176470588235294, 0.0078431373, 0.2823529412, 0.9411764706,\r\n      0.21568627450980393, 0.0078431373, 0.2745098039, 0.9333333333, 0.2196078431372549,\r\n      0.0078431373, 0.2666666667, 0.9176470588, 0.2235294117647059, 0.0078431373, 0.2666666667,\r\n      0.9098039216, 0.22745098039215686, 0.0078431373, 0.2588235294, 0.9019607843,\r\n      0.23137254901960785, 0.0078431373, 0.2588235294, 0.8862745098, 0.23529411764705885,\r\n      0.0078431373, 0.2509803922, 0.8784313725, 0.23921568627450984, 0.0078431373, 0.2509803922,\r\n      0.862745098, 0.24313725490196078, 0.0078431373, 0.2431372549, 0.8549019608,\r\n      0.24705882352941178, 0.0078431373, 0.2352941176, 0.8392156863, 0.25098039215686274,\r\n      0.0078431373, 0.2352941176, 0.831372549, 0.2549019607843137, 0.0078431373, 0.2274509804,\r\n      0.8235294118, 0.25882352941176473, 0.0078431373, 0.2274509804, 0.8078431373,\r\n      0.2627450980392157, 0.0078431373, 0.2196078431, 0.8, 0.26666666666666666, 0.0078431373,\r\n      0.2196078431, 0.7843137255, 0.27058823529411763, 0.0078431373, 0.2117647059, 0.7764705882,\r\n      0.27450980392156865, 0.0078431373, 0.2039215686, 0.7607843137, 0.2784313725490196,\r\n      0.0078431373, 0.2039215686, 0.7529411765, 0.2823529411764706, 0.0078431373, 0.1960784314,\r\n      0.7450980392, 0.28627450980392155, 0.0078431373, 0.1960784314, 0.7294117647,\r\n      0.2901960784313726, 0.0078431373, 0.1882352941, 0.7215686275, 0.29411764705882354,\r\n      0.0078431373, 0.1882352941, 0.7058823529, 0.2980392156862745, 0.0078431373, 0.1803921569,\r\n      0.6980392157, 0.30196078431372547, 0.0078431373, 0.1803921569, 0.6823529412,\r\n      0.3058823529411765, 0.0078431373, 0.1725490196, 0.6745098039, 0.30980392156862746,\r\n      0.0078431373, 0.1647058824, 0.6666666667, 0.3137254901960784, 0.0078431373, 0.1647058824,\r\n      0.6509803922, 0.3176470588235294, 0.0078431373, 0.1568627451, 0.6431372549,\r\n      0.3215686274509804, 0.0078431373, 0.1568627451, 0.6274509804, 0.3254901960784314,\r\n      0.0078431373, 0.1490196078, 0.6196078431, 0.32941176470588235, 0.0078431373, 0.1490196078,\r\n      0.6039215686, 0.3333333333333333, 0.0078431373, 0.1411764706, 0.5960784314,\r\n      0.33725490196078434, 0.0078431373, 0.1333333333, 0.5882352941, 0.3411764705882353,\r\n      0.0078431373, 0.1333333333, 0.5725490196, 0.34509803921568627, 0.0078431373, 0.1254901961,\r\n      0.5647058824, 0.34901960784313724, 0.0078431373, 0.1254901961, 0.5490196078,\r\n      0.35294117647058826, 0.0078431373, 0.1176470588, 0.5411764706, 0.3568627450980392,\r\n      0.0078431373, 0.1176470588, 0.5254901961, 0.3607843137254902, 0.0078431373, 0.1098039216,\r\n      0.5176470588, 0.36470588235294116, 0.0078431373, 0.1019607843, 0.5098039216,\r\n      0.3686274509803922, 0.0078431373, 0.1019607843, 0.4941176471, 0.37254901960784315,\r\n      0.0078431373, 0.0941176471, 0.4862745098, 0.3764705882352941, 0.0078431373, 0.0941176471,\r\n      0.4705882353, 0.3803921568627451, 0.0078431373, 0.0862745098, 0.462745098, 0.3843137254901961,\r\n      0.0078431373, 0.0862745098, 0.4470588235, 0.38823529411764707, 0.0078431373, 0.0784313725,\r\n      0.4392156863, 0.39215686274509803, 0.0078431373, 0.0705882353, 0.431372549, 0.396078431372549,\r\n      0.0078431373, 0.0705882353, 0.4156862745, 0.4, 0.0078431373, 0.062745098, 0.4078431373,\r\n      0.403921568627451, 0.0078431373, 0.062745098, 0.3921568627, 0.40784313725490196, 0.0078431373,\r\n      0.0549019608, 0.3843137255, 0.4117647058823529, 0.0078431373, 0.0549019608, 0.368627451,\r\n      0.41568627450980394, 0.0078431373, 0.0470588235, 0.3607843137, 0.4196078431372549,\r\n      0.0078431373, 0.0470588235, 0.3529411765, 0.4235294117647059, 0.0078431373, 0.0392156863,\r\n      0.337254902, 0.42745098039215684, 0.0078431373, 0.031372549, 0.3294117647,\r\n      0.43137254901960786, 0.0078431373, 0.031372549, 0.3137254902, 0.43529411764705883,\r\n      0.0078431373, 0.0235294118, 0.3058823529, 0.4392156862745098, 0.0078431373, 0.0235294118,\r\n      0.2901960784, 0.44313725490196076, 0.0078431373, 0.0156862745, 0.2823529412,\r\n      0.4470588235294118, 0.0078431373, 0.0156862745, 0.2745098039, 0.45098039215686275,\r\n      0.0078431373, 0.0078431373, 0.2588235294, 0.4549019607843137, 0.0235294118, 0.0078431373,\r\n      0.2509803922, 0.4588235294117647, 0.0078431373, 0.0078431373, 0.2352941176,\r\n      0.4627450980392157, 0.0078431373, 0.0078431373, 0.2274509804, 0.4666666666666667,\r\n      0.0078431373, 0.0078431373, 0.2117647059, 0.4705882352941177, 0.0078431373, 0.0078431373,\r\n      0.2039215686, 0.4745098039215686, 0.0078431373, 0.0078431373, 0.1960784314,\r\n      0.4784313725490197, 0.0078431373, 0.0078431373, 0.1803921569, 0.48235294117647065,\r\n      0.0078431373, 0.0078431373, 0.1725490196, 0.48627450980392156, 0.0078431373, 0.0078431373,\r\n      0.1568627451, 0.49019607843137253, 0.0078431373, 0.0078431373, 0.1490196078,\r\n      0.49411764705882355, 0.0078431373, 0.0078431373, 0.1333333333, 0.4980392156862745,\r\n      0.0078431373, 0.0078431373, 0.1254901961, 0.5019607843137255, 0.0078431373, 0.0078431373,\r\n      0.1176470588, 0.5058823529411764, 0.0078431373, 0.0078431373, 0.1019607843,\r\n      0.5098039215686274, 0.0078431373, 0.0078431373, 0.0941176471, 0.5137254901960784,\r\n      0.0078431373, 0.0078431373, 0.0784313725, 0.5176470588235295, 0.0078431373, 0.0078431373,\r\n      0.0705882353, 0.5215686274509804, 0.0078431373, 0.0078431373, 0.0549019608,\r\n      0.5254901960784314, 0.0078431373, 0.0078431373, 0.0470588235, 0.5294117647058824,\r\n      0.0235294118, 0.0078431373, 0.0392156863, 0.5333333333333333, 0.031372549, 0.0078431373,\r\n      0.0235294118, 0.5372549019607843, 0.0392156863, 0.0078431373, 0.0156862745,\r\n      0.5411764705882353, 0.0549019608, 0.0078431373, 0.0, 0.5450980392156862, 0.062745098,\r\n      0.0078431373, 0.0, 0.5490196078431373, 0.0705882353, 0.0078431373, 0.0, 0.5529411764705883,\r\n      0.0862745098, 0.0078431373, 0.0, 0.5568627450980392, 0.0941176471, 0.0078431373, 0.0,\r\n      0.5607843137254902, 0.1019607843, 0.0078431373, 0.0, 0.5647058823529412, 0.1098039216,\r\n      0.0078431373, 0.0, 0.5686274509803921, 0.1254901961, 0.0078431373, 0.0, 0.5725490196078431,\r\n      0.1333333333, 0.0078431373, 0.0, 0.5764705882352941, 0.1411764706, 0.0078431373, 0.0,\r\n      0.5803921568627451, 0.1568627451, 0.0078431373, 0.0, 0.5843137254901961, 0.1647058824,\r\n      0.0078431373, 0.0, 0.5882352941176471, 0.1725490196, 0.0078431373, 0.0, 0.592156862745098,\r\n      0.1882352941, 0.0078431373, 0.0, 0.596078431372549, 0.1960784314, 0.0078431373, 0.0, 0.6,\r\n      0.2039215686, 0.0078431373, 0.0, 0.6039215686274509, 0.2117647059, 0.0078431373, 0.0,\r\n      0.6078431372549019, 0.2274509804, 0.0078431373, 0.0, 0.611764705882353, 0.2352941176,\r\n      0.0078431373, 0.0, 0.615686274509804, 0.2431372549, 0.0078431373, 0.0, 0.6196078431372549,\r\n      0.2588235294, 0.0078431373, 0.0, 0.6235294117647059, 0.2666666667, 0.0078431373, 0.0,\r\n      0.6274509803921569, 0.2745098039, 0.0, 0.0, 0.6313725490196078, 0.2901960784, 0.0156862745,\r\n      0.0, 0.6352941176470588, 0.2980392157, 0.0235294118, 0.0, 0.6392156862745098, 0.3058823529,\r\n      0.0392156863, 0.0, 0.6431372549019608, 0.3137254902, 0.0470588235, 0.0, 0.6470588235294118,\r\n      0.3294117647, 0.0549019608, 0.0, 0.6509803921568628, 0.337254902, 0.0705882353, 0.0,\r\n      0.6549019607843137, 0.3450980392, 0.0784313725, 0.0, 0.6588235294117647, 0.3607843137,\r\n      0.0862745098, 0.0, 0.6627450980392157, 0.368627451, 0.1019607843, 0.0, 0.6666666666666666,\r\n      0.3764705882, 0.1098039216, 0.0, 0.6705882352941176, 0.3843137255, 0.1176470588, 0.0,\r\n      0.6745098039215687, 0.4, 0.1333333333, 0.0, 0.6784313725490196, 0.4078431373, 0.1411764706,\r\n      0.0, 0.6823529411764706, 0.4156862745, 0.1490196078, 0.0, 0.6862745098039216, 0.431372549,\r\n      0.1647058824, 0.0, 0.6901960784313725, 0.4392156863, 0.1725490196, 0.0, 0.6941176470588235,\r\n      0.4470588235, 0.1803921569, 0.0, 0.6980392156862745, 0.462745098, 0.1960784314, 0.0,\r\n      0.7019607843137254, 0.4705882353, 0.2039215686, 0.0, 0.7058823529411765, 0.4784313725,\r\n      0.2117647059, 0.0, 0.7098039215686275, 0.4862745098, 0.2274509804, 0.0, 0.7137254901960784,\r\n      0.5019607843, 0.2352941176, 0.0, 0.7176470588235294, 0.5098039216, 0.2431372549, 0.0,\r\n      0.7215686274509804, 0.5176470588, 0.2588235294, 0.0, 0.7254901960784313, 0.5333333333,\r\n      0.2666666667, 0.0, 0.7294117647058823, 0.5411764706, 0.2745098039, 0.0, 0.7333333333333333,\r\n      0.5490196078, 0.2901960784, 0.0, 0.7372549019607844, 0.5647058824, 0.2980392157, 0.0,\r\n      0.7411764705882353, 0.5725490196, 0.3058823529, 0.0, 0.7450980392156863, 0.5803921569,\r\n      0.3215686275, 0.0, 0.7490196078431373, 0.5882352941, 0.3294117647, 0.0, 0.7529411764705882,\r\n      0.6039215686, 0.337254902, 0.0, 0.7568627450980392, 0.6117647059, 0.3529411765, 0.0,\r\n      0.7607843137254902, 0.6196078431, 0.3607843137, 0.0, 0.7647058823529411, 0.6352941176,\r\n      0.368627451, 0.0, 0.7686274509803922, 0.6431372549, 0.3843137255, 0.0, 0.7725490196078432,\r\n      0.6509803922, 0.3921568627, 0.0, 0.7764705882352941, 0.6588235294, 0.4, 0.0,\r\n      0.7803921568627451, 0.6745098039, 0.4156862745, 0.0, 0.7843137254901961, 0.6823529412,\r\n      0.4235294118, 0.0, 0.788235294117647, 0.6901960784, 0.431372549, 0.0, 0.792156862745098,\r\n      0.7058823529, 0.4470588235, 0.0, 0.796078431372549, 0.7137254902, 0.4549019608, 0.0, 0.8,\r\n      0.7215686275, 0.462745098, 0.0, 0.803921568627451, 0.737254902, 0.4784313725, 0.0,\r\n      0.807843137254902, 0.7450980392, 0.4862745098, 0.0, 0.8117647058823529, 0.7529411765,\r\n      0.4941176471, 0.0, 0.8156862745098039, 0.7607843137, 0.5098039216, 0.0, 0.8196078431372549,\r\n      0.7764705882, 0.5176470588, 0.0, 0.8235294117647058, 0.7843137255, 0.5254901961, 0.0,\r\n      0.8274509803921568, 0.7921568627, 0.5411764706, 0.0, 0.8313725490196079, 0.8078431373,\r\n      0.5490196078, 0.0, 0.8352941176470589, 0.8156862745, 0.5568627451, 0.0, 0.8392156862745098,\r\n      0.8235294118, 0.5725490196, 0.0, 0.8431372549019608, 0.8392156863, 0.5803921569, 0.0,\r\n      0.8470588235294118, 0.8470588235, 0.5882352941, 0.0, 0.8509803921568627, 0.8549019608,\r\n      0.6039215686, 0.0, 0.8549019607843137, 0.862745098, 0.6117647059, 0.0, 0.8588235294117647,\r\n      0.8784313725, 0.6196078431, 0.0, 0.8627450980392157, 0.8862745098, 0.6352941176, 0.0,\r\n      0.8666666666666667, 0.8941176471, 0.6431372549, 0.0, 0.8705882352941177, 0.9098039216,\r\n      0.6509803922, 0.0, 0.8745098039215686, 0.9176470588, 0.6666666667, 0.0, 0.8784313725490196,\r\n      0.9254901961, 0.6745098039, 0.0, 0.8823529411764706, 0.9411764706, 0.6823529412, 0.0,\r\n      0.8862745098039215, 0.9490196078, 0.6980392157, 0.0, 0.8901960784313725, 0.9568627451,\r\n      0.7058823529, 0.0, 0.8941176470588236, 0.9647058824, 0.7137254902, 0.0, 0.8980392156862745,\r\n      0.9803921569, 0.7294117647, 0.0, 0.9019607843137255, 0.9882352941, 0.737254902, 0.0,\r\n      0.9058823529411765, 0.9960784314, 0.7450980392, 0.0, 0.9098039215686274, 0.9960784314,\r\n      0.7607843137, 0.0, 0.9137254901960784, 0.9960784314, 0.768627451, 0.0, 0.9176470588235294,\r\n      0.9960784314, 0.7764705882, 0.0, 0.9215686274509803, 0.9960784314, 0.7921568627, 0.0,\r\n      0.9254901960784314, 0.9960784314, 0.8, 0.0, 0.9294117647058824, 0.9960784314, 0.8078431373,\r\n      0.0, 0.9333333333333333, 0.9960784314, 0.8235294118, 0.0, 0.9372549019607843, 0.9960784314,\r\n      0.831372549, 0.0, 0.9411764705882354, 0.9960784314, 0.8392156863, 0.0, 0.9450980392156864,\r\n      0.9960784314, 0.8549019608, 0.0, 0.9490196078431372, 0.9960784314, 0.862745098, 0.0549019608,\r\n      0.9529411764705882, 0.9960784314, 0.8705882353, 0.1098039216, 0.9568627450980394,\r\n      0.9960784314, 0.8862745098, 0.1647058824, 0.9607843137254903, 0.9960784314, 0.8941176471,\r\n      0.2196078431, 0.9647058823529413, 0.9960784314, 0.9019607843, 0.2666666667,\r\n      0.9686274509803922, 0.9960784314, 0.9176470588, 0.3215686275, 0.9725490196078431,\r\n      0.9960784314, 0.9254901961, 0.3764705882, 0.9764705882352941, 0.9960784314, 0.9333333333,\r\n      0.431372549, 0.9803921568627451, 0.9960784314, 0.9490196078, 0.4862745098, 0.984313725490196,\r\n      0.9960784314, 0.9568627451, 0.5333333333, 0.9882352941176471, 0.9960784314, 0.9647058824,\r\n      0.5882352941, 0.9921568627450981, 0.9960784314, 0.9803921569, 0.6431372549, 0.996078431372549,\r\n      0.9960784314, 0.9882352941, 0.6980392157, 1.0, 0.9960784314, 0.9960784314, 0.7450980392,\r\n    ],\r\n    description: 'Perfusion',\r\n  },\r\n  {\r\n    ColorSpace: 'RGB',\r\n    Name: 'rainbow_2',\r\n    RGBPoints: [\r\n      0.0, 0.0, 0.0, 0.0, 0.00392156862745098, 0.0156862745, 0.0, 0.0117647059, 0.00784313725490196,\r\n      0.0352941176, 0.0, 0.0274509804, 0.011764705882352941, 0.0509803922, 0.0, 0.0392156863,\r\n      0.01568627450980392, 0.0705882353, 0.0, 0.0549019608, 0.0196078431372549, 0.0862745098, 0.0,\r\n      0.0745098039, 0.023529411764705882, 0.1058823529, 0.0, 0.0901960784, 0.027450980392156862,\r\n      0.1215686275, 0.0, 0.1098039216, 0.03137254901960784, 0.1411764706, 0.0, 0.1254901961,\r\n      0.03529411764705882, 0.1568627451, 0.0, 0.1490196078, 0.0392156862745098, 0.1764705882, 0.0,\r\n      0.168627451, 0.043137254901960784, 0.1960784314, 0.0, 0.1882352941, 0.047058823529411764,\r\n      0.2117647059, 0.0, 0.2078431373, 0.050980392156862744, 0.2274509804, 0.0, 0.231372549,\r\n      0.054901960784313725, 0.2392156863, 0.0, 0.2470588235, 0.05882352941176471, 0.2509803922, 0.0,\r\n      0.2666666667, 0.06274509803921569, 0.2666666667, 0.0, 0.2823529412, 0.06666666666666667,\r\n      0.2705882353, 0.0, 0.3019607843, 0.07058823529411765, 0.2823529412, 0.0, 0.3176470588,\r\n      0.07450980392156863, 0.2901960784, 0.0, 0.337254902, 0.0784313725490196, 0.3019607843, 0.0,\r\n      0.3568627451, 0.08235294117647059, 0.3098039216, 0.0, 0.3725490196, 0.08627450980392157,\r\n      0.3137254902, 0.0, 0.3921568627, 0.09019607843137255, 0.3215686275, 0.0, 0.4078431373,\r\n      0.09411764705882353, 0.3254901961, 0.0, 0.4274509804, 0.09803921568627451, 0.3333333333, 0.0,\r\n      0.4431372549, 0.10196078431372549, 0.3294117647, 0.0, 0.462745098, 0.10588235294117647,\r\n      0.337254902, 0.0, 0.4784313725, 0.10980392156862745, 0.3411764706, 0.0, 0.4980392157,\r\n      0.11372549019607843, 0.3450980392, 0.0, 0.5176470588, 0.11764705882352942, 0.337254902, 0.0,\r\n      0.5333333333, 0.12156862745098039, 0.3411764706, 0.0, 0.5529411765, 0.12549019607843137,\r\n      0.3411764706, 0.0, 0.568627451, 0.12941176470588237, 0.3411764706, 0.0, 0.5882352941,\r\n      0.13333333333333333, 0.3333333333, 0.0, 0.6039215686, 0.13725490196078433, 0.3294117647, 0.0,\r\n      0.6235294118, 0.1411764705882353, 0.3294117647, 0.0, 0.6392156863, 0.1450980392156863,\r\n      0.3294117647, 0.0, 0.6588235294, 0.14901960784313725, 0.3254901961, 0.0, 0.6784313725,\r\n      0.15294117647058825, 0.3098039216, 0.0, 0.6941176471, 0.1568627450980392, 0.3058823529, 0.0,\r\n      0.7137254902, 0.1607843137254902, 0.3019607843, 0.0, 0.7294117647, 0.16470588235294117,\r\n      0.2980392157, 0.0, 0.7490196078, 0.16862745098039217, 0.2784313725, 0.0, 0.7647058824,\r\n      0.17254901960784313, 0.2745098039, 0.0, 0.7843137255, 0.17647058823529413, 0.2666666667, 0.0,\r\n      0.8, 0.1803921568627451, 0.2588235294, 0.0, 0.8196078431, 0.1843137254901961, 0.2352941176,\r\n      0.0, 0.8392156863, 0.18823529411764706, 0.2274509804, 0.0, 0.8549019608, 0.19215686274509805,\r\n      0.2156862745, 0.0, 0.8745098039, 0.19607843137254902, 0.2078431373, 0.0, 0.8901960784, 0.2,\r\n      0.1803921569, 0.0, 0.9098039216, 0.20392156862745098, 0.168627451, 0.0, 0.9254901961,\r\n      0.20784313725490197, 0.1568627451, 0.0, 0.9450980392, 0.21176470588235294, 0.1411764706, 0.0,\r\n      0.9607843137, 0.21568627450980393, 0.1294117647, 0.0, 0.9803921569, 0.2196078431372549,\r\n      0.0980392157, 0.0, 1.0, 0.2235294117647059, 0.0823529412, 0.0, 1.0, 0.22745098039215686,\r\n      0.062745098, 0.0, 1.0, 0.23137254901960785, 0.0470588235, 0.0, 1.0, 0.23529411764705885,\r\n      0.0156862745, 0.0, 1.0, 0.23921568627450984, 0.0, 0.0, 1.0, 0.24313725490196078, 0.0,\r\n      0.0156862745, 1.0, 0.24705882352941178, 0.0, 0.031372549, 1.0, 0.25098039215686274, 0.0,\r\n      0.062745098, 1.0, 0.2549019607843137, 0.0, 0.0823529412, 1.0, 0.25882352941176473, 0.0,\r\n      0.0980392157, 1.0, 0.2627450980392157, 0.0, 0.1137254902, 1.0, 0.26666666666666666, 0.0,\r\n      0.1490196078, 1.0, 0.27058823529411763, 0.0, 0.1647058824, 1.0, 0.27450980392156865, 0.0,\r\n      0.1803921569, 1.0, 0.2784313725490196, 0.0, 0.2, 1.0, 0.2823529411764706, 0.0, 0.2156862745,\r\n      1.0, 0.28627450980392155, 0.0, 0.2470588235, 1.0, 0.2901960784313726, 0.0, 0.262745098, 1.0,\r\n      0.29411764705882354, 0.0, 0.2823529412, 1.0, 0.2980392156862745, 0.0, 0.2980392157, 1.0,\r\n      0.30196078431372547, 0.0, 0.3294117647, 1.0, 0.3058823529411765, 0.0, 0.3490196078, 1.0,\r\n      0.30980392156862746, 0.0, 0.3647058824, 1.0, 0.3137254901960784, 0.0, 0.3803921569, 1.0,\r\n      0.3176470588235294, 0.0, 0.4156862745, 1.0, 0.3215686274509804, 0.0, 0.431372549, 1.0,\r\n      0.3254901960784314, 0.0, 0.4470588235, 1.0, 0.32941176470588235, 0.0, 0.4666666667, 1.0,\r\n      0.3333333333333333, 0.0, 0.4980392157, 1.0, 0.33725490196078434, 0.0, 0.5137254902, 1.0,\r\n      0.3411764705882353, 0.0, 0.5294117647, 1.0, 0.34509803921568627, 0.0, 0.5490196078, 1.0,\r\n      0.34901960784313724, 0.0, 0.5647058824, 1.0, 0.35294117647058826, 0.0, 0.5960784314, 1.0,\r\n      0.3568627450980392, 0.0, 0.6156862745, 1.0, 0.3607843137254902, 0.0, 0.631372549, 1.0,\r\n      0.36470588235294116, 0.0, 0.6470588235, 1.0, 0.3686274509803922, 0.0, 0.6823529412, 1.0,\r\n      0.37254901960784315, 0.0, 0.6980392157, 1.0, 0.3764705882352941, 0.0, 0.7137254902, 1.0,\r\n      0.3803921568627451, 0.0, 0.7333333333, 1.0, 0.3843137254901961, 0.0, 0.7647058824, 1.0,\r\n      0.38823529411764707, 0.0, 0.7803921569, 1.0, 0.39215686274509803, 0.0, 0.7960784314, 1.0,\r\n      0.396078431372549, 0.0, 0.8156862745, 1.0, 0.4, 0.0, 0.8470588235, 1.0, 0.403921568627451,\r\n      0.0, 0.862745098, 1.0, 0.40784313725490196, 0.0, 0.8823529412, 1.0, 0.4117647058823529, 0.0,\r\n      0.8980392157, 1.0, 0.41568627450980394, 0.0, 0.9137254902, 1.0, 0.4196078431372549, 0.0,\r\n      0.9490196078, 1.0, 0.4235294117647059, 0.0, 0.9647058824, 1.0, 0.42745098039215684, 0.0,\r\n      0.9803921569, 1.0, 0.43137254901960786, 0.0, 1.0, 1.0, 0.43529411764705883, 0.0, 1.0,\r\n      0.9647058824, 0.4392156862745098, 0.0, 1.0, 0.9490196078, 0.44313725490196076, 0.0, 1.0,\r\n      0.9333333333, 0.4470588235294118, 0.0, 1.0, 0.9137254902, 0.45098039215686275, 0.0, 1.0,\r\n      0.8823529412, 0.4549019607843137, 0.0, 1.0, 0.862745098, 0.4588235294117647, 0.0, 1.0,\r\n      0.8470588235, 0.4627450980392157, 0.0, 1.0, 0.831372549, 0.4666666666666667, 0.0, 1.0,\r\n      0.7960784314, 0.4705882352941177, 0.0, 1.0, 0.7803921569, 0.4745098039215686, 0.0, 1.0,\r\n      0.7647058824, 0.4784313725490197, 0.0, 1.0, 0.7490196078, 0.48235294117647065, 0.0, 1.0,\r\n      0.7333333333, 0.48627450980392156, 0.0, 1.0, 0.6980392157, 0.49019607843137253, 0.0, 1.0,\r\n      0.6823529412, 0.49411764705882355, 0.0, 1.0, 0.6666666667, 0.4980392156862745, 0.0, 1.0,\r\n      0.6470588235, 0.5019607843137255, 0.0, 1.0, 0.6156862745, 0.5058823529411764, 0.0, 1.0,\r\n      0.5960784314, 0.5098039215686274, 0.0, 1.0, 0.5803921569, 0.5137254901960784, 0.0, 1.0,\r\n      0.5647058824, 0.5176470588235295, 0.0, 1.0, 0.5294117647, 0.5215686274509804, 0.0, 1.0,\r\n      0.5137254902, 0.5254901960784314, 0.0, 1.0, 0.4980392157, 0.5294117647058824, 0.0, 1.0,\r\n      0.4823529412, 0.5333333333333333, 0.0, 1.0, 0.4470588235, 0.5372549019607843, 0.0, 1.0,\r\n      0.431372549, 0.5411764705882353, 0.0, 1.0, 0.4156862745, 0.5450980392156862, 0.0, 1.0, 0.4,\r\n      0.5490196078431373, 0.0, 1.0, 0.3803921569, 0.5529411764705883, 0.0, 1.0, 0.3490196078,\r\n      0.5568627450980392, 0.0, 1.0, 0.3294117647, 0.5607843137254902, 0.0, 1.0, 0.3137254902,\r\n      0.5647058823529412, 0.0, 1.0, 0.2980392157, 0.5686274509803921, 0.0, 1.0, 0.262745098,\r\n      0.5725490196078431, 0.0, 1.0, 0.2470588235, 0.5764705882352941, 0.0, 1.0, 0.231372549,\r\n      0.5803921568627451, 0.0, 1.0, 0.2156862745, 0.5843137254901961, 0.0, 1.0, 0.1803921569,\r\n      0.5882352941176471, 0.0, 1.0, 0.1647058824, 0.592156862745098, 0.0, 1.0, 0.1490196078,\r\n      0.596078431372549, 0.0, 1.0, 0.1333333333, 0.6, 0.0, 1.0, 0.0980392157, 0.6039215686274509,\r\n      0.0, 1.0, 0.0823529412, 0.6078431372549019, 0.0, 1.0, 0.062745098, 0.611764705882353, 0.0,\r\n      1.0, 0.0470588235, 0.615686274509804, 0.0, 1.0, 0.031372549, 0.6196078431372549, 0.0, 1.0,\r\n      0.0, 0.6235294117647059, 0.0156862745, 1.0, 0.0, 0.6274509803921569, 0.031372549, 1.0, 0.0,\r\n      0.6313725490196078, 0.0470588235, 1.0, 0.0, 0.6352941176470588, 0.0823529412, 1.0, 0.0,\r\n      0.6392156862745098, 0.0980392157, 1.0, 0.0, 0.6431372549019608, 0.1137254902, 1.0, 0.0,\r\n      0.6470588235294118, 0.1294117647, 1.0, 0.0, 0.6509803921568628, 0.1647058824, 1.0, 0.0,\r\n      0.6549019607843137, 0.1803921569, 1.0, 0.0, 0.6588235294117647, 0.2, 1.0, 0.0,\r\n      0.6627450980392157, 0.2156862745, 1.0, 0.0, 0.6666666666666666, 0.2470588235, 1.0, 0.0,\r\n      0.6705882352941176, 0.262745098, 1.0, 0.0, 0.6745098039215687, 0.2823529412, 1.0, 0.0,\r\n      0.6784313725490196, 0.2980392157, 1.0, 0.0, 0.6823529411764706, 0.3137254902, 1.0, 0.0,\r\n      0.6862745098039216, 0.3490196078, 1.0, 0.0, 0.6901960784313725, 0.3647058824, 1.0, 0.0,\r\n      0.6941176470588235, 0.3803921569, 1.0, 0.0, 0.6980392156862745, 0.3960784314, 1.0, 0.0,\r\n      0.7019607843137254, 0.431372549, 1.0, 0.0, 0.7058823529411765, 0.4470588235, 1.0, 0.0,\r\n      0.7098039215686275, 0.4666666667, 1.0, 0.0, 0.7137254901960784, 0.4823529412, 1.0, 0.0,\r\n      0.7176470588235294, 0.5137254902, 1.0, 0.0, 0.7215686274509804, 0.5294117647, 1.0, 0.0,\r\n      0.7254901960784313, 0.5490196078, 1.0, 0.0, 0.7294117647058823, 0.5647058824, 1.0, 0.0,\r\n      0.7333333333333333, 0.6, 1.0, 0.0, 0.7372549019607844, 0.6156862745, 1.0, 0.0,\r\n      0.7411764705882353, 0.631372549, 1.0, 0.0, 0.7450980392156863, 0.6470588235, 1.0, 0.0,\r\n      0.7490196078431373, 0.662745098, 1.0, 0.0, 0.7529411764705882, 0.6980392157, 1.0, 0.0,\r\n      0.7568627450980392, 0.7137254902, 1.0, 0.0, 0.7607843137254902, 0.7333333333, 1.0, 0.0,\r\n      0.7647058823529411, 0.7490196078, 1.0, 0.0, 0.7686274509803922, 0.7803921569, 1.0, 0.0,\r\n      0.7725490196078432, 0.7960784314, 1.0, 0.0, 0.7764705882352941, 0.8156862745, 1.0, 0.0,\r\n      0.7803921568627451, 0.831372549, 1.0, 0.0, 0.7843137254901961, 0.8666666667, 1.0, 0.0,\r\n      0.788235294117647, 0.8823529412, 1.0, 0.0, 0.792156862745098, 0.8980392157, 1.0, 0.0,\r\n      0.796078431372549, 0.9137254902, 1.0, 0.0, 0.8, 0.9490196078, 1.0, 0.0, 0.803921568627451,\r\n      0.9647058824, 1.0, 0.0, 0.807843137254902, 0.9803921569, 1.0, 0.0, 0.8117647058823529, 1.0,\r\n      1.0, 0.0, 0.8156862745098039, 1.0, 0.9803921569, 0.0, 0.8196078431372549, 1.0, 0.9490196078,\r\n      0.0, 0.8235294117647058, 1.0, 0.9333333333, 0.0, 0.8274509803921568, 1.0, 0.9137254902, 0.0,\r\n      0.8313725490196079, 1.0, 0.8980392157, 0.0, 0.8352941176470589, 1.0, 0.8666666667, 0.0,\r\n      0.8392156862745098, 1.0, 0.8470588235, 0.0, 0.8431372549019608, 1.0, 0.831372549, 0.0,\r\n      0.8470588235294118, 1.0, 0.8156862745, 0.0, 0.8509803921568627, 1.0, 0.7803921569, 0.0,\r\n      0.8549019607843137, 1.0, 0.7647058824, 0.0, 0.8588235294117647, 1.0, 0.7490196078, 0.0,\r\n      0.8627450980392157, 1.0, 0.7333333333, 0.0, 0.8666666666666667, 1.0, 0.6980392157, 0.0,\r\n      0.8705882352941177, 1.0, 0.6823529412, 0.0, 0.8745098039215686, 1.0, 0.6666666667, 0.0,\r\n      0.8784313725490196, 1.0, 0.6470588235, 0.0, 0.8823529411764706, 1.0, 0.631372549, 0.0,\r\n      0.8862745098039215, 1.0, 0.6, 0.0, 0.8901960784313725, 1.0, 0.5803921569, 0.0,\r\n      0.8941176470588236, 1.0, 0.5647058824, 0.0, 0.8980392156862745, 1.0, 0.5490196078, 0.0,\r\n      0.9019607843137255, 1.0, 0.5137254902, 0.0, 0.9058823529411765, 1.0, 0.4980392157, 0.0,\r\n      0.9098039215686274, 1.0, 0.4823529412, 0.0, 0.9137254901960784, 1.0, 0.4666666667, 0.0,\r\n      0.9176470588235294, 1.0, 0.431372549, 0.0, 0.9215686274509803, 1.0, 0.4156862745, 0.0,\r\n      0.9254901960784314, 1.0, 0.4, 0.0, 0.9294117647058824, 1.0, 0.3803921569, 0.0,\r\n      0.9333333333333333, 1.0, 0.3490196078, 0.0, 0.9372549019607843, 1.0, 0.3333333333, 0.0,\r\n      0.9411764705882354, 1.0, 0.3137254902, 0.0, 0.9450980392156864, 1.0, 0.2980392157, 0.0,\r\n      0.9490196078431372, 1.0, 0.2823529412, 0.0, 0.9529411764705882, 1.0, 0.2470588235, 0.0,\r\n      0.9568627450980394, 1.0, 0.231372549, 0.0, 0.9607843137254903, 1.0, 0.2156862745, 0.0,\r\n      0.9647058823529413, 1.0, 0.2, 0.0, 0.9686274509803922, 1.0, 0.1647058824, 0.0,\r\n      0.9725490196078431, 1.0, 0.1490196078, 0.0, 0.9764705882352941, 1.0, 0.1333333333, 0.0,\r\n      0.9803921568627451, 1.0, 0.1137254902, 0.0, 0.984313725490196, 1.0, 0.0823529412, 0.0,\r\n      0.9882352941176471, 1.0, 0.0666666667, 0.0, 0.9921568627450981, 1.0, 0.0470588235, 0.0,\r\n      0.996078431372549, 1.0, 0.031372549, 0.0, 1.0, 1.0, 0.0, 0.0,\r\n    ],\r\n    description: 'Rainbow',\r\n  },\r\n  {\r\n    ColorSpace: 'RGB',\r\n    Name: 'suv',\r\n    RGBPoints: [\r\n      0.0, 1.0, 1.0, 1.0, 0.00392156862745098, 1.0, 1.0, 1.0, 0.00784313725490196, 1.0, 1.0, 1.0,\r\n      0.011764705882352941, 1.0, 1.0, 1.0, 0.01568627450980392, 1.0, 1.0, 1.0, 0.0196078431372549,\r\n      1.0, 1.0, 1.0, 0.023529411764705882, 1.0, 1.0, 1.0, 0.027450980392156862, 1.0, 1.0, 1.0,\r\n      0.03137254901960784, 1.0, 1.0, 1.0, 0.03529411764705882, 1.0, 1.0, 1.0, 0.0392156862745098,\r\n      1.0, 1.0, 1.0, 0.043137254901960784, 1.0, 1.0, 1.0, 0.047058823529411764, 1.0, 1.0, 1.0,\r\n      0.050980392156862744, 1.0, 1.0, 1.0, 0.054901960784313725, 1.0, 1.0, 1.0, 0.05882352941176471,\r\n      1.0, 1.0, 1.0, 0.06274509803921569, 1.0, 1.0, 1.0, 0.06666666666666667, 1.0, 1.0, 1.0,\r\n      0.07058823529411765, 1.0, 1.0, 1.0, 0.07450980392156863, 1.0, 1.0, 1.0, 0.0784313725490196,\r\n      1.0, 1.0, 1.0, 0.08235294117647059, 1.0, 1.0, 1.0, 0.08627450980392157, 1.0, 1.0, 1.0,\r\n      0.09019607843137255, 1.0, 1.0, 1.0, 0.09411764705882353, 1.0, 1.0, 1.0, 0.09803921568627451,\r\n      1.0, 1.0, 1.0, 0.10196078431372549, 0.737254902, 0.737254902, 0.737254902,\r\n      0.10588235294117647, 0.737254902, 0.737254902, 0.737254902, 0.10980392156862745, 0.737254902,\r\n      0.737254902, 0.737254902, 0.11372549019607843, 0.737254902, 0.737254902, 0.737254902,\r\n      0.11764705882352942, 0.737254902, 0.737254902, 0.737254902, 0.12156862745098039, 0.737254902,\r\n      0.737254902, 0.737254902, 0.12549019607843137, 0.737254902, 0.737254902, 0.737254902,\r\n      0.12941176470588237, 0.737254902, 0.737254902, 0.737254902, 0.13333333333333333, 0.737254902,\r\n      0.737254902, 0.737254902, 0.13725490196078433, 0.737254902, 0.737254902, 0.737254902,\r\n      0.1411764705882353, 0.737254902, 0.737254902, 0.737254902, 0.1450980392156863, 0.737254902,\r\n      0.737254902, 0.737254902, 0.14901960784313725, 0.737254902, 0.737254902, 0.737254902,\r\n      0.15294117647058825, 0.737254902, 0.737254902, 0.737254902, 0.1568627450980392, 0.737254902,\r\n      0.737254902, 0.737254902, 0.1607843137254902, 0.737254902, 0.737254902, 0.737254902,\r\n      0.16470588235294117, 0.737254902, 0.737254902, 0.737254902, 0.16862745098039217, 0.737254902,\r\n      0.737254902, 0.737254902, 0.17254901960784313, 0.737254902, 0.737254902, 0.737254902,\r\n      0.17647058823529413, 0.737254902, 0.737254902, 0.737254902, 0.1803921568627451, 0.737254902,\r\n      0.737254902, 0.737254902, 0.1843137254901961, 0.737254902, 0.737254902, 0.737254902,\r\n      0.18823529411764706, 0.737254902, 0.737254902, 0.737254902, 0.19215686274509805, 0.737254902,\r\n      0.737254902, 0.737254902, 0.19607843137254902, 0.737254902, 0.737254902, 0.737254902, 0.2,\r\n      0.737254902, 0.737254902, 0.737254902, 0.20392156862745098, 0.431372549, 0.0, 0.568627451,\r\n      0.20784313725490197, 0.431372549, 0.0, 0.568627451, 0.21176470588235294, 0.431372549, 0.0,\r\n      0.568627451, 0.21568627450980393, 0.431372549, 0.0, 0.568627451, 0.2196078431372549,\r\n      0.431372549, 0.0, 0.568627451, 0.2235294117647059, 0.431372549, 0.0, 0.568627451,\r\n      0.22745098039215686, 0.431372549, 0.0, 0.568627451, 0.23137254901960785, 0.431372549, 0.0,\r\n      0.568627451, 0.23529411764705885, 0.431372549, 0.0, 0.568627451, 0.23921568627450984,\r\n      0.431372549, 0.0, 0.568627451, 0.24313725490196078, 0.431372549, 0.0, 0.568627451,\r\n      0.24705882352941178, 0.431372549, 0.0, 0.568627451, 0.25098039215686274, 0.431372549, 0.0,\r\n      0.568627451, 0.2549019607843137, 0.431372549, 0.0, 0.568627451, 0.25882352941176473,\r\n      0.431372549, 0.0, 0.568627451, 0.2627450980392157, 0.431372549, 0.0, 0.568627451,\r\n      0.26666666666666666, 0.431372549, 0.0, 0.568627451, 0.27058823529411763, 0.431372549, 0.0,\r\n      0.568627451, 0.27450980392156865, 0.431372549, 0.0, 0.568627451, 0.2784313725490196,\r\n      0.431372549, 0.0, 0.568627451, 0.2823529411764706, 0.431372549, 0.0, 0.568627451,\r\n      0.28627450980392155, 0.431372549, 0.0, 0.568627451, 0.2901960784313726, 0.431372549, 0.0,\r\n      0.568627451, 0.29411764705882354, 0.431372549, 0.0, 0.568627451, 0.2980392156862745,\r\n      0.431372549, 0.0, 0.568627451, 0.30196078431372547, 0.431372549, 0.0, 0.568627451,\r\n      0.3058823529411765, 0.2509803922, 0.3333333333, 0.6509803922, 0.30980392156862746,\r\n      0.2509803922, 0.3333333333, 0.6509803922, 0.3137254901960784, 0.2509803922, 0.3333333333,\r\n      0.6509803922, 0.3176470588235294, 0.2509803922, 0.3333333333, 0.6509803922,\r\n      0.3215686274509804, 0.2509803922, 0.3333333333, 0.6509803922, 0.3254901960784314,\r\n      0.2509803922, 0.3333333333, 0.6509803922, 0.32941176470588235, 0.2509803922, 0.3333333333,\r\n      0.6509803922, 0.3333333333333333, 0.2509803922, 0.3333333333, 0.6509803922,\r\n      0.33725490196078434, 0.2509803922, 0.3333333333, 0.6509803922, 0.3411764705882353,\r\n      0.2509803922, 0.3333333333, 0.6509803922, 0.34509803921568627, 0.2509803922, 0.3333333333,\r\n      0.6509803922, 0.34901960784313724, 0.2509803922, 0.3333333333, 0.6509803922,\r\n      0.35294117647058826, 0.2509803922, 0.3333333333, 0.6509803922, 0.3568627450980392,\r\n      0.2509803922, 0.3333333333, 0.6509803922, 0.3607843137254902, 0.2509803922, 0.3333333333,\r\n      0.6509803922, 0.36470588235294116, 0.2509803922, 0.3333333333, 0.6509803922,\r\n      0.3686274509803922, 0.2509803922, 0.3333333333, 0.6509803922, 0.37254901960784315,\r\n      0.2509803922, 0.3333333333, 0.6509803922, 0.3764705882352941, 0.2509803922, 0.3333333333,\r\n      0.6509803922, 0.3803921568627451, 0.2509803922, 0.3333333333, 0.6509803922,\r\n      0.3843137254901961, 0.2509803922, 0.3333333333, 0.6509803922, 0.38823529411764707,\r\n      0.2509803922, 0.3333333333, 0.6509803922, 0.39215686274509803, 0.2509803922, 0.3333333333,\r\n      0.6509803922, 0.396078431372549, 0.2509803922, 0.3333333333, 0.6509803922, 0.4, 0.2509803922,\r\n      0.3333333333, 0.6509803922, 0.403921568627451, 0.2509803922, 0.3333333333, 0.6509803922,\r\n      0.40784313725490196, 0.0, 0.8, 1.0, 0.4117647058823529, 0.0, 0.8, 1.0, 0.41568627450980394,\r\n      0.0, 0.8, 1.0, 0.4196078431372549, 0.0, 0.8, 1.0, 0.4235294117647059, 0.0, 0.8, 1.0,\r\n      0.42745098039215684, 0.0, 0.8, 1.0, 0.43137254901960786, 0.0, 0.8, 1.0, 0.43529411764705883,\r\n      0.0, 0.8, 1.0, 0.4392156862745098, 0.0, 0.8, 1.0, 0.44313725490196076, 0.0, 0.8, 1.0,\r\n      0.4470588235294118, 0.0, 0.8, 1.0, 0.45098039215686275, 0.0, 0.8, 1.0, 0.4549019607843137,\r\n      0.0, 0.8, 1.0, 0.4588235294117647, 0.0, 0.8, 1.0, 0.4627450980392157, 0.0, 0.8, 1.0,\r\n      0.4666666666666667, 0.0, 0.8, 1.0, 0.4705882352941177, 0.0, 0.8, 1.0, 0.4745098039215686, 0.0,\r\n      0.8, 1.0, 0.4784313725490197, 0.0, 0.8, 1.0, 0.48235294117647065, 0.0, 0.8, 1.0,\r\n      0.48627450980392156, 0.0, 0.8, 1.0, 0.49019607843137253, 0.0, 0.8, 1.0, 0.49411764705882355,\r\n      0.0, 0.8, 1.0, 0.4980392156862745, 0.0, 0.8, 1.0, 0.5019607843137255, 0.0, 0.8, 1.0,\r\n      0.5058823529411764, 0.0, 0.6666666667, 0.5333333333, 0.5098039215686274, 0.0, 0.6666666667,\r\n      0.5333333333, 0.5137254901960784, 0.0, 0.6666666667, 0.5333333333, 0.5176470588235295, 0.0,\r\n      0.6666666667, 0.5333333333, 0.5215686274509804, 0.0, 0.6666666667, 0.5333333333,\r\n      0.5254901960784314, 0.0, 0.6666666667, 0.5333333333, 0.5294117647058824, 0.0, 0.6666666667,\r\n      0.5333333333, 0.5333333333333333, 0.0, 0.6666666667, 0.5333333333, 0.5372549019607843, 0.0,\r\n      0.6666666667, 0.5333333333, 0.5411764705882353, 0.0, 0.6666666667, 0.5333333333,\r\n      0.5450980392156862, 0.0, 0.6666666667, 0.5333333333, 0.5490196078431373, 0.0, 0.6666666667,\r\n      0.5333333333, 0.5529411764705883, 0.0, 0.6666666667, 0.5333333333, 0.5568627450980392, 0.0,\r\n      0.6666666667, 0.5333333333, 0.5607843137254902, 0.0, 0.6666666667, 0.5333333333,\r\n      0.5647058823529412, 0.0, 0.6666666667, 0.5333333333, 0.5686274509803921, 0.0, 0.6666666667,\r\n      0.5333333333, 0.5725490196078431, 0.0, 0.6666666667, 0.5333333333, 0.5764705882352941, 0.0,\r\n      0.6666666667, 0.5333333333, 0.5803921568627451, 0.0, 0.6666666667, 0.5333333333,\r\n      0.5843137254901961, 0.0, 0.6666666667, 0.5333333333, 0.5882352941176471, 0.0, 0.6666666667,\r\n      0.5333333333, 0.592156862745098, 0.0, 0.6666666667, 0.5333333333, 0.596078431372549, 0.0,\r\n      0.6666666667, 0.5333333333, 0.6, 0.0, 0.6666666667, 0.5333333333, 0.6039215686274509, 0.0,\r\n      0.6666666667, 0.5333333333, 0.6078431372549019, 0.4, 1.0, 0.4, 0.611764705882353, 0.4, 1.0,\r\n      0.4, 0.615686274509804, 0.4, 1.0, 0.4, 0.6196078431372549, 0.4, 1.0, 0.4, 0.6235294117647059,\r\n      0.4, 1.0, 0.4, 0.6274509803921569, 0.4, 1.0, 0.4, 0.6313725490196078, 0.4, 1.0, 0.4,\r\n      0.6352941176470588, 0.4, 1.0, 0.4, 0.6392156862745098, 0.4, 1.0, 0.4, 0.6431372549019608, 0.4,\r\n      1.0, 0.4, 0.6470588235294118, 0.4, 1.0, 0.4, 0.6509803921568628, 0.4, 1.0, 0.4,\r\n      0.6549019607843137, 0.4, 1.0, 0.4, 0.6588235294117647, 0.4, 1.0, 0.4, 0.6627450980392157, 0.4,\r\n      1.0, 0.4, 0.6666666666666666, 0.4, 1.0, 0.4, 0.6705882352941176, 0.4, 1.0, 0.4,\r\n      0.6745098039215687, 0.4, 1.0, 0.4, 0.6784313725490196, 0.4, 1.0, 0.4, 0.6823529411764706, 0.4,\r\n      1.0, 0.4, 0.6862745098039216, 0.4, 1.0, 0.4, 0.6901960784313725, 0.4, 1.0, 0.4,\r\n      0.6941176470588235, 0.4, 1.0, 0.4, 0.6980392156862745, 0.4, 1.0, 0.4, 0.7019607843137254, 0.4,\r\n      1.0, 0.4, 0.7058823529411765, 1.0, 0.9490196078, 0.0, 0.7098039215686275, 1.0, 0.9490196078,\r\n      0.0, 0.7137254901960784, 1.0, 0.9490196078, 0.0, 0.7176470588235294, 1.0, 0.9490196078, 0.0,\r\n      0.7215686274509804, 1.0, 0.9490196078, 0.0, 0.7254901960784313, 1.0, 0.9490196078, 0.0,\r\n      0.7294117647058823, 1.0, 0.9490196078, 0.0, 0.7333333333333333, 1.0, 0.9490196078, 0.0,\r\n      0.7372549019607844, 1.0, 0.9490196078, 0.0, 0.7411764705882353, 1.0, 0.9490196078, 0.0,\r\n      0.7450980392156863, 1.0, 0.9490196078, 0.0, 0.7490196078431373, 1.0, 0.9490196078, 0.0,\r\n      0.7529411764705882, 1.0, 0.9490196078, 0.0, 0.7568627450980392, 1.0, 0.9490196078, 0.0,\r\n      0.7607843137254902, 1.0, 0.9490196078, 0.0, 0.7647058823529411, 1.0, 0.9490196078, 0.0,\r\n      0.7686274509803922, 1.0, 0.9490196078, 0.0, 0.7725490196078432, 1.0, 0.9490196078, 0.0,\r\n      0.7764705882352941, 1.0, 0.9490196078, 0.0, 0.7803921568627451, 1.0, 0.9490196078, 0.0,\r\n      0.7843137254901961, 1.0, 0.9490196078, 0.0, 0.788235294117647, 1.0, 0.9490196078, 0.0,\r\n      0.792156862745098, 1.0, 0.9490196078, 0.0, 0.796078431372549, 1.0, 0.9490196078, 0.0, 0.8,\r\n      1.0, 0.9490196078, 0.0, 0.803921568627451, 1.0, 0.9490196078, 0.0, 0.807843137254902,\r\n      0.9490196078, 0.6509803922, 0.2509803922, 0.8117647058823529, 0.9490196078, 0.6509803922,\r\n      0.2509803922, 0.8156862745098039, 0.9490196078, 0.6509803922, 0.2509803922,\r\n      0.8196078431372549, 0.9490196078, 0.6509803922, 0.2509803922, 0.8235294117647058,\r\n      0.9490196078, 0.6509803922, 0.2509803922, 0.8274509803921568, 0.9490196078, 0.6509803922,\r\n      0.2509803922, 0.8313725490196079, 0.9490196078, 0.6509803922, 0.2509803922,\r\n      0.8352941176470589, 0.9490196078, 0.6509803922, 0.2509803922, 0.8392156862745098,\r\n      0.9490196078, 0.6509803922, 0.2509803922, 0.8431372549019608, 0.9490196078, 0.6509803922,\r\n      0.2509803922, 0.8470588235294118, 0.9490196078, 0.6509803922, 0.2509803922,\r\n      0.8509803921568627, 0.9490196078, 0.6509803922, 0.2509803922, 0.8549019607843137,\r\n      0.9490196078, 0.6509803922, 0.2509803922, 0.8588235294117647, 0.9490196078, 0.6509803922,\r\n      0.2509803922, 0.8627450980392157, 0.9490196078, 0.6509803922, 0.2509803922,\r\n      0.8666666666666667, 0.9490196078, 0.6509803922, 0.2509803922, 0.8705882352941177,\r\n      0.9490196078, 0.6509803922, 0.2509803922, 0.8745098039215686, 0.9490196078, 0.6509803922,\r\n      0.2509803922, 0.8784313725490196, 0.9490196078, 0.6509803922, 0.2509803922,\r\n      0.8823529411764706, 0.9490196078, 0.6509803922, 0.2509803922, 0.8862745098039215,\r\n      0.9490196078, 0.6509803922, 0.2509803922, 0.8901960784313725, 0.9490196078, 0.6509803922,\r\n      0.2509803922, 0.8941176470588236, 0.9490196078, 0.6509803922, 0.2509803922,\r\n      0.8980392156862745, 0.9490196078, 0.6509803922, 0.2509803922, 0.9019607843137255,\r\n      0.9490196078, 0.6509803922, 0.2509803922, 0.9058823529411765, 0.9490196078, 0.6509803922,\r\n      0.2509803922, 0.9098039215686274, 1.0, 0.0, 0.0, 0.9137254901960784, 1.0, 0.0, 0.0,\r\n      0.9176470588235294, 1.0, 0.0, 0.0, 0.9215686274509803, 1.0, 0.0, 0.0, 0.9254901960784314, 1.0,\r\n      0.0, 0.0, 0.9294117647058824, 1.0, 0.0, 0.0, 0.9333333333333333, 1.0, 0.0, 0.0,\r\n      0.9372549019607843, 1.0, 0.0, 0.0, 0.9411764705882354, 1.0, 0.0, 0.0, 0.9450980392156864, 1.0,\r\n      0.0, 0.0, 0.9490196078431372, 1.0, 0.0, 0.0, 0.9529411764705882, 1.0, 0.0, 0.0,\r\n      0.9568627450980394, 1.0, 0.0, 0.0, 0.9607843137254903, 1.0, 0.0, 0.0, 0.9647058823529413, 1.0,\r\n      0.0, 0.0, 0.9686274509803922, 1.0, 0.0, 0.0, 0.9725490196078431, 1.0, 0.0, 0.0,\r\n      0.9764705882352941, 1.0, 0.0, 0.0, 0.9803921568627451, 1.0, 0.0, 0.0, 0.984313725490196, 1.0,\r\n      0.0, 0.0, 0.9882352941176471, 1.0, 0.0, 0.0, 0.9921568627450981, 1.0, 0.0, 0.0,\r\n      0.996078431372549, 1.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0,\r\n    ],\r\n    description: 'SUV',\r\n  },\r\n  {\r\n    ColorSpace: 'RGB',\r\n    Name: 'ge_256',\r\n    RGBPoints: [\r\n      0.0, 0.0039215686, 0.0078431373, 0.0078431373, 0.00392156862745098, 0.0039215686,\r\n      0.0078431373, 0.0078431373, 0.00784313725490196, 0.0039215686, 0.0078431373, 0.0117647059,\r\n      0.011764705882352941, 0.0039215686, 0.0117647059, 0.0156862745, 0.01568627450980392,\r\n      0.0039215686, 0.0117647059, 0.0196078431, 0.0196078431372549, 0.0039215686, 0.0156862745,\r\n      0.0235294118, 0.023529411764705882, 0.0039215686, 0.0156862745, 0.0274509804,\r\n      0.027450980392156862, 0.0039215686, 0.0196078431, 0.031372549, 0.03137254901960784,\r\n      0.0039215686, 0.0196078431, 0.0352941176, 0.03529411764705882, 0.0039215686, 0.0235294118,\r\n      0.0392156863, 0.0392156862745098, 0.0039215686, 0.0235294118, 0.0431372549,\r\n      0.043137254901960784, 0.0039215686, 0.0274509804, 0.0470588235, 0.047058823529411764,\r\n      0.0039215686, 0.0274509804, 0.0509803922, 0.050980392156862744, 0.0039215686, 0.031372549,\r\n      0.0549019608, 0.054901960784313725, 0.0039215686, 0.031372549, 0.0588235294,\r\n      0.05882352941176471, 0.0039215686, 0.0352941176, 0.062745098, 0.06274509803921569,\r\n      0.0039215686, 0.0352941176, 0.0666666667, 0.06666666666666667, 0.0039215686, 0.0392156863,\r\n      0.0705882353, 0.07058823529411765, 0.0039215686, 0.0392156863, 0.0745098039,\r\n      0.07450980392156863, 0.0039215686, 0.0431372549, 0.0784313725, 0.0784313725490196,\r\n      0.0039215686, 0.0431372549, 0.0823529412, 0.08235294117647059, 0.0039215686, 0.0470588235,\r\n      0.0862745098, 0.08627450980392157, 0.0039215686, 0.0470588235, 0.0901960784,\r\n      0.09019607843137255, 0.0039215686, 0.0509803922, 0.0941176471, 0.09411764705882353,\r\n      0.0039215686, 0.0509803922, 0.0980392157, 0.09803921568627451, 0.0039215686, 0.0549019608,\r\n      0.1019607843, 0.10196078431372549, 0.0039215686, 0.0549019608, 0.1058823529,\r\n      0.10588235294117647, 0.0039215686, 0.0588235294, 0.1098039216, 0.10980392156862745,\r\n      0.0039215686, 0.0588235294, 0.1137254902, 0.11372549019607843, 0.0039215686, 0.062745098,\r\n      0.1176470588, 0.11764705882352942, 0.0039215686, 0.062745098, 0.1215686275,\r\n      0.12156862745098039, 0.0039215686, 0.0666666667, 0.1254901961, 0.12549019607843137,\r\n      0.0039215686, 0.0666666667, 0.1294117647, 0.12941176470588237, 0.0039215686, 0.0705882353,\r\n      0.1333333333, 0.13333333333333333, 0.0039215686, 0.0705882353, 0.137254902,\r\n      0.13725490196078433, 0.0039215686, 0.0745098039, 0.1411764706, 0.1411764705882353,\r\n      0.0039215686, 0.0745098039, 0.1450980392, 0.1450980392156863, 0.0039215686, 0.0784313725,\r\n      0.1490196078, 0.14901960784313725, 0.0039215686, 0.0784313725, 0.1529411765,\r\n      0.15294117647058825, 0.0039215686, 0.0823529412, 0.1568627451, 0.1568627450980392,\r\n      0.0039215686, 0.0823529412, 0.1607843137, 0.1607843137254902, 0.0039215686, 0.0862745098,\r\n      0.1647058824, 0.16470588235294117, 0.0039215686, 0.0862745098, 0.168627451,\r\n      0.16862745098039217, 0.0039215686, 0.0901960784, 0.1725490196, 0.17254901960784313,\r\n      0.0039215686, 0.0901960784, 0.1764705882, 0.17647058823529413, 0.0039215686, 0.0941176471,\r\n      0.1803921569, 0.1803921568627451, 0.0039215686, 0.0941176471, 0.1843137255,\r\n      0.1843137254901961, 0.0039215686, 0.0980392157, 0.1882352941, 0.18823529411764706,\r\n      0.0039215686, 0.0980392157, 0.1921568627, 0.19215686274509805, 0.0039215686, 0.1019607843,\r\n      0.1960784314, 0.19607843137254902, 0.0039215686, 0.1019607843, 0.2, 0.2, 0.0039215686,\r\n      0.1058823529, 0.2039215686, 0.20392156862745098, 0.0039215686, 0.1058823529, 0.2078431373,\r\n      0.20784313725490197, 0.0039215686, 0.1098039216, 0.2117647059, 0.21176470588235294,\r\n      0.0039215686, 0.1098039216, 0.2156862745, 0.21568627450980393, 0.0039215686, 0.1137254902,\r\n      0.2196078431, 0.2196078431372549, 0.0039215686, 0.1137254902, 0.2235294118,\r\n      0.2235294117647059, 0.0039215686, 0.1176470588, 0.2274509804, 0.22745098039215686,\r\n      0.0039215686, 0.1176470588, 0.231372549, 0.23137254901960785, 0.0039215686, 0.1215686275,\r\n      0.2352941176, 0.23529411764705885, 0.0039215686, 0.1215686275, 0.2392156863,\r\n      0.23921568627450984, 0.0039215686, 0.1254901961, 0.2431372549, 0.24313725490196078,\r\n      0.0039215686, 0.1254901961, 0.2470588235, 0.24705882352941178, 0.0039215686, 0.1294117647,\r\n      0.2509803922, 0.25098039215686274, 0.0039215686, 0.1294117647, 0.2509803922,\r\n      0.2549019607843137, 0.0078431373, 0.1254901961, 0.2549019608, 0.25882352941176473,\r\n      0.0156862745, 0.1254901961, 0.2588235294, 0.2627450980392157, 0.0235294118, 0.1215686275,\r\n      0.262745098, 0.26666666666666666, 0.031372549, 0.1215686275, 0.2666666667,\r\n      0.27058823529411763, 0.0392156863, 0.1176470588, 0.2705882353, 0.27450980392156865,\r\n      0.0470588235, 0.1176470588, 0.2745098039, 0.2784313725490196, 0.0549019608, 0.1137254902,\r\n      0.2784313725, 0.2823529411764706, 0.062745098, 0.1137254902, 0.2823529412,\r\n      0.28627450980392155, 0.0705882353, 0.1098039216, 0.2862745098, 0.2901960784313726,\r\n      0.0784313725, 0.1098039216, 0.2901960784, 0.29411764705882354, 0.0862745098, 0.1058823529,\r\n      0.2941176471, 0.2980392156862745, 0.0941176471, 0.1058823529, 0.2980392157,\r\n      0.30196078431372547, 0.1019607843, 0.1019607843, 0.3019607843, 0.3058823529411765,\r\n      0.1098039216, 0.1019607843, 0.3058823529, 0.30980392156862746, 0.1176470588, 0.0980392157,\r\n      0.3098039216, 0.3137254901960784, 0.1254901961, 0.0980392157, 0.3137254902,\r\n      0.3176470588235294, 0.1333333333, 0.0941176471, 0.3176470588, 0.3215686274509804,\r\n      0.1411764706, 0.0941176471, 0.3215686275, 0.3254901960784314, 0.1490196078, 0.0901960784,\r\n      0.3254901961, 0.32941176470588235, 0.1568627451, 0.0901960784, 0.3294117647,\r\n      0.3333333333333333, 0.1647058824, 0.0862745098, 0.3333333333, 0.33725490196078434,\r\n      0.1725490196, 0.0862745098, 0.337254902, 0.3411764705882353, 0.1803921569, 0.0823529412,\r\n      0.3411764706, 0.34509803921568627, 0.1882352941, 0.0823529412, 0.3450980392,\r\n      0.34901960784313724, 0.1960784314, 0.0784313725, 0.3490196078, 0.35294117647058826,\r\n      0.2039215686, 0.0784313725, 0.3529411765, 0.3568627450980392, 0.2117647059, 0.0745098039,\r\n      0.3568627451, 0.3607843137254902, 0.2196078431, 0.0745098039, 0.3607843137,\r\n      0.36470588235294116, 0.2274509804, 0.0705882353, 0.3647058824, 0.3686274509803922,\r\n      0.2352941176, 0.0705882353, 0.368627451, 0.37254901960784315, 0.2431372549, 0.0666666667,\r\n      0.3725490196, 0.3764705882352941, 0.2509803922, 0.0666666667, 0.3764705882,\r\n      0.3803921568627451, 0.2549019608, 0.062745098, 0.3803921569, 0.3843137254901961, 0.262745098,\r\n      0.062745098, 0.3843137255, 0.38823529411764707, 0.2705882353, 0.0588235294, 0.3882352941,\r\n      0.39215686274509803, 0.2784313725, 0.0588235294, 0.3921568627, 0.396078431372549,\r\n      0.2862745098, 0.0549019608, 0.3960784314, 0.4, 0.2941176471, 0.0549019608, 0.4,\r\n      0.403921568627451, 0.3019607843, 0.0509803922, 0.4039215686, 0.40784313725490196,\r\n      0.3098039216, 0.0509803922, 0.4078431373, 0.4117647058823529, 0.3176470588, 0.0470588235,\r\n      0.4117647059, 0.41568627450980394, 0.3254901961, 0.0470588235, 0.4156862745,\r\n      0.4196078431372549, 0.3333333333, 0.0431372549, 0.4196078431, 0.4235294117647059,\r\n      0.3411764706, 0.0431372549, 0.4235294118, 0.42745098039215684, 0.3490196078, 0.0392156863,\r\n      0.4274509804, 0.43137254901960786, 0.3568627451, 0.0392156863, 0.431372549,\r\n      0.43529411764705883, 0.3647058824, 0.0352941176, 0.4352941176, 0.4392156862745098,\r\n      0.3725490196, 0.0352941176, 0.4392156863, 0.44313725490196076, 0.3803921569, 0.031372549,\r\n      0.4431372549, 0.4470588235294118, 0.3882352941, 0.031372549, 0.4470588235,\r\n      0.45098039215686275, 0.3960784314, 0.0274509804, 0.4509803922, 0.4549019607843137,\r\n      0.4039215686, 0.0274509804, 0.4549019608, 0.4588235294117647, 0.4117647059, 0.0235294118,\r\n      0.4588235294, 0.4627450980392157, 0.4196078431, 0.0235294118, 0.462745098, 0.4666666666666667,\r\n      0.4274509804, 0.0196078431, 0.4666666667, 0.4705882352941177, 0.4352941176, 0.0196078431,\r\n      0.4705882353, 0.4745098039215686, 0.4431372549, 0.0156862745, 0.4745098039,\r\n      0.4784313725490197, 0.4509803922, 0.0156862745, 0.4784313725, 0.48235294117647065,\r\n      0.4588235294, 0.0117647059, 0.4823529412, 0.48627450980392156, 0.4666666667, 0.0117647059,\r\n      0.4862745098, 0.49019607843137253, 0.4745098039, 0.0078431373, 0.4901960784,\r\n      0.49411764705882355, 0.4823529412, 0.0078431373, 0.4941176471, 0.4980392156862745,\r\n      0.4901960784, 0.0039215686, 0.4980392157, 0.5019607843137255, 0.4980392157, 0.0117647059,\r\n      0.4980392157, 0.5058823529411764, 0.5058823529, 0.0156862745, 0.4901960784,\r\n      0.5098039215686274, 0.5137254902, 0.0235294118, 0.4823529412, 0.5137254901960784,\r\n      0.5215686275, 0.0274509804, 0.4745098039, 0.5176470588235295, 0.5294117647, 0.0352941176,\r\n      0.4666666667, 0.5215686274509804, 0.537254902, 0.0392156863, 0.4588235294, 0.5254901960784314,\r\n      0.5450980392, 0.0470588235, 0.4509803922, 0.5294117647058824, 0.5529411765, 0.0509803922,\r\n      0.4431372549, 0.5333333333333333, 0.5607843137, 0.0588235294, 0.4352941176,\r\n      0.5372549019607843, 0.568627451, 0.062745098, 0.4274509804, 0.5411764705882353, 0.5764705882,\r\n      0.0705882353, 0.4196078431, 0.5450980392156862, 0.5843137255, 0.0745098039, 0.4117647059,\r\n      0.5490196078431373, 0.5921568627, 0.0823529412, 0.4039215686, 0.5529411764705883, 0.6,\r\n      0.0862745098, 0.3960784314, 0.5568627450980392, 0.6078431373, 0.0941176471, 0.3882352941,\r\n      0.5607843137254902, 0.6156862745, 0.0980392157, 0.3803921569, 0.5647058823529412,\r\n      0.6235294118, 0.1058823529, 0.3725490196, 0.5686274509803921, 0.631372549, 0.1098039216,\r\n      0.3647058824, 0.5725490196078431, 0.6392156863, 0.1176470588, 0.3568627451,\r\n      0.5764705882352941, 0.6470588235, 0.1215686275, 0.3490196078, 0.5803921568627451,\r\n      0.6549019608, 0.1294117647, 0.3411764706, 0.5843137254901961, 0.662745098, 0.1333333333,\r\n      0.3333333333, 0.5882352941176471, 0.6705882353, 0.1411764706, 0.3254901961, 0.592156862745098,\r\n      0.6784313725, 0.1450980392, 0.3176470588, 0.596078431372549, 0.6862745098, 0.1529411765,\r\n      0.3098039216, 0.6, 0.6941176471, 0.1568627451, 0.3019607843, 0.6039215686274509, 0.7019607843,\r\n      0.1647058824, 0.2941176471, 0.6078431372549019, 0.7098039216, 0.168627451, 0.2862745098,\r\n      0.611764705882353, 0.7176470588, 0.1764705882, 0.2784313725, 0.615686274509804, 0.7254901961,\r\n      0.1803921569, 0.2705882353, 0.6196078431372549, 0.7333333333, 0.1882352941, 0.262745098,\r\n      0.6235294117647059, 0.7411764706, 0.1921568627, 0.2549019608, 0.6274509803921569,\r\n      0.7490196078, 0.2, 0.2509803922, 0.6313725490196078, 0.7529411765, 0.2039215686, 0.2431372549,\r\n      0.6352941176470588, 0.7607843137, 0.2117647059, 0.2352941176, 0.6392156862745098, 0.768627451,\r\n      0.2156862745, 0.2274509804, 0.6431372549019608, 0.7764705882, 0.2235294118, 0.2196078431,\r\n      0.6470588235294118, 0.7843137255, 0.2274509804, 0.2117647059, 0.6509803921568628,\r\n      0.7921568627, 0.2352941176, 0.2039215686, 0.6549019607843137, 0.8, 0.2392156863, 0.1960784314,\r\n      0.6588235294117647, 0.8078431373, 0.2470588235, 0.1882352941, 0.6627450980392157,\r\n      0.8156862745, 0.2509803922, 0.1803921569, 0.6666666666666666, 0.8235294118, 0.2549019608,\r\n      0.1725490196, 0.6705882352941176, 0.831372549, 0.2588235294, 0.1647058824, 0.6745098039215687,\r\n      0.8392156863, 0.2666666667, 0.1568627451, 0.6784313725490196, 0.8470588235, 0.2705882353,\r\n      0.1490196078, 0.6823529411764706, 0.8549019608, 0.2784313725, 0.1411764706,\r\n      0.6862745098039216, 0.862745098, 0.2823529412, 0.1333333333, 0.6901960784313725, 0.8705882353,\r\n      0.2901960784, 0.1254901961, 0.6941176470588235, 0.8784313725, 0.2941176471, 0.1176470588,\r\n      0.6980392156862745, 0.8862745098, 0.3019607843, 0.1098039216, 0.7019607843137254,\r\n      0.8941176471, 0.3058823529, 0.1019607843, 0.7058823529411765, 0.9019607843, 0.3137254902,\r\n      0.0941176471, 0.7098039215686275, 0.9098039216, 0.3176470588, 0.0862745098,\r\n      0.7137254901960784, 0.9176470588, 0.3254901961, 0.0784313725, 0.7176470588235294,\r\n      0.9254901961, 0.3294117647, 0.0705882353, 0.7215686274509804, 0.9333333333, 0.337254902,\r\n      0.062745098, 0.7254901960784313, 0.9411764706, 0.3411764706, 0.0549019608, 0.7294117647058823,\r\n      0.9490196078, 0.3490196078, 0.0470588235, 0.7333333333333333, 0.9568627451, 0.3529411765,\r\n      0.0392156863, 0.7372549019607844, 0.9647058824, 0.3607843137, 0.031372549, 0.7411764705882353,\r\n      0.9725490196, 0.3647058824, 0.0235294118, 0.7450980392156863, 0.9803921569, 0.3725490196,\r\n      0.0156862745, 0.7490196078431373, 0.9882352941, 0.3725490196, 0.0039215686,\r\n      0.7529411764705882, 0.9960784314, 0.3843137255, 0.0156862745, 0.7568627450980392,\r\n      0.9960784314, 0.3921568627, 0.031372549, 0.7607843137254902, 0.9960784314, 0.4039215686,\r\n      0.0470588235, 0.7647058823529411, 0.9960784314, 0.4117647059, 0.062745098, 0.7686274509803922,\r\n      0.9960784314, 0.4235294118, 0.0784313725, 0.7725490196078432, 0.9960784314, 0.431372549,\r\n      0.0941176471, 0.7764705882352941, 0.9960784314, 0.4431372549, 0.1098039216,\r\n      0.7803921568627451, 0.9960784314, 0.4509803922, 0.1254901961, 0.7843137254901961,\r\n      0.9960784314, 0.462745098, 0.1411764706, 0.788235294117647, 0.9960784314, 0.4705882353,\r\n      0.1568627451, 0.792156862745098, 0.9960784314, 0.4823529412, 0.1725490196, 0.796078431372549,\r\n      0.9960784314, 0.4901960784, 0.1882352941, 0.8, 0.9960784314, 0.5019607843, 0.2039215686,\r\n      0.803921568627451, 0.9960784314, 0.5098039216, 0.2196078431, 0.807843137254902, 0.9960784314,\r\n      0.5215686275, 0.2352941176, 0.8117647058823529, 0.9960784314, 0.5294117647, 0.2509803922,\r\n      0.8156862745098039, 0.9960784314, 0.5411764706, 0.262745098, 0.8196078431372549, 0.9960784314,\r\n      0.5490196078, 0.2784313725, 0.8235294117647058, 0.9960784314, 0.5607843137, 0.2941176471,\r\n      0.8274509803921568, 0.9960784314, 0.568627451, 0.3098039216, 0.8313725490196079, 0.9960784314,\r\n      0.5803921569, 0.3254901961, 0.8352941176470589, 0.9960784314, 0.5882352941, 0.3411764706,\r\n      0.8392156862745098, 0.9960784314, 0.6, 0.3568627451, 0.8431372549019608, 0.9960784314,\r\n      0.6078431373, 0.3725490196, 0.8470588235294118, 0.9960784314, 0.6196078431, 0.3882352941,\r\n      0.8509803921568627, 0.9960784314, 0.6274509804, 0.4039215686, 0.8549019607843137,\r\n      0.9960784314, 0.6392156863, 0.4196078431, 0.8588235294117647, 0.9960784314, 0.6470588235,\r\n      0.4352941176, 0.8627450980392157, 0.9960784314, 0.6588235294, 0.4509803922,\r\n      0.8666666666666667, 0.9960784314, 0.6666666667, 0.4666666667, 0.8705882352941177,\r\n      0.9960784314, 0.6784313725, 0.4823529412, 0.8745098039215686, 0.9960784314, 0.6862745098,\r\n      0.4980392157, 0.8784313725490196, 0.9960784314, 0.6980392157, 0.5137254902,\r\n      0.8823529411764706, 0.9960784314, 0.7058823529, 0.5294117647, 0.8862745098039215,\r\n      0.9960784314, 0.7176470588, 0.5450980392, 0.8901960784313725, 0.9960784314, 0.7254901961,\r\n      0.5607843137, 0.8941176470588236, 0.9960784314, 0.737254902, 0.5764705882, 0.8980392156862745,\r\n      0.9960784314, 0.7450980392, 0.5921568627, 0.9019607843137255, 0.9960784314, 0.7529411765,\r\n      0.6078431373, 0.9058823529411765, 0.9960784314, 0.7607843137, 0.6235294118,\r\n      0.9098039215686274, 0.9960784314, 0.7725490196, 0.6392156863, 0.9137254901960784,\r\n      0.9960784314, 0.7803921569, 0.6549019608, 0.9176470588235294, 0.9960784314, 0.7921568627,\r\n      0.6705882353, 0.9215686274509803, 0.9960784314, 0.8, 0.6862745098, 0.9254901960784314,\r\n      0.9960784314, 0.8117647059, 0.7019607843, 0.9294117647058824, 0.9960784314, 0.8196078431,\r\n      0.7176470588, 0.9333333333333333, 0.9960784314, 0.831372549, 0.7333333333, 0.9372549019607843,\r\n      0.9960784314, 0.8392156863, 0.7490196078, 0.9411764705882354, 0.9960784314, 0.8509803922,\r\n      0.7607843137, 0.9450980392156864, 0.9960784314, 0.8588235294, 0.7764705882,\r\n      0.9490196078431372, 0.9960784314, 0.8705882353, 0.7921568627, 0.9529411764705882,\r\n      0.9960784314, 0.8784313725, 0.8078431373, 0.9568627450980394, 0.9960784314, 0.8901960784,\r\n      0.8235294118, 0.9607843137254903, 0.9960784314, 0.8980392157, 0.8392156863,\r\n      0.9647058823529413, 0.9960784314, 0.9098039216, 0.8549019608, 0.9686274509803922,\r\n      0.9960784314, 0.9176470588, 0.8705882353, 0.9725490196078431, 0.9960784314, 0.9294117647,\r\n      0.8862745098, 0.9764705882352941, 0.9960784314, 0.937254902, 0.9019607843, 0.9803921568627451,\r\n      0.9960784314, 0.9490196078, 0.9176470588, 0.984313725490196, 0.9960784314, 0.9568627451,\r\n      0.9333333333, 0.9882352941176471, 0.9960784314, 0.968627451, 0.9490196078, 0.9921568627450981,\r\n      0.9960784314, 0.9764705882, 0.9647058824, 0.996078431372549, 0.9960784314, 0.9882352941,\r\n      0.9803921569, 1.0, 0.9960784314, 0.9882352941, 0.9803921569,\r\n    ],\r\n    description: 'GE 256',\r\n  },\r\n  {\r\n    ColorSpace: 'RGB',\r\n    Name: 'ge',\r\n    RGBPoints: [\r\n      0.0, 0.0078431373, 0.0078431373, 0.0078431373, 0.00392156862745098, 0.0078431373,\r\n      0.0078431373, 0.0078431373, 0.00784313725490196, 0.0078431373, 0.0078431373, 0.0078431373,\r\n      0.011764705882352941, 0.0078431373, 0.0078431373, 0.0078431373, 0.01568627450980392,\r\n      0.0078431373, 0.0078431373, 0.0078431373, 0.0196078431372549, 0.0078431373, 0.0078431373,\r\n      0.0078431373, 0.023529411764705882, 0.0078431373, 0.0078431373, 0.0078431373,\r\n      0.027450980392156862, 0.0078431373, 0.0078431373, 0.0078431373, 0.03137254901960784,\r\n      0.0078431373, 0.0078431373, 0.0078431373, 0.03529411764705882, 0.0078431373, 0.0078431373,\r\n      0.0078431373, 0.0392156862745098, 0.0078431373, 0.0078431373, 0.0078431373,\r\n      0.043137254901960784, 0.0078431373, 0.0078431373, 0.0078431373, 0.047058823529411764,\r\n      0.0078431373, 0.0078431373, 0.0078431373, 0.050980392156862744, 0.0078431373, 0.0078431373,\r\n      0.0078431373, 0.054901960784313725, 0.0078431373, 0.0078431373, 0.0078431373,\r\n      0.05882352941176471, 0.0117647059, 0.0078431373, 0.0078431373, 0.06274509803921569,\r\n      0.0078431373, 0.0156862745, 0.0156862745, 0.06666666666666667, 0.0078431373, 0.0235294118,\r\n      0.0235294118, 0.07058823529411765, 0.0078431373, 0.031372549, 0.031372549,\r\n      0.07450980392156863, 0.0078431373, 0.0392156863, 0.0392156863, 0.0784313725490196,\r\n      0.0078431373, 0.0470588235, 0.0470588235, 0.08235294117647059, 0.0078431373, 0.0549019608,\r\n      0.0549019608, 0.08627450980392157, 0.0078431373, 0.062745098, 0.062745098,\r\n      0.09019607843137255, 0.0078431373, 0.0705882353, 0.0705882353, 0.09411764705882353,\r\n      0.0078431373, 0.0784313725, 0.0784313725, 0.09803921568627451, 0.0078431373, 0.0901960784,\r\n      0.0862745098, 0.10196078431372549, 0.0078431373, 0.0980392157, 0.0941176471,\r\n      0.10588235294117647, 0.0078431373, 0.1058823529, 0.1019607843, 0.10980392156862745,\r\n      0.0078431373, 0.1137254902, 0.1098039216, 0.11372549019607843, 0.0078431373, 0.1215686275,\r\n      0.1176470588, 0.11764705882352942, 0.0078431373, 0.1294117647, 0.1254901961,\r\n      0.12156862745098039, 0.0078431373, 0.137254902, 0.1333333333, 0.12549019607843137,\r\n      0.0078431373, 0.1450980392, 0.1411764706, 0.12941176470588237, 0.0078431373, 0.1529411765,\r\n      0.1490196078, 0.13333333333333333, 0.0078431373, 0.1647058824, 0.1568627451,\r\n      0.13725490196078433, 0.0078431373, 0.1725490196, 0.1647058824, 0.1411764705882353,\r\n      0.0078431373, 0.1803921569, 0.1725490196, 0.1450980392156863, 0.0078431373, 0.1882352941,\r\n      0.1803921569, 0.14901960784313725, 0.0078431373, 0.1960784314, 0.1882352941,\r\n      0.15294117647058825, 0.0078431373, 0.2039215686, 0.1960784314, 0.1568627450980392,\r\n      0.0078431373, 0.2117647059, 0.2039215686, 0.1607843137254902, 0.0078431373, 0.2196078431,\r\n      0.2117647059, 0.16470588235294117, 0.0078431373, 0.2274509804, 0.2196078431,\r\n      0.16862745098039217, 0.0078431373, 0.2352941176, 0.2274509804, 0.17254901960784313,\r\n      0.0078431373, 0.2470588235, 0.2352941176, 0.17647058823529413, 0.0078431373, 0.2509803922,\r\n      0.2431372549, 0.1803921568627451, 0.0078431373, 0.2549019608, 0.2509803922,\r\n      0.1843137254901961, 0.0078431373, 0.262745098, 0.2509803922, 0.18823529411764706,\r\n      0.0078431373, 0.2705882353, 0.2588235294, 0.19215686274509805, 0.0078431373, 0.2784313725,\r\n      0.2666666667, 0.19607843137254902, 0.0078431373, 0.2862745098, 0.2745098039, 0.2,\r\n      0.0078431373, 0.2941176471, 0.2823529412, 0.20392156862745098, 0.0078431373, 0.3019607843,\r\n      0.2901960784, 0.20784313725490197, 0.0078431373, 0.3137254902, 0.2980392157,\r\n      0.21176470588235294, 0.0078431373, 0.3215686275, 0.3058823529, 0.21568627450980393,\r\n      0.0078431373, 0.3294117647, 0.3137254902, 0.2196078431372549, 0.0078431373, 0.337254902,\r\n      0.3215686275, 0.2235294117647059, 0.0078431373, 0.3450980392, 0.3294117647,\r\n      0.22745098039215686, 0.0078431373, 0.3529411765, 0.337254902, 0.23137254901960785,\r\n      0.0078431373, 0.3607843137, 0.3450980392, 0.23529411764705885, 0.0078431373, 0.368627451,\r\n      0.3529411765, 0.23921568627450984, 0.0078431373, 0.3764705882, 0.3607843137,\r\n      0.24313725490196078, 0.0078431373, 0.3843137255, 0.368627451, 0.24705882352941178,\r\n      0.0078431373, 0.3960784314, 0.3764705882, 0.25098039215686274, 0.0078431373, 0.4039215686,\r\n      0.3843137255, 0.2549019607843137, 0.0078431373, 0.4117647059, 0.3921568627,\r\n      0.25882352941176473, 0.0078431373, 0.4196078431, 0.4, 0.2627450980392157, 0.0078431373,\r\n      0.4274509804, 0.4078431373, 0.26666666666666666, 0.0078431373, 0.4352941176, 0.4156862745,\r\n      0.27058823529411763, 0.0078431373, 0.4431372549, 0.4235294118, 0.27450980392156865,\r\n      0.0078431373, 0.4509803922, 0.431372549, 0.2784313725490196, 0.0078431373, 0.4588235294,\r\n      0.4392156863, 0.2823529411764706, 0.0078431373, 0.4705882353, 0.4470588235,\r\n      0.28627450980392155, 0.0078431373, 0.4784313725, 0.4549019608, 0.2901960784313726,\r\n      0.0078431373, 0.4862745098, 0.462745098, 0.29411764705882354, 0.0078431373, 0.4941176471,\r\n      0.4705882353, 0.2980392156862745, 0.0078431373, 0.5019607843, 0.4784313725,\r\n      0.30196078431372547, 0.0117647059, 0.5098039216, 0.4862745098, 0.3058823529411765,\r\n      0.0196078431, 0.5019607843, 0.4941176471, 0.30980392156862746, 0.0274509804, 0.4941176471,\r\n      0.5058823529, 0.3137254901960784, 0.0352941176, 0.4862745098, 0.5137254902,\r\n      0.3176470588235294, 0.0431372549, 0.4784313725, 0.5215686275, 0.3215686274509804,\r\n      0.0509803922, 0.4705882353, 0.5294117647, 0.3254901960784314, 0.0588235294, 0.462745098,\r\n      0.537254902, 0.32941176470588235, 0.0666666667, 0.4549019608, 0.5450980392,\r\n      0.3333333333333333, 0.0745098039, 0.4470588235, 0.5529411765, 0.33725490196078434,\r\n      0.0823529412, 0.4392156863, 0.5607843137, 0.3411764705882353, 0.0901960784, 0.431372549,\r\n      0.568627451, 0.34509803921568627, 0.0980392157, 0.4235294118, 0.5764705882,\r\n      0.34901960784313724, 0.1058823529, 0.4156862745, 0.5843137255, 0.35294117647058826,\r\n      0.1137254902, 0.4078431373, 0.5921568627, 0.3568627450980392, 0.1215686275, 0.4, 0.6,\r\n      0.3607843137254902, 0.1294117647, 0.3921568627, 0.6078431373, 0.36470588235294116,\r\n      0.137254902, 0.3843137255, 0.6156862745, 0.3686274509803922, 0.1450980392, 0.3764705882,\r\n      0.6235294118, 0.37254901960784315, 0.1529411765, 0.368627451, 0.631372549, 0.3764705882352941,\r\n      0.1607843137, 0.3607843137, 0.6392156863, 0.3803921568627451, 0.168627451, 0.3529411765,\r\n      0.6470588235, 0.3843137254901961, 0.1764705882, 0.3450980392, 0.6549019608,\r\n      0.38823529411764707, 0.1843137255, 0.337254902, 0.662745098, 0.39215686274509803,\r\n      0.1921568627, 0.3294117647, 0.6705882353, 0.396078431372549, 0.2, 0.3215686275, 0.6784313725,\r\n      0.4, 0.2078431373, 0.3137254902, 0.6862745098, 0.403921568627451, 0.2156862745, 0.3058823529,\r\n      0.6941176471, 0.40784313725490196, 0.2235294118, 0.2980392157, 0.7019607843,\r\n      0.4117647058823529, 0.231372549, 0.2901960784, 0.7098039216, 0.41568627450980394,\r\n      0.2392156863, 0.2823529412, 0.7176470588, 0.4196078431372549, 0.2470588235, 0.2745098039,\r\n      0.7254901961, 0.4235294117647059, 0.2509803922, 0.2666666667, 0.7333333333,\r\n      0.42745098039215684, 0.2509803922, 0.2588235294, 0.7411764706, 0.43137254901960786,\r\n      0.2588235294, 0.2509803922, 0.7490196078, 0.43529411764705883, 0.2666666667, 0.2509803922,\r\n      0.7490196078, 0.4392156862745098, 0.2745098039, 0.2431372549, 0.7568627451,\r\n      0.44313725490196076, 0.2823529412, 0.2352941176, 0.7647058824, 0.4470588235294118,\r\n      0.2901960784, 0.2274509804, 0.7725490196, 0.45098039215686275, 0.2980392157, 0.2196078431,\r\n      0.7803921569, 0.4549019607843137, 0.3058823529, 0.2117647059, 0.7882352941,\r\n      0.4588235294117647, 0.3137254902, 0.2039215686, 0.7960784314, 0.4627450980392157,\r\n      0.3215686275, 0.1960784314, 0.8039215686, 0.4666666666666667, 0.3294117647, 0.1882352941,\r\n      0.8117647059, 0.4705882352941177, 0.337254902, 0.1803921569, 0.8196078431, 0.4745098039215686,\r\n      0.3450980392, 0.1725490196, 0.8274509804, 0.4784313725490197, 0.3529411765, 0.1647058824,\r\n      0.8352941176, 0.48235294117647065, 0.3607843137, 0.1568627451, 0.8431372549,\r\n      0.48627450980392156, 0.368627451, 0.1490196078, 0.8509803922, 0.49019607843137253,\r\n      0.3764705882, 0.1411764706, 0.8588235294, 0.49411764705882355, 0.3843137255, 0.1333333333,\r\n      0.8666666667, 0.4980392156862745, 0.3921568627, 0.1254901961, 0.8745098039,\r\n      0.5019607843137255, 0.4, 0.1176470588, 0.8823529412, 0.5058823529411764, 0.4078431373,\r\n      0.1098039216, 0.8901960784, 0.5098039215686274, 0.4156862745, 0.1019607843, 0.8980392157,\r\n      0.5137254901960784, 0.4235294118, 0.0941176471, 0.9058823529, 0.5176470588235295, 0.431372549,\r\n      0.0862745098, 0.9137254902, 0.5215686274509804, 0.4392156863, 0.0784313725, 0.9215686275,\r\n      0.5254901960784314, 0.4470588235, 0.0705882353, 0.9294117647, 0.5294117647058824,\r\n      0.4549019608, 0.062745098, 0.937254902, 0.5333333333333333, 0.462745098, 0.0549019608,\r\n      0.9450980392, 0.5372549019607843, 0.4705882353, 0.0470588235, 0.9529411765,\r\n      0.5411764705882353, 0.4784313725, 0.0392156863, 0.9607843137, 0.5450980392156862,\r\n      0.4862745098, 0.031372549, 0.968627451, 0.5490196078431373, 0.4941176471, 0.0235294118,\r\n      0.9764705882, 0.5529411764705883, 0.4980392157, 0.0156862745, 0.9843137255,\r\n      0.5568627450980392, 0.5058823529, 0.0078431373, 0.9921568627, 0.5607843137254902,\r\n      0.5137254902, 0.0156862745, 0.9803921569, 0.5647058823529412, 0.5215686275, 0.0235294118,\r\n      0.9647058824, 0.5686274509803921, 0.5294117647, 0.0352941176, 0.9490196078,\r\n      0.5725490196078431, 0.537254902, 0.0431372549, 0.9333333333, 0.5764705882352941, 0.5450980392,\r\n      0.0509803922, 0.9176470588, 0.5803921568627451, 0.5529411765, 0.062745098, 0.9019607843,\r\n      0.5843137254901961, 0.5607843137, 0.0705882353, 0.8862745098, 0.5882352941176471, 0.568627451,\r\n      0.0784313725, 0.8705882353, 0.592156862745098, 0.5764705882, 0.0901960784, 0.8549019608,\r\n      0.596078431372549, 0.5843137255, 0.0980392157, 0.8392156863, 0.6, 0.5921568627, 0.1098039216,\r\n      0.8235294118, 0.6039215686274509, 0.6, 0.1176470588, 0.8078431373, 0.6078431372549019,\r\n      0.6078431373, 0.1254901961, 0.7921568627, 0.611764705882353, 0.6156862745, 0.137254902,\r\n      0.7764705882, 0.615686274509804, 0.6235294118, 0.1450980392, 0.7607843137, 0.6196078431372549,\r\n      0.631372549, 0.1529411765, 0.7490196078, 0.6235294117647059, 0.6392156863, 0.1647058824,\r\n      0.737254902, 0.6274509803921569, 0.6470588235, 0.1725490196, 0.7215686275, 0.6313725490196078,\r\n      0.6549019608, 0.1843137255, 0.7058823529, 0.6352941176470588, 0.662745098, 0.1921568627,\r\n      0.6901960784, 0.6392156862745098, 0.6705882353, 0.2, 0.6745098039, 0.6431372549019608,\r\n      0.6784313725, 0.2117647059, 0.6588235294, 0.6470588235294118, 0.6862745098, 0.2196078431,\r\n      0.6431372549, 0.6509803921568628, 0.6941176471, 0.2274509804, 0.6274509804,\r\n      0.6549019607843137, 0.7019607843, 0.2392156863, 0.6117647059, 0.6588235294117647,\r\n      0.7098039216, 0.2470588235, 0.5960784314, 0.6627450980392157, 0.7176470588, 0.2509803922,\r\n      0.5803921569, 0.6666666666666666, 0.7254901961, 0.2588235294, 0.5647058824,\r\n      0.6705882352941176, 0.7333333333, 0.2666666667, 0.5490196078, 0.6745098039215687,\r\n      0.7411764706, 0.2784313725, 0.5333333333, 0.6784313725490196, 0.7490196078, 0.2862745098,\r\n      0.5176470588, 0.6823529411764706, 0.7490196078, 0.2941176471, 0.5019607843,\r\n      0.6862745098039216, 0.7529411765, 0.3058823529, 0.4862745098, 0.6901960784313725,\r\n      0.7607843137, 0.3137254902, 0.4705882353, 0.6941176470588235, 0.768627451, 0.3215686275,\r\n      0.4549019608, 0.6980392156862745, 0.7764705882, 0.3333333333, 0.4392156863,\r\n      0.7019607843137254, 0.7843137255, 0.3411764706, 0.4235294118, 0.7058823529411765,\r\n      0.7921568627, 0.3529411765, 0.4078431373, 0.7098039215686275, 0.8, 0.3607843137, 0.3921568627,\r\n      0.7137254901960784, 0.8078431373, 0.368627451, 0.3764705882, 0.7176470588235294, 0.8156862745,\r\n      0.3803921569, 0.3607843137, 0.7215686274509804, 0.8235294118, 0.3882352941, 0.3450980392,\r\n      0.7254901960784313, 0.831372549, 0.3960784314, 0.3294117647, 0.7294117647058823, 0.8392156863,\r\n      0.4078431373, 0.3137254902, 0.7333333333333333, 0.8470588235, 0.4156862745, 0.2980392157,\r\n      0.7372549019607844, 0.8549019608, 0.4274509804, 0.2823529412, 0.7411764705882353, 0.862745098,\r\n      0.4352941176, 0.2666666667, 0.7450980392156863, 0.8705882353, 0.4431372549, 0.2509803922,\r\n      0.7490196078431373, 0.8784313725, 0.4549019608, 0.2431372549, 0.7529411764705882,\r\n      0.8862745098, 0.462745098, 0.2274509804, 0.7568627450980392, 0.8941176471, 0.4705882353,\r\n      0.2117647059, 0.7607843137254902, 0.9019607843, 0.4823529412, 0.1960784314,\r\n      0.7647058823529411, 0.9098039216, 0.4901960784, 0.1803921569, 0.7686274509803922,\r\n      0.9176470588, 0.4980392157, 0.1647058824, 0.7725490196078432, 0.9254901961, 0.5098039216,\r\n      0.1490196078, 0.7764705882352941, 0.9333333333, 0.5176470588, 0.1333333333,\r\n      0.7803921568627451, 0.9411764706, 0.5294117647, 0.1176470588, 0.7843137254901961,\r\n      0.9490196078, 0.537254902, 0.1019607843, 0.788235294117647, 0.9568627451, 0.5450980392,\r\n      0.0862745098, 0.792156862745098, 0.9647058824, 0.5568627451, 0.0705882353, 0.796078431372549,\r\n      0.9725490196, 0.5647058824, 0.0549019608, 0.8, 0.9803921569, 0.5725490196, 0.0392156863,\r\n      0.803921568627451, 0.9882352941, 0.5843137255, 0.0235294118, 0.807843137254902, 0.9921568627,\r\n      0.5921568627, 0.0078431373, 0.8117647058823529, 0.9921568627, 0.6039215686, 0.0274509804,\r\n      0.8156862745098039, 0.9921568627, 0.6117647059, 0.0509803922, 0.8196078431372549,\r\n      0.9921568627, 0.6196078431, 0.0745098039, 0.8235294117647058, 0.9921568627, 0.631372549,\r\n      0.0980392157, 0.8274509803921568, 0.9921568627, 0.6392156863, 0.1215686275,\r\n      0.8313725490196079, 0.9921568627, 0.6470588235, 0.1411764706, 0.8352941176470589,\r\n      0.9921568627, 0.6588235294, 0.1647058824, 0.8392156862745098, 0.9921568627, 0.6666666667,\r\n      0.1882352941, 0.8431372549019608, 0.9921568627, 0.6784313725, 0.2117647059,\r\n      0.8470588235294118, 0.9921568627, 0.6862745098, 0.2352941176, 0.8509803921568627,\r\n      0.9921568627, 0.6941176471, 0.2509803922, 0.8549019607843137, 0.9921568627, 0.7058823529,\r\n      0.2705882353, 0.8588235294117647, 0.9921568627, 0.7137254902, 0.2941176471,\r\n      0.8627450980392157, 0.9921568627, 0.7215686275, 0.3176470588, 0.8666666666666667,\r\n      0.9921568627, 0.7333333333, 0.3411764706, 0.8705882352941177, 0.9921568627, 0.7411764706,\r\n      0.3647058824, 0.8745098039215686, 0.9921568627, 0.7490196078, 0.3843137255,\r\n      0.8784313725490196, 0.9921568627, 0.7529411765, 0.4078431373, 0.8823529411764706,\r\n      0.9921568627, 0.7607843137, 0.431372549, 0.8862745098039215, 0.9921568627, 0.7725490196,\r\n      0.4549019608, 0.8901960784313725, 0.9921568627, 0.7803921569, 0.4784313725,\r\n      0.8941176470588236, 0.9921568627, 0.7882352941, 0.4980392157, 0.8980392156862745,\r\n      0.9921568627, 0.8, 0.5215686275, 0.9019607843137255, 0.9921568627, 0.8078431373, 0.5450980392,\r\n      0.9058823529411765, 0.9921568627, 0.8156862745, 0.568627451, 0.9098039215686274, 0.9921568627,\r\n      0.8274509804, 0.5921568627, 0.9137254901960784, 0.9921568627, 0.8352941176, 0.6156862745,\r\n      0.9176470588235294, 0.9921568627, 0.8470588235, 0.6352941176, 0.9215686274509803,\r\n      0.9921568627, 0.8549019608, 0.6588235294, 0.9254901960784314, 0.9921568627, 0.862745098,\r\n      0.6823529412, 0.9294117647058824, 0.9921568627, 0.8745098039, 0.7058823529,\r\n      0.9333333333333333, 0.9921568627, 0.8823529412, 0.7294117647, 0.9372549019607843,\r\n      0.9921568627, 0.8901960784, 0.7490196078, 0.9411764705882354, 0.9921568627, 0.9019607843,\r\n      0.7647058824, 0.9450980392156864, 0.9921568627, 0.9098039216, 0.7882352941,\r\n      0.9490196078431372, 0.9921568627, 0.9215686275, 0.8117647059, 0.9529411764705882,\r\n      0.9921568627, 0.9294117647, 0.8352941176, 0.9568627450980394, 0.9921568627, 0.937254902,\r\n      0.8588235294, 0.9607843137254903, 0.9921568627, 0.9490196078, 0.8784313725,\r\n      0.9647058823529413, 0.9921568627, 0.9568627451, 0.9019607843, 0.9686274509803922,\r\n      0.9921568627, 0.9647058824, 0.9254901961, 0.9725490196078431, 0.9921568627, 0.9764705882,\r\n      0.9490196078, 0.9764705882352941, 0.9921568627, 0.9843137255, 0.9725490196,\r\n      0.9803921568627451, 0.9921568627, 0.9921568627, 0.9921568627, 0.984313725490196, 0.9921568627,\r\n      0.9921568627, 0.9921568627, 0.9882352941176471, 0.9921568627, 0.9921568627, 0.9921568627,\r\n      0.9921568627450981, 0.9921568627, 0.9921568627, 0.9921568627, 0.996078431372549, 0.9921568627,\r\n      0.9921568627, 0.9921568627, 1.0, 0.9921568627, 0.9921568627, 0.9921568627,\r\n    ],\r\n    description: 'GE',\r\n  },\r\n  {\r\n    ColorSpace: 'RGB',\r\n    Name: 'siemens',\r\n    RGBPoints: [\r\n      0.0, 0.0078431373, 0.0039215686, 0.1254901961, 0.00392156862745098, 0.0078431373,\r\n      0.0039215686, 0.1254901961, 0.00784313725490196, 0.0078431373, 0.0039215686, 0.1882352941,\r\n      0.011764705882352941, 0.0117647059, 0.0039215686, 0.2509803922, 0.01568627450980392,\r\n      0.0117647059, 0.0039215686, 0.3098039216, 0.0196078431372549, 0.0156862745, 0.0039215686,\r\n      0.3725490196, 0.023529411764705882, 0.0156862745, 0.0039215686, 0.3725490196,\r\n      0.027450980392156862, 0.0156862745, 0.0039215686, 0.3725490196, 0.03137254901960784,\r\n      0.0156862745, 0.0039215686, 0.3725490196, 0.03529411764705882, 0.0156862745, 0.0039215686,\r\n      0.3725490196, 0.0392156862745098, 0.0156862745, 0.0039215686, 0.3725490196,\r\n      0.043137254901960784, 0.0156862745, 0.0039215686, 0.3725490196, 0.047058823529411764,\r\n      0.0156862745, 0.0039215686, 0.3725490196, 0.050980392156862744, 0.0156862745, 0.0039215686,\r\n      0.3725490196, 0.054901960784313725, 0.0156862745, 0.0039215686, 0.3725490196,\r\n      0.05882352941176471, 0.0156862745, 0.0039215686, 0.3725490196, 0.06274509803921569,\r\n      0.0156862745, 0.0039215686, 0.3882352941, 0.06666666666666667, 0.0156862745, 0.0039215686,\r\n      0.4078431373, 0.07058823529411765, 0.0156862745, 0.0039215686, 0.4235294118,\r\n      0.07450980392156863, 0.0156862745, 0.0039215686, 0.4431372549, 0.0784313725490196,\r\n      0.0156862745, 0.0039215686, 0.462745098, 0.08235294117647059, 0.0156862745, 0.0039215686,\r\n      0.4784313725, 0.08627450980392157, 0.0156862745, 0.0039215686, 0.4980392157,\r\n      0.09019607843137255, 0.0196078431, 0.0039215686, 0.5137254902, 0.09411764705882353,\r\n      0.0196078431, 0.0039215686, 0.5333333333, 0.09803921568627451, 0.0196078431, 0.0039215686,\r\n      0.5529411765, 0.10196078431372549, 0.0196078431, 0.0039215686, 0.568627451,\r\n      0.10588235294117647, 0.0196078431, 0.0039215686, 0.5882352941, 0.10980392156862745,\r\n      0.0196078431, 0.0039215686, 0.6039215686, 0.11372549019607843, 0.0196078431, 0.0039215686,\r\n      0.6235294118, 0.11764705882352942, 0.0196078431, 0.0039215686, 0.6431372549,\r\n      0.12156862745098039, 0.0235294118, 0.0039215686, 0.6588235294, 0.12549019607843137,\r\n      0.0235294118, 0.0039215686, 0.6784313725, 0.12941176470588237, 0.0235294118, 0.0039215686,\r\n      0.6980392157, 0.13333333333333333, 0.0235294118, 0.0039215686, 0.7137254902,\r\n      0.13725490196078433, 0.0235294118, 0.0039215686, 0.7333333333, 0.1411764705882353,\r\n      0.0235294118, 0.0039215686, 0.7490196078, 0.1450980392156863, 0.0235294118, 0.0039215686,\r\n      0.7647058824, 0.14901960784313725, 0.0235294118, 0.0039215686, 0.7843137255,\r\n      0.15294117647058825, 0.0274509804, 0.0039215686, 0.8, 0.1568627450980392, 0.0274509804,\r\n      0.0039215686, 0.8196078431, 0.1607843137254902, 0.0274509804, 0.0039215686, 0.8352941176,\r\n      0.16470588235294117, 0.0274509804, 0.0039215686, 0.8549019608, 0.16862745098039217,\r\n      0.0274509804, 0.0039215686, 0.8745098039, 0.17254901960784313, 0.0274509804, 0.0039215686,\r\n      0.8901960784, 0.17647058823529413, 0.0274509804, 0.0039215686, 0.9098039216,\r\n      0.1803921568627451, 0.031372549, 0.0039215686, 0.9294117647, 0.1843137254901961, 0.031372549,\r\n      0.0039215686, 0.9254901961, 0.18823529411764706, 0.0509803922, 0.0039215686, 0.9098039216,\r\n      0.19215686274509805, 0.0705882353, 0.0039215686, 0.8901960784, 0.19607843137254902,\r\n      0.0901960784, 0.0039215686, 0.8705882353, 0.2, 0.1137254902, 0.0039215686, 0.8509803922,\r\n      0.20392156862745098, 0.1333333333, 0.0039215686, 0.831372549, 0.20784313725490197,\r\n      0.1529411765, 0.0039215686, 0.8117647059, 0.21176470588235294, 0.1725490196, 0.0039215686,\r\n      0.7921568627, 0.21568627450980393, 0.1960784314, 0.0039215686, 0.7725490196,\r\n      0.2196078431372549, 0.2156862745, 0.0039215686, 0.7529411765, 0.2235294117647059,\r\n      0.2352941176, 0.0039215686, 0.737254902, 0.22745098039215686, 0.2509803922, 0.0039215686,\r\n      0.7176470588, 0.23137254901960785, 0.2745098039, 0.0039215686, 0.6980392157,\r\n      0.23529411764705885, 0.2941176471, 0.0039215686, 0.6784313725, 0.23921568627450984,\r\n      0.3137254902, 0.0039215686, 0.6588235294, 0.24313725490196078, 0.3333333333, 0.0039215686,\r\n      0.6392156863, 0.24705882352941178, 0.3568627451, 0.0039215686, 0.6196078431,\r\n      0.25098039215686274, 0.3764705882, 0.0039215686, 0.6, 0.2549019607843137, 0.3960784314,\r\n      0.0039215686, 0.5803921569, 0.25882352941176473, 0.4156862745, 0.0039215686, 0.5607843137,\r\n      0.2627450980392157, 0.4392156863, 0.0039215686, 0.5411764706, 0.26666666666666666,\r\n      0.4588235294, 0.0039215686, 0.5215686275, 0.27058823529411763, 0.4784313725, 0.0039215686,\r\n      0.5019607843, 0.27450980392156865, 0.4980392157, 0.0039215686, 0.4823529412,\r\n      0.2784313725490196, 0.5215686275, 0.0039215686, 0.4666666667, 0.2823529411764706,\r\n      0.5411764706, 0.0039215686, 0.4470588235, 0.28627450980392155, 0.5607843137, 0.0039215686,\r\n      0.4274509804, 0.2901960784313726, 0.5803921569, 0.0039215686, 0.4078431373,\r\n      0.29411764705882354, 0.6039215686, 0.0039215686, 0.3882352941, 0.2980392156862745,\r\n      0.6235294118, 0.0039215686, 0.368627451, 0.30196078431372547, 0.6431372549, 0.0039215686,\r\n      0.3490196078, 0.3058823529411765, 0.662745098, 0.0039215686, 0.3294117647,\r\n      0.30980392156862746, 0.6862745098, 0.0039215686, 0.3098039216, 0.3137254901960784,\r\n      0.7058823529, 0.0039215686, 0.2901960784, 0.3176470588235294, 0.7254901961, 0.0039215686,\r\n      0.2705882353, 0.3215686274509804, 0.7450980392, 0.0039215686, 0.2509803922,\r\n      0.3254901960784314, 0.7647058824, 0.0039215686, 0.2352941176, 0.32941176470588235,\r\n      0.7843137255, 0.0039215686, 0.2156862745, 0.3333333333333333, 0.8039215686, 0.0039215686,\r\n      0.1960784314, 0.33725490196078434, 0.8235294118, 0.0039215686, 0.1764705882,\r\n      0.3411764705882353, 0.8470588235, 0.0039215686, 0.1568627451, 0.34509803921568627,\r\n      0.8666666667, 0.0039215686, 0.137254902, 0.34901960784313724, 0.8862745098, 0.0039215686,\r\n      0.1176470588, 0.35294117647058826, 0.9058823529, 0.0039215686, 0.0980392157,\r\n      0.3568627450980392, 0.9294117647, 0.0039215686, 0.0784313725, 0.3607843137254902,\r\n      0.9490196078, 0.0039215686, 0.0588235294, 0.36470588235294116, 0.968627451, 0.0039215686,\r\n      0.0392156863, 0.3686274509803922, 0.9921568627, 0.0039215686, 0.0235294118,\r\n      0.37254901960784315, 0.9529411765, 0.0039215686, 0.0588235294, 0.3764705882352941,\r\n      0.9529411765, 0.0078431373, 0.0549019608, 0.3803921568627451, 0.9529411765, 0.0156862745,\r\n      0.0549019608, 0.3843137254901961, 0.9529411765, 0.0235294118, 0.0549019608,\r\n      0.38823529411764707, 0.9529411765, 0.031372549, 0.0549019608, 0.39215686274509803,\r\n      0.9529411765, 0.0352941176, 0.0549019608, 0.396078431372549, 0.9529411765, 0.0431372549,\r\n      0.0549019608, 0.4, 0.9529411765, 0.0509803922, 0.0549019608, 0.403921568627451, 0.9529411765,\r\n      0.0588235294, 0.0549019608, 0.40784313725490196, 0.9529411765, 0.062745098, 0.0549019608,\r\n      0.4117647058823529, 0.9529411765, 0.0705882353, 0.0549019608, 0.41568627450980394,\r\n      0.9529411765, 0.0784313725, 0.0509803922, 0.4196078431372549, 0.9529411765, 0.0862745098,\r\n      0.0509803922, 0.4235294117647059, 0.9568627451, 0.0941176471, 0.0509803922,\r\n      0.42745098039215684, 0.9568627451, 0.0980392157, 0.0509803922, 0.43137254901960786,\r\n      0.9568627451, 0.1058823529, 0.0509803922, 0.43529411764705883, 0.9568627451, 0.1137254902,\r\n      0.0509803922, 0.4392156862745098, 0.9568627451, 0.1215686275, 0.0509803922,\r\n      0.44313725490196076, 0.9568627451, 0.1254901961, 0.0509803922, 0.4470588235294118,\r\n      0.9568627451, 0.1333333333, 0.0509803922, 0.45098039215686275, 0.9568627451, 0.1411764706,\r\n      0.0509803922, 0.4549019607843137, 0.9568627451, 0.1490196078, 0.0470588235,\r\n      0.4588235294117647, 0.9568627451, 0.1568627451, 0.0470588235, 0.4627450980392157,\r\n      0.9568627451, 0.1607843137, 0.0470588235, 0.4666666666666667, 0.9568627451, 0.168627451,\r\n      0.0470588235, 0.4705882352941177, 0.9607843137, 0.1764705882, 0.0470588235,\r\n      0.4745098039215686, 0.9607843137, 0.1843137255, 0.0470588235, 0.4784313725490197,\r\n      0.9607843137, 0.1882352941, 0.0470588235, 0.48235294117647065, 0.9607843137, 0.1960784314,\r\n      0.0470588235, 0.48627450980392156, 0.9607843137, 0.2039215686, 0.0470588235,\r\n      0.49019607843137253, 0.9607843137, 0.2117647059, 0.0470588235, 0.49411764705882355,\r\n      0.9607843137, 0.2196078431, 0.0431372549, 0.4980392156862745, 0.9607843137, 0.2235294118,\r\n      0.0431372549, 0.5019607843137255, 0.9607843137, 0.231372549, 0.0431372549, 0.5058823529411764,\r\n      0.9607843137, 0.2392156863, 0.0431372549, 0.5098039215686274, 0.9607843137, 0.2470588235,\r\n      0.0431372549, 0.5137254901960784, 0.9607843137, 0.2509803922, 0.0431372549,\r\n      0.5176470588235295, 0.9647058824, 0.2549019608, 0.0431372549, 0.5215686274509804,\r\n      0.9647058824, 0.262745098, 0.0431372549, 0.5254901960784314, 0.9647058824, 0.2705882353,\r\n      0.0431372549, 0.5294117647058824, 0.9647058824, 0.2745098039, 0.0431372549,\r\n      0.5333333333333333, 0.9647058824, 0.2823529412, 0.0392156863, 0.5372549019607843,\r\n      0.9647058824, 0.2901960784, 0.0392156863, 0.5411764705882353, 0.9647058824, 0.2980392157,\r\n      0.0392156863, 0.5450980392156862, 0.9647058824, 0.3058823529, 0.0392156863,\r\n      0.5490196078431373, 0.9647058824, 0.3098039216, 0.0392156863, 0.5529411764705883,\r\n      0.9647058824, 0.3176470588, 0.0392156863, 0.5568627450980392, 0.9647058824, 0.3254901961,\r\n      0.0392156863, 0.5607843137254902, 0.9647058824, 0.3333333333, 0.0392156863,\r\n      0.5647058823529412, 0.9647058824, 0.337254902, 0.0392156863, 0.5686274509803921, 0.968627451,\r\n      0.3450980392, 0.0392156863, 0.5725490196078431, 0.968627451, 0.3529411765, 0.0352941176,\r\n      0.5764705882352941, 0.968627451, 0.3607843137, 0.0352941176, 0.5803921568627451, 0.968627451,\r\n      0.368627451, 0.0352941176, 0.5843137254901961, 0.968627451, 0.3725490196, 0.0352941176,\r\n      0.5882352941176471, 0.968627451, 0.3803921569, 0.0352941176, 0.592156862745098, 0.968627451,\r\n      0.3882352941, 0.0352941176, 0.596078431372549, 0.968627451, 0.3960784314, 0.0352941176, 0.6,\r\n      0.968627451, 0.4, 0.0352941176, 0.6039215686274509, 0.968627451, 0.4078431373, 0.0352941176,\r\n      0.6078431372549019, 0.968627451, 0.4156862745, 0.0352941176, 0.611764705882353, 0.968627451,\r\n      0.4235294118, 0.031372549, 0.615686274509804, 0.9725490196, 0.431372549, 0.031372549,\r\n      0.6196078431372549, 0.9725490196, 0.4352941176, 0.031372549, 0.6235294117647059, 0.9725490196,\r\n      0.4431372549, 0.031372549, 0.6274509803921569, 0.9725490196, 0.4509803922, 0.031372549,\r\n      0.6313725490196078, 0.9725490196, 0.4588235294, 0.031372549, 0.6352941176470588, 0.9725490196,\r\n      0.462745098, 0.031372549, 0.6392156862745098, 0.9725490196, 0.4705882353, 0.031372549,\r\n      0.6431372549019608, 0.9725490196, 0.4784313725, 0.031372549, 0.6470588235294118, 0.9725490196,\r\n      0.4862745098, 0.031372549, 0.6509803921568628, 0.9725490196, 0.4941176471, 0.0274509804,\r\n      0.6549019607843137, 0.9725490196, 0.4980392157, 0.0274509804, 0.6588235294117647,\r\n      0.9725490196, 0.5058823529, 0.0274509804, 0.6627450980392157, 0.9764705882, 0.5137254902,\r\n      0.0274509804, 0.6666666666666666, 0.9764705882, 0.5215686275, 0.0274509804,\r\n      0.6705882352941176, 0.9764705882, 0.5254901961, 0.0274509804, 0.6745098039215687,\r\n      0.9764705882, 0.5333333333, 0.0274509804, 0.6784313725490196, 0.9764705882, 0.5411764706,\r\n      0.0274509804, 0.6823529411764706, 0.9764705882, 0.5490196078, 0.0274509804,\r\n      0.6862745098039216, 0.9764705882, 0.5529411765, 0.0274509804, 0.6901960784313725,\r\n      0.9764705882, 0.5607843137, 0.0235294118, 0.6941176470588235, 0.9764705882, 0.568627451,\r\n      0.0235294118, 0.6980392156862745, 0.9764705882, 0.5764705882, 0.0235294118,\r\n      0.7019607843137254, 0.9764705882, 0.5843137255, 0.0235294118, 0.7058823529411765,\r\n      0.9764705882, 0.5882352941, 0.0235294118, 0.7098039215686275, 0.9764705882, 0.5960784314,\r\n      0.0235294118, 0.7137254901960784, 0.9803921569, 0.6039215686, 0.0235294118,\r\n      0.7176470588235294, 0.9803921569, 0.6117647059, 0.0235294118, 0.7215686274509804,\r\n      0.9803921569, 0.6156862745, 0.0235294118, 0.7254901960784313, 0.9803921569, 0.6235294118,\r\n      0.0235294118, 0.7294117647058823, 0.9803921569, 0.631372549, 0.0196078431, 0.7333333333333333,\r\n      0.9803921569, 0.6392156863, 0.0196078431, 0.7372549019607844, 0.9803921569, 0.6470588235,\r\n      0.0196078431, 0.7411764705882353, 0.9803921569, 0.6509803922, 0.0196078431,\r\n      0.7450980392156863, 0.9803921569, 0.6588235294, 0.0196078431, 0.7490196078431373,\r\n      0.9803921569, 0.6666666667, 0.0196078431, 0.7529411764705882, 0.9803921569, 0.6745098039,\r\n      0.0196078431, 0.7568627450980392, 0.9803921569, 0.6784313725, 0.0196078431,\r\n      0.7607843137254902, 0.9843137255, 0.6862745098, 0.0196078431, 0.7647058823529411,\r\n      0.9843137255, 0.6941176471, 0.0196078431, 0.7686274509803922, 0.9843137255, 0.7019607843,\r\n      0.0156862745, 0.7725490196078432, 0.9843137255, 0.7098039216, 0.0156862745,\r\n      0.7764705882352941, 0.9843137255, 0.7137254902, 0.0156862745, 0.7803921568627451,\r\n      0.9843137255, 0.7215686275, 0.0156862745, 0.7843137254901961, 0.9843137255, 0.7294117647,\r\n      0.0156862745, 0.788235294117647, 0.9843137255, 0.737254902, 0.0156862745, 0.792156862745098,\r\n      0.9843137255, 0.7411764706, 0.0156862745, 0.796078431372549, 0.9843137255, 0.7490196078,\r\n      0.0156862745, 0.8, 0.9843137255, 0.7529411765, 0.0156862745, 0.803921568627451, 0.9843137255,\r\n      0.7607843137, 0.0156862745, 0.807843137254902, 0.9882352941, 0.768627451, 0.0156862745,\r\n      0.8117647058823529, 0.9882352941, 0.768627451, 0.0156862745, 0.8156862745098039, 0.9843137255,\r\n      0.7843137255, 0.0117647059, 0.8196078431372549, 0.9843137255, 0.8, 0.0117647059,\r\n      0.8235294117647058, 0.9843137255, 0.8156862745, 0.0117647059, 0.8274509803921568,\r\n      0.9803921569, 0.831372549, 0.0117647059, 0.8313725490196079, 0.9803921569, 0.8431372549,\r\n      0.0117647059, 0.8352941176470589, 0.9803921569, 0.8588235294, 0.0078431373,\r\n      0.8392156862745098, 0.9803921569, 0.8745098039, 0.0078431373, 0.8431372549019608,\r\n      0.9764705882, 0.8901960784, 0.0078431373, 0.8470588235294118, 0.9764705882, 0.9058823529,\r\n      0.0078431373, 0.8509803921568627, 0.9764705882, 0.9176470588, 0.0078431373,\r\n      0.8549019607843137, 0.9764705882, 0.9333333333, 0.0039215686, 0.8588235294117647,\r\n      0.9725490196, 0.9490196078, 0.0039215686, 0.8627450980392157, 0.9725490196, 0.9647058824,\r\n      0.0039215686, 0.8666666666666667, 0.9725490196, 0.9803921569, 0.0039215686,\r\n      0.8705882352941177, 0.9725490196, 0.9960784314, 0.0039215686, 0.8745098039215686,\r\n      0.9725490196, 0.9960784314, 0.0039215686, 0.8784313725490196, 0.9725490196, 0.9960784314,\r\n      0.0352941176, 0.8823529411764706, 0.9725490196, 0.9960784314, 0.0666666667,\r\n      0.8862745098039215, 0.9725490196, 0.9960784314, 0.0980392157, 0.8901960784313725,\r\n      0.9725490196, 0.9960784314, 0.1294117647, 0.8941176470588236, 0.9725490196, 0.9960784314,\r\n      0.1647058824, 0.8980392156862745, 0.9764705882, 0.9960784314, 0.1960784314,\r\n      0.9019607843137255, 0.9764705882, 0.9960784314, 0.2274509804, 0.9058823529411765,\r\n      0.9764705882, 0.9960784314, 0.2549019608, 0.9098039215686274, 0.9764705882, 0.9960784314,\r\n      0.2901960784, 0.9137254901960784, 0.9764705882, 0.9960784314, 0.3215686275,\r\n      0.9176470588235294, 0.9803921569, 0.9960784314, 0.3529411765, 0.9215686274509803,\r\n      0.9803921569, 0.9960784314, 0.3843137255, 0.9254901960784314, 0.9803921569, 0.9960784314,\r\n      0.4156862745, 0.9294117647058824, 0.9803921569, 0.9960784314, 0.4509803922,\r\n      0.9333333333333333, 0.9803921569, 0.9960784314, 0.4823529412, 0.9372549019607843,\r\n      0.9843137255, 0.9960784314, 0.5137254902, 0.9411764705882354, 0.9843137255, 0.9960784314,\r\n      0.5450980392, 0.9450980392156864, 0.9843137255, 0.9960784314, 0.5803921569,\r\n      0.9490196078431372, 0.9843137255, 0.9960784314, 0.6117647059, 0.9529411764705882,\r\n      0.9843137255, 0.9960784314, 0.6431372549, 0.9568627450980394, 0.9882352941, 0.9960784314,\r\n      0.6745098039, 0.9607843137254903, 0.9882352941, 0.9960784314, 0.7058823529,\r\n      0.9647058823529413, 0.9882352941, 0.9960784314, 0.7411764706, 0.9686274509803922,\r\n      0.9882352941, 0.9960784314, 0.768627451, 0.9725490196078431, 0.9882352941, 0.9960784314, 0.8,\r\n      0.9764705882352941, 0.9921568627, 0.9960784314, 0.831372549, 0.9803921568627451, 0.9921568627,\r\n      0.9960784314, 0.8666666667, 0.984313725490196, 0.9921568627, 0.9960784314, 0.8980392157,\r\n      0.9882352941176471, 0.9921568627, 0.9960784314, 0.9294117647, 0.9921568627450981,\r\n      0.9921568627, 0.9960784314, 0.9607843137, 0.996078431372549, 0.9960784314, 0.9960784314,\r\n      0.9607843137, 1.0, 0.9960784314, 0.9960784314, 0.9607843137,\r\n    ],\r\n    description: 'Siemens',\r\n  },\r\n];\r\n\r\nexport { colormaps };\r\n","import { imageLoader } from '@cornerstonejs/core';\r\nimport dicomImageLoader from '@cornerstonejs/dicom-image-loader';\r\nimport { api } from 'dicomweb-client';\r\nimport { DICOMWeb, errorHandler } from '@ohif/core';\r\n\r\nconst getImageId = imageObj => {\r\n  if (!imageObj) {\r\n    return;\r\n  }\r\n\r\n  return typeof imageObj.getImageId === 'function' ? imageObj.getImageId() : imageObj.url;\r\n};\r\n\r\nconst findImageIdOnStudies = (studies, displaySetInstanceUID) => {\r\n  const study = studies.find(study => {\r\n    const displaySet = study.displaySets.some(\r\n      displaySet => displaySet.displaySetInstanceUID === displaySetInstanceUID\r\n    );\r\n    return displaySet;\r\n  });\r\n  const { series = [] } = study;\r\n  const { instances = [] } = series[0] || {};\r\n  const instance = instances[0];\r\n\r\n  return getImageId(instance);\r\n};\r\n\r\nconst someInvalidStrings = strings => {\r\n  const stringsArray = Array.isArray(strings) ? strings : [strings];\r\n  const emptyString = string => !string;\r\n  let invalid = stringsArray.some(emptyString);\r\n  return invalid;\r\n};\r\n\r\nconst getImageInstance = dataset => {\r\n  return dataset && dataset.images && dataset.images[0];\r\n};\r\n\r\nconst getNonImageInstance = dataset => {\r\n  return dataset && dataset.instance;\r\n};\r\n\r\nconst getImageInstanceId = imageInstance => {\r\n  return getImageId(imageInstance);\r\n};\r\n\r\nconst fetchIt = (url, headers = DICOMWeb.getAuthorizationHeader()) => {\r\n  return fetch(url, headers).then(response => response.arrayBuffer());\r\n};\r\n\r\nconst cornerstoneRetriever = imageId => {\r\n  return imageLoader.loadAndCacheImage(imageId).then(image => {\r\n    return image && image.data && image.data.byteArray.buffer;\r\n  });\r\n};\r\n\r\nconst wadorsRetriever = (\r\n  url,\r\n  studyInstanceUID,\r\n  seriesInstanceUID,\r\n  sopInstanceUID,\r\n  headers = DICOMWeb.getAuthorizationHeader(),\r\n  errorInterceptor = errorHandler.getHTTPErrorHandler()\r\n) => {\r\n  const config = {\r\n    url,\r\n    headers,\r\n    errorInterceptor,\r\n  };\r\n  const dicomWeb = new api.DICOMwebClient(config);\r\n\r\n  return dicomWeb.retrieveInstance({\r\n    studyInstanceUID,\r\n    seriesInstanceUID,\r\n    sopInstanceUID,\r\n  });\r\n};\r\n\r\nconst getImageLoaderType = imageId => {\r\n  const loaderRegExp = /^\\w+\\:/;\r\n  const loaderType = loaderRegExp.exec(imageId);\r\n\r\n  return (\r\n    (loaderRegExp.lastIndex === 0 &&\r\n      loaderType &&\r\n      loaderType[0] &&\r\n      loaderType[0].replace(':', '')) ||\r\n    ''\r\n  );\r\n};\r\n\r\nclass DicomLoaderService {\r\n  getLocalData(dataset, studies) {\r\n    // Use referenced imageInstance\r\n    const imageInstance = getImageInstance(dataset);\r\n    const nonImageInstance = getNonImageInstance(dataset);\r\n\r\n    if (\r\n      (!imageInstance && !nonImageInstance) ||\r\n      !nonImageInstance.imageId?.startsWith('dicomfile')\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    const instance = imageInstance || nonImageInstance;\r\n\r\n    let imageId = getImageInstanceId(instance);\r\n\r\n    // or Try to get it from studies\r\n    if (someInvalidStrings(imageId)) {\r\n      imageId = findImageIdOnStudies(studies, dataset.displaySetInstanceUID);\r\n    }\r\n\r\n    if (!someInvalidStrings(imageId)) {\r\n      return dicomImageLoader.wadouri.loadFileRequest(imageId);\r\n    }\r\n  }\r\n\r\n  getDataByImageType(dataset) {\r\n    const imageInstance = getImageInstance(dataset);\r\n\r\n    if (imageInstance) {\r\n      const imageId = getImageInstanceId(imageInstance);\r\n      let getDicomDataMethod = fetchIt;\r\n      const loaderType = getImageLoaderType(imageId);\r\n\r\n      switch (loaderType) {\r\n        case 'dicomfile':\r\n          getDicomDataMethod = cornerstoneRetriever.bind(this, imageId);\r\n          break;\r\n        case 'wadors':\r\n          const url = imageInstance.getData().wadoRoot;\r\n          const studyInstanceUID = imageInstance.getStudyInstanceUID();\r\n          const seriesInstanceUID = imageInstance.getSeriesInstanceUID();\r\n          const sopInstanceUID = imageInstance.getSOPInstanceUID();\r\n          const invalidParams = someInvalidStrings([\r\n            url,\r\n            studyInstanceUID,\r\n            seriesInstanceUID,\r\n            sopInstanceUID,\r\n          ]);\r\n          if (invalidParams) {\r\n            return;\r\n          }\r\n\r\n          getDicomDataMethod = wadorsRetriever.bind(\r\n            this,\r\n            url,\r\n            studyInstanceUID,\r\n            seriesInstanceUID,\r\n            sopInstanceUID\r\n          );\r\n          break;\r\n        case 'wadouri':\r\n          // Strip out the image loader specifier\r\n          imageId = imageId.substring(imageId.indexOf(':') + 1);\r\n\r\n          if (someInvalidStrings(imageId)) {\r\n            return;\r\n          }\r\n          getDicomDataMethod = fetchIt.bind(this, imageId);\r\n          break;\r\n        default:\r\n          return;\r\n      }\r\n\r\n      return getDicomDataMethod();\r\n    }\r\n  }\r\n\r\n  getDataByDatasetType(dataset) {\r\n    const {\r\n      StudyInstanceUID,\r\n      SeriesInstanceUID,\r\n      SOPInstanceUID,\r\n      authorizationHeaders,\r\n      wadoRoot,\r\n      wadoUri,\r\n      instance,\r\n    } = dataset;\r\n    // Retrieve wadors or just try to fetch wadouri\r\n    if (!someInvalidStrings(wadoRoot)) {\r\n      return wadorsRetriever(\r\n        wadoRoot,\r\n        StudyInstanceUID,\r\n        SeriesInstanceUID,\r\n        SOPInstanceUID,\r\n        authorizationHeaders\r\n      );\r\n    } else if (!someInvalidStrings(wadoUri)) {\r\n      return fetchIt(wadoUri, { headers: authorizationHeaders });\r\n    } else if (!someInvalidStrings(instance?.url)) {\r\n      // make sure the url is absolute, remove the scope\r\n      // from it if it is not absolute. For instance it might be dicomweb:http://....\r\n      // and we need to remove the dicomweb: part\r\n      const url = instance.url;\r\n      const absoluteUrl = url.startsWith('http') ? url : url.substring(url.indexOf(':') + 1);\r\n      return fetchIt(absoluteUrl, { headers: authorizationHeaders });\r\n    }\r\n  }\r\n\r\n  *getLoaderIterator(dataset, studies, headers) {\r\n    yield this.getLocalData(dataset, studies);\r\n    yield this.getDataByImageType(dataset);\r\n    yield this.getDataByDatasetType(dataset);\r\n  }\r\n\r\n  findDicomDataPromise(dataset, studies, headers) {\r\n    dataset.authorizationHeaders = headers;\r\n    const loaderIterator = this.getLoaderIterator(dataset, studies);\r\n    // it returns first valid retriever method.\r\n    for (const loader of loaderIterator) {\r\n      if (loader) {\r\n        return loader;\r\n      }\r\n    }\r\n\r\n    // in case of no valid loader\r\n    throw new Error('Invalid dicom data loader');\r\n  }\r\n}\r\n\r\nconst dicomLoaderService = new DicomLoaderService();\r\n\r\nexport default dicomLoaderService;\r\n","/**\r\n * Finds tool nearby event position triggered.\r\n *\r\n * @param {Object} commandsManager mannager of commands\r\n * @param {Object} event that has being triggered\r\n * @returns cs toolData or undefined if not found.\r\n */\r\nexport const findNearbyToolData = (commandsManager, evt) => {\r\n  if (!evt?.detail) {\r\n    return;\r\n  }\r\n  const { element, currentPoints } = evt.detail;\r\n  return commandsManager.runCommand(\r\n    'getNearbyAnnotation',\r\n    {\r\n      element,\r\n      canvasCoordinates: currentPoints?.canvas,\r\n    },\r\n    'CORNERSTONE'\r\n  );\r\n};\r\n","export function generateSegmentationCSVReport(\r\n  segmentationData,\r\n  info: {\r\n    reference: {\r\n      SeriesNumber: string;\r\n      SeriesInstanceUID: string;\r\n      StudyInstanceUID: string;\r\n      SeriesDate: string;\r\n      SeriesTime: string;\r\n      SeriesDescription: string;\r\n    };\r\n  }\r\n) {\r\n  // Initialize the rows for our CSV\r\n  const csvRows = [];\r\n\r\n  // Add segmentation-level information\r\n  csvRows.push(['Segmentation ID', segmentationData.segmentationId || '']);\r\n  csvRows.push(['Segmentation Label', segmentationData.label || '']);\r\n\r\n  csvRows.push([]);\r\n\r\n  const additionalInfo = info.reference;\r\n  // Add reference information\r\n  const referenceKeys = [\r\n    ['Series Number', additionalInfo.SeriesNumber],\r\n    ['Series Instance UID', additionalInfo.SeriesInstanceUID],\r\n    ['Study Instance UID', additionalInfo.StudyInstanceUID],\r\n    ['Series Date', additionalInfo.SeriesDate],\r\n    ['Series Time', additionalInfo.SeriesTime],\r\n    ['Series Description', additionalInfo.SeriesDescription],\r\n  ];\r\n\r\n  referenceKeys.forEach(([key, value]) => {\r\n    if (value) {\r\n      csvRows.push([`reference ${key}`, value]);\r\n    }\r\n  });\r\n\r\n  // Add a blank row for separation\r\n  csvRows.push([]);\r\n\r\n  csvRows.push(['Segments Statistics']);\r\n\r\n  // Add segment information in columns\r\n  if (segmentationData.segments) {\r\n    // First row: Segment headers\r\n    const segmentHeaderRow = ['Label'];\r\n    for (const segmentId in segmentationData.segments) {\r\n      const segment = segmentationData.segments[segmentId];\r\n      segmentHeaderRow.push(`${segment.label || ''}`);\r\n    }\r\n    csvRows.push(segmentHeaderRow);\r\n\r\n    // Add segment properties\r\n    csvRows.push([\r\n      'Segment Index',\r\n      ...Object.values(segmentationData.segments).map(s => s.segmentIndex || ''),\r\n    ]);\r\n    csvRows.push([\r\n      'Locked',\r\n      ...Object.values(segmentationData.segments).map(s => (s.locked ? 'Yes' : 'No')),\r\n    ]);\r\n    csvRows.push([\r\n      'Active',\r\n      ...Object.values(segmentationData.segments).map(s => (s.active ? 'Yes' : 'No')),\r\n    ]);\r\n\r\n    // Add segment statistics\r\n    // First, collect all unique statistics across all segments\r\n    const allStats = new Set();\r\n    for (const segment of Object.values(segmentationData.segments)) {\r\n      if (segment.cachedStats && segment.cachedStats.namedStats) {\r\n        for (const statKey in segment.cachedStats.namedStats) {\r\n          const stat = segment.cachedStats.namedStats[statKey];\r\n          const statLabel = stat.label || stat.name;\r\n          const statUnit = stat.unit ? ` (${stat.unit})` : '';\r\n          allStats.add(`${statLabel}${statUnit}`);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Then create a row for each statistic\r\n    for (const statName of allStats) {\r\n      const statRow = [statName];\r\n\r\n      for (const segment of Object.values(segmentationData.segments)) {\r\n        let statValue = '';\r\n\r\n        if (segment.cachedStats && segment.cachedStats.namedStats) {\r\n          for (const statKey in segment.cachedStats.namedStats) {\r\n            const stat = segment.cachedStats.namedStats[statKey];\r\n            const currentStatName = `${stat.label || stat.name}${stat.unit ? ` (${stat.unit})` : ''}`;\r\n\r\n            if (currentStatName === statName) {\r\n              statValue = stat.value !== undefined ? stat.value : '';\r\n              break;\r\n            }\r\n          }\r\n        }\r\n\r\n        statRow.push(statValue);\r\n      }\r\n\r\n      csvRows.push(statRow);\r\n    }\r\n  }\r\n\r\n  // Convert to CSV string\r\n  let csvString = '';\r\n  for (const row of csvRows) {\r\n    const formattedRow = row.map(cell => {\r\n      // Handle values that need to be quoted (contain commas, quotes, or newlines)\r\n      const cellValue = cell !== undefined && cell !== null ? cell.toString() : '';\r\n      if (cellValue.includes(',') || cellValue.includes('\"') || cellValue.includes('\\n')) {\r\n        // Escape quotes and wrap in quotes\r\n        return '\"' + cellValue.replace(/\"/g, '\"\"') + '\"';\r\n      }\r\n      return cellValue;\r\n    });\r\n    csvString += formattedRow.join(',') + '\\n';\r\n  }\r\n\r\n  // Create a download link and trigger the download\r\n  const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });\r\n  const url = URL.createObjectURL(blob);\r\n  const link = document.createElement('a');\r\n\r\n  link.setAttribute('href', url);\r\n  link.setAttribute(\r\n    'download',\r\n    `${segmentationData.label || 'Segmentation'}_Report_${new Date().toISOString().split('T')[0]}.csv`\r\n  );\r\n  link.style.visibility = 'hidden';\r\n\r\n  document.body.appendChild(link);\r\n  link.click();\r\n  document.body.removeChild(link);\r\n}\r\n","import { getEnabledElement } from '@cornerstonejs/core';\r\nimport { IEnabledElement } from '@cornerstonejs/core/types';\r\n\r\nimport { getEnabledElement as OHIFgetEnabledElement } from '../state';\r\n\r\nexport default function getActiveViewportEnabledElement(viewportGridService): IEnabledElement {\r\n  const { activeViewportId } = viewportGridService.getState();\r\n  const { element } = OHIFgetEnabledElement(activeViewportId) || {};\r\n  const enabledElement = getEnabledElement(element);\r\n  return enabledElement;\r\n}\r\n","import { Enums } from '@cornerstonejs/core';\r\n\r\nconst MIP = 'mip';\r\nconst MINIP = 'minip';\r\nconst AVG = 'avg';\r\n\r\nexport default function getCornerstoneBlendMode(blendMode: string): Enums.BlendModes {\r\n  if (!blendMode) {\r\n    return Enums.BlendModes.COMPOSITE;\r\n  }\r\n\r\n  if (blendMode.toLowerCase() === MIP) {\r\n    return Enums.BlendModes.MAXIMUM_INTENSITY_BLEND;\r\n  }\r\n\r\n  if (blendMode.toLowerCase() === MINIP) {\r\n    return Enums.BlendModes.MINIMUM_INTENSITY_BLEND;\r\n  }\r\n\r\n  if (blendMode.toLowerCase() === AVG) {\r\n    return Enums.BlendModes.AVERAGE_INTENSITY_BLEND;\r\n  }\r\n\r\n  throw new Error(`Unsupported blend mode: ${blendMode}`);\r\n}\r\n","import { Enums } from '@cornerstonejs/core';\r\n\r\nconst AXIAL = 'axial';\r\nconst SAGITTAL = 'sagittal';\r\nconst CORONAL = 'coronal';\r\n\r\nexport default function getCornerstoneOrientation(orientation: string): Enums.OrientationAxis {\r\n  if (orientation) {\r\n    switch (orientation.toLowerCase()) {\r\n      case AXIAL:\r\n        return Enums.OrientationAxis.AXIAL;\r\n      case SAGITTAL:\r\n        return Enums.OrientationAxis.SAGITTAL;\r\n      case CORONAL:\r\n        return Enums.OrientationAxis.CORONAL;\r\n      default:\r\n        return Enums.OrientationAxis.ACQUISITION;\r\n    }\r\n  }\r\n\r\n  return Enums.OrientationAxis.ACQUISITION;\r\n}\r\n","import type { Types } from '@ohif/core';\r\nimport { Enums } from '@cornerstonejs/core';\r\n\r\nconst STACK = 'stack';\r\nconst VOLUME = 'volume';\r\nconst ORTHOGRAPHIC = 'orthographic';\r\nconst VOLUME_3D = 'volume3d';\r\nconst VIDEO = 'video';\r\nconst WHOLESLIDE = 'wholeslide';\r\n\r\nexport default function getCornerstoneViewportType(\r\n  viewportType: string,\r\n  displaySets?: Types.DisplaySet[]\r\n): Enums.ViewportType {\r\n  const lowerViewportType =\r\n    displaySets?.[0]?.viewportType?.toLowerCase() || viewportType.toLowerCase();\r\n  if (lowerViewportType === STACK) {\r\n    return Enums.ViewportType.STACK;\r\n  }\r\n\r\n  if (lowerViewportType === VIDEO) {\r\n    return Enums.ViewportType.VIDEO;\r\n  }\r\n  if (lowerViewportType === WHOLESLIDE) {\r\n    return Enums.ViewportType.WHOLE_SLIDE;\r\n  }\r\n\r\n  if (lowerViewportType === VOLUME || lowerViewportType === ORTHOGRAPHIC) {\r\n    return Enums.ViewportType.ORTHOGRAPHIC;\r\n  }\r\n\r\n  if (lowerViewportType === VOLUME_3D) {\r\n    return Enums.ViewportType.VOLUME_3D;\r\n  }\r\n\r\n  throw new Error(\r\n    `Invalid viewport type: ${viewportType}. Valid types are: stack, volume, video, wholeslide`\r\n  );\r\n}\r\n","export default function getInterleavedFrames(imageIds) {\r\n  const minImageIdIndex = 0;\r\n  const maxImageIdIndex = imageIds.length - 1;\r\n\r\n  const middleImageIdIndex = Math.floor(imageIds.length / 2);\r\n\r\n  let lowerImageIdIndex = middleImageIdIndex;\r\n  let upperImageIdIndex = middleImageIdIndex;\r\n\r\n  // Build up an array of images to prefetch, starting with the current image.\r\n  const imageIdsToPrefetch = [\r\n    { imageId: imageIds[middleImageIdIndex], imageIdIndex: middleImageIdIndex },\r\n  ];\r\n\r\n  const prefetchQueuedFilled = {\r\n    currentPositionDownToMinimum: false,\r\n    currentPositionUpToMaximum: false,\r\n  };\r\n\r\n  // Check if on edges and some criteria is already fulfilled\r\n\r\n  if (middleImageIdIndex === minImageIdIndex) {\r\n    prefetchQueuedFilled.currentPositionDownToMinimum = true;\r\n  } else if (middleImageIdIndex === maxImageIdIndex) {\r\n    prefetchQueuedFilled.currentPositionUpToMaximum = true;\r\n  }\r\n\r\n  while (\r\n    !prefetchQueuedFilled.currentPositionDownToMinimum ||\r\n    !prefetchQueuedFilled.currentPositionUpToMaximum\r\n  ) {\r\n    if (!prefetchQueuedFilled.currentPositionDownToMinimum) {\r\n      // Add imageId below\r\n      lowerImageIdIndex--;\r\n      imageIdsToPrefetch.push({\r\n        imageId: imageIds[lowerImageIdIndex],\r\n        imageIdIndex: lowerImageIdIndex,\r\n      });\r\n\r\n      if (lowerImageIdIndex === minImageIdIndex) {\r\n        prefetchQueuedFilled.currentPositionDownToMinimum = true;\r\n      }\r\n    }\r\n\r\n    if (!prefetchQueuedFilled.currentPositionUpToMaximum) {\r\n      // Add imageId above\r\n      upperImageIdIndex++;\r\n      imageIdsToPrefetch.push({\r\n        imageId: imageIds[upperImageIdIndex],\r\n        imageIdIndex: upperImageIdIndex,\r\n      });\r\n\r\n      if (upperImageIdIndex === maxImageIdIndex) {\r\n        prefetchQueuedFilled.currentPositionUpToMaximum = true;\r\n      }\r\n    }\r\n  }\r\n\r\n  return imageIdsToPrefetch;\r\n}\r\n","/**\r\n * Returns a re-ordered array consisting of, in order:\r\n *    1. First few objects\r\n *    2. Center objects\r\n *    3. Last few objects\r\n *    4. nth Objects (n=7), set 2\r\n *    5. nth Objects set 5,\r\n *    6. Remaining objects\r\n * What this does is return the first/center/start objects, as those\r\n * are often used first, then a selection of objects scattered over the\r\n * instances in order to allow making requests over a set of image instances.\r\n *\r\n * @param {[]} imageIds\r\n * @returns [] reordered to be an nth selection\r\n */\r\nexport default function getNthFrames(imageIds) {\r\n  const frames = [[], [], [], [], []];\r\n  const centerStart = imageIds.length / 2 - 3;\r\n  const centerEnd = centerStart + 6;\r\n\r\n  for (let i = 0; i < imageIds.length; i++) {\r\n    if (i < 2 || i > imageIds.length - 4 || (i > centerStart && i < centerEnd)) {\r\n      frames[0].push(imageIds[i]);\r\n    } else if (i % 7 === 2) {\r\n      frames[1].push(imageIds[i]);\r\n    } else if (i % 7 === 5) {\r\n      frames[2].push(imageIds[i]);\r\n    } else {\r\n      frames[(i % 2) + 3].push(imageIds[i]);\r\n    }\r\n  }\r\n  const ret = [...frames[0], ...frames[1], ...frames[2], ...frames[3], ...frames[4]];\r\n  return ret;\r\n}\r\n","import { CONSTANTS, utilities } from '@cornerstonejs/core';\r\n\r\nconst { MPR_CAMERA_VALUES } = CONSTANTS;\r\n\r\n/**\r\n * Determines the viewport orientation (axial, sagittal, or coronal) based on the image orientation patient values.\r\n * This is done by comparing the view vectors with predefined MPR camera values.\r\n *\r\n * @param imageOrientationPatient - Array of 6 numbers representing the image orientation patient values.\r\n * The first 3 numbers represent the direction cosines of the first row and the second 3 numbers\r\n * represent the direction cosines of the first column.\r\n *\r\n * @returns The viewport orientation as a string ('axial', 'sagittal', 'coronal') or undefined if\r\n * the orientation cannot be determined or if the input is invalid.\r\n *\r\n * @example\r\n * ```typescript\r\n * const orientation = getViewportOrientationFromImageOrientationPatient([1,0,0,0,1,0]);\r\n * console.debug(orientation); // 'axial'\r\n * ```\r\n */\r\nexport const getViewportOrientationFromImageOrientationPatient = (\r\n  imageOrientationPatient: number[]\r\n): string | undefined => {\r\n  if (!imageOrientationPatient || imageOrientationPatient.length !== 6) {\r\n    return undefined;\r\n  }\r\n\r\n  const viewRight = imageOrientationPatient.slice(0, 3);\r\n  const viewDown = imageOrientationPatient.slice(3, 6);\r\n  const viewUp = [-viewDown[0], -viewDown[1], -viewDown[2]];\r\n\r\n  // Compare vectors with MPR camera values using utilities.isEqual\r\n  if (\r\n    utilities.isEqual(viewRight, MPR_CAMERA_VALUES.axial.viewRight) &&\r\n    utilities.isEqual(viewUp, MPR_CAMERA_VALUES.axial.viewUp)\r\n  ) {\r\n    return 'axial';\r\n  }\r\n\r\n  if (\r\n    utilities.isEqual(viewRight, MPR_CAMERA_VALUES.sagittal.viewRight) &&\r\n    utilities.isEqual(viewUp, MPR_CAMERA_VALUES.sagittal.viewUp)\r\n  ) {\r\n    return 'sagittal';\r\n  }\r\n\r\n  if (\r\n    utilities.isEqual(viewRight, MPR_CAMERA_VALUES.coronal.viewRight) &&\r\n    utilities.isEqual(viewUp, MPR_CAMERA_VALUES.coronal.viewUp)\r\n  ) {\r\n    return 'coronal';\r\n  }\r\n\r\n  return undefined;\r\n};\r\n","function getUpdatedViewportsForSegmentation({\r\n  viewportId,\r\n  servicesManager,\r\n  displaySetInstanceUIDs,\r\n}: withAppTypes) {\r\n  const { hangingProtocolService, viewportGridService } = servicesManager.services;\r\n\r\n  const { isHangingProtocolLayout } = viewportGridService.getState();\r\n\r\n  const viewport = getTargetViewport({ viewportId, viewportGridService });\r\n  const targetViewportId = viewport.viewportOptions.viewportId;\r\n\r\n  const updatedViewports = hangingProtocolService.getViewportsRequireUpdate(\r\n    targetViewportId,\r\n    displaySetInstanceUIDs[0],\r\n    isHangingProtocolLayout\r\n  );\r\n\r\n  return updatedViewports.filter(v => v.viewportOptions?.viewportType !== 'volume3d');\r\n}\r\n\r\nconst getTargetViewport = ({ viewportId, viewportGridService }) => {\r\n  const { viewports, activeViewportId } = viewportGridService.getState();\r\n  const targetViewportId = viewportId || activeViewportId;\r\n\r\n  const viewport = viewports.get(targetViewportId);\r\n\r\n  return viewport;\r\n};\r\n\r\nexport { getUpdatedViewportsForSegmentation };\r\n","import { DisplaySetService, ViewportGridService } from '@ohif/core';\r\n\r\nconst IMAGE_SLICE_SYNC_NAME = 'IMAGE_SLICE_SYNC';\r\n\r\nexport default function toggleImageSliceSync({\r\n  servicesManager,\r\n  viewports: providedViewports,\r\n  syncId,\r\n}: withAppTypes) {\r\n  const { syncGroupService, viewportGridService, displaySetService, cornerstoneViewportService } =\r\n    servicesManager.services;\r\n\r\n  syncId ||= IMAGE_SLICE_SYNC_NAME;\r\n\r\n  const viewports =\r\n    providedViewports || getReconstructableStackViewports(viewportGridService, displaySetService);\r\n\r\n  // Todo: right now we don't have a proper way to define specific\r\n  // viewports to add to synchronizers, and right now it is global or not\r\n  // after we do that, we should do fine grained control of the synchronizers\r\n  const someViewportHasSync = viewports.some(viewport => {\r\n    const syncStates = syncGroupService.getSynchronizersForViewport(\r\n      viewport.viewportOptions.viewportId\r\n    );\r\n\r\n    const imageSync = syncStates.find(syncState => syncState.id === syncId);\r\n\r\n    return !!imageSync;\r\n  });\r\n\r\n  if (someViewportHasSync) {\r\n    return disableSync(syncId, servicesManager);\r\n  }\r\n\r\n  // create synchronization group and add the viewports to it.\r\n  viewports.forEach(gridViewport => {\r\n    const { viewportId } = gridViewport.viewportOptions;\r\n    const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n    if (!viewport) {\r\n      return;\r\n    }\r\n    syncGroupService.addViewportToSyncGroup(viewportId, viewport.getRenderingEngine().id, {\r\n      type: 'imageSlice',\r\n      id: syncId,\r\n      source: true,\r\n      target: true,\r\n    });\r\n  });\r\n}\r\n\r\nfunction disableSync(syncName, servicesManager: AppTypes.ServicesManager) {\r\n  const { syncGroupService, viewportGridService, displaySetService, cornerstoneViewportService } =\r\n    servicesManager.services;\r\n  const viewports = getReconstructableStackViewports(viewportGridService, displaySetService);\r\n  viewports.forEach(gridViewport => {\r\n    const { viewportId } = gridViewport.viewportOptions;\r\n    const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n    if (!viewport) {\r\n      return;\r\n    }\r\n    syncGroupService.removeViewportFromSyncGroup(\r\n      viewport.id,\r\n      viewport.getRenderingEngine().id,\r\n      syncName\r\n    );\r\n  });\r\n}\r\n\r\n/**\r\n * Gets the consistent spacing stack viewport types, which are the ones which\r\n * can be navigated using the stack image sync right now.\r\n */\r\nfunction getReconstructableStackViewports(\r\n  viewportGridService: ViewportGridService,\r\n  displaySetService: DisplaySetService\r\n) {\r\n  let { viewports } = viewportGridService.getState();\r\n\r\n  viewports = [...viewports.values()];\r\n  // filter empty viewports\r\n  viewports = viewports.filter(\r\n    viewport => viewport.displaySetInstanceUIDs && viewport.displaySetInstanceUIDs.length\r\n  );\r\n\r\n  // filter reconstructable viewports\r\n  viewports = viewports.filter(viewport => {\r\n    const { displaySetInstanceUIDs } = viewport;\r\n\r\n    for (const displaySetInstanceUID of displaySetInstanceUIDs) {\r\n      const displaySet = displaySetService.getDisplaySetByUID(displaySetInstanceUID);\r\n\r\n      // TODO - add a better test than isReconstructable\r\n      if (displaySet && displaySet.isReconstructable) {\r\n        return true;\r\n      }\r\n\r\n      return false;\r\n    }\r\n  });\r\n  return viewports;\r\n}\r\n","import { handleSegmentChange } from './segmentUtils';\r\nimport { isReferenceViewable } from './isReferenceViewable';\r\nimport {\r\n  setupSegmentationDataModifiedHandler,\r\n  setupSegmentationModifiedHandler,\r\n} from './segmentationHandlers';\r\nimport promptHydrationDialog, {\r\n  HydrationDialogProps,\r\n  HydrationCallback,\r\n  HydrationSRResult,\r\n} from './promptHydrationDialog';\r\n\r\nconst utils = {\r\n  handleSegmentChange,\r\n  isReferenceViewable,\r\n  setupSegmentationDataModifiedHandler,\r\n  setupSegmentationModifiedHandler,\r\n  promptHydrationDialog,\r\n};\r\n\r\nexport type { HydrationDialogProps, HydrationCallback, HydrationSRResult };\r\n\r\nexport default utils;\r\n","import { log, Enums } from '@ohif/core';\r\nimport { EVENTS } from '@cornerstonejs/core';\r\n\r\nconst IMAGE_TIMING_KEYS = [];\r\n\r\nconst imageTiming = {\r\n  viewportsWaiting: 0,\r\n};\r\n\r\n/**\r\n * Defines the initial view timing reporting.\r\n * This allows knowing how many viewports are waiting for initial views and\r\n * when the IMAGE_RENDERED gets sent out.\r\n * The first image rendered will fire the FIRST_IMAGE timeEnd logs, while\r\n * the last of the enabled viewport will fire the ALL_IMAGES timeEnd logs.\r\n *\r\n */\r\n\r\nexport default function initViewTiming({ element }) {\r\n  if (!IMAGE_TIMING_KEYS.length) {\r\n    // Work around a bug in WebPack that doesn't getting the enums initialized\r\n    // quite fast enough to be declared statically.\r\n    const { TimingEnum } = Enums;\r\n\r\n    IMAGE_TIMING_KEYS.push(\r\n      TimingEnum.DISPLAY_SETS_TO_ALL_IMAGES,\r\n      TimingEnum.DISPLAY_SETS_TO_FIRST_IMAGE,\r\n      TimingEnum.STUDY_TO_FIRST_IMAGE,\r\n    );\r\n  }\r\n\r\n  if (!IMAGE_TIMING_KEYS.find(key => log.timingKeys[key])) {\r\n    return;\r\n  }\r\n  imageTiming.viewportsWaiting += 1;\r\n  element.addEventListener(EVENTS.IMAGE_RENDERED, imageRenderedListener);\r\n}\r\n\r\nfunction imageRenderedListener(evt) {\r\n  if (evt.detail.viewportStatus === 'preRender') {\r\n    return;\r\n  }\r\n  const { TimingEnum } = Enums;\r\n  log.timeEnd(TimingEnum.DISPLAY_SETS_TO_FIRST_IMAGE);\r\n  log.timeEnd(TimingEnum.STUDY_TO_FIRST_IMAGE);\r\n  log.timeEnd(TimingEnum.SCRIPT_TO_VIEW);\r\n  imageTiming.viewportsWaiting -= 1;\r\n  evt.detail.element.removeEventListener(EVENTS.IMAGE_RENDERED, imageRenderedListener);\r\n  if (!imageTiming.viewportsWaiting) {\r\n    log.timeEnd(TimingEnum.DISPLAY_SETS_TO_ALL_IMAGES);\r\n  }\r\n}\r\n","/**\r\n * Interleave the items from all the lists so that the first items are first\r\n * in the returned list, the second items are next etc.\r\n * Does this in a O(n) fashion, and return lists[0] if there is only one list.\r\n *\r\n * @param {[]} lists\r\n * @returns [] reordered to be breadth first traversal of lists\r\n */\r\nexport default function interleave(lists) {\r\n  if (!lists || !lists.length) {\r\n    return [];\r\n  }\r\n  if (lists.length === 1) {\r\n    return lists[0];\r\n  }\r\n  console.time('interleave');\r\n  const useLists = [...lists];\r\n  const ret = [];\r\n  for (let i = 0; useLists.length > 0; i++) {\r\n    for (const list of useLists) {\r\n      if (i >= list.length) {\r\n        useLists.splice(useLists.indexOf(list), 1);\r\n        continue;\r\n      }\r\n      ret.push(list[i]);\r\n    }\r\n  }\r\n  console.timeEnd('interleave');\r\n  return ret;\r\n}\r\n","import { cache, imageLoadPoolManager, Enums } from '@cornerstonejs/core';\r\nimport getInterleavedFrames from './getInterleavedFrames';\r\nimport zip from 'lodash.zip';\r\nimport compact from 'lodash.compact';\r\nimport flatten from 'lodash.flatten';\r\n\r\n// Map of volumeId and SeriesInstanceId\r\nconst volumeIdMapsToLoad = new Map<string, string>();\r\nconst viewportIdVolumeInputArrayMap = new Map<string, unknown[]>();\r\n\r\n/**\r\n * This function caches the volumeUIDs until all the volumes inside the\r\n * hanging protocol are initialized. Then it goes through the imageIds\r\n * of the volumes, and interleave them, in order for the volumes to be loaded\r\n * together from middle to the start and the end.\r\n * @param {Object} props image loading properties from Cornerstone ViewportService\r\n * @returns\r\n */\r\nexport default function interleaveCenterLoader({\r\n  data: { viewportId, volumeInputArray },\r\n  displaySetsMatchDetails,\r\n  viewportMatchDetails: matchDetails,\r\n}) {\r\n  viewportIdVolumeInputArrayMap.set(viewportId, volumeInputArray);\r\n\r\n  // Based on the volumeInputs store the volumeIds and SeriesInstanceIds\r\n  // to keep track of the volumes being loaded\r\n  for (const volumeInput of volumeInputArray) {\r\n    const { volumeId } = volumeInput;\r\n    const volume = cache.getVolume(volumeId);\r\n\r\n    if (!volume) {\r\n      return;\r\n    }\r\n\r\n    // if the volumeUID is not in the volumeUIDs array, add it\r\n    if (!volumeIdMapsToLoad.has(volumeId)) {\r\n      const { metadata } = volume;\r\n      volumeIdMapsToLoad.set(volumeId, metadata.SeriesInstanceUID);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * The following is checking if all the viewports that were matched in the HP has been\r\n   * successfully created their cornerstone viewport or not. Todo: This can be\r\n   * improved by not checking it, and as soon as the matched DisplaySets have their\r\n   * volume loaded, we start the loading, but that comes at the cost of viewports\r\n   * not being created yet (e.g., in a 10 viewport ptCT fusion, when one ct viewport and one\r\n   * pt viewport are created we have a guarantee that the volumes are created in the cache\r\n   * but the rest of the viewports (fusion, mip etc.) are not created yet. So\r\n   * we can't initiate setting the volumes for those viewports. One solution can be\r\n   * to add an event when a viewport is created (not enabled element event) and then\r\n   * listen to it and as the other viewports are created we can set the volumes for them\r\n   * since volumes are already started loading.\r\n   */\r\n  const uniqueViewportVolumeDisplaySetUIDs = new Set();\r\n  viewportIdVolumeInputArrayMap.forEach((volumeInputArray, viewportId) => {\r\n    volumeInputArray.forEach(volumeInput => {\r\n      const { volumeId } = volumeInput;\r\n      uniqueViewportVolumeDisplaySetUIDs.add(volumeId);\r\n    });\r\n  });\r\n\r\n  const uniqueMatchedDisplaySetUIDs = new Set();\r\n\r\n  matchDetails.forEach(matchDetail => {\r\n    const { displaySetsInfo } = matchDetail;\r\n    displaySetsInfo.forEach(({ displaySetInstanceUID }) => {\r\n      uniqueMatchedDisplaySetUIDs.add(displaySetInstanceUID);\r\n    });\r\n  });\r\n\r\n  if (uniqueViewportVolumeDisplaySetUIDs.size !== uniqueMatchedDisplaySetUIDs.size) {\r\n    return;\r\n  }\r\n\r\n  const volumeIds = Array.from(volumeIdMapsToLoad.keys()).slice();\r\n  // get volumes from cache\r\n  const volumes = volumeIds.map(volumeId => {\r\n    return cache.getVolume(volumeId);\r\n  });\r\n\r\n  // iterate over all volumes, and get their imageIds, and interleave\r\n  // the imageIds and save them in AllRequests for later use\r\n  const AllRequests = [];\r\n  volumes.forEach(volume => {\r\n    const requests = volume.getImageLoadRequests();\r\n\r\n    if (!requests.length || !requests[0] || !requests[0].imageId) {\r\n      return;\r\n    }\r\n\r\n    const requestImageIds = requests.map(request => {\r\n      return request.imageId;\r\n    });\r\n\r\n    const imageIds = getInterleavedFrames(requestImageIds);\r\n\r\n    const reOrderedRequests = imageIds.map(({ imageId }) => {\r\n      const request = requests.find(req => req.imageId === imageId);\r\n      return request;\r\n    });\r\n\r\n    AllRequests.push(reOrderedRequests);\r\n  });\r\n\r\n  // flatten the AllRequests array, which will result in a list of all the\r\n  // imageIds for all the volumes but interleaved\r\n  const interleavedRequests = compact(flatten(zip(...AllRequests)));\r\n\r\n  // set the finalRequests to the imageLoadPoolManager\r\n  const finalRequests = [];\r\n  interleavedRequests.forEach(request => {\r\n    const { imageId } = request;\r\n\r\n    AllRequests.forEach(volumeRequests => {\r\n      const volumeImageIdRequest = volumeRequests.find(req => req.imageId === imageId);\r\n      if (volumeImageIdRequest) {\r\n        finalRequests.push(volumeImageIdRequest);\r\n      }\r\n    });\r\n  });\r\n\r\n  const requestType = Enums.RequestType.Prefetch;\r\n  const priority = 0;\r\n\r\n  finalRequests.forEach(({ callLoadImage, additionalDetails, imageId, imageIdIndex, options }) => {\r\n    const callLoadImageBound = callLoadImage.bind(null, imageId, imageIdIndex, options);\r\n\r\n    imageLoadPoolManager.addRequest(callLoadImageBound, requestType, additionalDetails, priority);\r\n  });\r\n\r\n  // clear the volumeIdMapsToLoad\r\n  volumeIdMapsToLoad.clear();\r\n\r\n  // copy the viewportIdVolumeInputArrayMap\r\n  const viewportIdVolumeInputArrayMapCopy = new Map(viewportIdVolumeInputArrayMap);\r\n\r\n  // reset the viewportIdVolumeInputArrayMap\r\n  viewportIdVolumeInputArrayMap.clear();\r\n\r\n  return viewportIdVolumeInputArrayMapCopy;\r\n}\r\n","import { cache, imageLoadPoolManager, Enums } from '@cornerstonejs/core';\r\nimport zip from 'lodash.zip';\r\nimport compact from 'lodash.compact';\r\nimport flatten from 'lodash.flatten';\r\n\r\n// Map of volumeId and SeriesInstanceId\r\nconst volumeIdMapsToLoad = new Map<string, string>();\r\nconst viewportIdVolumeInputArrayMap = new Map<string, unknown[]>();\r\n\r\n/**\r\n * This function caches the volumeIds until all the volumes inside the\r\n * hanging protocol are initialized. Then it goes through the imageIds\r\n * of the volumes, and interleave them, in order for the volumes to be loaded\r\n * together from middle to the start and the end.\r\n * @param {Object} {viewportData, displaySetMatchDetails}\r\n * @returns\r\n */\r\nexport default function interleaveTopToBottom({\r\n  data: { viewportId, volumeInputArray },\r\n  displaySetsMatchDetails,\r\n  viewportMatchDetails: matchDetails,\r\n}) {\r\n  viewportIdVolumeInputArrayMap.set(viewportId, volumeInputArray);\r\n\r\n  // Based on the volumeInputs store the volumeIds and SeriesInstanceIds\r\n  // to keep track of the volumes being loaded\r\n  for (const volumeInput of volumeInputArray) {\r\n    const { volumeId } = volumeInput;\r\n    const volume = cache.getVolume(volumeId);\r\n\r\n    if (!volume) {\r\n      return;\r\n    }\r\n\r\n    // if the volumeUID is not in the volumeUIDs array, add it\r\n    if (!volumeIdMapsToLoad.has(volumeId)) {\r\n      const { metadata } = volume;\r\n      volumeIdMapsToLoad.set(volumeId, metadata.SeriesInstanceUID);\r\n    }\r\n  }\r\n\r\n  const filteredMatchDetails = [];\r\n  const displaySetsToLoad = new Set();\r\n\r\n  // Check all viewports that have a displaySet to be loaded. In some cases\r\n  // (eg: line chart viewports which is not a Cornerstone viewport) the\r\n  // displaySet is created on the client and there are no instances to be\r\n  // downloaded. For those viewports the displaySet may have the `skipLoading`\r\n  // option set to true otherwise it may block the download of all other\r\n  // instances resulting in blank viewports.\r\n  Array.from(matchDetails.values()).forEach(curMatchDetails => {\r\n    const { displaySetsInfo } = curMatchDetails;\r\n    let numDisplaySetsToLoad = 0;\r\n\r\n    displaySetsInfo.forEach(({ displaySetInstanceUID, displaySetOptions }) => {\r\n      if (!displaySetOptions?.options?.skipLoading) {\r\n        numDisplaySetsToLoad++;\r\n        displaySetsToLoad.add(displaySetInstanceUID);\r\n      }\r\n    });\r\n\r\n    if (numDisplaySetsToLoad) {\r\n      filteredMatchDetails.push(curMatchDetails);\r\n    }\r\n  });\r\n\r\n  /**\r\n   * The following is checking if all the viewports that were matched in the HP has been\r\n   * successfully created their cornerstone viewport or not. Todo: This can be\r\n   * improved by not checking it, and as soon as the matched DisplaySets have their\r\n   * volume loaded, we start the loading, but that comes at the cost of viewports\r\n   * not being created yet (e.g., in a 10 viewport ptCT fusion, when one ct viewport and one\r\n   * pt viewport are created we have a guarantee that the volumes are created in the cache\r\n   * but the rest of the viewports (fusion, mip etc.) are not created yet. So\r\n   * we can't initiate setting the volumes for those viewports. One solution can be\r\n   * to add an event when a viewport is created (not enabled element event) and then\r\n   * listen to it and as the other viewports are created we can set the volumes for them\r\n   * since volumes are already started loading.\r\n   */\r\n  const uniqueViewportVolumeDisplaySetUIDs = new Set();\r\n  viewportIdVolumeInputArrayMap.forEach((volumeInputArray, viewportId) => {\r\n    volumeInputArray.forEach(volumeInput => {\r\n      const { volumeId } = volumeInput;\r\n      uniqueViewportVolumeDisplaySetUIDs.add(volumeId);\r\n    });\r\n  });\r\n\r\n  const uniqueMatchedDisplaySetUIDs = new Set();\r\n\r\n  matchDetails.forEach(matchDetail => {\r\n    const { displaySetsInfo } = matchDetail;\r\n    displaySetsInfo.forEach(({ displaySetInstanceUID }) => {\r\n      uniqueMatchedDisplaySetUIDs.add(displaySetInstanceUID);\r\n    });\r\n  });\r\n\r\n  if (uniqueViewportVolumeDisplaySetUIDs.size !== uniqueMatchedDisplaySetUIDs.size) {\r\n    return;\r\n  }\r\n\r\n  const volumeIds = Array.from(volumeIdMapsToLoad.keys()).slice();\r\n  // get volumes from cache\r\n  const volumes = volumeIds.map(volumeId => {\r\n    return cache.getVolume(volumeId);\r\n  });\r\n\r\n  // iterate over all volumes, and get their imageIds, and interleave\r\n  // the imageIds and save them in AllRequests for later use\r\n  const AllRequests = [];\r\n  volumes.forEach(volume => {\r\n    const requests = volume.getImageLoadRequests();\r\n\r\n    if (!requests?.[0]?.imageId) {\r\n      return;\r\n    }\r\n\r\n    // reverse the requests\r\n    AllRequests.push(requests.reverse());\r\n  });\r\n\r\n  // flatten the AllRequests array, which will result in a list of all the\r\n  // imageIds for all the volumes but interleaved\r\n  const interleavedRequests = compact(flatten(zip(...AllRequests)));\r\n\r\n  // set the finalRequests to the imageLoadPoolManager\r\n  const finalRequests = [];\r\n  interleavedRequests.forEach(request => {\r\n    const { imageId } = request;\r\n\r\n    AllRequests.forEach(volumeRequests => {\r\n      const volumeImageIdRequest = volumeRequests.find(req => req.imageId === imageId);\r\n      if (volumeImageIdRequest) {\r\n        finalRequests.push(volumeImageIdRequest);\r\n      }\r\n    });\r\n  });\r\n\r\n  const requestType = Enums.RequestType.Prefetch;\r\n  const priority = 0;\r\n\r\n  finalRequests.forEach(({ callLoadImage, additionalDetails, imageId, imageIdIndex, options }) => {\r\n    const callLoadImageBound = callLoadImage.bind(null, imageId, imageIdIndex, options);\r\n\r\n    imageLoadPoolManager.addRequest(callLoadImageBound, requestType, additionalDetails, priority);\r\n  });\r\n\r\n  // clear the volumeIdMapsToLoad\r\n  volumeIdMapsToLoad.clear();\r\n\r\n  // copy the viewportIdVolumeInputArrayMap\r\n  const viewportIdVolumeInputArrayMapCopy = new Map(viewportIdVolumeInputArrayMap);\r\n\r\n  // reset the viewportIdVolumeInputArrayMap\r\n  viewportIdVolumeInputArrayMap.clear();\r\n\r\n  return viewportIdVolumeInputArrayMapCopy;\r\n}\r\n","import { vec3 } from 'gl-matrix';\r\nimport { Enums } from '@cornerstonejs/core';\r\n\r\nimport OrientationAxis = Enums.OrientationAxis;\r\n\r\nexport const isReferenceViewable = ({\r\n  viewportId,\r\n  reference,\r\n  viewportOptions,\r\n  servicesManager,\r\n}) => {\r\n  const { cornerstoneViewportService, displaySetService } = servicesManager.services;\r\n\r\n  if (!viewportOptions) {\r\n    const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n\r\n    // we can make a customization for this to allow\r\n    const isViewable = viewport.isReferenceViewable(reference, {\r\n      withNavigation: true,\r\n    });\r\n\r\n    return isViewable;\r\n  }\r\n\r\n  if (viewportOptions.viewportType === 'stack') {\r\n    // we only need the viewport to include the referenced imageId\r\n    const displaySet = displaySetService.getDisplaySetByUID(reference.displaySetInstanceUID);\r\n    const imageIds = displaySet.instances.map(instance => instance.imageId);\r\n    return imageIds.includes(reference.referencedImageId);\r\n  }\r\n\r\n  // for the volume viewports, we need to check orientation\r\n  const { orientation } = viewportOptions;\r\n\r\n  // Todo: handle hanging protocols that have acquisition orientation\r\n  const closestOrientation = getClosestOrientationFromIOP(\r\n    displaySetService,\r\n    reference.displaySetInstanceUID\r\n  );\r\n\r\n  return closestOrientation === orientation;\r\n};\r\n\r\n/**\r\n * Get the plane (orientation) to which the ImageOrientationPatient is most closely aligned\r\n *\r\n * @param displaySetService\r\n * @param displaySetInstanceUID\r\n * @returns orientation\r\n */\r\nexport default function getClosestOrientationFromIOP(\r\n  displaySetService,\r\n  displaySetInstanceUID\r\n): OrientationAxis {\r\n  const displaySet = displaySetService.getDisplaySetByUID(displaySetInstanceUID);\r\n  const imageOrientationPatient = displaySet.instances[0].ImageOrientationPatient as Array<number>;\r\n  // ImageOrientationPatient must be an array of length 6.\r\n  if (imageOrientationPatient?.length !== 6) {\r\n    return;\r\n  }\r\n\r\n  // Take cross product to get vector coming \"out\" of image plane\r\n  const rowCosineVec = vec3.fromValues(\r\n    imageOrientationPatient[0],\r\n    imageOrientationPatient[1],\r\n    imageOrientationPatient[2]\r\n  );\r\n  const colCosineVec = vec3.fromValues(\r\n    imageOrientationPatient[3],\r\n    imageOrientationPatient[4],\r\n    imageOrientationPatient[5]\r\n  );\r\n  const scanAxisNormal = vec3.cross(vec3.create(), rowCosineVec, colCosineVec);\r\n\r\n  // Define the reference vectors for axial, coronal, and sagittal planes\r\n  const unitVectors = {\r\n    [OrientationAxis.AXIAL]: vec3.fromValues(0, 0, 1),\r\n    [OrientationAxis.CORONAL]: vec3.fromValues(0, 1, 0),\r\n    [OrientationAxis.SAGITTAL]: vec3.fromValues(1, 0, 0),\r\n  };\r\n\r\n  // Compute dot products for each reference plane\r\n  // Because all vectors are normalized, dot product is bounded between -1 and 1\r\n  let maxDot = 0;\r\n  let maxOrientation: string = '';\r\n  for (const [k, v] of Object.entries(unitVectors)) {\r\n    // Absolute value of dot product because we only care about alignment with the axis\r\n    // For example, dot product of -1 for a given axis means perfect alignment\r\n    // but the image is pointing in the \"opposite\" direction\r\n    const res = Math.abs(vec3.dot(scanAxisNormal, v));\r\n    if (res > maxDot) {\r\n      maxDot = res;\r\n      maxOrientation = k;\r\n    }\r\n  }\r\n\r\n  return maxOrientation as OrientationAxis;\r\n}\r\n","import SUPPORTED_TOOLS from './constants/supportedTools';\r\nimport { getDisplayUnit } from './utils';\r\nimport { getIsLocked } from './utils/getIsLocked';\r\nimport { getIsVisible } from './utils/getIsVisible';\r\nimport getSOPInstanceAttributes from './utils/getSOPInstanceAttributes';\r\nimport { utils } from '@ohif/core';\r\n\r\nconst Angle = {\r\n  toAnnotation: measurement => {},\r\n\r\n  /**\r\n   * Maps cornerstone annotation event data to measurement service format.\r\n   *\r\n   * @param {Object} cornerstone Cornerstone event data\r\n   * @return {Measurement} Measurement instance\r\n   */\r\n  toMeasurement: (\r\n    csToolsEventDetail,\r\n    displaySetService,\r\n    CornerstoneViewportService,\r\n    getValueTypeFromToolType,\r\n    customizationService\r\n  ) => {\r\n    const { annotation } = csToolsEventDetail;\r\n    const { metadata, data, annotationUID } = annotation;\r\n\r\n    const isLocked = getIsLocked(annotationUID);\r\n    const isVisible = getIsVisible(annotationUID);\r\n    if (!metadata || !data) {\r\n      console.warn('Length tool: Missing metadata or data');\r\n      return null;\r\n    }\r\n\r\n    const { toolName, referencedImageId, FrameOfReferenceUID } = metadata;\r\n    const validToolType = SUPPORTED_TOOLS.includes(toolName);\r\n\r\n    if (!validToolType) {\r\n      throw new Error('Tool not supported');\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, StudyInstanceUID } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    let displaySet;\r\n\r\n    if (SOPInstanceUID) {\r\n      displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n        SOPInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n    } else {\r\n      displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n    }\r\n\r\n    const { points, textBox } = data.handles;\r\n\r\n    const mappedAnnotations = getMappedAnnotations(annotation, displaySetService);\r\n\r\n    const displayText = getDisplayText(mappedAnnotations, displaySet);\r\n    const getReport = () =>\r\n      _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService);\r\n\r\n    return {\r\n      uid: annotationUID,\r\n      SOPInstanceUID,\r\n      FrameOfReferenceUID,\r\n      points,\r\n      textBox,\r\n      isLocked,\r\n      isVisible,\r\n      metadata,\r\n      referenceSeriesUID: SeriesInstanceUID,\r\n      referenceStudyUID: StudyInstanceUID,\r\n      frameNumber: mappedAnnotations?.[0]?.frameNumber || 1,\r\n      toolName: metadata.toolName,\r\n      displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n      label: data.label,\r\n      displayText: displayText,\r\n      data: data.cachedStats,\r\n      type: getValueTypeFromToolType(toolName),\r\n      getReport,\r\n      referencedImageId,\r\n    };\r\n  },\r\n};\r\n\r\nfunction getMappedAnnotations(annotation, displaySetService) {\r\n  const { metadata, data } = annotation;\r\n  const { cachedStats } = data;\r\n  const { referencedImageId } = metadata;\r\n  const targets = Object.keys(cachedStats);\r\n\r\n  if (!targets.length) {\r\n    return;\r\n  }\r\n\r\n  const annotations = [];\r\n  Object.keys(cachedStats).forEach(targetId => {\r\n    const targetStats = cachedStats[targetId];\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    const displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n\r\n    const { SeriesNumber } = displaySet;\r\n    const { angle } = targetStats;\r\n    const unit = '\\u00B0';\r\n\r\n    annotations.push({\r\n      SeriesInstanceUID,\r\n      SOPInstanceUID,\r\n      SeriesNumber,\r\n      frameNumber,\r\n      unit,\r\n      angle,\r\n    });\r\n  });\r\n\r\n  return annotations;\r\n}\r\n\r\n/*\r\nThis function is used to convert the measurement data to a format that is\r\nsuitable for the report generation (e.g. for the csv report). The report\r\nreturns a list of columns and corresponding values.\r\n*/\r\nfunction _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService) {\r\n  const columns = [];\r\n  const values = [];\r\n\r\n  // Add Type\r\n  columns.push('AnnotationType');\r\n  values.push('Cornerstone:Angle');\r\n\r\n  mappedAnnotations.forEach(annotation => {\r\n    const { angle, unit } = annotation;\r\n    columns.push(`Angle (${unit})`);\r\n    values.push(angle);\r\n  });\r\n\r\n  if (FrameOfReferenceUID) {\r\n    columns.push('FrameOfReferenceUID');\r\n    values.push(FrameOfReferenceUID);\r\n  }\r\n\r\n  if (points) {\r\n    columns.push('points');\r\n    // points has the form of [[x1, y1, z1], [x2, y2, z2], ...]\r\n    // convert it to string of [[x1 y1 z1];[x2 y2 z2];...]\r\n    // so that it can be used in the csv report\r\n    values.push(points.map(p => p.join(' ')).join(';'));\r\n  }\r\n\r\n  return {\r\n    columns,\r\n    values,\r\n  };\r\n}\r\n\r\nfunction getDisplayText(mappedAnnotations, displaySet) {\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: [],\r\n  };\r\n\r\n  if (!mappedAnnotations || !mappedAnnotations.length) {\r\n    return displayText;\r\n  }\r\n\r\n  // Area is the same for all series\r\n  const { angle, unit, SeriesNumber, SOPInstanceUID, frameNumber } = mappedAnnotations[0];\r\n\r\n  const instance = displaySet.instances.find(image => image.SOPInstanceUID === SOPInstanceUID);\r\n\r\n  let InstanceNumber;\r\n  if (instance) {\r\n    InstanceNumber = instance.InstanceNumber;\r\n  }\r\n\r\n  const instanceText = InstanceNumber ? ` I: ${InstanceNumber}` : '';\r\n  const frameText = displaySet.isMultiFrame ? ` F: ${frameNumber}` : '';\r\n  if (angle === undefined) {\r\n    return displayText;\r\n  }\r\n  const roundedAngle = utils.roundNumber(angle, 2);\r\n\r\n  displayText.primary.push(`${roundedAngle} ${getDisplayUnit(unit)}`);\r\n  displayText.secondary.push(`S: ${SeriesNumber}${instanceText}${frameText}`);\r\n\r\n  return displayText;\r\n}\r\n\r\nexport default Angle;\r\n","import SUPPORTED_TOOLS from './constants/supportedTools';\r\nimport { getIsLocked } from './utils/getIsLocked';\r\nimport getSOPInstanceAttributes from './utils/getSOPInstanceAttributes';\r\nimport { getIsVisible } from './utils/getIsVisible';\r\n\r\nconst ArrowAnnotate = {\r\n  toAnnotation: measurement => {},\r\n\r\n  /**\r\n   * Maps cornerstone annotation event data to measurement service format.\r\n   *\r\n   * @param {Object} cornerstone Cornerstone event data\r\n   * @return {Measurement} Measurement instance\r\n   */\r\n  toMeasurement: (\r\n    csToolsEventDetail,\r\n    displaySetService,\r\n    cornerstoneViewportService,\r\n    getValueTypeFromToolType,\r\n    customizationService\r\n  ) => {\r\n    const { annotation } = csToolsEventDetail;\r\n    const { metadata, data, annotationUID } = annotation;\r\n\r\n    const isLocked = getIsLocked(annotationUID);\r\n    const isVisible = getIsVisible(annotationUID);\r\n    if (!metadata || !data) {\r\n      console.warn('Length tool: Missing metadata or data');\r\n      return null;\r\n    }\r\n\r\n    const { toolName, referencedImageId, FrameOfReferenceUID } = metadata;\r\n    const validToolType = SUPPORTED_TOOLS.includes(toolName);\r\n\r\n    if (!validToolType) {\r\n      throw new Error('Tool not supported');\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, StudyInstanceUID } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    let displaySet;\r\n\r\n    if (SOPInstanceUID) {\r\n      displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n        SOPInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n    } else {\r\n      displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n    }\r\n\r\n    const { points, textBox } = data.handles;\r\n\r\n    const mappedAnnotations = getMappedAnnotations(annotation, displaySetService);\r\n\r\n    const displayText = getDisplayText(mappedAnnotations, displaySet);\r\n    const getReport = () => _getReport(mappedAnnotations, points, FrameOfReferenceUID);\r\n\r\n    return {\r\n      uid: annotationUID,\r\n      SOPInstanceUID,\r\n      FrameOfReferenceUID,\r\n      points,\r\n      textBox,\r\n      isLocked,\r\n      isVisible,\r\n      metadata,\r\n      referenceSeriesUID: SeriesInstanceUID,\r\n      referenceStudyUID: StudyInstanceUID,\r\n      referencedImageId,\r\n      frameNumber: mappedAnnotations[0]?.frameNumber || 1,\r\n      toolName: metadata.toolName,\r\n      displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n      label: data.text,\r\n      displayText: displayText,\r\n      data: data.cachedStats,\r\n      type: getValueTypeFromToolType(toolName),\r\n      getReport,\r\n    };\r\n  },\r\n};\r\n\r\nfunction getMappedAnnotations(annotation, displaySetService) {\r\n  const { metadata, data } = annotation;\r\n  const { text } = data;\r\n  const { referencedImageId } = metadata;\r\n\r\n  const annotations = [];\r\n\r\n  const { SOPInstanceUID, SeriesInstanceUID, frameNumber } = getSOPInstanceAttributes(\r\n    referencedImageId,\r\n    displaySetService,\r\n    annotation\r\n  );\r\n\r\n  const displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n\r\n  const { SeriesNumber } = displaySet;\r\n\r\n  annotations.push({\r\n    SeriesInstanceUID,\r\n    SOPInstanceUID,\r\n    SeriesNumber,\r\n    frameNumber,\r\n    text,\r\n  });\r\n\r\n  return annotations;\r\n}\r\n\r\nfunction getDisplayText(mappedAnnotations, displaySet) {\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: [],\r\n  };\r\n\r\n  if (!mappedAnnotations || !mappedAnnotations.length) {\r\n    return displayText;\r\n  }\r\n\r\n  const { SeriesNumber, SOPInstanceUID, frameNumber, text } = mappedAnnotations[0];\r\n\r\n  const instance = displaySet.instances.find(image => image.SOPInstanceUID === SOPInstanceUID);\r\n\r\n  let InstanceNumber;\r\n  if (instance) {\r\n    InstanceNumber = instance.InstanceNumber;\r\n  }\r\n\r\n  const instanceText = InstanceNumber ? ` I: ${InstanceNumber}` : '';\r\n  const frameText = displaySet.isMultiFrame ? ` F: ${frameNumber}` : '';\r\n\r\n  // Add the annotation text to the primary array\r\n  if (text) {\r\n    displayText.primary.push(text);\r\n  }\r\n\r\n  // Add the series information to the secondary array\r\n  displayText.secondary.push(`S: ${SeriesNumber}${instanceText}${frameText}`);\r\n\r\n  return displayText;\r\n}\r\n\r\nfunction _getReport(mappedAnnotations, points, FrameOfReferenceUID) {\r\n  const columns = [];\r\n  const values = [];\r\n\r\n  columns.push('AnnotationType');\r\n  values.push('Cornerstone:ArrowAnnote');\r\n\r\n  mappedAnnotations.forEach(annotation => {\r\n    const { text } = annotation;\r\n    columns.push(`Text`);\r\n    values.push(text);\r\n  });\r\n\r\n  if (FrameOfReferenceUID) {\r\n    columns.push('FrameOfReferenceUID');\r\n    values.push(FrameOfReferenceUID);\r\n  }\r\n\r\n  if (points) {\r\n    columns.push('points');\r\n    values.push(points.map(p => p.join(' ')).join(';'));\r\n  }\r\n\r\n  return {\r\n    columns,\r\n    values,\r\n  };\r\n}\r\nexport default ArrowAnnotate;\r\n","import SUPPORTED_TOOLS from './constants/supportedTools';\r\nimport getSOPInstanceAttributes from './utils/getSOPInstanceAttributes';\r\nimport { utils } from '@ohif/core';\r\nimport { getDisplayUnit } from './utils';\r\nimport { getIsLocked } from './utils/getIsLocked';\r\nimport { getIsVisible } from './utils/getIsVisible';\r\n\r\nconst Bidirectional = {\r\n  toAnnotation: measurement => {},\r\n  toMeasurement: (\r\n    csToolsEventDetail,\r\n    displaySetService,\r\n    cornerstoneViewportService,\r\n    getValueTypeFromToolType,\r\n    customizationService\r\n  ) => {\r\n    const { annotation } = csToolsEventDetail;\r\n    const { metadata, data, annotationUID } = annotation;\r\n\r\n    const isLocked = getIsLocked(annotationUID);\r\n    const isVisible = getIsVisible(annotationUID);\r\n\r\n    if (!metadata || !data) {\r\n      console.warn('Length tool: Missing metadata or data');\r\n      return null;\r\n    }\r\n\r\n    const { toolName, referencedImageId, FrameOfReferenceUID } = metadata;\r\n    const validToolType = SUPPORTED_TOOLS.includes(toolName);\r\n\r\n    if (!validToolType) {\r\n      throw new Error('Tool not supported');\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, StudyInstanceUID } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    let displaySet;\r\n\r\n    if (SOPInstanceUID) {\r\n      displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n        SOPInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n    } else {\r\n      displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n    }\r\n\r\n    const { points, textBox } = data.handles;\r\n\r\n    const mappedAnnotations = getMappedAnnotations(annotation, displaySetService);\r\n\r\n    const displayText = getDisplayText(mappedAnnotations, displaySet);\r\n    const getReport = () =>\r\n      _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService);\r\n\r\n    return {\r\n      uid: annotationUID,\r\n      SOPInstanceUID,\r\n      FrameOfReferenceUID,\r\n      points,\r\n      textBox,\r\n      isLocked,\r\n      isVisible,\r\n      metadata,\r\n      referenceSeriesUID: SeriesInstanceUID,\r\n      referenceStudyUID: StudyInstanceUID,\r\n      referencedImageId,\r\n      frameNumber: mappedAnnotations[0]?.frameNumber || 1,\r\n      toolName: metadata.toolName,\r\n      displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n      label: data.label,\r\n      displayText: displayText,\r\n      data: data.cachedStats,\r\n      type: getValueTypeFromToolType(toolName),\r\n      getReport,\r\n    };\r\n  },\r\n};\r\n\r\nfunction getMappedAnnotations(annotation, displaySetService) {\r\n  const { metadata, data } = annotation;\r\n  const { cachedStats } = data;\r\n  const { referencedImageId } = metadata;\r\n  const targets = Object.keys(cachedStats);\r\n\r\n  if (!targets.length) {\r\n    return [];\r\n  }\r\n\r\n  const annotations = [];\r\n  Object.keys(cachedStats).forEach(targetId => {\r\n    const targetStats = cachedStats[targetId];\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    const displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n\r\n    const { SeriesNumber } = displaySet;\r\n    const { length, width, unit } = targetStats;\r\n\r\n    annotations.push({\r\n      SeriesInstanceUID,\r\n      SOPInstanceUID,\r\n      SeriesNumber,\r\n      frameNumber,\r\n      unit,\r\n      length,\r\n      width,\r\n    });\r\n  });\r\n\r\n  return annotations;\r\n}\r\n\r\n/*\r\nThis function is used to convert the measurement data to a format that is\r\nsuitable for the report generation (e.g. for the csv report). The report\r\nreturns a list of columns and corresponding values.\r\n*/\r\nfunction _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService) {\r\n  const columns = [];\r\n  const values = [];\r\n\r\n  // Add Type\r\n  columns.push('AnnotationType');\r\n  values.push('Cornerstone:Bidirectional');\r\n\r\n  mappedAnnotations.forEach(annotation => {\r\n    const { length, width, unit } = annotation;\r\n    columns.push(`Length`, `Width`, 'Unit');\r\n    values.push(length, width, unit);\r\n  });\r\n\r\n  if (FrameOfReferenceUID) {\r\n    columns.push('FrameOfReferenceUID');\r\n    values.push(FrameOfReferenceUID);\r\n  }\r\n\r\n  if (points) {\r\n    columns.push('points');\r\n    // points has the form of [[x1, y1, z1], [x2, y2, z2], ...]\r\n    // convert it to string of [[x1 y1 z1];[x2 y2 z2];...]\r\n    // so that it can be used in the csv report\r\n    values.push(points.map(p => p.join(' ')).join(';'));\r\n  }\r\n\r\n  return {\r\n    columns,\r\n    values,\r\n  };\r\n}\r\n\r\nfunction getDisplayText(mappedAnnotations, displaySet) {\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: [],\r\n  };\r\n\r\n  if (!mappedAnnotations || !mappedAnnotations.length) {\r\n    return displayText;\r\n  }\r\n\r\n  // Area is the same for all series\r\n  const { length, width, unit, SeriesNumber, SOPInstanceUID, frameNumber } = mappedAnnotations[0];\r\n  const roundedLength = utils.roundNumber(length, 2);\r\n  const roundedWidth = utils.roundNumber(width, 2);\r\n\r\n  const instance = displaySet.instances.find(image => image.SOPInstanceUID === SOPInstanceUID);\r\n\r\n  let InstanceNumber;\r\n  if (instance) {\r\n    InstanceNumber = instance.InstanceNumber;\r\n  }\r\n\r\n  const instanceText = InstanceNumber ? ` I: ${InstanceNumber}` : '';\r\n  const frameText = displaySet.isMultiFrame ? ` F: ${frameNumber}` : '';\r\n\r\n  displayText.primary.push(`L: ${roundedLength} ${getDisplayUnit(unit)}`);\r\n  displayText.primary.push(`W: ${roundedWidth} ${getDisplayUnit(unit)}`);\r\n  displayText.secondary.push(`S: ${SeriesNumber}${instanceText}${frameText}`);\r\n\r\n  return displayText;\r\n}\r\n\r\nexport default Bidirectional;\r\n","import SUPPORTED_TOOLS from './constants/supportedTools';\r\nimport { getDisplayUnit } from './utils';\r\nimport getSOPInstanceAttributes from './utils/getSOPInstanceAttributes';\r\nimport { utils } from '@ohif/core';\r\nimport { getStatisticDisplayString } from './utils/getValueDisplayString';\r\nimport { getIsLocked } from './utils/getIsLocked';\r\nimport { getIsVisible } from './utils/getIsVisible';\r\n\r\nconst CircleROI = {\r\n  toAnnotation: measurement => {},\r\n  toMeasurement: (\r\n    csToolsEventDetail,\r\n    displaySetService,\r\n    CornerstoneViewportService,\r\n    getValueTypeFromToolType,\r\n    customizationService\r\n  ) => {\r\n    const { annotation } = csToolsEventDetail;\r\n    const { metadata, data, annotationUID } = annotation;\r\n\r\n    const isLocked = getIsLocked(annotationUID);\r\n    const isVisible = getIsVisible(annotationUID);\r\n\r\n    if (!metadata || !data) {\r\n      console.warn('Length tool: Missing metadata or data');\r\n      return null;\r\n    }\r\n\r\n    const { toolName, referencedImageId, FrameOfReferenceUID } = metadata;\r\n    const validToolType = SUPPORTED_TOOLS.includes(toolName);\r\n\r\n    if (!validToolType) {\r\n      throw new Error('Tool not supported');\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, StudyInstanceUID } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    let displaySet;\r\n\r\n    if (SOPInstanceUID) {\r\n      displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n        SOPInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n    } else {\r\n      displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n    }\r\n\r\n    const { points, textBox } = data.handles;\r\n\r\n    const mappedAnnotations = getMappedAnnotations(annotation, displaySetService);\r\n\r\n    const displayText = getDisplayText(mappedAnnotations, displaySet);\r\n    const getReport = () =>\r\n      _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService);\r\n\r\n    return {\r\n      uid: annotationUID,\r\n      SOPInstanceUID,\r\n      FrameOfReferenceUID,\r\n      points,\r\n      textBox,\r\n      isLocked,\r\n      isVisible,\r\n      metadata,\r\n      referenceSeriesUID: SeriesInstanceUID,\r\n      referenceStudyUID: StudyInstanceUID,\r\n      referencedImageId,\r\n      frameNumber: mappedAnnotations[0]?.frameNumber || 1,\r\n      toolName: metadata.toolName,\r\n      displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n      label: data.label,\r\n      displayText: displayText,\r\n      data: data.cachedStats,\r\n      type: getValueTypeFromToolType(toolName),\r\n      getReport,\r\n    };\r\n  },\r\n};\r\n\r\nfunction getMappedAnnotations(annotation, displaySetService) {\r\n  const { metadata, data } = annotation;\r\n  const { cachedStats } = data;\r\n  const { referencedImageId } = metadata;\r\n  const targets = Object.keys(cachedStats);\r\n\r\n  if (!targets.length) {\r\n    return [];\r\n  }\r\n\r\n  const annotations = [];\r\n  const addedModalities = new Set();\r\n  Object.keys(cachedStats).forEach(targetId => {\r\n    const targetStats = cachedStats[targetId];\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    const displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n\r\n    const { SeriesNumber } = displaySet;\r\n    const { mean, stdDev, max, area, Modality, areaUnit, modalityUnit, perimeter, radiusUnit } =\r\n      targetStats;\r\n\r\n    if (Modality && addedModalities.has(Modality)) {\r\n      return;\r\n    }\r\n\r\n    addedModalities.add(Modality);\r\n\r\n    annotations.push({\r\n      SeriesInstanceUID,\r\n      SOPInstanceUID,\r\n      SeriesNumber,\r\n      frameNumber,\r\n      Modality,\r\n      unit: modalityUnit,\r\n      mean,\r\n      stdDev,\r\n      max,\r\n      area,\r\n      areaUnit,\r\n      perimeter,\r\n      radiusUnit,\r\n    });\r\n  });\r\n\r\n  return annotations;\r\n}\r\n\r\n/*\r\nThis function is used to convert the measurement data to a format that is\r\nsuitable for the report generation (e.g. for the csv report). The report\r\nreturns a list of columns and corresponding values.\r\n*/\r\nfunction _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService) {\r\n  const columns = [];\r\n  const values = [];\r\n\r\n  // Add Type\r\n  columns.push('AnnotationType');\r\n  values.push('Cornerstone:CircleROI');\r\n\r\n  mappedAnnotations.forEach(annotation => {\r\n    const { mean, stdDev, max, area, unit, areaUnit } = annotation;\r\n\r\n    if (!mean || !unit || !max || !area) {\r\n      return;\r\n    }\r\n\r\n    columns.push(`max (${unit})`, `mean (${unit})`, `std (${unit})`, 'Area', 'Unit');\r\n    values.push(max, mean, stdDev, area, areaUnit);\r\n  });\r\n\r\n  if (FrameOfReferenceUID) {\r\n    columns.push('FrameOfReferenceUID');\r\n    values.push(FrameOfReferenceUID);\r\n  }\r\n\r\n  if (points) {\r\n    columns.push('points');\r\n    // points has the form of [[x1, y1, z1], [x2, y2, z2], ...]\r\n    // convert it to string of [[x1 y1 z1];[x2 y2 z2];...]\r\n    // so that it can be used in the csv report\r\n    values.push(points.map(p => p.join(' ')).join(';'));\r\n  }\r\n\r\n  return {\r\n    columns,\r\n    values,\r\n  };\r\n}\r\n\r\nfunction getDisplayText(mappedAnnotations, displaySet) {\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: [],\r\n  };\r\n\r\n  if (!mappedAnnotations || !mappedAnnotations.length) {\r\n    return displayText;\r\n  }\r\n\r\n  // Area is the same for all series\r\n  const { area, SOPInstanceUID, frameNumber, areaUnit } = mappedAnnotations[0];\r\n\r\n  const instance = displaySet.instances.find(image => image.SOPInstanceUID === SOPInstanceUID);\r\n\r\n  let InstanceNumber;\r\n  if (instance) {\r\n    InstanceNumber = instance.InstanceNumber;\r\n  }\r\n\r\n  const instanceText = InstanceNumber ? ` I: ${InstanceNumber}` : '';\r\n  const frameText = displaySet.isMultiFrame ? ` F: ${frameNumber}` : '';\r\n\r\n  // Area sometimes becomes undefined if `preventHandleOutsideImage` is off.\r\n  if (!isNaN(area)) {\r\n    const roundedArea = utils.roundNumber(area || 0, 2);\r\n    displayText.primary.push(`${roundedArea} ${getDisplayUnit(areaUnit)}`);\r\n  }\r\n\r\n  // Todo: we need a better UI for displaying all these information\r\n  mappedAnnotations.forEach(mappedAnnotation => {\r\n    const { unit, perimeter, radiusUnit, max, SeriesNumber } = mappedAnnotation;\r\n\r\n    if (!isNaN(max)) {\r\n      const maxStr = getStatisticDisplayString(max, unit, 'max');\r\n      displayText.primary.push(maxStr);\r\n    } else if (perimeter && !isNaN(perimeter)) {\r\n      const perimeterStr = getStatisticDisplayString(perimeter, radiusUnit, 'perimeter');\r\n      displayText.primary.push(perimeterStr);\r\n    }\r\n    displayText.secondary.push(`S: ${SeriesNumber}${instanceText}${frameText}`);\r\n  });\r\n\r\n  return displayText;\r\n}\r\n\r\nexport default CircleROI;\r\n","import SUPPORTED_TOOLS from './constants/supportedTools';\r\nimport { getDisplayUnit } from './utils';\r\nimport { getIsLocked } from './utils/getIsLocked';\r\nimport { getIsVisible } from './utils/getIsVisible';\r\nimport getSOPInstanceAttributes from './utils/getSOPInstanceAttributes';\r\nimport { utils } from '@ohif/core';\r\n\r\nconst CobbAngle = {\r\n  toAnnotation: measurement => {},\r\n\r\n  /**\r\n   * Maps cornerstone annotation event data to measurement service format.\r\n   *\r\n   * @param {Object} cornerstone Cornerstone event data\r\n   * @return {Measurement} Measurement instance\r\n   */\r\n  toMeasurement: (\r\n    csToolsEventDetail,\r\n    displaySetService,\r\n    CornerstoneViewportService,\r\n    getValueTypeFromToolType,\r\n    customizationService\r\n  ) => {\r\n    const { annotation } = csToolsEventDetail;\r\n    const { metadata, data, annotationUID } = annotation;\r\n\r\n    const isLocked = getIsLocked(annotationUID);\r\n    const isVisible = getIsVisible(annotationUID);\r\n\r\n    if (!metadata || !data) {\r\n      console.warn('Cobb Angle tool: Missing metadata or data');\r\n      return null;\r\n    }\r\n\r\n    const { toolName, referencedImageId, FrameOfReferenceUID } = metadata;\r\n    const validToolType = SUPPORTED_TOOLS.includes(toolName);\r\n\r\n    if (!validToolType) {\r\n      throw new Error('Tool not supported');\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, StudyInstanceUID } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    let displaySet;\r\n\r\n    if (SOPInstanceUID) {\r\n      displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n        SOPInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n    } else {\r\n      displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n    }\r\n\r\n    const { points, textBox } = data.handles;\r\n\r\n    const mappedAnnotations = getMappedAnnotations(annotation, displaySetService);\r\n\r\n    const displayText = getDisplayText(mappedAnnotations, displaySet);\r\n    const getReport = () =>\r\n      _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService);\r\n\r\n    return {\r\n      uid: annotationUID,\r\n      SOPInstanceUID,\r\n      FrameOfReferenceUID,\r\n      points,\r\n      textBox,\r\n      isLocked,\r\n      isVisible,\r\n      metadata,\r\n      referenceSeriesUID: SeriesInstanceUID,\r\n      referenceStudyUID: StudyInstanceUID,\r\n      referencedImageId,\r\n      frameNumber: mappedAnnotations?.[0]?.frameNumber || 1,\r\n      toolName: metadata.toolName,\r\n      displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n      label: data.label,\r\n      displayText: displayText,\r\n      data: data.cachedStats,\r\n      type: getValueTypeFromToolType(toolName),\r\n      getReport,\r\n    };\r\n  },\r\n};\r\n\r\nfunction getMappedAnnotations(annotation, displaySetService) {\r\n  const { metadata, data } = annotation;\r\n  const { cachedStats } = data;\r\n  const { referencedImageId } = metadata;\r\n  const targets = Object.keys(cachedStats);\r\n\r\n  if (!targets.length) {\r\n    return;\r\n  }\r\n\r\n  const annotations = [];\r\n  Object.keys(cachedStats).forEach(targetId => {\r\n    const targetStats = cachedStats[targetId];\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    const displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n\r\n    const { SeriesNumber } = displaySet;\r\n    const { angle } = targetStats;\r\n    const unit = '\\u00B0';\r\n\r\n    annotations.push({\r\n      SeriesInstanceUID,\r\n      SOPInstanceUID,\r\n      SeriesNumber,\r\n      frameNumber,\r\n      unit,\r\n      angle,\r\n    });\r\n  });\r\n\r\n  return annotations;\r\n}\r\n\r\n/*\r\nThis function is used to convert the measurement data to a format that is\r\nsuitable for the report generation (e.g. for the csv report). The report\r\nreturns a list of columns and corresponding values.\r\n*/\r\nfunction _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService) {\r\n  const columns = [];\r\n  const values = [];\r\n\r\n  // Add Type\r\n  columns.push('AnnotationType');\r\n  values.push('Cornerstone:CobbAngle');\r\n\r\n  mappedAnnotations.forEach(annotation => {\r\n    const { angle, unit } = annotation;\r\n    columns.push(`Angle (${unit})`);\r\n    values.push(angle);\r\n  });\r\n\r\n  if (FrameOfReferenceUID) {\r\n    columns.push('FrameOfReferenceUID');\r\n    values.push(FrameOfReferenceUID);\r\n  }\r\n\r\n  if (points) {\r\n    columns.push('points');\r\n    // points has the form of [[x1, y1, z1], [x2, y2, z2], ...]\r\n    // convert it to string of [[x1 y1 z1];[x2 y2 z2];...]\r\n    // so that it can be used in the csv report\r\n    values.push(points.map(p => p.join(' ')).join(';'));\r\n  }\r\n\r\n  return {\r\n    columns,\r\n    values,\r\n  };\r\n}\r\n\r\nfunction getDisplayText(mappedAnnotations, displaySet) {\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: [],\r\n  };\r\n\r\n  if (!mappedAnnotations || !mappedAnnotations.length) {\r\n    return displayText;\r\n  }\r\n\r\n  // Angle is the same for all series\r\n  const { angle, unit, SeriesNumber, SOPInstanceUID, frameNumber } = mappedAnnotations[0];\r\n\r\n  const instance = displaySet.instances.find(image => image.SOPInstanceUID === SOPInstanceUID);\r\n\r\n  let InstanceNumber;\r\n  if (instance) {\r\n    InstanceNumber = instance.InstanceNumber;\r\n  }\r\n\r\n  const instanceText = InstanceNumber ? ` I: ${InstanceNumber}` : '';\r\n  const frameText = displaySet.isMultiFrame ? ` F: ${frameNumber}` : '';\r\n  if (angle === undefined) {\r\n    return displayText;\r\n  }\r\n  const roundedAngle = utils.roundNumber(angle, 2);\r\n\r\n  displayText.primary.push(`${roundedAngle} ${getDisplayUnit(unit)}`);\r\n  displayText.secondary.push(`S: ${SeriesNumber}${instanceText}${frameText}`);\r\n\r\n  return displayText;\r\n}\r\n\r\nexport default CobbAngle;\r\n","import SUPPORTED_TOOLS from './constants/supportedTools';\r\nimport { getDisplayUnit } from './utils';\r\nimport { getIsLocked } from './utils/getIsLocked';\r\nimport { getIsVisible } from './utils/getIsVisible';\r\nimport getSOPInstanceAttributes from './utils/getSOPInstanceAttributes';\r\nimport { utils } from '@ohif/core';\r\nimport { getStatisticDisplayString } from './utils/getValueDisplayString';\r\n\r\nconst EllipticalROI = {\r\n  toAnnotation: measurement => {},\r\n  toMeasurement: (\r\n    csToolsEventDetail,\r\n    displaySetService,\r\n    cornerstoneViewportService,\r\n    getValueTypeFromToolType,\r\n    customizationService\r\n  ) => {\r\n    const { annotation } = csToolsEventDetail;\r\n    const { metadata, data, annotationUID } = annotation;\r\n\r\n    const isLocked = getIsLocked(annotationUID);\r\n    const isVisible = getIsVisible(annotationUID);\r\n\r\n    if (!metadata || !data) {\r\n      console.warn('Length tool: Missing metadata or data');\r\n      return null;\r\n    }\r\n\r\n    const { toolName, referencedImageId, FrameOfReferenceUID } = metadata;\r\n    const validToolType = SUPPORTED_TOOLS.includes(toolName);\r\n\r\n    if (!validToolType) {\r\n      throw new Error('Tool not supported');\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, StudyInstanceUID } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    let displaySet;\r\n\r\n    if (SOPInstanceUID) {\r\n      displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n        SOPInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n    } else {\r\n      displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n    }\r\n\r\n    const { points, textBox } = data.handles;\r\n\r\n    const mappedAnnotations = getMappedAnnotations(annotation, displaySetService);\r\n\r\n    const displayText = getDisplayText(mappedAnnotations, displaySet, customizationService);\r\n    const getReport = () =>\r\n      _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService);\r\n\r\n    return {\r\n      uid: annotationUID,\r\n      SOPInstanceUID,\r\n      FrameOfReferenceUID,\r\n      points,\r\n      textBox,\r\n      metadata,\r\n      isLocked,\r\n      isVisible,\r\n      referenceSeriesUID: SeriesInstanceUID,\r\n      referenceStudyUID: StudyInstanceUID,\r\n      referencedImageId,\r\n      frameNumber: mappedAnnotations[0]?.frameNumber || 1,\r\n      toolName: metadata.toolName,\r\n      displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n      label: data.label,\r\n      displayText: displayText,\r\n      data: data.cachedStats,\r\n      type: getValueTypeFromToolType(toolName),\r\n      getReport,\r\n    };\r\n  },\r\n};\r\n\r\nfunction getMappedAnnotations(annotation, displaySetService) {\r\n  const { metadata, data } = annotation;\r\n  const { cachedStats } = data;\r\n  const { referencedImageId } = metadata;\r\n  const targets = Object.keys(cachedStats);\r\n\r\n  if (!targets.length) {\r\n    return [];\r\n  }\r\n\r\n  const annotations = [];\r\n  const addedModalities = new Set();\r\n\r\n  Object.keys(cachedStats).forEach(targetId => {\r\n    const targetStats = cachedStats[targetId];\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    const displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n\r\n    const { SeriesNumber } = displaySet;\r\n    const { mean, stdDev, max, area, Modality, areaUnit, modalityUnit } = targetStats;\r\n\r\n    // Skip if we've already added this modality\r\n    if (Modality && addedModalities.has(Modality)) {\r\n      return;\r\n    }\r\n\r\n    // Add modality to the set if it exists\r\n    if (Modality) {\r\n      addedModalities.add(Modality);\r\n    }\r\n\r\n    annotations.push({\r\n      SeriesInstanceUID,\r\n      SOPInstanceUID,\r\n      SeriesNumber,\r\n      frameNumber,\r\n      Modality,\r\n      unit: modalityUnit,\r\n      areaUnit,\r\n      mean,\r\n      stdDev,\r\n      max,\r\n      area,\r\n    });\r\n  });\r\n\r\n  return annotations;\r\n}\r\n\r\n/*\r\nThis function is used to convert the measurement data to a format that is\r\nsuitable for the report generation (e.g. for the csv report). The report\r\nreturns a list of columns and corresponding values.\r\n*/\r\nfunction _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService) {\r\n  const columns = [];\r\n  const values = [];\r\n\r\n  // Add Type\r\n  columns.push('AnnotationType');\r\n  values.push('Cornerstone:EllipticalROI');\r\n\r\n  mappedAnnotations.forEach(annotation => {\r\n    const { mean, stdDev, max, area, unit, areaUnit } = annotation;\r\n\r\n    if (!mean || !unit || !max || !area) {\r\n      return;\r\n    }\r\n\r\n    columns.push(`max (${unit})`, `mean (${unit})`, `std (${unit})`, 'Area', 'Unit');\r\n    values.push(max, mean, stdDev, area, areaUnit);\r\n  });\r\n\r\n  if (FrameOfReferenceUID) {\r\n    columns.push('FrameOfReferenceUID');\r\n    values.push(FrameOfReferenceUID);\r\n  }\r\n\r\n  if (points) {\r\n    columns.push('points');\r\n    // points has the form of [[x1, y1, z1], [x2, y2, z2], ...]\r\n    // convert it to string of [[x1 y1 z1];[x2 y2 z2];...]\r\n    // so that it can be used in the csv report\r\n    values.push(points.map(p => p.join(' ')).join(';'));\r\n  }\r\n\r\n  return {\r\n    columns,\r\n    values,\r\n  };\r\n}\r\n\r\nfunction getDisplayText(mappedAnnotations, displaySet, customizationService) {\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: [],\r\n  };\r\n\r\n  if (!mappedAnnotations || !mappedAnnotations.length) {\r\n    return displayText;\r\n  }\r\n\r\n  // Area is the same for all series\r\n  const { area, SOPInstanceUID, frameNumber, areaUnit } = mappedAnnotations[0];\r\n\r\n  const instance = displaySet.instances.find(image => image.SOPInstanceUID === SOPInstanceUID);\r\n\r\n  let InstanceNumber;\r\n  if (instance) {\r\n    InstanceNumber = instance.InstanceNumber;\r\n  }\r\n\r\n  const instanceText = InstanceNumber ? ` I: ${InstanceNumber}` : '';\r\n  const frameText = displaySet.isMultiFrame ? ` F: ${frameNumber}` : '';\r\n\r\n  const roundedArea = utils.roundNumber(area, 2);\r\n  displayText.primary.push(`${roundedArea} ${getDisplayUnit(areaUnit)}`);\r\n\r\n  // Todo: we need a better UI for displaying all these information\r\n  mappedAnnotations.forEach(mappedAnnotation => {\r\n    const { unit, max, SeriesNumber } = mappedAnnotation;\r\n\r\n    const maxStr = getStatisticDisplayString(max, unit, 'max');\r\n    displayText.primary.push(maxStr);\r\n    displayText.secondary.push(`S: ${SeriesNumber}${instanceText}${frameText}`);\r\n  });\r\n\r\n  return displayText;\r\n}\r\n\r\nexport default EllipticalROI;\r\n","import SUPPORTED_TOOLS from './constants/supportedTools';\r\nimport { getIsLocked } from './utils/getIsLocked';\r\nimport { getIsVisible } from './utils/getIsVisible';\r\nimport getSOPInstanceAttributes from './utils/getSOPInstanceAttributes';\r\nimport { utils } from '@ohif/core';\r\nimport { config } from '@cornerstonejs/tools/annotation';\r\n\r\nconst Length = {\r\n  toAnnotation: measurement => {},\r\n\r\n  /**\r\n   * Maps cornerstone annotation event data to measurement service format.\r\n   *\r\n   * @param {Object} cornerstone Cornerstone event data\r\n   * @return {Measurement} Measurement instance\r\n   */\r\n  toMeasurement: (\r\n    csToolsEventDetail,\r\n    displaySetService,\r\n    cornerstoneViewportService,\r\n    getValueTypeFromToolType,\r\n    customizationService\r\n  ) => {\r\n    const { annotation } = csToolsEventDetail;\r\n    const { metadata, data, annotationUID } = annotation;\r\n\r\n    const isLocked = getIsLocked(annotationUID);\r\n    const isVisible = getIsVisible(annotationUID);\r\n    // const colorString = config.style.getStyleProperty('color', { annotationUID });\r\n\r\n    // color string is like 'rgb(255, 255, 255)' we need them to be in RGBA array [255, 255, 255, 255]\r\n    // Todo: this should be in a utility\r\n    // const color = colorString.replace('rgb(', '').replace(')', '').split(',').map(Number);\r\n\r\n    if (!metadata || !data) {\r\n      console.warn('Length tool: Missing metadata or data');\r\n      return null;\r\n    }\r\n\r\n    const { toolName, referencedImageId, FrameOfReferenceUID } = metadata;\r\n    const validToolType = SUPPORTED_TOOLS.includes(toolName);\r\n\r\n    if (!validToolType) {\r\n      throw new Error('Tool not supported');\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, StudyInstanceUID } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    let displaySet;\r\n\r\n    if (SOPInstanceUID) {\r\n      displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n        SOPInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n    } else {\r\n      displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n    }\r\n\r\n    const { points, textBox } = data.handles;\r\n\r\n    const mappedAnnotations = getMappedAnnotations(annotation, displaySetService);\r\n\r\n    const displayText = getDisplayText(mappedAnnotations, displaySet);\r\n    const getReport = () =>\r\n      _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService);\r\n\r\n    return {\r\n      uid: annotationUID,\r\n      SOPInstanceUID,\r\n      FrameOfReferenceUID,\r\n      points,\r\n      textBox,\r\n      isLocked,\r\n      isVisible,\r\n      metadata,\r\n      // color,\r\n      referenceSeriesUID: SeriesInstanceUID,\r\n      referenceStudyUID: StudyInstanceUID,\r\n      referencedImageId,\r\n      frameNumber: mappedAnnotations[0]?.frameNumber || 1,\r\n      toolName: metadata.toolName,\r\n      displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n      label: data.label,\r\n      displayText: displayText,\r\n      data: data.cachedStats,\r\n      type: getValueTypeFromToolType(toolName),\r\n      getReport,\r\n    };\r\n  },\r\n};\r\n\r\nfunction getMappedAnnotations(annotation, displaySetService) {\r\n  const { metadata, data } = annotation;\r\n  const { cachedStats } = data;\r\n  const { referencedImageId } = metadata;\r\n  const targets = Object.keys(cachedStats);\r\n\r\n  if (!targets.length) {\r\n    return [];\r\n  }\r\n\r\n  const annotations = [];\r\n  Object.keys(cachedStats).forEach(targetId => {\r\n    const targetStats = cachedStats[targetId];\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    const displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n\r\n    const { SeriesNumber } = displaySet;\r\n    const { length, unit = 'mm' } = targetStats;\r\n\r\n    annotations.push({\r\n      SeriesInstanceUID,\r\n      SOPInstanceUID,\r\n      SeriesNumber,\r\n      frameNumber,\r\n      unit,\r\n      length,\r\n    });\r\n  });\r\n\r\n  return annotations;\r\n}\r\n\r\n/*\r\nThis function is used to convert the measurement data to a format that is\r\nsuitable for the report generation (e.g. for the csv report). The report\r\nreturns a list of columns and corresponding values.\r\n*/\r\nfunction _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService) {\r\n  const columns = [];\r\n  const values = [];\r\n\r\n  // Add Type\r\n  columns.push('AnnotationType');\r\n  values.push('Cornerstone:Length');\r\n\r\n  mappedAnnotations.forEach(annotation => {\r\n    const { length, unit } = annotation;\r\n    columns.push(`Length`);\r\n    values.push(length);\r\n    columns.push('Unit');\r\n    values.push(unit);\r\n  });\r\n\r\n  if (FrameOfReferenceUID) {\r\n    columns.push('FrameOfReferenceUID');\r\n    values.push(FrameOfReferenceUID);\r\n  }\r\n\r\n  if (points) {\r\n    columns.push('points');\r\n    // points has the form of [[x1, y1, z1], [x2, y2, z2], ...]\r\n    // convert it to string of [[x1 y1 z1];[x2 y2 z2];...]\r\n    // so that it can be used in the csv report\r\n    values.push(points.map(p => p.join(' ')).join(';'));\r\n  }\r\n\r\n  return {\r\n    columns,\r\n    values,\r\n  };\r\n}\r\n\r\nfunction getDisplayText(mappedAnnotations, displaySet) {\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: [],\r\n  };\r\n\r\n  if (!mappedAnnotations || !mappedAnnotations.length) {\r\n    return displayText;\r\n  }\r\n\r\n  // Length is the same for all series\r\n  const { length, SeriesNumber, SOPInstanceUID, frameNumber, unit } = mappedAnnotations[0];\r\n\r\n  const instance = displaySet.instances.find(image => image.SOPInstanceUID === SOPInstanceUID);\r\n\r\n  let InstanceNumber;\r\n  if (instance) {\r\n    InstanceNumber = instance.InstanceNumber;\r\n  }\r\n\r\n  const instanceText = InstanceNumber ? ` I: ${InstanceNumber}` : '';\r\n  const frameText = displaySet.isMultiFrame ? ` F: ${frameNumber}` : '';\r\n\r\n  if (length === null || length === undefined) {\r\n    return displayText;\r\n  }\r\n  const roundedLength = utils.roundNumber(length, 2);\r\n  displayText.primary.push(`${roundedLength} ${unit}`);\r\n  displayText.secondary.push(`S: ${SeriesNumber}${instanceText}${frameText}`);\r\n\r\n  return displayText;\r\n}\r\n\r\nexport default Length;\r\n","import SUPPORTED_TOOLS from './constants/supportedTools';\r\nimport getSOPInstanceAttributes from './utils/getSOPInstanceAttributes';\r\nimport { getDisplayUnit } from './utils';\r\nimport { utils } from '@ohif/core';\r\nimport { getIsLocked } from './utils/getIsLocked';\r\nimport { getIsVisible } from './utils/getIsVisible';\r\n/**\r\n * Represents a mapping utility for Livewire measurements.\r\n */\r\nconst LivewireContour = {\r\n  toAnnotation: measurement => {},\r\n\r\n  /**\r\n   * Maps cornerstone annotation event data to measurement service format.\r\n   *\r\n   * @param {Object} csToolsEventDetail Cornerstone event data\r\n   * @param {DisplaySetService} DisplaySetService Service for managing display sets\r\n   * @param {CornerstoneViewportService} CornerstoneViewportService Service for managing viewports\r\n   * @param {Function} getValueTypeFromToolType Function to get value type from tool type\r\n   * @returns {Measurement} Measurement instance\r\n   */\r\n  toMeasurement: (\r\n    csToolsEventDetail,\r\n    displaySetService,\r\n    CornerstoneViewportService,\r\n    getValueTypeFromToolType,\r\n    customizationService\r\n  ) => {\r\n    const { annotation } = csToolsEventDetail;\r\n    const { metadata, data, annotationUID } = annotation;\r\n\r\n    const isLocked = getIsLocked(annotationUID);\r\n    const isVisible = getIsVisible(annotationUID);\r\n    if (!metadata || !data) {\r\n      console.warn('Livewire tool: Missing metadata or data');\r\n      return null;\r\n    }\r\n\r\n    const { toolName, referencedImageId, FrameOfReferenceUID } = metadata;\r\n    const validToolType = SUPPORTED_TOOLS.includes(toolName);\r\n    if (!validToolType) {\r\n      throw new Error(`Tool ${toolName} not supported`);\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber, StudyInstanceUID } =\r\n      getSOPInstanceAttributes(referencedImageId, displaySetService, annotation);\r\n\r\n    let displaySet;\r\n    if (SOPInstanceUID) {\r\n      displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n        SOPInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n    } else {\r\n      displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID);\r\n    }\r\n\r\n    return {\r\n      uid: annotationUID,\r\n      SOPInstanceUID,\r\n      FrameOfReferenceUID,\r\n      points: data.contour.polyline,\r\n      textBox: data.handles.textBox,\r\n      metadata,\r\n      frameNumber,\r\n      referenceSeriesUID: SeriesInstanceUID,\r\n      referencedImageId,\r\n      referenceStudyUID: StudyInstanceUID,\r\n      toolName: metadata.toolName,\r\n      displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n      label: data.label,\r\n      isLocked,\r\n      isVisible,\r\n      displayText: getDisplayText(annotation, displaySet, displaySetService),\r\n      data: data.cachedStats,\r\n      type: getValueTypeFromToolType(toolName),\r\n      getReport: () => getColumnValueReport(annotation, customizationService),\r\n    };\r\n  },\r\n};\r\n\r\n/**\r\n * This function is used to convert the measurement data to a\r\n * format that is suitable for report generation (e.g. for the csv report).\r\n * The report returns a list of columns and corresponding values.\r\n *\r\n * @param {object} annotation\r\n * @returns {object} Report's content from this tool\r\n */\r\nfunction getColumnValueReport(annotation, customizationService) {\r\n  const columns = [];\r\n  const values = [];\r\n\r\n  /** Add type */\r\n  columns.push('AnnotationType');\r\n  values.push('Cornerstone:Livewire');\r\n\r\n  /** Add cachedStats */\r\n  const { metadata, data } = annotation;\r\n\r\n  /** Add FOR */\r\n  if (metadata.FrameOfReferenceUID) {\r\n    columns.push('FrameOfReferenceUID');\r\n    values.push(metadata.FrameOfReferenceUID);\r\n  }\r\n\r\n  /** Add points */\r\n  if (data.contour.polyline) {\r\n    /**\r\n     * Points has the form of [[x1, y1, z1], [x2, y2, z2], ...]\r\n     * convert it to string of [[x1 y1 z1];[x2 y2 z2];...]\r\n     * so that it can be used in the CSV report\r\n     */\r\n    columns.push('points');\r\n    values.push(data.contour.polyline.map(p => p.join(' ')).join(';'));\r\n  }\r\n\r\n  return { columns, values };\r\n}\r\n\r\n/**\r\n * Retrieves the display text for an annotation in a display set.\r\n *\r\n * @param {Object} annotation - The annotation object.\r\n * @param {Object} displaySet - The display set object.\r\n * @returns {object} - An object with primary and secondary text arrays.\r\n */\r\nfunction getDisplayText(annotation, displaySet, displaySetService) {\r\n  const { metadata, data } = annotation;\r\n\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: [],\r\n  };\r\n\r\n  if (!data.cachedStats || !data.cachedStats[`imageId:${metadata.referencedImageId}`]) {\r\n    return displayText;\r\n  }\r\n\r\n  const { area, areaUnit } = data.cachedStats[`imageId:${metadata.referencedImageId}`];\r\n\r\n  const { SOPInstanceUID, frameNumber } = getSOPInstanceAttributes(\r\n    metadata.referencedImageId,\r\n    displaySetService,\r\n    annotation\r\n  );\r\n\r\n  const instance = displaySet.instances.find(image => image.SOPInstanceUID === SOPInstanceUID);\r\n  let InstanceNumber;\r\n  if (instance) {\r\n    InstanceNumber = instance.InstanceNumber;\r\n  }\r\n\r\n  const instanceText = InstanceNumber ? ` I: ${InstanceNumber}` : '';\r\n  const frameText = displaySet.isMultiFrame ? ` F: ${frameNumber}` : '';\r\n\r\n  const { SeriesNumber } = displaySet;\r\n  let seriesText = null;\r\n  if (SeriesNumber !== undefined) {\r\n    seriesText = `S: ${SeriesNumber}${instanceText}${frameText}`;\r\n  }\r\n\r\n  if (area) {\r\n    const roundedArea = utils.roundNumber(area || 0, 2);\r\n    displayText.primary.push(`${roundedArea} ${getDisplayUnit(areaUnit)}`);\r\n  }\r\n\r\n  if (seriesText) {\r\n    displayText.secondary.push(seriesText);\r\n  }\r\n\r\n  return displayText;\r\n}\r\n\r\nexport default LivewireContour;\r\n","import SUPPORTED_TOOLS from './constants/supportedTools';\r\nimport getSOPInstanceAttributes from './utils/getSOPInstanceAttributes';\r\nimport { utils } from '@ohif/core';\r\nimport { getIsLocked } from './utils/getIsLocked';\r\nimport { getIsVisible } from './utils/getIsVisible';\r\nimport { getDisplayUnit } from './utils';\r\nimport { getStatisticDisplayString } from './utils/getValueDisplayString';\r\n/**\r\n * Represents a mapping utility for Planar Freehand ROI measurements.\r\n */\r\nconst PlanarFreehandROI = {\r\n  toAnnotation: measurement => {},\r\n\r\n  /**\r\n   * Maps cornerstone annotation event data to measurement service format.\r\n   *\r\n   * @param {Object} csToolsEventDetail Cornerstone event data\r\n   * @param {DisplaySetService} displaySetService Service for managing display sets\r\n   * @param {CornerstoneViewportService} CornerstoneViewportService Service for managing viewports\r\n   * @param {Function} getValueTypeFromToolType Function to get value type from tool type\r\n   * @param {CustomizationService} customizationService Service for customization\r\n   * @returns {Measurement | null} Measurement instance or null if invalid\r\n   */\r\n  toMeasurement: (\r\n    csToolsEventDetail,\r\n    displaySetService,\r\n    CornerstoneViewportService,\r\n    getValueTypeFromToolType,\r\n    customizationService\r\n  ) => {\r\n    const { annotation } = csToolsEventDetail;\r\n    const { metadata, data, annotationUID } = annotation;\r\n\r\n    const isLocked = getIsLocked(annotationUID);\r\n    const isVisible = getIsVisible(annotationUID);\r\n    if (!metadata || !data) {\r\n      console.debug('PlanarFreehandROI tool: Missing metadata or data');\r\n      return null;\r\n    }\r\n\r\n    const { toolName, referencedImageId, FrameOfReferenceUID } = metadata;\r\n    const validToolType = SUPPORTED_TOOLS.includes(toolName);\r\n    if (!validToolType) {\r\n      throw new Error(`Tool ${toolName} not supported`);\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber, StudyInstanceUID } =\r\n      getSOPInstanceAttributes(referencedImageId, displaySetService, annotation);\r\n\r\n    let displaySet;\r\n    if (SOPInstanceUID) {\r\n      displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n        SOPInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n    } else {\r\n      displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n    }\r\n\r\n    const mappedAnnotations = getMappedAnnotations(annotation, displaySetService);\r\n    const displayText = getDisplayText(mappedAnnotations, displaySet);\r\n\r\n    return {\r\n      uid: annotationUID,\r\n      SOPInstanceUID,\r\n      FrameOfReferenceUID,\r\n      points: data.contour.polyline,\r\n      textBox: data.handles.textBox,\r\n      metadata,\r\n      frameNumber,\r\n      referenceSeriesUID: SeriesInstanceUID,\r\n      referenceStudyUID: StudyInstanceUID,\r\n      referencedImageId,\r\n      toolName: metadata.toolName,\r\n      displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n      label: data.label,\r\n      displayText: displayText,\r\n      data: data.cachedStats,\r\n      type: getValueTypeFromToolType(toolName),\r\n      getReport: () => getColumnValueReport(annotation, customizationService),\r\n      isLocked,\r\n      isVisible,\r\n    };\r\n  },\r\n};\r\n\r\n/**\r\n * Maps annotations to a structured format with relevant attributes.\r\n *\r\n * @param {Object} annotation The annotation object.\r\n * @param {DisplaySetService} displaySetService Service for managing display sets.\r\n * @returns {Array} Mapped annotations.\r\n */\r\nfunction getMappedAnnotations(annotation, displaySetService) {\r\n  const { metadata, data } = annotation;\r\n  const { cachedStats } = data;\r\n  const { referencedImageId } = metadata;\r\n  const targets = Object.keys(cachedStats);\r\n\r\n  if (!targets.length) {\r\n    return [];\r\n  }\r\n\r\n  const annotations = [];\r\n  Object.keys(cachedStats).forEach(targetId => {\r\n    const targetStats = cachedStats[targetId];\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    const displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n\r\n    const { SeriesNumber } = displaySet;\r\n    const { mean, stdDev, max, area, Modality, areaUnit, modalityUnit } = targetStats;\r\n\r\n    annotations.push({\r\n      SeriesInstanceUID,\r\n      SOPInstanceUID,\r\n      SeriesNumber,\r\n      frameNumber,\r\n      Modality,\r\n      unit: modalityUnit,\r\n      mean,\r\n      stdDev,\r\n      max,\r\n      area,\r\n      areaUnit,\r\n    });\r\n  });\r\n\r\n  return annotations;\r\n}\r\n\r\n/**\r\n * Converts the measurement data to a format suitable for report generation.\r\n *\r\n * @param {object} annotation The annotation object.\r\n * @param {CustomizationService} customizationService Service for customization.\r\n * @returns {object} Report's content.\r\n */\r\nfunction getColumnValueReport(annotation, customizationService) {\r\n  const { PlanarFreehandROI } = customizationService.getCustomization('cornerstone.measurements');\r\n  const { report } = PlanarFreehandROI;\r\n  const columns = [];\r\n  const values = [];\r\n\r\n  /** Add type */\r\n  columns.push('AnnotationType');\r\n  values.push('Cornerstone:PlanarFreehandROI');\r\n\r\n  /** Add cachedStats */\r\n  const { metadata, data } = annotation;\r\n  const stats = data.cachedStats[`imageId:${metadata.referencedImageId}`];\r\n\r\n  report.forEach(({ name, value }) => {\r\n    columns.push(name);\r\n    stats[value] ? values.push(stats[value]) : values.push('not available');\r\n  });\r\n\r\n  /** Add FOR */\r\n  if (metadata.FrameOfReferenceUID) {\r\n    columns.push('FrameOfReferenceUID');\r\n    values.push(metadata.FrameOfReferenceUID);\r\n  }\r\n\r\n  /** Add points */\r\n  if (data.contour.polyline) {\r\n    columns.push('points');\r\n    values.push(data.contour.polyline.map(p => p.join(' ')).join(';'));\r\n  }\r\n\r\n  return { columns, values };\r\n}\r\n\r\n/**\r\n * Retrieves the display text for an annotation in a display set.\r\n *\r\n * @param {Array} mappedAnnotations The mapped annotations.\r\n * @param {Object} displaySet The display set object.\r\n * @returns {Object} Display text with primary and secondary information.\r\n */\r\nfunction getDisplayText(mappedAnnotations, displaySet) {\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: [],\r\n  };\r\n\r\n  if (!mappedAnnotations || !mappedAnnotations.length) {\r\n    return displayText;\r\n  }\r\n\r\n  // Area is the same for all series\r\n  const { area, SOPInstanceUID, frameNumber, areaUnit } = mappedAnnotations[0];\r\n\r\n  const instance = displaySet.instances.find(image => image.SOPInstanceUID === SOPInstanceUID);\r\n\r\n  let InstanceNumber;\r\n  if (instance) {\r\n    InstanceNumber = instance.InstanceNumber;\r\n  }\r\n\r\n  const instanceText = InstanceNumber ? ` I: ${InstanceNumber}` : '';\r\n  const frameText = displaySet.isMultiFrame ? ` F: ${frameNumber}` : '';\r\n\r\n  const roundedArea = utils.roundNumber(area || 0, 2);\r\n  displayText.primary.push(`${roundedArea} ${getDisplayUnit(areaUnit)}`);\r\n\r\n  mappedAnnotations.forEach(mappedAnnotation => {\r\n    const { unit, max, SeriesNumber } = mappedAnnotation;\r\n\r\n    const maxStr = getStatisticDisplayString(max, unit, 'max');\r\n\r\n    displayText.primary.push(maxStr);\r\n    displayText.secondary.push(`S: ${SeriesNumber}${instanceText}${frameText}`);\r\n  });\r\n\r\n  return displayText;\r\n}\r\n\r\nexport default PlanarFreehandROI;\r\n","import SUPPORTED_TOOLS from './constants/supportedTools';\r\nimport { getDisplayUnit } from './utils';\r\nimport getSOPInstanceAttributes from './utils/getSOPInstanceAttributes';\r\nimport { utils } from '@ohif/core';\r\nimport { getIsLocked } from './utils/getIsLocked';\r\nimport { getIsVisible } from './utils/getIsVisible';\r\nconst Probe = {\r\n  toAnnotation: measurement => {},\r\n\r\n  /**\r\n   * Maps cornerstone annotation event data to measurement service format.\r\n   *\r\n   * @param {Object} cornerstone Cornerstone event data\r\n   * @return {Measurement} Measurement instance\r\n   */\r\n  toMeasurement: (\r\n    csToolsEventDetail,\r\n    displaySetService,\r\n    CornerstoneViewportService,\r\n    getValueTypeFromToolType,\r\n    customizationService\r\n  ) => {\r\n    const { annotation } = csToolsEventDetail;\r\n    const { metadata, data, annotationUID } = annotation;\r\n    const isLocked = getIsLocked(annotationUID);\r\n    const isVisible = getIsVisible(annotationUID);\r\n    if (!metadata || !data) {\r\n      console.warn('Probe tool: Missing metadata or data');\r\n      return null;\r\n    }\r\n\r\n    const { toolName, referencedImageId, FrameOfReferenceUID } = metadata;\r\n    const validToolType = SUPPORTED_TOOLS.includes(toolName);\r\n\r\n    if (!validToolType) {\r\n      throw new Error('Tool not supported');\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, StudyInstanceUID } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    let displaySet;\r\n\r\n    if (SOPInstanceUID) {\r\n      displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n        SOPInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n    } else {\r\n      displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n    }\r\n\r\n    const { points } = data.handles;\r\n\r\n    const mappedAnnotations = getMappedAnnotations(annotation, displaySetService);\r\n\r\n    const displayText = getDisplayText(mappedAnnotations, displaySet, customizationService);\r\n    const getReport = () =>\r\n      _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService);\r\n\r\n    return {\r\n      uid: annotationUID,\r\n      SOPInstanceUID,\r\n      FrameOfReferenceUID,\r\n      points,\r\n      metadata,\r\n      isLocked,\r\n      isVisible,\r\n      referenceSeriesUID: SeriesInstanceUID,\r\n      referenceStudyUID: StudyInstanceUID,\r\n      referencedImageId,\r\n      frameNumber: mappedAnnotations?.[0]?.frameNumber || 1,\r\n      toolName: metadata.toolName,\r\n      displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n      label: data.label,\r\n      displayText: displayText,\r\n      data: data.cachedStats,\r\n      type: getValueTypeFromToolType(toolName),\r\n      getReport,\r\n    };\r\n  },\r\n};\r\n\r\nfunction getMappedAnnotations(annotation, displaySetService) {\r\n  const { metadata, data } = annotation;\r\n  const { cachedStats } = data;\r\n  const { referencedImageId } = metadata;\r\n  const targets = Object.keys(cachedStats);\r\n\r\n  if (!targets.length) {\r\n    return;\r\n  }\r\n\r\n  const annotations = [];\r\n  Object.keys(cachedStats).forEach(targetId => {\r\n    const targetStats = cachedStats[targetId];\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    const displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n\r\n    const { SeriesNumber } = displaySet;\r\n    const { value } = targetStats;\r\n    const unit = 'HU';\r\n\r\n    annotations.push({\r\n      SeriesInstanceUID,\r\n      SOPInstanceUID,\r\n      SeriesNumber,\r\n      frameNumber,\r\n      unit,\r\n      value,\r\n    });\r\n  });\r\n\r\n  return annotations;\r\n}\r\n\r\n/*\r\nThis function is used to convert the measurement data to a format that is\r\nsuitable for the report generation (e.g. for the csv report). The report\r\nreturns a list of columns and corresponding values.\r\n*/\r\nfunction _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService) {\r\n  const columns = [];\r\n  const values = [];\r\n\r\n  // Add Type\r\n  columns.push('AnnotationType');\r\n  values.push('Cornerstone:Probe');\r\n\r\n  mappedAnnotations.forEach(annotation => {\r\n    const { value, unit } = annotation;\r\n    columns.push(`Probe (${unit})`);\r\n    values.push(value);\r\n  });\r\n\r\n  if (FrameOfReferenceUID) {\r\n    columns.push('FrameOfReferenceUID');\r\n    values.push(FrameOfReferenceUID);\r\n  }\r\n\r\n  if (points) {\r\n    columns.push('points');\r\n    values.push(points.map(p => p.join(' ')).join(';'));\r\n  }\r\n\r\n  return {\r\n    columns,\r\n    values,\r\n  };\r\n}\r\n\r\nfunction getDisplayText(mappedAnnotations, displaySet, customizationService) {\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: [],\r\n  };\r\n\r\n  if (!mappedAnnotations || !mappedAnnotations.length) {\r\n    return displayText;\r\n  }\r\n\r\n  const { value, unit, SeriesNumber, SOPInstanceUID, frameNumber } = mappedAnnotations[0];\r\n\r\n  const instance = displaySet.instances.find(image => image.SOPInstanceUID === SOPInstanceUID);\r\n\r\n  let InstanceNumber;\r\n  if (instance) {\r\n    InstanceNumber = instance.InstanceNumber;\r\n  }\r\n\r\n  const instanceText = InstanceNumber ? ` I: ${InstanceNumber}` : '';\r\n  const frameText = displaySet.isMultiFrame ? ` F: ${frameNumber}` : '';\r\n\r\n  if (value !== undefined) {\r\n    const roundedValue = utils.roundNumber(value, 2);\r\n    displayText.primary.push(`${roundedValue} ${getDisplayUnit(unit)}`);\r\n    displayText.secondary.push(`S: ${SeriesNumber}${instanceText}${frameText}`);\r\n  }\r\n\r\n  return displayText;\r\n}\r\n\r\nexport default Probe;\r\n","import SUPPORTED_TOOLS from './constants/supportedTools';\r\nimport { getDisplayUnit } from './utils';\r\nimport getSOPInstanceAttributes from './utils/getSOPInstanceAttributes';\r\nimport { utils } from '@ohif/core';\r\nimport { getStatisticDisplayString } from './utils/getValueDisplayString';\r\nimport { getIsLocked } from './utils/getIsLocked';\r\nimport { getIsVisible } from './utils/getIsVisible';\r\n\r\nconst RectangleROI = {\r\n  toAnnotation: measurement => {},\r\n  toMeasurement: (\r\n    csToolsEventDetail,\r\n    displaySetService,\r\n    CornerstoneViewportService,\r\n    getValueTypeFromToolType,\r\n    customizationService\r\n  ) => {\r\n    const { annotation } = csToolsEventDetail;\r\n    const { metadata, data, annotationUID } = annotation;\r\n    const isLocked = getIsLocked(annotationUID);\r\n    const isVisible = getIsVisible(annotationUID);\r\n\r\n    if (!metadata || !data) {\r\n      console.warn('Rectangle ROI tool: Missing metadata or data');\r\n      return null;\r\n    }\r\n\r\n    const { toolName, referencedImageId, FrameOfReferenceUID } = metadata;\r\n    const validToolType = SUPPORTED_TOOLS.includes(toolName);\r\n\r\n    if (!validToolType) {\r\n      throw new Error('Tool not supported');\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, StudyInstanceUID } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    let displaySet;\r\n\r\n    if (SOPInstanceUID) {\r\n      displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n        SOPInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n    } else {\r\n      displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n    }\r\n\r\n    const { points, textBox } = data.handles;\r\n\r\n    const mappedAnnotations = getMappedAnnotations(annotation, displaySetService);\r\n\r\n    const displayText = getDisplayText(mappedAnnotations, displaySet, customizationService);\r\n    const getReport = () =>\r\n      _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService);\r\n\r\n    return {\r\n      uid: annotationUID,\r\n      SOPInstanceUID,\r\n      FrameOfReferenceUID,\r\n      points,\r\n      textBox,\r\n      metadata,\r\n      referenceSeriesUID: SeriesInstanceUID,\r\n      referenceStudyUID: StudyInstanceUID,\r\n      referencedImageId,\r\n      frameNumber: mappedAnnotations[0]?.frameNumber || 1,\r\n      toolName: metadata.toolName,\r\n      displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n      label: data.label,\r\n      displayText: displayText,\r\n      data: data.cachedStats,\r\n      type: getValueTypeFromToolType(toolName),\r\n      getReport,\r\n      isLocked,\r\n      isVisible,\r\n    };\r\n  },\r\n};\r\n\r\nfunction getMappedAnnotations(annotation, displaySetService) {\r\n  const { metadata, data } = annotation;\r\n  const { cachedStats } = data;\r\n  const { referencedImageId } = metadata;\r\n  const targets = Object.keys(cachedStats);\r\n\r\n  if (!targets.length) {\r\n    return [];\r\n  }\r\n\r\n  const annotations = [];\r\n\r\n  const addedModalities = new Set();\r\n  Object.keys(cachedStats).forEach(targetId => {\r\n    const targetStats = cachedStats[targetId];\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    const displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n\r\n    const { SeriesNumber } = displaySet;\r\n    const { mean, stdDev, max, area, Modality, modalityUnit, areaUnit } = targetStats;\r\n\r\n    // Skip if we've already added this modality\r\n    if (Modality && addedModalities.has(Modality)) {\r\n      return;\r\n    }\r\n\r\n    // Add modality to the set if it exists\r\n    if (Modality) {\r\n      addedModalities.add(Modality);\r\n    }\r\n\r\n    annotations.push({\r\n      SeriesInstanceUID,\r\n      SOPInstanceUID,\r\n      SeriesNumber,\r\n      frameNumber,\r\n      Modality,\r\n      unit: modalityUnit,\r\n      mean,\r\n      stdDev,\r\n      metadata,\r\n      max,\r\n      area,\r\n      areaUnit,\r\n    });\r\n  });\r\n\r\n  return annotations;\r\n}\r\n\r\n/*\r\nThis function is used to convert the measurement data to a format that is\r\nsuitable for the report generation (e.g. for the csv report). The report\r\nreturns a list of columns and corresponding values.\r\n*/\r\nfunction _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService) {\r\n  const columns = [];\r\n  const values = [];\r\n\r\n  // Add Type\r\n  columns.push('AnnotationType');\r\n  values.push('Cornerstone:RectangleROI');\r\n\r\n  mappedAnnotations.forEach(annotation => {\r\n    const { mean, stdDev, max, area, unit, areaUnit } = annotation;\r\n\r\n    if (!mean || !unit || !max || !area) {\r\n      return;\r\n    }\r\n\r\n    columns.push(`Maximum`, `Mean`, `Std Dev`, 'Pixel Unit', `Area`, 'Unit');\r\n    values.push(max, mean, stdDev, unit, area, areaUnit);\r\n  });\r\n\r\n  if (FrameOfReferenceUID) {\r\n    columns.push('FrameOfReferenceUID');\r\n    values.push(FrameOfReferenceUID);\r\n  }\r\n\r\n  if (points) {\r\n    columns.push('points');\r\n    // points has the form of [[x1, y1, z1], [x2, y2, z2], ...]\r\n    // convert it to string of [[x1 y1 z1];[x2 y2 z2];...]\r\n    // so that it can be used in the csv report\r\n    values.push(points.map(p => p.join(' ')).join(';'));\r\n  }\r\n\r\n  return {\r\n    columns,\r\n    values,\r\n  };\r\n}\r\n\r\nfunction getDisplayText(mappedAnnotations, displaySet, customizationService) {\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: [],\r\n  };\r\n\r\n  if (!mappedAnnotations || !mappedAnnotations.length) {\r\n    return displayText;\r\n  }\r\n\r\n  // Area is the same for all series\r\n  const { area, SOPInstanceUID, frameNumber, areaUnit } = mappedAnnotations[0];\r\n\r\n  const instance = displaySet.instances.find(image => image.SOPInstanceUID === SOPInstanceUID);\r\n\r\n  let InstanceNumber;\r\n  if (instance) {\r\n    InstanceNumber = instance.InstanceNumber;\r\n  }\r\n\r\n  const instanceText = InstanceNumber ? ` I: ${InstanceNumber}` : '';\r\n  const frameText = displaySet.isMultiFrame ? ` F: ${frameNumber}` : '';\r\n\r\n  // Area sometimes becomes undefined if `preventHandleOutsideImage` is off.\r\n  const roundedArea = utils.roundNumber(area || 0, 2);\r\n  displayText.primary.push(`${roundedArea} ${getDisplayUnit(areaUnit)}`);\r\n\r\n  // Todo: we need a better UI for displaying all these information\r\n  mappedAnnotations.forEach(mappedAnnotation => {\r\n    const { unit, max, SeriesNumber } = mappedAnnotation;\r\n\r\n    const maxStr = getStatisticDisplayString(max, unit, 'max');\r\n\r\n    displayText.primary.push(maxStr);\r\n    displayText.secondary.push(`S: ${SeriesNumber}${instanceText}${frameText}`);\r\n  });\r\n\r\n  return displayText;\r\n}\r\n\r\nexport default RectangleROI;\r\n","import SUPPORTED_TOOLS from './constants/supportedTools';\r\nimport getSOPInstanceAttributes from './utils/getSOPInstanceAttributes';\r\nimport { utils } from '@ohif/core';\r\nimport { getDisplayUnit } from './utils';\r\nimport { getIsLocked } from './utils/getIsLocked';\r\nimport { getIsVisible } from './utils/getIsVisible';\r\n\r\nconst SegmentBidirectional = {\r\n  toAnnotation: measurement => {},\r\n  toMeasurement: (\r\n    csToolsEventDetail,\r\n    displaySetService,\r\n    cornerstoneViewportService,\r\n    getValueTypeFromToolType,\r\n    customizationService\r\n  ) => {\r\n    const { annotation } = csToolsEventDetail;\r\n    const { metadata, data, annotationUID } = annotation;\r\n    const isLocked = getIsLocked(annotationUID);\r\n    const isVisible = getIsVisible(annotationUID);\r\n\r\n    if (!metadata || !data) {\r\n      console.debug('SegmentBidirectional tool: Missing metadata or data');\r\n      return null;\r\n    }\r\n\r\n    const { toolName, referencedImageId, FrameOfReferenceUID } = metadata;\r\n    const validToolType = SUPPORTED_TOOLS.includes(toolName);\r\n\r\n    if (!validToolType) {\r\n      throw new Error('Tool not supported');\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, StudyInstanceUID } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    let displaySet;\r\n\r\n    if (SOPInstanceUID) {\r\n      displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n        SOPInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n    } else {\r\n      displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n    }\r\n\r\n    const { points, textBox } = data.handles;\r\n\r\n    const mappedAnnotations = getMappedAnnotations(annotation, displaySetService);\r\n\r\n    const displayText = getDisplayText(mappedAnnotations, displaySet);\r\n    const getReport = () =>\r\n      _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService);\r\n\r\n    return {\r\n      uid: annotationUID,\r\n      SOPInstanceUID,\r\n      FrameOfReferenceUID,\r\n      points,\r\n      textBox,\r\n      isLocked,\r\n      isVisible,\r\n      metadata,\r\n      referenceSeriesUID: SeriesInstanceUID,\r\n      referenceStudyUID: StudyInstanceUID,\r\n      referencedImageId,\r\n      frameNumber: mappedAnnotations[0]?.frameNumber || 1,\r\n      toolName: metadata.toolName,\r\n      displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n      label: data.label,\r\n      displayText: displayText,\r\n      data: data.cachedStats,\r\n      type: getValueTypeFromToolType(toolName),\r\n      getReport,\r\n    };\r\n  },\r\n};\r\n\r\nfunction getMappedAnnotations(annotation, displaySetService) {\r\n  const { metadata, data } = annotation;\r\n  const { cachedStats } = data;\r\n  const { referencedImageId } = metadata;\r\n  const targets = Object.keys(cachedStats);\r\n\r\n  if (!targets.length) {\r\n    return [];\r\n  }\r\n\r\n  const annotations = [];\r\n  Object.keys(cachedStats).forEach(targetId => {\r\n    const targetStats = cachedStats[targetId];\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    const displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n\r\n    const { SeriesNumber } = displaySet;\r\n    const { length, width, unit } = targetStats;\r\n\r\n    annotations.push({\r\n      SeriesInstanceUID,\r\n      SOPInstanceUID,\r\n      SeriesNumber,\r\n      frameNumber,\r\n      unit,\r\n      length,\r\n      width,\r\n    });\r\n  });\r\n\r\n  return annotations;\r\n}\r\n\r\nfunction _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService) {\r\n  const columns = [];\r\n  const values = [];\r\n\r\n  // Add Type\r\n  columns.push('AnnotationType');\r\n  values.push('Cornerstone:SegmentBidirectional');\r\n\r\n  mappedAnnotations.forEach(annotation => {\r\n    const { length, width, unit } = annotation;\r\n    columns.push(`Length`, `Width`, 'Unit');\r\n    values.push(length, width, unit);\r\n  });\r\n\r\n  if (FrameOfReferenceUID) {\r\n    columns.push('FrameOfReferenceUID');\r\n    values.push(FrameOfReferenceUID);\r\n  }\r\n\r\n  if (points) {\r\n    columns.push('points');\r\n    values.push(points.map(p => p.join(' ')).join(';'));\r\n  }\r\n\r\n  return {\r\n    columns,\r\n    values,\r\n  };\r\n}\r\n\r\nfunction getDisplayText(mappedAnnotations, displaySet) {\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: [],\r\n  };\r\n\r\n  if (!mappedAnnotations || !mappedAnnotations.length) {\r\n    return displayText;\r\n  }\r\n\r\n  // Area is the same for all series\r\n  const { length, width, unit, SeriesNumber, SOPInstanceUID, frameNumber } = mappedAnnotations[0];\r\n  const roundedLength = utils.roundNumber(length, 2);\r\n  const roundedWidth = utils.roundNumber(width, 2);\r\n\r\n  const instance = displaySet.instances.find(image => image.SOPInstanceUID === SOPInstanceUID);\r\n\r\n  let InstanceNumber;\r\n  if (instance) {\r\n    InstanceNumber = instance.InstanceNumber;\r\n  }\r\n\r\n  const instanceText = InstanceNumber ? ` I: ${InstanceNumber}` : '';\r\n  const frameText = displaySet.isMultiFrame ? ` F: ${frameNumber}` : '';\r\n\r\n  displayText.primary.push(`L: ${roundedLength} ${getDisplayUnit(unit)}`);\r\n  displayText.primary.push(`W: ${roundedWidth} ${getDisplayUnit(unit)}`);\r\n  displayText.secondary.push(`S: ${SeriesNumber}${instanceText}${frameText}`);\r\n\r\n  return displayText;\r\n}\r\n\r\nexport default SegmentBidirectional;\r\n","import SUPPORTED_TOOLS from './constants/supportedTools';\r\nimport getSOPInstanceAttributes from './utils/getSOPInstanceAttributes';\r\nimport { utils } from '@ohif/core';\r\nimport { getIsLocked } from './utils/getIsLocked';\r\nimport { getIsVisible } from './utils/getIsVisible';\r\nimport { getDisplayUnit } from './utils';\r\nimport { getStatisticDisplayString } from './utils/getValueDisplayString';\r\n\r\n/**\r\n * Represents a mapping utility for Spline ROI measurements.\r\n */\r\nconst SplineROI = {\r\n  toAnnotation: measurement => {\r\n    // Implementation for converting measurement to annotation\r\n  },\r\n\r\n  /**\r\n   * Maps cornerstone annotation event data to measurement service format.\r\n   *\r\n   * @param {Object} csToolsEventDetail - Cornerstone event data\r\n   * @param {DisplaySetService} displaySetService - Service for managing display sets\r\n   * @param {CornerstoneViewportService} CornerstoneViewportService - Service for managing viewports\r\n   * @param {Function} getValueTypeFromToolType - Function to get value type from tool type\r\n   * @param {CustomizationService} customizationService - Service for customization\r\n   * @returns {Measurement | null} Measurement instance or null if invalid\r\n   */\r\n  toMeasurement: (\r\n    csToolsEventDetail,\r\n    displaySetService,\r\n    CornerstoneViewportService,\r\n    getValueTypeFromToolType,\r\n    customizationService\r\n  ) => {\r\n    const { annotation } = csToolsEventDetail;\r\n    const { metadata, data, annotationUID } = annotation;\r\n\r\n    const isLocked = getIsLocked(annotationUID);\r\n    const isVisible = getIsVisible(annotationUID);\r\n    if (!metadata || !data) {\r\n      console.warn('SplineROI tool: Missing metadata or data');\r\n      return null;\r\n    }\r\n\r\n    const { toolName, referencedImageId, FrameOfReferenceUID } = metadata;\r\n    const validToolType = SUPPORTED_TOOLS.includes(toolName);\r\n    if (!validToolType) {\r\n      throw new Error(`Tool ${toolName} not supported`);\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber, StudyInstanceUID } =\r\n      getSOPInstanceAttributes(referencedImageId, displaySetService, annotation);\r\n\r\n    let displaySet;\r\n    if (SOPInstanceUID) {\r\n      displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n        SOPInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n    } else {\r\n      displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n    }\r\n\r\n    const mappedAnnotations = getMappedAnnotations(annotation, displaySetService);\r\n    const displayText = getDisplayText(mappedAnnotations, displaySet);\r\n\r\n    return {\r\n      uid: annotationUID,\r\n      SOPInstanceUID,\r\n      FrameOfReferenceUID,\r\n      points: data.contour.polyline,\r\n      textBox: data.handles.textBox,\r\n      metadata,\r\n      frameNumber,\r\n      referenceSeriesUID: SeriesInstanceUID,\r\n      referenceStudyUID: StudyInstanceUID,\r\n      referencedImageId,\r\n      toolName: metadata.toolName,\r\n      displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n      label: data.label,\r\n      displayText: displayText,\r\n      data: data.cachedStats,\r\n      type: getValueTypeFromToolType(toolName),\r\n      getReport: () => getColumnValueReport(annotation, customizationService),\r\n      isLocked,\r\n      isVisible,\r\n    };\r\n  },\r\n};\r\n\r\n/**\r\n * Maps annotations to a structured format with relevant attributes.\r\n *\r\n * @param {Object} annotation - The annotation object.\r\n * @param {DisplaySetService} displaySetService - Service for managing display sets.\r\n * @returns {Array} Mapped annotations.\r\n */\r\nfunction getMappedAnnotations(annotation, displaySetService) {\r\n  const { metadata, data } = annotation;\r\n  const { cachedStats } = data;\r\n  const { referencedImageId } = metadata;\r\n  const targets = Object.keys(cachedStats);\r\n\r\n  if (!targets.length) {\r\n    return [];\r\n  }\r\n\r\n  const annotations = [];\r\n  Object.keys(cachedStats).forEach(targetId => {\r\n    const targetStats = cachedStats[targetId];\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber } = getSOPInstanceAttributes(\r\n      referencedImageId,\r\n      displaySetService,\r\n      annotation\r\n    );\r\n\r\n    const displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID)[0];\r\n\r\n    const { SeriesNumber } = displaySet;\r\n    const { mean, stdDev, max, area, Modality, areaUnit, modalityUnit } = targetStats;\r\n\r\n    annotations.push({\r\n      SeriesInstanceUID,\r\n      SOPInstanceUID,\r\n      SeriesNumber,\r\n      frameNumber,\r\n      Modality,\r\n      unit: modalityUnit,\r\n      mean,\r\n      stdDev,\r\n      max,\r\n      area,\r\n      areaUnit,\r\n    });\r\n  });\r\n\r\n  return annotations;\r\n}\r\n\r\n/**\r\n * Converts the measurement data to a format suitable for report generation.\r\n *\r\n * @param {object} annotation - The annotation object.\r\n * @param {CustomizationService} customizationService - Service for customization.\r\n * @returns {object} Report's content.\r\n */\r\nfunction getColumnValueReport(annotation, customizationService) {\r\n  const { SplineROI } = customizationService.getCustomization('cornerstone.measurements');\r\n  const { report } = SplineROI;\r\n  const columns = [];\r\n  const values = [];\r\n\r\n  /** Add type */\r\n  columns.push('AnnotationType');\r\n  values.push('Cornerstone:SplineROI');\r\n\r\n  /** Add cachedStats */\r\n  const { metadata, data } = annotation;\r\n  const stats = data.cachedStats[`imageId:${metadata.referencedImageId}`];\r\n\r\n  report.forEach(({ name, value }) => {\r\n    columns.push(name);\r\n    stats[value] ? values.push(stats[value]) : values.push('not available');\r\n  });\r\n\r\n  /** Add FOR */\r\n  if (metadata.FrameOfReferenceUID) {\r\n    columns.push('FrameOfReferenceUID');\r\n    values.push(metadata.FrameOfReferenceUID);\r\n  }\r\n\r\n  /** Add points */\r\n  if (data.contour.polyline) {\r\n    columns.push('points');\r\n    values.push(data.contour.polyline.map(p => p.join(' ')).join(';'));\r\n  }\r\n\r\n  return { columns, values };\r\n}\r\n\r\n/**\r\n * Retrieves the display text for an annotation in a display set.\r\n *\r\n * @param {Array} mappedAnnotations - The mapped annotations.\r\n * @param {Object} displaySet - The display set object.\r\n * @returns {Object} Display text with primary and secondary information.\r\n */\r\nfunction getDisplayText(mappedAnnotations, displaySet) {\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: [],\r\n  };\r\n\r\n  if (!mappedAnnotations || !mappedAnnotations.length) {\r\n    return displayText;\r\n  }\r\n\r\n  // Area is the same for all series\r\n  const { area, SOPInstanceUID, frameNumber, areaUnit } = mappedAnnotations[0];\r\n\r\n  const instance = displaySet.instances.find(image => image.SOPInstanceUID === SOPInstanceUID);\r\n\r\n  let InstanceNumber;\r\n  if (instance) {\r\n    InstanceNumber = instance.InstanceNumber;\r\n  }\r\n\r\n  const instanceText = InstanceNumber ? ` I: ${InstanceNumber}` : '';\r\n  const frameText = displaySet.isMultiFrame ? ` F: ${frameNumber}` : '';\r\n\r\n  const roundedArea = utils.roundNumber(area || 0, 2);\r\n  displayText.primary.push(`${roundedArea} ${getDisplayUnit(areaUnit)}`);\r\n\r\n  // we don't have max yet for splines rois\r\n  // mappedAnnotations.forEach(mappedAnnotation => {\r\n  //   const { unit, max, SeriesNumber } = mappedAnnotation;\r\n\r\n  //   const maxStr = getStatisticDisplayString(max, unit, 'max');\r\n\r\n  //   displayText.primary.push(maxStr);\r\n  //   displayText.secondary.push(`S: ${SeriesNumber}${instanceText}${frameText}`);\r\n  // });\r\n\r\n  return displayText;\r\n}\r\n\r\nexport default SplineROI;\r\n","import SUPPORTED_TOOLS from './constants/supportedTools';\r\nimport getSOPInstanceAttributes from './utils/getSOPInstanceAttributes';\r\nimport { utils } from '@ohif/core';\r\nimport { getIsLocked } from './utils/getIsLocked';\r\nimport { getIsVisible } from './utils/getIsVisible';\r\nconst UltrasoundDirectional = {\r\n  toAnnotation: measurement => {},\r\n\r\n  /**\r\n   * Maps cornerstone annotation event data to measurement service format.\r\n   *\r\n   * @param {Object} cornerstone Cornerstone event data\r\n   * @return {Measurement} Measurement instance\r\n   */\r\n  toMeasurement: (\r\n    csToolsEventDetail,\r\n    displaySetService,\r\n    CornerstoneViewportService,\r\n    getValueTypeFromToolType,\r\n    customizationService\r\n  ) => {\r\n    const { annotation } = csToolsEventDetail;\r\n    const { metadata, data, annotationUID } = annotation;\r\n    const isLocked = getIsLocked(annotationUID);\r\n    const isVisible = getIsVisible(annotationUID);\r\n    if (!metadata || !data) {\r\n      console.warn('Length tool: Missing metadata or data');\r\n      return null;\r\n    }\r\n\r\n    const { toolName, referencedImageId, FrameOfReferenceUID } = metadata;\r\n    const validToolType = SUPPORTED_TOOLS.includes(toolName);\r\n\r\n    if (!validToolType) {\r\n      throw new Error('Tool not supported');\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, StudyInstanceUID } =\r\n      getSOPInstanceAttributes(referencedImageId);\r\n\r\n    let displaySet;\r\n\r\n    if (SOPInstanceUID) {\r\n      displaySet = displaySetService.getDisplaySetForSOPInstanceUID(\r\n        SOPInstanceUID,\r\n        SeriesInstanceUID\r\n      );\r\n    } else {\r\n      displaySet = displaySetService.getDisplaySetsForSeries(SeriesInstanceUID);\r\n    }\r\n\r\n    const { points } = data.handles;\r\n\r\n    const mappedAnnotations = getMappedAnnotations(annotation, displaySetService);\r\n\r\n    const displayText = getDisplayText(mappedAnnotations, displaySet, customizationService);\r\n    const getReport = () =>\r\n      _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService);\r\n\r\n    return {\r\n      uid: annotationUID,\r\n      SOPInstanceUID,\r\n      FrameOfReferenceUID,\r\n      points,\r\n      metadata,\r\n      referenceSeriesUID: SeriesInstanceUID,\r\n      referenceStudyUID: StudyInstanceUID,\r\n      frameNumber: mappedAnnotations?.[0]?.frameNumber || 1,\r\n      toolName: metadata.toolName,\r\n      displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n      label: data.label,\r\n      displayText: displayText,\r\n      data: data.cachedStats,\r\n      type: getValueTypeFromToolType(toolName),\r\n      getReport,\r\n      isLocked,\r\n      isVisible,\r\n    };\r\n  },\r\n};\r\n\r\nfunction getMappedAnnotations(annotation, DisplaySetService) {\r\n  const { metadata, data } = annotation;\r\n  const { cachedStats } = data;\r\n  const { referencedImageId } = metadata;\r\n  const targets = Object.keys(cachedStats);\r\n\r\n  if (!targets.length) {\r\n    return;\r\n  }\r\n\r\n  const annotations = [];\r\n  Object.keys(cachedStats).forEach(targetId => {\r\n    const targetStats = cachedStats[targetId];\r\n\r\n    if (!referencedImageId) {\r\n      throw new Error('Non-acquisition plane measurement mapping not supported');\r\n    }\r\n\r\n    const { SOPInstanceUID, SeriesInstanceUID, frameNumber } =\r\n      getSOPInstanceAttributes(referencedImageId);\r\n\r\n    const displaySet = DisplaySetService.getDisplaySetForSOPInstanceUID(\r\n      SOPInstanceUID,\r\n      SeriesInstanceUID,\r\n      frameNumber\r\n    );\r\n\r\n    const { SeriesNumber } = displaySet;\r\n    const { xValues, yValues, units, isUnitless, isHorizontal } = targetStats;\r\n\r\n    annotations.push({\r\n      SeriesInstanceUID,\r\n      SOPInstanceUID,\r\n      SeriesNumber,\r\n      frameNumber,\r\n      xValues,\r\n      yValues,\r\n      units,\r\n      isUnitless,\r\n      isHorizontal,\r\n    });\r\n  });\r\n\r\n  return annotations;\r\n}\r\n\r\n/*\r\nThis function is used to convert the measurement data to a format that is\r\nsuitable for the report generation (e.g. for the csv report). The report\r\nreturns a list of columns and corresponding values.\r\n*/\r\nfunction _getReport(mappedAnnotations, points, FrameOfReferenceUID, customizationService) {\r\n  const columns = [];\r\n  const values = [];\r\n\r\n  // Add Type\r\n  columns.push('AnnotationType');\r\n  values.push('Cornerstone:UltrasoundDirectional');\r\n\r\n  mappedAnnotations.forEach(annotation => {\r\n    const { xValues, yValues, units, isUnitless } = annotation;\r\n    if (isUnitless) {\r\n      columns.push('Length' + units[0]);\r\n      values.push(utils.roundNumber(xValues[0], 2));\r\n    } else {\r\n      const dist1 = Math.abs(xValues[1] - xValues[0]);\r\n      const dist2 = Math.abs(yValues[1] - yValues[0]);\r\n      columns.push('Time' + units[0]);\r\n      values.push(utils.roundNumber(dist1, 2));\r\n      columns.push('Length' + units[1]);\r\n      values.push(utils.roundNumber(dist2, 2));\r\n    }\r\n  });\r\n\r\n  if (FrameOfReferenceUID) {\r\n    columns.push('FrameOfReferenceUID');\r\n    values.push(FrameOfReferenceUID);\r\n  }\r\n\r\n  if (points) {\r\n    columns.push('points');\r\n    values.push(points.map(p => p.join(' ')).join(';'));\r\n  }\r\n\r\n  return {\r\n    columns,\r\n    values,\r\n  };\r\n}\r\n\r\nfunction getDisplayText(mappedAnnotations, displaySet, customizationService) {\r\n  const displayText = {\r\n    primary: [],\r\n    secondary: [],\r\n  };\r\n\r\n  if (!mappedAnnotations || !mappedAnnotations.length) {\r\n    return displayText;\r\n  }\r\n\r\n  const { xValues, yValues, units, isUnitless, SeriesNumber, SOPInstanceUID, frameNumber } =\r\n    mappedAnnotations[0];\r\n\r\n  const instance = displaySet.instances.find(image => image.SOPInstanceUID === SOPInstanceUID);\r\n\r\n  let InstanceNumber;\r\n  if (instance) {\r\n    InstanceNumber = instance.InstanceNumber;\r\n  }\r\n\r\n  const instanceText = InstanceNumber ? ` I: ${InstanceNumber}` : '';\r\n  const frameText = displaySet.isMultiFrame ? ` F: ${frameNumber}` : '';\r\n  const seriesText = `S: ${SeriesNumber}${instanceText}${frameText}`;\r\n\r\n  if (xValues === undefined || yValues === undefined) {\r\n    return displayText;\r\n  }\r\n\r\n  if (isUnitless) {\r\n    displayText.primary.push(`${utils.roundNumber(xValues[0], 2)} ${units[0]}`);\r\n  } else {\r\n    const dist1 = Math.abs(xValues[1] - xValues[0]);\r\n    const dist2 = Math.abs(yValues[1] - yValues[0]);\r\n    displayText.primary.push(`${utils.roundNumber(dist1)} ${units[0]}`);\r\n    displayText.primary.push(`${utils.roundNumber(dist2)} ${units[1]}`);\r\n  }\r\n\r\n  displayText.secondary.push(seriesText);\r\n\r\n  return displayText;\r\n}\r\n\r\nexport default UltrasoundDirectional;\r\n","const supportedTools = [\r\n  'Length',\r\n  'EllipticalROI',\r\n  'CircleROI',\r\n  'Bidirectional',\r\n  'ArrowAnnotate',\r\n  'Angle',\r\n  'CobbAngle',\r\n  'Probe',\r\n  'RectangleROI',\r\n  'PlanarFreehandROI',\r\n  'SplineROI',\r\n  'LivewireContour',\r\n  'UltrasoundDirectionalTool',\r\n  'SCOORD3DPoint',\r\n  'SegmentBidirectional',\r\n];\r\n\r\nexport default supportedTools;\r\n","import * as measurementMappingUtils from './utils';\r\n\r\nexport { measurementMappingUtils };\r\n","import { MeasurementService } from '@ohif/core';\r\nimport Length from './Length';\r\nimport Bidirectional from './Bidirectional';\r\nimport EllipticalROI from './EllipticalROI';\r\nimport CircleROI from './CircleROI';\r\nimport ArrowAnnotate from './ArrowAnnotate';\r\nimport CobbAngle from './CobbAngle';\r\nimport Angle from './Angle';\r\nimport PlanarFreehandROI from './PlanarFreehandROI';\r\nimport RectangleROI from './RectangleROI';\r\nimport SplineROI from './SplineROI';\r\nimport LivewireContour from './LivewireContour';\r\nimport Probe from './Probe';\r\nimport UltrasoundDirectional from './UltrasoundDirectional';\r\nimport SegmentBidirectional from './SegmentBidirectional';\r\n\r\nconst measurementServiceMappingsFactory = (\r\n  measurementService: MeasurementService,\r\n  displaySetService,\r\n  cornerstoneViewportService,\r\n  customizationService\r\n) => {\r\n  /**\r\n   * Maps measurement service format object to cornerstone annotation object.\r\n   *\r\n   * @param measurement The measurement instance\r\n   * @param definition The source definition\r\n   * @return Cornerstone annotation data\r\n   */\r\n\r\n  const _getValueTypeFromToolType = toolType => {\r\n    const { POLYLINE, ELLIPSE, CIRCLE, RECTANGLE, BIDIRECTIONAL, POINT, ANGLE } =\r\n      MeasurementService.VALUE_TYPES;\r\n\r\n    // TODO -> I get why this was attempted, but its not nearly flexible enough.\r\n    // A single measurement may have an ellipse + a bidirectional measurement, for instances.\r\n    // You can't define a bidirectional tool as a single type..\r\n    const TOOL_TYPE_TO_VALUE_TYPE = {\r\n      Length: POLYLINE,\r\n      EllipticalROI: ELLIPSE,\r\n      CircleROI: CIRCLE,\r\n      RectangleROI: RECTANGLE,\r\n      PlanarFreehandROI: POLYLINE,\r\n      Bidirectional: BIDIRECTIONAL,\r\n      ArrowAnnotate: POINT,\r\n      CobbAngle: ANGLE,\r\n      Angle: ANGLE,\r\n      SplineROI: POLYLINE,\r\n      LivewireContour: POLYLINE,\r\n      Probe: POINT,\r\n      UltrasoundDirectional: POLYLINE,\r\n      SegmentBidirectional: BIDIRECTIONAL,\r\n    };\r\n\r\n    return TOOL_TYPE_TO_VALUE_TYPE[toolType];\r\n  };\r\n\r\n  const factories = {\r\n    Length: {\r\n      toAnnotation: Length.toAnnotation,\r\n      toMeasurement: csToolsAnnotation =>\r\n        Length.toMeasurement(\r\n          csToolsAnnotation,\r\n          displaySetService,\r\n          cornerstoneViewportService,\r\n          _getValueTypeFromToolType,\r\n          customizationService\r\n        ),\r\n      matchingCriteria: [\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.POLYLINE,\r\n          points: 2,\r\n        },\r\n      ],\r\n    },\r\n    Bidirectional: {\r\n      toAnnotation: Bidirectional.toAnnotation,\r\n      toMeasurement: csToolsAnnotation =>\r\n        Bidirectional.toMeasurement(\r\n          csToolsAnnotation,\r\n          displaySetService,\r\n          cornerstoneViewportService,\r\n          _getValueTypeFromToolType,\r\n          customizationService\r\n        ),\r\n      matchingCriteria: [\r\n        // TODO -> We should eventually do something like shortAxis + longAxis,\r\n        // But its still a little unclear how these automatic interpretations will work.\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.POLYLINE,\r\n          points: 2,\r\n        },\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.POLYLINE,\r\n          points: 2,\r\n        },\r\n      ],\r\n    },\r\n    SegmentBidirectional: {\r\n      toAnnotation: SegmentBidirectional.toAnnotation,\r\n      toMeasurement: csToolsAnnotation =>\r\n        SegmentBidirectional.toMeasurement(\r\n          csToolsAnnotation,\r\n          displaySetService,\r\n          cornerstoneViewportService,\r\n          _getValueTypeFromToolType,\r\n          customizationService\r\n        ),\r\n      matchingCriteria: [\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.POLYLINE,\r\n          points: 2,\r\n        },\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.POLYLINE,\r\n          points: 2,\r\n        },\r\n      ],\r\n    },\r\n    EllipticalROI: {\r\n      toAnnotation: EllipticalROI.toAnnotation,\r\n      toMeasurement: csToolsAnnotation =>\r\n        EllipticalROI.toMeasurement(\r\n          csToolsAnnotation,\r\n          displaySetService,\r\n          cornerstoneViewportService,\r\n          _getValueTypeFromToolType,\r\n          customizationService\r\n        ),\r\n      matchingCriteria: [\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.ELLIPSE,\r\n        },\r\n      ],\r\n    },\r\n    CircleROI: {\r\n      toAnnotation: CircleROI.toAnnotation,\r\n      toMeasurement: csToolsAnnotation =>\r\n        CircleROI.toMeasurement(\r\n          csToolsAnnotation,\r\n          displaySetService,\r\n          cornerstoneViewportService,\r\n          _getValueTypeFromToolType,\r\n          customizationService\r\n        ),\r\n      matchingCriteria: [\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.CIRCLE,\r\n        },\r\n      ],\r\n    },\r\n    RectangleROI: {\r\n      toAnnotation: RectangleROI.toAnnotation,\r\n      toMeasurement: csToolsAnnotation =>\r\n        RectangleROI.toMeasurement(\r\n          csToolsAnnotation,\r\n          displaySetService,\r\n          cornerstoneViewportService,\r\n          _getValueTypeFromToolType,\r\n          customizationService\r\n        ),\r\n      matchingCriteria: [\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.POLYLINE,\r\n        },\r\n      ],\r\n    },\r\n    PlanarFreehandROI: {\r\n      toAnnotation: PlanarFreehandROI.toAnnotation,\r\n      toMeasurement: csToolsAnnotation =>\r\n        PlanarFreehandROI.toMeasurement(\r\n          csToolsAnnotation,\r\n          displaySetService,\r\n          cornerstoneViewportService,\r\n          _getValueTypeFromToolType,\r\n          customizationService\r\n        ),\r\n      matchingCriteria: [\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.POLYLINE,\r\n        },\r\n      ],\r\n    },\r\n    SplineROI: {\r\n      toAnnotation: SplineROI.toAnnotation,\r\n      toMeasurement: csToolsAnnotation =>\r\n        SplineROI.toMeasurement(\r\n          csToolsAnnotation,\r\n          displaySetService,\r\n          cornerstoneViewportService,\r\n          _getValueTypeFromToolType,\r\n          customizationService\r\n        ),\r\n      matchingCriteria: [\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.POLYLINE,\r\n        },\r\n      ],\r\n    },\r\n    LivewireContour: {\r\n      toAnnotation: LivewireContour.toAnnotation,\r\n      toMeasurement: csToolsAnnotation =>\r\n        LivewireContour.toMeasurement(\r\n          csToolsAnnotation,\r\n          displaySetService,\r\n          cornerstoneViewportService,\r\n          _getValueTypeFromToolType,\r\n          customizationService\r\n        ),\r\n      matchingCriteria: [\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.POLYLINE,\r\n        },\r\n      ],\r\n    },\r\n    ArrowAnnotate: {\r\n      toAnnotation: ArrowAnnotate.toAnnotation,\r\n      toMeasurement: csToolsAnnotation =>\r\n        ArrowAnnotate.toMeasurement(\r\n          csToolsAnnotation,\r\n          displaySetService,\r\n          cornerstoneViewportService,\r\n          _getValueTypeFromToolType,\r\n          customizationService\r\n        ),\r\n      matchingCriteria: [\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.POINT,\r\n          points: 1,\r\n        },\r\n      ],\r\n    },\r\n    Probe: {\r\n      toAnnotation: Probe.toAnnotation,\r\n      toMeasurement: csToolsAnnotation =>\r\n        Probe.toMeasurement(\r\n          csToolsAnnotation,\r\n          displaySetService,\r\n          cornerstoneViewportService,\r\n          _getValueTypeFromToolType,\r\n          customizationService\r\n        ),\r\n      matchingCriteria: [\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.POINT,\r\n          points: 1,\r\n        },\r\n      ],\r\n    },\r\n    CobbAngle: {\r\n      toAnnotation: CobbAngle.toAnnotation,\r\n      toMeasurement: csToolsAnnotation =>\r\n        CobbAngle.toMeasurement(\r\n          csToolsAnnotation,\r\n          displaySetService,\r\n          cornerstoneViewportService,\r\n          _getValueTypeFromToolType,\r\n          customizationService\r\n        ),\r\n      matchingCriteria: [\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.ANGLE,\r\n        },\r\n      ],\r\n    },\r\n    Angle: {\r\n      toAnnotation: Angle.toAnnotation,\r\n      toMeasurement: csToolsAnnotation =>\r\n        Angle.toMeasurement(\r\n          csToolsAnnotation,\r\n          displaySetService,\r\n          cornerstoneViewportService,\r\n          _getValueTypeFromToolType,\r\n          customizationService\r\n        ),\r\n      matchingCriteria: [\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.ANGLE,\r\n        },\r\n      ],\r\n    },\r\n    UltrasoundDirectional: {\r\n      toAnnotation: UltrasoundDirectional.toAnnotation,\r\n      toMeasurement: csToolsAnnotation =>\r\n        UltrasoundDirectional.toMeasurement(\r\n          csToolsAnnotation,\r\n          displaySetService,\r\n          cornerstoneViewportService,\r\n          _getValueTypeFromToolType,\r\n          customizationService\r\n        ),\r\n      matchingCriteria: [\r\n        {\r\n          valueType: MeasurementService.VALUE_TYPES.POLYLINE,\r\n          points: 2,\r\n        },\r\n      ],\r\n    },\r\n  };\r\n\r\n  return factories;\r\n};\r\n\r\nexport default measurementServiceMappingsFactory;\r\n","const getDisplayUnit = unit => (unit == null ? '' : unit);\r\n\r\nexport default getDisplayUnit;\r\n","export default function getHandlesFromPoints(points) {\r\n  if (points.longAxis && points.shortAxis) {\r\n    const handles = {};\r\n    handles.start = points.longAxis[0];\r\n    handles.end = points.longAxis[1];\r\n    handles.perpendicularStart = points.longAxis[0];\r\n    handles.perpendicularEnd = points.longAxis[1];\r\n    return handles;\r\n  }\r\n\r\n  return points\r\n    .map((p, i) => (i % 10 === 0 ? { start: p } : { end: p }))\r\n    .reduce((obj, item) => Object.assign(obj, { ...item }), {});\r\n}\r\n","import { locking } from '@cornerstonejs/tools/annotation';\r\n\r\nexport const getIsLocked = annotationUID => {\r\n  return locking.isAnnotationLocked(annotationUID);\r\n};\r\n","import { visibility } from '@cornerstonejs/tools/annotation';\r\n\r\nexport const getIsVisible = annotationUID => {\r\n  const isVisible = visibility.isAnnotationVisible(annotationUID);\r\n  return isVisible;\r\n};\r\n","import * as cornerstone from '@cornerstonejs/core';\r\n\r\n/**\r\n * It checks if the imageId is provided then it uses it to query\r\n * the metadata and get the SOPInstanceUID, SeriesInstanceUID and StudyInstanceUID.\r\n * If the imageId is not provided then undefined is returned.\r\n * @param {string} imageId The image id of the referenced image\r\n * @returns\r\n */\r\nexport default function getSOPInstanceAttributes(imageId, displaySetService, annotation) {\r\n  if (imageId) {\r\n    return _getUIDFromImageID(imageId);\r\n  }\r\n\r\n  const { metadata } = annotation;\r\n  const { volumeId } = metadata;\r\n\r\n  const displaySet = displaySetService.getDisplaySetsBy(displaySet =>\r\n    volumeId.includes(displaySet.uid)\r\n  )[0];\r\n  const { StudyInstanceUID, SeriesInstanceUID } = displaySet;\r\n\r\n  return {\r\n    SOPInstanceUID: undefined,\r\n    SeriesInstanceUID,\r\n    StudyInstanceUID,\r\n  };\r\n}\r\n\r\nfunction _getUIDFromImageID(imageId) {\r\n  const instance = cornerstone.metaData.get('instance', imageId);\r\n\r\n  return {\r\n    SOPInstanceUID: instance.SOPInstanceUID,\r\n    SeriesInstanceUID: instance.SeriesInstanceUID,\r\n    StudyInstanceUID: instance.StudyInstanceUID,\r\n    frameNumber: instance.frameNumber || 1,\r\n  };\r\n}\r\n","import { utils } from '@ohif/core';\r\nimport getDisplayUnit from './getDisplayUnit';\r\n\r\nexport const getStatisticDisplayString = (numbers, unit, key) => {\r\n  if (Array.isArray(numbers) && numbers.length > 0) {\r\n    const results = numbers.map(number => utils.roundNumber(number, 2));\r\n    return `${key.charAt(0).toUpperCase() + key.slice(1)}: ${results.join(', ')} ${getDisplayUnit(unit)}`;\r\n  }\r\n\r\n  const result = utils.roundNumber(numbers, 2);\r\n  return `${key.charAt(0).toUpperCase() + key.slice(1)}: ${result} ${getDisplayUnit(unit)}`;\r\n};\r\n","import getHandlesFromPoints from './getHandlesFromPoints';\r\nimport {\r\n  isAnnotationSelected,\r\n  setAnnotationSelected,\r\n  getFirstAnnotationSelected,\r\n} from './selection';\r\nimport getSOPInstanceAttributes from './getSOPInstanceAttributes';\r\nimport getDisplayUnit from './getDisplayUnit';\r\n\r\nexport {\r\n  getHandlesFromPoints,\r\n  getSOPInstanceAttributes,\r\n  isAnnotationSelected,\r\n  setAnnotationSelected,\r\n  getFirstAnnotationSelected,\r\n  getDisplayUnit,\r\n};\r\n","import { annotation as cs3dToolAnnotationUtils } from '@cornerstonejs/tools';\r\n\r\n/**\r\n * Check whether an annotation from imaging library is selected or not.\r\n * @param {string} annotationUID uid of imaging library annotation\r\n * @returns boolean\r\n */\r\nfunction isAnnotationSelected(annotationUID: string): boolean {\r\n  return cs3dToolAnnotationUtils.selection.isAnnotationSelected(annotationUID);\r\n}\r\n\r\n/**\r\n * Change an annotation from imaging library's selected property.\r\n * @param annotationUID - uid of imaging library annotation\r\n * @param selected - new value for selected\r\n */\r\nfunction setAnnotationSelected(annotationUID: string, selected: boolean): void {\r\n  const isCurrentSelected = isAnnotationSelected(annotationUID);\r\n  // branch cut, avoid invoking imaging library unnecessarily.\r\n  if (isCurrentSelected !== selected) {\r\n    cs3dToolAnnotationUtils.selection.setAnnotationSelected(annotationUID, selected);\r\n  }\r\n}\r\n\r\nfunction getFirstAnnotationSelected(element) {\r\n  const [selectedAnnotationUID] = cs3dToolAnnotationUtils.selection.getAnnotationsSelected() || [];\r\n\r\n  if (selectedAnnotationUID) {\r\n    return cs3dToolAnnotationUtils.state.getAnnotation(selectedAnnotationUID);\r\n  }\r\n}\r\n\r\nexport { isAnnotationSelected, setAnnotationSelected, getFirstAnnotationSelected };\r\n","import { cache, imageLoadPoolManager, Enums } from '@cornerstonejs/core';\r\nimport getNthFrames from './getNthFrames';\r\nimport interleave from './interleave';\r\n\r\n// Map of volumeId and SeriesInstanceId\r\nconst volumeIdMapsToLoad = new Map<string, string>();\r\nconst viewportIdVolumeInputArrayMap = new Map<string, unknown[]>();\r\n\r\n/**\r\n * This function caches the volumeUIDs until all the volumes inside the\r\n * hanging protocol are initialized. Then it goes through the requests and\r\n * chooses a sub-selection starting the the first few objects, center objects\r\n * and last objects, and then the remaining nth images until all instances are\r\n * retrieved.  This causes the image to have a progressive load order and looks\r\n * visually much better.\r\n * @param {Object} props image loading properties from Cornerstone ViewportService\r\n */\r\nexport default function interleaveNthLoader({\r\n  data: { viewportId, volumeInputArray },\r\n  displaySetsMatchDetails,\r\n}) {\r\n  viewportIdVolumeInputArrayMap.set(viewportId, volumeInputArray);\r\n\r\n  // Based on the volumeInputs store the volumeIds and SeriesInstanceIds\r\n  // to keep track of the volumes being loaded\r\n  for (const volumeInput of volumeInputArray) {\r\n    const { volumeId } = volumeInput;\r\n    const volume = cache.getVolume(volumeId);\r\n\r\n    if (!volume) {\r\n      console.log(\"interleaveNthLoader::No volume, can't load it\");\r\n      return;\r\n    }\r\n\r\n    // if the volumeUID is not in the volumeUIDs array, add it\r\n    if (!volumeIdMapsToLoad.has(volumeId)) {\r\n      const { metadata } = volume;\r\n      volumeIdMapsToLoad.set(volumeId, metadata.SeriesInstanceUID);\r\n    }\r\n  }\r\n\r\n  const volumeIds = Array.from(volumeIdMapsToLoad.keys()).slice();\r\n  // get volumes from cache\r\n  const volumes = volumeIds.map(volumeId => {\r\n    return cache.getVolume(volumeId);\r\n  });\r\n\r\n  // iterate over all volumes, and get their imageIds, and interleave\r\n  // the imageIds and save them in AllRequests for later use\r\n  const originalRequests = volumes\r\n    .map(volume => volume.getImageLoadRequests())\r\n    .filter(requests => requests?.[0]?.imageId);\r\n\r\n  const orderedRequests = originalRequests.map(request => getNthFrames(request));\r\n\r\n  // set the finalRequests to the imageLoadPoolManager\r\n  const finalRequests = interleave(orderedRequests);\r\n\r\n  const requestType = Enums.RequestType.Prefetch;\r\n  const priority = 0;\r\n\r\n  finalRequests.forEach(({ callLoadImage, additionalDetails, imageId, imageIdIndex, options }) => {\r\n    const callLoadImageBound = callLoadImage.bind(null, imageId, imageIdIndex, options);\r\n\r\n    imageLoadPoolManager.addRequest(callLoadImageBound, requestType, additionalDetails, priority);\r\n  });\r\n\r\n  // clear the volumeIdMapsToLoad\r\n  volumeIdMapsToLoad.clear();\r\n\r\n  // copy the viewportIdVolumeInputArrayMap\r\n  const viewportIdVolumeInputArrayMapCopy = new Map(viewportIdVolumeInputArrayMap);\r\n\r\n  // reset the viewportIdVolumeInputArrayMap\r\n  viewportIdVolumeInputArrayMap.clear();\r\n\r\n  return viewportIdVolumeInputArrayMapCopy;\r\n}\r\n","export type HydrationCallback = (params: any) => Promise<boolean>;\r\n\r\nexport const HydrationType = {\r\n  SEG: 'SEG',\r\n  SR: 'SR',\r\n  RTSTRUCT: 'RTSTRUCT',\r\n} as const;\r\n\r\nexport interface HydrationDialogProps {\r\n  servicesManager: AppTypes.ServicesManager;\r\n  viewportId: string;\r\n  displaySet: AppTypes.DisplaySet;\r\n  preHydrateCallbacks?: HydrationCallback[];\r\n  hydrateCallback: HydrationCallback;\r\n  type: string;\r\n}\r\n\r\nexport interface HydrationSRResult {\r\n  userResponse: number;\r\n  displaySetInstanceUID: string;\r\n  srSeriesInstanceUID: string;\r\n  viewportId: string;\r\n  StudyInstanceUID?: string;\r\n  SeriesInstanceUIDs?: string[];\r\n}\r\n\r\nconst RESPONSE = {\r\n  NO_NEVER: -1,\r\n  CANCEL: 0,\r\n  CREATE_REPORT: 1,\r\n  ADD_SERIES: 2,\r\n  SET_STUDY_AND_SERIES: 3,\r\n  NO_NOT_FOR_SERIES: 4,\r\n  HYDRATE: 5,\r\n};\r\n\r\nfunction getCustomizationMessageKey(type: string): string {\r\n  switch (type) {\r\n    case HydrationType.RTSTRUCT:\r\n      return 'viewportNotification.hydrateRTMessage';\r\n    case HydrationType.SEG:\r\n      return 'viewportNotification.hydrateSEGMessage';\r\n    case HydrationType.SR:\r\n      return 'viewportNotification.hydrateSRMessage';\r\n    default:\r\n      return 'viewportNotification.hydrateMessage';\r\n  }\r\n}\r\n\r\nfunction getDialogId(type: string): string {\r\n  switch (type) {\r\n    case HydrationType.RTSS:\r\n      return 'promptHydrateRT';\r\n    case HydrationType.SEG:\r\n      return 'promptHydrateSEG';\r\n    case HydrationType.SR:\r\n      return 'promptHydrateSR';\r\n    default:\r\n      return 'promptHydrate';\r\n  }\r\n}\r\n\r\nfunction promptHydrationDialog({\r\n  servicesManager,\r\n  viewportId,\r\n  displaySet,\r\n  preHydrateCallbacks = [],\r\n  hydrateCallback,\r\n  type,\r\n}: HydrationDialogProps): Promise<boolean | HydrationSRResult> {\r\n  const { uiViewportDialogService, customizationService } = servicesManager.services;\r\n  const extensionManager = servicesManager._extensionManager;\r\n  const appConfig = extensionManager._appConfig;\r\n\r\n  // Todo: make this use enum from the extension, we should move the enum\r\n  const standardMode = appConfig?.measurementTrackingMode === 'standard';\r\n\r\n  return new Promise(async function (resolve, reject) {\r\n    // For RT and SEG, we check disableConfirmationPrompts\r\n    // For SR, we check if standardMode is true\r\n    const shouldPrompt =\r\n      type === HydrationType.SR ? standardMode : !appConfig?.disableConfirmationPrompts;\r\n\r\n    const promptResult = shouldPrompt\r\n      ? await _askHydrate(uiViewportDialogService, customizationService, viewportId, type)\r\n      : RESPONSE.HYDRATE;\r\n\r\n    if (promptResult === RESPONSE.HYDRATE) {\r\n      // Execute preHydrate callbacks\r\n      preHydrateCallbacks?.forEach(callback => {\r\n        callback();\r\n      });\r\n\r\n      if (type === HydrationType.SEG) {\r\n        // SEG needs setTimeout\r\n        window.setTimeout(async () => {\r\n          const isHydrated = await hydrateCallback({\r\n            segDisplaySet: displaySet,\r\n            viewportId,\r\n          });\r\n\r\n          resolve(isHydrated);\r\n        }, 0);\r\n      } else if (type === HydrationType.RTSTRUCT) {\r\n        // RT hydration\r\n        const isHydrated = await hydrateCallback({\r\n          rtDisplaySet: displaySet,\r\n          viewportId,\r\n          servicesManager,\r\n        });\r\n\r\n        resolve(isHydrated);\r\n      } else if (type === HydrationType.SR) {\r\n        // SR has a different result structure\r\n        const hydrationResult = await hydrateCallback(displaySet);\r\n\r\n        resolve({\r\n          userResponse: promptResult,\r\n          displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n          srSeriesInstanceUID: displaySet.SeriesInstanceUID,\r\n          viewportId,\r\n          StudyInstanceUID: hydrationResult?.StudyInstanceUID,\r\n          SeriesInstanceUIDs: hydrationResult?.SeriesInstanceUIDs,\r\n        });\r\n      }\r\n    } else {\r\n      if (type === HydrationType.SR) {\r\n        resolve({\r\n          userResponse: promptResult,\r\n          displaySetInstanceUID: displaySet.displaySetInstanceUID,\r\n          srSeriesInstanceUID: displaySet.SeriesInstanceUID,\r\n          viewportId,\r\n        });\r\n      } else {\r\n        resolve(false);\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\nfunction _askHydrate(\r\n  uiViewportDialogService: AppTypes.UIViewportDialogService,\r\n  customizationService: AppTypes.CustomizationService,\r\n  viewportId: string,\r\n  type: string\r\n) {\r\n  return new Promise(function (resolve, reject) {\r\n    const messageKey = getCustomizationMessageKey(type);\r\n    const message = customizationService.getCustomization(messageKey);\r\n    const actions = [\r\n      {\r\n        id: 'no-hydrate',\r\n        type: 'secondary',\r\n        text: 'No',\r\n        value: RESPONSE.CANCEL,\r\n      },\r\n      {\r\n        id: 'yes-hydrate',\r\n        type: 'primary',\r\n        text: 'Yes',\r\n        value: RESPONSE.HYDRATE,\r\n      },\r\n    ];\r\n    const onSubmit = result => {\r\n      uiViewportDialogService.hide();\r\n      resolve(result);\r\n    };\r\n\r\n    uiViewportDialogService.show({\r\n      id: getDialogId(type),\r\n      viewportId,\r\n      type: 'info',\r\n      message,\r\n      actions,\r\n      onSubmit,\r\n      onOutsideClick: () => {\r\n        uiViewportDialogService.hide();\r\n        resolve(RESPONSE.CANCEL);\r\n      },\r\n      onKeyPress: event => {\r\n        if (event.key === 'Enter') {\r\n          onSubmit(RESPONSE.HYDRATE);\r\n        }\r\n      },\r\n    });\r\n  });\r\n}\r\n\r\nexport default promptHydrationDialog;\r\n","import SegmentationServiceType from '../services/SegmentationService';\r\n\r\nexport const handleSegmentChange = ({\r\n  direction,\r\n  segmentationId,\r\n  viewportId,\r\n  selectedSegmentObjectIndex,\r\n  segmentationService,\r\n}: {\r\n  direction: number;\r\n  segmentationId: string;\r\n  viewportId: string;\r\n  selectedSegmentObjectIndex: number;\r\n  segmentationService: SegmentationServiceType;\r\n}) => {\r\n  const segmentation = segmentationService.getSegmentation(segmentationId);\r\n\r\n  const { segments } = segmentation;\r\n\r\n  const numberOfSegments = Object.keys(segments).length;\r\n\r\n  // Get activeSegment each time because the user can select any segment from the list and thus the index should be updated\r\n  const activeSegment = segmentationService.getActiveSegment(viewportId);\r\n  if (activeSegment) {\r\n    // from the activeSegment get the actual object array index to be used\r\n    selectedSegmentObjectIndex = Object.values(segments).findIndex(\r\n      segment => segment.segmentIndex === activeSegment.segmentIndex\r\n    );\r\n  }\r\n  let newSelectedSegmentIndex = selectedSegmentObjectIndex + direction;\r\n\r\n  // Handle looping through list of segments\r\n  if (newSelectedSegmentIndex > numberOfSegments - 1) {\r\n    newSelectedSegmentIndex = 0;\r\n  } else if (newSelectedSegmentIndex < 0) {\r\n    newSelectedSegmentIndex = numberOfSegments - 1;\r\n  }\r\n\r\n  // Convert segmentationId from object array index to property value of type Segment\r\n  // Functions below use the segmentIndex object attribute so we have to do the conversion\r\n  const segmentIndex = Object.values(segments)[newSelectedSegmentIndex]?.segmentIndex;\r\n\r\n  segmentationService.setActiveSegment(segmentationId, segmentIndex);\r\n  segmentationService.jumpToSegmentCenter(segmentationId, segmentIndex, viewportId);\r\n  selectedSegmentObjectIndex = newSelectedSegmentIndex;\r\n};\r\n","import * as cornerstoneTools from '@cornerstonejs/tools';\r\nimport { updateSegmentationStats } from './updateSegmentationStats';\r\n\r\n/**\r\n * Sets up the handler for segmentation data modification events\r\n */\r\nexport function setupSegmentationDataModifiedHandler({\r\n  segmentationService,\r\n  customizationService,\r\n  commandsManager,\r\n}) {\r\n  // A flag to indicate if the event is unsubscribed to. This is important because\r\n  // the debounced callback does an await and in that period of time the event may have\r\n  // been unsubscribed.\r\n  let isUnsubscribed = false;\r\n  const { unsubscribe: debouncedUnsubscribe } = segmentationService.subscribeDebounced(\r\n    segmentationService.EVENTS.SEGMENTATION_DATA_MODIFIED,\r\n    async ({ segmentationId }) => {\r\n      const segmentation = segmentationService.getSegmentation(segmentationId);\r\n\r\n      if (!segmentation) {\r\n        return;\r\n      }\r\n\r\n      const readableText = customizationService.getCustomization('panelSegmentation.readableText');\r\n\r\n      // Check for segments with bidirectional measurements and update them\r\n      const segmentIndices = Object.keys(segmentation.segments)\r\n        .map(index => parseInt(index))\r\n        .filter(index => index > 0);\r\n\r\n      for (const segmentIndex of segmentIndices) {\r\n        const segment = segmentation.segments[segmentIndex];\r\n        if (segment?.cachedStats?.namedStats?.bidirectional) {\r\n          // Run the command to update the bidirectional measurement\r\n          commandsManager.runCommand('runSegmentBidirectional', {\r\n            segmentationId,\r\n            segmentIndex,\r\n          });\r\n        }\r\n      }\r\n\r\n      const updatedSegmentation = await updateSegmentationStats({\r\n        segmentation,\r\n        segmentationId,\r\n        readableText,\r\n      });\r\n\r\n      if (!isUnsubscribed && updatedSegmentation) {\r\n        segmentationService.addOrUpdateSegmentation({\r\n          segmentationId,\r\n          segments: updatedSegmentation.segments,\r\n        });\r\n      }\r\n    },\r\n    1000\r\n  );\r\n\r\n  const unsubscribe = () => {\r\n    isUnsubscribed = true;\r\n    debouncedUnsubscribe();\r\n  };\r\n  return { unsubscribe };\r\n}\r\n\r\n/**\r\n * Sets up the handler for segmentation modification events\r\n */\r\nexport function setupSegmentationModifiedHandler({ segmentationService }) {\r\n  const { unsubscribe } = segmentationService.subscribe(\r\n    segmentationService.EVENTS.SEGMENTATION_MODIFIED,\r\n    async ({ segmentationId }) => {\r\n      const segmentation = segmentationService.getSegmentation(segmentationId);\r\n\r\n      if (!segmentation) {\r\n        return;\r\n      }\r\n\r\n      const annotationState = cornerstoneTools.annotation.state.getAllAnnotations();\r\n      const bidirectionalAnnotations = annotationState.filter(\r\n        annotation =>\r\n          annotation.metadata.toolName === cornerstoneTools.SegmentBidirectionalTool.toolName\r\n      );\r\n\r\n      let toRemoveUIDs = [];\r\n      if (!segmentation) {\r\n        toRemoveUIDs = bidirectionalAnnotations.map(\r\n          annotation => annotation.metadata.segmentationId === segmentationId\r\n        );\r\n        return;\r\n      } else {\r\n        const segmentIndices = Object.keys(segmentation.segments)\r\n          .map(index => parseInt(index))\r\n          .filter(index => index > 0);\r\n\r\n        // check if there is a bidirectional data that exists but the segment\r\n        // does not exists anymore we need to remove the bidirectional data\r\n        const bidirectionalAnnotationsToRemove = bidirectionalAnnotations.filter(\r\n          annotation =>\r\n            annotation.metadata.segmentationId === segmentationId &&\r\n            !segmentIndices.includes(annotation.metadata.segmentIndex)\r\n        );\r\n\r\n        toRemoveUIDs = bidirectionalAnnotationsToRemove.map(annotation => annotation.annotationUID);\r\n      }\r\n\r\n      toRemoveUIDs.forEach(uid => {\r\n        cornerstoneTools.annotation.state.removeAnnotation(uid);\r\n      });\r\n    }\r\n  );\r\n\r\n  return { unsubscribe };\r\n}\r\n","import {\r\n  setupSegmentationDataModifiedHandler,\r\n  setupSegmentationModifiedHandler,\r\n} from './segmentationHandlers';\r\n\r\nexport const setUpSegmentationEventHandlers = ({ servicesManager, commandsManager }) => {\r\n  const { segmentationService, customizationService, displaySetService } = servicesManager.services;\r\n\r\n  const { unsubscribe: unsubscribeSegmentationDataModifiedHandler } =\r\n    setupSegmentationDataModifiedHandler({\r\n      segmentationService,\r\n      customizationService,\r\n      commandsManager,\r\n    });\r\n\r\n  const { unsubscribe: unsubscribeSegmentationModifiedHandler } = setupSegmentationModifiedHandler({\r\n    segmentationService,\r\n  });\r\n\r\n  const { unsubscribe: unsubscribeSegmentationCreated } = segmentationService.subscribe(\r\n    segmentationService.EVENTS.SEGMENTATION_ADDED,\r\n    evt => {\r\n      const { segmentationId } = evt;\r\n      const displaySet = displaySetService.getDisplaySetByUID(segmentationId);\r\n      if (displaySet) {\r\n        return;\r\n      }\r\n\r\n      const segmentation = segmentationService.getSegmentation(segmentationId);\r\n      const label = segmentation.cachedStats.info;\r\n      const imageIds = segmentation.representationData.Labelmap.imageIds;\r\n\r\n      // Create a display set for the segmentation\r\n      const segmentationDisplaySet = {\r\n        displaySetInstanceUID: segmentationId,\r\n        SOPClassUID: '1.2.840.10008.5.1.4.1.1.66.4',\r\n        SOPClassHandlerId: '@ohif/extension-cornerstone-dicom-seg.sopClassHandlerModule.dicom-seg',\r\n        SeriesDescription: label,\r\n        Modality: 'SEG',\r\n        numImageFrames: imageIds.length,\r\n        imageIds,\r\n        isOverlayDisplaySet: true,\r\n        label,\r\n        madeInClient: true,\r\n        segmentationId: segmentationId,\r\n        isDerived: true,\r\n      };\r\n\r\n      displaySetService.addDisplaySets(segmentationDisplaySet);\r\n    }\r\n  );\r\n\r\n  const unsubscriptions = [\r\n    unsubscribeSegmentationDataModifiedHandler,\r\n    unsubscribeSegmentationModifiedHandler,\r\n    unsubscribeSegmentationCreated,\r\n  ];\r\n\r\n  return { unsubscriptions };\r\n};\r\n","import { DisplaySetService, ViewportGridService } from '@ohif/core';\r\n\r\nconst VOI_SYNC_NAME = 'VOI_SYNC';\r\n\r\nconst getSyncId = modality => `${VOI_SYNC_NAME}_${modality}`;\r\n\r\nexport default function toggleVOISliceSync({\r\n  servicesManager,\r\n  viewports: providedViewports,\r\n  syncId,\r\n}: withAppTypes) {\r\n  const { syncGroupService, viewportGridService, displaySetService, cornerstoneViewportService } =\r\n    servicesManager.services;\r\n\r\n  const viewports =\r\n    providedViewports || groupViewportsByModality(viewportGridService, displaySetService);\r\n\r\n  // Todo: right now we don't have a proper way to define specific\r\n  // viewports to add to synchronizers, and right now it is global or not\r\n  // after we do that, we should do fine grained control of the synchronizers\r\n\r\n  // we can apply voi sync within each modality group\r\n  for (const [modality, modalityViewports] of Object.entries(viewports)) {\r\n    const syncIdToUse = syncId || getSyncId(modality);\r\n\r\n    const someViewportHasSync = modalityViewports.some(viewport => {\r\n      const syncStates = syncGroupService.getSynchronizersForViewport(\r\n        viewport.viewportOptions.viewportId\r\n      );\r\n\r\n      const imageSync = syncStates.find(syncState => syncState.id === syncIdToUse);\r\n\r\n      return !!imageSync;\r\n    });\r\n\r\n    if (someViewportHasSync) {\r\n      return disableSync(modalityViewports, syncIdToUse, servicesManager);\r\n    }\r\n\r\n    // create synchronization group and add the modalityViewports to it.\r\n    modalityViewports.forEach(gridViewport => {\r\n      const { viewportId } = gridViewport.viewportOptions;\r\n      const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n      if (!viewport) {\r\n        return;\r\n      }\r\n      syncGroupService.addViewportToSyncGroup(viewportId, viewport.getRenderingEngine().id, {\r\n        type: 'voi',\r\n        id: syncIdToUse,\r\n        source: true,\r\n        target: true,\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nfunction disableSync(modalityViewports, syncId, servicesManager: AppTypes.ServicesManager) {\r\n  const { syncGroupService, cornerstoneViewportService } = servicesManager.services;\r\n\r\n  const viewports = modalityViewports;\r\n  viewports.forEach(gridViewport => {\r\n    const { viewportId } = gridViewport.viewportOptions;\r\n    const viewport = cornerstoneViewportService.getCornerstoneViewport(viewportId);\r\n    if (!viewport) {\r\n      return;\r\n    }\r\n    syncGroupService.removeViewportFromSyncGroup(\r\n      viewport.id,\r\n      viewport.getRenderingEngine().id,\r\n      syncId\r\n    );\r\n  });\r\n}\r\n\r\nfunction groupViewportsByModality(\r\n  viewportGridService: ViewportGridService,\r\n  displaySetService: DisplaySetService\r\n) {\r\n  let { viewports } = viewportGridService.getState();\r\n\r\n  viewports = [...viewports.values()];\r\n\r\n  // group the viewports by modality\r\n  return viewports.reduce((acc, viewport) => {\r\n    const { displaySetInstanceUIDs } = viewport;\r\n    // Todo: add proper fusion support\r\n    const displaySetInstanceUID = displaySetInstanceUIDs[0];\r\n    const displaySet = displaySetService.getDisplaySetByUID(displaySetInstanceUID);\r\n\r\n    const modality = displaySet.Modality;\r\n    if (!acc[modality]) {\r\n      acc[modality] = [];\r\n    }\r\n\r\n    acc[modality].push(viewport);\r\n\r\n    return acc;\r\n  }, {});\r\n}\r\n","/**\r\n * It is a bell curved function that uses ease in out quadratic for css\r\n * transition timing function for each side of the curve.\r\n *\r\n * @param {number} x - The current time, in the range [0, 1].\r\n * @param {number} baseline - The baseline value to start from and return to.\r\n * @returns the value of the transition at time x.\r\n */\r\nexport function easeInOutBell(x: number, baseline: number): number {\r\n  const alpha = 1 - baseline;\r\n\r\n  // prettier-ignore\r\n  if (x < 1 / 4) {\r\n    return  4 * Math.pow(2 * x, 3) * alpha + baseline;\r\n  } else if (x < 1 / 2) {\r\n    return (1 - Math.pow(-4 * x + 2, 3) / 2) * alpha + baseline;\r\n  } else if (x < 3 / 4) {\r\n    return (1 - Math.pow(4 * x - 2, 3) / 2) * alpha + baseline;\r\n  } else {\r\n    return (- 4 * Math.pow(2 * x - 2, 3)) * alpha + baseline;\r\n  }\r\n}\r\n\r\n/**\r\n * A reversed bell curved function that starts from 1 and goes to baseline and\r\n * come back to 1 again. It uses ease in out quadratic for css transition\r\n * timing function for each side of the curve.\r\n *\r\n * @param {number} x - The current time, in the range [0, 1].\r\n * @param {number} baseline - The baseline value to start from and return to.\r\n * @returns the value of the transition at time x.\r\n */\r\nexport function reverseEaseInOutBell(x: number, baseline: number): number {\r\n  const y = easeInOutBell(x, baseline);\r\n  return -y + 1 + baseline;\r\n}\r\n\r\nexport function easeInOutBellRelative(\r\n  x: number,\r\n  baseline: number,\r\n  prevOutlineWidth: number\r\n): number {\r\n  const range = baseline - prevOutlineWidth;\r\n\r\n  if (x < 1 / 4) {\r\n    return prevOutlineWidth + 4 * Math.pow(2 * x, 3) * range;\r\n  } else if (x < 1 / 2) {\r\n    return prevOutlineWidth + (1 - Math.pow(-4 * x + 2, 3) / 2) * range;\r\n  } else if (x < 3 / 4) {\r\n    return prevOutlineWidth + (1 - Math.pow(4 * x - 2, 3) / 2) * range;\r\n  } else {\r\n    return prevOutlineWidth + -4 * Math.pow(2 * x - 2, 3) * range;\r\n  }\r\n}\r\n\r\nexport function reverseEaseInOutBellRelative(\r\n  x: number,\r\n  baseline: number,\r\n  prevOutlineWidth: number\r\n): number {\r\n  const y = easeInOutBellRelative(x, baseline, prevOutlineWidth);\r\n  return y;\r\n}\r\n","import * as cornerstoneTools from '@cornerstonejs/tools';\r\n\r\ninterface BidirectionalAxis {\r\n  length: number;\r\n  // Add other axis properties as needed\r\n}\r\n\r\ninterface BidirectionalData {\r\n  majorAxis: BidirectionalAxis;\r\n  minorAxis: BidirectionalAxis;\r\n}\r\n\r\n/**\r\n * Updates the statistics for a segmentation by calculating stats for each segment\r\n * and storing them in the segment's cachedStats property\r\n *\r\n * @param segmentation - The segmentation object containing segments to update stats for\r\n * @param segmentationId - The ID of the segmentation\r\n * @returns The updated segmentation object with new stats, or null if no updates were made\r\n */\r\nexport async function updateSegmentationStats({\r\n  segmentation,\r\n  segmentationId,\r\n  readableText,\r\n}: {\r\n  segmentation: any;\r\n  segmentationId: string;\r\n  readableText: any;\r\n}): Promise<any | null> {\r\n  if (!segmentation) {\r\n    console.debug('No segmentation found for id:', segmentationId);\r\n    return null;\r\n  }\r\n\r\n  const segmentIndices = Object.keys(segmentation.segments)\r\n    .map(index => parseInt(index))\r\n    .filter(index => index > 0); // Filter out segment 0 which is typically background\r\n\r\n  if (segmentIndices.length === 0) {\r\n    console.debug('No segments found in segmentation:', segmentationId);\r\n    return null;\r\n  }\r\n\r\n  const stats = await cornerstoneTools.utilities.segmentation.getStatistics({\r\n    segmentationId,\r\n    segmentIndices,\r\n    mode: 'individual',\r\n  });\r\n\r\n  if (!stats) {\r\n    return null;\r\n  }\r\n\r\n  const updatedSegmentation = { ...segmentation };\r\n  let hasUpdates = false;\r\n\r\n  // Loop through each segment's stats\r\n  Object.entries(stats).forEach(([segmentIndex, segmentStats]) => {\r\n    const index = parseInt(segmentIndex);\r\n\r\n    if (!updatedSegmentation.segments[index].cachedStats) {\r\n      updatedSegmentation.segments[index].cachedStats = {};\r\n      hasUpdates = true;\r\n    }\r\n\r\n    // Get existing namedStats or initialize if not present\r\n    const namedStats = updatedSegmentation.segments[index].cachedStats.namedStats || {};\r\n\r\n    if (segmentStats.array) {\r\n      segmentStats.array.forEach(stat => {\r\n        // only gather stats that are in the readableText\r\n        if (!readableText[stat.name]) {\r\n          return;\r\n        }\r\n\r\n        if (stat && stat.name) {\r\n          namedStats[stat.name] = {\r\n            name: stat.name,\r\n            label: readableText[stat.name],\r\n            value: stat.value,\r\n            unit: stat.unit,\r\n            order: Object.keys(readableText).indexOf(stat.name),\r\n          };\r\n        }\r\n      });\r\n\r\n      if (readableText.volume) {\r\n        // Add volume if it exists but isn't in the array\r\n        if (segmentStats.volume && !namedStats.volume) {\r\n          namedStats.volume = {\r\n            name: 'volume',\r\n            label: 'Volume',\r\n            value: segmentStats.volume.value,\r\n            unit: segmentStats.volume.unit,\r\n            order: Object.keys(readableText).indexOf('volume'),\r\n          };\r\n        }\r\n      }\r\n\r\n      // Update the segment's cachedStats with namedStats\r\n      updatedSegmentation.segments[index].cachedStats.namedStats = namedStats;\r\n      hasUpdates = true;\r\n    }\r\n  });\r\n\r\n  return hasUpdates ? updatedSegmentation : null;\r\n}\r\n\r\n/**\r\n * Updates a segment's statistics with bidirectional measurement data\r\n *\r\n * @param segmentationId - The ID of the segmentation\r\n * @param segmentIndex - The index of the segment to update\r\n * @param bidirectionalData - The bidirectional measurement data to add\r\n * @param segmentationService - The segmentation service to use for updating the segment\r\n * @returns Whether the update was successful\r\n */\r\nexport function updateSegmentBidirectionalStats({\r\n  segmentationId,\r\n  segmentIndex,\r\n  bidirectionalData,\r\n  segmentationService,\r\n  annotation,\r\n}: {\r\n  segmentationId: string;\r\n  segmentIndex: number;\r\n  bidirectionalData: BidirectionalData;\r\n  segmentationService: AppTypes.SegmentationService;\r\n  annotation: any;\r\n}) {\r\n  if (!segmentationId || segmentIndex === undefined || !bidirectionalData) {\r\n    console.debug('Missing required data for bidirectional stats update');\r\n    return null;\r\n  }\r\n\r\n  const segmentation = segmentationService.getSegmentation(segmentationId);\r\n  if (!segmentation || !segmentation.segments[segmentIndex]) {\r\n    console.debug('Segment not found:', segmentIndex, 'in segmentation:', segmentationId);\r\n    return null;\r\n  }\r\n\r\n  const updatedSegmentation = { ...segmentation };\r\n  const segment = updatedSegmentation.segments[segmentIndex];\r\n\r\n  if (!segment.cachedStats) {\r\n    segment.cachedStats = { namedStats: {} };\r\n  }\r\n\r\n  if (!segment.cachedStats.namedStats) {\r\n    segment.cachedStats.namedStats = {};\r\n  }\r\n\r\n  const { majorAxis, minorAxis, maxMajor, maxMinor } = bidirectionalData;\r\n  if (!majorAxis || !minorAxis) {\r\n    console.debug('Missing major or minor axis data');\r\n    return null;\r\n  }\r\n\r\n  let hasUpdates = false;\r\n  const namedStats = segment.cachedStats.namedStats;\r\n\r\n  // Only calculate and update if we have valid measurements\r\n  if (maxMajor > 0 && maxMinor > 0) {\r\n    namedStats.bidirectional = {\r\n      name: 'bidirectional',\r\n      label: 'Bidirectional',\r\n      annotationUID: annotation.annotationUID,\r\n      value: {\r\n        maxMajor,\r\n        maxMinor,\r\n        majorAxis,\r\n        minorAxis,\r\n      },\r\n      unit: 'mm',\r\n    };\r\n\r\n    hasUpdates = true;\r\n  }\r\n\r\n  if (hasUpdates) {\r\n    return updatedSegmentation;\r\n  }\r\n\r\n  return null;\r\n}\r\n","// Imports\nimport ___CSS_LOADER_API_SOURCEMAP_IMPORT___ from \"../../../../../node_modules/css-loader/dist/runtime/sourceMaps.js\";\nimport ___CSS_LOADER_API_IMPORT___ from \"../../../../../node_modules/css-loader/dist/runtime/api.js\";\nvar ___CSS_LOADER_EXPORT___ = ___CSS_LOADER_API_IMPORT___(___CSS_LOADER_API_SOURCEMAP_IMPORT___);\n// Module\n___CSS_LOADER_EXPORT___.push([module.id, `.dicom-upload-drop-area-border-dash {\r\n  background-image: repeating-linear-gradient(\r\n      to right,\r\n      #7bb2ce 0%,\r\n      #7bb2ce 50%,\r\n      transparent 50%,\r\n      transparent 100%\r\n    ),\r\n    repeating-linear-gradient(to right, #7bb2ce 0%, #7bb2ce 50%, transparent 50%, transparent 100%),\r\n    repeating-linear-gradient(to bottom, #7bb2ce 0%, #7bb2ce 50%, transparent 50%, transparent 100%),\r\n    repeating-linear-gradient(to bottom, #7bb2ce 0%, #7bb2ce 50%, transparent 50%, transparent 100%);\r\n  background-position:\r\n    left top,\r\n    left bottom,\r\n    left top,\r\n    right top;\r\n  background-repeat: repeat-x, repeat-x, repeat-y, repeat-y;\r\n  background-size:\r\n    20px 3px,\r\n    20px 3px,\r\n    3px 20px,\r\n    3px 20px;\r\n}\r\n`, \"\",{\"version\":3,\"sources\":[\"webpack://./../../../extensions/cornerstone/src/components/DicomUpload/DicomUpload.css\"],\"names\":[],\"mappings\":\"AAAA;EACE;;;;;;;;;oGASkG;EAClG;;;;aAIW;EACX,yDAAyD;EACzD;;;;YAIU;AACZ\",\"sourcesContent\":[\".dicom-upload-drop-area-border-dash {\\r\\n  background-image: repeating-linear-gradient(\\r\\n      to right,\\r\\n      #7bb2ce 0%,\\r\\n      #7bb2ce 50%,\\r\\n      transparent 50%,\\r\\n      transparent 100%\\r\\n    ),\\r\\n    repeating-linear-gradient(to right, #7bb2ce 0%, #7bb2ce 50%, transparent 50%, transparent 100%),\\r\\n    repeating-linear-gradient(to bottom, #7bb2ce 0%, #7bb2ce 50%, transparent 50%, transparent 100%),\\r\\n    repeating-linear-gradient(to bottom, #7bb2ce 0%, #7bb2ce 50%, transparent 50%, transparent 100%);\\r\\n  background-position:\\r\\n    left top,\\r\\n    left bottom,\\r\\n    left top,\\r\\n    right top;\\r\\n  background-repeat: repeat-x, repeat-x, repeat-y, repeat-y;\\r\\n  background-size:\\r\\n    20px 3px,\\r\\n    20px 3px,\\r\\n    3px 20px,\\r\\n    3px 20px;\\r\\n}\\r\\n\"],\"sourceRoot\":\"\"}]);\n// Exports\nexport default ___CSS_LOADER_EXPORT___;\n","var api = require(\"!../../../../../node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js\");\n            var content = require(\"!!../../../../../node_modules/css-loader/dist/cjs.js??ruleSet[1].rules[5].use[1]!../../../../../node_modules/postcss-loader/dist/cjs.js??ruleSet[1].rules[5].use[2]!./DicomUpload.css\");\n\n            content = content.__esModule ? content.default : content;\n\n            if (typeof content === 'string') {\n              content = [[module.id, content, '']];\n            }\n\nvar options = {};\n\noptions.insert = \"head\";\noptions.singleton = false;\n\nvar update = api(content, options);\n\n\nif (module.hot) {\n  if (!content.locals || module.hot.invalidate) {\n    var isEqualLocals = function isEqualLocals(a, b, isNamedExport) {\n  if (!a && b || a && !b) {\n    return false;\n  }\n\n  var p;\n\n  for (p in a) {\n    if (isNamedExport && p === 'default') {\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    if (a[p] !== b[p]) {\n      return false;\n    }\n  }\n\n  for (p in b) {\n    if (isNamedExport && p === 'default') {\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    if (!a[p]) {\n      return false;\n    }\n  }\n\n  return true;\n};\n    var oldLocals = content.locals;\n\n    module.hot.accept(\n      \"!!../../../../../node_modules/css-loader/dist/cjs.js??ruleSet[1].rules[5].use[1]!../../../../../node_modules/postcss-loader/dist/cjs.js??ruleSet[1].rules[5].use[2]!./DicomUpload.css\",\n      function () {\n        content = require(\"!!../../../../../node_modules/css-loader/dist/cjs.js??ruleSet[1].rules[5].use[1]!../../../../../node_modules/postcss-loader/dist/cjs.js??ruleSet[1].rules[5].use[2]!./DicomUpload.css\");\n\n              content = content.__esModule ? content.default : content;\n\n              if (typeof content === 'string') {\n                content = [[module.id, content, '']];\n              }\n\n              if (!isEqualLocals(oldLocals, content.locals)) {\n                module.hot.invalidate();\n\n                return;\n              }\n\n              oldLocals = content.locals;\n\n              update(content);\n      }\n    )\n  }\n\n  module.hot.dispose(function() {\n    update();\n  });\n}\n\nmodule.exports = content.locals || {};"],"names":[],"sourceRoot":""}